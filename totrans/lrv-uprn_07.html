<html><head></head><body><section data-pdf-bookmark="Chapter 7. Collecting and Handling User Data" data-type="chapter" epub:type="chapter"><div class="chapter" id="collecting_and_handling_user_data">&#13;
<h1><span class="label">Chapter 7. </span>Collecting and Handling User Data</h1>&#13;
&#13;
&#13;
<p>Websites that benefit from a framework like Laravel often don’t just serve static content. Many deal with complex and mixed data sources, and one of the most common (and most complex) of these sources is user input in its myriad forms: URL paths, query parameters, <code>POST</code> data, and file uploads.</p>&#13;
&#13;
<p>Laravel provides a collection of tools for gathering, validating, normalizing, and filtering user-provided data. We’ll look at those here.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Injecting a Request Object" data-type="sect1"><div class="sect1" id="id429">&#13;
<h1>Injecting a Request Object</h1>&#13;
&#13;
<p>The<a data-primary="user-provided data" data-secondary="injecting request objects" data-type="indexterm" id="UPDinject07"/><a data-primary="Request objects" data-secondary="injecting" data-type="indexterm" id="ROinject07"/> most common tool for accessing user data in Laravel is injecting an instance of the <code>Illuminate\Http\Request</code> object. It offers easy access to all of the ways users <span class="keep-together">can provide</span> input to your site: <code>POST</code>ed form data or JSON, <code>GET</code> requests (query parameters), and URL segments.</p>&#13;
<div data-type="note" epub:type="note"><h1>Other Options for Accessing Request Data</h1>&#13;
<p>There’s also a <code>request()</code> global helper and a <code>Request</code> facade, both of which expose the same methods. Each of these options exposes the entire Illuminate <code>Request</code> object, but for now we’re only going to cover the methods that specifically relate to user data.</p>&#13;
</div>&#13;
&#13;
<p>Since we’re planning on injecting a <code>Request</code> object, let’s take a quick look at how to get the <code>$request</code> object we’ll be calling all these methods on:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'form'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Illuminate\Http\Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// $request-&gt;etc()</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;all()" data-type="sect2"><div class="sect2" id="id147">&#13;
<h2>$request-&gt;all()</h2>&#13;
&#13;
<p>Just<a data-primary="$request-&gt;all() method" data-type="indexterm" id="id1196"/> like the name suggests, <code>$request-&gt;all()</code> gives you an array containing all of the input the user has provided, from every source. Let’s say, for some reason, you decided to have a form <code>POST</code> to a URL with a query parameter—for example, sending a <code>POST</code> to <em>http://myapp.com/signup?utm=12345</em>. Take a look at <a data-type="xref" href="#EX601">Example 7-1</a> to see what you’d get from <code>$request-&gt;all()</code>. (Note that <code>$request-&gt;all()</code> also contains information about any files that were uploaded, but we’ll cover that later in the chapter.)</p>&#13;
<div data-type="example" id="EX601">&#13;
<h5><span class="label">Example 7-1. </span><code>$request-&gt;all()</code></h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- GET route form view at /get-route --&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/signup?utm=12345"</code><code class="p">&gt;</code>&#13;
    @csrf&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"first_name"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'signup'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Outputs:</code>&#13;
<code class="sd">/**</code>&#13;
<code class="sd"> * [</code>&#13;
<code class="sd"> *     '_token' =&gt; 'CSRF token here',</code>&#13;
<code class="sd"> *     'first_name' =&gt; 'value',</code>&#13;
<code class="sd"> *     'utm' =&gt; 12345,</code>&#13;
<code class="sd"> * ]</code>&#13;
<code class="sd"> */</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;except() and -&gt;only()" data-type="sect2"><div class="sect2" id="id148">&#13;
<h2>$request-&gt;except() and -&gt;only()</h2>&#13;
&#13;
<p><code>$request-&gt;except()</code> provides<a data-primary="$request-&gt;except() method" data-type="indexterm" id="id1197"/> the same output as <code>$request-&gt;all()</code>, but you can choose one or more fields to exclude—for example, <code>_token</code>. You can pass it either a string or an array of strings.</p>&#13;
&#13;
<p><a data-type="xref" href="#EX602">Example 7-2</a> shows what it looks like when we use <code>$request-&gt;except()</code> on the same form as in <a data-type="xref" href="#EX601">Example 7-1</a>.</p>&#13;
<div data-type="example" id="EX602">&#13;
<h5><span class="label">Example 7-2. </span><code>$request-&gt;except()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'post-route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">except</code><code class="p">(</code><code class="s1">'_token'</code><code class="p">));</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Outputs:</code>&#13;
<code class="sd">/**</code>&#13;
<code class="sd"> * [</code>&#13;
<code class="sd"> *     'firstName' =&gt; 'value',</code>&#13;
<code class="sd"> *     'utm' =&gt; 12345</code>&#13;
<code class="sd"> * ]</code>&#13;
<code class="sd"> */</code></pre></div>&#13;
&#13;
<p><code>$request-&gt;only()</code> is<a data-primary="$request-&gt;only() method" data-type="indexterm" id="id1198"/> the inverse of <code>$request-&gt;except()</code>, as you can see in <a data-type="xref" href="#EX603">Example 7-3</a>.</p>&#13;
<div data-type="example" id="EX603">&#13;
<h5><span class="label">Example 7-3. </span><code>$request-&gt;only()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'post-route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">([</code><code class="s1">'firstName'</code><code class="p">,</code> <code class="s1">'utm'</code><code class="p">]));</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Outputs:</code>&#13;
<code class="sd">/**</code>&#13;
<code class="sd"> * [</code>&#13;
<code class="sd"> *     'firstName' =&gt; 'value',</code>&#13;
<code class="sd"> *     'utm' =&gt; 12345</code>&#13;
<code class="sd"> * ]</code>&#13;
<code class="sd"> */</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;has() and -&gt;missing()" data-type="sect2"><div class="sect2" id="id149">&#13;
<h2>$request-&gt;has() and -&gt;missing()</h2>&#13;
&#13;
<p>With <code>$request-&gt;has()</code> you<a data-primary="$request-&gt;has() method" data-type="indexterm" id="id1199"/><a data-primary="$request-&gt;missing() method" data-type="indexterm" id="id1200"/> can detect whether a particular piece of user input is available to you, regardless of whether the input actually has a value in it. Check out <a data-type="xref" href="#EX604">Example 7-4</a> for an analytics example with our <code>utm</code> query string parameter from the previous examples.</p>&#13;
<div data-type="example" id="EX604">&#13;
<h5><span class="label">Example 7-4. </span><code>$request-&gt;has()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /post-route</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'utm'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do some analytics work</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p><code>$request-&gt;missing()</code> is its inverse.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;whenHas()" data-type="sect2"><div class="sect2" id="id150">&#13;
<h2>$request-&gt;whenHas()</h2>&#13;
&#13;
<p>With <code>$request-&gt;whenHas()</code>, you<a data-primary="$request-&gt;whenHas() method" data-type="indexterm" id="id1201"/> can define the behavior when the request either does or doesn’t have a field provided. The first closure parameter is returned when the field exists, and the second is returned when it doesn’t.</p>&#13;
&#13;
<p>See <a data-type="xref" href="#EX624">Example 7-5</a> for an example with our <code>utm</code> query string parameter.</p>&#13;
<div data-type="example" id="EX624">&#13;
<h5><span class="label">Example 7-5. </span><code>$request-&gt;whenHas()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /post-route</code>&#13;
<code class="nv">$utm</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">whenHas</code><code class="p">(</code><code class="s1">'utm'</code><code class="p">,</code> <code class="k">function</code><code class="p">(</code><code class="nv">$utm</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$utm</code><code class="p">;</code>&#13;
<code class="p">},</code> <code class="k">function</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="s1">'default'</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;filled()" data-type="sect2"><div class="sect2" id="id151">&#13;
<h2>$request-&gt;filled()</h2>&#13;
&#13;
<p>Using<a data-primary="$request-&gt;filled() method" data-type="indexterm" id="id1202"/> the <code>$request-&gt;filled()</code> method, it is possible to check if a particular field is present and filled in the request. <code>filled()</code> is the same as <code>has()</code>, except it also requires there to be an actual value present in the field. In <a data-type="xref" href="#EX625">Example 7-6</a> you can see an example of how to use this method.</p>&#13;
<div data-type="example" id="EX625">&#13;
<h5><span class="label">Example 7-6. </span><code>$request-&gt;filled()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /post-route</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">filled</code><code class="p">(</code><code class="s1">'utm'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do some analytics work</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;whenFilled()" data-type="sect2"><div class="sect2" id="id152">&#13;
<h2>$request-&gt;whenFilled()</h2>&#13;
&#13;
<p>Much<a data-primary="$request-&gt;whenFilled() method" data-type="indexterm" id="id1203"/> like with the <code>whenHas()</code> method, the <code>$request-&gt;whenFilled()</code> method allows you to define the values either when the field is filled or when it isn’t. The first closure parameter runs when the field is filled, the second when it is not. See <a data-type="xref" href="#EX626">Example 7-7</a> for an example of how to use this method.</p>&#13;
<div data-type="example" id="EX626">&#13;
<h5><span class="label">Example 7-7. </span><code>$request-&gt;whenFilled()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /post-route</code>&#13;
<code class="nv">$utm</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">whenFilled</code><code class="p">(</code><code class="s1">'utm'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$utm</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$utm</code><code class="p">;</code>&#13;
<code class="p">},</code> <code class="k">function</code><code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="s1">'default'</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;mergeIfMissing()" data-type="sect2"><div class="sect2" id="id153">&#13;
<h2>$request-&gt;mergeIfMissing()</h2>&#13;
&#13;
<p>With<a data-primary="$request-&gt;mergeIfMissing() method" data-type="indexterm" id="id1204"/> the <code>mergeIfMissing()</code> method you can add a field to the request when it is not present and while defining its value. This can be useful, for example, when a field comes from a checkbox, as it is only present when checked. You can see <a data-type="xref" href="#EX627">Example 7-8</a> for an implementation.</p>&#13;
<div data-type="example" id="EX627">&#13;
<h5><span class="label">Example 7-8. </span><code>$request-&gt;mergeIfMissing()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /post-route</code>&#13;
<code class="nv">$shouldSend</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">mergeIfMissing</code><code class="p">(</code><code class="s1">'send_newsletter'</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;input()" data-type="sect2"><div class="sect2" id="id154">&#13;
<h2>$request-&gt;input()</h2>&#13;
&#13;
<p>Whereas<a data-primary="$request-&gt;input() method" data-type="indexterm" id="id1205"/> <code>$request-&gt;all()</code>, <code>$request-&gt;except()</code>, and <code>$request-&gt;only()</code> operate on the full array of input provided by the user, <code>$request-&gt;input()</code> allows you to get the value of just a single field. <a data-type="xref" href="#EX605">Example 7-9</a> provides an example. Note that the second parameter is the default value, so if the user hasn’t passed in a value, you can have a sensible (and nonbreaking) fallback.</p>&#13;
<div data-type="example" id="EX605">&#13;
<h5><span class="label">Example 7-9. </span><code>$request-&gt;input()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'post-route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$userName</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Matt'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;method() and -&gt;isMethod()" data-type="sect2"><div class="sect2" id="id155">&#13;
<h2>$request-&gt;method() and -&gt;isMethod()</h2>&#13;
&#13;
<p><code>$request-&gt;method()</code> returns<a data-primary="$request-&gt;method() method" data-type="indexterm" id="id1206"/><a data-primary="$request-&gt;isMethod() method" data-type="indexterm" id="id1207"/> the HTTP verb for the request, and <code>$⁠r⁠e⁠q⁠u⁠e⁠s⁠t​\-⁠&gt;⁠i⁠s⁠M⁠e⁠t⁠h⁠o⁠d⁠(⁠)</code> checks whether it matches the specified verb. <a data-type="xref" href="#EX622">Example 7-10</a> illustrates their use.</p>&#13;
<div data-type="example" id="EX622">&#13;
<h5><span class="label">Example 7-10. </span><code>$request-&gt;method()</code> and <code>$request-&gt;isMethod()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$method</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">method</code><code class="p">();</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">isMethod</code><code class="p">(</code><code class="s1">'patch'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do something if request method is PATCH</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;integer(), -&gt;float(), -&gt;string(), and -&gt;enum()" data-type="sect2"><div class="sect2" id="id156">&#13;
<h2>$request-&gt;integer(), -&gt;float(), -&gt;string(), and -&gt;enum()</h2>&#13;
&#13;
<p>These<a data-primary="$request-&gt;integer() method" data-type="indexterm" id="id1208"/><a data-primary="$request-&gt;float() method" data-type="indexterm" id="id1209"/><a data-primary="$request-&gt;string() method" data-type="indexterm" id="id1210"/><a data-primary="$request-&gt;enum() method" data-type="indexterm" id="id1211"/> methods cast the inputs directly into integers, floats, strings, or enums when you use each method respectively. See <a data-type="xref" href="#EX628">Example 7-11</a> for usage examples.</p>&#13;
<div data-type="example" id="EX628">&#13;
<h5><span class="label">Example 7-11. </span><code>$request-&gt;integer()</code>, <code>$request-&gt;float()</code>, <code>$request-&gt;string()</code>, and <code>$request-&gt;enum()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">dump</code><code class="p">(</code><code class="nb">is_int</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">integer</code><code class="p">(</code><code class="s1">'some_integer'</code><code class="p">));</code>&#13;
<code class="c1">// true</code>&#13;
&#13;
<code class="nx">dump</code><code class="p">(</code><code class="nb">is_float</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">float</code><code class="p">(</code><code class="s1">'some_float'</code><code class="p">));</code>&#13;
<code class="c1">// true</code>&#13;
&#13;
<code class="nx">dump</code><code class="p">(</code><code class="nb">is_string</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'some_string'</code><code class="p">));</code>&#13;
<code class="c1">// true</code>&#13;
&#13;
<code class="nx">dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">enum</code><code class="p">(</code><code class="s1">'subscription'</code><code class="p">,</code> <code class="nx">SubscriptionStatusEnum</code><code class="o">::</code><code class="na">class</code><code class="p">));</code>&#13;
<code class="c1">// 'active', assuming that's a valid status for the SubscriptionStatusEnum</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="$request-&gt;dump() and -&gt;dd()" data-type="sect2"><div class="sect2" id="id157">&#13;
<h2>$request-&gt;dump() and -&gt;dd()</h2>&#13;
&#13;
<p><code>$request-&gt;dump()</code> and <code>$request-&gt;dd()</code> are<a data-primary="$request-&gt;dump() method" data-type="indexterm" id="id1212"/><a data-primary="$request-&gt;dd() method" data-type="indexterm" id="id1213"/> helper methods for dumping the request. For both, you can dump the whole request by not passing any parameters or dump only selected fields by passing an array. <code>$request-&gt;dump()</code> dumps and then continues, while <code>$request-&gt;dd()</code> dumps and then stops execution of the script. <a data-type="xref" href="#EX629">Example 7-12</a> illustrates their use.</p>&#13;
<div data-type="example" id="EX629">&#13;
<h5><span class="label">Example 7-12. </span><code>$request-&gt;dump()</code> and <code>$request-&gt;dd()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// dumping the whole request</code>&#13;
<code class="nv">$request</code><code class="o">-&gt;</code><code class="na">dump</code><code class="p">()</code>&#13;
<code class="nv">$request</code><code class="o">-&gt;</code><code class="na">dd</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// dumping just two fields</code>&#13;
<code class="nv">$request</code><code class="o">-&gt;</code><code class="na">dump</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'utm'</code><code class="p">]);</code>&#13;
<code class="nv">$request</code><code class="o">-&gt;</code><code class="na">dd</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'utm'</code><code class="p">]);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Array Input" data-type="sect2"><div class="sect2" id="id158">&#13;
<h2>Array Input</h2>&#13;
&#13;
<p>Laravel<a data-primary="array input" data-type="indexterm" id="id1214"/> also provides convenience helpers for accessing data from array input. Just<a data-primary="dot notation" data-type="indexterm" id="id1215"/> use the “dot” notation to indicate the steps of digging into the array structure, like in <a data-type="xref" href="#EX606">Example 7-13</a>.</p>&#13;
<div data-type="example" id="EX606">&#13;
<h5><span class="label">Example 7-13. </span>Dot notation to access array values in user data</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- GET route form view at /employees/create --&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/employees/"</code><code class="p">&gt;</code>&#13;
    @csrf&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"employees[0][firstName]"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"employees[0][lastName]"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"employees[1][firstName]"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"employees[1][lastName]"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// POST route at /employees</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'employees'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$employeeZeroFirstName</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'employees.0.firstName'</code><code class="p">);</code>&#13;
    <code class="nv">$allLastNames</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'employees.*.lastName'</code><code class="p">);</code>&#13;
    <code class="nv">$employeeOne</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'employees.1'</code><code class="p">);</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$employeeZeroFirstname</code><code class="p">,</code> <code class="nv">$allLastNames</code><code class="p">,</code> <code class="nv">$employeeOne</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// If forms filled out as "Jim" "Smith" "Bob" "Jones":</code>&#13;
<code class="c1">// $employeeZeroFirstName = 'Jim';</code>&#13;
<code class="c1">// $allLastNames = ['Smith', 'Jones'];</code>&#13;
<code class="c1">// $employeeOne = ['firstName' =&gt; 'Bob', 'lastName' =&gt; 'Jones'];</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON Input (and $request-&gt;json())" data-type="sect2"><div class="sect2" id="id159">&#13;
<h2>JSON Input (and $request-&gt;json())</h2>&#13;
&#13;
<p>So<a data-primary="JSON operations" data-secondary="JSON input" data-type="indexterm" id="id1216"/><a data-primary="$request-&gt;json() method" data-type="indexterm" id="id1217"/> far we’ve covered input from query strings (<code>GET</code>) and form submissions (<code>POST</code>). But there’s another form of user input that’s becoming more common with the advent of JavaScript SPAs: the JSON request. It’s essentially just a <code>POST</code> request with the body set to JSON instead of a traditional form <code>POST</code>.</p>&#13;
&#13;
<p>Let’s take a look at what it might look like to submit some JSON to a Laravel route, and how to use<a data-primary="$request-&gt;input() method" data-type="indexterm" id="id1218"/> <code>$request-&gt;input()</code> to pull out that data (<a data-type="xref" href="#EX607">Example 7-14</a>).</p>&#13;
<div data-type="example" id="EX607">&#13;
<h5><span class="label">Example 7-14. </span>Getting data from JSON with <code>$request-&gt;input()</code></h5>&#13;
&#13;
<pre data-code-language="http" data-type="programlisting"><code class="nf">POST</code> <code class="nn">/post-route</code> <code class="kr">HTTP</code><code class="o">/</code><code class="m">1.1</code>&#13;
<code class="na">Content-Type</code><code class="o">:</code> <code class="l">application/json</code>&#13;
&#13;
<code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"firstName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Joe"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"lastName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Schmoe"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"spouse"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"firstName"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Jill"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="nt">"lastName"</code><code class="p">:</code><code class="s2">"Schmoe"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Post-route</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'post-route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$firstName</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'firstName'</code><code class="p">);</code>&#13;
    <code class="nv">$spouseFirstname</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'spouse.firstName'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Since <code>$request-&gt;input()</code> is smart enough to pull user data from <code>GET</code>, <code>POST</code>, or JSON, you may wonder why Laravel even offers <code>$request-&gt;json()</code>. There are two reasons you might prefer <code>$request-&gt;json()</code>. First, you might want to just be more explicit to other programmers working on your project about where you’re expecting the data to come from. And second, if the <code>POST</code> doesn’t have the correct <code>application/json</code> headers, <code>$request-&gt;input()</code> won’t pick it up as JSON, but <code>$request-&gt;json()</code> will.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1219">&#13;
<h1>Facade Namespaces, the request() Global Helper, <br/>and Injecting $request</h1>&#13;
<p>Any<a data-primary="facades" data-secondary="facade namespaces" data-type="indexterm" id="id1220"/><a data-primary="helpers" data-secondary="request() global helper" data-type="indexterm" id="id1221"/><a data-primary="request() global helper" data-type="indexterm" id="id1222"/> time you’re using facades inside of namespaced classes (e.g., controllers), you’ll have to add the full facade path to the import block at the top of your file (e.g., <code>use Illuminate\Support\Facades\Request</code>).</p>&#13;
&#13;
<p>Because of this, several of the facades also have a companion global helper function. If these helper functions are run with no parameters, they expose the same syntax as the facade (e.g., <code>request()-&gt;has()</code> is the same as <code>Request::has()</code>). They also have a default behavior for when you pass them a parameter (e.g., <code>request('firstName')</code> is a shortcut to <code>request()-&gt;input('firstName')</code>).</p>&#13;
&#13;
<p>With <code>Request</code>, we’ve been covering injecting an instance of the <code>Request</code> object, but you could also use the <code>Request</code> facade or the <code>request()</code> global helper. Take a look at <a data-type="xref" href="ch10.html#requests_and_responses">Chapter 10</a> to learn more.<a data-primary="" data-startref="UPDinject07" data-type="indexterm" id="id1223"/><a data-primary="" data-startref="ROinject07" data-type="indexterm" id="id1224"/></p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Route Data" data-type="sect1"><div class="sect1" id="id160">&#13;
<h1>Route Data</h1>&#13;
&#13;
<p>It<a data-primary="user-provided data" data-secondary="route data" data-type="indexterm" id="id1225"/><a data-primary="route data, from users" data-type="indexterm" id="id1226"/><a data-primary="Request objects" data-secondary="URL data" data-type="indexterm" id="id1227"/> might not be the first thing you think of when you imagine “user data,” but the URL is just as much user data as anything else in this chapter.</p>&#13;
&#13;
<p>There<a data-primary="Uniform Resource Locators (URLs)" data-secondary="getting data from" data-type="indexterm" id="id1228"/> are two primary ways you’ll get data from the URL: via <code>Request</code> objects and via route parameters.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="From Request" data-type="sect2"><div class="sect2" id="id161">&#13;
<h2>From Request</h2>&#13;
&#13;
<p>Injected <code>Request</code> objects (and the <code>Request</code> facade and the <code>request()</code> helper) have several methods available to represent the state of the current page’s URL, but right now, let’s focus on getting information about the URL segments.</p>&#13;
&#13;
<p>Each group of characters after the domain in a URL is called a <em>segment</em>. So, <em><a class="bare" href="http://www.myapp.com/users/15"><em class="hyperlink">http://www.myapp.com/users/15</em></a></em> has two segments: <em>users</em> and <em>15</em>.</p>&#13;
&#13;
<p>As<a data-primary="$request-&gt;segment() method" data-type="indexterm" id="id1229"/> you can probably guess, we have two methods available to us: <code>$request</code><span class="keep-together"><code>-&gt;segments()</code></span> returns an array of all segments, and <code>$request⁠-&gt;​s⁠e⁠g⁠m⁠e⁠n⁠t⁠(<em>$segmentId</em>)</code> allows us to get the value of a single segment. Note that <span class="keep-together">segments</span> are returned on a <span class="keep-together">1-based</span> index, so in the preceding example, <code>$request⁠-&gt;​s⁠e⁠g⁠m⁠e⁠n⁠t⁠(1)</code> would return <em>users</em>.</p>&#13;
&#13;
<p><code>Request</code> objects, the <code>Request</code> facade, and the <code>request()</code> global helper provide quite a few more methods to help us get data out of the URL. To learn more, check out <a data-type="xref" href="ch10.html#requests_and_responses">Chapter 10</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="From Route Parameters" data-type="sect2"><div class="sect2" id="id674">&#13;
<h2>From Route Parameters</h2>&#13;
&#13;
<p>The other primary way we get data about the URL is from route parameters, which are injected into the controller method or closure that is serving a current route, as shown in <a data-type="xref" href="#EX608">Example 7-15</a>.</p>&#13;
<div data-type="example" id="EX608">&#13;
<h5><span class="label">Example 7-15. </span>Getting URL details from route parameters</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'users/{id}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$id</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// If the user visits myapp.com/users/15/, $id will equal 15</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>To learn more about routes and route binding, check out <a data-type="xref" href="ch03.html#routing">Chapter 3</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uploaded Files" data-type="sect1"><div class="sect1" id="id162">&#13;
<h1>Uploaded Files</h1>&#13;
&#13;
<p>We’ve<a data-primary="user-provided data" data-secondary="uploaded files" data-type="indexterm" id="UPDupload07"/><a data-primary="Request objects" data-secondary="uploaded files" data-type="indexterm" id="ROupload07"/><a data-primary="$request-&gt;file() method" data-type="indexterm" id="id1230"/><a data-primary="files" data-secondary="user data from uploaded" data-type="indexterm" id="id1231"/> talked about different ways to interact with users’ text input, but there’s also the matter of file uploads to consider. <code>Request</code> objects provide access to any uploaded files using the <code>$request-&gt;file()</code> method, which takes the file’s input name as a parameter and returns an instance of <code>Symfony\Component\HttpFoundation\File\UploadedFile</code>. Let’s walk through an example. First, our form, in <a data-type="xref" href="#EX609">Example 7-16</a>.</p>&#13;
<div data-type="example" id="EX609">&#13;
<h5><span class="label">Example 7-16. </span>A form to upload files</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">enctype</code><code class="o">=</code><code class="s">"multipart/form-data"</code><code class="p">&gt;</code>&#13;
    @csrf&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"text"</code> <code class="na">name</code><code class="o">=</code><code class="s">"name"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"file"</code> <code class="na">name</code><code class="o">=</code><code class="s">"profile_picture"</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>Now<a data-primary="$request-&gt;all() method" data-type="indexterm" id="id1232"/><a data-primary="$request-&gt;input() method" data-type="indexterm" id="id1233"/> let’s take a look at what we get from running <code>$request-&gt;all()</code>, as shown in <a data-type="xref" href="#EX610">Example 7-17</a>. Note that <code>$request-&gt;input('profile_picture')</code> will return <code>null</code>; we need to use <code>$request-&gt;file('profile_picture')</code> instead.</p>&#13;
<div data-type="example" id="EX610">&#13;
<h5><span class="label">Example 7-17. </span>The output from submitting the form in <a data-type="xref" href="#EX609">Example 7-16</a></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'form'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Output:</code>&#13;
<code class="c1">// [</code>&#13;
<code class="c1">//     "_token" =&gt; "token here",</code>&#13;
<code class="c1">//     "name" =&gt; "asdf",</code>&#13;
<code class="c1">//     "profile_picture" =&gt; UploadedFile {},</code>&#13;
<code class="c1">// ]</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'form'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">hasFile</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">));</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Output:</code>&#13;
<code class="c1">// UploadedFile (details)</code></pre></div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1234">&#13;
<h1>Validating a File Upload</h1>&#13;
<p>As<a data-primary="files" data-secondary="validating file uploads" data-type="indexterm" id="id1235"/><a data-primary="validation" data-secondary="of file uploads" data-secondary-sortas="file uploads" data-type="indexterm" id="id1236"/> you can see in <a data-type="xref" href="#EX610">Example 7-17</a>, we have access to <code>$request-&gt;hasFile()</code> to see whether the user uploaded a file. We can also check whether the file upload was successful by using <code>isValid()</code> on the file itself:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">isValid</code><code class="p">())</code> <code class="p">{</code>&#13;
    <code class="c1">//</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Because <code>isValid()</code> is called on the file itself, it will error if the user didn’t upload a file. So, to check for both, you’d need to check for the file’s existence first:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">hasFile</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">)</code> <code class="o">&amp;&amp;</code>&#13;
    <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">isValid</code><code class="p">())</code> <code class="p">{</code>&#13;
    <code class="c1">//</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Laravel also offers file-specific validation rules, allowing you to require file uploads to match certain mime types, file sizes or lengths, and more. Take a look at the <a href="https://oreil.ly/bamub">validation docs</a> to learn more.</p>&#13;
&#13;
<p>Symfony’s <code>UploadedFile</code> class extends PHP’s native <code>SplFileInfo</code> with methods allowing you to easily inspect and manipulate the file. This list isn’t exhaustive, but it gives you a taste of what you can do:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>guessExtension()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getMimeType()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>store(<em>$path</em>, <em>$storageDisk = default disk</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>storeAs(<em>$path</em>, <em>$newName</em>, <em>$storageDisk = default disk</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>storePublicly(<em>$path</em>, <em>$storageDisk = default disk</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>storePubliclyAs(<em>$path</em>, <em>$newName</em>, <em>$storageDisk = default disk</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>move(<em>$directory</em>, <em>$newName = null</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getClientOriginalName()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getClientOriginalExtension()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getClientMimeType()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>guessClientExtension()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getClientSize()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>getError()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>isValid()</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>As you can see, most of the methods have to do with getting information about the uploaded file, but there’s one that you’ll likely use more than all the others: <code>store()</code>, which takes the file that was uploaded with the request and stores it in a specified directory on your server. Its first parameter is the destination directory, and the optional second parameter is the storage disk (<code>s3</code>, <code>local</code>, etc.) to use to store the file. You can see a common workflow in <a data-type="xref" href="#EX611">Example 7-18</a>.</p>&#13;
<div data-type="example" id="EX611">&#13;
<h5><span class="label">Example 7-18. </span>Common file upload workflow</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">hasFile</code><code class="p">(</code><code class="s1">'profile_picture'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nv">$path</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">profile_picture</code><code class="o">-&gt;</code><code class="na">store</code><code class="p">(</code><code class="s1">'profiles'</code><code class="p">,</code> <code class="s1">'s3'</code><code class="p">);</code>&#13;
    <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">profile_picture</code> <code class="o">=</code> <code class="nv">$path</code><code class="p">;</code>&#13;
    <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If you need to specify the filename, you can use <code>storeAs()</code> instead of <code>store()</code>. The first parameter is still the path; the second is the filename, and the optional third parameter is the storage disk to use.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Proper Form Encoding for File Uploads</h1>&#13;
<p>If<a data-primary="files" data-secondary="proper form encoding for uploads" data-type="indexterm" id="id1237"/> you get <code>null</code> when you try to get the contents of a file from your request, you might’ve forgotten to set the encoding type on your form. Make sure to add the attribute <code>enctype="multipart/form-data"</code> on your<a data-primary="" data-startref="UPDupload07" data-type="indexterm" id="id1238"/><a data-primary="" data-startref="ROupload07" data-type="indexterm" id="id1239"/> form:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"post"</code> <code class="na">enctype</code><code class="o">=</code><code class="s">"multipart/form-data"</code><code class="p">&gt;</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Validation" data-type="sect1"><div class="sect1" id="validation">&#13;
<h1>Validation</h1>&#13;
&#13;
<p>Laravel<a data-primary="user-provided data" data-secondary="validation of incoming data" data-type="indexterm" id="UPDvalid07"/><a data-primary="data" data-secondary="validating incoming" data-type="indexterm" id="Dincom07"/><a data-primary="validation" data-secondary="of incoming data" data-secondary-sortas="incoming data" data-type="indexterm" id="Vincom07"/> has quite a few ways you can validate incoming data. We’ll cover form requests in the next section, so that leaves us with two primary options: validating manually or using the <code>validate()</code> method on the <code>Request</code> object. Let’s start with the simpler, and more common, <code>validate()</code>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="validate() on the Request Object" data-type="sect2"><div class="sect2" id="validation_on_request">&#13;
<h2>validate() on the Request Object</h2>&#13;
&#13;
<p>The<a data-primary="Request objects" data-secondary="validate() method" data-type="indexterm" id="id1240"/><a data-primary="validate() method" data-type="indexterm" id="id1241"/> <code>Request</code> object has a <code>validate()</code> method that provides a convenient shortcut for the most common validation workflow. Take a look at <a data-type="xref" href="#EX612">Example 7-19</a>.</p>&#13;
<div data-type="example" id="EX612">&#13;
<h5><span class="label">Example 7-19. </span>Basic usage of request validation</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'recipes/create'</code><code class="p">,</code> <code class="p">[</code><code class="nx">RecipeController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'create'</code><code class="p">]);</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'recipes'</code><code class="p">,</code> <code class="p">[</code><code class="nx">RecipeController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'store'</code><code class="p">]);</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/Http/Controllers/RecipeController.php</code>&#13;
<code class="k">class</code> <code class="nc">RecipeController</code> <code class="k">extends</code> <code class="nx">Controller</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">create</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'recipes.create'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">validate</code><code class="p">([</code>&#13;
            <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'required|unique:recipes|max:125'</code><code class="p">,</code>&#13;
            <code class="s1">'body'</code> <code class="o">=&gt;</code> <code class="s1">'required'</code>&#13;
        <code class="p">]);</code>&#13;
&#13;
        <code class="c1">// Recipe is valid; proceed to save it</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We only have four lines of code running our validation here, but they’re doing a lot.</p>&#13;
&#13;
<p>First, we explicitly define the fields we expect and apply rules (here separated by the pipe character, <code>|</code>) to each individually.</p>&#13;
&#13;
<p>Next, the <code>validate()</code> method checks the incoming data from <code>$request</code> and determines whether or not it is valid.</p>&#13;
&#13;
<p>If the data is valid, the <code>validate()</code> method ends and we can move on with the controller method, saving the data or whatever else.</p>&#13;
&#13;
<p>But if the data isn’t valid, it throws a <code>ValidationException</code>. This contains instructions to the router about how to handle this exception. If the request is from JavaScript (or if it’s requesting JSON as a response), the exception will create a JSON response containing the validation errors. If not, the exception will return a redirect to the previous page, together with all of the user input and the validation errors—​perfect for repopulating a failed form and showing some errors.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More on Laravel’s Validation Rules" data-type="sect2"><div class="sect2" id="id675">&#13;
<h2>More on Laravel’s Validation Rules</h2>&#13;
&#13;
<p>In our examples here (like in the docs) we’re using the “pipe” syntax: <code>'<em>fieldname</em>': '<em>rule</em>|<em>otherRule</em>|<em>anotherRule</em>'</code>. But you can also use the array syntax to do the same thing: <code>'<em>fieldname</em>': ['<em>rule</em>', '<em>otherRule</em>', '<em>anotherRule</em>']</code>.</p>&#13;
&#13;
<p>Additionally, you can validate nested properties. This matters if you use HTML’s array syntax, which allows you to, for example, have multiple “users” on an HTML form, each with an associated name. Here’s how you validate that:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">validate</code><code class="p">([</code>&#13;
    <code class="s1">'user.name'</code> <code class="o">=&gt;</code> <code class="s1">'required'</code><code class="p">,</code>&#13;
    <code class="s1">'user.email'</code> <code class="o">=&gt;</code> <code class="s1">'required|email'</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre>&#13;
&#13;
<p>We don’t have enough space to cover every possible validation rule here, but here are a few of the most common rules and their functions:</p>&#13;
<dl>&#13;
<dt>Require the field</dt>&#13;
<dd>&#13;
<p><code>required</code>; <code>required_if:<em>anotherField,equalToThisValue</em></code>;<br/>&#13;
<code>required_unless:<em>anotherField,equalToThisValue</em></code></p>&#13;
</dd>&#13;
<dt>Exclude the field from the request output</dt>&#13;
<dd>&#13;
<p><code>exclude_if:<em>anotherField,equalToThisValue</em></code>;<br/>&#13;
<code>exclude_unless:<em>anotherField,equalToThisValue</em></code></p>&#13;
</dd>&#13;
<dt>Field must contain certain types of characters</dt>&#13;
<dd>&#13;
<p><code>alpha</code>; <code>alpha_dash</code>; <code>alpha_num</code>; <code>numeric</code>; <code>integer</code></p>&#13;
</dd>&#13;
<dt>Field must contain certain patterns</dt>&#13;
<dd>&#13;
<p><code>email</code>; <code>active_url</code>; <code>ip</code></p>&#13;
</dd>&#13;
<dt>Dates</dt>&#13;
<dd>&#13;
<p><code>after:<em>date</em></code>; <code>before:<em>date</em></code> (<code><em>date</em></code> can be any valid string that <span class="keep-together"><code>strtotime()</code> can</span> handle)</p>&#13;
</dd>&#13;
<dt>Numbers</dt>&#13;
<dd>&#13;
<p><code>between:<em>min</em></code>,<code><em>max</em></code>; <code>min:<em>num</em></code>; <code>max:<em>num</em></code>; <code>size:<em>num</em></code> (<code>size</code> tests against length for strings, value for integers, <code>count</code> for arrays, or size in KB for files.)</p>&#13;
</dd>&#13;
<dt>Image dimensions</dt>&#13;
<dd>&#13;
<p><code>dimensions:min_width=<em>XXX</em></code>; can also use and/or combine with <code>max_width</code>, <code>min_height</code>, <code>max_height</code>, <code>width</code>, <code>height</code>, and <code>ratio</code></p>&#13;
</dd>&#13;
<dt>Databases</dt>&#13;
<dd>&#13;
<p><code>exists:<em>tableName</em></code>; <code>unique:<em>tableName</em></code> (expects to look in the same table column as the field name; see the <a href="https://oreil.ly/JmbQC">validation docs</a> for how to &#13;
<span class="keep-together">customize</span>)</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>You can also specify the Eloquent model instead of the table name in the database validation rules:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'exists:App\Models\Contact,name'</code><code class="p">,</code>&#13;
<code class="s1">'phone'</code> <code class="o">=&gt;</code> <code class="s1">'unique:App\Models\Contact,phone'</code><code class="p">,</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manual Validation" data-type="sect2"><div class="sect2" id="id164">&#13;
<h2>Manual Validation</h2>&#13;
&#13;
<p>If<a data-primary="manual validation" data-type="indexterm" id="id1242"/> you are not working in a controller, or if for some other reason the previously described flow is not a good fit, you can manually create a <code>Validator</code> instance using the <code>Validator</code> facade and check for success or failure like in <a data-type="xref" href="#EX613">Example 7-20</a>.</p>&#13;
<div data-type="example" id="EX613">&#13;
<h5><span class="label">Example 7-20. </span>Manual validation</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'recipes/create'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'recipes.create'</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'recipes'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Illuminate\Http\Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$validator</code> <code class="o">=</code> <code class="nx">Validator</code><code class="o">::</code><code class="na">make</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">(),</code> <code class="p">[</code>&#13;
        <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'required|unique:recipes|max:125'</code><code class="p">,</code>&#13;
        <code class="s1">'body'</code> <code class="o">=&gt;</code> <code class="s1">'required'</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$validator</code><code class="o">-&gt;</code><code class="na">fails</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'recipes/create'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">withErrors</code><code class="p">(</code><code class="nv">$validator</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">withInput</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Recipe is valid; proceed to save it</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>As you can see, we create an instance of a validator by passing it our input as the first parameter and the validation rules as the second parameter. The validator exposes a <code>fails()</code> method that we can check against and can be passed into the <code>withErrors()</code> method of the redirect.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Validated Data" data-type="sect2"><div class="sect2" id="id165">&#13;
<h2>Using Validated Data</h2>&#13;
&#13;
<p>Once you’ve validated your data, you can pull it from the request in a way that ensures you’re only working with validated data. There are two main options: <code>validated()</code> and <code>safe()</code>. You can run these methods either on the <code>$request</code> object, or, if you created a manual validator, the <code>$validator</code> instance.</p>&#13;
&#13;
<p>The<a data-primary="validated() method" data-type="indexterm" id="id1243"/> <code>validated()</code> method returns an array of all of the data that’s been validated, as shown in <a data-type="xref" href="#validated_data_validated">Example 7-21</a>.</p>&#13;
<div data-type="example" id="validated_data_validated">&#13;
<h5><span class="label">Example 7-21. </span>Getting validated data with <code>validated()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Both return an array of validated user input</code>&#13;
<code class="nv">$validated</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">validated</code><code class="p">();</code>&#13;
<code class="nv">$validated</code> <code class="o">=</code> <code class="nv">$validator</code><code class="o">-&gt;</code><code class="na">validated</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>The<a data-primary="safe() method" data-type="indexterm" id="id1244"/> <code>safe()</code> method, on the other hand, returns an object that gives you access to <code>all()</code>, <code>only()</code>, and <code>except()</code> methods, as you can see in <a data-type="xref" href="#validated_data_safe">Example 7-22</a>.</p>&#13;
<div data-type="example" id="validated_data_safe">&#13;
<h5><span class="label">Example 7-22. </span>Getting validated data with <code>safe()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$validated</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">safe</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'email'</code><code class="p">]);</code>&#13;
&#13;
<code class="nv">$validated</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">safe</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">except</code><code class="p">([</code><code class="s1">'password'</code><code class="p">]);</code>&#13;
&#13;
<code class="nv">$validated</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">safe</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom Rule Objects" data-type="sect2"><div class="sect2" id="id166">&#13;
<h2>Custom Rule Objects</h2>&#13;
&#13;
<p>If<a data-primary="custom validation rules, creating" data-type="indexterm" id="id1245"/> the validation rule you need doesn’t exist in Laravel, you can create your own. To create a custom rule, run <code>php artisan make:rule <em>RuleName</em></code> and then edit that file in <em>app/Rules/{RuleName}.php</em>.</p>&#13;
&#13;
<p>You’ll<a data-primary="validate() method" data-type="indexterm" id="id1246"/> get the method <code>validate()</code> in your rule class out of the box. The <code>validate()</code> method should accept an attribute name as the first parameter, the user-provided value as the second, and the third a closure that you’ll when the validation fails; you can use <code>:attribute</code> as a placeholder in your message for the attribute name.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX621">Example 7-23</a> as an example.</p>&#13;
<div data-type="example" id="EX621">&#13;
<h5><span class="label">Example 7-23. </span>A sample custom rule</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">AllowedEmailDomain</code> <code class="k">implements</code> <code class="nx">ValidationRule</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">validate</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$attribute</code><code class="p">,</code> <code class="nx">mixed</code> <code class="nv">$value</code><code class="p">,</code> <code class="nx">Closure</code> <code class="nv">$fail</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">if</code><code class="p">(</code><code class="o">!</code> <code class="nb">in_array</code><code class="p">(</code><code class="nx">Str</code><code class="o">::</code><code class="na">after</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="s1">'@'</code><code class="p">),</code> <code class="p">[</code><code class="s1">'tighten.co'</code><code class="p">])){</code>&#13;
            <code class="nv">$fail</code><code class="p">(</code><code class="s1">'The :attribute field is not from an allowed email provider.'</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To use this rule, just pass an instance of the rule object to your validator:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">validate</code><code class="p">([</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="k">new</code> <code class="nx">AllowedEmailDomain</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Displaying Validation Error Messages" data-type="sect2"><div class="sect2" id="id167">&#13;
<h2>Displaying Validation Error Messages</h2>&#13;
&#13;
<p>We’ve<a data-primary="error messages" data-secondary="validation errors" data-type="indexterm" id="id1247"/><a data-primary="validation" data-secondary="displaying error messages" data-type="indexterm" id="id1248"/><a data-primary="messages" data-secondary="validation error messages" data-type="indexterm" id="id1249"/> already covered much of this in <a data-type="xref" href="ch06.html#frontend_components">Chapter 6</a>, but here’s a quick refresher on how to display errors from validation.</p>&#13;
&#13;
<p>The <code>validate()</code> method on requests (and the <code>withErrors()</code> method on redirects that it relies on) flashes any errors to the session. These errors are made available to the view you’re being redirected to in the <code>$errors</code> variable. And remember that as a part of Laravel’s magic, that <code>$errors</code> variable will be available every time you load the view, even if it’s just empty, so you don’t have to check if it exists with <code>isset()</code>.</p>&#13;
&#13;
<p>That means you can do something like <a data-type="xref" href="#EX614">Example 7-24</a> on every page.</p>&#13;
<div data-type="example" id="EX614">&#13;
<h5><span class="label">Example 7-24. </span>Echo validation errors</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">@if ($errors-&gt;any())&#13;
    <code class="p">&lt;</code><code class="nt">ul</code> <code class="na">id</code><code class="o">=</code><code class="s">"errors"</code><code class="p">&gt;</code>&#13;
        @foreach ($errors-&gt;all() as $error)&#13;
            <code class="p">&lt;</code><code class="nt">li</code><code class="p">&gt;</code>{{ $error }}<code class="p">&lt;/</code><code class="nt">li</code><code class="p">&gt;</code>&#13;
        @endforeach&#13;
    <code class="p">&lt;/</code><code class="nt">ul</code><code class="p">&gt;</code>&#13;
@endif</pre></div>&#13;
&#13;
<p>You can also conditionally echo a single field’s error message. For this you’ll use the <code>@error</code> Blade directive to check for whether there’s an error on a given field.<a data-primary="" data-startref="UPDvalid07" data-type="indexterm" id="id1250"/><a data-primary="" data-startref="Dincom07" data-type="indexterm" id="id1251"/><a data-primary="" data-startref="Vincom07" data-type="indexterm" id="id1252"/></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">@</code><code class="nx">error</code><code class="p">(</code><code class="s1">'first_name'</code><code class="p">)</code>&#13;
    <code class="o">&lt;</code><code class="nx">span</code><code class="o">&gt;</code><code class="p">{{</code> <code class="nv">$message</code> <code class="p">}}</code><code class="o">&lt;/</code><code class="nx">span</code><code class="o">&gt;</code>&#13;
<code class="o">@</code><code class="nx">enderror</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Form Requests" data-type="sect1"><div class="sect1" id="form_requests">&#13;
<h1>Form Requests</h1>&#13;
&#13;
<p>As<a data-primary="user-provided data" data-secondary="form requests" data-type="indexterm" id="UPDform07"/><a data-primary="form requests" data-type="indexterm" id="formreq07"/> you build out your applications, you might start noticing some patterns in your controller methods. There are certain patterns that are repeated—​for example, input validation, user authentication and authorization, and possible redirects. If you find yourself wanting a structure to normalize and extract these common behaviors out of your controller methods, you may be interested in Laravel’s form requests.</p>&#13;
&#13;
<p>A form request is a custom request class that is intended to map to the submission of a form, and the request takes the responsibility for validating the request, authorizing the user, and optionally redirecting the user upon a failed validation. Each form request will usually, but not always, explicitly map to a single HTTP request—for example, “Create Comment.”</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Creating a Form Request" data-type="sect2"><div class="sect2" id="id676">&#13;
<h2>Creating a Form Request</h2>&#13;
&#13;
<p>You can create a new form request from the command line:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:request<code class="w"> </code>CreateCommentRequest<code class="w"/></pre>&#13;
&#13;
<p>You now have a form request object available at <em>app/Http/Requests/Create</em><span class="keep-together"><em>Comment</em></span><em>Request.php</em>.</p>&#13;
&#13;
<p>Every form request class provides either one or two public methods. The first is <code>rules()</code>, which needs to return an array of validation rules for this request. The second (optional) method is <code>authorize()</code>; if this returns <code>true</code>, the user is authorized to perform this request, and if <code>false</code>, the user is rejected. Take a look at <a data-type="xref" href="#EX615">Example 7-25</a> to see a sample form request.</p>&#13;
<div data-type="example" id="EX615">&#13;
<h5><span class="label">Example 7-25. </span>Sample form request</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Http\Requests</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\BlogPost</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Foundation\Http\FormRequest</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">CreateCommentRequest</code> <code class="k">extends</code> <code class="nx">FormRequest</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">authorize</code><code class="p">()</code><code class="o">:</code> <code class="nx">bool</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$blogPostId</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">route</code><code class="p">(</code><code class="s1">'blogPost'</code><code class="p">);</code>&#13;
&#13;
        <code class="k">return</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">check</code><code class="p">()</code> <code class="o">&amp;&amp;</code> <code class="nx">BlogPost</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'id'</code><code class="p">,</code> <code class="nv">$blogPostId</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">,</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">())</code><code class="o">-&gt;</code><code class="na">exists</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">rules</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'body'</code> <code class="o">=&gt;</code> <code class="s1">'required|max:1000'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The <code>rules()</code> section of <a data-type="xref" href="#EX615">Example 7-25</a> is pretty self-explanatory, but let’s look at <code>authorize()</code> briefly.</p>&#13;
&#13;
<p class="pagebreak-before">We’re grabbing the segment from the route named <code>blogPost</code>. That’s implying the route definition for this route probably looks a bit like this: <code>Route::post('blogPosts/<em><code>blogPost</code></em>', function () <em><code>{ // Do stuff }</code></em>)</code>. As you can see, we named the route parameter <code>blogPost</code>, which makes it accessible in our <code>Request</code> using <code>$⁠t⁠h⁠i⁠s​-⁠&gt;⁠r⁠o⁠u⁠t⁠e⁠('blogPost')</code>.</p>&#13;
&#13;
<p>We then look at whether the user is logged in and, if so, whether any blog posts exist with that identifier that are owned by the currently logged-in user. You’ve already learned some easier ways to check ownership in <a data-type="xref" href="ch05.html#database_and_eloquent">Chapter 5</a>, but we’ll keep it more explicit here to keep it clean. We’ll cover what implications this has shortly, but the important thing to know is that returning <code>true</code> means the user is authorized to perform the specified action (in this case, creating a comment), and <code>false</code> means the user is not authorized.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using a Form Request" data-type="sect2"><div class="sect2" id="id169">&#13;
<h2>Using a Form Request</h2>&#13;
&#13;
<p>Now that we’ve created a form request object, how do we use it? It’s a little bit of Laravel magic. Any route (closure or controller method) that typehints a form request as one of its parameters will benefit from the definition of that form request.</p>&#13;
&#13;
<p>Let’s try it out, in <a data-type="xref" href="#EX616">Example 7-26</a>.</p>&#13;
<div data-type="example" id="EX616">&#13;
<h5><span class="label">Example 7-26. </span>Using a form request</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'comments'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">App\Http\Requests\CreateCommentRequest</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Store comment</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You might be wondering where we call the form request, but Laravel does it for us. It validates the user input and authorizes the request. If the input is invalid, it’ll act just like the <code>Request</code> object’s <code>validate()</code> method, redirecting the user to the previous page with their input preserved and with the appropriate error messages passed along. And if the user is not authorized, Laravel will return a “403 Forbidden” error and not execute the route code.<a data-primary="" data-startref="UPDform07" data-type="indexterm" id="id1253"/><a data-primary="" data-startref="formreq07" data-type="indexterm" id="id1254"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Model Mass Assignment" data-type="sect1"><div class="sect1" id="id170">&#13;
<h1>Eloquent Model Mass Assignment</h1>&#13;
&#13;
<p>Until<a data-primary="user-provided data" data-secondary="Eloquent model mass assignment" data-type="indexterm" id="id1255"/><a data-primary="Eloquent" data-secondary="mass assignment concept" data-type="indexterm" id="id1256"/><a data-primary="mass assignment" data-type="indexterm" id="id1257"/> now, we’ve been looking at validating at the controller level, which is absolutely the best place to start. But you can also filter the incoming data at the model level.</p>&#13;
&#13;
<p>It’s a common (but not recommended) pattern to pass the entirety of a form’s input directly to a database model. In Laravel, that might look like <a data-type="xref" href="#EX617">Example 7-27</a>.</p>&#13;
<div data-type="example" id="EX617">&#13;
<h5><span class="label">Example 7-27. </span>Passing the entirety of a form to an Eloquent model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$newPost</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>We’re assuming here that the end user is kind and not malicious, and has kept only the fields we want them to edit—maybe the post <code>title</code> or <code>body</code>.</p>&#13;
&#13;
<p>But what if our end user can guess, or discern, that we have an <code>author_id</code> field on that <code>posts</code> table? What if they used their browser tools to add an <code>author_id</code> field and set the ID to be someone else’s ID, and impersonated the other person by creating fake blog posts attributed to them?</p>&#13;
&#13;
<p>Eloquent has a concept called “mass assignment” that allows you to either define a list of fields that should be fillable (using the model’s <code>$fillable</code> property) or a list of fields that shouldn’t be fillable (using the model’s <code>$guarded</code> property) by passing them in an array to <code>create()</code> or <code>update()</code>. See <a data-type="xref" href="ch05.html#mass_assignment">“Mass assignment”</a> for more information.</p>&#13;
&#13;
<p>In our example, we might want to fill out the model like in <a data-type="xref" href="#EX618">Example 7-28</a> to keep our app safe.</p>&#13;
<div data-type="example" id="EX618">&#13;
<h5><span class="label">Example 7-28. </span>Guarding an Eloquent model from mischievous mass assignment</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Post</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Disable mass assignment on the author_id field</code>&#13;
    <code class="k">protected</code> <code class="nv">$guarded</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'author_id'</code><code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>By setting <code>author_id</code> to <code>guarded</code>, we ensure that malicious users will no longer be able to override the value of this field by manually adding it to the contents of a form that they’re sending to our app.</p>&#13;
<div data-type="tip"><h1>Double Protection Using $request-&gt;only()</h1>&#13;
<p>While<a data-primary="$request-&gt;only() method" data-type="indexterm" id="id1258"/> it’s important to do a good job of protecting our models from mass assignment, it’s also worth being careful on the assigning end. Rather than using <code>$request-&gt;all()</code>, consider using <span class="keep-together"><code>$request-&gt;</code></span><code>only()</code> so you can specify which fields you’d like to pass into your model:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$newPost</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">([</code>&#13;
        <code class="s1">'title'</code><code class="p">,</code>&#13;
        <code class="s1">'body'</code><code class="p">,</code>&#13;
    <code class="p">]));</code>&#13;
<code class="p">});</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="{{ Versus {!!" data-type="sect1"><div class="sect1" id="id171">&#13;
<h1>{{ Versus {!!</h1>&#13;
&#13;
<p>Any<a data-primary="user-provided data" data-secondary="guarding against malicious input" data-type="indexterm" id="id1259"/><a data-primary="curly braces, double ({{ }})" data-type="indexterm" id="id1260"/><a data-primary="{{ }} (curly braces, double)" data-type="indexterm" id="id1261"/><a data-primary="{!! !!} (Blade templating)" data-type="indexterm" id="id1262"/> time you display content on a web page that was created by a user, you need to guard against malicious input, such as script injection.</p>&#13;
&#13;
<p>Let’s say you allow your users to write blog posts on your site. You probably don’t want them to be able to inject malicious JavaScript that will run in your unsuspecting visitors’ browsers, right? So, you’ll want to escape any user input that you show on the page to avoid this.</p>&#13;
&#13;
<p>Thankfully, this is almost entirely covered for you. If you use Laravel’s Blade templating engine, the default “echo” syntax (<code>{{ <em>$stuffToEcho</em> }}</code>) runs the output through <code>htmlentities()</code> (PHP’s best way of making user content safe to echo) automatically. You actually have to do <em>extra</em> work to avoid escaping the output, by using the <code>{!! <em>$stuffToEcho</em> !!}</code> syntax.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id431">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>If<a data-primary="user-provided data" data-secondary="testing" data-type="indexterm" id="id1263"/><a data-primary="testing" data-secondary="user-provided data" data-type="indexterm" id="id1264"/> you’re interested in testing your interactions with user input, you’re probably most interested in simulating valid and invalid user input and ensuring that if the input is invalid the user is redirected, and if the input is valid it ends up in the proper place (e.g., the database).</p>&#13;
&#13;
<p>Laravel’s<a data-primary="Dusk" data-secondary="for user interactions" data-type="indexterm" id="id1265"/> application testing framework makes this simple.</p>&#13;
<div data-type="tip"><h1>Laravel Dusk for Testing User Interactions</h1>&#13;
<p>These tests are testing the HTTP layer of your application, but not the actual form fields and interactions. If you want to test specific user interactions on the page and with your forms, you’ll want to pull in Laravel’s Dusk testing package.</p>&#13;
&#13;
<p>Check out <a data-type="xref" href="ch12.html#dusk_testing">“Testing with Dusk”</a> to learn how to install and use Dusk in your tests.</p>&#13;
</div>&#13;
&#13;
<p>Let’s start with an invalid route that we expect to be rejected, as in <a data-type="xref" href="#EX619">Example 7-29</a>.</p>&#13;
<div data-type="example" id="EX619">&#13;
<h5><span class="label">Example 7-29. </span>Testing that invalid input is rejected</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_input_missing_a_title_is_rejected</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'body'</code> <code class="o">=&gt;</code> <code class="s1">'This is the body of my post'</code><code class="p">]);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertRedirect</code><code class="p">();</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Here we assert that after invalid input the user is redirected, with errors attached. You can see we’re using a few custom PHPUnit assertions that Laravel adds here.</p>&#13;
&#13;
<p>So, how do we test our route’s success? Check out <a data-type="xref" href="#EX620">Example 7-30</a>.</p>&#13;
<div data-type="example" id="EX620">&#13;
<h5><span class="label">Example 7-30. </span>Testing that valid input is processed</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_valid_input_should_create_a_post_in_the_database</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'Post Title'</code><code class="p">,</code> <code class="s1">'body'</code> <code class="o">=&gt;</code> <code class="s1">'This is the body'</code><code class="p">]);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'Post Title'</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Note that if you’re testing something using the database, you’ll need to learn more about database migrations and transactions. More on that in <a data-type="xref" href="ch12.html#testing">Chapter 12</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id432">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>There<a data-primary="user-provided data" data-secondary="overview of" data-type="indexterm" id="id1266"/> are a lot of ways to get the same data: using the <code>Request</code> facade, using the <code>request()</code> global helper, and injecting an instance of <code>Illuminate\Http\Request</code>. Each exposes the ability to get all input, some input, or specific pieces of data, and there can be some special considerations for files and JSON input.</p>&#13;
&#13;
<p>URL path segments are also a possible source of user input, and they’re also accessible via the request tools.</p>&#13;
&#13;
<p>Validation can be performed manually with <code>Validator::make()</code>, or automatically using the <code>validate()</code> request method or form requests. Each automatic tool, upon failed validation, redirects the user to the previous page with all old input stored and errors passed along.</p>&#13;
&#13;
<p>Views and Eloquent models also need to be protected from nefarious user input. You can protect Blade views by using the double curly brace syntax (<code>{{ }}</code>), which escapes user input. You can protect models by only passing specific fields into bulk methods using <code>$request-&gt;only()</code> and by defining the mass assignment rules on the model itself.</p>&#13;
</div></section>&#13;
</div></section></body></html>