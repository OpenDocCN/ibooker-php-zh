<html><head></head><body><section data-pdf-bookmark="Chapter 13. Writing APIs" data-type="chapter" epub:type="chapter"><div class="chapter" id="writing_apis">&#13;
<h1><span class="label">Chapter 13. </span>Writing APIs</h1>&#13;
&#13;
&#13;
<p>One of the most common tasks Laravel developers are given is to create an API, usually JSON and REST or REST-like, that allows third parties to interact with the Laravel application’s data.</p>&#13;
&#13;
<p>Laravel makes it incredibly easy to work with JSON, and its resource controllers are already structured around REST verbs and patterns. In this chapter you’ll learn about some basic API-writing concepts, the tools Laravel provides for writing APIs, and some external tools and organizational systems you’ll want to consider when writing your first Laravel API.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Basics of REST-Like JSON APIs" data-type="sect1"><div class="sect1" id="intro_to_rest">&#13;
<h1>The Basics of REST-Like JSON APIs</h1>&#13;
&#13;
<p>Representational state transfer (REST) is an<a data-primary="APIs (application programming interfaces)" data-secondary="REST-like JSON APIs" data-type="indexterm" id="id1627"/><a data-primary="representational state transfer (REST)" data-secondary="characteristics of RESTful APIs" data-type="indexterm" id="id1628"/> architectural style for building APIs. Technically, REST is either a broad definition that could apply to almost the entirety of the internet or something so specific that <em>no one</em> actually uses it, so don’t let yourself get overwhelmed by the definition or caught in an argument with a pedant. When we talk about RESTful or REST-like APIs in the Laravel world, we’re generally talking about APIs with a few common characteristics:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>They’re structured around “resources” that can be uniquely represented by URIs, like <span class="keep-together"><code>/cats</code></span> for all cats, <span class="keep-together"><code>/cats/15</code></span> for a single cat with the ID of 15, etc.</p>&#13;
</li>&#13;
<li>&#13;
<p>Interactions with resources primarily take place using HTTP verbs (<code>GET</code> <span class="keep-together"><code>/cats/15</code></span> versus <code>DELETE /cats/15</code>).</p>&#13;
</li>&#13;
<li>&#13;
<p>They’re stateless, meaning there’s no persistent session authentication between requests; each request must uniquely authenticate itself.</p>&#13;
</li>&#13;
<li>&#13;
<p>They’re cacheable and consistent, meaning each request (except for a few authenticated user–specific requests) should return the same result regardless of who the requester is.</p>&#13;
</li>&#13;
<li>&#13;
<p>They return JSON.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The most common API pattern is to have a unique URL structure for each of your Eloquent models that’s exposed as an API resource and allow for users to interact with that resource with specific verbs and get JSON back.  <a data-type="xref" href="#Common_REST_API_endpoint_structures">Example 13-1</a> shows a few possible examples.</p>&#13;
<div data-type="example" id="Common_REST_API_endpoint_structures">&#13;
<h5><span class="label">Example 13-1. </span>Common REST API endpoint structures</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">GET</code> <code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">cats</code>&#13;
<code class="p">[</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">id</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s1">'Fluffy'</code>&#13;
    <code class="p">},</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="s1">'Killer'</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">]</code>&#13;
&#13;
<code class="nx">GET</code> <code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">cats</code><code class="o">/</code><code class="mi">2</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Killer'</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="nx">POST</code> <code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">cats</code> <code class="nx">with</code> <code class="nx">body</code><code class="o">:</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Mr Bigglesworth'</code>&#13;
<code class="p">}</code>&#13;
<code class="p">(</code><code class="nx">creates</code> <code class="k">new</code> <code class="nx">cat</code><code class="p">)</code>&#13;
&#13;
<code class="nx">PATCH</code> <code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">cats</code><code class="o">/</code><code class="mi">3</code> <code class="nx">with</code> <code class="nx">body</code><code class="o">:</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">name</code><code class="o">:</code> <code class="s1">'Mr. Bigglesworth'</code>&#13;
<code class="p">}</code>&#13;
<code class="p">(</code><code class="nx">updates</code> <code class="nx">cat</code><code class="p">)</code>&#13;
&#13;
<code class="nx">DELETE</code> <code class="o">/</code><code class="nx">api</code><code class="o">/</code><code class="nx">cats</code><code class="o">/</code><code class="mi">2</code>&#13;
<code class="p">(</code><code class="nx">deletes</code> <code class="nx">cat</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>This gives you the idea of the basic set of interactions we are likely to have with our APIs. Let’s dig into how to make them happen with Laravel.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controller Organization and JSON Returns" data-type="sect1"><div class="sect1" id="id254">&#13;
<h1>Controller Organization and JSON Returns</h1>&#13;
&#13;
<p>Laravel’s API resource controllers<a data-primary="APIs (application programming interfaces)" data-secondary="controller organization and JSON returns" data-type="indexterm" id="APIcntrl13"/><a data-primary="routing and controllers" data-secondary="controllers" data-tertiary="controller organization and JSON returns" data-type="indexterm" id="RACorg13"/><a data-primary="JSON operations" data-secondary="controller organization and JSON returns" data-type="indexterm" id="JSONcntrl13"/><a data-primary="resource controllers" data-secondary="controller organization and JSON returns" data-type="indexterm" id="RCcntrl13"/> are like normal resource controllers (see <a data-type="xref" href="ch03.html#resource_controllers">“Resource Controllers”</a>) but modified to align with RESTful API routes. For example, they exclude the <code>create()</code> and <code>edit()</code> methods, both of which are irrelevant in an API. Let’s get started there. First we’ll create a new controller for our resource, which we’ll<a data-primary="--api flag" data-type="indexterm" id="id1629"/> route at <code>/api/dogs</code>:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan make:controller Api/DogController --api</pre>&#13;
&#13;
<p><a data-type="xref" href="#generated_api_resource_controller">Example 13-2</a> shows what our API resource controller will look like.</p>&#13;
<div data-type="example" id="generated_api_resource_controller">&#13;
<h5><span class="label">Example 13-2. </span>A generated API resource controller</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Http\Controllers\Api</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Request</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">App\Http\Controllers\Controller</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">DogController</code> <code class="k">extends</code> <code class="nx">Controller</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Display a listing of the resource.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Store a newly created resource in storage.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Display the specified resource.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Update the specified resource in storage.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">update</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Remove the specified resource from storage.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">destroy</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The docblocks pretty much tell the story. <code>index()</code> lists all of the dogs, <code>show()</code> lists a single dog, <code>store()</code> stores a new dog, <code>update()</code> updates a dog, and <code>destroy()</code> removes a dog.</p>&#13;
&#13;
<p>Let’s quickly make a model and a<a data-primary="--migration flag" data-type="indexterm" id="id1630"/> migration so we can work with it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">model</code> <code class="nx">Dog</code> <code class="o">--</code><code class="nx">migration</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">migrate</code></pre>&#13;
&#13;
<p>Great! Now we can fill out our controller methods.</p>&#13;
<div data-type="note" epub:type="note"><h1>Database Requirements for These Code Samples to Work</h1>&#13;
<p>If<a data-primary="databases" data-secondary="requirements for code samples to work" data-type="indexterm" id="id1631"/><a data-primary="code samples, database requirements for" data-type="indexterm" id="id1632"/> you want the code we’re writing here to actually work, you’ll want to add a <code>string()</code> column to the migration named <code>name</code> and another named <code>breed</code>, and either add those columns to the Eloquent model’s <code>fillable</code> property or just set the <code>guarded</code> property of that model equal to an empty array (<code>[]</code>). Later examples will also require columns for <code>weight</code>, <code>color</code>, and relationships for <code>bones</code> and <code>friends</code>.</p>&#13;
</div>&#13;
&#13;
<p>We can take advantage of a great feature of Eloquent here: if you echo an Eloquent results collection, it’ll automatically convert itself to JSON (using the <code>__toString()</code> magic method, if you’re curious). That means if you return a collection of results from a route, you’ll in effect be returning JSON. So, as <a data-type="xref" href="#resource_controller_for_the_dog_entity">Example 13-3</a> demonstrates, this will be some of the simplest code you’ll ever write.</p>&#13;
<div data-type="example" id="resource_controller_for_the_dog_entity">&#13;
<h5><span class="label">Example 13-3. </span>A sample API resource controller for the <code>Dog</code> entity</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">DogController</code> <code class="k">extends</code> <code class="nx">Controller</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'breed'</code><code class="p">]));</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$id</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">update</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$dog</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$id</code><code class="p">);</code>&#13;
        <code class="nv">$dog</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'breed'</code><code class="p">]));</code>&#13;
        <code class="k">return</code> <code class="nv">$dog</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">destroy</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$id</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Dog</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$id</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">delete</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Artisan’s <code>make:model</code> command also has an<a data-primary="--api flag" data-type="indexterm" id="id1633"/> <code>--api</code> flag you can pass to generate the same API-specific controller we generated above:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">model</code> <code class="nx">Dog</code> <code class="o">--</code><code class="nx">api</code></pre>&#13;
&#13;
<p>If<a data-primary="--all flag" data-type="indexterm" id="id1634"/> you want to generate migration, seeder, factory, policy, and resource controller, and both store and update form requests in one command, you can use the <code>--all</code> flag:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">model</code> <code class="nx">Dog</code> <code class="o">--</code><code class="nx">all</code></pre>&#13;
&#13;
<p><a data-type="xref" href="#binding_the_routes_for_a_resource_controller">Example 13-4</a> shows how we can link this up in our routes file. As you can see, we can use <code>Route::apiResource()</code> to automatically map all of these default methods to their appropriate routes and HTTP verbs.</p>&#13;
<div data-type="example" id="binding_the_routes_for_a_resource_controller">&#13;
<h5><span class="label">Example 13-4. </span>Binding the routes for a resource controller</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/api.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">namespace</code><code class="p">(</code><code class="s1">'App\Http\Controllers\Api'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">apiResource</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="nx">DogController</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>There you have it! Your first RESTful API in Laravel. Of course, you’ll need much more nuance: pagination, sorting, authentication, and better-defined response headers. But this is the foundation of everything else.<a data-primary="" data-startref="APIcntrl13" data-type="indexterm" id="id1635"/><a data-primary="" data-startref="RACorg13" data-type="indexterm" id="id1636"/><a data-primary="" data-startref="JSONcntrl13" data-type="indexterm" id="id1637"/><a data-primary="" data-startref="RCcntrl13" data-type="indexterm" id="id1638"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reading and Sending Headers" data-type="sect1"><div class="sect1" id="id255">&#13;
<h1>Reading and Sending Headers</h1>&#13;
&#13;
<p>REST APIs<a data-primary="APIs (application programming interfaces)" data-secondary="reading and sending headers" data-type="indexterm" id="id1639"/><a data-primary="headers, reading and sending" data-type="indexterm" id="id1640"/> often read, and send, noncontent information using headers. For example, any request to GitHub’s API will return headers detailing the current user’s rate limiting status:</p>&#13;
&#13;
<pre data-type="programlisting">X-RateLimit-Limit: 5000&#13;
X-RateLimit-Remaining: 4987&#13;
X-RateLimit-Reset: 1350085394</pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1641">&#13;
<h1>X-* Headers</h1>&#13;
<p>You<a data-primary="X-* headers" data-type="indexterm" id="id1642"/> might be wondering why the GitHub<a data-primary="rate limiting" data-type="indexterm" id="id1643"/> rate limiting headers are prefixed with <code>X-</code>, especially if you see them in the context of other headers returned with the same request:</p>&#13;
&#13;
<pre data-type="programlisting">HTTP/1.1 200 OK&#13;
Server: nginx&#13;
Date: Fri, 12 Oct 2012 23:33:14 GMT&#13;
Content-Type: application/json; charset=utf-8&#13;
Connection: keep-alive&#13;
Status: 200 OK&#13;
ETag: "a00049ba79152d03380c34652f2cb612"&#13;
X-GitHub-Media-Type: github.v3&#13;
X-RateLimit-Limit: 5000&#13;
X-RateLimit-Remaining: 4987&#13;
X-RateLimit-Reset: 1350085394&#13;
Content-Length: 5&#13;
Cache-Control: max-age=0, private, must-revalidate&#13;
X-Content-Type-Options: nosniff</pre>&#13;
&#13;
<p>Any header whose name starts with <code>X-</code> is a header that’s not in the HTTP spec. It might be entirely made up (e.g., <code>X-How-Much-Matt-Loves-This-Page</code>), or part of a common convention that hasn’t made it into the spec yet (e.g., <code>X-Requested-With</code>).</p>&#13;
</div></aside>&#13;
&#13;
<p>Similarly, many APIs allow developers to customize their requests using request headers. For example, GitHub’s API makes it easy to define which version of the API you’d like to use with the <code>Accept</code> header:</p>&#13;
&#13;
<pre data-type="programlisting">Accept: application/vnd.github.v3+json</pre>&#13;
&#13;
<p>If you were to change <code>v3</code> to <code>v2</code>, GitHub would pass your request to version 2 of its API instead.</p>&#13;
&#13;
<p>Let’s learn quickly how to do both in Laravel.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending Response Headers in Laravel" data-type="sect2"><div class="sect2" id="id256">&#13;
<h2>Sending Response Headers in Laravel</h2>&#13;
&#13;
<p>We<a data-primary="response headers, sending" data-type="indexterm" id="id1644"/> already covered this topic quite a bit in <a data-type="xref" href="ch10.html#requests_and_responses">Chapter 10</a>, but here’s a quick refresher. Once you have a response object, you can add a header using <code>header(<em>$headerName</em>, <em>$headerValue</em>)</code>, as seen in <a data-type="xref" href="#adding_a_response_header_in_Laravel">Example 13-5</a>.</p>&#13;
<div data-type="example" id="adding_a_response_header_in_Laravel">&#13;
<h5><span class="label">Example 13-5. </span>Adding a response header in Laravel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="nx">Dog</code><code class="o">::</code><code class="na">all</code><code class="p">())</code>&#13;
        <code class="o">-&gt;</code><code class="na">header</code><code class="p">(</code><code class="s1">'X-Greatness-Index'</code><code class="p">,</code> <code class="mi">12</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Nice and easy.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reading Request Headers in Laravel" data-type="sect2"><div class="sect2" id="id257">&#13;
<h2>Reading Request Headers in Laravel</h2>&#13;
&#13;
<p>If<a data-primary="request headers, reading" data-type="indexterm" id="id1645"/> you have an incoming request, it’s also simple to read any given header.  <a data-type="xref" href="#reading_a_request_header_in_Laravel">Example 13-6</a> illustrates this.</p>&#13;
<div data-type="example" id="reading_a_request_header_in_Laravel">&#13;
<h5><span class="label">Example 13-6. </span>Reading a request header in Laravel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">header</code><code class="p">(</code><code class="s1">'Accept'</code><code class="p">));</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Now that you can read incoming request headers and set headers on your API responses, let’s take a look at how you might want to customize your API.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Pagination" data-type="sect1"><div class="sect1" id="id258">&#13;
<h1>Eloquent Pagination</h1>&#13;
&#13;
<p id="eloquent_pagination">Pagination<a data-primary="APIs (application programming interfaces)" data-secondary="Eloquent pagination" data-type="indexterm" id="id1646"/><a data-primary="pagination" data-type="indexterm" id="id1647"/><a data-primary="Eloquent" data-secondary="pagination system" data-type="indexterm" id="id1648"/> is one of the first places where most APIs need to consider special instructions. Eloquent comes out of the box with a pagination system that hooks directly into the query parameters of any page request. We already covered the paginator component a bit in <a data-type="xref" href="ch06.html#frontend_components">Chapter 6</a>, but here’s a quick refresher.</p>&#13;
&#13;
<p>Any Eloquent call provides a <code>paginate()</code> method, to which you can pass the number of items you’d like to return per page. Eloquent then checks the URL for a page query parameter and, if it’s set, treats that as an indicator of where (how many pages) the user is in a paginated list.</p>&#13;
&#13;
<p>To make your API route ready for automated Laravel pagination, use <code>paginate()</code> instead of <code>all()</code> or <code>get()</code> to call your Eloquent queries in your route; something like <a data-type="xref" href="#paginated_API_route">Example 13-7</a>.</p>&#13;
<div data-type="example" id="paginated_API_route">&#13;
<h5><span class="label">Example 13-7. </span>A paginated API route</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>We’ve defined that Eloquent should get 20 results from the database. Depending on what the <code>page</code> query parameter is set to, Laravel will know exactly <em>which</em> 20 results to pull for us:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">GET</code> <code class="o">/</code><code class="nx">dogs</code>        <code class="o">-</code> <code class="k">Return</code> <code class="nx">results</code> <code class="mi">1</code><code class="o">-</code><code class="mi">20</code>&#13;
<code class="nx">GET</code> <code class="o">/</code><code class="nx">dogs</code><code class="o">?</code><code class="nx">page</code><code class="o">=</code><code class="mi">1</code> <code class="o">-</code> <code class="k">Return</code> <code class="nx">results</code> <code class="mi">1</code><code class="o">-</code><code class="mi">20</code>&#13;
<code class="nx">GET</code> <code class="o">/</code><code class="nx">dogs</code><code class="o">?</code><code class="nx">page</code><code class="o">=</code><code class="mi">2</code> <code class="o">-</code> <code class="k">Return</code> <code class="nx">results</code> <code class="mi">21</code><code class="o">-</code><code class="mi">40</code></pre>&#13;
&#13;
<p>Note that the <code>paginate()</code> method is also available on query builder calls, as seen in <a data-type="xref" href="#using_the_paginate_method_on_a_query_builder_call">Example 13-8</a>.</p>&#13;
<div data-type="example" id="using_the_paginate_method_on_a_query_builder_call">&#13;
<h5><span class="label">Example 13-8. </span>Using the <code>paginate()</code> method on a query builder call</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Here’s something interesting, though: this isn’t just going to return 20 results when you convert it to JSON. Instead, it’s going to build a response object that automatically passes some useful pagination-related details to the end user, <em>along with</em> the paginated data. <a data-type="xref" href="#sample_output_from_a_paginated_database_call">Example 13-9</a> shows a possible response from our call, truncated to only three records to save space.</p>&#13;
<div data-type="example" id="sample_output_from_a_paginated_database_call">&#13;
<h5><span class="label">Example 13-9. </span>Sample output from a paginated database call</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="p">{</code>&#13;
   <code class="s2">"current_page"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
   <code class="s2">"data"</code><code class="o">:</code> <code class="p">[</code>&#13;
        <code class="p">{</code>&#13;
           <code class="s1">'name'</code><code class="o">:</code> <code class="s1">'Fido'</code>&#13;
        <code class="p">},</code>&#13;
        <code class="p">{</code>&#13;
            <code class="s1">'name'</code><code class="o">:</code> <code class="s1">'Pickles'</code>&#13;
        <code class="p">},</code>&#13;
        <code class="p">{</code>&#13;
            <code class="s1">'name'</code><code class="o">:</code> <code class="s1">'Spot'</code>&#13;
        <code class="p">}</code>&#13;
   <code class="p">]</code>&#13;
   <code class="s2">"first_page_url"</code><code class="o">:</code> <code class="s2">"http://myapp.com/api/dogs?page=1"</code><code class="p">,</code>&#13;
   <code class="s2">"from"</code><code class="o">:</code> <code class="mi">1</code><code class="p">,</code>&#13;
   <code class="s2">"last_page"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
   <code class="s2">"last_page_url"</code><code class="o">:</code> <code class="s2">"http://myapp.com/api/dogs?page=2"</code><code class="p">,</code>&#13;
   <code class="s2">"links"</code><code class="o">:</code> <code class="p">[</code>&#13;
      <code class="p">{</code>&#13;
         <code class="s2">"url"</code><code class="o">:</code> <code class="k">null</code><code class="p">,</code>&#13;
         <code class="s2">"label"</code><code class="o">:</code> <code class="s2">"&amp;laquo; Previous"</code><code class="p">,</code>&#13;
         <code class="s2">"active"</code><code class="o">:</code> <code class="k">false</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
         <code class="s2">"url"</code><code class="o">:</code> <code class="s2">"http://myapp.com/api/dogs?page=1"</code><code class="p">,</code>&#13;
         <code class="s2">"label"</code><code class="o">:</code> <code class="s2">"1"</code><code class="p">,</code>&#13;
         <code class="s2">"active"</code><code class="o">:</code> <code class="k">true</code>&#13;
      <code class="p">},</code>&#13;
      <code class="p">{</code>&#13;
         <code class="s2">"url"</code><code class="o">:</code> <code class="k">null</code><code class="p">,</code>&#13;
         <code class="s2">"label"</code><code class="o">:</code> <code class="s2">"Next &amp;raquo;"</code><code class="p">,</code>&#13;
         <code class="s2">"active"</code><code class="o">:</code> <code class="k">false</code>&#13;
      <code class="p">}</code>&#13;
   <code class="p">],</code>&#13;
   <code class="s2">"next_page_url"</code><code class="o">:</code> <code class="s2">"http://myapp.com/api/dogs?page=2"</code><code class="p">,</code>&#13;
   <code class="s2">"path"</code><code class="o">:</code> <code class="s2">"http://myapp.com/api/dogs"</code><code class="p">,</code>&#13;
   <code class="s2">"per_page"</code><code class="o">:</code> <code class="mi">20</code><code class="p">,</code>&#13;
   <code class="s2">"prev_page_url"</code><code class="o">:</code> <code class="k">null</code><code class="p">,</code>&#13;
   <code class="s2">"to"</code><code class="o">:</code> <code class="mi">2</code><code class="p">,</code>&#13;
   <code class="s2">"total"</code><code class="o">:</code> <code class="mi">4</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sorting and Filtering" data-type="sect1"><div class="sect1" id="id488">&#13;
<h1>Sorting and Filtering</h1>&#13;
&#13;
<p>Although<a data-primary="APIs (application programming interfaces)" data-secondary="sorting and filtering results" data-type="indexterm" id="APsort13"/><a data-primary="JSON operations" data-secondary="API standard" data-type="indexterm" id="id1649"/> there is a convention and some built-in tooling for pagination in Laravel, there isn’t any for sorting, so you have to figure that out on your own. I’ll give a quick code sample here, and I’ll style the query parameters similarly to the JSON API spec (described in the following sidebar).</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1650">&#13;
<h1>The JSON API Spec</h1>&#13;
<p>The <a href="http://jsonapi.org">JSON API</a> is a standard for how to handle many of the most common tasks in building JSON-based APIs: filtering, sorting, pagination, authentication, embedding, linking, metadata, and more.</p>&#13;
&#13;
<p>Laravel’s default pagination doesn’t work <em>exactly</em> according to the JSON API spec, but it gets you started in the right direction. The majority of the rest of the JSON API spec is something you’ll just have to choose (or not) to implement manually.</p>&#13;
&#13;
<p>For example, here’s a piece of the JSON API spec that helpfully handles how to structure data versus error returns:</p>&#13;
<blockquote>&#13;
<p>A document MUST contain at least one of the following top-level members:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>data</code>: the document’s “primary data”</p>&#13;
</li>&#13;
<li>&#13;
<p><code>errors</code>: an array of error objects</p>&#13;
</li>&#13;
<li>&#13;
<p><code>meta</code>: a meta object that contains non-standard meta-information.</p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>The members <code>data</code> and <code>errors</code> MUST NOT coexist in the same document.</p></blockquote>&#13;
&#13;
<p>Be warned, however: it’s wonderful to have the JSON API as a spec, but it also takes quite a bit of groundwork to get running with it. We won’t use it entirely in these examples, but I’ll use its general ideas as inspiration.</p>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sorting Your API Results" data-type="sect2"><div class="sect2" id="id259">&#13;
<h2>Sorting Your API Results</h2>&#13;
&#13;
<p>First, let’s<a data-primary="sorting API results" data-type="indexterm" id="id1651"/> set up the ability to sort our results. We start in <a data-type="xref" href="#simplest_API_sorting">Example 13-10</a> with the ability to sort by only a single column, and in only a single direction.</p>&#13;
<div data-type="example" id="simplest_API_sorting">&#13;
<h5><span class="label">Example 13-10. </span>Simplest API sorting</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Handles /dogs?sort=name</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Get the sort query parameter (or fall back to default sort "name")</code>&#13;
    <code class="nv">$sortColumn</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'sort'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">);</code>&#13;
    <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">orderBy</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>We add the ability to invert it (e.g., <code>?sort=-weight</code>) in <a data-type="xref" href="#single_column_API_sorting_direction_control">Example 13-11</a>.</p>&#13;
<div data-type="example" id="single_column_API_sorting_direction_control">&#13;
<h5><span class="label">Example 13-11. </span>Single-column API sorting, with direction control</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Handles /dogs?sort=name and /dogs?sort=-name</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Get the sort query parameter (or fall back to default sort "name")</code>&#13;
    <code class="nv">$sortColumn</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'sort'</code><code class="p">,</code> <code class="s1">'name'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Set the sort direction based on whether the key starts with -</code>&#13;
    <code class="c1">// using Laravel's starts_with() helper function</code>&#13;
    <code class="nv">$sortDirection</code> <code class="o">=</code> <code class="nb">str_starts_with</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">)</code> <code class="o">?</code> <code class="s1">'desc'</code> <code class="o">:</code> <code class="s1">'asc'</code><code class="p">;</code>&#13;
    <code class="nv">$sortColumn</code> <code class="o">=</code> <code class="nb">ltrim</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">);</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">orderBy</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="nv">$sortDirection</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Finally, we do the same for multiple columns (e.g., <code>?sort=name,-weight</code>) in <a data-type="xref" href="#json_API_style_sorting">Example 13-12</a>.</p>&#13;
<div data-type="example" id="json_API_style_sorting">&#13;
<h5><span class="label">Example 13-12. </span>JSON API–style sorting</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Handles ?sort=name,-weight</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Grab the query parameter and turn it into an array exploded by ,</code>&#13;
    <code class="nv">$sorts</code> <code class="o">=</code> <code class="nb">explode</code><code class="p">(</code><code class="s1">','</code><code class="p">,</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'sort'</code><code class="p">,</code> <code class="s1">''</code><code class="p">));</code>&#13;
&#13;
    <code class="c1">// Create a query</code>&#13;
    <code class="nv">$query</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">query</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Add the sorts one by one</code>&#13;
    <code class="k">foreach</code> <code class="p">(</code><code class="nv">$sorts</code> <code class="k">as</code> <code class="nv">$sortColumn</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$sortDirection</code> <code class="o">=</code> <code class="nb">str_starts_with</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">)</code> <code class="o">?</code> <code class="s1">'desc'</code> <code class="o">:</code> <code class="s1">'asc'</code><code class="p">;</code>&#13;
        <code class="nv">$sortColumn</code> <code class="o">=</code> <code class="nb">ltrim</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="s1">'-'</code><code class="p">);</code>&#13;
&#13;
        <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">orderBy</code><code class="p">(</code><code class="nv">$sortColumn</code><code class="p">,</code> <code class="nv">$sortDirection</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// Return</code>&#13;
    <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>As you can see, it’s not the simplest process ever, and you’ll likely want to build some helper tooling around the repetitive processes, but we’re building up the customizability of our API piece by piece using logical and simple features.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Filtering Your API Results" data-type="sect2"><div class="sect2" id="id260">&#13;
<h2>Filtering Your API Results</h2>&#13;
&#13;
<p>Another<a data-primary="filtering API results" data-type="indexterm" id="id1652"/> common task in building APIs is filtering out all but a certain subset of data. For example, the client might ask for a list of the dogs that are Chihuahuas.</p>&#13;
&#13;
<p>The JSON API doesn’t give us any great ideas for syntax here, other than that we should use the <code>filter</code> query parameter. Let’s think along the lines of the sort syntax, where we’re putting everything into a single key—​maybe <code>?filter=breed:chihuahua</code>. You can see how to do this in <a data-type="xref" href="#single_filter_on_API_results">Example 13-13</a>.</p>&#13;
<div data-type="example" id="single_filter_on_API_results">&#13;
<h5><span class="label">Example 13-13. </span>Single filter on API results</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">query</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">filled</code><code class="p">(</code><code class="s1">'filter'</code><code class="p">),</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="p">[</code><code class="nv">$criteria</code><code class="p">,</code> <code class="nv">$value</code><code class="p">]</code> <code class="o">=</code> <code class="nb">explode</code><code class="p">(</code><code class="s1">':'</code><code class="p">,</code> <code class="nx">request</code><code class="p">(</code><code class="s1">'filter'</code><code class="p">));</code>&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="nv">$criteria</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Note that in <a data-type="xref" href="#single_filter_on_API_results">Example 13-13</a> we’re using the <code>request()</code> helper instead of injecting an instance of <code>$request</code>. Both work the same, but sometimes the <code>request()</code> helper can be easier when you’re working inside of a closure so you don’t have to pass variables in manually.</p>&#13;
&#13;
<p>And, just for kicks, in <a data-type="xref" href="#multiple_filters_on_API_results">Example 13-14</a> we allow<a data-primary="" data-startref="APsort13" data-type="indexterm" id="id1653"/> for multiple filters, like <code>?filter=breed:chihuahua,color:brown</code>.</p>&#13;
<div data-type="example" id="multiple_filters_on_API_results">&#13;
<h5><span class="label">Example 13-14. </span>Multiple filters on API results</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">query</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">filled</code><code class="p">(</code><code class="s1">'filter'</code><code class="p">),</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$filters</code> <code class="o">=</code> <code class="nb">explode</code><code class="p">(</code><code class="s1">','</code><code class="p">,</code> <code class="nx">request</code><code class="p">(</code><code class="s1">'filter'</code><code class="p">));</code>&#13;
&#13;
        <code class="k">foreach</code> <code class="p">(</code><code class="nv">$filters</code> <code class="k">as</code> <code class="nv">$filter</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="p">[</code><code class="nv">$criteria</code><code class="p">,</code> <code class="nv">$value</code><code class="p">]</code> <code class="o">=</code> <code class="nb">explode</code><code class="p">(</code><code class="s1">':'</code><code class="p">,</code> <code class="nv">$filter</code><code class="p">);</code>&#13;
            <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="nv">$criteria</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Transforming Results" data-type="sect1"><div class="sect1" id="id261">&#13;
<h1>Transforming Results</h1>&#13;
&#13;
<p>We’ve<a data-primary="transforming results" data-type="indexterm" id="id1654"/><a data-primary="APIs (application programming interfaces)" data-secondary="transforming results" data-type="indexterm" id="id1655"/> covered how to sort and filter our result sets. But right now, we’re relying on Eloquent’s JSON serialization, which means we return every field on every model.</p>&#13;
&#13;
<p>Eloquent provides a few convenience tools for defining which fields to show when you’re serializing an array. You can read more in <a data-type="xref" href="ch05.html#database_and_eloquent">Chapter 5</a>, but the gist is that if you set a <code>$hidden</code> array property on your Eloquent class, any field listed in that array will not be shown in the serialized model output. You can alternatively set a <code>$visible</code> array that defines the fields that are allowed to be shown. You could also either <span class="keep-together">overwrite</span> or mimic the <code>toArray()</code> function on your model, crafting a custom output format.</p>&#13;
&#13;
<p>Another common pattern is to create a <em>transformer</em> for each data type. Transformers are helpful because they give you more control, isolate API-specific logic away from the model itself, and allow you to provide a more consistent API even when the models and their relationships change down the road.</p>&#13;
&#13;
<p>There’s<a data-primary="Fractal" data-type="indexterm" id="id1656"/> a fantastic but complicated package for this, <a href="https://oreil.ly/pso1E">Fractal</a>, that sets up a series of convenience structures and classes for transforming your data.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="API Resources" data-type="sect1"><div class="sect1" id="api_resources">&#13;
<h1>API Resources</h1>&#13;
&#13;
<p>In<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="using Eloquent API resources" data-tertiary-sortas="Eloquent API resources" data-type="indexterm" id="id1657"/><a data-primary="Eloquent" data-secondary="API resources" data-type="indexterm" id="id1658"/> the past, one of the first challenges we’d run into when developing APIs in Laravel was how to transform our data. The simplest APIs can just return Eloquent objects as JSON, but very quickly the needs of most APIs outgrow that structure. How should we convert our Eloquent results into the right format? What if we want to embed other resources or do so but only optionally, or add a computed field or hide some fields from APIs but not other JSON output? An API-specific transformer is the &#13;
<span class="keep-together">solution</span>.</p>&#13;
&#13;
<p>We now have access to a feature called <em>Eloquent API resources</em>, which are structures that define how to transform an Eloquent object (or a collection of Eloquent objects) of a given class to API results. For example, your <code>Dog</code> Eloquent model now has a <code>Dog</code> resource whose responsibility it is to translate each instance of <code>Dog</code> to the appropriate <code>Dog</code>-shaped API response object.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Resource Class" data-type="sect2"><div class="sect2" id="id262">&#13;
<h2>Creating a Resource Class</h2>&#13;
&#13;
<p>Let’s<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="creating resource classes" data-type="indexterm" id="id1659"/><a data-primary="resource classes, creating" data-type="indexterm" id="id1660"/> walk through this <code>Dog</code> example to see what it looks like to transform our API output. First, use the Artisan command <code>make:resource</code> to create your first resource:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:resource<code class="w"> </code>Dog<code class="w"/></pre>&#13;
&#13;
<p>This will create a new class in <em>app/Http/Resources/Dog.php</em>, which contains one method: <code>toArray()</code>. You can see what the file looks like in <a data-type="xref" href="#api_resource_stub">Example 13-15</a>.</p>&#13;
<div data-type="example" id="api_resource_stub">&#13;
<h5><span class="label">Example 13-15. </span>Generated API resource</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Http\Resources</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Request</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Resources\Json\JsonResource</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Dog</code> <code class="k">extends</code> <code class="nx">JsonResource</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Transform the resource into an array.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;string, mixed&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">parent</code><code class="o">::</code><code class="na">toArray</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The <code>toArray()</code> method we’re working with here has access to two important pieces of data. First, it has access to the Illuminate <code>Request</code> object, so we can customize our response based on query parameters and headers and anything else important. And second, it has access to the entire Eloquent object being transformed by calling its properties and methods on <code>$this</code>, as you can see in <a data-type="xref" href="#simple_dog_resource">Example 13-16</a>.</p>&#13;
<div data-type="example" id="simple_dog_resource">&#13;
<h5><span class="label">Example 13-16. </span>Simple API resource for the <code>Dog</code> model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Dog</code> <code class="k">extends</code> <code class="nx">JsonResource</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
            <code class="s1">'breed'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">breed</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To use this new resource, you’ll want to update any API endpoint that returns a single <code>Dog</code> to wrap the response in your new resource, like in <a data-type="xref" href="#using_single_dog_resource">Example 13-17</a>.</p>&#13;
<div data-type="example" id="using_single_dog_resource">&#13;
<h5><span class="label">Example 13-17. </span>Using the simple <code>Dog</code> resource</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Dog</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">App\Http\Resources\Dog</code> <code class="k">as</code> <code class="nx">DogResource</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs/{dogId}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$dogId</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">DogResource</code><code class="p">(</code><code class="nx">Dog</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="nv">$dogId</code><code class="p">));</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resource Collections" data-type="sect2"><div class="sect2" id="id263">&#13;
<h2>Resource Collections</h2>&#13;
&#13;
<p>Now, let’s talk about<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="resource collections" data-type="indexterm" id="id1661"/><a data-primary="resource collections" data-type="indexterm" id="id1662"/> what happens when you have more than one of your entities returning from a given API endpoint. This is possible using an API resource’s <code>collection()</code> method, as you can see in <a data-type="xref" href="#using_default_api_resource_collection">Example 13-18</a>.</p>&#13;
<div data-type="example" id="using_default_api_resource_collection">&#13;
<h5><span class="label">Example 13-18. </span>Using the default API resource collection method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Dog</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">App\Http\Resources\Dog</code> <code class="k">as</code> <code class="nx">DogResource</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">DogResource</code><code class="o">::</code><code class="na">collection</code><code class="p">(</code><code class="nx">Dog</code><code class="o">::</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>This method iterates over every entry that’s passed to it, transforms it with the <span class="keep-together"><code>DogResource</code></span> API resource, and then returns the collection.</p>&#13;
&#13;
<p>This will likely be enough for many APIs, but if you need to customize any of the structure or add metadata to your collection responses, you’ll want to instead create a custom API resource collection.</p>&#13;
&#13;
<p>In order to do so, let’s reach for the <code>make:resource</code> Artisan command again. This time we’ll name it <code>DogCollection</code>, which signals to Laravel that this is an API resource collection, not just an API resource:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:resource<code class="w"> </code>DogCollection<code class="w"/></pre>&#13;
&#13;
<p>This will generate a new file very similar to the API resource file, living at <em>app/Http/Resources/DogCollection.php</em>, which again contains one method: <code>toArray()</code>. You can see what the file looks like in <a data-type="xref" href="#api_resource_collection_stub">Example 13-19</a>.</p>&#13;
<div data-type="example" id="api_resource_collection_stub">&#13;
<h5><span class="label">Example 13-19. </span>Generated API resource collection</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Http\Resources</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Resources\Json\ResourceCollection</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">DogCollection</code> <code class="k">extends</code> <code class="nx">ResourceCollection</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Transform the resource collection into an array.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;int|string, mixed&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">parent</code><code class="o">::</code><code class="na">toArray</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Just like with the API resource, we have access to the request and the underlying data. But unlike with the API resource, we’re dealing with a collection of items instead of just one, so we will access that (already transformed) collection as <code>$this-&gt;collection</code>. Take a look at <a data-type="xref" href="#api_resource_collection_example">Example 13-20</a> for an example.</p>&#13;
<div data-type="example" id="api_resource_collection_example">&#13;
<h5><span class="label">Example 13-20. </span>A simple API resource collection for the <code>Dog</code> model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">DogCollection</code> <code class="k">extends</code> <code class="nx">ResourceCollection</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'data'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">collection</code><code class="p">,</code>&#13;
            <code class="s1">'links'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
                <code class="s1">'self'</code> <code class="o">=&gt;</code> <code class="nx">route</code><code class="p">(</code><code class="s1">'dogs.index'</code><code class="p">),</code>&#13;
            <code class="p">],</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Nesting Relationships" data-type="sect2"><div class="sect2" id="id264">&#13;
<h2>Nesting Relationships</h2>&#13;
&#13;
<p>One<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="nesting relationships" data-type="indexterm" id="id1663"/><a data-primary="nesting relationships" data-type="indexterm" id="id1664"/><a data-primary="relationships, nesting in APIs" data-type="indexterm" id="id1665"/> of the more complicated aspects of any API is how relationships are nested. The simplest way with API resources is to add a key to your returned array that’s set to an API resource collection, like in <a data-type="xref" href="#simple_included_api_relationships">Example 13-21</a>.</p>&#13;
<div data-type="example" id="simple_included_api_relationships">&#13;
<h5><span class="label">Example 13-21. </span>A simple included API relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
        <code class="s1">'breed'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">breed</code><code class="p">,</code>&#13;
        <code class="s1">'friends'</code> <code class="o">=&gt;</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">collection</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">friends</code><code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you try the code in <a data-type="xref" href="#simple_included_api_relationships">Example 13-21</a> and receive a 502 error, it’s because you haven’t loaded the “friends” relationship on your parent resource first. Keep reading to see how to get around that, but here’s how to eager load that relationship when you’re working with this resource, using the <code>with()</code> method:</p>&#13;
&#13;
<pre class="no-indent" data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="k">new</code> <code class="nx">DogResource</code><code class="p">(</code><code class="nx">Dog</code><code class="o">::</code><code class="na">with</code><code class="p">(</code><code class="s1">'friends'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">find</code><code class="p">(</code><code class="nv">$dogId</code><code class="p">));</code></pre>&#13;
</div>&#13;
&#13;
<p>You may also want this to be a conditional property; you can choose to only nest it if it’s asked for in the request or only if it’s already been eager loaded on the Eloquent object that’s passed in. Take a look at <a data-type="xref" href="#conditional_loading_api_relationships">Example 13-22</a>.</p>&#13;
<div data-type="example" id="conditional_loading_api_relationships">&#13;
<h5><span class="label">Example 13-22. </span>Conditionally loading API relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
        <code class="s1">'breed'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">breed</code><code class="p">,</code>&#13;
        <code class="c1">// Only load this relationship if it's been eager loaded</code>&#13;
        <code class="s1">'bones'</code> <code class="o">=&gt;</code> <code class="nx">BoneResource</code><code class="o">::</code><code class="na">collection</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">whenLoaded</code><code class="p">(</code><code class="s1">'bones'</code><code class="p">)),</code>&#13;
        <code class="c1">// Or only load this relationship if the URL asks for it</code>&#13;
        <code class="s1">'bones'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code>&#13;
            <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'include'</code><code class="p">)</code> <code class="o">==</code> <code class="s1">'bones'</code><code class="p">,</code>&#13;
            <code class="nx">BoneResource</code><code class="o">::</code><code class="na">collection</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">bones</code><code class="p">)</code>&#13;
        <code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Pagination with API Resources" data-type="sect2"><div class="sect2" id="id265">&#13;
<h2>Using Pagination with API Resources</h2>&#13;
&#13;
<p>Just<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="using pagination with" data-type="indexterm" id="id1666"/><a data-primary="pagination" data-type="indexterm" id="id1667"/> like you can pass a collection of Eloquent models to a resource, you can also pass a paginator instance. Take a look at <a data-type="xref" href="#passing_paginators_to_api_resource_collections">Example 13-23</a>.</p>&#13;
<div data-type="example" id="passing_paginators_to_api_resource_collections">&#13;
<h5><span class="label">Example 13-23. </span>Passing a paginator instance to an API resource collection</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">DogCollection</code><code class="p">(</code><code class="nx">Dog</code><code class="o">::</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">));</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If you pass a paginator instance, the transformed result will have additional links containing pagination information (<code>first</code> page, <code>last</code> page, <code>prev</code> page, and <code>next</code> page) and meta-information about the entire collection.</p>&#13;
&#13;
<p>You can take a look at <a data-type="xref" href="#sample_paginated_resource_response">Example 13-24</a> to see what this information looks like. In this example, I’ve set the items-per-page count to 2 by calling <code>Dog::paginate(2)</code> so you can more easily see how the links work.</p>&#13;
<div data-type="example" id="sample_paginated_resource_response">&#13;
<h5><span class="label">Example 13-24. </span>A sample paginated resource response with pagination links</h5>&#13;
&#13;
<pre data-code-language="json" data-type="programlisting"><code class="p">{</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"data"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Pickles"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"breed"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Chorkie"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Gandalf"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">      </code><code class="nt">"breed"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Golden Retriever Mix"</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"links"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"self"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrant.com/api/dogs"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"first"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrant.com/api/dogs?page=1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"last"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrant.com/api/dogs?page=3"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"prev"</code><code class="p">:</code><code class="w"> </code><code class="kc">null</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"next"</code><code class="p">:</code><code class="w"> </code><code class="kc">null</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">  </code><code class="nt">"meta"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"current_page"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"data"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Pickles"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"breed"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Chorkie"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Gandalf"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"breed"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Golden Retriever Mix"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"first_page_url"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrent.com/api/dogs?page=1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"from"</code><code class="p">:</code><code class="w"> </code><code class="mi">1</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"last_page"</code><code class="p">:</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"last_page_url"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrent.com/api/dogs?page=3"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"links"</code><code class="p">:</code><code class="w"> </code><code class="p">[</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"url"</code><code class="p">:</code><code class="w"> </code><code class="kc">null</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"label"</code><code class="p">:</code><code class="w"> </code><code class="s2">"&amp;laquo; Previous"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"active"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"url"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrent.com/api/dogs?page=1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"label"</code><code class="p">:</code><code class="w"> </code><code class="s2">"1"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"active"</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">},</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"url"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrent.com/api/dogs?page=2"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"label"</code><code class="p">:</code><code class="w"> </code><code class="s2">"Next &amp;raquo;"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">            </code><code class="nt">"active"</code><code class="p">:</code><code class="w"> </code><code class="kc">false</code><code class="w"/>&#13;
<code class="w">        </code><code class="p">}</code><code class="w"/>&#13;
<code class="w">    </code><code class="p">],</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"next_page_url"</code><code class="p">:</code><code class="w"> </code><code class="kc">null</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"path"</code><code class="p">:</code><code class="w"> </code><code class="s2">"http://gooddogbrent.com/api/dogs"</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"per_page"</code><code class="p">:</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"to"</code><code class="p">:</code><code class="w"> </code><code class="mi">3</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nt">"total"</code><code class="p">:</code><code class="w"> </code><code class="mi">9</code><code class="w"/>&#13;
<code class="w">  </code><code class="p">}</code><code class="w"/>&#13;
<code class="p">}</code><code class="w"/></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conditionally Applying Attributes" data-type="sect2"><div class="sect2" id="id490">&#13;
<h2>Conditionally Applying Attributes</h2>&#13;
&#13;
<p>You<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="applying conditionally" data-type="indexterm" id="id1668"/><a data-primary="attributes" data-secondary="applying conditionally in APIs" data-type="indexterm" id="id1669"/> can also specify that certain attributes in your response should only be applied when a particular test is satisfied, as illustrated in <a data-type="xref" href="#EX13a">Example 13-25</a>.</p>&#13;
<div data-type="example" id="EX13a">&#13;
<h5><span class="label">Example 13-25. </span>Conditionally applying attributes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
        <code class="s1">'breed'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">breed</code><code class="p">,</code>&#13;
        <code class="s1">'rating'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="nx">Auth</code><code class="o">::</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">canSeeRatings</code><code class="p">(),</code> <code class="mi">12</code><code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="More Customizations for API Resources" data-type="sect2"><div class="sect2" id="id583">&#13;
<h2>More Customizations for API Resources</h2>&#13;
&#13;
<p>The<a data-primary="APIs (application programming interfaces)" data-secondary="API resources" data-tertiary="customizing" data-type="indexterm" id="id1670"/> default shape of how the <code>data</code> property is wrapped might not be how you like it, or you may find yourself needing to add or customize metadata for the responses. Take a look at the <a href="https://oreil.ly/LJ3Ie">resources docs</a> for details on how to customize every aspect of your API responses.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="API Authentication" data-type="sect1"><div class="sect1" id="id698">&#13;
<h1>API Authentication</h1>&#13;
&#13;
<p>Laravel provides two primary tools for authenticating API requests: Sanctum (most recommended) and Passport (powerful but very complex and usually overkill).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="API Authentication with Sanctum" data-type="sect2"><div class="sect2" id="sanctum">&#13;
<h2>API Authentication with Sanctum</h2>&#13;
&#13;
<p>Sanctum<a data-primary="APIs (application programming interfaces)" data-secondary="authenticating requests" data-tertiary="using Sanctum" data-type="indexterm" id="APIauthsanctum13"/><a data-primary="Sanctum" data-secondary="API authentication with" data-type="indexterm" id="id1671"/> is an API authentication system for Laravel, built for two tasks: generating simple tokens for your power users to use to interact with your API, and allowing SPAs and mobile apps to latch onto your existing authentication system. It’s not quite as configurable as OAuth 2.0, but it’s <em>very close</em> and it comes with much lower cost in terms of setup and configuration.</p>&#13;
&#13;
<p>There are several ways to use Sanctum. You can allow power users to generate tokens for your API directly in your admin panel, similar to how many developer-focused SaaS services do. You can allow users to visit a special login page to receive a token directly, which is useful for authenticating mobile apps to your API. And you can integrate with your SPA, which, using some of Sanctum’s special sauce, can hook directly into Laravel’s cookie-based authentication sessions, and you won’t have to manage tokens at all.</p>&#13;
&#13;
<p>Let’s look at how to install Sanctum and then how to use it in each of these contexts.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Sanctum" data-type="sect3"><div class="sect3" id="id266">&#13;
<h3>Installing Sanctum</h3>&#13;
&#13;
<p>Sanctum<a data-primary="Sanctum" data-secondary="installing" data-type="indexterm" id="id1672"/><a data-primary="--provider flag" data-type="indexterm" id="id1673"/> comes preinstalled with new Laravel projects. If your project doesn’t have it, you’ll need to manually install it and publish its config files.</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>laravel/sanctum<code class="w"/>&#13;
php<code class="w"> </code>artisan<code class="w"> </code>vendor:publish<code class="w"> </code>--provider<code class="o">=</code><code class="s2">"Laravel\Sanctum\SanctumServiceProvider"</code><code class="w"/>&#13;
php<code class="w"> </code>artisan<code class="w"> </code>migrate<code class="w"/></pre>&#13;
&#13;
<p>For any routes you want to protect with Sanctum, attach the <code>auth:sanctum</code> &#13;
<span class="keep-together">middleware</span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'clips'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'clips.index'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'clips'</code> <code class="o">=&gt;</code> <code class="nx">Clip</code><code class="o">::</code><code class="na">all</code><code class="p">()]);</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth:sanctum'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Issuing Sanctum tokens manually" data-type="sect3"><div class="sect3" id="id492">&#13;
<h3>Issuing Sanctum tokens manually</h3>&#13;
&#13;
<p>If<a data-primary="Sanctum" data-secondary="issuing tokens manually" data-type="indexterm" id="id1674"/> you want to build tooling in your application to provide tokens for your users to authenticate against your API, here are the steps you’ll want to take.</p>&#13;
&#13;
<p>First, make sure your <code>User</code> model uses the <code>HasApiTokens</code> trait (on a new project, it’ll already have it):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Laravel\Sanctum\HasApiTokens</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Authenticatable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">HasApiTokens</code><code class="p">,</code> <code class="nx">HasFactory</code><code class="p">,</code> <code class="nx">Notifiable</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Next, build a user interface that allows the user to generate a token. You could make a button in their settings page that says “Generate new token,” pops up a modal asking for the nickame for that token, and then posts the results to this form:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'tokens/create'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$token</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">createToken</code><code class="p">(</code><code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">token_name</code><code class="p">);</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'tokens.created'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'token'</code> <code class="o">=&gt;</code> <code class="nv">$token</code><code class="o">-&gt;</code><code class="na">plainTextToken</code><code class="p">]);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>You can also list out all of the tokens your user has by referencing the <code>tokens</code> property of a <code>user</code> object:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tokens'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'tokens.index'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'tokens'</code> <code class="o">=&gt;</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">tokens</code><code class="p">]);</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sanctum token abilities" data-type="sect3"><div class="sect3" id="id493">&#13;
<h3>Sanctum token abilities</h3>&#13;
&#13;
<p>A<a data-primary="Sanctum" data-secondary="token abilities" data-type="indexterm" id="id1675"/> common security pattern for token-based API authentication is to allow users to generate tokens with only certain privileges, to minimize the potential damage if the token were compromised.</p>&#13;
&#13;
<p>If you want to build a system for that, you can define (based on business logic or user preferences) which “abilities” each token has when you create it. Pass an array of strings to the <code>createToken()</code> method and each string will represent an ability that token has.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$token</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">createToken</code><code class="p">(</code>&#13;
    <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">token_name</code><code class="p">,</code> <code class="p">[</code><code class="s1">'list-clips'</code><code class="p">,</code> <code class="s1">'add-delete-clips'</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>Then, your code can check against the authenticated user’s tokens either directly (as in <a data-type="xref" href="#sanctum_manually_checking_tokens">Example 13-26</a>) or through middleware (as in <a data-type="xref" href="#sanctum_using_middleware_to_restrict">Example 13-27</a>).</p>&#13;
<div data-type="example" id="sanctum_manually_checking_tokens">&#13;
<h5><span class="label">Example 13-26. </span>Manually checking a user’s access based on token abilities</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">tokenCan</code><code class="p">(</code><code class="s1">'list-clips'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="example" id="sanctum_using_middleware_to_restrict">&#13;
<h5><span class="label">Example 13-27. </span>Using middleware to restrict access based on token scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/api.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'clips'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Access token has both the "list-clips" and "add-delete-clips" abilities</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">([</code><code class="s1">'auth:sanctum'</code><code class="p">,</code><code class="s1">'abilities:list-clips,add-delete-clips'</code><code class="p">]);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'clips'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Access token has at least one of the listed abilities</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">([</code><code class="s1">'auth:sanctum'</code><code class="p">,</code><code class="s1">'ability:list-clips,add-delete-clips'</code><code class="p">])</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h6>Note</h6>&#13;
<p>If<a data-primary="middleware" data-secondary="Sanctum's middleware checks" data-type="indexterm" id="id1676"/> you want to use Sanctum’s middleware checks, you’ll need to add the following two lines to the <code>middlewareAliases</code> property of <code>App\Http\Kernel</code>.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'abilities'</code> <code class="o">=&gt;</code> <code class="nx">\Laravel\Sanctum\Http\Middleware\</code>&#13;
    <code class="nx">CheckAbilities</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="s1">'ability'</code> <code class="o">=&gt;</code> <code class="nx">\Laravel\Sanctum\Http\Middleware\</code>&#13;
    <code class="nx">CheckForAnyAbility</code><code class="o">::</code><code class="na">class</code><code class="p">,</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SPA authentication" data-type="sect3"><div class="sect3" id="id267">&#13;
<h3>SPA authentication</h3>&#13;
&#13;
<p>If<a data-primary="Sanctum" data-secondary="SPA authentication" data-type="indexterm" id="id1677"/><a data-primary="single-page application (SPA)" data-type="indexterm" id="id1678"/> you plan to use Sanctum to authenticate with an SPA, there are a few steps you’ll need to take first to set up your Laravel app and your SPA.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Laravel app preparation" data-type="sect4"><div class="sect4" id="id699">&#13;
<h4>Laravel app preparation</h4>&#13;
&#13;
<p>First, uncomment the <code>EnsureFrontendRequestsAreStateful</code> class on the <code>api</code> middleware group in <em>app/Http/Kernel.php</em>.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'api'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="nx">\Laravel\Sanctum\Http\Middleware\EnsureFrontendRequestsAreStateful</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="c1">// Other API middleware here</code>&#13;
<code class="p">],</code></pre>&#13;
&#13;
<p>Second, update the list of “stateful” domains in the Sanctum config. These are all the domains your SPA can make requests from. You can modify them directly in <em>config/sanctum.php</em>, or add a comma-separated list of domains to the <code>SANCTUM_STATEFUL_DOMAINS</code> key in your <em>.env</em> file.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SPA app preparation" data-type="sect4"><div class="sect4" id="id700">&#13;
<h4>SPA app preparation</h4>&#13;
&#13;
<p>Before allowing your users to log into your app, your SPA should request Laravel set a CSRF cookie, which most JavaScript HTTP clients like Axios will then pass with every future request.</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">axios</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/sanctum/csrf-cookie'</code><code class="p">).</code><code class="nx">then</code><code class="p">(</code><code class="nx">response</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
    <code class="c1">// Handle login</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>You can then log in to your Laravel login route, either one you’ve created yourself or a route offered by an existing tool like Fortify. Future requests will remain authenticated via the session cookie Laravel sets for you.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mobile app authentication" data-type="sect3"><div class="sect3" id="id268">&#13;
<h3>Mobile app authentication</h3>&#13;
&#13;
<p>Here’s<a data-primary="Sanctum" data-secondary="mobile app authentication" data-type="indexterm" id="id1679"/><a data-primary="mobile app authentication" data-type="indexterm" id="id1680"/> the workflow for allowing your mobile app users to authenticate to a Sanctum-based app: request the user’s email (or username) and their password in your mobile app. Send that, together with the name of their device (reading from the device’s name in its OS; e.g., “Matt’s iPhone”), to a route you create yourself on the backend, which will validate their login and (assuming it’s valid) create and return a token, as you can see in <a data-type="xref" href="#EX13f">Example 13-28</a>, which I’ve taken directly from the docs.</p>&#13;
<div data-type="example" id="EX13f">&#13;
<h5><span class="label">Example 13-28. </span>Route to accept mobile app logins to Sanctum-based apps</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'sanctum/token'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">validate</code><code class="p">([</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'required|email'</code><code class="p">,</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="s1">'required'</code><code class="p">,</code>&#13;
        <code class="s1">'device_name'</code> <code class="o">=&gt;</code> <code class="s1">'required'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'email'</code><code class="p">,</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nv">$user</code> <code class="o">||</code> <code class="o">!</code> <code class="nx">Hash</code><code class="o">::</code><code class="na">check</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">password</code><code class="p">,</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">password</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="k">throw</code> <code class="nx">ValidationException</code><code class="o">::</code><code class="na">withMessages</code><code class="p">([</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'The provided credentials are incorrect.'</code><code class="p">],</code>&#13;
        <code class="p">]);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">createToken</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">device_name</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">plainTextToken</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Future requests to the API should pass the token in the <code>Authorization</code> header as a <code>Bearer</code> type token.<a data-primary="" data-startref="APIauthsanctum13" data-type="indexterm" id="id1681"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Further configuration and debugging" data-type="sect3"><div class="sect3" id="id494">&#13;
<h3>Further configuration and debugging</h3>&#13;
&#13;
<p>If<a data-primary="Sanctum" data-secondary="documentation" data-type="indexterm" id="id1682"/> you’re having any trouble with your Sanctum install or want to customize any of Sanctum’s functionality, check out the <a href="https://oreil.ly/lIpkq">Sanctum docs</a> to learn more.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="API Authentication with Laravel Passport" data-type="sect2"><div class="sect2" id="passport">&#13;
<h2>API Authentication with Laravel Passport</h2>&#13;
&#13;
<p>Passport<a data-primary="APIs (application programming interfaces)" data-secondary="authenticating requests" data-tertiary="using Passport" data-type="indexterm" id="APIauthpassport13"/><a data-primary="Passport" data-secondary="API authentication with" data-type="indexterm" id="id1683"/> (a first-party package that has to be installed, brought in via Composer) makes it easy to set up a full-featured OAuth 2.0 server in your application, complete with an API and UI components for managing clients and tokens.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A brief introduction to OAuth 2.0" data-type="sect3"><div class="sect3" id="id269">&#13;
<h3>A brief introduction to OAuth 2.0</h3>&#13;
&#13;
<p>OAuth<a data-primary="Passport" data-secondary="OAuth 2.0 overview" data-type="indexterm" id="id1684"/><a data-primary="OAuth (Open Authentication)" data-type="indexterm" id="id1685"/> is by far the most common auth system used in RESTful APIs. Unfortunately, it’s far too complex a topic for us to cover here in depth. For further reading, Matt Frost has written a great book on OAuth and PHP titled <em>Integrating Web Services with OAuth and PHP</em> (php[architect]).</p>&#13;
&#13;
<p>Here’s the simplest concept behind OAuth: because APIs are stateless, we can’t rely on the same session-based authentication that we do in normal browser-based viewing sessions, where the user logs in and their authenticated state is saved to the session for subsequent views. Instead, the API client needs to make a single call to an authentication endpoint and perform some form of handshake to prove itself. It then gets back a token that it must send along with every future request (via the <code>Authorization</code> header, usually) to prove its identity.</p>&#13;
&#13;
<p>There are a few different types of OAuth<a data-primary="grants (OAuth)" data-type="indexterm" id="id1686"/> “grant,” which basically means that there are several different scenarios and types of interaction that can define that authentication handshake. Different projects and different sorts of end consumers will necessitate different grants.</p>&#13;
&#13;
<p>Passport gives you everything needed to add a basic OAuth 2.0 authentication server to your Laravel application, with a simpler and powerful API and interface.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Passport" data-type="sect3"><div class="sect3" id="id496">&#13;
<h3>Installing Passport</h3>&#13;
&#13;
<p>Passport<a data-primary="Passport" data-secondary="installing" data-type="indexterm" id="id1687"/> is a separate package, so your first step is to install it. I’ll sum up the steps here, but you can get more in-depth installation instructions in the <a href="https://oreil.ly/N9-eD">Passport docs</a>.</p>&#13;
&#13;
<p>First, bring it in with Composer:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>laravel/passport<code class="w"/></pre>&#13;
&#13;
<p>Passport imports a series of migrations, so run those with <code>php artisan migrate</code> to create the tables necessary for OAuth clients, scopes, and tokens.</p>&#13;
&#13;
<p>Next, run the installer with <code>php artisan passport:install</code>. This will create encryption keys for the OAuth server (<em>storage/oauth-private.key</em> and <em>storage/oauth-public.key</em>) and insert OAuth clients into the database for our personal and password grant type tokens (which we’ll cover later).</p>&#13;
&#13;
<p>You’ll need to import the <code>Laravel\Passport\HasApiTokens</code> trait into your <code>User</code> model; this will add OAuth client- and token-related relationships to each <code>User</code>, as well as a few token-related helper methods.</p>&#13;
&#13;
<p>Finally, add a new auth guard in <em>config/auth.php</em> named <code>api</code>; set the provider to <code>users</code>, and the driver to <code>passport</code>.</p>&#13;
&#13;
<p>You now have a fully functional OAuth 2.0 server! You can create new clients with <code>php artisan passport:client</code>, and you have an API for managing your clients and tokens available under the <code>/oauth</code> route prefix.</p>&#13;
&#13;
<p>To protect a route behind your Passport auth system, add the <code>auth:api</code> middleware to the route or route group, as shown in <a data-type="xref" href="#protecting_an_API_route">Example 13-29</a>.</p>&#13;
<div data-type="example" id="protecting_an_API_route">&#13;
<h5><span class="label">Example 13-29. </span>Protecting an API route with the Passport auth middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/api.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'/user'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth:api'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>In order to authenticate to these protected routes, your client apps will need to pass a token (we’ll cover how to get one shortly) as a <code>Bearer</code> token in the <code>Authorization</code> header. <a data-type="xref" href="#sample_API_request_with_a_Bearer_token">Example 13-30</a> shows what this would look like if you were making a request using the HTTP client included by Laravel.</p>&#13;
<div data-type="example" id="sample_API_request_with_a_Bearer_token">&#13;
<h5><span class="label">Example 13-30. </span>Making a sample API request with a <code>Bearer</code> token</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Http</code><code class="p">;</code>&#13;
&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">withHeaders</code><code class="p">([</code><code class="s1">'Accept'</code> <code class="o">=&gt;</code> <code class="s1">'application/json'</code><code class="p">])</code>&#13;
    <code class="o">-&gt;</code><code class="na">withToken</code><code class="p">(</code><code class="nv">$accessToken</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'http://tweeter.test/api/user'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Now, let’s take a closer look at how it all works.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Passport’s API" data-type="sect3"><div class="sect3" id="id497">&#13;
<h3>Passport’s API</h3>&#13;
&#13;
<p>Passport<a data-primary="Passport" data-secondary="API functions" data-type="indexterm" id="id1688"/> exposes an API in your application under the <code>/oauth</code> route prefix. The API provides two primary functions: first, to authorize users with OAuth 2.0 authorization flows (<code>/oauth/authorize</code> and <code>/oauth/token</code>), and second, to allow users to manage their clients and tokens (the rest of the routes).</p>&#13;
&#13;
<p>This is an important distinction, especially if you’re unfamiliar with OAuth. Every OAuth server needs to expose the ability for consumers to authenticate with your server; that’s the entire point of the service. But Passport <em>also</em> exposes an API for managing the state of your OAuth server’s clients and tokens. This means you can easily build a frontend to let your users manage their information in your OAuth application. Passport actually comes with Vue-based manager components that you can either use directly or use for inspiration.</p>&#13;
&#13;
<p>We’ll cover the API routes that allow you to manage clients and tokens, and the Vue components that Passport ships with to make that easy, but first let’s dig into the various ways your users can authenticate with your Passport-protected API.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Passport’s available grant types" data-type="sect3"><div class="sect3" id="id270">&#13;
<h3>Passport’s available grant types</h3>&#13;
&#13;
<p>Passport<a data-primary="Passport" data-secondary="available grant types" data-tertiary="password grants" data-type="indexterm" id="id1689"/><a data-primary="grants (OAuth)" data-type="indexterm" id="grants13"/> makes it possible for you to authenticate users in four different ways. Two are traditional OAuth 2.0 grants (the password grant and authorization code grant) and two are convenience methods that are unique to Passport (the personal token and synchronizer token).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Password grant" data-type="sect4"><div class="sect4" id="id271">&#13;
<h4>Password grant</h4>&#13;
&#13;
<p>The<a data-primary="password grants" data-type="indexterm" id="id1690"/> <em>password grant</em>, while less common than the authorization code grant, is much simpler. If you want users to be able to authenticate directly with your API using their username and password—​for example, if you have a mobile app for your company consuming your own API—​you can use the password grant.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1691">&#13;
<h1>Creating a Password Grant Client</h1>&#13;
<p>To use the password grant flow, you need a password grant client in your database. This is because every request to an OAuth server needs to be made by a client. Usually, the client identifies which app or site the user is authenticating against—​for example, if you used Facebook to log in to a third-party website, that website would be the client.</p>&#13;
&#13;
<p>With the password grant flow, however, there is no client coming along with the request, so you have to create one—and that’s the password grant client. One will have been added when you ran <code>php artisan passport:install</code>, but if you ever need to generate a new<a data-primary="--password flag" data-type="indexterm" id="id1692"/> password grant client for any reason, you can do so as follows:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<strong><code>php</code><code class="w"> </code><code>artisan</code><code class="w"> </code><code>passport:client</code><code class="w"> </code><code>--password</code></strong><code class="w">&#13;
&#13;
 </code><code>What</code><code class="w"> </code><code>should</code><code class="w"> </code><code>we</code><code class="w"> </code><code>name</code><code class="w"> </code><code>the</code><code class="w"> </code><code>password</code><code class="w"> </code><code>grant</code><code class="w"> </code><code>client?</code><code class="w">&#13;
   </code><code class="o">[</code><code>My</code><code class="w"> </code><code>Application</code><code class="w"> </code><code>Password</code><code class="w"> </code><code>Grant</code><code class="w"> </code><code>Client</code><code class="o">]</code><code>:</code><code class="w">&#13;
 </code><code>&gt;</code><code class="w"> </code><em><code>Client_name</code></em><code class="w">&#13;
&#13;
</code><code>Which</code><code class="w"> </code><code>user</code><code class="w"> </code><code>provider</code><code class="w"> </code><code>should</code><code class="w"> </code><code>this</code><code class="w"> </code><code>client</code><code class="w"> </code><code>use</code><code class="w"> </code><code>to</code><code class="w"> </code><code>retrieve</code><code class="w"> </code><code>users?</code><code class="w"> </code><code class="o">[</code><code>users</code><code class="o">]</code><code>:</code><code class="w">&#13;
   </code><code class="o">[</code><code class="m">0</code><code class="o">]</code><code class="w"> </code><code>users:</code><code class="w">&#13;
 </code><code>&gt;</code><code class="w"> </code><em><code class="m">0</code></em><code class="w">&#13;
&#13;
</code><code>Password</code><code class="w"> </code><code>grant</code><code class="w"> </code><code>client</code><code class="w"> </code><code>created</code><code class="w"> </code><code>successfully.</code><code class="w">&#13;
</code><code>Client</code><code class="w"> </code><code>ID:</code><code class="w"> </code><code class="m">3</code><code class="w">&#13;
</code><code>Client</code><code class="w"> </code><code>Secret:</code><code class="w"> </code><code>Pg1EEzt18JAnFoUIM9n38Nqewg1aekB4rvFk2Pma</code><code class="w">&#13;
</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>With the password grant type, there is just one step to getting a token: sending the user’s credentials to the <code>/oauth/token</code> route, like in <a data-type="xref" href="#password_grant_type">Example 13-31</a>.</p>&#13;
<div data-type="example" id="password_grant_type">&#13;
<h5><span class="label">Example 13-31. </span>Making a request with the password grant type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php in the *consuming application*</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tweeter/password-grant-auth'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Make call to "Tweeter," our Passport-powered OAuth server</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'http://tweeter.test/oauth/token'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'grant_type'</code> <code class="o">=&gt;</code> <code class="s1">'password'</code><code class="p">,</code>&#13;
        <code class="s1">'client_id'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.id'</code><code class="p">),</code>&#13;
        <code class="s1">'client_secret'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.secret'</code><code class="p">),</code>&#13;
        <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="s1">'matt@mattstauffer.co'</code><code class="p">,</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="s1">'my-tweeter-password'</code><code class="p">,</code>&#13;
        <code class="s1">'scope'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$thisUsersTokens</code> <code class="o">=</code> <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">();</code>&#13;
    <code class="c1">// Do stuff with the tokens</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>This route will return an <code>access_token</code>, a <code>refresh_token</code>, and two pieces of metadata: <code>token_type</code> and <code>expires_in</code> (discussed later in this chapter). You can now save those tokens to use to authenticate with the API (access token) and to request more tokens later (refresh token).</p>&#13;
&#13;
<p>Note that the ID and secret we would use for the password grant type would be those in <span class="keep-together">the <code>oauth_clients</code></span> database table of our Passport app in the row whose name matches that of our Passport grant client. You’ll also see entries in this table for the two clients that are generated by default when you run <code>passport:install</code>: “Laravel Personal Access Client” and “Laravel Password Grant Client.”</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization code grant" data-type="sect4"><div class="sect4" id="id272">&#13;
<h4>Authorization code grant</h4>&#13;
&#13;
<p>The<a data-primary="authorization code grants" data-type="indexterm" id="authcode13"/><a data-primary="Passport" data-secondary="available grant types" data-tertiary="authorization code grants" data-type="indexterm" id="id1693"/> most common OAuth 2.0 auth workflow is also the most complex one Passport supports. Let’s imagine we’re developing an application that’s like Twitter but for sound clips; we’ll call it Tweeter. And we’ll imagine another website, a social network for science fiction fans, called SpaceBook. SpaceBook’s developer wants to let people embed their Tweeter data into their SpaceBook newsfeeds. We’re going to install Passport in our Tweeter app so that other apps—SpaceBook, for example—can allow their users to authenticate with their Tweeter information.</p>&#13;
&#13;
<p>In the <em>authorization code grant</em> type, each consuming website—SpaceBook, in this example—needs to create a client in our Passport-enabled app. In most scenarios, the other sites’ admins will have user accounts at Tweeter, and we’ll build tools for them to create clients there. But for starters, we can just manually create a client for the SpaceBook admins:</p>&#13;
<pre data-type="programlisting"><strong>php artisan passport:client</strong>&#13;
Which user ID should the client be assigned to?:&#13;
 &gt; <strong>1</strong>&#13;
&#13;
 What should we name the client?:&#13;
 &gt; <strong>SpaceBook</strong>&#13;
 Where should we redirect the request after authorization?&#13;
   [http://tweeter.test/auth/callback]:&#13;
 &gt; <strong>http://spacebook.test/tweeter/callback</strong>&#13;
&#13;
 New client created successfully.&#13;
 Client ID: 4&#13;
 Client secret: 5rzqKpeCjIgz3MXpi3tjQ37HBnLLykrgWgmc18uH</pre>&#13;
&#13;
<p>To answer the first question, you’ll need to know that every client needs to be assigned to a user in your app. Imagine user #1 is writing SpaceBook; they’ll be the “owner” of this client we’re creating.</p>&#13;
&#13;
<p>Once we’ve run this command, we have the ID and secret for the SpaceBook client. At this point, SpaceBook can use this ID and secret to build tooling that allows an individual SpaceBook user (who is also a Tweeter user) to get an auth token from Tweeter for use when SpaceBook wants to make API calls to Tweeter on that user’s behalf. <a data-type="xref" href="#redirecting_to_OAuth">Example 13-32</a> illustrates this. (This and the following examples assume SpaceBook is a Laravel app, too; they also assume the Spacebook’s developer created a file at <em>config/tweeter.php</em> that returns the ID and secret we <span class="keep-together">just created.)</span></p>&#13;
<div data-type="example" id="redirecting_to_OAuth">&#13;
<h5><span class="label">Example 13-32. </span>A consumer app redirecting a user to our OAuth server</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In SpaceBook's routes/web.php:</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tweeter/redirect'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">http_build_query</code><code class="p">([</code>&#13;
        <code class="s1">'client_id'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.id'</code><code class="p">),</code>&#13;
        <code class="s1">'redirect_uri'</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="p">(</code><code class="s1">'tweeter/callback'</code><code class="p">),</code>&#13;
        <code class="s1">'response_type'</code> <code class="o">=&gt;</code> <code class="s1">'code'</code><code class="p">,</code>&#13;
        <code class="s1">'scope'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="c1">// Builds a string like:</code>&#13;
    <code class="c1">// client_id={$client_id}&amp;redirect_uri={$redirect_uri}&amp;response_type=code</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'http://tweeter.test/oauth/authorize?'</code> <code class="o">.</code> <code class="nv">$query</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>When users hit that route in SpaceBook, they’ll now be redirected to the <code>/oauth/authorize</code> Passport route in our Tweeter app. At this point they’ll see a confirmation page—you can use the<a data-primary="--tag flag" data-type="indexterm" id="id1694"/> default Passport confirmation page by running this command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>vendor:publish<code class="w"> </code>--tag<code class="o">=</code>passport-views<code class="w"/></pre>&#13;
&#13;
<p>This will publish the view to <em>resources/views/vendor/passport/authorize.blade.php</em>, and your users will see the page shown in <a data-type="xref" href="#authorization_code_approval_page">Figure 13-1</a>.</p>&#13;
&#13;
<figure><div class="figure" id="authorization_code_approval_page">&#13;
<img alt="A screenshot of the OAuth authorization code approval page" src="assets/lur3_1301.png"/>&#13;
<h6><span class="label">Figure 13-1. </span>OAuth authorization code approval page</h6>&#13;
</div></figure>&#13;
&#13;
<p>Once a user chooses to accept or reject the authorization, Passport will redirect that user back to the provided <code>redirect_uri</code>. In <a data-type="xref" href="#redirecting_to_OAuth">Example 13-32</a> we set a <code>redirect_uri</code> of <code>url('tweeter/callback')</code>, so the user will be redirected back to <em>http://spacebook.test/tweeter/callback</em>.</p>&#13;
&#13;
<p>An approval request will contain a code that our consumer app’s callback route can now use to get a token back from our Passport-enabled app, Tweeter. A rejection request will contain an error. SpaceBook’s callback route might look something like <a data-type="xref" href="#authorization_callback_route">Example 13-33</a>.</p>&#13;
<div data-type="example" id="authorization_callback_route">&#13;
<h5><span class="label">Example 13-33. </span>The authorization callback route in the sample consuming app</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In SpaceBook's routes/web.php:</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tweeter/callback'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'error'</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="c1">// Handle error condition</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'http://tweeter.test/oauth/token'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'grant_type'</code> <code class="o">=&gt;</code> <code class="s1">'authorization_code'</code><code class="p">,</code>&#13;
        <code class="s1">'client_id'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.id'</code><code class="p">),</code>&#13;
        <code class="s1">'client_secret'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.secret'</code><code class="p">),</code>&#13;
        <code class="s1">'redirect_uri'</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="p">(</code><code class="s1">'tweeter/callback'</code><code class="p">),</code>&#13;
        <code class="s1">'code'</code> <code class="o">=&gt;</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">code</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$thisUsersTokens</code> <code class="o">=</code> <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">();</code>&#13;
    <code class="c1">// Do stuff with the tokens</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>What the SpaceBook developer has done here is build an HTTP request, using the Laravel HTTP client, to the <span class="keep-together"><code>/oauth</code></span><code>/token</code> Passport route on Tweeter. They then send a <code>POST</code> request containing the authorization code they received when the user approved access, and Tweeter will return a JSON response containing a<a data-primary="access tokens" data-secondary="in Laravel Passport" data-secondary-sortas="Laravel Passport" data-type="indexterm" id="id1695"/> few keys:</p>&#13;
<dl>&#13;
<dt id="passport_response"><code>access_token</code></dt>&#13;
<dd>&#13;
<p>The token SpaceBook will want to save for this user. This token is what the user will use to authenticate in future requests to Tweeter (using the <code>Authorization</code> header).</p>&#13;
</dd>&#13;
<dt><code>refresh_token</code></dt>&#13;
<dd>&#13;
<p>A token SpaceBook will need <em>if</em> you decide to set your tokens to expire. By default, Passport’s access tokens last for one year.</p>&#13;
</dd>&#13;
<dt><code>expires_in</code></dt>&#13;
<dd>&#13;
<p>The number of seconds until an <code>access_token</code> expires (needs to <span class="keep-together">be refreshed).</span></p>&#13;
</dd>&#13;
<dt><code>token_type</code></dt>&#13;
<dd>&#13;
<p>The type of token you’re getting back, which will be <code>Bearer</code>; this means you pass a header with all future requests with the name of <code>Authorization</code> and the value of <code>Bearer <em>YOURTOKENHERE</em></code>.</p>&#13;
</dd>&#13;
</dl>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1696">&#13;
<h1>Using Refresh Tokens</h1>&#13;
<p>If<a data-primary="refresh tokens" data-type="indexterm" id="id1697"/> you’d like to force users to reauthenticate more often, you need to set a shorter refresh time on the tokens, and then you can use <code>refresh_token</code> to request a new <code>access_token</code> when needed—​most likely whenever you receive a 401 (Unauthorized) response from an API call.</p>&#13;
&#13;
<p><a data-type="xref" href="#EX13b">Example 13-34</a> illustrates how to set a shorter refresh time.</p>&#13;
<div data-type="example" id="EX13b">&#13;
<h5><span class="label">Example 13-34. </span>Defining token refresh times</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// AuthServiceProvider's boot() method</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Passport</code><code class="o">::</code><code class="na">routes</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// How long a token lasts before needing refreshing</code>&#13;
    <code class="nx">Passport</code><code class="o">::</code><code class="na">tokensExpireIn</code><code class="p">(</code>&#13;
        <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addDays</code><code class="p">(</code><code class="mi">15</code><code class="p">)</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// How long a refresh token will last before re-auth</code>&#13;
    <code class="nx">Passport</code><code class="o">::</code><code class="na">refreshTokensExpireIn</code><code class="p">(</code>&#13;
        <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addDays</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To request a new token using a refresh token, the consuming application will need to have first saved <code>refresh_token</code> from the initial auth response in <a data-type="xref" href="#authorization_callback_route">Example 13-33</a>. Once it’s time to refresh, it will make a call similar to that example, but modified slightly as shown in <a data-type="xref" href="#EX13c">Example 13-35</a>.</p>&#13;
<div data-type="example" id="EX13c">&#13;
<h5><span class="label">Example 13-35. </span>Requesting a new token using a refresh token</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In SpaceBook's routes/web.php:</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Http</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tweeter/request-refresh'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'http://tweeter.test/oauth/token'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'grant_type'</code> <code class="o">=&gt;</code> <code class="s1">'refresh_token'</code><code class="p">,</code>&#13;
        <code class="s1">'client_id'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.id'</code><code class="p">),</code>&#13;
        <code class="s1">'client_secret'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.secret'</code><code class="p">),</code>&#13;
        <code class="s1">'redirect_uri'</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="p">(</code><code class="s1">'tweeter/callback'</code><code class="p">),</code>&#13;
        <code class="s1">'refresh_token'</code> <code class="o">=&gt;</code> <code class="nv">$theTokenYouSavedEarlier</code><code class="p">,</code>&#13;
        <code class="s1">'scope'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$thisUsersTokens</code> <code class="o">=</code> <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">();</code>&#13;
&#13;
     <code class="c1">// Do stuff with the tokens</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>In the response, the consuming app will receive a fresh set of tokens to save to its <code>user</code>.</p>&#13;
</div></aside>&#13;
&#13;
<p>You now have all the tools you need to perform basic authorization code flows. We’ll cover how to build an admin panel for your clients and tokens later, but first, let’s take a quick look at the other grant types.<a data-primary="" data-startref="grants13" data-type="indexterm" id="id1698"/><a data-primary="" data-startref="authcode13" data-type="indexterm" id="id1699"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Personal access tokens" data-type="sect4"><div class="sect4" id="id273">&#13;
<h4>Personal access tokens</h4>&#13;
&#13;
<p>The<a data-primary="personal access tokens" data-type="indexterm" id="id1700"/><a data-primary="access tokens" data-secondary="personal access tokens" data-type="indexterm" id="id1701"/><a data-primary="Passport" data-secondary="available grant types" data-tertiary="personal access tokens" data-type="indexterm" id="id1702"/> authorization code grant is great for your users’ apps, and the password code grant is great for your own apps, but what if your users want to create tokens for themselves to test out your API or to use when they’re developing their apps? That’s what personal tokens are for.</p>&#13;
<div data-type="tip"><h1>Creating a Personal Access Client</h1>&#13;
<p>To create personal tokens, you need a personal access client in your database. Running <code>php artisan passport:install</code> will have added one already, but if you ever need to generate a new<a data-primary="--personal flag" data-type="indexterm" id="id1703"/> personal access client for any reason, you can run <code>php artisan passport:client --personal</code>:</p>&#13;
<pre data-code-language="bash" data-type="programlisting">&#13;
<strong><code>php</code><code class="w"> </code><code>artisan</code><code class="w"> </code><code>passport:client</code><code class="w"> </code><code>--personal</code></strong><code class="w">&#13;
&#13;
 </code><code>What</code><code class="w"> </code><code>should</code><code class="w"> </code><code>we</code><code class="w"> </code><code>name</code><code class="w"> </code><code>the</code><code class="w"> </code><code>personal</code><code class="w"> </code><code>access</code><code class="w"> </code><code>client?</code><code class="w">&#13;
   </code><code class="o">[</code><code>My</code><code class="w"> </code><code>Application</code><code class="w"> </code><code>Personal</code><code class="w"> </code><code>Access</code><code class="w"> </code><code>Client</code><code class="o">]</code><code>:</code><code class="w">&#13;
 </code><code>&gt;</code><code class="w"> </code><strong><code>My</code><code class="w"> </code><code>Application</code><code class="w"> </code><code>Personal</code><code class="w"> </code><code>Access</code><code class="w"> </code><code>Client</code></strong><code class="w">&#13;
&#13;
</code><code>Personal</code><code class="w"> </code><code>access</code><code class="w"> </code><code>client</code><code class="w"> </code><code>created</code><code class="w"> </code><code>successfully.</code><code class="w">&#13;
</code></pre>&#13;
</div>&#13;
&#13;
<p>Personal access tokens are not quite a “grant” type; there’s no OAuth-prescribed flow here. Rather, they’re a convenience method that Passport adds to make it easy to have a single client registered in your system that exists solely to facilitate the creation of convenience tokens for your users who are developers.</p>&#13;
&#13;
<p>For example, maybe you have a user who’s developing a competitor to SpaceBook named RaceBook (it’s for marathon runners), and they want to toy around with the Tweeter API a bit to figure out how it works <em>before</em> starting to code. Does this developer have the facility to create tokens using the authorization code flow? Not yet—​they haven’t even written any code yet! That’s what personal access tokens are for.</p>&#13;
&#13;
<p>You can create personal access tokens through the JSON API, which we’ll cover shortly, but you can also create one for your user directly in code:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Creating a token without scopes</code>&#13;
<code class="nv">$token</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">createToken</code><code class="p">(</code><code class="s1">'Token Name'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">accessToken</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// Creating a token with scopes</code>&#13;
<code class="nv">$token</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">createToken</code><code class="p">(</code><code class="s1">'My Token'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'place-orders'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">accessToken</code><code class="p">;</code></pre>&#13;
&#13;
<p>Your users can use these tokens just as if they were tokens created with the authorization code grant flow. We’ll talk more about scopes in <a data-type="xref" href="#passport_scopes">“Passport scopes”</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Tokens from Laravel session authentication (synchronizer tokens)" data-type="sect4"><div class="sect4" id="id274">&#13;
<h4>Tokens from Laravel session authentication (synchronizer tokens)</h4>&#13;
&#13;
<p>There’s<a data-primary="access tokens" data-secondary="synchronizer tokens" data-type="indexterm" id="id1704"/><a data-primary="Passport" data-secondary="available grant types" data-tertiary="synchronizer tokens" data-type="indexterm" id="id1705"/><a data-primary="synchronizer tokens" data-type="indexterm" id="id1706"/> one final way for your users to get tokens to access your API, and it’s another convenience method that Passport adds but that normal OAuth servers don’t <span class="keep-together">provide.</span> This method is for when your users are already authenticated because they’ve logged in to your Laravel app like normal, and you want your app’s JavaScript to be able to access the API. It’d be a pain to have to reauthenticate the users with the authorization code or password grant flow, so Laravel provides a helper for that.</p>&#13;
&#13;
<p>If you add the <code>Laravel\Passport\Http\Middleware\CreateFreshApiToken</code> middleware to your <code>web</code> middleware group (in <em>app/Http/Kernel.php</em>), every response Laravel sends to your authenticated users will have a cookie named <code>laravel_token</code> attached to it. This cookie is a<a data-primary="JSON operations" data-secondary="JSON Web Tokens (JWT)" data-type="indexterm" id="id1707"/> JSON Web Token (JWT) that contains encoded information about the CSRF token. Now, if you send the normal CSRF token with your JavaScript requests in the <code>X-CSRF-TOKEN</code> header and also send the <code>X-Requested-With</code> header with any API requests you make, the API will compare your CSRF token with this cookie and this will authenticate your users to the API just like any other token.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1708">&#13;
<h1>JSON Web Tokens (JWT)</h1>&#13;
<p>JWT is a relatively new format for “representing claims securely between two parties” that has gained prominence over the last few years. A JSON Web Token is a JSON object containing all of the information necessary to determine a user’s authentication state and access permissions. This JSON object is digitally signed using a keyed-hash message authentication code (HMAC) or RSA, which is what makes <span class="keep-together">it trustworthy.</span></p>&#13;
&#13;
<p>The token is usually encoded and then delivered via URL or <code>POST</code> request, or in a header. Once a user authenticates with the system somehow, every HTTP request after that will contain the token, describing the user’s identity and authorization.</p>&#13;
&#13;
<p>JSON Web Tokens consist of three Base64-encoded strings separated by dots (<code>.</code>); something like <code><em>xxx.yyy.zzz</em></code>. The first section is a Base64-encoded JSON object containing information about which hashing algorithm is being used; the second section is a series of “claims” about the user’s authorization and identity; and the third is the signature, or the first and second sections encrypted and signed using the algorithm specified in the first section.</p>&#13;
&#13;
<p>To learn more about JWT, check out <a href="https://jwt.io">JWT.IO</a> or the <a href="https://oreil.ly/Ig_eu"><code>jwt-auth</code> Laravel package</a>.</p>&#13;
</div></aside>&#13;
&#13;
<p>The default JavaScript bootstrap setup that Laravel comes bundled with sets up this header for you, but if you’re using a different framework, you’ll need to set it up manually. <a data-type="xref" href="#pass_tokens_with_all_Ajax_requests">Example 13-36</a> shows how to do it with jQuery.</p>&#13;
<div data-type="example" id="pass_tokens_with_all_Ajax_requests">&#13;
<h5><span class="label">Example 13-36. </span>Setting jQuery to pass Laravel’s CSRF tokens and the <code>X-Requested-With</code> header with all Ajax requests</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">$</code><code class="p">.</code><code class="nx">ajaxSetup</code><code class="p">({</code>&#13;
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
        <code class="s1">'X-CSRF-TOKEN'</code><code class="o">:</code> <code class="s2">"{{ csrf_token() }}"</code><code class="p">,</code>&#13;
        <code class="s1">'X-Requested-With'</code><code class="o">:</code> <code class="s1">'XMLHttpRequest'</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If you add the <code>CreateFreshApiToken</code> middleware to your <code>web</code> middleware group and pass those headers with every JavaScript request, your JavaScript requests will be able to hit your Passport-protected API routes without worrying about any of the complexity of the authorization code or password grants.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Passport scopes" data-type="sect3"><div class="sect3" id="passport_scopes">&#13;
<h3>Passport scopes</h3>&#13;
&#13;
<p>If<a data-primary="Passport" data-secondary="scopes" data-type="indexterm" id="id1709"/><a data-primary="scopes (in OAuth)" data-type="indexterm" id="id1710"/> you’re familiar with OAuth, you’ve probably noticed we haven’t talked much about scopes yet. Everything we’ve covered so far can be customized by scope—but before we get into that, let’s first quickly cover what scopes are.</p>&#13;
&#13;
<p>In OAuth, <em>scopes</em> are defined sets of privileges that are something other than “can do everything.” If you’ve ever gotten a GitHub API token before, for example, you might’ve noticed that some apps want access just to your name and email address, some want access to all of your repos, and some want access to your gists. Each of these is a “scope,” which allows both the user and the consumer app to define what access the consumer app needs to perform its job.</p>&#13;
&#13;
<p>As shown in <a data-type="xref" href="#defining_passport_scopes">Example 13-37</a>, you can define the scopes for your application in the <code>boot()</code> method of your <code>AuthServiceProvider</code>.</p>&#13;
<div data-type="example" id="defining_passport_scopes">&#13;
<h5><span class="label">Example 13-37. </span>Defining Passport scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// AuthServiceProvider</code>&#13;
<code class="k">use</code> <code class="nx">Laravel\Passport\Passport</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="o">...</code>&#13;
&#13;
        <code class="nx">Passport</code><code class="o">::</code><code class="na">tokensCan</code><code class="p">([</code>&#13;
            <code class="s1">'list-clips'</code> <code class="o">=&gt;</code> <code class="s1">'List sound clips'</code><code class="p">,</code>&#13;
            <code class="s1">'add-delete-clips'</code> <code class="o">=&gt;</code> <code class="s1">'Add new and delete old sound clips'</code><code class="p">,</code>&#13;
            <code class="s1">'admin-account'</code> <code class="o">=&gt;</code> <code class="s1">'Administer account details'</code><code class="p">,</code>&#13;
        <code class="p">]);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Once you have your scopes defined, the consumer app can define which scopes it’s asking for access to. Just add a space-separated list of tokens in the <code>scope</code> field in the initial redirect, as shown in <a data-type="xref" href="#requesting_authorization">Example 13-38</a>.</p>&#13;
<div data-type="example" id="requesting_authorization">&#13;
<h5><span class="label">Example 13-38. </span>Requesting authorization to access specific scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In SpaceBook's routes/web.php:</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'tweeter/redirect'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code> <code class="o">=</code> <code class="nb">http_build_query</code><code class="p">([</code>&#13;
        <code class="s1">'client_id'</code> <code class="o">=&gt;</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'tweeter.id'</code><code class="p">),</code>&#13;
        <code class="s1">'redirect_uri'</code> <code class="o">=&gt;</code> <code class="nx">url</code><code class="p">(</code><code class="s1">'tweeter/callback'</code><code class="p">),</code>&#13;
        <code class="s1">'response_type'</code> <code class="o">=&gt;</code> <code class="s1">'code'</code><code class="p">,</code>&#13;
        <code class="s1">'scope'</code> <code class="o">=&gt;</code> <code class="s1">'list-clips add-delete-clips'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'http://tweeter.test/oauth/authorize?'</code> <code class="o">.</code> <code class="nv">$query</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>When the user tries to authorize with this app, it’ll present the list of requested scopes. This way, the user will know whether “SpaceBook is requesting to see your email address” or “SpaceBook is requesting access to post as you and delete your posts and message your friends.”</p>&#13;
&#13;
<p>You can check for scope using middleware or on the <code>User</code> instance. <a data-type="xref" href="#check_to_perform_a_given_action">Example 13-39</a> shows how to check on the <code>User</code>.</p>&#13;
<div data-type="example" id="check_to_perform_a_given_action">&#13;
<h5><span class="label">Example 13-39. </span>Checking whether the token a user authenticated with can perform a given action</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'/events'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">tokenCan</code><code class="p">(</code><code class="s1">'add-delete-clips'</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>There are two middleware you can use for this too, <code>scope</code> and <code>scopes</code>. To use these in your app, add them to <code>$middlewareAliases</code> in your <em>app/Http/Kernel.php</em> file:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'scopes'</code> <code class="o">=&gt;</code> <code class="nx">\Laravel\Passport\Http\Middleware\CheckScopes</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="s1">'scope'</code> <code class="o">=&gt;</code> <code class="nx">\Laravel\Passport\Http\Middleware\CheckForAnyScope</code><code class="o">::</code><code class="na">class</code><code class="p">,</code></pre>&#13;
&#13;
<p>You can now use the middleware as illustrated in <a data-type="xref" href="#passport_Using_middleware_to_restrict">Example 13-40</a>. <code>scopes</code> requires <em>all</em> of the defined scopes to be on the user’s token in order for the user to access the route, while <code>scope</code> requires <em>at least one</em> of the defined scopes to be on the user’s token.</p>&#13;
<div data-type="example" id="passport_Using_middleware_to_restrict">&#13;
<h5><span class="label">Example 13-40. </span>Using middleware to restrict access based on token scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/api.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'clips'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Access token has both the "list-clips" and "add-delete-clips" scopes</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'scopes:list-clips,add-delete-clips'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'clips'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Access token has at least one of the listed scopes</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'scope:list-clips,add-delete-clips'</code><code class="p">)</code></pre></div>&#13;
&#13;
<p>If you haven’t defined any scopes, the app will just work as if they don’t exist. The moment you use scopes, however, your consumer apps will have to explicitly define which scopes they’re requesting access with. The one exception to this rule is that if you’re using the password grant type, your consumer app can request the <code>*</code> scope, which gives the token access to everything.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deploying Passport" data-type="sect3"><div class="sect3" id="id276">&#13;
<h3>Deploying Passport</h3>&#13;
&#13;
<p>The<a data-primary="Passport" data-secondary="deploying" data-type="indexterm" id="id1711"/> first time you deploy your Passport-powered app, the Passport API won’t function until you generate keys for the app. This can be accomplished by running <code>php artisan passport:keys</code> on your production server, which will generate the encryption keys Passport uses to generate tokens.<a data-primary="" data-startref="APIauthpassport13" data-type="indexterm" id="id1712"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing 404 Responses" data-type="sect1"><div class="sect1" id="id277">&#13;
<h1>Customizing 404 Responses</h1>&#13;
&#13;
<p>Laravel<a data-primary="APIs (application programming interfaces)" data-secondary="customizing 404 responses" data-type="indexterm" id="id1713"/><a data-primary="404 responses, customizing" data-type="indexterm" id="id1714"/><a data-primary="404 responses, customizing" data-primary-sortas="four" data-type="indexterm" id="id1715"/><a data-primary="fallback responses" data-type="indexterm" id="id1716"/> offers customizable error-message pages for normal HTML views, but you can also customize the default 404 fallback response for calls with a JSON content type. To do so, add a <code>Route::fallback()</code> call to your API, as shown in <a data-type="xref" href="#EX13d">Example 13-41</a>.</p>&#13;
<div data-type="example" id="EX13d">&#13;
<h5><span class="label">Example 13-41. </span>Defining a fallback route</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/api.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">fallback</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">([</code><code class="s1">'message'</code> <code class="o">=&gt;</code> <code class="s1">'Route Not Found'</code><code class="p">],</code> <code class="mi">404</code><code class="p">);</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'api.fallback.404'</code><code class="p">);</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Triggering the Fallback Route" data-type="sect2"><div class="sect2" id="id278">&#13;
<h2>Triggering the Fallback Route</h2>&#13;
&#13;
<p>If<a data-primary="“not found” exceptions" data-primary-sortas="not found” exceptions" data-type="indexterm" id="id1717"/> you want to customize which route is returned when Laravel catches “not found” exceptions, you can update the exception handler using the <code>respondWithRoute()</code> method, as illustrated in <a data-type="xref" href="#EX13e">Example 13-42</a>.</p>&#13;
<div data-type="example" id="EX13e">&#13;
<h5><span class="label">Example 13-42. </span>Calling the fallback route when “not found” exceptions are caught</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// App\Exceptions\Handler</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Route</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Request</code><code class="p">;</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">register</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">renderable</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">NotFoundHttpException</code> <code class="nv">$e</code><code class="p">,</code> <code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">isJson</code><code class="p">())</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nx">Route</code><code class="o">::</code><code class="na">respondWithRoute</code><code class="p">(</code><code class="s1">'api.fallback.404'</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">});</code>&#13;
&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id498">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Fortunately, testing APIs<a data-primary="APIs (application programming interfaces)" data-secondary="testing" data-type="indexterm" id="id1718"/><a data-primary="testing" data-secondary="APIs (application programming interfaces)" data-type="indexterm" id="id1719"/> is actually simpler than testing almost anything else in <span class="keep-together">Laravel.</span></p>&#13;
&#13;
<p>We cover this in more depth in <a data-type="xref" href="ch12.html#testing">Chapter 12</a>, but there are a series of methods for making assertions against JSON. Combine that capability with the simplicity of full-stack application tests, and you can put together your API tests quickly and easily. Take a look at the common API testing pattern in <a data-type="xref" href="#common_API_testing_pattern">Example 13-43</a>.</p>&#13;
<div data-type="example" id="common_API_testing_pattern">&#13;
<h5><span class="label">Example 13-43. </span>A common API testing pattern</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">DogsApiTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">WithoutMiddleware</code><code class="p">,</code> <code class="nx">RefreshDatabase</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_gets_all_dogs</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$dog1</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
        <code class="nv">$dog2</code> <code class="o">=</code> <code class="nx">Dog</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
        <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">getJson</code><code class="p">(</code><code class="s1">'api/dogs'</code><code class="p">);</code>&#13;
&#13;
        <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertJsonFragment</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$dog1</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">]);</code>&#13;
        <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertJsonFragment</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$dog2</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">]);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Note that we’re using <code>WithoutMiddleware</code> to avoid worrying about authentication. You’ll want to test that separately, if at all (for more on authentication, see <a data-type="xref" href="ch09.html#user_authentication_and_authorization">Chapter 9</a>).</p>&#13;
&#13;
<p>In this test we insert two <code>Dog</code>s into the database, then visit the API route for listing all <code>Dog</code>s and make sure both are present in the output.</p>&#13;
&#13;
<p>You can cover all of your API routes simply and easily here, including modifying actions like <code>POST</code> and <code>PATCH</code>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing Passport" data-type="sect2"><div class="sect2" id="id279">&#13;
<h2>Testing Passport</h2>&#13;
&#13;
<p>You<a data-primary="testing" data-secondary="Passport" data-type="indexterm" id="id1720"/><a data-primary="Passport" data-secondary="testing" data-type="indexterm" id="id1721"/><a data-primary="actingAs() method" data-type="indexterm" id="id1722"/> can use the <code>actingAs()</code> method on the <code>Passport</code> facade to test your scopes. Take a look at <a data-type="xref" href="#common_passport_testing">Example 13-44</a> to see a common pattern for testing scopes in Passport.</p>&#13;
<div data-type="example" id="common_passport_testing">&#13;
<h5><span class="label">Example 13-44. </span>Testing scoped access</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_lists_all_clips_for_those_with_list_clips_scope</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Passport</code><code class="o">::</code><code class="na">actingAs</code><code class="p">(</code>&#13;
        <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">(),</code>&#13;
        <code class="p">[</code><code class="s1">'list-clips'</code><code class="p">]</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">getJson</code><code class="p">(</code><code class="s1">'api/clips'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id499">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Laravel<a data-primary="APIs (application programming interfaces)" data-secondary="overview of" data-type="indexterm" id="id1723"/> is geared toward building APIs and makes it simple to work with JSON and RESTful APIs. There are some conventions, like for pagination, but much of the definition of exactly how your API will be sorted, authenticated, or whatever else is up to you.</p>&#13;
&#13;
<p>Laravel provides tools for authentication and testing, easy manipulation and reading of headers, and working with JSON, even automatically encoding all Eloquent results to JSON if they’re returned directly from a route.</p>&#13;
&#13;
<p>Laravel Passport<a data-primary="Passport" data-secondary="overview of" data-type="indexterm" id="id1724"/> is a separate package that makes it simple to create and manage an OAuth server in your Laravel apps.</p>&#13;
</div></section>&#13;
</div></section></body></html>