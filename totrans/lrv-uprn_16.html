<html><head></head><body><section data-pdf-bookmark="Chapter 16. Queues, Jobs, Events, Broadcasting, and the Scheduler" data-type="chapter" epub:type="chapter"><div class="chapter" id="queues_jobs_events">&#13;
<h1><span class="label">Chapter 16. </span>Queues, Jobs, Events, Broadcasting, <span class="keep-together">and the Scheduler</span></h1>&#13;
&#13;
&#13;
<p>So far we’ve covered some of the most common structures that power web applications: databases, mail, filesystems, and more. All of these are common across a majority of applications and frameworks.</p>&#13;
&#13;
<p>Laravel also provides facilities for some less common architecture patterns and application structures. In this chapter we’ll cover Laravel’s tools for implementing queues, queued jobs, events, and WebSocket event publishing. We’ll also cover Laravel’s scheduler, which makes manually edited cron schedules a thing of the past.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues" data-type="sect1"><div class="sect1" id="queues-6Euyh3">&#13;
<h1>Queues</h1>&#13;
&#13;
<p>To<a data-primary="queues and queueing" data-secondary="concept of" data-type="indexterm" id="id1861"/> understand what a queue is, just think about the idea of “queueing up” in a line at the bank. Even if there are multiple lines—​queues—​only one person is being served at a time from each queue, and each person will eventually reach the front and be served. In some banks, it’s a strict first-in-first-out sort of policy, but in other banks, there’s not an exact guarantee that someone won’t cut ahead of you in line at some point. Essentially, someone can get added to the queue, be removed from the queue prematurely, or be successfully “processed” and then removed. Someone might even hit the front of the queue, not be able to be served correctly, return to the queue for a time, and then be processed again.</p>&#13;
&#13;
<p>Queues in programming are very similar. Your application adds a “job” to a queue, which is a chunk of code that tells the application how to perform a particular behavior. Then some other separate application structure, usually a “queue worker,” takes the responsibility for pulling jobs off of the queue one at a time and performing the appropriate behavior. Queue workers can delete the jobs, return them to the queue with a delay, or mark them as successfully processed.</p>&#13;
&#13;
<p>Laravel<a data-primary="queues and queueing" data-secondary="services supported" data-type="indexterm" id="id1862"/> makes it easy to serve your queues using Redis, <em>beanstalkd</em>, Amazon Simple Queue Service (SQS), or a database table. You can also choose the <code>sync</code> driver to have the jobs run right in your application without actually being queued, or the <code>null</code> driver for jobs to just be discarded; these two are usually used in local development or testing environments.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Why Queues?" data-type="sect2"><div class="sect2" id="why-queues-MaumI0hR">&#13;
<h2>Why Queues?</h2>&#13;
&#13;
<p>Queues<a data-primary="queues and queueing" data-secondary="benefits of" data-type="indexterm" id="id1863"/> make it easy to remove a costly or slow process from any synchronous call. The most common example is sending mail—​doing so can be slow, and you don’t want your users to have to wait for mail to send in response to their actions. Instead, you can trigger a “send mail” queued job and let the users get on with their day. And sometimes you may not be worried about saving your users time, but you might have a process like a cron job or a webhook that has a lot of work to get through; rather than letting it all run at once (and potentially time out), you may choose to queue its individual pieces and let the queue worker process them one at a time.</p>&#13;
&#13;
<p>Additionally, if you have some heavy processing that’s more than your server can handle, you can spin up more than one queue worker to work through your queue faster than your normal application server could on its own.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic Queue Configuration" data-type="sect2"><div class="sect2" id="basic-queue-configuration-OduWc4hq">&#13;
<h2>Basic Queue Configuration</h2>&#13;
&#13;
<p>Like<a data-primary="queues and queueing" data-secondary="basic queue configuration" data-type="indexterm" id="id1864"/> many other Laravel features that abstract multiple providers, queues have their own dedicated config file (<em>config/queue.php</em>) that allows you to set up multiple drivers and define which will be the default. This is also where you’ll store your SQS, Redis, or <em>beanstalkd</em> authentication information.</p>&#13;
<div data-type="tip"><h1>Simple Redis Queues on Laravel Forge</h1>&#13;
<p><a href="http://forge.laravel.com">Laravel Forge</a> is a hosting management<a data-primary="Laravel Forge" data-type="indexterm" id="id1865"/> service provided by Taylor Otwell, the creator of Laravel, which makes serving queues with Redis a breeze. Every server you create has Redis configured automatically, so if you visit any site’s Forge console, you can just go to the Queue tab and hit Start Worker and you’re ready to use Redis as your queue driver; you can leave all the default settings, and no other work is necessary.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Queued Jobs" data-type="sect2"><div class="sect2" id="queued-jobs-QeulT3hg">&#13;
<h2>Queued Jobs</h2>&#13;
&#13;
<p>Remember<a data-primary="queues and queueing" data-secondary="queued jobs" data-type="indexterm" id="QQjobs16"/><a data-primary="jobs" data-secondary="queueing" data-tertiary="data types supported" data-type="indexterm" id="id1866"/> our bank analogy? Each person in the bank’s <em>queue</em> (line) is, in programming terms, a <em>job</em>. Queued jobs can, depending on the environment, take many shapes, like arrays of data or simple strings. In Laravel, each job is a collection of information containing the job name, the data payload, the number of attempts that have been made so far to process this job, and some other simple metadata.</p>&#13;
&#13;
<p>But you don’t need to worry about any of that in your interactions with Laravel. Laravel provides a structure called <code>Job</code>, which is intended to encapsulate a single task—​a behavior that your application can be commanded to do—​and allow it to be added to and pulled from a queue. There are also simple helpers to make it easy to queue Artisan commands and mail.</p>&#13;
&#13;
<p>Let’s start with an example in which every time a user changes their plan with your SaaS app, you want to rerun some calculations about your overall profit.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a job" data-type="sect3"><div class="sect3" id="id315">&#13;
<h3>Creating a job</h3>&#13;
&#13;
<p>As<a data-primary="jobs" data-secondary="queueing" data-tertiary="creating jobs" data-type="indexterm" id="id1867"/> always, there’s an Artisan command for that:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">job</code> <code class="nx">CrunchReports</code></pre>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX1502">Example 16-1</a> to see what you’ll get.</p>&#13;
<div data-type="example" id="EX1502">&#13;
<h5><span class="label">Example 16-1. </span>The default template for jobs in Laravel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Jobs</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Bus\Queueable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldBeUnique</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Foundation\Bus\Dispatchable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\InteractsWithQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\SerializesModels</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">CrunchReports</code> <code class="k">implements</code> <code class="nx">ShouldQueue</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Dispatchable</code><code class="p">,</code> <code class="nx">InteractsWithQueue</code><code class="p">,</code> <code class="nx">Queueable</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Create a new job instance.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Execute the job.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, this template imports the <code>Dispatchable</code>, <code>InteractsWithQueue</code>, <code>Queueable</code>, and <code>SerializesModels</code> traits, and implements the <code>ShouldQueue</code> interface.</p>&#13;
&#13;
<p>We also get two methods from this template: the constructor, which you’ll use to attach data to the job, and the <code>handle()</code> method, which is where the job’s logic should reside (and is also the method signature you’ll use to inject dependencies).</p>&#13;
&#13;
<p>The traits and interface provide the class with the ability to be added to, and interact with, the queue. <code>Dispatchable</code> gives it methods to dispatch itself; <code>InteractsWithQueue</code> allows each job, while being handled, to control its relationship with the queue, including deleting or requeueing itself; <code>Queueable</code> allows you to specify how Laravel should push this job to the queue; and <code>SerializesModels</code> gives the job the ability to serialize and deserialize Eloquent models.</p>&#13;
<div data-type="note" epub:type="note"><h1>Serializing Models</h1>&#13;
<p>The<a data-primary="jobs" data-secondary="queueing" data-tertiary="serializing models" data-type="indexterm" id="id1868"/><a data-primary="serialization (Eloquent)" data-type="indexterm" id="id1869"/> <code>SerializesModels</code> trait gives jobs the ability to <em>serialize</em> (convert to a flatter format that can be stored in a data store like a database or queue system) injected models so that your job’s <span class="keep-together"><code>handle()</code></span> method will have access to them. However, because it’s too difficult to reliably serialize an entire Eloquent object, the trait ensures that just the primary keys of any attached Eloquent objects are serialized when the job is pushed onto the queue. When the job is deserialized and handled, the trait pulls those Eloquent models fresh from the database by their primary key. This means that when your job runs, it will be pulling a fresh instance of this model, not whatever state it was in when you queued the job.</p>&#13;
</div>&#13;
&#13;
<p>Let’s fill out the methods for our sample class, as in <a data-type="xref" href="#example_job">Example 16-2</a>.</p>&#13;
<div data-type="example" id="example_job">&#13;
<h5><span class="label">Example 16-2. </span>An example job</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">App\ReportGenerator</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">CrunchReports</code> <code class="k">implements</code> <code class="nx">ShouldQueue</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Dispatchable</code><code class="p">,</code> <code class="nx">InteractsWithQueue</code><code class="p">,</code> <code class="nx">Queueable</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="k">protected</code> <code class="nv">$user</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code> <code class="o">=</code> <code class="nv">$user</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nx">ReportGenerator</code> <code class="nv">$generator</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$generator</code><code class="o">-&gt;</code><code class="na">generateReportsForUser</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">);</code>&#13;
&#13;
        <code class="nx">Log</code><code class="o">::</code><code class="na">info</code><code class="p">(</code><code class="s1">'Generated reports.'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We’re expecting the <code>User</code> instance to be injected when we create the job, and then when it’s handled, we’re typehinting a <code>ReportGenerator</code> class (which we presumably wrote). Laravel will read the typehint and inject that dependency automatically.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pushing a job onto a queue" data-type="sect3"><div class="sect3" id="id587">&#13;
<h3>Pushing a job onto a queue</h3>&#13;
&#13;
<p>There<a data-primary="jobs" data-secondary="queueing" data-tertiary="pushing job into queues" data-type="indexterm" id="id1870"/> are multiple methods by which you can dispatch a job, including some methods available to every controller and a global <code>dispatch()</code> helper. But the simpler and preferred method is calling the <code>dispatch()</code> method on the job itself, so that’s what we’ll do for the rest of the chapter.</p>&#13;
&#13;
<p>To dispatch your job, you can just create an instance of it and then call its <code>dispatch()</code> method, passing any necessary data directly into that method. Take a look at <a data-type="xref" href="#dispatching_jobs">Example 16-3</a> for an example.</p>&#13;
<div data-type="example" id="dispatching_jobs">&#13;
<h5><span class="label">Example 16-3. </span>Dispatching jobs</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code>&#13;
<code class="nv">$daysToCrunch</code> <code class="o">=</code> <code class="mi">7</code><code class="p">;</code>&#13;
<code class="nx">\App\Jobs\CrunchReports</code><code class="o">::</code><code class="na">dispatch</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>There are three settings you can control to customize exactly how you dispatch a job: the connection, the queue, and the delay.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing the connection" data-type="sect4"><div class="sect4" id="id720">&#13;
<h4>Customizing the connection</h4>&#13;
&#13;
<p>If you ever have multiple queue connections in place at once, you can customize the connection by chaining <code>onConnection()</code> after the <span class="keep-together"><code>dispatch()</code></span> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DoThingJob</code><code class="o">::</code><code class="na">dispatch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">onConnection</code><code class="p">(</code><code class="s1">'redis'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing the queue" data-type="sect4"><div class="sect4" id="id721">&#13;
<h4>Customizing the queue</h4>&#13;
&#13;
<p>Within queue servers, you can specify which named queue you’re pushing a job onto. For example, you may differentiate your queues based on their importance, naming one <code>low</code> and one <code>high</code>.</p>&#13;
&#13;
<p>You can customize which queue you’re pushing a job onto with the <code>onQueue()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DoThingJob</code><code class="o">::</code><code class="na">dispatch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">onQueue</code><code class="p">(</code><code class="s1">'high'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing the delay" data-type="sect4"><div class="sect4" id="id722">&#13;
<h4>Customizing the delay</h4>&#13;
&#13;
<p>You can customize the amount of time your queue workers should wait before processing a job with the <code>delay()</code> method, which accepts either an integer representing the number of seconds to delay a job or a <code><em>DateTime</em></code>/<code><em>Carbon</em></code> instance:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Delays five minutes before releasing the job to queue workers</code>&#13;
<code class="nv">$delay</code> <code class="o">=</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addMinutes</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
<code class="nx">DoThingJob</code><code class="o">::</code><code class="na">dispatch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">delay</code><code class="p">(</code><code class="nv">$delay</code><code class="p">);</code></pre>&#13;
&#13;
<p>Note that Amazon SQS doesn’t allow delays longer than 15 minutes.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Job chaining" data-type="sect3"><div class="sect3" id="id588">&#13;
<h3>Job chaining</h3>&#13;
&#13;
<p>If<a data-primary="jobs" data-secondary="queueing" data-tertiary="job chaining" data-type="indexterm" id="id1871"/> you need a series of jobs to run in order one after the other, you can “chain” them together. Each job will wait to run until the previous job completes, and if one job fails, the rest after it won’t run.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code>&#13;
<code class="nv">$daysToCrunch</code> <code class="o">=</code> <code class="mi">7</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Bus</code><code class="o">::</code><code class="na">chain</code><code class="p">([</code>&#13;
    <code class="k">new</code> <code class="nx">CrunchReports</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">),</code>&#13;
    <code class="k">new</code> <code class="nx">SendReport</code><code class="p">(</code><code class="nv">$user</code><code class="p">),</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">dispatch</code><code class="p">();</code></pre>&#13;
&#13;
<p>When one of the chained jobs fails, you can execute with the <code>catch()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code>&#13;
<code class="nv">$daysToCrunch</code> <code class="o">=</code> <code class="mi">7</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Bus</code><code class="o">::</code><code class="na">chain</code><code class="p">([</code>&#13;
    <code class="k">new</code> <code class="nx">CrunchReports</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">),</code>&#13;
    <code class="k">new</code> <code class="nx">NotifyNewReportsDone</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">catch</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Throwable</code> <code class="nv">$e</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">new</code> <code class="nx">ReportsNotCrunchedNotification</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">dispatch</code><code class="p">(</code><code class="nv">$user</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Job batching" data-type="sect3"><div class="sect3" id="id589">&#13;
<h3>Job batching</h3>&#13;
&#13;
<p>Job batching<a data-primary="jobs" data-secondary="queueing" data-tertiary="job batching" data-type="indexterm" id="Jbatch16"/> makes it possible to push a group of jobs onto the queue at the same time, inspect the status of the batch, and take an action after the batch is complete.</p>&#13;
&#13;
<p>This feature requires a database table to keep track of the jobs; as you might expect, there’s an Artisan command to create it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">queue</code><code class="o">:</code><code class="nx">batches</code><code class="o">-</code><code class="nx">table</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">migrate</code></pre>&#13;
&#13;
<p>To mark a job as batchable, include the <code>Illuminate\Bus\Batchable</code> trait. This trait adds a <code>batch()</code> method to your job, which will allow you to retrieve information about the current batch your job is running in.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX1605">Example 16-4</a> to see how this works. In this example, you can see that one of the most important steps to take on a batchable job is to make sure it doesn’t take any action if its batch was canceled.</p>&#13;
<div data-type="example" id="EX1605">&#13;
<h5><span class="label">Example 16-4. </span>Batchable job in Laravel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">SampleBatchableJob</code> <code class="k">implements</code> <code class="nx">ShouldQueue</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Batchable</code><code class="p">,</code> <code class="nx">Dispatchable</code><code class="p">,</code> <code class="nx">InteractsWithQueue</code><code class="p">,</code> <code class="nx">Queueable</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Don't run if this batch is canceled</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">batch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">cancelled</code><code class="p">())</code> <code class="p">{</code>&#13;
            <code class="k">return</code><code class="p">;</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="c1">// Otherwise, run like normal</code>&#13;
        <code class="c1">// ...</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dispatching batchable jobs" data-type="sect4"><div class="sect4" id="id723">&#13;
<h4>Dispatching batchable jobs</h4>&#13;
&#13;
<p>The <code>Bus</code> facade offers a method <code>batch()</code>, which allows you to dispatch a batch of jobs. You can also define actions to take after the batch succeeds or fails, using the <code>then()</code> (succeeds), <code>catch()</code> (fails), or <code>finally()</code> (succeeds or fails) methods.</p>&#13;
&#13;
<p>You can see how these can be called in <a data-type="xref" href="#EX1606">Example 16-5</a>.</p>&#13;
<div data-type="example" id="EX1606">&#13;
<h5><span class="label">Example 16-5. </span>Dispatching batchable jobs</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Jobs\CrunchReports</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Bus</code><code class="p">;</code>&#13;
&#13;
<code class="nv">$user</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code>&#13;
<code class="nv">$admin</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">admin</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$supervisor</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">supervisor</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$daysToCrunch</code> <code class="o">=</code> <code class="mi">7</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Bus</code><code class="o">::</code><code class="na">batch</code><code class="p">([</code>&#13;
    <code class="k">new</code> <code class="nx">CrunchReports</code><code class="o">::</code><code class="na">dispatch</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">),</code>&#13;
    <code class="k">new</code> <code class="nx">CrunchReports</code><code class="o">::</code><code class="na">dispatch</code><code class="p">(</code><code class="nv">$admin</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">),</code>&#13;
    <code class="k">new</code> <code class="nx">CrunchReports</code><code class="o">::</code><code class="na">dispatch</code><code class="p">(</code><code class="nv">$supervisor</code><code class="p">,</code> <code class="nv">$daysToCrunch</code><code class="p">)</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">then</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Batch</code> <code class="nv">$batch</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Run when the batch is completed successfully</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">catch</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Batch</code> <code class="nv">$batch</code><code class="p">,</code> <code class="nx">Throwable</code> <code class="nv">$e</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Run when any job fails</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">finally</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Batch</code> <code class="nv">$batch</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Run when the batch is complete</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">dispatch</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding jobs to batches from a job" data-type="sect4"><div class="sect4" id="id724">&#13;
<h4>Adding jobs to batches from a job</h4>&#13;
&#13;
<p>If the jobs in your batch have a responsibility of adding jobs to a batch—for example, if you initially dispatch a few job-dispatcher type jobs—they can use the <code>add()</code> method on the <code>Batch</code> object returned by <code>batch()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">batch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">cancelled</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">return</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">batch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">add</code><code class="p">([</code>&#13;
        <code class="k">new</code> <code class="nx">\App\Jobs\ImportContacts</code><code class="p">,</code>&#13;
        <code class="k">new</code> <code class="nx">\App\Jobs\ImportContacts</code><code class="p">,</code>&#13;
        <code class="k">new</code> <code class="nx">\App\Jobs\ImportContacts</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cancelling a batch" data-type="sect4"><div class="sect4" id="id725">&#13;
<h4>Cancelling a batch</h4>&#13;
&#13;
<p>If a job has a reason to cancel its batch, it can:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="cm">/* This batch should be canceled for whatever reason */</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">batch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">cancel</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Batch failures" data-type="sect4"><div class="sect4" id="id726">&#13;
<h4>Batch failures</h4>&#13;
&#13;
<p>By default, if a single job in a batch fails, the batch will be marked as “canceled.” If you want to define a different behavior, you can chain <code>allowFailures()</code> when you dispatch the batch:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$batch</code> <code class="o">=</code> <code class="nx">Bus</code><code class="o">::</code><code class="na">batch</code><code class="p">([</code>&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">allowFailures</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">dispatch</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cleaning up the batches table" data-type="sect4"><div class="sect4" id="id316">&#13;
<h4>Cleaning up the batches table</h4>&#13;
&#13;
<p>The batches table isn’t self-pruning, so you’ll want to schedule your app to “prune” that<a data-primary="" data-startref="Jbatch16" data-type="indexterm" id="id1872"/><a data-primary="" data-startref="QQjobs16" data-type="indexterm" id="id1873"/> table:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'queue:prune-batches'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">daily</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running a Queue Worker" data-type="sect2"><div class="sect2" id="queue_workers">&#13;
<h2>Running a Queue Worker</h2>&#13;
&#13;
<p>So<a data-primary="queues and queueing" data-secondary="running queue workers" data-type="indexterm" id="id1874"/><a data-primary="jobs" data-secondary="queueing" data-tertiary="running queue workers" data-type="indexterm" id="id1875"/> what is a queue worker, and how does it work? In Laravel, it’s an Artisan command that runs forever (until it’s stopped manually) and takes the responsibility for pulling down jobs from your queue and running them:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">queue</code><code class="o">:</code><code class="nx">work</code></pre>&#13;
&#13;
<p>This command starts a daemon “listening” to your queue; every time there are jobs on the queue, it will pull down the first job, handle it, delete it, and move on to the next. If at any point there are no jobs, it “sleeps” for a configurable amount of time before checking again to see if there are any more jobs.</p>&#13;
&#13;
<p>You<a data-primary="--timeout flag" data-type="indexterm" id="id1876"/> can define how many seconds a job should be allowed to run before the queue listener stops it (<code>--timeout</code>), how many seconds the listener should<a data-primary="--sleep flag" data-type="indexterm" id="id1877"/> “sleep” when there are no jobs left (<code>--sleep</code>), how many<a data-primary="--tries flag" data-type="indexterm" id="triesflag16"/> tries each job should be allowed before being deleted (<code>--tries</code>), which connection the worker should listen to (the first parameter after <code>queue:work</code>), and which<a data-primary="--queue flag" data-type="indexterm" id="id1878"/> queues it should listen to (<code>--queue=</code>):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">queue</code><code class="o">:</code><code class="nx">work</code> <code class="nx">redis</code> <code class="o">--</code><code class="nx">timeout</code><code class="o">=</code><code class="mi">60</code> <code class="o">--</code><code class="nb">sleep</code><code class="o">=</code><code class="mi">15</code> <code class="o">--</code><code class="nx">tries</code><code class="o">=</code><code class="mi">3</code>&#13;
 <code class="o">--</code><code class="nx">queue</code><code class="o">=</code><code class="nx">high</code><code class="p">,</code><code class="nx">medium</code></pre>&#13;
&#13;
<p>You can also process just a single job with <code>php artisan queue:work</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Errors" data-type="sect2"><div class="sect2" id="handling-errors-zMu9tEhp">&#13;
<h2>Handling Errors</h2>&#13;
&#13;
<p>So, what<a data-primary="jobs" data-secondary="queueing" data-tertiary="error handling" data-type="indexterm" id="JQerror16"/><a data-primary="queues and queueing" data-secondary="error handling" data-type="indexterm" id="QQerror16"/><a data-primary="exceptions" data-secondary="handling job queue errors" data-type="indexterm" id="EXjobqueue16"/> happens when something goes wrong with a job that’s in the middle of &#13;
<span class="keep-together">processing</span>?</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Exceptions in handling" data-type="sect3"><div class="sect3" id="id727">&#13;
<h3>Exceptions in handling</h3>&#13;
&#13;
<p>If an exception is thrown, the queue listener will release that job back onto the queue. The job will be rereleased to be processed again and again until it is able to finish successfully or until it has reached the maximum number of attempts allowed by your queue listener.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Limiting the number of tries" data-type="sect3"><div class="sect3" id="id318">&#13;
<h3>Limiting the number of tries</h3>&#13;
&#13;
<p>The maximum number of tries is defined by the <code>--tries</code> switch passed to the <code>queue:listen</code> or <code>queue:work</code> Artisan command.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>The Danger of Infinite Retries</h1>&#13;
<p>If<a data-primary="retries, danger of infinite" data-type="indexterm" id="id1879"/> you don’t set <code>--tries</code>, or if you set it to <code>0</code>, the queue listener will allow infinite retries. That means if there are any circumstances in which a job can just <em>never</em> be completed—​for example, if it relies on a tweet that has since been deleted—​your app will slowly crawl to a halt as it retries forever.</p>&#13;
&#13;
<p>The <a href="https://oreil.ly/7BIW-">documentation</a> and Laravel Forge both show <code>3</code> as the recommended starting point for the maximum number of retries. So, in case of confusion, start there and adjust:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:work<code class="w"> </code>--tries<code class="o">=</code><code class="m">3</code><code class="w"/></pre>&#13;
</div>&#13;
&#13;
<p>If<a data-primary="attempts() method" data-type="indexterm" id="id1880"/> at any point you’d like to check how many times a job has been attempted already, use the <code>attempts()</code> method on the job itself, as in <a data-type="xref" href="#times_a_job_been_tried">Example 16-6</a>.</p>&#13;
<div data-type="example" id="times_a_job_been_tried">&#13;
<h5><span class="label">Example 16-6. </span>Checking how many times a job has already been tried</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">attempts</code><code class="p">()</code> <code class="o">&gt;</code> <code class="mi">3</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You<a data-primary="$tries property" data-type="indexterm" id="id1881"/> can also specify the maximum number of times a given job can be retried on the job class itself by defining a <code>$tries</code> property. When specified, this value will take precedence over the value set with the <code>--tries</code> switch:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="nv">$tries</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code></pre>&#13;
&#13;
<p>You<a data-primary="$maxExceptions property" data-type="indexterm" id="id1882"/> can set the <code>$maxExceptions</code> property in a job class to specify how many times the job can throw an exception (and therefore be retried) before it should be considered failed:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Can attempt this job 10 times.</code>&#13;
<code class="k">public</code> <code class="nv">$tries</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// If the job fails 3 times because an exception was thrown,</code>&#13;
<code class="c1">// stop attempting the job and fail it.</code>&#13;
<code class="k">public</code> <code class="nv">$maxExceptions</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code></pre>&#13;
&#13;
<p>You<a data-primary="" data-startref="triesflag16" data-type="indexterm" id="id1883"/><a data-primary="retryUntil() method" data-type="indexterm" id="id1884"/> can also specify when a job should time out, instructing the framework to attempt the job any number of times within a specified timeframe. You can specify a <code>retryUntil()</code> method on a job and from that return a <code>DateTime/Carbon</code> instance:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">retryUntil</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addSeconds</code><code class="p">(</code><code class="mi">30</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Job-based retry delay" data-type="sect3"><div class="sect3" id="id728">&#13;
<h3>Job-based retry delay</h3>&#13;
&#13;
<p>We can specify how long to wait before retrying a failed job by setting a <code>$retryAfter</code> property on the job, equivalent to the minutes to wait. For more complex calculations, we can instead define a <code>retryAfter</code> method, which should also return the minutes to wait:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="nv">$retryAfter</code> <code class="o">=</code> <code class="mi">10</code><code class="p">;</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">retryAfter</code><code class="p">()</code> <code class="p">{</code><code class="o">...</code><code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Job middleware" data-type="sect3"><div class="sect3" id="id535">&#13;
<h3>Job middleware</h3>&#13;
&#13;
<p>We<a data-primary="middleware" data-secondary="for jobs" data-secondary-sortas="jobs" data-type="indexterm" id="id1885"/> can run jobs through middleware, just like we run our HTTP requests through middleware. This is a great opportunity to extract logic that guards or validates your jobs or the conditions they’ll run in:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Jobs\Middleware</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Response</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">MyMiddleware</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nv">$job</code><code class="p">,</code> <code class="nv">$next</code><code class="p">)</code><code class="o">:</code> <code class="nx">Response</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="nv">$something</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nv">$next</code><code class="p">(</code><code class="nv">$job</code><code class="p">);</code>&#13;
        <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>&#13;
            <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">release</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>To assign a middleware to a job, specify a <code>middleware()</code> method in the job class:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">App\Jobs\Middleware\MyMiddleware</code><code class="p">;</code>&#13;
&#13;
<code class="o">...</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">middleware</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="k">new</code> <code class="nx">MyMiddleware</code><code class="p">];</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>You can also specify a middleware when dispatching jobs using the <code>through</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DoThingJob</code><code class="o">::</code><code class="na">dispatch</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">through</code><code class="p">([</code><code class="k">new</code> <code class="nx">MyMiddleware</code><code class="p">]);</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Rate limiting middleware for jobs" data-type="sect4"><div class="sect4" id="id319">&#13;
<h4>Rate limiting middleware for jobs</h4>&#13;
&#13;
<p>Laravel comes out of the box with a<a data-primary="rate limiting" data-type="indexterm" id="id1886"/> rate limiting job middleware. To use it, define a rate limiter using <code>RateLimiter::for()</code> in the <code>boot()</code> method of a service provider, as shown in <a data-type="xref" href="#EX1607">Example 16-7</a>.</p>&#13;
<div data-type="example" id="EX1607">&#13;
<h5><span class="label">Example 16-7. </span>A sample job rate limiting middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In a service provider</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">RateLimiter</code><code class="o">::</code><code class="na">for</code><code class="p">(</code><code class="s1">'imageConversions'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">object</code> <code class="nv">$job</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">paidForPriorityConversions</code><code class="p">()</code>&#13;
            <code class="o">?</code> <code class="nx">Limit</code><code class="o">::</code><code class="na">none</code><code class="p">()</code>&#13;
            <code class="o">:</code> <code class="nx">Limit</code><code class="o">::</code><code class="na">perHour</code><code class="p">(</code><code class="mi">1</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">by</code><code class="p">(</code><code class="nv">$job</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The syntax of the job rate limiting middleware is the same as the route rate limiting middleware (<a data-type="xref" href="ch10.html#route_rate_limiting">“Rate Limiting”</a>).</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling failed jobs" data-type="sect3"><div class="sect3" id="id320">&#13;
<h3>Handling failed jobs</h3>&#13;
&#13;
<p>Once<a data-primary="failed jobs" data-type="indexterm" id="id1887"/><a data-primary="jobs" data-secondary="failed jobs" data-type="indexterm" id="id1888"/> a job has exceeded its allowable number of retries, it’s considered a “failed” job. Before you do anything else—​even if all you want to do is limit the number of times a job can be tried—​you’ll need to create a “failed jobs” database table.</p>&#13;
&#13;
<p>There’s an Artisan command to create the migration (and you’ll then want to migrate):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">queue</code><code class="o">:</code><code class="nx">failed</code><code class="o">-</code><code class="nx">table</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">migrate</code></pre>&#13;
&#13;
<p>Any job that has surpassed its maximum number of allowed attempts will be dumped there. But there are quite a few things you can do with your failed jobs.</p>&#13;
&#13;
<p>First, you can define a <code>failed()</code> method on the job itself, which will run when that job fails (see <a data-type="xref" href="#method_when_a_job_fails">Example 16-8</a>).</p>&#13;
<div data-type="example" id="method_when_a_job_fails">&#13;
<h5><span class="label">Example 16-8. </span>Defining a method to run when a job fails</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">CrunchReports</code> <code class="k">implements</code> <code class="nx">ShouldQueue</code>&#13;
<code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">failed</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Do whatever you want, like notify an admin</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Next, you can register a global handler for failed jobs. Somewhere in the application’s bootstrap—​if you don’t know where to put it, just put it in the <code>boot()</code> method of <code>AppServiceProvider</code>—place the code in <a data-type="xref" href="#global_handler_to_handle_failed_jobs">Example 16-9</a> to define a listener.</p>&#13;
<div data-type="example" id="global_handler_to_handle_failed_jobs">&#13;
<h5><span class="label">Example 16-9. </span>Registering a global handler to handle failed jobs</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Some service provider</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Queue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\Events\JobFailed</code><code class="p">;</code>&#13;
<code class="c1">// ...</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Queue</code><code class="o">::</code><code class="na">failing</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">JobFailed</code> <code class="nv">$event</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="c1">// $event-&gt;connectionName</code>&#13;
            <code class="c1">// $event-&gt;job</code>&#13;
            <code class="c1">// $event-&gt;exception</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>There is also a suite of Artisan tools for interacting with the failed jobs table.</p>&#13;
&#13;
<p><code>queue:failed</code> shows you a list of your failed jobs:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:failed<code class="w"/></pre>&#13;
&#13;
<p>The list will look something like this:</p>&#13;
&#13;
<pre data-type="programlisting">+----+------------+---------+----------------------+---------------------+&#13;
| ID | Connection | Queue   | Class                | Failed At           |&#13;
+----+------------+---------+----------------------+---------------------+&#13;
| 9  | database   | default | App\Jobs\AlwaysFails | 2018-08-26 03:42:55 |&#13;
+----+------------+---------+----------------------+---------------------+</pre>&#13;
&#13;
<p>From there, you can grab the ID of any individual failed job and retry it with <code>queue:retry</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:retry<code class="w"> </code><code class="m">9</code><code class="w"/></pre>&#13;
&#13;
<p>If you’d rather retry all of the jobs, pass <code>all</code> instead of an ID:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:retry<code class="w"> </code>all<code class="w"/></pre>&#13;
&#13;
<p>You can delete an individual failed job with <code>queue:forget</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:forget<code class="w"> </code><code class="m">5</code><code class="w"/></pre>&#13;
&#13;
<p>You<a data-primary="--hours flag" data-type="indexterm" id="id1889"/> can delete all of your failed jobs over a certain age (by default, it’s 24 hours, but you can also pass a custom number of hours using <code>--hours=48</code>):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>queue:prune-failed<code class="w"/></pre>&#13;
&#13;
<p>And you can delete all of your failed jobs<a data-primary="" data-startref="JQerror16" data-type="indexterm" id="id1890"/><a data-primary="" data-startref="QQerror16" data-type="indexterm" id="id1891"/><a data-primary="" data-startref="EXjobqueue16" data-type="indexterm" id="id1892"/> with <code>queue:flush</code>:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan queue:flush</pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controlling the Queue" data-type="sect2"><div class="sect2" id="id536">&#13;
<h2>Controlling the Queue</h2>&#13;
&#13;
<p>Sometimes, from within<a data-primary="queues and queueing" data-secondary="controlling the queue" data-type="indexterm" id="id1893"/> the handling of a job, you’ll want to add conditions that will potentially either release the job to be restarted later or delete the job forever.</p>&#13;
&#13;
<p>To release a job back onto the queue, use the <code>release()</code> method, as in <a data-type="xref" href="#releasing_back_onto_queue">Example 16-10</a>.</p>&#13;
<div data-type="example" id="releasing_back_onto_queue">&#13;
<h5><span class="label">Example 16-10. </span>Releasing a job back onto the queue</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">condition</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">release</code><code class="p">(</code><code class="nv">$numberOfSecondsToDelayBeforeRetrying</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If you want to delete a job during its handling, you can just <code>return</code> at any point, as seen in <a data-type="xref" href="#deleting_a_job">Example 16-11</a>; that’s the signal to the queue that the job was handled appropriately and should not be returned to the queue.</p>&#13;
<div data-type="example" id="deleting_a_job">&#13;
<h5><span class="label">Example 16-11. </span>Deleting a job</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$jobShouldBeDeleted</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues Supporting Other Functions" data-type="sect2"><div class="sect2" id="id537">&#13;
<h2>Queues Supporting Other Functions</h2>&#13;
&#13;
<p>The<a data-primary="queues and queueing" data-secondary="functions supported" data-type="indexterm" id="id1894"/> primary use for queues is to push jobs onto them, but you can also queue mail using the <code>Mail::queue</code> functionality. You can learn more about this in <a data-type="xref" href="ch15.html#queued_mail">“Queues”</a>. You can also queue Artisan commands, which we covered in <a data-type="xref" href="ch08.html#artisan_and_tinker">Chapter 8</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Laravel Horizon" data-type="sect1"><div class="sect1" id="horizon">&#13;
<h1>Laravel Horizon</h1>&#13;
&#13;
<p>Laravel Horizon, like<a data-primary="queues and queueing" data-secondary="insights into via Laravel Horizon" data-type="indexterm" id="id1895"/><a data-primary="Laravel Horizon" data-type="indexterm" id="id1896"/><a data-primary="Horizon" data-type="indexterm" id="id1897"/> some of the other tools we’ve covered (Scout, Passport, etc.), is a tool provided by Laravel that doesn’t come bundled with the core.</p>&#13;
&#13;
<p>Horizon provides insight into the status of your Redis queued jobs. You can see which jobs have failed, how many are queued, and how fast they’re working, and you can even get notifications when any of your queues are overloaded or failing. The Horizon dashboard is shown in <a data-type="xref" href="#horizon-dashboard">Figure 16-1</a>.</p>&#13;
&#13;
<p>Installing and running Horizon is relatively straightforward, and the documentation is thorough, so if you’re interested, take a look at the <a href="https://oreil.ly/6tpkn">Horizon docs</a> to learn how to install, configure, and deploy it.</p>&#13;
&#13;
<p>Please note that you will need to have your queue connection set to <code>redis</code>, in your <em>.env</em> or the <em>config/queue.php</em> config file, in order to run Horizon.</p>&#13;
&#13;
<figure><div class="figure" id="horizon-dashboard">&#13;
<img alt="A screenshot of the Horizon dashboard" src="assets/lur3_1601.png"/>&#13;
<h6><span class="label">Figure 16-1. </span>The Horizon dashboard</h6>&#13;
</div></figure>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Events" data-type="sect1"><div class="sect1" id="id322">&#13;
<h1>Events</h1>&#13;
&#13;
<p>With jobs, the<a data-primary="calling code" data-type="indexterm" id="id1898"/><a data-primary="events" data-secondary="overview of" data-type="indexterm" id="id1899"/><a data-primary="jobs" data-secondary="events" data-tertiary="overview of" data-type="indexterm" id="id1900"/> calling code informs the application that it should <em>do something</em>: <code>CrunchReports</code> or <code>NotifyAdminOfNewSignup</code>.</p>&#13;
&#13;
<p>With an event, the calling code instead informs the application that <em>something happened</em>: <code>UserSubscribed</code>, <code>UserSignedUp</code>, or <code>ContactWasAdded</code>. <em>Events</em> are notifications that something has taken place.</p>&#13;
&#13;
<p>Some of these events may be “fired” by the framework itself. For example, Eloquent models fire events when they are saved, created, or deleted. But some events can also be manually triggered by the application’s code.</p>&#13;
&#13;
<p>An event being fired doesn’t do anything on its own. However, you<a data-primary="events" data-secondary="event listeners" data-type="indexterm" id="id1901"/> can bind <em>event listeners</em>, whose sole purpose is to listen for the broadcasting of specific events and to act in response. Any event can have anywhere from zero to many event listeners.</p>&#13;
&#13;
<p>Laravel’s events are structured like the observer, or “pub/sub,” pattern. Many events are fired out into the application; some may never be listened for, and others may have a dozen listeners. The events don’t know or care.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Firing an Event" data-type="sect2"><div class="sect2" id="id538">&#13;
<h2>Firing an Event</h2>&#13;
&#13;
<p>There<a data-primary="events" data-secondary="firing events" data-type="indexterm" id="id1902"/><a data-primary="jobs" data-secondary="events" data-tertiary="firing events" data-type="indexterm" id="id1903"/> are three ways to fire an event. You can use the <code>Event</code> facade, inject the <span class="keep-together"><code>Dispatcher</code></span>, or use the <code>event()</code> global helper, as illustrated in <a data-type="xref" href="#fire-an-event">Example 16-12</a>.</p>&#13;
<div data-type="example" id="fire-an-event">&#13;
<h5><span class="label">Example 16-12. </span>Three ways to fire an event</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Event</code><code class="o">::</code><code class="na">fire</code><code class="p">(</code><code class="k">new</code> <code class="nx">UserSubscribed</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">));</code>&#13;
<code class="c1">// or</code>&#13;
<code class="nv">$dispatcher</code> <code class="o">=</code> <code class="nx">app</code><code class="p">(</code><code class="nx">Illuminate\Contracts\Events\Dispatcher</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="nv">$dispatcher</code><code class="o">-&gt;</code><code class="na">fire</code><code class="p">(</code><code class="k">new</code> <code class="nx">UserSubscribed</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">));</code>&#13;
<code class="c1">// or</code>&#13;
<code class="nx">event</code><code class="p">(</code><code class="k">new</code> <code class="nx">UserSubscribed</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">));</code></pre></div>&#13;
&#13;
<p>If in doubt, I’d recommend using the global helper function.</p>&#13;
&#13;
<p>To create an event to fire, use the <code>make:event</code> Artisan command:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">event</code> <code class="nx">UserSubscribed</code></pre>&#13;
&#13;
<p>That’ll make a file that looks something like <a data-type="xref" href="#EX1503">Example 16-13</a>.</p>&#13;
<div data-type="example" id="EX1503">&#13;
<h5><span class="label">Example 16-13. </span>The default template for a Laravel event</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Events</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Broadcasting\Channel</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Broadcasting\InteractsWithSockets</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Broadcasting\PresenceChannel</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Broadcasting\PrivateChannel</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Broadcasting\ShouldBroadcast</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Foundation\Events\Dispatchable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\SerializesModels</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">UserSubscribed</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Dispatchable</code><code class="p">,</code> <code class="nx">InteractsWithSockets</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Create a new event instance.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the channels the event should broadcast on.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;int, \Illuminate\Broadcasting\Channel&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">broadcastOn</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="k">new</code> <code class="nx">PrivateChannel</code><code class="p">(</code><code class="s1">'channel-name'</code><code class="p">),</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Let’s take a look at what we get here. <code>SerializesModels</code> works just like with jobs; it allows you to accept Eloquent models as parameters. <code>InteractsWithSockets</code>, <code>ShouldBroadcast</code>, and the <code>broadcastOn()</code> method provide the backing functionality for broadcasting events using WebSockets, which we’ll cover in a bit.</p>&#13;
&#13;
<p>It might seem strange that there’s no <code>handle()</code> or <code>fire()</code> method here. But remember, this object exists not to determine a particular action, but just to encapsulate some data. The first piece of data is its name; <code>UserSubscribed</code> tells us that a particular event happened (a user subscribed). The rest of the data is any data we pass into the constructor and associate with this entity.</p>&#13;
&#13;
<p><a data-type="xref" href="#injecting_data_into_event">Example 16-14</a> shows what we might want to do with our <code>UserSubscribed</code> event.</p>&#13;
<div data-type="example" id="injecting_data_into_event">&#13;
<h5><span class="label">Example 16-14. </span>Injecting data into an event</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">UserSubscribed</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">InteractsWithSockets</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="nv">$user</code><code class="p">;</code>&#13;
    <code class="k">public</code> <code class="nv">$plan</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code> <code class="o">=</code> <code class="nv">$user</code><code class="p">;</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">plan</code> <code class="o">=</code> <code class="nv">$plan</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now we have an object that appropriately represents the event that happened: <code>$event-&gt;user</code> subscribed to the <code>$event-&gt;plan</code> plan. Remember, firing this event is as simple as <code>event(new UserSubscribed($user, $plan))</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Listening for an Event" data-type="sect2"><div class="sect2" id="id323">&#13;
<h2>Listening for an Event</h2>&#13;
&#13;
<p>We<a data-primary="events" data-secondary="listening for events" data-type="indexterm" id="Elisten16"/><a data-primary="jobs" data-secondary="events" data-tertiary="listening for events" data-type="indexterm" id="JElisten16"/> have an event and the ability to fire it. Now let’s look at how to listen for it.</p>&#13;
&#13;
<p>First, we’ll create an<a data-primary="events" data-secondary="event listeners" data-type="indexterm" id="id1904"/><a data-primary="--event flag" data-type="indexterm" id="id1905"/> event listener. Let’s say we want to email the app’s owner every time a new user subscribes:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">listener</code> <code class="nx">EmailOwnerAboutSubscription</code> <code class="o">--</code><code class="nx">event</code><code class="o">=</code><code class="nx">UserSubscribed</code></pre>&#13;
&#13;
<p>That gives us the file in <a data-type="xref" href="#EX1504">Example 16-15</a>.</p>&#13;
<div data-type="example" id="EX1504">&#13;
<h5><span class="label">Example 16-15. </span>The default template for a Laravel event listener</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Listeners</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\Events\UserSubscribed</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\InteractsWithQueue</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">EmailOwnerAboutSubscription</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Create the event listener.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Handle the event.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nx">UserSubscribed</code> <code class="nv">$event</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>This is where the action happens—​where the <code>handle()</code> method lives. This method expects to be passed an event of type <code>UserSubscribed</code> and act in response to it.</p>&#13;
&#13;
<p>So, let’s make it send an email (<a data-type="xref" href="#sample_event_listener">Example 16-16</a>).</p>&#13;
<div data-type="example" id="sample_event_listener">&#13;
<h5><span class="label">Example 16-16. </span>A sample event listener</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">App\Mail\UserSubscribed</code> <code class="k">as</code> <code class="nx">UserSubscribedMessage</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">EmailOwnerAboutSubscription</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nx">UserSubscribed</code> <code class="nv">$event</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Log</code><code class="o">::</code><code class="na">info</code><code class="p">(</code><code class="s1">'Emailed owner about new user: '</code> <code class="o">.</code> <code class="nv">$event</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">);</code>&#13;
&#13;
        <code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nx">config</code><code class="p">(</code><code class="s1">'app.owner-email'</code><code class="p">))</code>&#13;
            <code class="o">-&gt;</code><code class="na">send</code><code class="p">(</code><code class="k">new</code> <code class="nx">UserSubscribedMessage</code><code class="p">(</code><code class="nv">$event</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">,</code> <code class="nv">$event</code><code class="o">-&gt;</code><code class="na">plan</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now, one last task: we need to set this listener to listen to the <code>UserSubscribed</code> event. We’ll do that in the <code>$listen</code> property of the <code>EventServiceProvider</code> class (see <a data-type="xref" href="#binding_listeners_to_events">Example 16-17</a>).</p>&#13;
<div data-type="example" id="binding_listeners_to_events">&#13;
<h5><span class="label">Example 16-17. </span>Binding listeners to events in <code>EventServiceProvider</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">EventServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$listen</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="nx">\App\Events\UserSubscribed</code><code class="o">::</code><code class="na">class</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
            <code class="nx">\App\Listeners\EmailOwnerAboutSubscription</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="p">],</code>&#13;
    <code class="p">];</code></pre></div>&#13;
&#13;
<p>As you can see, the key of each array entry is the class name of the event, and <span class="keep-together">the value</span> is an array of listener class names. We can add as many class names as we want under the <code>UserSubscribed</code> key, and they will all listen and respond to each <code>UserSubscribed</code> event.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Automatic event discovery" data-type="sect3"><div class="sect3" id="id324">&#13;
<h3>Automatic event discovery</h3>&#13;
&#13;
<p>You<a data-primary="automatic event discovery" data-type="indexterm" id="id1906"/> can also instruct Laravel to automatically connect events and their matching listeners, without having to manually bind them in <code>EventServiceProvider</code>. This feature, called <em>automatic event discovery</em>, is disabled by default, but can be enabled by setting the <code>shouldDiscoverEvents()</code> method to return <code>true</code> in the <code>EventS⁠e⁠r⁠v⁠i⁠c⁠e​P⁠r⁠o⁠v⁠i⁠d⁠e⁠r</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="sd">/**</code>&#13;
<code class="sd"> * Determine if events and listeners should be automatically discovered.</code>&#13;
<code class="sd"> */</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">shouldDiscoverEvents</code><code class="p">()</code><code class="o">:</code> <code class="nx">bool</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">true</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>If this feature is enabled, Laravel will map events to their matching listeners based on the typehints in the listeners. It’ll have to match them on every request, which will introduce a small lag to your app, but like many slow features, you can cache these lookups using <code>php artisan event:cache</code> and clear the cache with <code>php artisan event:clear</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Event subscribers" data-type="sect3"><div class="sect3" id="id325">&#13;
<h3>Event subscribers</h3>&#13;
&#13;
<p>There’s<a data-primary="events" data-secondary="event subscribers" data-type="indexterm" id="id1907"/> one more structure you can use to define the relationship between your events and their listeners. Laravel has a concept called an <em>event subscriber</em>, which is a class that contains a collection of methods that act as separate listeners to unique events, and also contains the mapping of which method should handle which event. In this case it’s easier to show than to tell, so take a look at <a data-type="xref" href="#EX1501">Example 16-18</a>. Note that event subscribers are not a particularly commonly used tool.</p>&#13;
<div data-type="example" id="EX1501">&#13;
<h5><span class="label">Example 16-18. </span>A sample event subscriber</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Listeners</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">UserEventSubscriber</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">onUserSubscription</code><code class="p">(</code><code class="nv">$event</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Handles the UserSubscribed event</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">onUserCancellation</code><code class="p">(</code><code class="nv">$event</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Handles the UserCanceled event</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">subscribe</code><code class="p">(</code><code class="nv">$events</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$events</code><code class="o">-&gt;</code><code class="na">listen</code><code class="p">(</code>&#13;
            <code class="nx">\App\Events\UserSubscribed</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
            <code class="s1">'App\Listeners\UserEventSubscriber@onUserSubscription'</code>&#13;
        <code class="p">);</code>&#13;
&#13;
        <code class="nv">$events</code><code class="o">-&gt;</code><code class="na">listen</code><code class="p">(</code>&#13;
            <code class="nx">\App\Events\UserCanceled</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
            <code class="s1">'App\Listeners\UserEventSubscriber@onUserCancellation'</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Subscribers<a data-primary="subscribe() method" data-type="indexterm" id="id1908"/> need to define a <code>subscribe()</code> method, which is passed an instance of the event dispatcher. We’ll use that to pair events with their listeners, but in this case, those are methods on this class, instead of entire classes.</p>&#13;
&#13;
<p>As a refresher, any time you see an <code>@</code> inline like this, it means the class name is to the left of the <code>@</code> and the method name is to the right. So, in <a data-type="xref" href="#EX1501">Example 16-18</a>, we’re defining that the <code>onUserSubscription()</code> method of this subscriber will listen to any <code>U⁠s⁠e⁠r​S⁠u⁠b⁠s⁠c⁠r⁠i⁠b⁠e⁠d</code> events.</p>&#13;
&#13;
<p>There’s one last thing we need to do: in <code>App\Providers\EventServiceProvider</code>, we need to add our subscriber’s class name to the <code>$subscribe</code> property, as seen in <a data-type="xref" href="#registering_an_event_subscriber">Example 16-19</a>.<a data-primary="" data-startref="JElisten16" data-type="indexterm" id="id1909"/><a data-primary="" data-startref="Elisten16" data-type="indexterm" id="id1910"/></p>&#13;
<div data-type="example" id="registering_an_event_subscriber">&#13;
<h5><span class="label">Example 16-19. </span>Registering an event subscriber</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">EventServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="o">...</code>&#13;
    <code class="k">protected</code> <code class="nv">$subscribe</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="nx">\App\Listeners\UserEventSubscriber</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Broadcasting Events Over WebSockets, and Laravel Echo" data-type="sect1"><div class="sect1" id="broadcasting_events">&#13;
<h1>Broadcasting Events Over WebSockets, and Laravel Echo</h1>&#13;
&#13;
<p>WebSocket (often called WebSockets) is<a data-primary="events" data-secondary="broadcasting" data-tertiary="using WebSocket protocol" data-tertiary-sortas="WebSocket protocol" data-type="indexterm" id="id1911"/><a data-primary="WebSockets" data-secondary="broadcasting events over" data-type="indexterm" id="id1912"/> a protocol, popularized by Pusher (a hosted WebSocket SaaS), that makes it simple to provide near real-time communication between web devices. Rather than relying on information passing via HTTP requests, WebSockets libraries open a direct connection between the client and the server. WebSockets are behind tools like the chat boxes in Gmail and Facebook, where you don’t have to wait for the page to reload or for Ajax requests to receive or send data; instead, data is both sent and received in real time.</p>&#13;
&#13;
<p>WebSockets work best with small pieces of data passed in a pub/sub structure—​just like Laravel’s events. Laravel has a built-in set of tools that makes it easy to define <span class="keep-together">that one</span> or more of your events should be broadcast to a WebSocket server; it’s straightforward, for example, to have a <code>MessageWasReceived</code> event that is published to the notifications box of a certain user or set of users the instant a message arrives at your application.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1913">&#13;
<h1>Laravel Echo</h1>&#13;
<p>Laravel<a data-primary="Laravel Echo" data-type="indexterm" id="id1914"/><a data-primary="Echo" data-type="indexterm" id="id1915"/> also has a more powerful tool designed for more complex event broadcasting. If you need presence notification or want to keep your rich frontend data model in sync with your Laravel app, check out Laravel Echo, which we’ll cover in <a data-type="xref" href="#advanced_broadcasting">“Advanced Broadcasting Tools”</a>. Much of what comprises Echo is built into the Laravel core, but some of it requires pulling in the external JavaScript Echo library, which we cover in <a data-type="xref" href="#echo">“Laravel Echo (the JavaScript Side)”</a>.</p>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuration and Setup" data-type="sect2"><div class="sect2" id="id539">&#13;
<h2>Configuration and Setup</h2>&#13;
&#13;
<p>Take<a data-primary="events" data-secondary="broadcasting" data-tertiary="configuration and setup" data-type="indexterm" id="id1916"/> a look at <em>config/broadcasting.php</em> to find the configuration settings for your event broadcasting. Laravel supports three drivers for broadcasting: Pusher, a paid SaaS offering; Redis, for locally running WebSocket servers; and <code>log</code>, for local development and debugging.</p>&#13;
<div data-type="note" epub:type="note"><h1>Queue Listeners</h1>&#13;
<p>In<a data-primary="queues and queueing" data-secondary="queue listeners" data-type="indexterm" id="id1917"/> order for event broadcasting to move quickly, Laravel pushes the instruction to broadcast events onto a queue. That means you’ll need to have a queue worker running (or use the <code>sync</code> queue driver for local development). See <a data-type="xref" href="#queue_workers">“Running a Queue Worker”</a> to learn how to run a queue worker.</p>&#13;
&#13;
<p>Laravel suggests a default delay of three seconds before the queue worker looks for new jobs. However, with event broadcasting, you may notice some events take a second or two to broadcast. To speed this up, update your queue settings to wait only one second before looking for new jobs.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Broadcasting an Event" data-type="sect2"><div class="sect2" id="id327">&#13;
<h2>Broadcasting an Event</h2>&#13;
&#13;
<p>To<a data-primary="events" data-secondary="broadcasting" data-tertiary="process of" data-type="indexterm" id="EBprocess16"/> broadcast an event, you need to mark that event as a broadcast event by having it implement the <code>Illuminate\Contracts\Broadcasting\ShouldBroadcast</code> interface. This interface requires you to add the <code>broadcastOn()</code> method, which will return an array of either strings or <code>Channel</code> objects, each representing a WebSocket channel.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1918">&#13;
<h1>The Structure of WebSocket Events</h1>&#13;
<p>Every event<a data-primary="WebSockets" data-secondary="event structure" data-type="indexterm" id="id1919"/> you send with WebSockets can have three primary characteristics: the name, the channel, and the data.</p>&#13;
&#13;
<p>The <em>name</em> of an event might be something like <code>user-was-subscribed</code>, but Laravel’s default is to use the fully qualified class name of the event; that is something like <code>App\Events\UserSubscribed</code>. You can customize this by passing the name to the optional <code>broadcastAs()</code> method in your event class.</p>&#13;
&#13;
<p>The <em>channel</em> is the way of describing which clients should receive this message. It’s a very common pattern to have a channel for each user (e.g., <code>users.1</code>, <code>users.2</code>, etc.), and possibly a channel for all users (e.g., <code>users</code>), and maybe one for just users who are members of a certain account (<code>accounts.1</code>).</p>&#13;
&#13;
<p>If the channel you’re targeting is a private channel, preface the channel name with <code>private-</code>, and if it’s a presence channel, preface the channel name with <code>presence-</code>. So, a private Pusher channel named <code>groups.5</code> should isntead be named <code>private-groups.5</code>. If you use Laravel’s <code>PrivateChannel</code> and <code>PresenceChannel</code> objects in your <span class="keep-together"><code>broadcastOn()</code></span> method, they’ll take care of adding those prefaces to your channel names for you.</p>&#13;
&#13;
<p>If you’re not familiar with public, private, and presence channels, see the note in <a data-type="xref" href="#broadcast-service-provider">“The broadcast service provider”</a>.</p>&#13;
&#13;
<p>The <em>data</em> is a payload, usually JSON, of information relevant to the event—​the message, maybe, or information about the user or plan that can be acted upon by the consuming JavaScript.</p>&#13;
</div></aside>&#13;
&#13;
<p><a data-type="xref" href="#broadcasting_on_multiple_channels">Example 16-20</a> shows our <code>UserSubscribed</code> event, modified to broadcast on two channels: one for the user (to confirm the user’s subscription) and one for admins (to notify them of a new subscription).</p>&#13;
<div data-type="example" id="broadcasting_on_multiple_channels">&#13;
<h5><span class="label">Example 16-20. </span>An event broadcasting on multiple channels</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Broadcasting\ShouldBroadcast</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">UserSubscribed</code> <code class="k">implements</code> <code class="nx">ShouldBroadcast</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Dispatchable</code><code class="p">,</code> <code class="nx">InteractsWithSockets</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="nv">$user</code><code class="p">;</code>&#13;
    <code class="k">public</code> <code class="nv">$plan</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code> <code class="o">=</code> <code class="nv">$user</code><code class="p">;</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">plan</code> <code class="o">=</code> <code class="nv">$plan</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">broadcastOn</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// String syntax</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'users.'</code> <code class="o">.</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code>&#13;
            <code class="s1">'admins'</code>&#13;
        <code class="p">];</code>&#13;
&#13;
        <code class="c1">// Channel object syntax</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="k">new</code> <code class="nx">Channel</code><code class="p">(</code><code class="s1">'users.'</code> <code class="o">.</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">),</code>&#13;
            <code class="k">new</code> <code class="nx">Channel</code><code class="p">(</code><code class="s1">'admins'</code><code class="p">),</code>&#13;
            <code class="c1">// If it were a private channel: new PrivateChannel('admins'),</code>&#13;
            <code class="c1">// If it were a presence channel: new PresenceChannel('admins'),</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>By default, any public properties of your event will be serialized as JSON and sent along as the data of your broadcast event. That means the data of one of our broadcast <code>UserSubscribed</code> events might look like <a data-type="xref" href="#sample_broadcast_event_data">Example 16-21</a>.</p>&#13;
<div data-type="example" id="sample_broadcast_event_data">&#13;
<h5><span class="label">Example 16-21. </span>Sample broadcast event data</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="p">{</code>&#13;
    <code class="s1">'user'</code><code class="o">:</code> <code class="p">{</code>&#13;
        <code class="s1">'id'</code><code class="o">:</code> <code class="mi">5</code><code class="p">,</code>&#13;
        <code class="s1">'name'</code><code class="o">:</code> <code class="s1">'Fred McFeely'</code><code class="p">,</code>&#13;
        <code class="p">...</code>&#13;
    <code class="p">},</code>&#13;
    <code class="s1">'plan'</code><code class="o">:</code> <code class="s1">'silver'</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can override this by returning an array of data from the <code>broadcastWith()</code> method on your event, as in <a data-type="xref" href="#customizing_broadcast_event_data">Example 16-22</a>.</p>&#13;
<div data-type="example" id="customizing_broadcast_event_data">&#13;
<h5><span class="label">Example 16-22. </span>Customizing the broadcast event data</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">broadcastWith</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'userId'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code>&#13;
        <code class="s1">'plan'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">plan</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can customize which<a data-primary="queues and queueing" data-secondary="customizing event queues" data-type="indexterm" id="id1920"/> queue your event is pushed onto by setting the <code>$broadcastQueue</code> property on the event class:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="nv">$broadcastQueue</code> <code class="o">=</code> <code class="s1">'websockets-for-faster-processing'</code><code class="p">;</code></pre>&#13;
&#13;
<p>You may choose to do this so you can keep other queue items from slowing down your event broadcast; real-time WebSockets aren’t much fun if a long-running job that’s higher in the queue keeps the events from going out <span class="keep-together">in time.</span></p>&#13;
&#13;
<p>You can also force a given event to skip the queue entirely (using the “sync” queue driver, which is processed by the current PHP thread), by having it implement the <code>ShouldBroadcastNow</code> contract (<a data-type="xref" href="#skip-the-broadcast-queue">Example 16-23</a>).</p>&#13;
<div class="pagebreak-before less_space" data-type="example" id="skip-the-broadcast-queue">&#13;
<h5><span class="label">Example 16-23. </span>Forcing an event to skip the broadcast queue</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Contracts\Broadcasting\ShouldBroadcastNow</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">UserSubscribed</code> <code class="k">implements</code> <code class="nx">ShouldBroadcastNow</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">//</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>And, finally, you<a data-primary="broadcastWhen() method" data-type="indexterm" id="id1921"/> can choose to customize whether a given event should be broadcast at all by giving it a <code>broadcastWhen()</code> methods<a data-primary="" data-startref="EBprocess16" data-type="indexterm" id="id1922"/> as in <a data-type="xref" href="#determining-when-to-broadcast">Example 16-24</a>:</p>&#13;
<div data-type="example" id="determining-when-to-broadcast">&#13;
<h5><span class="label">Example 16-24. </span>Conditionally determining whether an event should be broadcast</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">broadcastWhen</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Notify me only when users sign up from the White House</code>&#13;
    <code class="k">return</code> <code class="nx">Str</code><code class="o">::</code><code class="na">contains</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">,</code> <code class="s1">'whitehouse.gov'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Receiving the Message" data-type="sect2"><div class="sect2" id="websockets_servers">&#13;
<h2>Receiving the Message</h2>&#13;
&#13;
<p>As<a data-primary="events" data-secondary="broadcasting" data-tertiary="receiving messages" data-type="indexterm" id="id1923"/><a data-primary="messages" data-secondary="receiving broadcast messages" data-type="indexterm" id="id1924"/><a data-primary="Pusher" data-type="indexterm" id="id1925"/> of this book’s publication, the most common solution Laravel developers use is <a href="https://pusher.com">Pusher</a>. Plans over a certain size cost money, but there’s a generous free plan. Pusher makes it incredibly easy to set up a simple WebSocket server, and its JavaScript SDK handles all <span class="keep-together">of the authentication</span> and channel management with almost no work on your part. SDKs are available for iOS, Android, and many more platforms, languages, and frameworks.</p>&#13;
&#13;
<p>If<a data-primary="WebSockets" data-secondary="receiving broadcast messages" data-type="indexterm" id="id1926"/> you’d like to host your own Pusher-compatible WebSockets server, there are two great options. First, you can try a Laravel-based tool called <a href="https://oreil.ly/p8fyJ">Laravel WebSockets</a>. You can install the package into your current Laravel app (the same app you’re broadcasting from) or into a separate microservice.</p>&#13;
&#13;
<p>Second, if you’re using<a data-primary="Soketi" data-type="indexterm" id="id1927"/> Docker (including Sail) you can install <a href="https://soketi.app">Soketi</a>, a free Pusher replacement developed in TypeScript.</p>&#13;
&#13;
<p>If you choose to work with a server other than Pusher, you’ll follow all of the directions in this book as if you were working with Pusher, but your configuration settings will be a bit different.</p>&#13;
&#13;
<p>It’s helpful to understand how to listen to Laravel’s broadcast events without Echo even if you choose to use Echo in the end. But because much of the code here is not necessary if you use Echo, I’d recommend reading this section, and then reading <a data-type="xref" href="#echo">“Laravel Echo (the JavaScript Side)”</a> before you start implementing any of it; <span class="keep-together">you can</span> decide which way you prefer and then write your code from there.</p>&#13;
&#13;
<p>To get started, pull in Pusher’s library, get an API key from your Pusher account, and subscribe to any events on any channels with code like that in <a data-type="xref" href="#basic_usage_of_pusher_JS">Example 16-25</a>.</p>&#13;
<div data-type="example" id="basic_usage_of_pusher_JS">&#13;
<h5><span class="label">Example 16-25. </span>Basic usage of Pusher</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">...&#13;
<code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"https://js.pusher.com/4.3/pusher.min.js"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">script</code><code class="p">&gt;</code><code class="w"/>&#13;
<code class="c1">// Enable Pusher logging - don't include this in production</code><code class="w"/>&#13;
<code class="nx">Pusher</code><code class="p">.</code><code class="nx">logToConsole</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="kc">true</code><code class="p">;</code><code class="w"/>&#13;
&#13;
<code class="c1">// Globally, perhaps; just a sample of how to get data in</code><code class="w"/>&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">App</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="s1">'userId'</code><code class="o">:</code><code class="w"> </code><code class="p">{{</code><code class="w"> </code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="nx">id</code><code class="p">()</code><code class="w"> </code><code class="p">}},</code><code class="w"/>&#13;
<code class="w">    </code><code class="s1">'pusherKey'</code><code class="o">:</code><code class="w"> </code><code class="s1">'{{ config('</code><code class="nx">broadcasting</code><code class="p">.</code><code class="nx">connections</code><code class="p">.</code><code class="nx">pusher</code><code class="p">.</code><code class="nx">key</code><code class="s1">') }}'</code><code class="w"/>&#13;
<code class="p">};</code><code class="w"/>&#13;
&#13;
<code class="c1">// Locally</code><code class="w"/>&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">pusher</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="ow">new</code><code class="w"> </code><code class="nx">Pusher</code><code class="p">(</code><code class="nx">App</code><code class="p">.</code><code class="nx">pusherKey</code><code class="p">,</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">cluster</code><code class="o">:</code><code class="w"> </code><code class="s1">'{{ config('</code><code class="nx">broadcasting</code><code class="p">.</code><code class="nx">connections</code><code class="p">.</code><code class="nx">pusher</code><code class="p">.</code><code class="nx">options</code><code class="p">.</code><code class="nx">cluster</code><code class="s1">') }}'</code><code class="p">,</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">encrypted</code><code class="o">:</code><code class="w"> </code><code class="p">{{</code><code class="w"> </code><code class="nx">config</code><code class="p">(</code><code class="s1">'broadcasting.connections.pusher.options.encrypted'</code><code class="p">)</code><code class="w"> </code><code class="p">}}</code><code class="w"/>&#13;
<code class="p">});</code><code class="w"/>&#13;
&#13;
<code class="kd">var</code><code class="w"> </code><code class="nx">pusherChannel</code><code class="w"> </code><code class="o">=</code><code class="w"> </code><code class="nx">pusher</code><code class="p">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'users.'</code><code class="w"> </code><code class="o">+</code><code class="w"> </code><code class="nx">App</code><code class="p">.</code><code class="nx">userId</code><code class="p">);</code><code class="w"/>&#13;
&#13;
<code class="nx">pusherChannel</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="s1">'App\\Events\\UserSubscribed'</code><code class="p">,</code><code class="w"> </code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code class="w"> </code><code class="p">=&gt;</code><code class="w"> </code><code class="p">{</code><code class="w"/>&#13;
<code class="w">    </code><code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">user</code><code class="p">,</code><code class="w"> </code><code class="nx">data</code><code class="p">.</code><code class="nx">plan</code><code class="p">);</code><code class="w"/>&#13;
<code class="p">});</code><code class="w"/>&#13;
<code class="p">&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h1>Escaping Backslashes in JavaScript</h1>&#13;
<p>Since<a data-primary="backslashes, escaping" data-type="indexterm" id="id1928"/><a data-primary="\ (backslash)" data-type="indexterm" id="id1929"/><a data-primary="escape characters" data-type="indexterm" id="id1930"/> <code>\</code> is a control character in JavaScript, you need to write <code>\\</code> to represent a backslash in your strings, which is why there are two backslashes between each namespace segment in <a data-type="xref" href="#basic_usage_of_pusher_JS">Example 16-25</a>.</p>&#13;
</div>&#13;
&#13;
<p>To publish to Pusher from Laravel, get your Pusher key, secret, cluster, and app ID from your Pusher account dashboard, and then set them in your <em>.env</em> file under the keys <code>PUSHER_KEY</code>, <code>PUSHER_SECRET</code>, <code>PUSHER_APP_CLUSTER</code>, and <code>PUSHER_APP_ID</code>, &#13;
<span class="keep-together">respectively</span>.</p>&#13;
&#13;
<p>If you serve your app, visit a page with the JavaScript from <a data-type="xref" href="#basic_usage_of_pusher_JS">Example 16-25</a> embedded in it in one window, push a broadcast event in another window or from your terminal, have a queue listener running or are using the <code>sync</code> driver, and all of your authentication information is set up correctly, you should see event logs popping up in your JavaScript window’s console in near real time.</p>&#13;
&#13;
<p>With this power, it’s now easy for you to keep your users up to date with what’s happening with their data any time they’re in your app. You can notify users of the actions of other users, of long-running processes that have just finished, or of your application’s responses to external actions like incoming emails or webhooks. The possibilities are endless.</p>&#13;
<div data-type="note" epub:type="note"><h1>Requirements</h1>&#13;
<p>If you want to broadcast with Pusher or Redis, you’ll need to bring in these dependencies:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p>Pusher: <code>pusher/pusher-php-server "~3.0"</code></p>&#13;
</li>&#13;
<li>&#13;
<p>Redis: <code>predis/predis</code></p>&#13;
</li>&#13;
</ul>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Advanced Broadcasting Tools" data-type="sect2"><div class="sect2" id="advanced_broadcasting">&#13;
<h2>Advanced Broadcasting Tools</h2>&#13;
&#13;
<p>Laravel<a data-primary="events" data-secondary="broadcasting" data-tertiary="advanced broadcasting tools" data-type="indexterm" id="EBadvanc16"/> has a few more tools to make it possible to perform more complex interactions in event broadcasting. These tools, a combination of framework features and a JavaScript library, are called <em>Laravel Echo</em>.</p>&#13;
&#13;
<p>These framework features work best when you use<a data-primary="Laravel Echo" data-type="indexterm" id="id1931"/><a data-primary="Echo" data-type="indexterm" id="id1932"/> Laravel Echo in your JavaScript frontend (which we’ll cover in <a data-type="xref" href="#echo">“Laravel Echo (the JavaScript Side)”</a>), but you can still enjoy some of the benefits of Echo without using the JavaScript components. Echo will work with both Pusher and Redis, but I’m going to use Pusher for any examples.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Excluding the current user from broadcast events" data-type="sect3"><div class="sect3" id="id330">&#13;
<h3>Excluding the current user from broadcast events</h3>&#13;
&#13;
<p>Every<a data-primary="users, excluding current from broadcast events" data-type="indexterm" id="id1933"/> connection to Pusher is assigned a unique “socket ID” identifying that socket connection. And it’s easy to define that any given socket (user) should be excluded from receiving a specified broadcast event.</p>&#13;
&#13;
<p>This feature makes it possible to define that certain events should not be broadcast to the user who fired them. Let’s say every user in a team gets notified when other users create a task; would you want to be notified of a task you just created? No, and that’s why we have the <code>toOthers()</code> method.</p>&#13;
&#13;
<p>To implement this, there are two steps to follow. First, you need to set up your JavaScript to send a certain <code>POST</code> to <code>/broadcasting/socket</code> when your WebSocket connection is initialized. This attaches your <code>socket_id</code> to your Laravel session. Echo does this for you, but you can also do it manually—take a look at the <a href="https://oreil.ly/3Ww0U">Echo source</a> to see how it works.</p>&#13;
&#13;
<p>Next, you’ll want to update every request that your JavaScript makes to have an <code>X-Socket-ID</code> header that contains that <code>socket_id</code>. <a data-type="xref" href="#sending_the_socket_id">Example 16-26</a> shows how to do that with Axios or in jQuery. Note that your event must use the <code>Illuminate\Broadcasting\InteractsWithSockets</code> trait in order to call the <code>toOthers()</code> method.</p>&#13;
<div data-type="example" id="sending_the_socket_id">&#13;
<h5><span class="label">Example 16-26. </span>Sending the socket ID along with each Ajax request with Axios or in jQuery</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Run this right after you initialize Echo</code>&#13;
<code class="c1">// With Axios</code>&#13;
<code class="nx">window</code><code class="o">.</code><code class="nx">axios</code><code class="o">.</code><code class="nx">defaults</code><code class="o">.</code><code class="nx">headers</code><code class="o">.</code><code class="nx">common</code><code class="p">[</code><code class="s1">'X-Socket-Id'</code><code class="p">]</code> <code class="o">=</code> <code class="k">Echo</code><code class="o">.</code><code class="nx">socketId</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// With jQuery</code>&#13;
<code class="err">$</code><code class="o">.</code><code class="nx">ajaxSetup</code><code class="p">({</code>&#13;
    <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>&#13;
        <code class="s1">'X-Socket-Id'</code><code class="o">:</code> <code class="k">Echo</code><code class="o">.</code><code class="nx">socketId</code><code class="p">()</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Once you’ve handled this, you can exclude any event from being broadcast to the user who triggered it by using the<a data-primary="helpers" data-secondary="broadcast() global helper" data-type="indexterm" id="id1934"/><a data-primary="broadcast() global helper" data-type="indexterm" id="id1935"/> <code>broadcast()</code> global helper, instead of the <code>event()</code> global helper, and then chaining <code>toOthers()</code> after it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">broadcast</code><code class="p">(</code><code class="k">new</code> <code class="nx">UserSubscribed</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$plan</code><code class="p">))</code><code class="o">-&gt;</code><code class="na">toOthers</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The broadcast service provider" data-type="sect3"><div class="sect3" id="broadcast-service-provider">&#13;
<h3>The broadcast service provider</h3>&#13;
&#13;
<p>All<a data-primary="service providers" data-type="indexterm" id="id1936"/> of the other features that Echo provides require your JavaScript to authenticate with the server. Take a look at <code>App\Providers\BroadcastServiceProvider</code>, where you’ll define how to authorize users’ access to your private and presence channels.</p>&#13;
&#13;
<p>The two primary actions you can take are to define the middleware that will be used on your broadcasting auth routes, and to define the authorization settings for <span class="keep-together">your channels.</span></p>&#13;
&#13;
<p>If you’re going to use these features, you’ll need to uncomment the <code>App\Providers\BroadcastServiceProvider::class</code> line in <em>config/app.php</em>.</p>&#13;
&#13;
<p>And if you’ll be using these features <em>without</em> Laravel Echo, you’ll either need to manually handle sending CSRF tokens along with your authentication requests, or exclude <code>/broadcasting/auth</code> and <code>/broadcasting/socket</code> from CSRF protection by adding them to the <code>$except</code> property of the <code>VerifyCsrfToken</code> middleware.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Binding authorization definitions for WebSocket channels" data-type="sect4"><div class="sect4" id="id332">&#13;
<h4>Binding authorization definitions for WebSocket channels</h4>&#13;
&#13;
<p>Private<a data-primary="authentication and authorization" data-secondary="WebSocket channels and" data-type="indexterm" id="id1937"/> and presence WebSocket channels need to be able to ping your application to learn whether the current user is authorized for that channel. You’ll use the <code>Broadcast::channel()</code> method to define the rules for this authorization in your <em>routes/channels.php</em> file.</p>&#13;
<div data-type="note" epub:type="note" id="public_private_presence_channels"><h1>Public, Private, and Presence Channels</h1>&#13;
<p>There are three types of<a data-primary="channels, in WebSocket" data-type="indexterm" id="id1938"/> channels in WebSockets: public, private, and presence:</p>&#13;
<dl>&#13;
<dt>Public channels</dt>&#13;
<dd>&#13;
<p>Can be subscribed to by any user, authenticated <span class="keep-together">or not.</span></p>&#13;
</dd>&#13;
<dt>Private channels</dt>&#13;
<dd>&#13;
<p>Require the end user’s JavaScript to authenticate against the application to prove that the user is both authenticated and authorized to join this channel.</p>&#13;
</dd>&#13;
<dt>Presence channels</dt>&#13;
<dd>&#13;
<p>A type of private channel, but instead of allowing for message passing, they simply keep track of which users join and leave the channel, and make this information available to the application’s frontend.</p>&#13;
</dd>&#13;
</dl>&#13;
</div>&#13;
&#13;
<p><code>Broadcast::channel()</code> takes two parameters: first, a string representing the channel(s) you want it to match, and second, a closure that defines how to authorize users for any channel matching that string. The closure will be passed an Eloquent model of the current user as its first parameter, and any matched <em><code>variableNameHere</code></em> segments as additional parameters. For example, a channel authorization definition with a string of <code>teams.<em>teamId</em></code>, when matched against the channel <code>teams.5</code>, will pass its closure <code>$user</code> as the first parameter and <code>5</code> as the second parameter.</p>&#13;
&#13;
<p>If you’re defining the rules for a private channel, your <code>Broadcast::channel()</code> closure will need to return a Boolean: is this user authorized for this channel or not? If you’re defining the rules for a presence channel, your closure should return an array of data you want available to the presence channel for any users that you want to show up in the channel. <a data-type="xref" href="#defining_authorization_rules">Example 16-27</a> illustrates defining rules for both kinds of channel.</p>&#13;
<div data-type="example" id="defining_authorization_rules">&#13;
<h5><span class="label">Example 16-27. </span>Defining authorization rules for private and presence WebSocket channels</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="c1">// routes/channels.php</code>&#13;
&#13;
<code class="c1">// Define how to authenticate a private channel</code>&#13;
<code class="nx">Broadcast</code><code class="o">::</code><code class="na">channel</code><code class="p">(</code><code class="s1">'teams.{teamId}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$teamId</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">(</code><code class="nx">int</code><code class="p">)</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">team_id</code> <code class="o">===</code> <code class="p">(</code><code class="nx">int</code><code class="p">)</code> <code class="nv">$teamId</code><code class="p">;</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Define how to authenticate a presence channel; return any data</code>&#13;
<code class="c1">// you want the app to have about the user in the channel</code>&#13;
<code class="nx">Broadcast</code><code class="o">::</code><code class="na">channel</code><code class="p">(</code><code class="s1">'rooms.{roomId}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$roomId</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">rooms</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="nv">$roomId</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">name</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You might be wondering how this information gets from your Laravel application to your JavaScript frontend. Pusher’s JavaScript library sends a <code>POST</code> to your application; by default it will hit <code>/pusher/auth</code>, but you can customize that (and Echo customizes it for you) to hit Laravel’s authentication route, <code>/broadcasting/auth</code>:</p>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">pusher</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Pusher</code><code class="p">(</code><code class="nx">App</code><code class="p">.</code><code class="nx">pusherKey</code><code class="p">,</code> <code class="p">{</code>&#13;
    <code class="nx">authEndpoint</code><code class="o">:</code> <code class="s1">'/broadcasting/auth'</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p><a data-type="xref" href="#pusher_JS_for_private_and_presence_channels">Example 16-28</a> shows how we can tweak <a data-type="xref" href="#basic_usage_of_pusher_JS">Example 16-25</a> for private and presence channels, <em>without</em> Echo’s frontend components.</p>&#13;
<div data-type="example" id="pusher_JS_for_private_and_presence_channels">&#13;
<h5><span class="label">Example 16-28. </span>Basic use of Pusher for private and presence channels</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="o">&lt;</code><code class="nx">script</code> <code class="nx">src</code><code class="o">=</code><code class="s2">"https://js.pusher.com/4.3/pusher.min.js"</code><code class="o">&gt;&lt;/</code><code class="nx">script</code><code class="o">&gt;</code>&#13;
<code class="o">&lt;</code><code class="nx">script</code><code class="o">&gt;</code>&#13;
    <code class="c1">// Enable Pusher logging - don't include this in production</code>&#13;
    <code class="nx">Pusher</code><code class="o">.</code><code class="nx">logToConsole</code> <code class="o">=</code> <code class="k">true</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// Globally, perhaps; just a sample of how to get data in</code>&#13;
    <code class="k">var</code> <code class="nx">App</code> <code class="o">=</code> <code class="p">{</code>&#13;
        <code class="s1">'userId'</code><code class="o">:</code> <code class="p">{{</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">()</code> <code class="p">}},</code>&#13;
        <code class="s1">'pusherKey'</code><code class="o">:</code> <code class="s1">'{{ config('</code><code class="nx">broadcasting</code><code class="o">.</code><code class="nx">connections</code><code class="o">.</code><code class="nx">pusher</code><code class="o">.</code><code class="nb">key</code><code class="s1">') }}'</code>&#13;
    <code class="p">};</code>&#13;
&#13;
    <code class="c1">// Locally</code>&#13;
    <code class="k">var</code> <code class="nx">pusher</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Pusher</code><code class="p">(</code><code class="nx">App</code><code class="o">.</code><code class="nx">pusherKey</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">cluster</code><code class="o">:</code> <code class="s1">'{{ config('</code><code class="nx">broadcasting</code><code class="o">.</code><code class="nx">connections</code><code class="o">.</code><code class="nx">pusher</code><code class="o">.</code><code class="nx">options</code><code class="o">.</code><code class="nx">cluster</code><code class="s1">') }}'</code><code class="p">,</code>&#13;
        <code class="nx">encrypted</code><code class="o">:</code> <code class="p">{{</code> <code class="nx">config</code><code class="p">(</code><code class="s1">'broadcasting.connections.pusher.options.encrypted'</code><code class="p">)</code> <code class="p">}},</code>&#13;
        <code class="nx">authEndpoint</code><code class="o">:</code> <code class="s1">'/broadcasting/auth'</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Private channel</code>&#13;
    <code class="k">var</code> <code class="nx">privateChannel</code> <code class="o">=</code> <code class="nx">pusher</code><code class="o">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'private-teams.1'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">privateChannel</code><code class="o">.</code><code class="nx">bind</code><code class="p">(</code><code class="s1">'App\\Events\\UserSubscribed'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="o">.</code><code class="nb">log</code><code class="p">(</code><code class="nx">data</code><code class="o">.</code><code class="nx">user</code><code class="p">,</code> <code class="nx">data</code><code class="o">.</code><code class="nx">plan</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Presence channel</code>&#13;
    <code class="k">var</code> <code class="nx">presenceChannel</code> <code class="o">=</code> <code class="nx">pusher</code><code class="o">.</code><code class="nx">subscribe</code><code class="p">(</code><code class="s1">'presence-rooms.5'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">console</code><code class="o">.</code><code class="nb">log</code><code class="p">(</code><code class="nx">presenceChannel</code><code class="o">.</code><code class="nx">members</code><code class="p">);</code>&#13;
<code class="o">&lt;/</code><code class="nx">script</code><code class="o">&gt;</code></pre></div>&#13;
&#13;
<p>We now have the ability to send WebSocket messages to users depending on whether they pass a given channel’s authorization rules. We can also keep track of which users are active in a particular group or section of the site and display relevant information to each user about other users in the same group.<a data-primary="" data-startref="EBadvanc16" data-type="indexterm" id="id1939"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Laravel Echo (the JavaScript Side)" data-type="sect2"><div class="sect2" id="echo">&#13;
<h2>Laravel Echo (the JavaScript Side)</h2>&#13;
&#13;
<p>Laravel Echo<a data-primary="Echo" data-type="indexterm" id="echo16"/><a data-primary="Laravel Echo" data-type="indexterm" id="LEcho16"/><a data-primary="events" data-secondary="broadcasting" data-tertiary="Laravel Echo" data-type="indexterm" id="EBlaravelE16"/> compromises two pieces: the advanced framework features we just covered and a JavaScript package that takes advantage of those features and drastically reduces the amount of boilerplate code you need to write powerful WebSocket-based frontends. The Echo JavaScript package makes it easy to handle authentication, authorization, and subscribing to private and presence channels. Echo can be used with the SDKs for either Pusher (for Pusher or a custom Pusher-compatible server) or <code>socket.io</code> (for Redis).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bringing Echo into your project" data-type="sect3"><div class="sect3" id="id334">&#13;
<h3>Bringing Echo into your project</h3>&#13;
&#13;
<p>To<a data-primary="--save flag" data-type="indexterm" id="id1940"/> use Echo in your project’s JavaScript, add it to <em>package.json</em> using <code>npm install</code> <code class="keep-together">--save</code> (be sure to bring in the appropriate Pusher or <code>socket.io</code> SDK as well):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">npm<code class="w"> </code>install<code class="w"> </code>pusher-js<code class="w"> </code>laravel-echo<code class="w"> </code>--save<code class="w"/></pre>&#13;
&#13;
<p>Let’s assume you have a basic Vite file compiling your <em>app.js</em>, like in Laravel’s default installation setup.</p>&#13;
&#13;
<p>Laravel’s default <em>resources/js/app.js</em> structure has a great example of how best to initialize your Echo install. Take a look at <a data-type="xref" href="#initializing_echo_in_appjs">Example 16-29</a> to see how that works between that file and <em>resources/js/bootstrap.js</em>.</p>&#13;
<div data-type="example" id="initializing_echo_in_appjs">&#13;
<h5><span class="label">Example 16-29. </span>Initializing Echo in app.js and bootstrap.js</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// app.js</code>&#13;
<code class="nx">require</code><code class="p">(</code><code class="s1">'./bootstrap'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// ... lots of Vue stuff ...</code>&#13;
&#13;
<code class="c1">// Add your Echo bindings here</code></pre>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="c1">// bootstrap.js</code>&#13;
<code class="kr">import</code> <code class="nx">Echo</code> <code class="nx">from</code> <code class="s2">"laravel-echo"</code><code class="p">;</code>&#13;
&#13;
<code class="nb">window</code><code class="p">.</code><code class="nx">Echo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Echo</code><code class="p">({</code>&#13;
    <code class="nx">broadcaster</code><code class="o">:</code> <code class="s1">'pusher'</code><code class="p">,</code>&#13;
    <code class="nx">key</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">MIX_PUSHER_APP_KEY</code><code class="p">,</code>&#13;
    <code class="nx">cluster</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">MIX_PUSHER_APP_CLUSTER</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>For CSRF protection, you’ll also need to add a <code>csrf-token &lt;meta&gt;</code> tag to your HTML template:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">meta</code> <code class="na">name</code><code class="o">=</code><code class="s">"csrf-token"</code> <code class="na">content</code><code class="o">=</code><code class="s">"{{ csrf_token() }}"</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>And, of course, remember to link to your compiled <em>app.js</em> in your HTML template:</p>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">script</code> <code class="na">src</code><code class="o">=</code><code class="s">"{{ asset('js/app.js') }}"</code><code class="p">&gt;&lt;/</code><code class="nt">script</code><code class="p">&gt;</code></pre>&#13;
&#13;
<p>Now we’re ready to get started.</p>&#13;
<div data-type="tip"><h1>Changes to the Configuration When Using the Laravel WebSockets Server Package</h1>&#13;
<p>If you’re working with a Laravel WebSockets server (using the package discussed earlier in <a data-type="xref" href="#websockets_servers">“Receiving the Message”</a>), the configuration details in <a data-type="xref" href="#initializing_echo_in_appjs">Example 16-29</a> will be a little bit different. See the <a href="https://oreil.ly/iL6Yl">Laravel WebSockets package docs</a> for more info.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Echo for basic event broadcasting" data-type="sect3"><div class="sect3" id="id729">&#13;
<h3>Using Echo for basic event broadcasting</h3>&#13;
&#13;
<p>This is nothing different from what we’ve already used Pusher for, but <a data-type="xref" href="#listening_to_a_public_channel_with_Echo">Example 16-30</a> is a simple code sample to show how to use Echo to listen to public channels for basic event information.</p>&#13;
<div data-type="example" id="listening_to_a_public_channel_with_Echo">&#13;
<h5><span class="label">Example 16-30. </span>Listening to a public channel with Echo</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">currentTeamId</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="c1">// Likely set elsewhere</code>&#13;
&#13;
<code class="nx">Echo</code><code class="p">.</code><code class="nx">channel</code><code class="p">(</code><code class="sb">`teams.</code><code class="si">${</code><code class="nx">currentTeamId</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="s1">'UserSubscribed'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
&#13;
<p>Echo provides a few methods for subscribing to various types of channels; <code>channel()</code> will subscribe you to a public channel. Note that when you listen to an event with Echo, you can ignore the full event namespace and just listen for the unique class name of this event.</p>&#13;
&#13;
<p>We now have access to the public data that’s passed along with our event, represented in the <code>data</code> object. We can also chain <code>listen()</code> handlers, as in <a data-type="xref" href="#chaining_event_listeners_in_echo">Example 16-31</a>.</p>&#13;
<div data-type="example" id="chaining_event_listeners_in_echo">&#13;
<h5><span class="label">Example 16-31. </span>Chaining event listeners in Echo</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">Echo</code><code class="o">.</code><code class="nx">channel</code><code class="p">(</code><code class="sb">`teams.${currentTeamId}`</code><code class="p">)</code>&#13;
    <code class="o">.</code><code class="nx">listen</code><code class="p">(</code><code class="s1">'UserSubscribed'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="o">.</code><code class="nb">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">.</code><code class="nx">listen</code><code class="p">(</code><code class="s1">'UserCanceled'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="o">.</code><code class="nb">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
<div data-type="tip"><h1>Remember to Compile and Include!</h1>&#13;
<p>Did you try these code samples and not see anything change in your browser? Make sure to <span class="keep-together">run <code>npm run dev</code></span> (if you’re running it locally) or <code>npm run build</code> (to build it once) to compile your code. And, if you haven’t yet, be sure to actually include <em>app.js</em> in your template somewhere.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Private channels and basic authentication" data-type="sect3"><div class="sect3" id="id730">&#13;
<h3>Private channels and basic authentication</h3>&#13;
&#13;
<p>Echo also has a method for subscribing to private channels: <code>private()</code>. It works the same as <code>channel()</code>, but requires you to have set up channel authorization definitions in <em>routes/channel.php</em>, like we covered earlier. Additionally, unlike with the SDKs, you don’t need to put <code>private-</code> in front of your channel name.</p>&#13;
&#13;
<p><a data-type="xref" href="#listening_to_private_channel_with_echo">Example 16-32</a> shows what it looks like to listen to a private channel named <code>private-teams.5</code>.</p>&#13;
<div data-type="example" id="listening_to_private_channel_with_echo">&#13;
<h5><span class="label">Example 16-32. </span>Listening to a private channel with Echo</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">currentTeamId</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="c1">// Likely set elsewhere</code>&#13;
&#13;
<code class="nx">Echo</code><code class="p">.</code><code class="kr">private</code><code class="p">(</code><code class="sb">`teams.</code><code class="si">${</code><code class="nx">currentTeamId</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="s1">'UserSubscribed'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Presence channels" data-type="sect3"><div class="sect3" id="id731">&#13;
<h3>Presence channels</h3>&#13;
&#13;
<p>Echo makes it much simpler to join and listen to events in presence channels. This time you’ll want to use the <code>join()</code> method to bind to the channel, as in <a data-type="xref" href="#listening_to_presence_channel_with_echo">Example 16-33</a>.</p>&#13;
<div data-type="example" id="listening_to_presence_channel_with_echo">&#13;
<h5><span class="label">Example 16-33. </span>Joining a presence channel</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">currentTeamId</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="c1">// Likely set elsewhere</code>&#13;
&#13;
<code class="nx">Echo</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="sb">`teams.</code><code class="si">${</code><code class="nx">currentTeamId</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">here</code><code class="p">((</code><code class="nx">members</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">members</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
&#13;
<p><code>join()</code> subscribes to the presence channel, and <code>here()</code> allows you to define the behavior when the user joins and also when any other users join or leave the presence channel.</p>&#13;
&#13;
<p>You can think of a presence channel like a “who’s online” sidebar in a chat room. When you first join a presence channel, your <code>here()</code> callback will be called and provided a list of all the members at that time. And any time any members join or leave, that callback will be called again with the updated list. There’s no messaging happening here, but you can play sounds, update the on-page list of members, or do whatever else you want in response to these actions.</p>&#13;
&#13;
<p>There are also specific methods for individual events, which you can use individually or chained (see <a data-type="xref" href="#listening_for_specific_presence_events">Example 16-34</a>).</p>&#13;
<div data-type="example" id="listening_for_specific_presence_events">&#13;
<h5><span class="label">Example 16-34. </span>Listening for specific presence events</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="kd">var</code> <code class="nx">currentTeamId</code> <code class="o">=</code> <code class="mi">5</code><code class="p">;</code> <code class="c1">// Likely set elsewhere</code>&#13;
&#13;
<code class="nx">Echo</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">'teams.'</code> <code class="o">+</code> <code class="nx">currentTeamId</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">here</code><code class="p">((</code><code class="nx">members</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="c1">// Runs when you join</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">table</code><code class="p">(</code><code class="nx">members</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="p">.</code><code class="nx">joining</code><code class="p">((</code><code class="nx">joiningMember</code><code class="p">,</code> <code class="nx">members</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="c1">// Runs when another member joins</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">table</code><code class="p">(</code><code class="nx">joiningMember</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="p">.</code><code class="nx">leaving</code><code class="p">((</code><code class="nx">leavingMember</code><code class="p">,</code> <code class="nx">members</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="c1">// Runs when another member leaves</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">table</code><code class="p">(</code><code class="nx">leavingMember</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Excluding the current user" data-type="sect3"><div class="sect3" id="id335">&#13;
<h3>Excluding the current user</h3>&#13;
&#13;
<p>We covered this previously in the chapter, but if you want to exclude the current user, you can use the<a data-primary="helpers" data-secondary="broadcast() global helper" data-type="indexterm" id="id1941"/><a data-primary="broadcast() global helper" data-type="indexterm" id="id1942"/> <code>broadcast()</code> global helper instead of the <code>event()</code> global helper and then chain the <code>toOthers()</code> method after your broadcast call. But with Echo, the JavaScript side of this is already handled for you. It’ll just work.</p>&#13;
&#13;
<p>As you can see, the Echo JavaScript library doesn’t do anything you couldn’t do on your own—​but it makes a lot of common tasks much simpler and provides a cleaner, more expressive syntax for common WebSocket tasks.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Subscribing to notifications with Echo" data-type="sect3"><div class="sect3" id="id732">&#13;
<h3>Subscribing to notifications with Echo</h3>&#13;
&#13;
<p>Laravel’s notifications come with a broadcast driver out of the box that pushes notifications out as broadcast events. You can subscribe to these notifications with Echo using <code>Echo.notification()</code>, as in <a data-type="xref" href="#subscribing_to_notification_with_Echo">Example 16-35</a>.</p>&#13;
<div data-type="example" id="subscribing_to_notification_with_Echo">&#13;
<h5><span class="label">Example 16-35. </span>Subscribing to a notification with Echo</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">Echo</code><code class="p">.</code><code class="kr">private</code><code class="p">(</code><code class="sb">`App.User.</code><code class="si">${</code><code class="nx">userId</code><code class="si">}</code><code class="sb">`</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">notification</code><code class="p">((</code><code class="nx">notification</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">notification</code><code class="p">.</code><code class="nx">type</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Client events" data-type="sect3"><div class="sect3" id="id336">&#13;
<h3>Client events</h3>&#13;
&#13;
<p>If you’d like to send quick, performant messages between your users without the messages even hitting your Laravel application—​for example, to send “typing…​” notifications—​you can use Echo’s <code>whisper()</code> method, as shown in <a data-type="xref" href="#bypassing-laravel-with-echo">Example 16-36</a>.</p>&#13;
<div data-type="example" id="bypassing-laravel-with-echo">&#13;
<h5><span class="label">Example 16-36. </span>Bypassing the Laravel server using Echo’s <code>whisper()</code> method</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">Echo</code><code class="p">.</code><code class="kr">private</code><code class="p">(</code><code class="s1">'room'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">whisper</code><code class="p">(</code><code class="s1">'typing'</code><code class="p">,</code> <code class="p">{</code>&#13;
        <code class="nx">name</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">user</code><code class="p">.</code><code class="nx">name</code>&#13;
    <code class="p">});</code></pre></div>&#13;
&#13;
<p>And<a data-primary="" data-startref="LEcho16" data-type="indexterm" id="id1943"/><a data-primary="" data-startref="echo16" data-type="indexterm" id="id1944"/><a data-primary="" data-startref="EBlaravelE16" data-type="indexterm" id="id1945"/> then use <code>listenForWhisper()</code> to listen, as in <a data-type="xref" href="#whisper-events-with-echo">Example 16-37</a>.</p>&#13;
<div data-type="example" id="whisper-events-with-echo">&#13;
<h5><span class="label">Example 16-37. </span>Listening for whisper events with Echo</h5>&#13;
&#13;
<pre data-code-language="javascript" data-type="programlisting"><code class="nx">Echo</code><code class="p">.</code><code class="kr">private</code><code class="p">(</code><code class="s1">'room'</code><code class="p">)</code>&#13;
    <code class="p">.</code><code class="nx">listenForWhisper</code><code class="p">(</code><code class="s1">'typing'</code><code class="p">,</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>&#13;
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">.</code><code class="nx">name</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scheduler" data-type="sect1"><div class="sect1" id="id337">&#13;
<h1>Scheduler</h1>&#13;
&#13;
<p>If<a data-primary="scheduling jobs" data-type="indexterm" id="schedjob16"/><a data-primary="jobs" data-secondary="scheduling" data-type="indexterm" id="JBsched16"/><a data-primary="tasks, scheduling" data-type="indexterm" id="taskssched16"/> you’ve ever written a cron job before, you likely already wish for a better tool. Not only is the syntax onerous and frustratingly difficult to remember, but it’s one significant aspect of your application that can’t be stored in version control.</p>&#13;
&#13;
<p>Laravel’s scheduler makes handling scheduled tasks simple. You’ll write your scheduled tasks in code, and then point one cron job at your app: once per minute, run <code>php artisan schedule:run</code>. Every time this Artisan command is run, Laravel checks your schedule definitions to find out if any scheduled tasks should run.</p>&#13;
&#13;
<p>Here’s the<a data-primary="cron jobs" data-type="indexterm" id="id1946"/> cron job to define that command:</p>&#13;
&#13;
<pre data-type="programlisting">* * * * * cd /home/myapp.com &amp;&amp; php artisan schedule:run &gt;&gt; /dev/null 2&gt;&amp;1</pre>&#13;
&#13;
<p>There are many task types you can schedule and many time frames you can use to schedule them.</p>&#13;
&#13;
<p><em>app/Console/Kernel.php</em> has a method named <code>schedule()</code>, which is where you’ll define any tasks you’d like to schedule.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Available Task Types" data-type="sect2"><div class="sect2" id="id338">&#13;
<h2>Available Task Types</h2>&#13;
&#13;
<p>First, let’s take a look at the simplest option: a closure, run every minute (<a data-type="xref" href="#scheduling_closure_to_run_every_minute">Example 16-38</a>). Every time the cron job hits the <code>schedule:run</code> command, it will call this closure.</p>&#13;
<div data-type="example" id="scheduling_closure_to_run_every_minute">&#13;
<h5><span class="label">Example 16-38. </span>Scheduling a closure to run once every minute</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/Console/Kernel.php</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">schedule</code><code class="p">(</code><code class="nx">Schedule</code> <code class="nv">$schedule</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">call</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="nx">CalculateTotals</code><code class="o">::</code><code class="na">dispatch</code><code class="p">();</code>&#13;
    <code class="p">})</code><code class="o">-&gt;</code><code class="na">everyMinute</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>There are two other types of tasks you can schedule: Artisan and shell commands.</p>&#13;
&#13;
<p>You<a data-primary="--reset-cache flag" data-type="indexterm" id="id1947"/> can schedule Artisan commands by passing their syntax exactly as you would call them from the command line:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'scores:tally --reset-cache'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">everyMinute</code><code class="p">();</code></pre>&#13;
&#13;
<p>And you can run any shell commands that you can run with PHP’s <code>exec()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="s1">'/home/myapp.com/bin/build.sh'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">everyMinute</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Available Time Frames" data-type="sect2"><div class="sect2" id="id733">&#13;
<h2>Available Time Frames</h2>&#13;
&#13;
<p>The beauty of the scheduler isn’t just that you can define your tasks in code; it’s that you can schedule them in code, too. Laravel keeps track of time passing and evaluates whether it’s time for any given task to run. That’s easy with <code>everyMinute()</code> because the answer is always simple: run the task. But Laravel keeps the rest simple for you, too, even for the most complex of requests.</p>&#13;
&#13;
<p>Let’s take a look at your options by starting with a monstrous definition that’s simple in Laravel:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">call</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Runs once a week on Sunday at 23:50</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">weekly</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">sundays</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">at</code><code class="p">(</code><code class="s1">'23:50'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Notice that we can chain times together: we can define frequency and specify the day of the week and the time, and of course we can do much more.</p>&#13;
&#13;
<p><a data-type="xref" href="#modifiers_for_scheduler">Table 16-1</a> shows a list of potential date/time modifiers for use when scheduling a job.</p>&#13;
<table id="modifiers_for_scheduler">&#13;
<caption><span class="label">Table 16-1. </span>Date/time modifiers for use with the scheduler</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Command</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>-&gt;timezone('America/Detroit')</code></p></td>&#13;
<td><p>Set the time zone for schedules</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;cron('* * * * * *')</code></p></td>&#13;
<td><p>Define the schedule using the traditional cron notation</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyMinute()</code></p></td>&#13;
<td><p>Run every minute</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyTwoMinutes()</code></p></td>&#13;
<td><p>Run every 2 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyThreeMinutes()</code></p></td>&#13;
<td><p>Run every 3 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyFourMinutes()</code></p></td>&#13;
<td><p>Run every 4 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyFiveMinutes()</code></p></td>&#13;
<td><p>Run every 5 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyTenMinutes()</code></p></td>&#13;
<td><p>Run every 10 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyFifteenMinutes()</code></p></td>&#13;
<td><p>Run every 15 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyThirtyMinutes()</code></p></td>&#13;
<td><p>Run every 30 minutes</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;hourly()</code></p></td>&#13;
<td><p>Run every hour</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;hourlyAt(14)</code></p></td>&#13;
<td><p>Run every hour at 14 minutes past</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyTwoHours()</code></p></td>&#13;
<td><p>Run every 2 hours</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyThreeHours()</code></p></td>&#13;
<td><p>Run every 3 hours</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everyFourHours()</code></p></td>&#13;
<td><p>Run every 4 hours</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;everySixHours()</code></p></td>&#13;
<td><p>Run every 6 hours</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;daily()</code></p></td>&#13;
<td><p>Run every day at midnight</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;dailyAt('14:00')</code></p></td>&#13;
<td><p>Run every day at 14:00</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;twiceDaily(1, 14)</code></p></td>&#13;
<td><p>Run every day at 1:00 and 14:00</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;twiceDailyAt(1, 14, 6)</code></p></td>&#13;
<td><p>Run every day at 1:06 and 14:06 (the third argument is the minutes to start)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;weekly()</code></p></td>&#13;
<td><p>Run every week (midnight on Sunday)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;weeklyOn(5, '10:00')</code></p></td>&#13;
<td><p>Run every week on Friday at 10:00</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;monthly()</code></p></td>&#13;
<td><p>Run every month (midnight on the 1st)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;monthlyOn(15, '23:00')</code></p></td>&#13;
<td><p>Run every month on the 15th at 23:00</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;quarterly()</code></p></td>&#13;
<td><p>Run every quarter (midnight on the 1st of January, April, July, and October)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;yearly()</code></p></td>&#13;
<td><p>Run every year (midnight on the 1st of January)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;yearlyOn(6)</code></p></td>&#13;
<td><p>Run every year (midnight on the 1st of June)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;when(closure)</code></p></td>&#13;
<td><p>Limit the task to when the closure returns <code>true</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;skip(closure)</code></p></td>&#13;
<td><p>Limit the task to when the closure returns <code>false</code></p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;between('8:00', '12:00')</code></p></td>&#13;
<td><p>Limit the task to between the given times</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;unlessBetween('8:00', '12:00')</code></p></td>&#13;
<td><p>Limit the task to any time except between the given times</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;weekdays()</code></p></td>&#13;
<td><p>Limit to weekdays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;sundays()</code></p></td>&#13;
<td><p>Limit to Sundays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;mondays()</code></p></td>&#13;
<td><p>Limit to Mondays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;tuesdays()</code></p></td>&#13;
<td><p>Limit to Tuesdays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;wednesdays()</code></p></td>&#13;
<td><p>Limit to Wednesdays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;thursdays()</code></p></td>&#13;
<td><p>Limit to Thursdays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;fridays()</code></p></td>&#13;
<td><p>Limit to Fridays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;saturdays()</code></p></td>&#13;
<td><p>Limit to Saturdays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;days([1,2])</code></p></td>&#13;
<td><p>Limit to Sundays and Mondays</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>-&gt;environments(<em>staging</em>)</code></p></td>&#13;
<td><p>Limit to only the staging environment</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p>Most of these can be chained one after another, but of course, any combinations that don’t make sense chained can’t be chained.</p>&#13;
&#13;
<p><a data-type="xref" href="#sample_scheduled_events">Example 16-39</a> shows a few combinations you could consider.</p>&#13;
<div data-type="example" id="sample_scheduled_events">&#13;
<h5><span class="label">Example 16-39. </span>Some sample scheduled events</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Both run weekly on Sunday at 23:50</code>&#13;
<code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">weeklyOn</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="s1">'23:50'</code><code class="p">);</code>&#13;
<code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">weekly</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">sundays</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">at</code><code class="p">(</code><code class="s1">'23:50'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Run once per hour, weekdays, 8am-5pm</code>&#13;
<code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">weekdays</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">hourly</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nb">date</code><code class="p">(</code><code class="s1">'H'</code><code class="p">)</code> <code class="o">&gt;=</code> <code class="mi">8</code> <code class="o">&amp;&amp;</code> <code class="nb">date</code><code class="p">(</code><code class="s1">'H'</code><code class="p">)</code> <code class="o">&lt;=</code> <code class="mi">17</code><code class="p">;</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Run once per hour, weekdays, 8am-5pm using the "between" method</code>&#13;
<code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">weekdays</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">hourly</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">between</code><code class="p">(</code><code class="s1">'8:00'</code><code class="p">,</code> <code class="s1">'17:00'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Run every 30 minutes except when directed not to by the SkipDetector</code>&#13;
<code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">everyThirtyMinutes</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">skip</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">app</code><code class="p">(</code><code class="s1">'SkipDetector'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">shouldSkip</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining Time Zones for Scheduled Commands" data-type="sect2"><div class="sect2" id="id339">&#13;
<h2>Defining Time Zones for Scheduled Commands</h2>&#13;
&#13;
<p>You<a data-primary="time zones, for scheduled commands" data-type="indexterm" id="id1948"/> can define the time zone on a specific scheduled command using the <code>timezone()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:it'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">weeklyOn</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="s1">'23:50'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">timezone</code><code class="p">(</code><code class="s1">'America/Chicago'</code><code class="p">);</code></pre>&#13;
&#13;
<p>You can also set a default time zone (separate from the application time zone) that all of your scheduled times will be defined in, by defining the <code>scheduleTimezone()</code> method in <code>App\Console\Kernel</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">protected</code> <code class="k">function</code> <code class="nf">scheduleTimezone</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="s1">'America/Chicago'</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Blocking and Overlap" data-type="sect2"><div class="sect2" id="id734">&#13;
<h2>Blocking and Overlap</h2>&#13;
&#13;
<p>If you want to avoid having your tasks overlap each other—​for example, if you have a task running every minute that may sometimes take longer than a minute to run—​end the schedule chain with the <code>withoutOverlapping()</code> method. This method skips a task if the previous instance of that task is still running:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">everyMinute</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">withoutOverlapping</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Task Output" data-type="sect2"><div class="sect2" id="id735">&#13;
<h2>Handling Task Output</h2>&#13;
&#13;
<p>Sometimes the output from your scheduled task is important, whether for logging, notifications, or just ensuring that the task ran.</p>&#13;
&#13;
<p>If you want to write the returned output of a task to a file (potentially overwriting what is already in the file), use <code>sendOutputTo()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">daily</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">sendOutputTo</code><code class="p">(</code><code class="nv">$filePath</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you want to append it to a file instead, use <code>appendOutputTo()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">daily</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">appendOutputTo</code><code class="p">(</code><code class="nv">$filePath</code><code class="p">);</code></pre>&#13;
&#13;
<p>And if you want to email the output to a designated recipient, write it to a file first and then add <code>emailOutputTo()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">daily</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">sendOutputTo</code><code class="p">(</code><code class="nv">$filePath</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">emailOutputTo</code><code class="p">(</code><code class="s1">'me@myapp.com'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Make sure that your email settings are configured correctly in Laravel’s basic email configuration.</p>&#13;
<div data-type="note" epub:type="note"><h1>Closure Scheduled Events Can’t Send Output</h1>&#13;
<p>The <code>sendOutputTo()</code>, <code>appendOutputTo()</code>, and <code>emailOutputTo()</code> methods only work for <code>command()-</code> scheduled tasks. You can’t use them for closures, unfortunately.</p>&#13;
</div>&#13;
&#13;
<p>You may also want to send some output to a webhook to verify that your tasks ran correctly. There are a few services that provide this sort of uptime monitoring, most significantly <a href="https://envoyer.io"><span class="keep-together">Laravel</span> Envoyer</a>, a zero-downtime deployment service that also provides cron uptime monitoring, and <a href="https://deadmanssnitch.com">Dead Man’s Snitch</a>, a tool designed purely for monitoring cron job uptime.</p>&#13;
&#13;
<p>These services don’t expect something to be emailed to them, but rather expect an HTTP “ping,” so Laravel makes that easy with <code>pingBefore()</code> and <code>thenPing()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">daily</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">pingBefore</code><code class="p">(</code><code class="nv">$beforeUrl</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">thenPing</code><code class="p">(</code><code class="nv">$afterUrl</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you want to use the ping features, you’ll need to pull in Guzzle using Composer:</p>&#13;
&#13;
<p><code>composer require guzzlehttp/guzzle</code></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Task Hooks" data-type="sect2"><div class="sect2" id="id340">&#13;
<h2>Task Hooks</h2>&#13;
&#13;
<p>Speaking<a data-primary="before() method" data-type="indexterm" id="id1949"/><a data-primary="after() method" data-type="indexterm" id="id1950"/> of running something <em>before</em> and <em>after</em> your task, there are hooks for that, with <code>before()</code> and <code>after()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$schedule</code><code class="o">-&gt;</code><code class="na">command</code><code class="p">(</code><code class="s1">'do_thing'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">daily</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">before</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="c1">// Prepare</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">after</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="c1">// Cleanup</code>&#13;
    <code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running the Scheduler in Local Development" data-type="sect2"><div class="sect2" id="id341">&#13;
<h2>Running the Scheduler in Local Development</h2>&#13;
&#13;
<p>Since<a data-primary="development environment" data-secondary="for task scheduling" data-secondary-sortas="task scheduling" data-type="indexterm" id="id1951"/> the scheduler depends on cron, it’s simpler to set up on a server than on &#13;
<span class="keep-together">your local</span> machine. If you’d like to have the scheduler running locally, run the &#13;
<span class="keep-together"><code>schedule:work</code></span> Artisan command, which will invoke the scheduler every minute, just like a<a data-primary="" data-startref="schedjob16" data-type="indexterm" id="id1952"/><a data-primary="" data-startref="JBsched16" data-type="indexterm" id="id1953"/><a data-primary="" data-startref="taskssched16" data-type="indexterm" id="id1954"/> cron job:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>schedule:work<code class="w"/></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id540">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Testing<a data-primary="queues and queueing" data-secondary="testing" data-type="indexterm" id="id1955"/><a data-primary="events" data-secondary="testing" data-type="indexterm" id="id1956"/><a data-primary="jobs" data-secondary="testing" data-type="indexterm" id="id1957"/> queued jobs (or anything else in the queue) is easy. In <em>phpunit.xml</em>, which is the configuration file for your tests, the <code>QUEUE_DRIVER</code> environment variable is set to <code>sync</code> by default. That means your tests will run your jobs or other queued tasks synchronously, directly in your code, without relying on a queue system of any sort. You can test them just like any other code.</p>&#13;
&#13;
<p>However, you can assert against the specific job itself, as in <a data-type="xref" href="#verify_job_meets_criteria">Example 16-40</a>.</p>&#13;
<div data-type="example" id="verify_job_meets_criteria">&#13;
<h5><span class="label">Example 16-40. </span>Using a closure to verify that a dispatched job meets given criteria</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Bus</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_changing_subscriptions_triggers_crunch_job</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">assertDispatched</code><code class="p">(</code><code class="nx">CrunchReports</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$job</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">subscriptions</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Also can use assertNotDispatched()</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>There are also the <code>assertPushedWithChain()</code> and <code>assertPushedWithoutChain()</code> methods.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Bus</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
<code class="nx">Bus</code><code class="o">::</code><code class="na">assertPushedWithChain</code><code class="p">(</code>&#13;
    <code class="nx">CrunchReports</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="nx">ChainedJob</code><code class="o">::</code><code class="na">class</code><code class="p">],</code>&#13;
    <code class="k">function</code> <code class="p">(</code><code class="nv">$job</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">subscriptions</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">);</code>&#13;
&#13;
    <code class="c1">// Also can use assertPushedWithoutChain()</code>&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">assertPushedWithChain</code><code class="p">(</code><code class="nx">CrunchReports</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$job</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">subscriptions</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre>&#13;
&#13;
<p>To test that an event fired, you have two options. First, you can just test that the behavior you expected happened, without concerning yourself with the event itself.</p>&#13;
&#13;
<p>Second, you can run a test against the event that was fired, as in <a data-type="xref" href="#verify_fired_event_meets_criteria">Example 16-41</a>.</p>&#13;
<div data-type="example" id="verify_fired_event_meets_criteria">&#13;
<h5><span class="label">Example 16-41. </span>Using a closure to verify that a fired event meets given criteria</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Event</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_usersubscribed_event_fires</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// ...</code>&#13;
&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">assertDispatched</code><code class="p">(</code><code class="nx">UserSubscribed</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$e</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$e</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">email</code> <code class="o">=</code> <code class="s1">'user-who-subscribed@mail.com'</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Also can use assertNotDispatched()</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Another common scenario is that you’re testing code that incidentally fires events, and you want to disable the event listeners during that test. You can disable the event system with the <code>withoutEvents()</code> method, as in <a data-type="xref" href="#disabling_event_listeners">Example 16-42</a>.</p>&#13;
<div data-type="example" id="disabling_event_listeners">&#13;
<h5><span class="label">Example 16-42. </span>Disabling event listeners during a test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_something_subscription_related</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">withoutEvents</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id342">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Queues<a data-primary="queues and queueing" data-secondary="overview of" data-type="indexterm" id="id1958"/><a data-primary="events" data-secondary="overview of" data-type="indexterm" id="id1959"/><a data-primary="jobs" data-secondary="overview of" data-type="indexterm" id="id1960"/> allow you to separate chunks of your application’s code from the synchronous flow of user interactions out to a list of commands to be processed by a “queue worker.” This allows your users to resume interactions with your application while slower processes are handled asynchronously in the background.</p>&#13;
&#13;
<p>Jobs are classes that are structured with the intention of encapsulating a chunk of application behavior so that it can be pushed onto a queue.</p>&#13;
&#13;
<p>Laravel’s event system follows the pub/sub or observer pattern, allowing you to send out notifications of an event from one part of your application, and elsewhere bind listeners to those notifications to define what behavior should happen in response to them. Using WebSockets, events can also be broadcast to frontend clients.</p>&#13;
&#13;
<p>Laravel’s scheduler<a data-primary="scheduling jobs" data-type="indexterm" id="id1961"/><a data-primary="tasks, scheduling" data-type="indexterm" id="id1962"/> simplifies scheduling tasks. Point an every-minute cron job to <code class="keep-together">php artisan</code> <code>schedule:run</code> and then schedule your tasks with even the most complex of time requirements using the scheduler, and Laravel will handle all the timings for you.</p>&#13;
</div></section>&#13;
</div></section></body></html>