<html><head></head><body><section data-pdf-bookmark="Chapter 9. User Authentication and Authorization" data-type="chapter" epub:type="chapter"><div class="chapter" id="user_authentication_and_authorization">&#13;
<h1><span class="label">Chapter 9. </span>User Authentication and Authorization</h1>&#13;
&#13;
&#13;
<p>Setting up a basic user authentication system—including registration, login, sessions, password resets, and access permissions—can often be one of the more time-consuming pieces of creating the foundation of an application. It’s a prime candidate for extracting functionality out to a library, and there are quite a few such libraries.</p>&#13;
&#13;
<p>But<a data-primary="authentication and authorization" data-secondary="benefits of Laravel for" data-type="indexterm" id="id1307"/> because authentication needs can vary widely across projects, most authentication systems grow bulky and unusable quickly. Thankfully, Laravel has found a way to make a suite of authentication systems that are easy to use and understand, but flexible enough to fit in a variety of settings.</p>&#13;
&#13;
<p>Every new installation of Laravel has a <code>create_users_table</code> migration and a <code>User</code> model built in. If you bring in Breeze (see <a data-type="xref" href="ch06.html#breeze">“Laravel Breeze”</a>) or Jetstream (see <a data-type="xref" href="ch06.html#jetstream">“Laravel Jetstream”</a>), they’ll seed your app with a collection of authentication-related views, routes, controllers/actions, and other features. The APIs are clean and clear, and the conventions all work together to provide a simple—​and seamless—​authentication and authorization system.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The User Model and Migration" data-type="sect1"><div class="sect1" id="id187">&#13;
<h1>The User Model and Migration</h1>&#13;
&#13;
<p>When<a data-primary="authentication and authorization" data-secondary="user model and migration" data-type="indexterm" id="AAumodel09"/><a data-primary="User model" data-type="indexterm" id="usermodel09"/><a data-primary="databases" data-secondary="migrating" data-tertiary="User model and" data-type="indexterm" id="DBmiguser09"/> you create a new Laravel application, the first migration and model you’ll see are the <code>create_users_table</code> migration and the <code>App\User</code> model. <a data-type="xref" href="#EX901">Example 9-1</a> shows, straight from the migration, the fields you’ll get in your <code>users</code> table.</p>&#13;
<div data-type="example" id="EX901">&#13;
<h5><span class="label">Example 9-1. </span>Laravel’s default user migration</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">();</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'email'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">unique</code><code class="p">();</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">timestamp</code><code class="p">(</code><code class="s1">'email_verified_at'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">nullable</code><code class="p">();</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'password'</code><code class="p">);</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">rememberToken</code><code class="p">();</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">timestamps</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>We have an autoincrementing primary key ID, a name, a unique email, a password, a “remember me” token, and created and modified timestamps. This covers everything you need to handle basic user authentication in most apps.</p>&#13;
<div data-type="note" epub:type="note"><h1>The Difference Between Authentication and Authorization</h1>&#13;
<p><em>Authentication</em> means<a data-primary="authentication and authorization" data-secondary="definition of terms" data-type="indexterm" id="id1308"/> verifying who someone is and allowing them to act as that person in your system. This includes the login and logout processes as well as any tools that allow the users to identify themselves during their time using the application.</p>&#13;
&#13;
<p><em>Authorization</em> means determining whether the authenticated user is <em>allowed</em> (authorized) to perform a specific behavior. For example, an authorization system allows you to forbid any nonadministrators from viewing the site’s earnings.</p>&#13;
</div>&#13;
&#13;
<p>The <code>User</code> model is a bit more complex, as you can see in <a data-type="xref" href="#EX902">Example 9-2</a>. The <code>App\User</code> class itself is simple, but it extends the <code>Illuminate\Foundation\Auth\User</code> class, which pulls in several traits.</p>&#13;
<div data-type="example" id="EX902">&#13;
<h5><span class="label">Example 9-2. </span>Laravel’s default <code>User</code> model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
<code class="c1">// App\User</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Models</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// use Illuminate\Contracts\Auth\MustVerifyEmail;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Factories\HasFactory</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Foundation\Auth\User</code> <code class="k">as</code> <code class="nx">Authenticatable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Notifications\Notifiable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Laravel\Sanctum\HasApiTokens</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Authenticatable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">HasApiTokens</code><code class="p">,</code> <code class="nx">HasFactory</code><code class="p">,</code> <code class="nx">Notifiable</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * The attributes that are mass assignable.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @var array&lt;int, string&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">protected</code> <code class="nv">$fillable</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code><code class="p">,</code>&#13;
        <code class="s1">'email'</code><code class="p">,</code>&#13;
        <code class="s1">'password'</code><code class="p">,</code>&#13;
    <code class="p">];</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * The attributes that should be hidden for serialization.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @var array&lt;int, string&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">protected</code> <code class="nv">$hidden</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="s1">'password'</code><code class="p">,</code>&#13;
        <code class="s1">'remember_token'</code><code class="p">,</code>&#13;
    <code class="p">];</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * The attributes that should be cast.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @var array&lt;string, string&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">protected</code> <code class="nv">$casts</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="s1">'email_verified_at'</code> <code class="o">=&gt;</code> <code class="s1">'datetime'</code><code class="p">,</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
<code class="c1">// Illuminate\Foundation\Auth\User</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Illuminate\Foundation\Auth</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Auth\Authenticatable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Auth\MustVerifyEmail</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Auth\Passwords\CanResetPassword</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Auth\Access\Authorizable</code> <code class="k">as</code> <code class="nx">AuthorizableContract</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Auth\Authenticatable</code> <code class="k">as</code> <code class="nx">AuthenticatableContract</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Auth\CanResetPassword</code> <code class="k">as</code> <code class="nx">CanResetPasswordContract</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Foundation\Auth\Access\Authorizable</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code> <code class="k">implements</code>&#13;
    <code class="nx">AuthenticatableContract</code><code class="p">,</code>&#13;
    <code class="nx">AuthorizableContract</code><code class="p">,</code>&#13;
    <code class="nx">CanResetPasswordContract</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Authenticatable</code><code class="p">,</code> <code class="nx">Authorizable</code><code class="p">,</code> <code class="nx">CanResetPassword</code><code class="p">,</code> <code class="nx">MustVerifyEmail</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="tip"><h1>Eloquent Model Refresher</h1>&#13;
<p>If this is entirely unfamiliar, consider reading <a data-type="xref" href="ch05.html#database_and_eloquent">Chapter 5</a> before continuing to learn how Eloquent models work.</p>&#13;
</div>&#13;
&#13;
<p>So, what can we learn from this model? First, users live in the <code>users</code> table; Laravel will infer this from the class name. We are able to fill out the <code>name</code>, <code>email</code>, and <code>password</code> properties when creating a new user, and the <code>password</code> and <code>remember_token</code> properties are excluded when outputting the user as JSON. Looking good so far.</p>&#13;
&#13;
<p>We also can see from the contracts and the traits in the <code>Illuminate\Foundation\Auth</code> version of <code>User</code> that there are some features in the framework (the ability to authenticate, to authorize, and to reset passwords) that theoretically could be applied to other models, not just the <code>User</code> model, and that could be applied individually <span class="keep-together">or together.</span></p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1309">&#13;
<h1>Contracts and Interfaces</h1>&#13;
<p>You<a data-primary="Contracts namespace" data-type="indexterm" id="id1310"/><a data-primary="interfaces" data-type="indexterm" id="id1311"/> may have noticed that sometimes I write the word “contract” and sometimes “interface,” and that almost all of the interfaces in Laravel are under the <code>Contracts</code> namespace.</p>&#13;
&#13;
<p>A PHP interface is essentially an agreement between two classes that one of the classes will “behave” a certain way. It’s a bit like a contract between them, and thinking about it as a contract gives a little more inherent meaning to the name than calling it an interface does.</p>&#13;
&#13;
<p>In the end, though, they’re the same thing: an agreement that a class will provide certain methods with a certain signature.</p>&#13;
&#13;
<p>On a related note, the <code>Illuminate\Contracts</code> namespace contains a group of interfaces that Laravel components implement and<a data-primary="typehints" data-type="indexterm" id="id1312"/> typehint. This makes it easy to develop similar components that implement the same interfaces and swap them into your application in place of the stock <code>Illuminate</code> components. When the Laravel core and components typehint a mailer, for example, they don’t typehint the <code>Mailer</code> class. Instead, they typehint the <code>Mailer</code> contract (interface), making it easy to provide your own mailer. To learn more about how to do this, take a look at <a data-type="xref" href="ch11.html#the_container">Chapter 11</a>.</p>&#13;
</div></aside>&#13;
&#13;
<p>The <code>Authenticatable</code> contract requires methods (e.g., <code>getAuthIdentifier()</code>) that allow the framework to authenticate instances of this model to the auth system; the <code>Authenticatable</code> trait includes the methods necessary to satisfy that contract with an average Eloquent model.</p>&#13;
&#13;
<p>The <code>Authorizable</code> contract requires a method (<code>can()</code>) that allows the framework to authorize instances of this model for their access permissions in different contexts. Unsurprisingly, the <code>Authorizable</code> trait provides methods that will satisfy the <span class="keep-together"><code>Authorizable</code></span> contract for an average Eloquent model.</p>&#13;
&#13;
<p class="pagebreak-before">Finally, the <code>CanResetPassword</code> contract requires methods (<code>g⁠⁠e⁠t⁠E⁠m⁠a⁠i⁠l⁠F⁠o⁠r​P⁠a⁠s⁠s⁠w⁠o⁠r⁠d⁠R⁠e⁠s⁠e⁠t⁠(⁠)</code>, <code>sendPasswordResetNotification()</code>) that allow the framework &#13;
<span class="keep-together">to—you</span> guessed it—reset the password of any entity that satisfies this contract. The <code>CanResetPassword</code> trait provides methods to satisfy that contract for an average Eloquent model.</p>&#13;
&#13;
<p>At this point, we have the ability to easily represent an individual user in the database (with the migration), and to pull them out with a model instance that can be authenticated (logged in and out), authorized (checked for access permissions to a particular resource), and sent a password reset email.<a data-primary="" data-startref="AAumodel09" data-type="indexterm" id="id1313"/><a data-primary="" data-startref="DBmiguser09" data-type="indexterm" id="id1314"/><a data-primary="" data-startref="usermodel09" data-type="indexterm" id="id1315"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the auth() Global Helper and the Auth Facade" data-type="sect1"><div class="sect1" id="id436">&#13;
<h1>Using the auth() Global Helper and the Auth Facade</h1>&#13;
&#13;
<p>The <code>auth()</code> global helper<a data-primary="authentication and authorization" data-secondary="using auth() global helper and Auth facade" data-secondary-sortas="auth() global helper and the Auth facade" data-type="indexterm" id="id1316"/><a data-primary="helpers" data-secondary="auth() global helper" data-type="indexterm" id="id1317"/> is the easiest way to interact with the status of the authenticated user throughout your app. You can also inject an instance of <code>Illuminate\Auth\AuthManager</code> and get the same functionality, or use the <code>Auth</code> facade.</p>&#13;
&#13;
<p>The most common usages are to check whether a user is logged in—(<code>auth()-&gt;check()</code> returns <code>true</code> if the current user is logged in; <code>auth()-&gt;guest()</code> returns <code>true</code> if the user is not logged in)—and to get the currently logged-in user (use <code>auth()-&gt;user()</code>, or <code>auth()-&gt;id()</code> for just the ID; both return <code>null</code> if no user is logged in).</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX903">Example 9-3</a> for a sample usage of the global helper in a controller.</p>&#13;
<div data-type="example" id="EX903">&#13;
<h5><span class="label">Example 9-3. </span>Sample usage of the <code>auth()</code> global helper in a controller</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">dashboard</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">guest</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'sign-up'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'user'</code><code class="p">,</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">());</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="routes/auth.php, Auth Controllers, and Auth Actions" data-type="sect1"><div class="sect1" id="id437">&#13;
<h1>routes/auth.php, Auth Controllers, and Auth Actions</h1>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="using Laravel's starter kits" data-secondary-sortas="Laravel's starter kits" data-type="indexterm" id="id1318"/><a data-primary="frontend components" data-secondary="Laravel starter kits" data-tertiary="using for authentication and authorization" data-tertiary-sortas="authentication and authorization" data-type="indexterm" id="id1319"/><a data-primary="Jetstream" data-secondary="using for authentication and authorization" data-secondary-sortas="authentication and authorization" data-type="indexterm" id="id1320"/> you’re working with one of Laravel’s starter kits, you’ll see that using the baked-in authentication routes, such as login, register, and password reset, requires routes, controllers, and views.</p>&#13;
&#13;
<p>Both<a data-primary="Breeze" data-secondary="using for authentication and authorization" data-secondary-sortas="authentication and authorization" data-type="indexterm" id="id1321"/> Breeze and Jetstream define your routes using a custom routes file: <em>routes/auth.php</em>. They’re not exactly the same, but take a look at <a data-type="xref" href="#EX927">Example 9-4</a> to see a bit of Breeze’s auth routes file to show what they look like generally.</p>&#13;
<div data-type="example" id="EX927">&#13;
<h5><span class="label">Example 9-4. </span>Part of Breeze’s routes/auth.php</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'guest'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'register'</code><code class="p">,</code> <code class="p">[</code><code class="nx">RegisteredUserController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'create'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'register'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'register'</code><code class="p">,</code> <code class="p">[</code><code class="nx">RegisteredUserController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'store'</code><code class="p">]);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'login'</code><code class="p">,</code> <code class="p">[</code><code class="nx">AuthenticatedSessionController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'create'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'login'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'login'</code><code class="p">,</code> <code class="p">[</code><code class="nx">AuthenticatedSessionController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'store'</code><code class="p">]);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'forgot-password'</code><code class="p">,</code> <code class="p">[</code><code class="nx">PasswordResetLinkController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'create'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'password.request'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'forgot-password'</code><code class="p">,</code> <code class="p">[</code><code class="nx">PasswordResetLinkController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'store'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'password.email'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'reset-password/{token}'</code><code class="p">,</code> <code class="p">[</code><code class="nx">NewPasswordController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'create'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'password.reset'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'reset-password'</code><code class="p">,</code> <code class="p">[</code><code class="nx">NewPasswordController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'store'</code><code class="p">])</code>&#13;
                <code class="o">-&gt;</code><code class="na">name</code><code class="p">(</code><code class="s1">'password.store'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Breeze publishes controllers under the <code>Auth</code> namespace, which you can configure if you need to:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><em>AuthenticatedSessionController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>ConfirmablePasswordController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>EmailVerificationNotificationController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>EmailVerificationPromptController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>NewPasswordController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>PasswordController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>PasswordResetLinkController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>RegisteredUserController.php</em></p>&#13;
</li>&#13;
<li>&#13;
<p><em>VerifyEmailController.php</em></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Instead of controllers, Jetstream (and Fortify, which it depends on) publishes “actions” that you can customize:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Fortify</code><code class="o">/</code><code class="nx">CreateNewUser</code><code class="o">.</code><code class="nx">php</code>&#13;
<code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Fortify</code><code class="o">/</code><code class="nx">PasswordValidationRules</code><code class="o">.</code><code class="nx">php</code>&#13;
<code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Fortify</code><code class="o">/</code><code class="nx">ResetUserPassword</code><code class="o">.</code><code class="nx">php</code>&#13;
<code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Fortify</code><code class="o">/</code><code class="nx">UpdateUserPassword</code><code class="o">.</code><code class="nx">php</code>&#13;
<code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Fortify</code><code class="o">/</code><code class="nx">UpdateUserProfileInformation</code><code class="o">.</code><code class="nx">php</code>&#13;
<code class="nx">app</code><code class="o">/</code><code class="nx">Actions</code><code class="o">/</code><code class="nx">Jetstream</code><code class="o">/</code><code class="nx">DeleteUser</code><code class="o">.</code><code class="nx">php</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Breeze and Jetstream’s Frontend Templates" data-type="sect1"><div class="sect1" id="id438">&#13;
<h1>Breeze and Jetstream’s Frontend Templates</h1>&#13;
&#13;
<p>At<a data-primary="authentication and authorization" data-secondary="Jetstream and Breeze's frontend templates" data-type="indexterm" id="id1322"/><a data-primary="Breeze" data-secondary="frontend templates" data-type="indexterm" id="id1323"/><a data-primary="Jetstream" data-secondary="frontend templates" data-type="indexterm" id="id1324"/> this point you have a migration, a model, controllers/actions, and routes for your authentication system. But what about your views?</p>&#13;
&#13;
<p>You can learn more in <a data-type="xref" href="ch06.html#breeze">“Laravel Breeze”</a> and <a data-type="xref" href="ch06.html#jetstream">“Laravel Jetstream”</a>, but each tool provides multiple different stacks, and each stack keeps its templates in different places.</p>&#13;
&#13;
<p>In general, the JavaScript-based stacks put their templates in <em>resources/js</em> and the Blade-based stacks put them in <em>resources/views</em>.</p>&#13;
&#13;
<p>There’s at least one view for each function (log in, register, reset password, etc.) and they’re all generated with a slick Tailwind-based design, ready to be used or &#13;
<span class="keep-together">customized</span>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="“Remember Me”" data-type="sect1"><div class="sect1" id="id188">&#13;
<h1>“Remember Me”</h1>&#13;
&#13;
<p>Breeze and Jetstream<a data-primary="authentication and authorization" data-secondary="long-lived access tokens (“remember me”)" data-type="indexterm" id="id1325"/><a data-primary="Breeze" data-secondary="long-lived access tokens (“remember me”)" data-type="indexterm" id="id1326"/><a data-primary="Jetstream" data-secondary="long-lived access tokens (“remember me”)" data-type="indexterm" id="id1327"/><a data-primary="“remember me” feature" data-primary-sortas="remember me feature" data-type="indexterm" id="id1328"/><a data-primary="access tokens" data-secondary="long-lived" data-type="indexterm" id="id1329"/> have this implemented out of the box, but it’s still worth learning how it works and how to use it on your own. If you want to implement a “remember me”–style long-lived access token, make sure you have a <code>remember_token</code> column on your <code>users</code> table (which you will if you used the default migration).</p>&#13;
&#13;
<p>When you’re normally logging in a user (and this is how the <code>LoginController</code> does it, with the <code>AuthenticatesUsers</code> trait), you’ll “attempt” an authentication with the user-provided information, like in <a data-type="xref" href="#EX905">Example 9-5</a>.</p>&#13;
<div data-type="example" id="EX905">&#13;
<h5><span class="label">Example 9-5. </span>Attempting a user authentication</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attempt</code><code class="p">([</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'email'</code><code class="p">),</code>&#13;
    <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'password'</code><code class="p">),</code>&#13;
<code class="p">]))</code> <code class="p">{</code>&#13;
    <code class="c1">// Handle the successful login</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>This provides you with a user login that lasts as long as the user’s session. If you want Laravel to extend the login indefinitely using cookies (as long as the user is on the same computer and doesn’t log out), you can pass a Boolean <code>true</code> as the second parameter of the <code>auth()-&gt;attempt()</code> method. Take a look at <a data-type="xref" href="#EX906">Example 9-6</a> to see what that request looks like.</p>&#13;
<div data-type="example" id="EX906">&#13;
<h5><span class="label">Example 9-6. </span>Attempting a user authentication with a “remember me” checkbox check</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attempt</code><code class="p">([</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'email'</code><code class="p">),</code>&#13;
    <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'password'</code><code class="p">),</code>&#13;
<code class="p">],</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">filled</code><code class="p">(</code><code class="s1">'remember'</code><code class="p">)))</code> <code class="p">{</code>&#13;
    <code class="c1">// Handle the successful login</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can see that we checked whether the input has a nonempty (“filled”) <code>remember</code> property, which will return a Boolean. This allows our users to decide if they want to be remembered with a checkbox in the login form.</p>&#13;
&#13;
<p>And later, if you need to manually check whether the current user was authenticated by a remember token, there’s a method for that: <code>auth()-&gt;viaRemember()</code> returns a Boolean, indicating whether or not the current user authenticated via a remember token. This allows you to prevent certain higher-sensitivity features from being accessible by remember token; instead, you can require users to reenter their passwords.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Password Confirmation" data-type="sect1"><div class="sect1" id="id189">&#13;
<h1>Password Confirmation</h1>&#13;
&#13;
<p>It<a data-primary="authentication and authorization" data-secondary="password confirmation" data-type="indexterm" id="id1330"/><a data-primary="password confirmation" data-type="indexterm" id="id1331"/> may be necessary for your users to reconfirm their passwords before accessing certain parts of your application. For example, if a user has been logged in for a while, and then attempts to visit the billing section of your site, you might want them to verify their password.</p>&#13;
&#13;
<p>You can attach a <code>password.confirm</code> middleware to your routes to force this behavior. Once their password is confirmed, the user will be sent to the route they tried to visit initially. After that point, the user won’t have to reconfirm their password for 3 hours; you can change this in the <code>auth.password_timeout</code> configuration setting.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manually Authenticating Users" data-type="sect1"><div class="sect1" id="id439">&#13;
<h1>Manually Authenticating Users</h1>&#13;
&#13;
<p>The<a data-primary="authentication and authorization" data-secondary="manual authentication" data-type="indexterm" id="id1332"/> most common case for user authentication is that you allow the user to provide their credentials, and then use <code>auth()-&gt;attempt()</code> to see whether the provided credentials match any real users. If so, you log them in.</p>&#13;
&#13;
<p>But sometimes there are contexts where it’s valuable for you to be able to choose <span class="keep-together">to log</span> a user in on your own. For example, you may want to allow admin users to switch users.</p>&#13;
&#13;
<p>There are four methods that make this possible. First, you can just pass a user ID:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">loginUsingId</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code></pre>&#13;
&#13;
<p>Second, you can pass a <code>User</code> object (or any other object that implements the <span class="keep-together"><code>Illuminate</code></span><code>\Contracts\Auth\Authenticatable</code> contract):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">login</code><code class="p">(</code><code class="nv">$user</code><code class="p">);</code></pre>&#13;
&#13;
<p>And third and fourth, you can choose to authenticate the given user for only the current request, which won’t impact your session or cookies at all, using <code>once()</code> or <span class="keep-together"><code>onceUsingId()</code>:</span></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">([</code><code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="s1">'mattstauffer'</code><code class="p">]);</code>&#13;
<code class="c1">// or</code>&#13;
<code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">onceUsingId</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code></pre>&#13;
&#13;
<p>Note that the array you pass to the <code>once()</code> method can contain any key/value pairs to uniquely identify the user you’d like to authenticate as. You can even pass multiple keys and values, if it’s what is appropriate for your project. For example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">([</code>&#13;
    <code class="s1">'last_name'</code> <code class="o">=&gt;</code> <code class="s1">'Stauffer'</code><code class="p">,</code>&#13;
    <code class="s1">'zip_code'</code> <code class="o">=&gt;</code> <code class="mi">90210</code><code class="p">,</code>&#13;
<code class="p">])</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manually Logging Out a User" data-type="sect1"><div class="sect1" id="id190">&#13;
<h1>Manually Logging Out a User</h1>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="manual log-out" data-type="indexterm" id="id1333"/><a data-primary="logout() method" data-type="indexterm" id="id1334"/> you ever need to log out a user manually, just call <code>logout()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">logout</code><code class="p">();</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Invalidating Sessions on Other Devices" data-type="sect2"><div class="sect2" id="id191">&#13;
<h2>Invalidating Sessions on Other Devices</h2>&#13;
&#13;
<p>If<a data-primary="logoutOtherDevices() method" data-type="indexterm" id="id1335"/> you’d like to log out a user’s current session on any other devices—​for example, after they’ve changed their password—​you’ll need to prompt the user for their password and pass it to the <code>logoutOtherDevices()</code> method. To do this, you’ll have to apply the <code>auth.session</code> middleware to any routes you want them logged out of (for most projects, that’s the entire app).</p>&#13;
&#13;
<p>Then you can use it inline anywhere you need:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">logoutOtherDevices</code><code class="p">(</code><code class="nv">$password</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you want to give your users a detailed look at what other sessions are active, Jetstream (see <a data-type="xref" href="ch06.html#jetstream">“Laravel Jetstream”</a>) comes out of the box with a page that lists all active sessions and provides a button  to log out of all of them.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Auth Middleware" data-type="sect1"><div class="sect1" id="id440">&#13;
<h1>Auth Middleware</h1>&#13;
&#13;
<p>In <a data-type="xref" href="#EX903">Example 9-3</a>, you<a data-primary="authentication and authorization" data-secondary="auth middleware" data-type="indexterm" id="id1336"/><a data-primary="middleware" data-secondary="Authorize middleware" data-type="indexterm" id="id1337"/> saw how to check whether visitors are logged in and redirect them if not. You could perform these sorts of checks on every route in your application, but it would very quickly get tedious. It turns out that route middleware (see <a data-type="xref" href="ch10.html#requests_and_responses">Chapter 10</a> to learn more about how they work) are a perfect fit for restricting certain routes to guests or to authenticated users.</p>&#13;
&#13;
<p>Once again, Laravel comes with the middleware we need out of the box. You can see which route middleware you have defined in <code>App\Http\Kernel</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">protected</code> <code class="nv">$middlewareAliases</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="s1">'auth'</code> <code class="o">=&gt;</code> <code class="nx">\App\Http\Middleware\Authenticate</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'auth.basic'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'auth.session'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Session\Middleware\AuthenticateSession</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'cache.headers'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Http\Middleware\SetCacheHeaders</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'can'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Auth\Middleware\Authorize</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'guest'</code> <code class="o">=&gt;</code> <code class="nx">\App\Http\Middleware\RedirectIfAuthenticated</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'password.confirm'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Auth\Middleware\RequirePassword</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'signed'</code> <code class="o">=&gt;</code> <code class="nx">\App\Http\Middleware\ValidateSignature</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'throttle'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Routing\Middleware\ThrottleRequests</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="s1">'verified'</code> <code class="o">=&gt;</code> <code class="nx">\Illuminate\Auth\Middleware\EnsureEmailIsVerified</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="p">];</code></pre>&#13;
&#13;
<p>Six of the default route middleware are authentication-related:</p>&#13;
<dl>&#13;
<dt><code>auth</code></dt>&#13;
<dd>&#13;
<p>Restricts route access to authenticated users</p>&#13;
</dd>&#13;
<dt><code>auth.basic</code></dt>&#13;
<dd>&#13;
<p>Restricts access to authenticated users using HTTP Basic Authentication</p>&#13;
</dd>&#13;
<dt><code>auth.session</code></dt>&#13;
<dd>&#13;
<p>Makes routes viable to be disabled using <code>Auth::logoutOtherDevices</code></p>&#13;
</dd>&#13;
<dt><code>can</code></dt>&#13;
<dd>&#13;
<p>Used for authorizing user access to given routes</p>&#13;
</dd>&#13;
<dt><code>guest</code></dt>&#13;
<dd>&#13;
<p>Rstricts access to unauthenticated users</p>&#13;
</dd>&#13;
<dt><code>password.confirm</code></dt>&#13;
<dd>&#13;
<p>Requires users to have recently reconfirmed their password</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>It’s most common to use <code>auth</code> for your authenticated-user-only sections and <code>guest</code> for any routes you don’t want authenticated users to see (like the login form). <code>auth.basic</code> and <code>auth.session</code> are much less commonly used middleware for authenticating.</p>&#13;
&#13;
<p><a data-type="xref" href="#EX907">Example 9-7</a> shows an example of a few routes protected by the <code>auth</code> middleware.</p>&#13;
<div data-type="example" id="EX907">&#13;
<h5><span class="label">Example 9-7. </span>Sample routes protected by auth middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'account'</code><code class="p">,</code> <code class="p">[</code><code class="nx">AccountController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'dashboard'</code><code class="p">]);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'login'</code><code class="p">,</code> <code class="p">[</code><code class="nx">LoginController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'getLogin'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'guest'</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Email Verification" data-type="sect1"><div class="sect1" id="email_verification">&#13;
<h1>Email Verification</h1>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="email verification" data-type="indexterm" id="id1338"/><a data-primary="mail" data-secondary="email verification" data-type="indexterm" id="id1339"/><a data-primary="email verification" data-type="indexterm" id="id1340"/> you’d like to require a user to verify they have access to the email address they registered with, you can reach for Laravel’s email verification feature.</p>&#13;
&#13;
<p>To enable email verification, update your <code>App\User</code> class and make it implement the <code>Illuminate\Contracts\Auth\MustVerifyEmail</code> contract, as shown in <a data-type="xref" href="#EX9a">Example 9-8</a>.</p>&#13;
<div data-type="example" id="EX9a">&#13;
<h5><span class="label">Example 9-8. </span>Adding the <code>MustVerifyEmail</code> trait to an <code>Authenticatable</code> model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Authenticatable</code> <code class="k">implements</code> <code class="nx">MustVerifyEmail</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Notifiable</code><code class="p">;</code>&#13;
&#13;
    <code class="c1">// ...</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The <code>users</code> table must also contain a nullable timestamp column named <code>email_</code><span class="keep-together"><code>verified_at</code></span>, which the default <code>CreateUsersTable</code> migration will have already provided for you.</p>&#13;
&#13;
<p>Finally, you’ll need to enable the email verification routes in your controller. The easiest method is to use <code>Auth::routes()</code> in your routes file with the <code>verify</code> parameter set to <code>true</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Auth</code><code class="o">::</code><code class="na">routes</code><code class="p">([</code><code class="s1">'verify'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">]);</code></pre>&#13;
&#13;
<p>Now, you can protect any routes you’d like from being accessed by any users who haven’t verified their email address:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'posts/create'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Only verified users may enter...</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'verified'</code><code class="p">);</code></pre>&#13;
&#13;
<p>You can customize the route to which users are redirected after verifying in your <span class="keep=together"><code>Verification</code></span><code>Controller</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">protected</code> <code class="nv">$redirectTo</code> <code class="o">=</code> <code class="s1">'/profile'</code><code class="p">;</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Blade Authentication Directives" data-type="sect1"><div class="sect1" id="id441">&#13;
<h1>Blade Authentication Directives</h1>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="Blade authentication directives" data-type="indexterm" id="id1341"/><a data-primary="Blade templating" data-secondary="authentication directives" data-type="indexterm" id="id1342"/> you want to check whether a user is authenticated, not at the route level but in your views, you can do so with <code>@auth</code> and <code>@guest</code> (see <a data-type="xref" href="#EX9b">Example 9-9</a>).</p>&#13;
<div data-type="example" id="EX9b">&#13;
<h5><span class="label">Example 9-9. </span>Checking a user’s authentication status in templates</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">@</code><code class="nx">auth</code>&#13;
    <code class="c1">// The user is authenticated</code>&#13;
<code class="o">@</code><code class="nx">endauth</code>&#13;
&#13;
<code class="o">@</code><code class="nx">guest</code>&#13;
    <code class="c1">// The user is not authenticated</code>&#13;
<code class="o">@</code><code class="nx">endguest</code></pre></div>&#13;
&#13;
<p>You can also specify which guard you’d like to use with both methods by passing the guard name as a parameter, as shown in <a data-type="xref" href="#EX9c">Example 9-10</a>.</p>&#13;
<div data-type="example" id="EX9c">&#13;
<h5><span class="label">Example 9-10. </span>Checking a specific auth guard’s authentication in templates</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">@</code><code class="nx">auth</code><code class="p">(</code><code class="s1">'trainees'</code><code class="p">)</code>&#13;
    <code class="c1">// The user is authenticated</code>&#13;
<code class="o">@</code><code class="nx">endauth</code>&#13;
&#13;
<code class="o">@</code><code class="nx">guest</code><code class="p">(</code><code class="s1">'trainees'</code><code class="p">)</code>&#13;
    <code class="c1">// The user is not authenticated</code>&#13;
<code class="o">@</code><code class="nx">endguest</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Guards" data-type="sect1"><div class="sect1" id="authentication_guards">&#13;
<h1>Guards</h1>&#13;
&#13;
<p>Every<a data-primary="authentication and authorization" data-secondary="guards" data-type="indexterm" id="AAguards00"/><a data-primary="guards (authentication system)" data-type="indexterm" id="guards09"/> aspect of Laravel’s authentication system is routed through something called <span class="keep-together">a <em>guard</em></span>. Each guard is a combination<a data-primary="drivers (authentication system)" data-type="indexterm" id="id1343"/><a data-primary="providers (authentication system)" data-type="indexterm" id="id1344"/> of two pieces: a <em>driver</em> that defines how it persists and retrieves the authentication state (for example, <code>session</code>), and a <em>provider</em> that allows you to get a user by certain criteria (for example, <code>users</code>).</p>&#13;
&#13;
<p>Out of the box, Laravel has two guards: <code>web</code> and <code>api</code>. <code>web</code> is the more traditional authentication style, using the <code>session</code> driver and the basic user provider. <code>api</code> uses the same user provider, but it uses the <code>token</code> driver instead of <code>session</code> to authenticate each request.</p>&#13;
&#13;
<p>You’d change drivers if you wanted to handle the identification and persistence of <span class="keep-together">a user’s</span> identity differently (for example, changing from a long-running session to a provided-every-page-load token), and you’d change providers if you wanted to change the storage type or retrieval methods for your users (for example, storing your users in Mongo instead of MySQL).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Changing the Default Guard" data-type="sect2"><div class="sect2" id="id682">&#13;
<h2>Changing the Default Guard</h2>&#13;
&#13;
<p>The guards are defined in <em>config/auth.php</em>, and you can change them, add new guards, and also define which guard will be the default there. For what it’s worth, this is a relatively uncommon configuration; most Laravel apps just use one guard.</p>&#13;
&#13;
<p>The “default” guard is the one that will be used any time you use any auth features without specifying a guard. For example, <code>auth()-&gt;user()</code> will pull the currently authenticated user using the default guard. You can change this guard by changing the <code>auth.defaults.guard</code> setting in <em>config/auth.php</em>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'defaults'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'guard'</code> <code class="o">=&gt;</code> <code class="s1">'web'</code><code class="p">,</code> <code class="c1">// Change the default here</code>&#13;
    <code class="s1">'passwords'</code> <code class="o">=&gt;</code> <code class="s1">'users'</code><code class="p">,</code>&#13;
<code class="p">],</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Configuration Conventions</h1>&#13;
<p>You may have noticed that I refer to configuration sections with references like <code>auth.defaults.guard</code>. This means that in <em>config/auth.php</em>, in the array section keyed <code>defaults</code>, there should be a property keyed <code>guard</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Other Guards Without Changing the Default" data-type="sect2"><div class="sect2" id="id683">&#13;
<h2>Using Other Guards Without Changing the Default</h2>&#13;
&#13;
<p>If you want to use another guard but <em>not</em> change the default, you can start your <code>auth()</code> calls with <code>guard()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$apiUser</code> <code class="o">=</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">guard</code><code class="p">(</code><code class="s1">'api'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">();</code></pre>&#13;
&#13;
<p>This will, just for this call, get the current user using the <code>api</code> guard.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding a New Guard" data-type="sect2"><div class="sect2" id="id684">&#13;
<h2>Adding a New Guard</h2>&#13;
&#13;
<p>You can add a new guard at any time in <em>config/auth.php</em>, in the <code>auth.guards</code> setting:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'guards'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'trainees'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'session'</code><code class="p">,</code>&#13;
        <code class="s1">'provider'</code> <code class="o">=&gt;</code> <code class="s1">'trainees'</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
<code class="p">],</code></pre>&#13;
&#13;
<p>Here, we’ve created a new guard (in addition to <code>web</code> and <code>api</code>) named <code>trainees</code>. Let’s imagine, for the rest of this section, that we’re building an app where our users are physical trainers, and they each have their <em>own</em> users—​trainees—​who can log in to their subdomains. So, we need a separate guard for them.</p>&#13;
&#13;
<p>The only two options for <code>driver</code> are <code>token</code> and <code>session</code>. Out of the box, the only option for <code>provider</code> is <code>users</code>, which supports authentication against your default <code>users</code> table, but you can create your own provider easily.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Closure Request Guards" data-type="sect2"><div class="sect2" id="id685">&#13;
<h2>Closure Request Guards</h2>&#13;
&#13;
<p>If you want to define a custom guard, and your guard conditions (how to look up a given user against the request) can be described simply enough in response to any given HTTP request, you might just want to throw the user lookup code into a closure and not deal with creating a new custom guard class.</p>&#13;
&#13;
<p>The <code>viaRequest()</code> auth method makes it possible to define a guard (named in the first parameter) using just a closure (defined in the second parameter) that takes the HTTP request and returns the appropriate user. To register a closure request guard, call <code>viaRequest()</code> in the <code>boot()</code> method of your <code>AuthServiceProvider</code>, as shown in <a data-type="xref" href="#EX9d">Example 9-11</a>.</p>&#13;
<div data-type="example" id="EX9d">&#13;
<h5><span class="label">Example 9-11. </span>Defining a closure request guard</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Auth</code><code class="o">::</code><code class="na">viaRequest</code><code class="p">(</code><code class="s1">'token-hash'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">User</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'token-hash'</code><code class="p">,</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">token</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Custom User Provider" data-type="sect2"><div class="sect2" id="id686">&#13;
<h2>Creating a Custom User Provider</h2>&#13;
&#13;
<p>Just below where guards are defined in <em>config/auth.php</em>, there’s an <code>auth.providers</code> section that defines the available providers. Let’s create a new provider named &#13;
<span class="keep-together"><code>trainees</code></span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'providers'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'users'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'eloquent'</code><code class="p">,</code>&#13;
        <code class="s1">'model'</code> <code class="o">=&gt;</code> <code class="nx">App\User</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'trainees'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'eloquent'</code><code class="p">,</code>&#13;
        <code class="s1">'model'</code> <code class="o">=&gt;</code> <code class="nx">App\Trainee</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
<code class="p">],</code></pre>&#13;
&#13;
<p>The two options for <code>driver</code> are <code>eloquent</code> and <code>database</code>. If you use <code>eloquent</code>, you’ll need a <code>model</code> property that contains an Eloquent class name (the model to use for your <code>User</code> class); and if you use <code>database</code>, you’ll need a <code>table</code> property to define which table it should authenticate against.</p>&#13;
&#13;
<p>In our example, you can see that this application has a <code>User</code> and a <code>Trainee</code>, and they need to be authenticated separately. This way, the code can differentiate between <code>auth()-&gt;guard('users')</code> and <code>auth()-&gt;guard('trainees')</code>.</p>&#13;
&#13;
<p>One last note: the <code>auth</code> route middleware can take a parameter that is the guard name. So, you can guard certain routes with a specific guard:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth:trainees'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Trainee-only routes here</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom User Providers for Nonrelational Databases" data-type="sect2"><div class="sect2" id="id194">&#13;
<h2>Custom User Providers for Nonrelational Databases</h2>&#13;
&#13;
<p>The user provider creation flow just described still relies on the same <code>UserProvider</code> class, which means it’s expecting to pull the identifying information out of a relational database. But if you’re using Mongo or Riak or something similar, you’ll actually need to create your own class.</p>&#13;
&#13;
<p>To<a data-primary="" data-startref="AAguards00" data-type="indexterm" id="id1345"/><a data-primary="" data-startref="guards09" data-type="indexterm" id="id1346"/> do this, create a new class that implements the <code>Illuminate\Contracts\Auth\</code><span class="keep-together"><code>UserProvider</code></span> interface, and then bind it in <code>AuthServiceProvider@boot</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">provider</code><code class="p">(</code><code class="s1">'riak'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$app</code><code class="p">,</code> <code class="k">array</code> <code class="nv">$config</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Return an instance of Illuminate\Contracts\Auth\UserProvider...</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">RiakUserProvider</code><code class="p">(</code><code class="nv">$app</code><code class="p">[</code><code class="s1">'riak.connection'</code><code class="p">]);</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Auth Events" data-type="sect1"><div class="sect1" id="id442">&#13;
<h1>Auth Events</h1>&#13;
&#13;
<p>We’ll<a data-primary="authentication and authorization" data-secondary="auth events" data-type="indexterm" id="id1347"/><a data-primary="events" data-secondary="auth events" data-type="indexterm" id="id1348"/> talk more about events in <a data-type="xref" href="ch16.html#queues_jobs_events">Chapter 16</a>, but Laravel’s event system is a basic pub/sub framework. There are system- and user-generated events that are broadcast, and the user has the ability to create event listeners that do certain things in response to certain events.</p>&#13;
&#13;
<p>So, what if you wanted to send a ping to a particular security service every time a user was locked out after too many failed login attempts? Maybe this service watches for a certain number of failed logins from certain geographic regions or something else. You could, of course, inject a call in the appropriate controller. But with events, you can just create an event listener that listens to the “user locked out” event, and register that.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX908">Example 9-12</a> to see all of the events that the authentication system emits.</p>&#13;
<div data-type="example" id="EX908">&#13;
<h5><span class="label">Example 9-12. </span>Authentication events generated by the framework</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">protected</code> <code class="nv">$listen</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Attempting'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Authenticated'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\CurrentDeviceLogout'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Failed'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Lockout'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Login'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Logout'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\OtherDeviceLogout'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\PasswordReset'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Registered'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Validated'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
    <code class="s1">'Illuminate\Auth\Events\Verified'</code> <code class="o">=&gt;</code> <code class="p">[],</code>&#13;
<code class="p">];</code></pre></div>&#13;
&#13;
<p>As you can see, there are listeners for “user registered,” “user attempting login,” “user validated but not logged in,” “user authenticated,” “successful login,” “failed login,” “logout,” “logout from another device,” “logout from current device,” “lockout,” “password reset,” and “user email verified.” To learn more about how to build event listeners for these events, check out <a data-type="xref" href="ch16.html#queues_jobs_events">Chapter 16</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authorization and Roles" data-type="sect1"><div class="sect1" id="id443">&#13;
<h1>Authorization and Roles</h1>&#13;
&#13;
<p>Finally, let’s<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-type="indexterm" id="AAauthrole09"/> cover Laravel’s authorization system. It enables you to determine whether a user is <em>authorized</em> to do a particular thing, which you’ll check using a few primary verbs: <code>can</code>, <code>cannot</code>, <code>allows</code>, and <code>denies</code>.</p>&#13;
&#13;
<p>Most of this authorization control will be performed using the <code>Gate</code> facade, but there are also convenience helpers available in your controllers, on the <code>User</code> model, as middleware, and as Blade directives. Take a look at <a data-type="xref" href="#EX9e">Example 9-13</a> to get a taste of what we’ll be able to do.</p>&#13;
<div data-type="example" id="EX9e">&#13;
<h5><span class="label">Example 9-13. </span>Basic usage of the <code>Gate</code> facade</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">denies</code><code class="p">(</code><code class="s1">'edit-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">Gate</code><code class="o">::</code><code class="na">allows</code><code class="p">(</code><code class="s1">'create-contact'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining Authorization Rules" data-type="sect2"><div class="sect2" id="id195">&#13;
<h2>Defining Authorization Rules</h2>&#13;
&#13;
<p>The<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="rule definition" data-type="indexterm" id="id1349"/><a data-primary="rules, defining authorization" data-type="indexterm" id="id1350"/> default location for defining authorization rules is in the <code>boot()</code> method of the <code>AuthServiceProvider</code>, where you’ll be calling methods on the <code>Auth</code> facade.</p>&#13;
&#13;
<p>An authorization rule is called<a data-primary="ability (authorization system)" data-type="indexterm" id="id1351"/> an <em>ability</em> and comprises two things: a string key (e.g., <code>update-contact</code>) and a closure that returns a Boolean. <a data-type="xref" href="#EX909">Example 9-14</a> shows an ability for updating a contact.</p>&#13;
<div data-type="example" id="EX909">&#13;
<h5><span class="label">Example 9-14. </span>Sample ability for updating a contact</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">AuthServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">==</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user_id</code><code class="p">;</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Let’s walk through the steps for defining an ability.</p>&#13;
&#13;
<p>First, you want to define a key. In naming this key, you should consider what string makes sense in your code’s flow to refer to the ability you’re providing to the user. You can see in <a data-type="xref" href="#EX909">Example 9-14</a> that the code uses the convention <code>{<em>verb</em>}-{<em>modelName</em>}</code>: <code>create-contact</code>, <code>update-contact</code>, etc.</p>&#13;
&#13;
<p>Second, you define the closure. The first parameter will be the currently authenticated user, and all parameters after that will be the object(s) you’re checking for access to—​in this instance, the contact.</p>&#13;
&#13;
<p>So, given those two objects, we can check whether the user is authorized to update this contact. You can write this logic however you want, but in the app we’re looking at in <a data-type="xref" href="#EX909">Example 9-14</a>, authorization depends on being the creator of the contact row. The closure will return <code>true</code> (authorized) if the current user created the contact, and <code>false</code> (unauthorized) if not.</p>&#13;
&#13;
<p>Just like with route definitions, you could also use a class and method instead of a closure to resolve this definition:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$gate</code><code class="o">-&gt;</code><code class="na">define</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="s1">'ContactACLChecker@updateContact'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Gate Facade (and Injecting Gate)" data-type="sect2"><div class="sect2" id="id196">&#13;
<h2>The Gate Facade (and Injecting Gate)</h2>&#13;
&#13;
<p>Now<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="Gate facade" data-type="indexterm" id="id1352"/><a data-primary="Gate facade" data-type="indexterm" id="id1353"/> that you’ve defined an ability, it’s time to test against it. The simplest way is to use the <code>Gate</code> facade, as in <a data-type="xref" href="#EX910">Example 9-15</a> (or you can inject an instance of <code>Illuminate\Contracts\Auth\Access\Gate</code>).</p>&#13;
<div data-type="example" id="EX910">&#13;
<h5><span class="label">Example 9-15. </span>Basic <code>Gate</code> facade usage</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">allows</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Update contact</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">denies</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You might also define an ability with multiple parameters—​maybe contacts can be in groups, and you want to authorize whether the user has access to add a contact to a group. <a data-type="xref" href="#EX911">Example 9-16</a> shows how to do this.</p>&#13;
<div data-type="example" id="EX911">&#13;
<h5><span class="label">Example 9-16. </span>Abilities with multiple parameters</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Definition</code>&#13;
<code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'add-contact-to-group'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">,</code> <code class="nv">$group</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">==</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user_id</code> <code class="o">&amp;&amp;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">==</code> <code class="nv">$group</code><code class="o">-&gt;</code><code class="na">user_id</code><code class="p">;</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Usage</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">denies</code><code class="p">(</code><code class="s1">'add-contact-to-group'</code><code class="p">,</code> <code class="p">[</code><code class="nv">$contact</code><code class="p">,</code> <code class="nv">$group</code><code class="p">]))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>And if you need to check authorization for a user other than the currently authenticated user, try <code>forUser()</code>, like in <a data-type="xref" href="#EX912">Example 9-17</a>.</p>&#13;
<div data-type="example" id="EX912">&#13;
<h5><span class="label">Example 9-17. </span>Specifying the user for <code>Gate</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">forUser</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">denies</code><code class="p">(</code><code class="s1">'create-contact'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Resource Gates" data-type="sect2"><div class="sect2" id="id197">&#13;
<h2>Resource Gates</h2>&#13;
&#13;
<p>The<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="resource gates" data-type="indexterm" id="id1354"/><a data-primary="resource gates" data-type="indexterm" id="id1355"/> most common use for access control lists is to define access to individual “resources” (think an Eloquent model, or something you’re allowing users to administer from their admin panel).</p>&#13;
&#13;
<p>The <code>resource()</code> method makes it possible to apply the four most common gates, <code>view</code>, <code>create</code>, <code>update</code>, and <code>delete</code>, to a single resource at once:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Gate</code><code class="o">::</code><code class="na">resource</code><code class="p">(</code><code class="s1">'photos'</code><code class="p">,</code> <code class="s1">'App\Policies\PhotoPolicy'</code><code class="p">);</code></pre>&#13;
&#13;
<p>This is equivalent to defining the following:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'photos.view'</code><code class="p">,</code> <code class="s1">'App\Policies\PhotoPolicy@view'</code><code class="p">);</code>&#13;
<code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'photos.create'</code><code class="p">,</code> <code class="s1">'App\Policies\PhotoPolicy@create'</code><code class="p">);</code>&#13;
<code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'photos.update'</code><code class="p">,</code> <code class="s1">'App\Policies\PhotoPolicy@update'</code><code class="p">);</code>&#13;
<code class="nx">Gate</code><code class="o">::</code><code class="na">define</code><code class="p">(</code><code class="s1">'photos.delete'</code><code class="p">,</code> <code class="s1">'App\Policies\PhotoPolicy@delete'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Authorize Middleware" data-type="sect2"><div class="sect2" id="id198">&#13;
<h2>The Authorize Middleware</h2>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="Authorize middleware" data-type="indexterm" id="id1356"/><a data-primary="Authorize middleware" data-type="indexterm" id="id1357"/><a data-primary="middleware" data-secondary="Authorize middleware" data-type="indexterm" id="id1358"/> you want to authorize entire routes, you can use the <code>Authorize</code> middleware (which has a shortcut of <code>can</code>), like in <a data-type="xref" href="#EX913">Example 9-18</a>.</p>&#13;
<div data-type="example" id="EX913">&#13;
<h5><span class="label">Example 9-18. </span>Using the <code>Authorize</code> middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'people/create'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Create a person</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'can:create-person'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'people/{person}/edit'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Edit person</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'can:edit,person'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Here, the <code>{person}</code> parameter (whether it’s defined as a string or as a bound route model) will be passed to the ability method as an additional parameter.</p>&#13;
&#13;
<p>The first check in <a data-type="xref" href="#EX913">Example 9-18</a> is a normal ability, but the second is a policy, which we’ll talk about in <a data-type="xref" href="#policies">“Policies”</a>.</p>&#13;
&#13;
<p>If you need to check for an action that doesn’t require a model instance (for example, <code>create</code>, unlike <code>edit</code>, doesn’t get passed an actual route model–bound instance), you can just pass the class name:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'people'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Create a person</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'can:create,App\Person'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Controller Authorization" data-type="sect2"><div class="sect2" id="id199">&#13;
<h2>Controller Authorization</h2>&#13;
&#13;
<p>The<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="controller authorization" data-type="indexterm" id="id1359"/><a data-primary="controller authorization" data-type="indexterm" id="id1360"/> parent <code>App\Http\Controllers\Controller</code> class in Laravel imports the <span class="keep-together"><code>Authorizes</code></span><code>Requests</code> trait, which provides three methods for authorization: <span class="keep-together"><code>authorize()</code>,</span> <code>authorizeForUser()</code>, and <code>authorizeResource()</code>.</p>&#13;
&#13;
<p><code>authorize()</code> takes an ability key and an object (or array of objects) as parameters, and if the authorization fails, it’ll quit the application with a 403 (Unauthorized) status code. That means this feature can turn three lines of authorization code into just one, as you can see in <a data-type="xref" href="#EX914">Example 9-19</a>.</p>&#13;
<div data-type="example" id="EX914">&#13;
<h5><span class="label">Example 9-19. </span>Simplifying controller authorization with <code>authorize()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// From this:</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">edit</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">cannot</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'contacts.edit'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'contact'</code> <code class="o">=&gt;</code> <code class="nv">$contact</code><code class="p">]);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// To this:</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">edit</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'update-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'contacts.edit'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'contact'</code> <code class="o">=&gt;</code> <code class="nv">$contact</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p><code>authorizeForUser()</code> is the same, but allows you to pass in a <code>User</code> object instead of defaulting to the currently authenticated user:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorizeForUser</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="s1">'update-contact'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code></pre>&#13;
&#13;
<p><code>authorizeResource()</code>, called once in the controller constructor, maps a predefined set of authorization rules to each of the RESTful controller methods in that controller—​something like <a data-type="xref" href="#EX915">Example 9-20</a>.</p>&#13;
<div data-type="example" id="EX915">&#13;
<h5><span class="label">Example 9-20. </span>The authorization-to-method mappings of <code>authorizeResource()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">ContactController</code> <code class="k">extends</code> <code class="nx">Controller</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// This call does everything you see in the methods below.</code>&#13;
        <code class="c1">// If you put this here, you can remove all authorize()</code>&#13;
        <code class="c1">// calls in the individual resource methods here.</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorizeResource</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'viewAny'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">create</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'create'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'create'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'view'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">edit</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">update</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">destroy</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">authorize</code><code class="p">(</code><code class="s1">'delete'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Checking the User Instance" data-type="sect2"><div class="sect2" id="id200">&#13;
<h2>Checking the User Instance</h2>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="checking user instance" data-type="indexterm" id="id1361"/> you’re not in a controller, you’re more likely to be checking the capabilities of a specific user than the currently authenticated user. That’s already possible with the <code>Gate</code> facade using the <code>forUser()</code> method, but sometimes the syntax can feel a little off.</p>&#13;
&#13;
<p>Thankfully,<a data-primary="Authorizable trait" data-type="indexterm" id="id1362"/> the <code>Authorizable</code> trait on the <code>User</code> class provides four methods to <span class="keep-together">make a</span> more readable authorization feature: <code>$user-&gt;can()</code>, <code>$user→canAny()</code>, <code>$user-&gt;cant()</code>, and <code>$user-&gt;cannot()</code>. As you can probably guess, <code>cant()</code> and <code>cannot()</code> do the same thing, and <code>can()</code> is their exact inverse. With <code>canAny()</code>, you pass an array of permissions, and this method checks if the user can do any of them.</p>&#13;
&#13;
<p>That means you can do something like <a data-type="xref" href="#EX916">Example 9-21</a>.</p>&#13;
<div data-type="example" id="EX916">&#13;
<h5><span class="label">Example 9-21. </span>Checking authorization on a <code>User</code> instance</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">can</code><code class="p">(</code><code class="s1">'create-contact'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do something</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Behind the scenes, these methods are just passing your parameters to <code>Gate</code>; in the preceding example, <code>Gate::forUser($user)-&gt;check('create-contact')</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Blade Checks" data-type="sect2"><div class="sect2" id="id444">&#13;
<h2>Blade Checks</h2>&#13;
&#13;
<p>Blade<a data-primary="Blade templating" data-secondary="authorization and roles" data-type="indexterm" id="id1363"/><a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="Blade checks" data-type="indexterm" id="id1364"/> also has a little convenience helper: the <code>@can</code> directive. <a data-type="xref" href="#EX917">Example 9-22</a> illustrates <span class="keep-together">its usage.</span></p>&#13;
<div data-type="example" id="EX917">&#13;
<h5><span class="label">Example 9-22. </span>Using Blade’s <code>@can</code> directive</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">nav</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"/"</code><code class="p">&gt;</code>Home<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>&#13;
    @can('edit-contact', $contact)&#13;
        <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"{{ route('contacts.edit', [$contact-&gt;id]) }}"</code><code class="p">&gt;</code>Edit This Contact<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code>&#13;
    @endcan&#13;
<code class="p">&lt;/</code><code class="nt">nav</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>You can also use <code>@else</code> in between <code>@can</code> and <code>@endcan</code>, and you can use <code>@cannot</code> and <code>@endcannot</code> as in <a data-type="xref" href="#EX918">Example 9-23</a>.</p>&#13;
<div data-type="example" id="EX918">&#13;
<h5><span class="label">Example 9-23. </span>Using Blade’s <code>@cannot</code> directive</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">h1</code><code class="p">&gt;</code>{{ $contact-&gt;name }}<code class="p">&lt;/</code><code class="nt">h1</code><code class="p">&gt;</code>&#13;
@cannot('edit-contact', $contact)&#13;
    LOCKED&#13;
@endcannot</pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Intercepting Checks" data-type="sect2"><div class="sect2" id="id575">&#13;
<h2>Intercepting Checks</h2>&#13;
&#13;
<p>If<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="intercepting checks" data-type="indexterm" id="id1365"/> you’ve ever built an app with an admin user class, you’ve probably looked at all of the simple authorization closures so far in this chapter and thought about how you could add a superuser class that overrides these checks in every case. Thankfully, there’s already a tool for that.</p>&#13;
&#13;
<p>In <code>AuthServiceProvider</code>, where you’re already defining your abilities, you can also add a <code>before()</code> check that runs before all the others and can optionally override them, like in <a data-type="xref" href="#EX919">Example 9-24</a>.</p>&#13;
<div data-type="example" id="EX919">&#13;
<h5><span class="label">Example 9-24. </span>Overriding <code>Gate</code> checks with <code>before()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Gate</code><code class="o">::</code><code class="na">before</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$ability</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">isOwner</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Note that the string name for the ability is also passed in, so you can differentiate your <code>before()</code> hooks based on your ability naming scheme.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Policies" data-type="sect2"><div class="sect2" id="policies">&#13;
<h2>Policies</h2>&#13;
&#13;
<p>Up<a data-primary="authentication and authorization" data-secondary="authorization and roles" data-tertiary="policies" data-type="indexterm" id="id1366"/><a data-primary="policies (authorization system)" data-type="indexterm" id="policies09"/> until this point, all of the access controls have required you to manually associate Eloquent models with the ability names. You could have created an ability named something like <code>visit-dashboard</code> that’s not related to a specific Eloquent model, but you’ll probably have noticed that most of our examples have had to do with <em>doing something to something</em>—and in most of these cases, the <em>something</em> that’s the recipient of the action is an Eloquent model.</p>&#13;
&#13;
<p>Authorization policies are organizational structures that help you group your authorization logic based on the resource you’re controlling access to. They make it easy to manage defining authorization rules for behavior toward a particular Eloquent model (or other PHP class) all together in a single location.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generating policies" data-type="sect3"><div class="sect3" id="id687">&#13;
<h3>Generating policies</h3>&#13;
&#13;
<p>Policies are PHP classes, which can be generated with an Artisan command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:policy<code class="w"> </code>ContactPolicy<code class="w"/></pre>&#13;
&#13;
<p>Once they’re generated, they need to be registered. The <code>AuthServiceProvider</code> has a <code>$policies</code> property, which is an array. The key of each item is the class name of the protected resource (almost always an Eloquent class), and the value is the policy class name. <a data-type="xref" href="#EX9f">Example 9-25</a> shows what this will look like.</p>&#13;
<div data-type="example" id="EX9f">&#13;
<h5><span class="label">Example 9-25. </span>Registering policies in <code>AuthServiceProvider</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">AuthServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$policies</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code> <code class="o">=&gt;</code> <code class="nx">ContactPolicy</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="p">];</code></pre></div>&#13;
&#13;
<p>A policy class that’s generated by Artisan doesn’t have any special properties or methods. But every method that you add is now mapped as an ability key for this object.</p>&#13;
<div data-type="note" epub:type="note"><h1>Policy Auto-discovery</h1>&#13;
<p>Laravel tries to “guess” the links between your policies and their corresponding models. For example, it’ll apply the <code>PostPolicy</code> to your <code>Post</code> model automatically.</p>&#13;
&#13;
<p>If you need to customize the logic Laravel uses to guess this mapping, check out the <a href="https://oreil.ly/P5gC2">Policy docs</a>.</p>&#13;
</div>&#13;
&#13;
<p>Let’s define an <code>update()</code> method to take a look at how it works (<a data-type="xref" href="#EX920">Example 9-26</a>).</p>&#13;
<div data-type="example" id="EX920">&#13;
<h5><span class="label">Example 9-26. </span>A sample <code>update()</code> policy method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Policies</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ContactPolicy</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">update</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">==</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user_id</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Notice that the contents of this method look exactly like they would in a <code>Gate</code> <span class="keep-together">definition.</span></p>&#13;
<div data-type="note" epub:type="note"><h1>Policy Methods That Don’t Take an Instance</h1>&#13;
<p>What if you want to define a policy method that relates to the class but not a specific instance—​for example, “can this user create contacts at all?” rather than just “can this user view this specific contact?” You can treat this just like a normal policy method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">ContactPolicy</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">create</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">canCreateContacts</code><code class="p">();</code>&#13;
    <code class="p">}</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Checking policies" data-type="sect3"><div class="sect3" id="id688">&#13;
<h3>Checking policies</h3>&#13;
&#13;
<p>If there’s a policy defined for a resource type, the <code>Gate</code> facade will use the first parameter <span class="keep-together">to figure</span> out which method to check on the policy. If you run <code class="keep-together">Gate</code><code>::allows</code><code class="keep-together">('update',</code><code> $contact)</code>, it will check the <code>ContactPolicy@update</code> method for authorization.</p>&#13;
&#13;
<p>This also works for the <code>Authorize</code> middleware and for <code>User</code> model checking and Blade checking, as seen in <a data-type="xref" href="#EX921">Example 9-27</a>.</p>&#13;
<div data-type="example" id="EX921">&#13;
<h5><span class="label">Example 9-27. </span>Checking authorization against a policy</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Gate</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nx">Gate</code><code class="o">::</code><code class="na">denies</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Gate if you don't have an explicit instance</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="o">!</code> <code class="nx">Gate</code><code class="o">::</code><code class="na">check</code><code class="p">(</code><code class="s1">'create'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="nx">abort</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// User</code>&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">can</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do stuff</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Blade</code>&#13;
<code class="o">@</code><code class="nx">can</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="c1">// Show stuff</code>&#13;
<code class="o">@</code><code class="nx">endcan</code></pre></div>&#13;
&#13;
<p class="pagebreak-before">Additionally, there’s a <code>policy()</code> helper that allows you to retrieve a policy class and run its methods:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">policy</code><code class="p">(</code><code class="nv">$contact</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$contact</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do stuff</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Overriding policies" data-type="sect3"><div class="sect3" id="id202">&#13;
<h3>Overriding policies</h3>&#13;
&#13;
<p>Just like with normal ability definitions, policies can define a <code>before()</code> method that allows you to override any call before it’s even processed (see <a data-type="xref" href="#EX922">Example 9-28</a>).<a data-primary="" data-startref="AAauthrole09" data-type="indexterm" id="id1367"/><a data-primary="" data-startref="policies09" data-type="indexterm" id="id1368"/></p>&#13;
<div data-type="example" id="EX922">&#13;
<h5><span class="label">Example 9-28. </span>Overriding policies with the <code>before()</code> method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">before</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nv">$ability</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">isAdmin</code><code class="p">())</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">true</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id203">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Application tests<a data-primary="testing" data-secondary="authentication and authorization" data-type="indexterm" id="Taa09"/><a data-primary="authentication and authorization" data-secondary="testing" data-type="indexterm" id="AAtest09"/> often need to perform a particular behavior on behalf of a particular user. We therefore need to be able to authenticate as a user in application tests, and we need to test authorization rules and authentication routes.</p>&#13;
&#13;
<p>Of course, it’s possible to write an application test that manually visits the login page and then fills out the form and submits it, but that’s not necessary. Instead, the simplest option is to use the <code>-&gt;be()</code> method to simulate being logged in as a user. Take a look at <a data-type="xref" href="#EX923">Example 9-29</a>.</p>&#13;
<div data-type="example" id="EX923">&#13;
<h5><span class="label">Example 9-29. </span>Authenticating as a user in application tests</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_creates_a_new_contact</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">be</code><code class="p">(</code><code class="nv">$user</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">,</code>&#13;
        <code class="s1">'user_id'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can also use, and chain, the <code>actingAs()</code> method instead of <code>be()</code>, if you prefer how it reads:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_creates_a_new_contact</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">,</code>&#13;
        <code class="s1">'user_id'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>We can also test authorization like in <a data-type="xref" href="#EX924">Example 9-30</a>.</p>&#13;
<div data-type="example" id="EX924">&#13;
<h5><span class="label">Example 9-30. </span>Testing authorization rules</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_non_admins_cant_create_users</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
        <code class="s1">'admin'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">be</code><code class="p">(</code><code class="nv">$user</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseMissing</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Or we can test for a 403 response like in <a data-type="xref" href="#EX925">Example 9-31</a>.</p>&#13;
<div data-type="example" id="EX925">&#13;
<h5><span class="label">Example 9-31. </span>Testing authorization rules by checking status code</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_non_admins_cant_create_users</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
        <code class="s1">'admin'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">be</code><code class="p">(</code><code class="nv">$user</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'my@email.com'</code><code class="p">]);</code>&#13;
&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">403</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We need to test that our authentication (signup and signin) routes work too, as illustrated in <a data-type="xref" href="#EX926">Example 9-32</a>.</p>&#13;
<div data-type="example" id="EX926">&#13;
<h5><span class="label">Example 9-32. </span>Testing authentication routes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_users_can_register</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'register'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Sal Leibowitz'</code><code class="p">,</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'sal@leibs.net'</code><code class="p">,</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="s1">'abcdefg123'</code><code class="p">,</code>&#13;
        <code class="s1">'password_confirmation'</code> <code class="o">=&gt;</code> <code class="s1">'abcdefg123'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Sal Leibowitz'</code><code class="p">,</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'sal@leibs.net'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_users_can_log_in</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">Hash</code><code class="o">::</code><code class="na">make</code><code class="p">(</code><code class="s1">'abcdefg123'</code><code class="p">)</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'login'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">,</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="s1">'abcdefg123'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">check</code><code class="p">());</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">is</code><code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()));</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We can also use the integration test features to direct the test to “click” our authentication fields and “submit” the fields to test the entire flow. We’ll talk about that more in <a data-type="xref" href="ch12.html#testing">Chapter 12</a>.<a data-primary="" data-startref="AAtest09" data-type="indexterm" id="id1369"/><a data-primary="" data-startref="Taa09" data-type="indexterm" id="id1370"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id445">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Between<a data-primary="authentication and authorization" data-secondary="overview of" data-type="indexterm" id="id1371"/> the default <code>User</code> model, the <code>create_users_table</code> migration, and Jetstream and Breeze, Laravel provides options for a full user authentication system out of the box. Breeze handles the authentication functionality in controllers and Jetstream handles it in Actions, both of which can be customized for each app. Both tools also publish config files and templates for customization.</p>&#13;
&#13;
<p>The <code>Auth</code> facade and the <code>auth()</code> global helper provide access to the current user (<code>auth()-&gt;user()</code>) and make it easy to check whether a user is logged in (<code>auth()</code><code class="keep-together">-&gt;check()</code> and <code>auth()-&gt;guest()</code>).</p>&#13;
&#13;
<p>Laravel also has an authorization system built in that allows you to define specific abilities (<code>create-contact</code>, <code>visit-secret-page</code>) or define policies for user interaction with entire models.</p>&#13;
&#13;
<p>You can check for authorization with the <code>Gate</code> facade, the <code>can()</code> and <code>cannot()</code> methods on the <code>User</code> class, the <code>@can</code> and <code>@cannot</code> directives in Blade, the <code class="keep-together">authorize()</code> methods on the controller, or the <code>can</code> middleware.</p>&#13;
</div></section>&#13;
</div></section></body></html>