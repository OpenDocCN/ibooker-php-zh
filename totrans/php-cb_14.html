<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>PHP Cookbook</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Performance Tuning"><div class="chapter" id="chapter_performance">
<h1><span class="label">Chapter 14. </span>Performance Tuning</h1>


<p>Dynamically interpreted languages, such as PHP, are known for their flexibility and ease of use but not necessarily for their speed. This is partly because of the way their type systems work. When types <a data-type="indexterm" data-primary="performance tuning" id="idm45875141560992"></a>are inferred at runtime, it’s impossible for the parser to know exactly how to perform a certain operation until it’s provided with data.</p>

<p>Consider the following, loosely typed PHP function to add two items together:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="nv">$a</code> <code class="o">+</code> <code class="nv">$b</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Since this function does not declare the types for the variables passed in or the return type, it can exhibit multiple signatures. All of the method signatures in <a data-type="xref" href="#various_signatures">Example 14-1</a> are equally valid ways to call the preceding function.</p>
<div id="various_signatures" data-type="example">
<h5><span class="label">Example 14-1. </span>Various signatures for the same function definition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nx">add</code><code class="p">(</code><code class="nx">int</code><code> </code><code class="nv">$a</code><code class="p">,</code><code>    </code><code class="nx">int</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code>   </code><code class="nx">int</code><code> </code><a class="co" id="co_performance_tuning_CO1-1" href="#callout_performance_tuning_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nx">add</code><code class="p">(</code><code class="nx">float</code><code> </code><code class="nv">$a</code><code class="p">,</code><code>  </code><code class="nx">float</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code> </code><code class="nx">float</code><code> </code><a class="co" id="co_performance_tuning_CO1-2" href="#callout_performance_tuning_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
</code><code class="nx">add</code><code class="p">(</code><code class="nx">int</code><code> </code><code class="nv">$a</code><code class="p">,</code><code>    </code><code class="nx">float</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code> </code><code class="nx">float</code><code> </code><a class="co" id="co_performance_tuning_CO1-3" href="#callout_performance_tuning_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="nx">add</code><code class="p">(</code><code class="nx">float</code><code> </code><code class="nv">$a</code><code class="p">,</code><code>  </code><code class="nx">int</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code>   </code><code class="nx">float</code><code> </code><a class="co" id="co_performance_tuning_CO1-4" href="#callout_performance_tuning_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a><code>
</code><code class="nx">add</code><code class="p">(</code><code class="nx">string</code><code> </code><code class="nv">$a</code><code class="p">,</code><code> </code><code class="nx">int</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code>   </code><code class="nx">int</code><code> </code><a class="co" id="co_performance_tuning_CO1-5" href="#callout_performance_tuning_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a><code>
</code><code class="nx">add</code><code class="p">(</code><code class="nx">string</code><code> </code><code class="nv">$a</code><code class="p">,</code><code> </code><code class="nx">int</code><code> </code><code class="nv">$b</code><code class="p">)</code><code class="o">:</code><code>   </code><code class="nx">float</code><code> </code><a class="co" id="co_performance_tuning_CO1-6" href="#callout_performance_tuning_CO1-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_performance_tuning_CO1-1" href="#co_performance_tuning_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p><code>add(1, 2)</code> returns <code>int(3)</code></p></dd>
<dt><a class="co" id="callout_performance_tuning_CO1-2" href="#co_performance_tuning_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p><code>add(1., 2.)</code> returns <code>float(3)</code></p></dd>
<dt><a class="co" id="callout_performance_tuning_CO1-3" href="#co_performance_tuning_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p><code>add(1, 2.)</code> returns <code>float(3)</code></p></dd>
<dt><a class="co" id="callout_performance_tuning_CO1-4" href="#co_performance_tuning_CO1-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p><code>add(1., 2)</code> returns <code>float(3)</code></p></dd>
<dt><a class="co" id="callout_performance_tuning_CO1-5" href="#co_performance_tuning_CO1-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p><code>add("1", 2)</code> returns <code>int(3)</code></p></dd>
<dt><a class="co" id="callout_performance_tuning_CO1-6" href="#co_performance_tuning_CO1-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p><code>add("1.", 2)</code> returns <code>float(3)</code></p></dd>
</dl></div>

<p>The preceding example illustrates how you can write a single function and PHP internally needs to process it multiple ways. The language doesn’t know which version of the function you actually need until it sees the data you provide it, and it will internally cast some values to other types where necessary. At runtime, though, the actual function is compiled to operation code (opcode) that runs on the processor through a dedicated virtual machine—and PHP will need to produce multiple versions of the same function’s opcode to handle the differing input and return types.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The loose typing system leveraged <a data-type="indexterm" data-primary="strict typing" id="idm45875141378208"></a><a data-type="indexterm" data-primary="loose typing" id="idm45875141377504"></a>by PHP is one of the things that makes it so easy to learn but also so easy to make fatal programming mistakes. This book has taken care to leverage <em>strict typing</em> wherever possible to avoid these exact pitfalls. Review <a data-type="xref" href="ch03.html#argument_and_return_typing">Recipe 3.4</a> for more on using strict typing in your own code.</p>
</div>

<p>With a compiled language, the problem expressed here about loose typing would be trivial—merely compile the program to the multiple forks of opcode and move on. Unfortunately, PHP is more of an interpreted language; it reloads and recompiles your script on demand, depending on how your application is loaded. Luckily, the performance drain of multiple code paths can be combatted with two modern features built into the very language itself: just-in-time (JIT) compilation and the caching of opcode.</p>








<section data-type="sect2" data-pdf-bookmark="Just-In-Time Compilation"><div class="sect2" id="idm45875141374688">
<h2>Just-In-Time Compilation</h2>

<p>As of version 8.0, PHP <a href="https://oreil.ly/XS9gg">ships with a JIT compiler</a> that immediately enables faster <a data-type="indexterm" data-primary="JIT (just-in-time) compilation" id="idm45875141372624"></a>program execution and better-performing applications. It does this by leveraging traces of actual instructions passed to <a data-type="indexterm" data-primary="VM (virtual machine)" id="idm45875141371760"></a>the virtual machine (VM) handling the script’s execution. When a particular trace is called frequently, PHP will automatically recognize the importance of the operation and gauge whether or not the code benefits from compilation.</p>

<p>Subsequent invocations of the same code will use the compiled byte code rather than the dynamic script, causing a significant performance boost. Based on <a href="https://oreil.ly/LpZ3w">metrics published by Zend when PHP 8.0 was released</a>, the inclusion of a JIT compiler renders the PHP benchmark suite to be up to three times faster!</p>

<p>The point to remember is that JIT compilation primarily benefits low-level algorithms. This includes number crunching and raw data manipulation. Anything 
<span class="keep-together">outside</span> of CPU-intensive operations (e.g., graphics manipulation or heavy database integrations) won’t see nearly as much benefit to these changes. However, knowing that the JIT compiler exists, you can take advantage of it and use PHP in new ways.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Opcode Caching"><div class="sect2" id="idm45875141368384">
<h2>Opcode Caching</h2>

<p>Among the easiest ways to <a data-type="indexterm" data-primary="caching, Opcache" id="idm45875141366704"></a><a data-type="indexterm" data-primary="opcode caching" id="idm45875141366000"></a>increase performance—indeed, the way the JIT compiler does so—is to cache expensive operations and reference the result rather than doing the operations again and again. Since version 5.5, PHP has shipped with an optional extension for caching precompiled byte code in memory called <a href="https://oreil.ly/wH2ue">OPcache</a>.<sup><a data-type="noteref" id="idm45875141364544-marker" href="ch14.html#idm45875141364544">1</a></sup></p>

<p>Remember, PHP is primarily a dynamic script interpreter and will read in your scripts when the program starts. If you stop and start your application frequently, PHP will need to recompile your script to computer-readable byte code in order for the code to execute properly. Frequent starts/stops can force frequent recompiling of scripts and thus slow performance. The OPcache, however, allows you to selectively compile scripts to provide the byte code to PHP before the rest of the application runs. This removes the need for PHP to load and parse the scripts each time!</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The JIT compiler in PHP 8 and above can only be enabled if <a data-type="indexterm" data-primary="JIT (just-in-time) compilation" data-secondary="OPcache and" id="idm45875141362016"></a>OPcache is also enabled on the server, since it uses the cache as its shared memory backend. However, you do not need to use the JIT compiler to use OPcache itself.</p>
</div>

<p>Both JIT compilation and opcode caching are low-level performance improvements to the language that you can easily leverage at runtime, but they’re not the end of the story. It’s also critical to understand how to time the execution of user-defined functions. This makes identifying bottlenecks in business logic relatively easy. Comprehensively benchmarking the application also helps gauge performance changes when deploying to new environments, on new releases of the language, or with updated dependencies down the road.</p>

<p>The following recipes describe both the timing/benchmarking of userland application code and how to leverage the language-level opcode cache to optimize the performance of your application and environment.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="14.1 Timing Function Execution"><div class="sect1" id="idm45875141359664">
<h1>14.1 Timing Function Execution</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875141358304">
<h2>Problem</h2>

<p>You want to understand how long it takes a <a data-type="indexterm" data-primary="performance tuning" data-secondary="function execution timing" id="pftfxtm"></a><a data-type="indexterm" data-primary="functions" data-secondary="execution timing" id="fcxctm"></a>particular function to execute in order to identify potential opportunities for optimization.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875141353888">
<h2>Solution</h2>

<p>Leverage PHP’s built-in <code>hrtime()</code> function <a data-type="indexterm" data-primary="hrtime() function" id="htmfct"></a><a data-type="indexterm" data-primary="functions" data-secondary="hrtime()" id="fcnshtm"></a>both before and after function execution to determine how long the function took to run. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$start</code> <code class="o">=</code> <code class="nb">hrtime</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>

<code class="nx">doSomethingComputationallyExpensive</code><code class="p">();</code>

<code class="nv">$totalTime</code> <code class="o">=</code> <code class="p">(</code><code class="nb">hrtime</code><code class="p">(</code><code class="k">true</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$start</code><code class="p">)</code> <code class="o">/</code> <code class="mf">1e+9</code><code class="p">;</code>

<code class="k">echo</code> <code class="s2">"Function took </code><code class="si">{</code><code class="nv">$totalTime</code><code class="si">}</code><code class="s2"> seconds."</code> <code class="o">.</code> <code class="nx">PHP_EOL</code><code class="p">;</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875141332368">
<h2>Discussion</h2>

<p>The <code>hrtime()</code> function will return the system’s built-in high-resolution time, counting from an arbitrary point in time defined by the system. By default, it returns an array of two integers—seconds and nanoseconds, respectively. Passing <code>true</code> to the function will instead return the total number of nanoseconds, requiring you to divide by <code>1e+9</code> to convert the raw output back to human-readable seconds.</p>

<p>A slightly fancier approach is to abstract the timing mechanism into a decorator object. As covered in <a data-type="xref" href="ch08.html#chapter_classes">Chapter 8</a>, a decorator is a programming design pattern that allows you to extend the functionality of a single function call (or a whole class) by wrapping it in another class implementation. In this case, you want to trigger the use of <code>hrtime()</code> to time a function’s execution without changing the function itself. The decorator in <a data-type="xref" href="#timed_decorator_object">Example 14-2</a> would do exactly that.</p>
<div id="timed_decorator_object" data-type="example">
<h5><span class="label">Example 14-2. </span>A timed decorator object for measuring function call performance</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code><code> </code><code class="nc">TimerDecorator</code><code>
</code><code class="p">{</code><code>
    </code><code class="k">private</code><code> </code><code class="nx">int</code><code> </code><code class="nv">$calls</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code>
    </code><code class="k">private</code><code> </code><code class="nx">float</code><code> </code><code class="nv">$totalRuntime</code><code> </code><code class="o">=</code><code> </code><code class="mf">0.</code><code class="p">;</code><code>

    </code><code class="k">public</code><code> </code><code class="k">function</code><code> </code><code class="fm">__construct</code><code class="p">(</code><code class="k">public</code><code> </code><code class="nv">$callback</code><code class="p">,</code><code> </code><code class="k">private</code><code> </code><code class="nx">bool</code><code> </code><code class="nv">$verbose</code><code> </code><code class="o">=</code><code> </code><code class="k">false</code><code class="p">)</code><code> </code><code class="p">{}</code><code>

    </code><code class="k">public</code><code> </code><code class="k">function</code><code> </code><code class="fm">__invoke</code><code class="p">(</code><code class="o">...</code><code class="nv">$args</code><code class="p">)</code><code class="o">:</code><code> </code><code class="nx">mixed</code><code> </code><a class="co" id="co_performance_tuning_CO2-1" href="#callout_performance_tuning_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
    </code><code class="p">{</code><code>
        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code> </code><code class="nb">is_callable</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">callback</code><code class="p">))</code><code> </code><code class="p">{</code><code>
            </code><code class="k">throw</code><code> </code><code class="k">new</code><code> </code><code class="nx">ValueError</code><code class="p">(</code><code class="s1">'Class does not wrap a callable function!'</code><code class="p">);</code><code>
        </code><code class="p">}</code><code>

        </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">calls</code><code> </code><code class="o">+=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>
        </code><code class="nv">$start</code><code> </code><code class="o">=</code><code> </code><code class="nb">hrtime</code><code class="p">(</code><code class="k">true</code><code class="p">);</code><code> </code><a class="co" id="co_performance_tuning_CO2-2" href="#callout_performance_tuning_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>

        </code><code class="nv">$value</code><code> </code><code class="o">=</code><code> </code><code class="nb">call_user_func</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">callback</code><code class="p">,</code><code> </code><code class="o">...</code><code class="nv">$args</code><code class="p">);</code><code> </code><a class="co" id="co_performance_tuning_CO2-3" href="#callout_performance_tuning_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code>

        </code><code class="nv">$totalTime</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="nb">hrtime</code><code class="p">(</code><code class="k">true</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="nv">$start</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mf">1e+9</code><code class="p">;</code><code>
        </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">totalRuntime</code><code> </code><code class="o">+=</code><code> </code><code class="nv">$totalTime</code><code class="p">;</code><code>

        </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">verbose</code><code class="p">)</code><code> </code><code class="p">{</code><code>
            </code><code class="k">echo</code><code> </code><code class="s2">"</code><code class="s2">Function took </code><code class="si">{</code><code class="nv">$totalTime</code><code class="si">}</code><code class="s2"> seconds.</code><code class="s2">"</code><code> </code><code class="o">.</code><code> </code><code class="nx">PHP_EOL</code><code class="p">;</code><code> </code><a class="co" id="co_performance_tuning_CO2-4" href="#callout_performance_tuning_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a><code>
        </code><code class="p">}</code><code>

        </code><code class="k">return</code><code> </code><code class="nv">$value</code><code class="p">;</code><code> </code><a class="co" id="co_performance_tuning_CO2-5" href="#callout_performance_tuning_CO2-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a><code>
    </code><code class="p">}</code><code>

    </code><code class="k">public</code><code> </code><code class="k">function</code><code> </code><code class="nf">getMetrics</code><code class="p">()</code><code class="o">:</code><code> </code><code class="k">array</code><code> </code><a class="co" id="co_performance_tuning_CO2-6" href="#callout_performance_tuning_CO2-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a><code>
    </code><code class="p">{</code><code>
        </code><code class="k">return</code><code> </code><code class="p">[</code><code>
            </code><code class="s1">'calls'</code><code>   </code><code class="o">=&gt;</code><code> </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">calls</code><code class="p">,</code><code>
            </code><code class="s1">'runtime'</code><code> </code><code class="o">=&gt;</code><code> </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">totalRuntime</code><code class="p">,</code><code>
            </code><code class="s1">'avg'</code><code>     </code><code class="o">=&gt;</code><code> </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">totalRuntime</code><code> </code><code class="o">/</code><code> </code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">calls</code><code>
        </code><code class="p">];</code><code>
    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_performance_tuning_CO2-1" href="#co_performance_tuning_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The <code>__invoke()</code> magic method makes class instances callable as if they were functions. Using the <code>...</code> spread operator will capture any arguments passed in at runtime so they can be passed later to the wrapped method.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO2-2" href="#co_performance_tuning_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The actual timing mechanism used by the decorator is the same as that in the Solution example.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO2-3" href="#co_performance_tuning_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Assuming the wrapped function is callable, PHP will call the function and pass all necessary arguments thanks to the <code>...</code> spread operator.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO2-4" href="#co_performance_tuning_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>This implementation of the decorator can be instantiated with a verbosity flag that will also print runtimes to the console.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO2-5" href="#co_performance_tuning_CO2-5"><img src="assets/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Since the wrapped function might return data, you need to ensure that the decorator returns that output as well.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO2-6" href="#co_performance_tuning_CO2-6"><img src="assets/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>As the decorated function is itself an object, you can directly expose additional properties and methods. In this case, the decorator keeps track of aggregate metrics that can be retrieved directly.</p></dd>
</dl></div>

<p>Assuming the same <code>doSomethingComputationallyExpensive()</code> function from the Solution example is the function you want to test, the preceding decorator can wrap the function and produce metrics as shown in <a data-type="xref" href="#leveraging_decorator">Example 14-3</a>.</p>
<div id="leveraging_decorator" data-type="example">
<h5><span class="label">Example 14-3. </span>Leveraging a decorator to time function execution</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$decorated</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">TimerDecorator</code><code class="p">(</code><code class="s1">'doSomethingComputationallyExpensive'</code><code class="p">);</code><code>

</code><code class="nv">$decorated</code><code class="p">();</code><code> </code><a class="co" id="co_performance_tuning_CO3-1" href="#callout_performance_tuning_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="nb">var_dump</code><code class="p">(</code><code class="nv">$decorated</code><code class="o">-&gt;</code><code class="na">getMetrics</code><code class="p">());</code><code> </code><a class="co" id="co_performance_tuning_CO3-2" href="#callout_performance_tuning_CO3-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_performance_tuning_CO3-1" href="#co_performance_tuning_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Since the decorator class implements the <code>__invoke()</code> magic method, you can use an instance of the class as if it were a function itself.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO3-2" href="#co_performance_tuning_CO3-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The resulting metrics array will include a count of invocations, the total runtime (in seconds) for all invocations, and the average runtime (in seconds) across all invocations.</p></dd>
</dl></div>

<p>Similarly, you can test the same wrapped function multiple times and pull aggregate runtime metrics from all invocations as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$decorated</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TimerDecorator</code><code class="p">(</code><code class="s1">'doSomethingComputationallyExpensive'</code><code class="p">);</code>

<code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="nv">$decorated</code><code class="p">();</code>
<code class="p">}</code>

<code class="nb">var_dump</code><code class="p">(</code><code class="nv">$decorated</code><code class="o">-&gt;</code><code class="na">getMetrics</code><code class="p">());</code></pre>

<p>Since the <code>TimerDecorator</code> class can <a data-type="indexterm" data-primary="TimerDecorator class" id="idm45875140924560"></a><a data-type="indexterm" data-primary="classes" data-secondary="TimerDecorator" id="idm45875140923920"></a>wrap any callable function, you can use it to decorate class methods just as easily as you can native functions. The class in <a data-type="xref" href="#decorator_friendly_class">Example 14-4</a> defines both a static and an instance method, either of which can be wrapped by a decorator.</p>
<div id="decorator_friendly_class" data-type="example">
<h5><span class="label">Example 14-4. </span>Simple class definition for testing decorators</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">DecoratorFriendly</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">static</code> <code class="k">function</code> <code class="nf">doSomething</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="c1">// ...</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">doSomethingElse</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="c1">// ...</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p><a data-type="xref" href="#decorator_callables">Example 14-5</a> shows how class methods (both static and instance-bound) can be referred to as callables at runtime in PHP. Anything that can be expressed as a callable interface can be wrapped by a decorator.</p>
<div id="decorator_callables" data-type="example">
<h5><span class="label">Example 14-5. </span>Any callable interface can be wrapped by a decorator</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$decoratedStatic</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">TimerDecorator</code><code class="p">([</code><code class="s1">'DecoratorFriendly'</code><code class="p">,</code><code> </code><code class="s1">'doSomething'</code><code class="p">]);</code><code> </code><a class="co" id="co_performance_tuning_CO4-1" href="#callout_performance_tuning_CO4-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nv">$decoratedStatic</code><code class="p">();</code><code> </code><a class="co" id="co_performance_tuning_CO4-2" href="#callout_performance_tuning_CO4-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>

</code><code class="nb">var_dump</code><code class="p">(</code><code class="nv">$decoratedStatic</code><code class="o">-&gt;</code><code class="na">getMetrics</code><code class="p">());</code><code>

</code><code class="nv">$instance</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">DecoratorFriendly</code><code class="p">();</code><code>

</code><code class="nv">$decoratedMember</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">TimerDecorator</code><code class="p">([</code><code class="nv">$instance</code><code class="p">,</code><code> </code><code class="s1">'doSomethingElse'</code><code class="p">]);</code><code> </code><a class="co" id="co_performance_tuning_CO4-3" href="#callout_performance_tuning_CO4-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code>
</code><code class="nv">$decoratedMember</code><code class="p">();</code><code> </code><a class="co" id="co_performance_tuning_CO4-4" href="#callout_performance_tuning_CO4-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a><code>

</code><code class="nb">var_dump</code><code class="p">(</code><code class="nv">$decoratedMember</code><code class="o">-&gt;</code><code class="na">getMetrics</code><code class="p">());</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_performance_tuning_CO4-1" href="#co_performance_tuning_CO4-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>A static class method is used as a callable by passing an array of both the names of the class and its static method.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO4-2" href="#co_performance_tuning_CO4-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Once created, the decorated static method can be called as any other function would be and will produce metrics the same way.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO4-3" href="#co_performance_tuning_CO4-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>A method of a class instance is used as a callable by passing an array of the instantiated object and the string name of the method.</p></dd>
<dt><a class="co" id="callout_performance_tuning_CO4-4" href="#co_performance_tuning_CO4-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Similar to the decorated static method, a decorated instance method can then be called as any other function would be to populate metrics within the decorator.</p></dd>
</dl></div>

<p>Once you know how long a function takes to run, you can focus on optimizing its execution. This might involve refactoring the logic or using an alternative approach to defining an algorithm.</p>

<p>The use of <code>hrtime()</code> originally required the <a href="https://oreil.ly/P_4Fq">HRTime extension</a> to PHP but is now bundled as a core function by default. If you’re using a version of PHP older than 7.3 or a prebuilt distribution where it was explicitly omitted, the function itself might be missing. In that event, you can either install the extension yourself via PECL or leverage the similar <code>microtime()</code> function instead.<sup><a data-type="noteref" id="idm45875140747200-marker" href="ch14.html#idm45875140747200">2</a></sup></p>

<p>Rather than counting seconds from an arbitrary point in time, <code>microtime()</code> returns the number of microseconds since the Unix epoch. This function can be used in place of <code>hrtime()</code> to gauge function execution time as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$start</code> <code class="o">=</code> <code class="nb">microtime</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>

<code class="nx">doSomethingComputationallyExpensive</code><code class="p">();</code>

<code class="nv">$totalTime</code> <code class="o">=</code> <code class="nb">microtime</code><code class="p">(</code><code class="k">true</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$start</code><code class="p">;</code>

<code class="k">echo</code> <code class="s2">"Function took </code><code class="si">{</code><code class="nv">$totalTime</code><code class="si">}</code><code class="s2"> seconds."</code> <code class="o">.</code> <code class="nx">PHP_EOL</code><code class="p">;</code></pre>

<p>Regardless of whether you use <code>hrtime()</code> as in the Solution example or <code>microtime()</code> as in the preceding snippet, ensure that you’re consistent with the way you read out the resulting data. Both mechanisms return notions of time at different levels of precision, which could <a data-type="indexterm" data-primary="performance tuning" data-secondary="function execution timing" data-startref="pftfxtm" id="idm45875140729456"></a><a data-type="indexterm" data-primary="functions" data-secondary="execution timing" data-startref="fcxctm" id="idm45875140728336"></a><a data-type="indexterm" data-primary="hrtime() function" data-startref="htmfct" id="idm45875140727120"></a><a data-type="indexterm" data-primary="functions" data-secondary="hrtime()" data-startref="fcnshtm" id="idm45875140726176"></a>lead to confusion if you mix and match on any output 
<span class="keep-together">formatting</span>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875141302048">
<h2>See Also</h2>

<p>PHP documentation on <a href="https://oreil.ly/AjZ4H"><code>hrtime()</code></a> and <a href="https://oreil.ly/r_U84"><code>microtime()</code></a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="14.2 Benchmarking the Performance of an Application"><div class="sect1" id="idm45875140692240">
<h1>14.2 Benchmarking the Performance of an Application</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875140690992">
<h2>Problem</h2>

<p>You want to benchmark the performance of <a data-type="indexterm" data-primary="performance tuning" data-secondary="benchmarking application performance" id="pftbkpp"></a><a data-type="indexterm" data-primary="benchmarking application performance" id="bmkppp"></a><a data-type="indexterm" data-primary="applications" data-secondary="benchmarking performance" id="pplcmkpf"></a>your entire application so you can gauge changes (e.g., performance regressions) as the codebase, dependencies, and underlying language versions evolve.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875140685968">
<h2>Solution</h2>

<p>Leverage an automated tool like PHPBench to <a data-type="indexterm" data-primary="PHPBench" id="ppbch"></a><a data-type="indexterm" data-primary="performance tuning" data-secondary="PHPBench" id="pftngppb"></a>instrument your code and run regular performance benchmarks. For example, the following class is constructed to test the performance of all available hashing algorithms over various string sizes.<sup><a data-type="noteref" id="idm45875140682000-marker" href="ch14.html#idm45875140682000">3</a></sup></p>

<pre data-type="programlisting" data-code-language="php"><code class="sd">/**</code>
<code class="sd"> * @BeforeMethods("setUp")</code>
<code class="sd"> */</code>
<code class="k">class</code> <code class="nc">HashingBench</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="nv">$string</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">setUp</code><code class="p">(</code><code class="k">array</code> <code class="nv">$params</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">string</code> <code class="o">=</code> <code class="nb">str_repeat</code><code class="p">(</code><code class="s1">'X'</code><code class="p">,</code> <code class="nv">$params</code><code class="p">[</code><code class="s1">'size'</code><code class="p">]);</code>
    <code class="p">}</code>

    <code class="sd">/**</code>
<code class="sd">     * @ParamProviders({</code>
<code class="sd">     *     "provideAlgos",</code>
<code class="sd">     *     "provideStringSize"</code>
<code class="sd">     * })</code>
<code class="sd">     */</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">benchAlgos</code><code class="p">(</code><code class="nv">$params</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nb">hash</code><code class="p">(</code><code class="nv">$params</code><code class="p">[</code><code class="s1">'algo'</code><code class="p">],</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">provideAlgos</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">foreach</code> <code class="p">(</code><code class="nb">array_slice</code><code class="p">(</code><code class="nb">hash_algos</code><code class="p">(),</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">20</code><code class="p">)</code> <code class="k">as</code> <code class="nv">$algo</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">yield</code> <code class="p">[</code><code class="s1">'algo'</code> <code class="o">=&gt;</code> <code class="nv">$algo</code><code class="p">];</code>
        <code class="p">}</code>

    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">provideStringSize</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">yield</code> <code class="p">[</code><code class="s1">'size'</code> <code class="o">=&gt;</code> <code class="mi">10</code><code class="p">];</code>
        <code class="k">yield</code> <code class="p">[</code><code class="s1">'size'</code> <code class="o">=&gt;</code> <code class="mi">100</code><code class="p">];</code>
        <code class="k">yield</code> <code class="p">[</code><code class="s1">'size'</code> <code class="o">=&gt;</code> <code class="mi">1000</code><code class="p">];</code>
    <code class="p">}</code>

<code class="p">}</code></pre>

<p>To run the default preceding example benchmark, first clone PHPBench, then install Composer dependencies, and finally run the following command:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>./bin/phpbench<code class="w"> </code>run<code class="w"> </code>--profile<code class="o">=</code>examples<code class="w"> </code>--report<code class="o">=</code>examples<code class="w"> </code>--filter<code class="o">=</code>HashingBench<code class="w"></code></pre>

<p>The resulting output, once the benchmark completes, will resemble the chart in <a data-type="xref" href="#hashing_benchmark">Figure 14-1</a>.</p>

<figure><div id="hashing_benchmark" class="figure">
<img src="assets/phpc_1401.png" alt="Output metrics from PHPBench's example hashing benchmark" width="600" height="299"/>
<h6><span class="label">Figure 14-1. </span>Output metrics from PHPBench’s example hashing benchmark</h6>
</div></figure>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875140544432">
<h2>Discussion</h2>

<p>PHPBench is an effective way to gauge performance benchmarks of user-defined code in a variety of situations. It can be used in development environments to judge the performance level of new code, and it can also be integrated directly into continuous integration environments.</p>

<p>PHPBench’s own <a href="https://oreil.ly/D6PMf">GitHub Actions configuration</a> runs a full benchmarking suite of the application itself with every pull request and change. This allows the project maintainers to ensure that the project continues performing as expected with each change they introduce across a broad matrix of supported versions of PHP.</p>

<p>Any project aiming to include automated benchmarks must first start with Composer.<sup><a data-type="noteref" id="idm45875140540864-marker" href="ch14.html#idm45875140540864">4</a></sup> You need to leverage Composer autoloading so PHPBench knows where to grab classes from, but once that’s set up, you can build your project however you want.</p>

<p>Assume you’re building a project that leverages value objects and hashing to protect sensitive data they store. Your initial <em>composer.json</em> file might look something like the following:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="nt">"name"</code><code class="p">:</code><code class="w"> </code><code class="s2">"phpcookbook/valueobjects"</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="nt">"require-dev"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="nt">"phpbench/phpbench"</code><code class="p">:</code><code class="w"> </code><code class="s2">"^1.0"</code><code class="w"></code>
<code class="w">    </code><code class="p">},</code><code class="w"></code>
<code class="w">    </code><code class="nt">"autoload"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="nt">"psr-4"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">            </code><code class="nt">"Cookbook\\"</code><code class="p">:</code><code class="w"> </code><code class="s2">"src/"</code><code class="w"></code>
<code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="p">},</code><code class="w"></code>
<code class="w">    </code><code class="nt">"autoload-dev"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">        </code><code class="nt">"psr-4"</code><code class="p">:</code><code class="w"> </code><code class="p">{</code><code class="w"></code>
<code class="w">            </code><code class="nt">"Cookbook\\Tests\\"</code><code class="p">:</code><code class="w"> </code><code class="s2">"tests/"</code><code class="w"></code>
<code class="w">        </code><code class="p">}</code><code class="w"></code>
<code class="w">    </code><code class="p">},</code><code class="w"></code>
<code class="w">    </code><code class="nt">"minimum-stability"</code><code class="p">:</code><code class="w"> </code><code class="s2">"dev"</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="nt">"prefer-stable"</code><code class="p">:</code><code class="w"> </code><code class="kc">true</code><code class="w"></code>
<code class="p">}</code><code class="w"></code></pre>

<p>Naturally, your project code will live in a <em>src/</em> directory and any tests, benchmarking or otherwise, will live in a separate <em>tests/</em> directory. For the sake of benchmarking alone, you’ll want to create a dedicated <em>tests/Benchmark/</em> directory to keep track of both namespaces and filterable code.</p>

<p>Your first class, the one you want to benchmark, is a value object that takes in an email address and can be easily manipulated as if it were a string. But when it dumps its contents to a debugging context, like <code>var_dump()</code> or <code>print_r()</code>, it automatically hashes the value.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Email is a common enough format that even hashing the data won’t be enough to protect it from a truly dedicated attacker. The illustrations in this recipe are meant to demonstrate how data can be <em>obfuscated</em> using a hash. This should not be considered a comprehensive security tutorial.</p>
</div>

<p>Create the class defined in <a data-type="xref" href="#protected_string_class">Example 14-6</a> as <em>ProtectedString.php</em> in your new <em>src/</em> directory. This class has a lot to it—primarily several implemented magic methods to ensure that there is no way to <em>accidentally</em> serialize the object and get at its internal value. Instead, once you instantiate a <code>ProtectedString</code> object, the only way to get at its contents is with the <code>::getValue()</code> method. Anything else will return the SHA-256 hash of the contents.</p>
<div id="protected_string_class" data-type="example">
<h5><span class="label">Example 14-6. </span>Protected string wrapper class definition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">namespace</code> <code class="nx">Cookbook</code><code class="p">;</code>

<code class="k">class</code> <code class="nc">ProtectedString</code> <code class="k">implements</code> <code class="nx">\JsonSerializable</code>
<code class="p">{</code>
    <code class="k">protected</code> <code class="nx">bool</code> <code class="nv">$valid</code> <code class="o">=</code> <code class="k">true</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="k">protected</code> <code class="o">?</code><code class="nx">string</code> <code class="nv">$value</code><code class="p">)</code> <code class="p">{}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">getValue</code><code class="p">()</code><code class="o">:</code> <code class="o">?</code><code class="nx">string</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">value</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">equals</code><code class="p">(</code><code class="nx">ProtectedString</code> <code class="nv">$other</code><code class="p">)</code><code class="o">:</code> <code class="nx">bool</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">value</code> <code class="o">===</code> <code class="nv">$other</code><code class="o">-&gt;</code><code class="na">getValue</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">protected</code> <code class="k">function</code> <code class="nf">redacted</code><code class="p">()</code><code class="o">:</code> <code class="nx">string</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nb">hash</code><code class="p">(</code><code class="s1">'sha256'</code><code class="p">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">value</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">isValid</code><code class="p">()</code><code class="o">:</code> <code class="nx">bool</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">valid</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">__serialize</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="p">[</code>
            <code class="s1">'value'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">redacted</code><code class="p">()</code>
        <code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">__unserialize</code><code class="p">(</code><code class="k">array</code> <code class="nv">$serialized</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">value</code> <code class="o">=</code> <code class="k">null</code><code class="p">;</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">valid</code> <code class="o">=</code> <code class="k">false</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">jsonSerialize</code><code class="p">()</code><code class="o">:</code> <code class="nx">mixed</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">redacted</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__toString</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">redacted</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__debugInfo</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="p">[</code>
            <code class="s1">'valid'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">valid</code><code class="p">,</code>
            <code class="s1">'value'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">redacted</code><code class="p">()</code>
        <code class="p">];</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p>You want to validate the performance of the chosen hashing algorithm. SHA-256 is more than reasonable, but you want to ensure that you benchmark all possible means of serialization for performance so that, if and when you need to change to a different hashing algorithm, you can ensure no performance regressions in the system.</p>

<p>To actually begin benchmarking this class, create the following <em>phpbench.json</em> file in the root of your project:</p>

<pre data-type="programlisting" data-code-language="json"><code class="p">{</code><code class="w"></code>
<code class="w">    </code><code class="nt">"$schema"</code><code class="p">:</code><code class="w"> </code><code class="s2">"./vendor/phpbench/phpbench/phpbench.schema.json"</code><code class="p">,</code><code class="w"></code>
<code class="w">    </code><code class="nt">"runner.bootstrap"</code><code class="p">:</code><code class="w"> </code><code class="s2">"vendor/autoload.php"</code><code class="w"></code>
<code class="p">}</code><code class="w"></code></pre>

<p>Finally, create an actual benchmark to time the various ways a user can serialize a string. The benchmark defined in <a data-type="xref" href="#protected_string_benchmark">Example 14-7</a> should live in <em>tests/Benchmark/ProtectedStringBench.php</em>.</p>
<div id="protected_string_benchmark" data-type="example">
<h5><span class="label">Example 14-7. </span>Benchmarking the <code>ProtectedString</code> class</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">namespace</code> <code class="nx">Cookbook\Tests\Benchmark</code><code class="p">;</code>

<code class="k">use</code> <code class="nx">Cookbook\ProtectedString</code><code class="p">;</code>

<code class="k">class</code> <code class="nc">ProtectedStringBench</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">benchSerialize</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$data</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ProtectedString</code><code class="p">(</code><code class="s1">'testValue'</code><code class="p">);</code>
        <code class="nv">$serialized</code> <code class="o">=</code> <code class="nb">serialize</code><code class="p">(</code><code class="nv">$data</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">benchJsonSerialize</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$data</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ProtectedString</code><code class="p">(</code><code class="s1">'testValue'</code><code class="p">);</code>
        <code class="nv">$serialized</code> <code class="o">=</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$data</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">benchStringTypecast</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$data</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ProtectedString</code><code class="p">(</code><code class="s1">'testValue'</code><code class="p">);</code>
        <code class="nv">$serialized</code> <code class="o">=</code> <code class="s1">''</code> <code class="o">.</code> <code class="nv">$data</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">benchVarExport</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$data</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ProtectedString</code><code class="p">(</code><code class="s1">'testValue'</code><code class="p">);</code>
        <code class="nb">ob_start</code><code class="p">();</code>
        <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$data</code><code class="p">);</code>
        <code class="nv">$serialized</code> <code class="o">=</code> <code class="nb">ob_end_clean</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p>Finally, you can run your benchmarks with the following shell command:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>./vendor/bin/phpbench<code class="w"> </code>run<code class="w"> </code>tests/Benchmark<code class="w"> </code>--report<code class="o">=</code>default<code class="w"></code></pre>

<p>This command will produce an output similar to that in <a data-type="xref" href="#object_serialization_benchmarks">Figure 14-2</a>, detailing the memory usage and runtime for each of your serialization operations.</p>

<figure><div id="object_serialization_benchmarks" class="figure">
<img src="assets/phpc_1402.png" alt="Output of PHPBench for value object serialization with hashing." width="600" height="294"/>
<h6><span class="label">Figure 14-2. </span>Output of PHPBench for value object serialization with hashing</h6>
</div></figure>

<p>Every element of your application can, and should, have benchmarking built into it. This will drastically simplify testing the performance of your application in new environments—like on new server hardware or under a newly released version of PHP. Wherever possible, take time to wire these benchmarks into continuous integration runs as well to <a data-type="indexterm" data-primary="performance tuning" data-secondary="benchmarking application performance" data-startref="pftbkpp" id="idm45875139925344"></a><a data-type="indexterm" data-primary="benchmarking application performance" data-startref="bmkppp" id="idm45875139923472"></a><a data-type="indexterm" data-primary="applications" data-secondary="benchmarking performance" data-startref="pplcmkpf" id="idm45875139922560"></a><a data-type="indexterm" data-primary="PHPBench" data-startref="ppbch" id="idm45875139921376"></a><a data-type="indexterm" data-primary="performance tuning" data-secondary="PHPBench" data-startref="pftngppb" id="idm45875139920432"></a>ensure that the tests are run and recorded as frequently as possible.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875140543488">
<h2>See Also</h2>

<p>Official documentation for the <a href="https://oreil.ly/4HCMc">PHPBench project</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="14.3 Accelerating an Application with an Opcode Cache"><div class="sect1" id="idm45875139917248">
<h1>14.3 Accelerating an Application with an Opcode Cache</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875139915968">
<h2>Problem</h2>

<p>You want to leverage opcode caching <a data-type="indexterm" data-primary="opcode caching" data-secondary="application acceleration" id="opcchpp"></a><a data-type="indexterm" data-primary="applications" data-secondary="opcode caching" id="appcpcch"></a>in your environment to improve the overall performance of your application.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875139891392">
<h2>Solution</h2>

<p>Install the shared OPcache extension and configure it in <em>php.ini</em> for your environment.<sup><a data-type="noteref" id="idm45875139889680-marker" href="ch14.html#idm45875139889680">5</a></sup> As it’s a default extension, you merely need to update your configuration to enable caching. The following settings are generally recommended for solid performance but should be tested against your particular application and infrastructure:</p>

<pre data-type="programlisting" data-code-language="ini"><code class="na">opcache.memory_consumption</code><code class="o">=</code><code class="s">128</code>
<code class="na">opcache.interned_strings_buffer</code><code class="o">=</code><code class="s">8</code>
<code class="na">opcache.max_accelerated_files</code><code class="o">=</code><code class="s">4000</code>
<code class="na">opcache.revalidate_freq</code><code class="o">=</code><code class="s">60</code>
<code class="na">opcache.fast_shutdown</code><code class="o">=</code><code class="s">1</code>
<code class="na">opcache.enable</code><code class="o">=</code><code class="s">1</code>
<code class="na">opcache.enable_cli</code><code class="o">=</code><code class="s">1</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875139866656">
<h2>Discussion</h2>

<p>When PHP is running, the interpreter reads your scripts and compiles your user-friendly PHP code into something that’s easy for the machine to understand. Unfortunately, since PHP isn’t a formally compiled language, it has to do this compilation every time a script loads. With a simple application, this isn’t that much of an issue. With a complex application, it can lead to slow load times and high latency for repeated requests.</p>

<p>The easiest way to optimize an application around this particular issue is to cache the compiled byte code so it can be reused on subsequent requests.</p>

<p>To test and verify the functionality of the opcode cache locally, you can leverage <code>-d</code> flags at the command line when starting a script. The <code>-d</code> flag sets an explicit override for a configuration value otherwise set (or left to its default) by <em>php.ini</em>. Specifically, the command-line flags in <a data-type="xref" href="#webserver_no_opcache">Example 14-8</a> will leverage the local PHP development server to run an application with OPcache <em>disabled</em> entirely.</p>
<div id="webserver_no_opcache" data-type="example">
<h5><span class="label">Example 14-8. </span>Launch a local PHP web server without OPcache support</h5>

<pre data-type="programlisting">$ php -S localhost:8080 -t public/ -dopcache.enable_cli=0 -dopcache.enable=0</pre></div>

<p>Similarly, you can run almost exactly the same command with explicit <em>enabling</em> of the opcode cache to directly compare the behavior and performance of your application, as shown in <a data-type="xref" href="#webserver_with_opcache">Example 14-9</a>.</p>
<div id="webserver_with_opcache" data-type="example">
<h5><span class="label">Example 14-9. </span>Launch a local PHP web server with OPcache support</h5>

<pre data-type="programlisting">$ php -S localhost:8080 -t public/ -dopcache.enable_cli=1 -dopcache.enable=1</pre></div>

<p>To fully demonstrate how this works, take time to install a demo application using the open source Symfony framework. The following two commands will clone a demonstration application to the <em>/demosite/</em> directory locally and use Composer to install required dependencies:</p>

<pre data-type="programlisting">$ composer create-project symfony/symfony-demo demosite
$ cd demosite &amp;&amp; composer install</pre>

<p>Next, use the built-in PHP web server to launch the application itself. Use the command from <a data-type="xref" href="#webserver_no_opcache">Example 14-8</a> to start without opcache support. The application will be available on port 8080 and will look something like <a data-type="xref" href="#symfony_demo">Figure 14-3</a>.</p>

<figure><div id="symfony_demo" class="figure">
<img src="assets/phpc_1403.png" alt="Loading page of the default Symfony demo application." width="600" height="370"/>
<h6><span class="label">Figure 14-3. </span>Loading page of the default Symfony demo application</h6>
</div></figure>

<p>The default application is running locally, using a <a data-type="indexterm" data-primary="SQLite database" id="idm45875139847184"></a>lightweight SQLite database, so it should load fairly quickly. As shown in <a data-type="xref" href="#curl_performance_test">Example 14-10</a>, you can effectively test the load time with a cURL command in your terminal.</p>
<div id="curl_performance_test" data-type="example" class="pagebreak-before">
<h5><span class="label">Example 14-10. </span>Simple cURL command for gauging web application response time</h5>

<pre data-type="programlisting">curl -s -w "\nLookup time:\t%{time_namelookup}\
    \nConnect time:\t%{time_connect}\
    \nPreXfer time:\t%{time_pretransfer}\
    \nStartXfer time:\t%{time_starttransfer}\
    \n\nTotal time:\t%{time_total}\n" -o /dev/null \
    http://localhost:8080</pre></div>

<p>Without opcode caching enabled, the Symfony demo application loads with a total time of ~0.3677 seconds. This is remarkably fast but, again, the application is being run entirely within the local environment. In production with a remote database, it would likely be slower, but this is a solid baseline.</p>

<p>Now, stop the application and restart it <em>with</em> opcode caching enabled using the command defined in <a data-type="xref" href="#webserver_with_opcache">Example 14-9</a>. Then rerun the cURL performance test from <a data-type="xref" href="#curl_performance_test">Example 14-10</a>. With opcode caching, the application now loads with a total time of ~0.0371 seconds.</p>

<p>This is a relatively simple, default application, but a 10 times increase in performance is a massive boost to system performance. The faster an application loads, the more customers your system can service <a data-type="indexterm" data-primary="opcode caching" data-secondary="application acceleration" data-startref="opcchpp" id="idm45875139816608"></a><a data-type="indexterm" data-primary="applications" data-secondary="opcode caching" data-startref="appcpcch" id="idm45875139815392"></a>in the same period of time!</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875139866064">
<h2>See Also</h2>

<p>PHP documentation on the <a href="https://oreil.ly/Tb8rC">OPcache extension</a>.</p>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45875141364544"><sup><a href="ch14.html#idm45875141364544-marker">1</a></sup> The newer JIT compiler released with PHP 8.0 uses OPcache under the hood, but you can still leverage caching <em>manually</em> to control the system even if JIT compilation is unavailable.</p><p data-type="footnote" id="idm45875140747200"><sup><a href="ch14.html#idm45875140747200-marker">2</a></sup> For more on PECL and extension management, refer to <a data-type="xref" href="ch15.html#native_php_extensions">Recipe 15.4</a>.</p><p data-type="footnote" id="idm45875140682000"><sup><a href="ch14.html#idm45875140682000-marker">3</a></sup> This particular example is taken from the <a href="https://oreil.ly/zZE4X">example benchmarks</a> that ship by default with PHPBench.</p><p data-type="footnote" id="idm45875140540864"><sup><a href="ch14.html#idm45875140540864-marker">4</a></sup> For more on initializing a project with Composer, review <a data-type="xref" href="ch15.html#composer_definition">Recipe 15.1</a>.</p><p data-type="footnote" id="idm45875139889680"><sup><a href="ch14.html#idm45875139889680-marker">5</a></sup> OPcache is a shared extension that will not exist if your PHP was compiled with the <code>--disable-all</code> flag to disable default extensions. In that case, you have no choice but to either recompile PHP with the <code>--enable-opcache</code> flag set or else install a fresh version of the PHP engine that was compiled with this flag set.</p></div></div></section></div>
</div>
</body>
</html>