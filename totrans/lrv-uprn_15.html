<html><head></head><body><section data-pdf-bookmark="Chapter 15. Mail and Notifications" data-type="chapter" epub:type="chapter"><div class="chapter" id="mail_and_notifications">&#13;
<h1><span class="label">Chapter 15. </span>Mail and Notifications</h1>&#13;
&#13;
&#13;
<p>Sending an application’s users notifications via email, Slack, SMS, or another notification system is a common but surprisingly complex requirement. Laravel’s mail and notification features provide consistent APIs that abstract away the need to pay too close attention to any particular provider. Just like in <a data-type="xref" href="ch14.html#storage_and_retrieval">Chapter 14</a>, you’ll write your code once and choose at the configuration level which provider you’ll use to send your email or notifications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mail" data-type="sect1"><div class="sect1" id="id297">&#13;
<h1>Mail</h1>&#13;
&#13;
<p>Laravel’s mail functionality<a data-primary="Symfony Mailer" data-type="indexterm" id="id1797"/> is a convenience layer on top of <a href="https://oreil.ly/ceZ3K">Symfony Mailer</a>. Out of the box, Laravel<a data-primary="mail" data-secondary="services supported" data-type="indexterm" id="id1798"/> comes with drivers for SMTP, Mailgun, Postmark, Amazon SES, and Sendmail.</p>&#13;
&#13;
<p>For all of the cloud services, you’ll set your<a data-primary="mail" data-secondary="authentication information" data-type="indexterm" id="id1799"/> authentication information in <span class="keep-together"><em>config</em></span><span class="keep-together"><em>/services.php</em></span>. However, if you take a look, you’ll see there are already keys &#13;
<span class="keep-together">there—and</span> in <em>config/mail.php</em>—that allow you to customize your application’s mail functionality in <em>.env</em> using variables like <code>MAIL_MAILER</code> and <code>MAILGUN_SECRET</code>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1800">&#13;
<h1>Cloud-Based API Driver Dependencies</h1>&#13;
<p>If<a data-primary="mail" data-secondary="cloud-based API driver dependencies" data-type="indexterm" id="id1801"/> you’re using any of the cloud-based API drivers, you may need to bring in external dependencies to support them.</p>&#13;
&#13;
<p>If you’re using Mailgun, you’ll want to bring in Symfony’s Mailgun Mailer and its HTTP client:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>symfony/mailgun-mailer<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>symfony/http-client<code class="w"/></pre>&#13;
&#13;
<p>If you’re using Postmark, you’ll pull in Symfony’s Postmark Mailer and its HTTP &#13;
<span class="keep-together">client</span>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>symfony/postmark-mailer<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>symfony/http-client<code class="w"/></pre>&#13;
&#13;
<p>And if you use the SES driver, you’ll want to pull in the AWS SDK:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>aws/aws-sdk-php<code class="w"/></pre>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic “Mailable” Mail Usage" data-type="sect2"><div class="sect2" id="id298">&#13;
<h2>Basic “Mailable” Mail Usage</h2>&#13;
&#13;
<p>Every<a data-primary="mail" data-secondary="basic mailable mail usage" data-type="indexterm" id="Mmailable15"/> mail message you’ll send in a modern Laravel app will be an instance of a specific PHP class, created to represent each email, called a <em>mailable</em>.</p>&#13;
&#13;
<p>To make a mailable, use the <code>make:mail</code> Artisan command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:mail<code class="w"> </code>AssignmentCreated<code class="w"/></pre>&#13;
&#13;
<p><a data-type="xref" href="#autogenerated_mailable_PHP_class">Example 15-1</a> shows what that class looks like.</p>&#13;
<div data-type="example" id="autogenerated_mailable_PHP_class">&#13;
<h5><span class="label">Example 15-1. </span>An autogenerated mailable PHP class</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Mail</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Bus\Queueable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Content</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Envelope</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\SerializesModels</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">AssignmentCreated</code> <code class="k">extends</code> <code class="nx">Mailable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Queueable</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Create a new message instance.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the message envelope.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">envelope</code><code class="p">()</code><code class="o">:</code> <code class="nx">Envelope</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Envelope</code><code class="p">(</code>&#13;
            <code class="nx">subject</code><code class="o">:</code> <code class="s1">'Assignment Created'</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the message content definition.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">content</code><code class="p">()</code><code class="o">:</code> <code class="nx">Content</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Content</code><code class="p">(</code>&#13;
            <code class="nx">view</code><code class="o">:</code> <code class="s1">'view.name'</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the attachments for the message.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;int, \Illuminate\Mail\Mailables\Attachment&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You may notice a few similarities between mailables and jobs; this class even imports the <code>Queueable</code> trait for queuing your mail and the <code>SerializesModels</code> trait so any Eloquent models you pass to the constructor will be serialized correctly.</p>&#13;
&#13;
<p>So, how does this work? The class constructor is the place where you’ll pass in any data, and any properties you set as public on your mailable class will be available to the template.</p>&#13;
&#13;
<p>In the<a data-primary="envelope() method" data-type="indexterm" id="id1802"/> <code>envelope()</code> method, you’ll set configuration details about the mail—sender, subject, metadata.</p>&#13;
&#13;
<p>In the<a data-primary="content() method" data-type="indexterm" id="id1803"/> <code>content()</code> method, you’ll define the content—which view you’re using to render, any Markdown contents, and text parameters.</p>&#13;
&#13;
<p>And if you want to attach any files to the mail, you’ll use<a data-primary="attachments() method" data-type="indexterm" id="id1804"/> the <code>attachments()</code> method.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX1453">Example 15-2</a> to see how we might update the autogenerated mailable for our assignment example.</p>&#13;
<div data-type="example" id="EX1453">&#13;
<h5><span class="label">Example 15-2. </span>A sample mailable</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Mail</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Bus\Queueable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Address</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Content</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Envelope</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Queue\SerializesModels</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">AssignmentCreated</code> <code class="k">extends</code> <code class="nx">Mailable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Queueable</code><code class="p">,</code> <code class="nx">SerializesModels</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="k">public</code> <code class="nv">$trainer</code><code class="p">,</code> <code class="k">public</code> <code class="nv">$trainee</code><code class="p">)</code> <code class="p">{}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">envelope</code><code class="p">()</code><code class="o">:</code> <code class="nx">Envelope</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Envelope</code><code class="p">(</code>&#13;
            <code class="nx">subject</code><code class="o">:</code> <code class="s1">'New assignment from '</code> <code class="o">.</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
            <code class="nx">from</code><code class="o">:</code> <code class="k">new</code> <code class="nx">Address</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">),</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">content</code><code class="p">()</code><code class="o">:</code> <code class="nx">Content</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Content</code><code class="p">(</code>&#13;
            <code class="nx">view</code><code class="o">:</code> <code class="s1">'emails.assignment-created'</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Once you’ve created the mailable class, it’s time to send it. First, you create an instance of the mailable class, passing in the appropriate data; then, you chain <code>Mail::to($user)-&gt;send($mailable)</code> to send the mail. You can also customize some other details of your mail, like the CC and BCC, as part of the inline call chain. Take a look at <a data-type="xref" href="#ways_to_send_mailables">Example 15-3</a> to see a few examples.</p>&#13;
<div data-type="example" id="ways_to_send_mailables">&#13;
<h5><span class="label">Example 15-3. </span>How to send mailables</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$mail</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Simple</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">send</code><code class="p">(</code><code class="nv">$mail</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// With CC/BCC/etc.</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nv">$user1</code><code class="p">))</code>&#13;
    <code class="o">-&gt;</code><code class="na">cc</code><code class="p">(</code><code class="nv">$user2</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">bcc</code><code class="p">(</code><code class="nv">$user3</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">send</code><code class="p">(</code><code class="nv">$mail</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// With string email address and collections</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="s1">'me@app.com'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">bcc</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">all</code><code class="p">())</code>&#13;
    <code class="o">-&gt;</code><code class="na">send</code><code class="p">(</code><code class="nv">$mail</code><code class="p">)</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mail Templates" data-type="sect2"><div class="sect2" id="id299">&#13;
<h2>Mail Templates</h2>&#13;
&#13;
<p>Mail templates<a data-primary="" data-startref="Mmailable15" data-type="indexterm" id="id1805"/><a data-primary="mail" data-secondary="mail templates" data-type="indexterm" id="id1806"/> are just like any other template. They can extend other templates, use sections, parse variables, contain conditional or looping directives, and do anything else you can do in a normal Blade view.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX1409">Example 15-4</a> to see a possible <code>emails.assignment-created</code> template for <a data-type="xref" href="#EX1453">Example 15-2</a>.</p>&#13;
<div data-type="example" id="EX1409">&#13;
<h5><span class="label">Example 15-4. </span>Sample <code>assignment-created</code> email template</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- resources/views/emails/assignment-created.blade.php --&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>Hey {{ $trainee-&gt;name }}!<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code>&#13;
&#13;
<code class="p">&lt;</code><code class="nt">p</code><code class="p">&gt;</code>You have received a new training assignment from <code class="p">&lt;</code><code class="nt">b</code><code class="p">&gt;</code>{{ $trainer-&gt;name }}<code class="p">&lt;/</code><code class="nt">b</code><code class="p">&gt;</code>.&#13;
Check out your <code class="p">&lt;</code><code class="nt">a</code> <code class="na">href</code><code class="o">=</code><code class="s">"{{ route('training-dashboard') }}"</code><code class="p">&gt;</code>training&#13;
dashboard<code class="p">&lt;/</code><code class="nt">a</code><code class="p">&gt;</code> now!<code class="p">&lt;/</code><code class="nt">p</code><code class="p">&gt;</code></pre></div>&#13;
&#13;
<p>In <a data-type="xref" href="#EX1453">Example 15-2</a>, both <code>$trainer</code> and <code>$trainee</code> are public properties on your &#13;
<span class="keep-together">mailable</span>, which makes them available to the template. Had one of them been private, it would not have been available.</p>&#13;
&#13;
<p>If you want to explicitly define which variables are passed to the template, you can use the <code>with</code> parameter on the <code>Content</code> of your mailable, as in <a data-type="xref" href="#customizing_template_variables">Example 15-5</a>.</p>&#13;
<div data-type="example" id="customizing_template_variables">&#13;
<h5><span class="label">Example 15-5. </span>Customizing the template variables</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Content</code><code class="p">;</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">content</code><code class="p">()</code><code class="o">:</code> <code class="nx">Content</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Content</code><code class="p">(</code>&#13;
        <code class="nx">view</code><code class="o">:</code> <code class="s1">'emails.assignment-created'</code><code class="p">,</code>&#13;
        <code class="nx">with</code><code class="o">:</code> <code class="p">[</code><code class="s1">'assignment'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">event</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">],</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h1>HTML Versus Plain-Text Emails</h1>&#13;
<p>So far we’ve used the <code>view</code> parameter on the <code>new Content()</code> instantiation. This expects the template we’re referencing to pass back HTML. If you’d like to pass a plain-text version, use the <code>text</code> parameter to define your plain-text view:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">content</code><code class="p">()</code><code class="o">:</code> <code class="nx">Content</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Content</code><code class="p">(</code>&#13;
        <code class="nx">html</code><code class="o">:</code> <code class="s1">'emails.assignment-created'</code><code class="p">,</code>&#13;
        <code class="nx">text</code><code class="o">:</code> <code class="s1">'emails.assignment-created-text'</code><code class="p">,</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Methods Available in envelope()" data-type="sect2"><div class="sect2" id="id300">&#13;
<h2>Methods Available in envelope()</h2>&#13;
&#13;
<p>We’ve<a data-primary="mail" data-secondary="methods available in envelope()" data-type="indexterm" id="id1807"/><a data-primary="envelope() method" data-type="indexterm" id="id1808"/> already looked at how we can customize the subject and the “from” address using the <code>envelope()</code> method. Note that the way we’re customizing these is by passing different named parameters to the constructor of the <code>Envelope</code> class:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">envelope</code><code class="p">()</code><code class="o">:</code> <code class="nx">Envelope</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Envelope</code><code class="p">(</code>&#13;
        <code class="nx">subject</code><code class="o">:</code> <code class="s1">'New assignment from '</code> <code class="o">.</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">,</code>&#13;
        <code class="nx">from</code><code class="o">:</code> <code class="k">new</code> <code class="nx">Address</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">trainer</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">),</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>This isn’t an exhaustive list, but here is a short list of parameters the <code>envelope()</code> method allows us to pass to the <code>Envelope</code> class to customize our email. Any parameter that can accept an <code>Address</code> can also accept a string email address or an array containing a mixture of <code>Address</code> objects and/or strings.</p>&#13;
<dl>&#13;
<dt><code>from: <em>Address</em></code></dt>&#13;
<dd>&#13;
<p>Sets the “from” name and address—​represents the author</p>&#13;
</dd>&#13;
<dt><code>subject: <em>string</em></code></dt>&#13;
<dd>&#13;
<p>Sets the email subject</p>&#13;
</dd>&#13;
<dt><code>cc: <em>Address</em></code></dt>&#13;
<dd>&#13;
<p>Sets the CC</p>&#13;
</dd>&#13;
<dt><code>bcc: <em>Address</em></code></dt>&#13;
<dd>&#13;
<p>Sets the BCC</p>&#13;
</dd>&#13;
<dt><code>replyTo: <em>Address</em></code></dt>&#13;
<dd>&#13;
<p>Sets the “reply to”</p>&#13;
</dd>&#13;
<dt><code>tags: <em>array</em></code></dt>&#13;
<dd>&#13;
<p>Sets the tags, if relevant for your email sender</p>&#13;
</dd>&#13;
<dt><code>metadata: <em>array</em></code></dt>&#13;
<dd>&#13;
<p>Sets the metadata, if relevant for your email sender</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Finally, if you want to perform any manual modifications on the underlying Symfony message, you can do that in the <code>using</code> parameter, as shown in <a data-type="xref" href="#modify_underlying_SymfonyMessage">Example 15-6</a>.</p>&#13;
<div data-type="example" id="modify_underlying_SymfonyMessage">&#13;
<h5><span class="label">Example 15-6. </span>Modifying the underlying <code>SymfonyMessage</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">envelope</code><code class="p">()</code><code class="o">:</code> <code class="nx">Envelope</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Envelope</code><code class="p">(</code>&#13;
        <code class="nx">subject</code><code class="o">:</code> <code class="s1">'Howdy!'</code><code class="p">,</code>&#13;
        <code class="nx">view</code><code class="o">:</code> <code class="s1">'emails.howdy'</code><code class="p">,</code>&#13;
        <code class="nx">using</code><code class="o">:</code> <code class="p">[</code>&#13;
            <code class="k">function</code> <code class="p">(</code><code class="nx">Email</code> <code class="nv">$message</code><code class="p">)</code> <code class="p">{</code>&#13;
                <code class="nv">$message</code><code class="o">-&gt;</code><code class="na">setReplyTo</code><code class="p">(</code><code class="s1">'noreply@email.com'</code><code class="p">);</code>&#13;
            <code class="p">},</code>&#13;
        <code class="p">],</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attaching Files and Inlining Images" data-type="sect2"><div class="sect2" id="id518">&#13;
<h2>Attaching Files and Inlining Images</h2>&#13;
&#13;
<p>To<a data-primary="mail" data-secondary="attaching files and inlining images" data-type="indexterm" id="Mattach15"/><a data-primary="files" data-secondary="attaching to emails" data-type="indexterm" id="Fattach15"/> attach a file to your mail, return an array (in which each entry is an <code>Attachment</code>) from the <code>attachments()</code> method, as shown in <a data-type="xref" href="#attach_files_or_data_to_mailables">Example 15-7</a>.</p>&#13;
<div data-type="example" id="attach_files_or_data_to_mailables">&#13;
<h5><span class="label">Example 15-7. </span>Attaching files or data to mailables</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Mail\Mailables\Attachment</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// Attach a file using the local filename</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
         <code class="nx">Attachment</code><code class="o">::</code><code class="na">fromPath</code><code class="p">(</code><code class="s1">'/absolute/path/to/file'</code><code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Attach a file using storage disks</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="c1">// Attach from default disk</code>&#13;
        <code class="nx">Attachment</code><code class="o">::</code><code class="na">fromStorage</code><code class="p">(</code><code class="s1">'/path/to/file'</code><code class="p">),</code>&#13;
        <code class="c1">// Attach from custom disk</code>&#13;
        <code class="nx">Attachment</code><code class="o">::</code><code class="na">fromStorageDisk</code><code class="p">(</code><code class="s1">'s3'</code><code class="p">,</code> <code class="s1">'/path/to/file'</code><code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Attach a file passing the raw data</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="nx">Attachment</code><code class="o">::</code><code class="na">fromData</code><code class="p">(</code><code class="nx">fn</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nb">file_get_contents</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">pdf</code><code class="p">),</code> <code class="s1">'whitepaper.pdf'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">withMime</code><code class="p">(</code><code class="s1">'application/pdf'</code><code class="p">),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attachable mail objects" data-type="sect3"><div class="sect3" id="id716">&#13;
<h3>Attachable mail objects</h3>&#13;
&#13;
<p>If you have a PHP class that can be represented as an attachment to an email, or if you’d like to build a PHP class full of logic around the objects you attach to your emails, you’ll want to try Laravel’s attachable objects.</p>&#13;
&#13;
<p>Each of these objects need only be a PHP class that implements the <code>Illuminate\Contracts\Mail\Attachable</code> interface, which requires a <code>toMailAttachment()</code> method, which returns an instance of <code>Illuminate\Mail\Attachment</code>.</p>&#13;
&#13;
<p>One common example would be if you want to make one of your Eloquent models attachable. In our example, we’ve been emailing our clients about a new assignment from their trainer, so let’s try making <code>Assignment</code> attachable. Take a look at <a data-type="xref" href="#making_model_attachable">Example 15-8</a>.</p>&#13;
<div data-type="example" id="making_model_attachable">&#13;
<h5><span class="label">Example 15-8. </span>Making an Eloquent model attachable</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Models</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Mail\Attachable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Mail\Attachment</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Assignment</code> <code class="k">extends</code> <code class="nx">Model</code> <code class="k">implements</code> <code class="nx">Attachable</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the attachable representation of the model.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toMailAttachment</code><code class="p">()</code><code class="o">:</code> <code class="nx">Attachment</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Attachment</code><code class="o">::</code><code class="na">fromPath</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">pdf_path</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If a class implements <code>Attachable</code>, you can use any instances of that class as entries in the array you return from <code>attachments()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">attachments</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assignment</code><code class="p">];</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inlining images" data-type="sect3"><div class="sect3" id="id301">&#13;
<h3>Inlining images</h3>&#13;
&#13;
<p>If<a data-primary="images, attaching to emails" data-type="indexterm" id="id1809"/> you want to attach images inline, directly into your email, Laravel provides a feature for that as well, as you can see in <a data-type="xref" href="#inlining_images">Example 15-9</a>.<a data-primary="" data-startref="Mattach15" data-type="indexterm" id="id1810"/><a data-primary="" data-startref="Fattach15" data-type="indexterm" id="id1811"/></p>&#13;
<div data-type="example" id="inlining_images">&#13;
<h5><span class="label">Example 15-9. </span>Inlining images in email</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="cm">&lt;!-- emails/image.blade.php --&gt;</code>&#13;
Here is an image:&#13;
&#13;
<code class="p">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="s">"{{ $message-&gt;embed(storage_path('embed.jpg')) }}"</code><code class="p">&gt;</code>&#13;
&#13;
Or, the same image embedding the data:&#13;
&#13;
<code class="p">&lt;</code><code class="nt">img</code> <code class="na">src</code><code class="o">=</code><code class="s">"{{ $message-&gt;embedData(</code>&#13;
<code class="s">    file_get_contents(storage_path('embed.jpg')), 'embed.jpg'</code>&#13;
<code class="s">) }}"</code><code class="p">&gt;</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Markdown Mailables" data-type="sect2"><div class="sect2" id="markdown_mailables">&#13;
<h2>Markdown Mailables</h2>&#13;
&#13;
<p>Markdown mailables<a data-primary="mail" data-secondary="writing content in Markdown" data-type="indexterm" id="Mmarkdown15"/><a data-primary="Markdown mailables" data-type="indexterm" id="mrkdmlb15"/><a data-primary="--markdown flag" data-type="indexterm" id="id1812"/> allow you to write your email content in Markdown, after which it will be converted into full HTML (and plain-text) emails with Laravel’s built-in, responsive HTML templates. You can also tweak these templates to make a customized email template that’s simple for your developers and nondevelopers to create content for.</p>&#13;
&#13;
<p>First, run the <code>make:mail</code> Artisan command with the <code>markdown</code> flag:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:mail<code class="w"> </code>AssignmentCreated<code class="w"> </code>--markdown<code class="o">=</code>emails.assignment-created<code class="w"/></pre>&#13;
&#13;
<p>You can see an example of what the generated mail file looks like in <a data-type="xref" href="#generated_markdown_mailable">Example 15-10</a>.</p>&#13;
<div data-type="example" id="generated_markdown_mailable">&#13;
<h5><span class="label">Example 15-10. </span>Generated Markdown mailable</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">AssignmentCreated</code> <code class="k">extends</code> <code class="nx">Mailable</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">content</code><code class="p">()</code><code class="o">:</code> <code class="nx">Content</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Content</code><code class="p">(</code>&#13;
            <code class="nx">markdown</code><code class="o">:</code> <code class="s1">'emails.assignment-created'</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, this is almost exactly the same as a normal mailable file in Laravel. The main difference is that you’re passing your template into the <code>markdown</code> parameter instead of the <code>view</code> parameter. Also note that the template you’re referencing should represent a Markdown template, not a normal Blade template.</p>&#13;
&#13;
<p>What’s a <em>Markdown template</em>? Unlike a normal Blade email template, which is expected—​with the use of includes and inheritance like any Blade file—​to generate a full HTML email, Markdown templates simply pass Markdown content to a few predefined components.</p>&#13;
&#13;
<p>These components will look like <code>&lt;x-mail::component-name-here&gt;</code>, and, as such, the main body of your Markdown email should be passed into a component named <code>&lt;x-mail::message&gt;</code>. Take a look at <a data-type="xref" href="#simple_assignment_markdown_email">Example 15-11</a> to see an example of a simple Markdown mail template.</p>&#13;
<div data-type="example" id="simple_assignment_markdown_email">&#13;
<h5><span class="label">Example 15-11. </span>Simple assignment Markdown email</h5>&#13;
&#13;
<pre data-type="programlisting">{{-- resources/views/emails/assignment-created.blade.php --}}&#13;
&lt;x-mail::message&gt;&#13;
# Hey {{ $trainee-&gt;name }}!&#13;
&#13;
You have received a new training assignment from **{{ $trainer-&gt;name }}**&#13;
&#13;
&lt;x-mail::button :url="route('training-dashboard')"&gt;&#13;
View Your Assignment&#13;
&lt;/x-mail::button&gt;&#13;
&#13;
Thanks,&lt;br&gt;&#13;
{{ config('app.name') }}&#13;
&lt;/x-mail::message&gt;</pre></div>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#simple_assignment_markdown_email">Example 15-11</a>, there’s a parent <code>mail::message</code> component to which you pass the body of your email, but you’re also provided with other, smaller components you can sprinkle into your emails. We used the <code>mail::button</code> component here, which takes the content (“View Your Assignment”) but also requires the <code>url</code> attribute to be passed.</p>&#13;
&#13;
<p>There are three types of components available:</p>&#13;
<dl>&#13;
<dt>Button</dt>&#13;
<dd>&#13;
<p>Generates a centered button link. The button component requires a <code>url</code> attribute and allows an optional <code>color</code> attribute, to which you can pass <code>primary</code>, <code>success</code>, or <code>error</code>.</p>&#13;
</dd>&#13;
<dt>Panel</dt>&#13;
<dd>&#13;
<p>Renders the provided text with a slightly lighter background than the rest of the message.</p>&#13;
</dd>&#13;
<dt>Table</dt>&#13;
<dd>&#13;
<p>Converts the content passed into it via the Markdown table syntax.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h1>Customizing the Components</h1>&#13;
<p>These<a data-primary="--tag flag" data-type="indexterm" id="id1813"/> Markdown components are built into the core of the Laravel framework, but if you need to customize how they work, you can publish their files and edit them:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>vendor:publish<code class="w"> </code>--tag<code class="o">=</code>laravel-mail<code class="w"/></pre>&#13;
</div>&#13;
&#13;
<p>You can learn more about customizing these files and their themes in the <a href="https://oreil.ly/R4Gr9">Laravel docs</a>.<a data-primary="" data-startref="mrkdmlb15" data-type="indexterm" id="id1814"/><a data-primary="" data-startref="Mmarkdown15" data-type="indexterm" id="id1815"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Rendering Mailables to the Browser" data-type="sect2"><div class="sect2" id="id519">&#13;
<h2>Rendering Mailables to the Browser</h2>&#13;
&#13;
<p>When<a data-primary="mail" data-secondary="rendering mailables to the browser" data-type="indexterm" id="id1816"/> you’re developing emails in your applications, it’s helpful to be able to preview how they’ll render. You can rely on a tool like Mailtrap for this, and that is a useful tool, but it can also be helpful to render the mails directly in your browser and see your changes made immediately.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#rendering_mailables">Example 15-12</a> to see a sample route you can add to your application to render a given mailable.</p>&#13;
<div data-type="example" id="rendering_mailables">&#13;
<h5><span class="label">Example 15-12. </span>Rendering a mailable to a route</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'preview-assignment-created-mailable'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$trainer</code> <code class="o">=</code> <code class="nx">Trainer</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
    <code class="nv">$trainee</code> <code class="o">=</code> <code class="nx">Trainee</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">\App\Mail\AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Laravel also provides a way to quickly preview a notification in the browser:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'preview-notification'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$trainer</code> <code class="o">=</code> <code class="nx">Trainer</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
    <code class="nv">$trainee</code> <code class="o">=</code> <code class="nx">Trainee</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
    <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">App\Notifications\AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">))</code>&#13;
        <code class="o">-&gt;</code><code class="na">toMail</code><code class="p">(</code><code class="nv">$trainee</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues" data-type="sect2"><div class="sect2" id="queued_mail">&#13;
<h2>Queues</h2>&#13;
&#13;
<p>Sending email<a data-primary="mail" data-secondary="queuing messages" data-type="indexterm" id="id1817"/><a data-primary="queues and queueing" data-secondary="queuing email messages" data-type="indexterm" id="id1818"/><a data-primary="messages" data-secondary="queueing email messages" data-type="indexterm" id="id1819"/> is a time-consuming task that can cause applications to slow down, so it’s common to move it to a background queue. It’s so common, in fact, that Laravel has a set of built-in tools to make it easier to queue your messages without writing queue jobs for each email:</p>&#13;
<dl>&#13;
<dt><code>queue()</code></dt>&#13;
<dd>&#13;
<p>To<a data-primary="queues and queueing" data-secondary="queue() method" data-type="indexterm" id="id1820"/> queue a mail object instead of sending it immediately, simply pass your mailable object to <code>Mail::queue()</code> instead of <code>Mail::send()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"> <code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">queue</code><code class="p">(</code><code class="k">new</code> <code class="nx">AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">));</code></pre>&#13;
</dd>&#13;
<dt><code>later()</code></dt>&#13;
<dd>&#13;
<p><code>Mail::later()</code> works the<a data-primary="later() method" data-type="indexterm" id="id1821"/> same as <code>Mail::queue()</code>, but it allows you to add a delay—​either in minutes or by specifying a specific time by passing an instance of <code>DateTime</code> or <code>Carbon</code>—specifying when the email will be pulled from the queue and sent:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"> <code class="nv">$when</code> <code class="o">=</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addMinutes</code><code class="p">(</code><code class="mi">30</code><code class="p">);</code>&#13;
 <code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">later</code><code class="p">(</code><code class="nv">$when</code><code class="p">,</code> <code class="k">new</code> <code class="nx">AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code>  <code class="nv">$trainee</code><code class="p">));</code></pre>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="warning" epub:type="warning"><h1>Configuring Queues</h1>&#13;
<p>Your queues must be configured correctly for these methods to work. Take a look at <a data-type="xref" href="ch16.html#queues_jobs_events">Chapter 16</a> to learn more about how queues work and how to get them running in your application.</p>&#13;
</div>&#13;
&#13;
<p>For both <code>queue()</code> and <code>later()</code>, if you’d like to specify which queue or queue connection your mail is added to, use the <code>onConnection()</code> and <code>onQueue()</code> methods on your mailable object:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$message</code> <code class="o">=</code> <code class="p">(</code><code class="k">new</code> <code class="nx">AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">))</code>&#13;
    <code class="o">-&gt;</code><code class="na">onConnection</code><code class="p">(</code><code class="s1">'sqs'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">onQueue</code><code class="p">(</code><code class="s1">'emails'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">to</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">queue</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you’d like to direct that a given mailable should always be queued, you can make the mailable implement the <code>Illuminate\Contracts\Queue\ShouldQueue</code> interface.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Local Development" data-type="sect2"><div class="sect2" id="id520">&#13;
<h2>Local Development</h2>&#13;
&#13;
<p>This<a data-primary="development environment" data-secondary="for email services" data-secondary-sortas="email services" data-type="indexterm" id="id1822"/><a data-primary="mail" data-secondary="local development tools" data-type="indexterm" id="id1823"/><a data-primary="testing" data-secondary="mail services" data-type="indexterm" id="id1824"/> is all well and good for sending mail in your production environments. But how do you test it all out? There are two primary tools you’ll want to consider: Laravel’s <code>log</code> driver and fake inboxes for testing, such as Mailtrap.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The log driver" data-type="sect3"><div class="sect3" id="id521">&#13;
<h3>The log driver</h3>&#13;
&#13;
<p>Laravel provides<a data-primary="logging" data-secondary="log driver for email" data-type="indexterm" id="id1825"/> a <code>log</code> driver that logs every email you try to send to your local &#13;
<span class="keep-together"><em>laravel.log</em></span> file (which is, by default, in <em>storage/logs</em>).</p>&#13;
&#13;
<p>To use this, edit <em>.env</em> and set <code>MAIL_MAILER</code> to <code>log</code>. Now open up or <span class="keep-together">tail <em>storage/logs/laravel.log</em></span> and send an email from your app. You’ll see something <span class="keep-together">like this:</span></p>&#13;
&#13;
<pre data-type="programlisting">Message-ID: &lt;04ee2e97289c68f0c9191f4b04fc0de1@localhost&gt;&#13;
Date: Tue, 17 May 2016 02:52:46 +0000&#13;
Subject: Welcome to our app!&#13;
From: Matt Stauffer &lt;matt@mattstauffer.com&gt;&#13;
To: freja@jensen.no&#13;
MIME-Version: 1.0&#13;
Content-Type: text/html; charset=utf-8&#13;
Content-Transfer-Encoding: quoted-printable&#13;
&#13;
Welcome to our app!</pre>&#13;
&#13;
<p>You can optionally specify that logged mail gets sent to a different log channel than the rest of your logs. Either modify <em>config/mail.php</em> or set the <code>MAIL_LOG_CHANNEL</code> variable in your <em>.env</em> file to the name of any existing log channel.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Fake inboxes" data-type="sect3"><div class="sect3" id="id304">&#13;
<h3>Fake inboxes</h3>&#13;
&#13;
<p>If<a data-primary="fakes" data-secondary="fake inboxes" data-type="indexterm" id="id1826"/><a data-primary="inboxes, fake for testing" data-type="indexterm" id="id1827"/> you want to see your test emails as they’ll look in a real inbox, you can use one of several services that allow you to send your emails to them and show you your emails in a full fake inbox.</p>&#13;
&#13;
<p>The two most common such services are Mailtrap, a paid SaaS that requires no setup and allows you to share your inbox with coworkers and clients, and Mailpit, a service you can run on your local machine through Docker.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mailtrap" data-type="sect4"><div class="sect4" id="id305">&#13;
<h4>Mailtrap</h4>&#13;
&#13;
<p><a href="https://mailtrap.io">Mailtrap</a> is<a data-primary="Mailtrap" data-type="indexterm" id="id1828"/> a service for capturing and inspecting emails in development environments. You send your mail to the Mailtrap servers via SMTP, but instead of sending those emails off to the intended recipients, Mailtrap captures them all and provides you with a web-based email client for inspecting them, regardless of which email address is in the <code>to</code> field.</p>&#13;
&#13;
<p>To set up Mailtrap, sign up for a free account and visit the base dashboard for your demo. Copy your username and password from the SMTP column.</p>&#13;
&#13;
<p>Then edit your app’s <em>.env</em> file and set the following values in the <code>mail</code> section:</p>&#13;
&#13;
<pre data-type="programlisting">MAIL_MAILER=smtp&#13;
MAIL_HOST=mailtrap.io&#13;
MAIL_PORT=2525&#13;
MAIL_USERNAME=your_username_from_mailtrap_here&#13;
MAIL_PASSWORD=your_password_from_mailtrap_here&#13;
MAIL_ENCRYPTION=null</pre>&#13;
&#13;
<p>Now, any email you send from your app will show up in your Mailtrap inbox.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mailpit" data-type="sect4"><div class="sect4" id="id306">&#13;
<h4>Mailpit</h4>&#13;
&#13;
<p>If<a data-primary="Mailpit" data-type="indexterm" id="id1829"/> you like the idea of Mailtrap, but you’d like to run the application locally (and for free), you can use <a href="https://oreil.ly/dPgRK">Mailpit</a>, a Mailtrap alternative you can spin up in a local Docker container.</p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Notifications" data-type="sect1"><div class="sect1" id="id307">&#13;
<h1>Notifications</h1>&#13;
&#13;
<p>The<a data-primary="notifications" data-secondary="purpose of" data-type="indexterm" id="id1830"/> purpose of most of the mail that’s sent from web apps is to notify users that a particular action has happened or needs to happen. As users’ communication preferences grow more and more diverse, we<a data-primary="notifications" data-secondary="services supported" data-type="indexterm" id="id1831"/> gather ever more—and more disparate—packages to communicate via Slack, SMS, and other means.</p>&#13;
&#13;
<p>To support these preferences, Laravel introduced a concept called, fittingly, <em>notifications</em>. Just like a mailable, a notification is a PHP class that represents a single communication that you might want to send to your users. For now, let’s imagine we’re notifying the users of our physical training app that they have a new workout &#13;
<span class="keep-together">available</span>.</p>&#13;
&#13;
<p>Each<a data-primary="notifications" data-secondary="notification channels" data-type="indexterm" id="id1832"/> class represents all of the information necessary to send notifications to your users <em>using one or many notification channels</em>. A single notification could send an email, send an SMS via Vonage, send a WebSocket ping, add a record to a database, send a message to a Slack channel, and much more.</p>&#13;
&#13;
<p>So, let’s<a data-primary="notifications" data-secondary="creating" data-type="indexterm" id="Ncreate15"/> create our notification:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:notification<code class="w"> </code>WorkoutAvailable<code class="w"/></pre>&#13;
&#13;
<p><a data-type="xref" href="#autogenerated_notification_class">Example 15-13</a> shows what that gives us.</p>&#13;
<div data-type="example" id="autogenerated_notification_class">&#13;
<h5><span class="label">Example 15-13. </span>An autogenerated notification class</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Notifications</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Bus\Queueable</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Notifications\Notification</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Queue\ShouldQueue</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Notifications\Messages\MailMessage</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">WorkoutAvailable</code> <code class="k">extends</code> <code class="nx">Notification</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Queueable</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Create a new notification instance.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the notification's delivery channels.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;int, string&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">via</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code><code class="s1">'mail'</code><code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the mail representation of the notification.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toMail</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="nx">MailMessage</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">MailMessage</code><code class="p">)</code>&#13;
                    <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'The introduction to the notification.'</code><code class="p">)</code>&#13;
                    <code class="o">-&gt;</code><code class="na">action</code><code class="p">(</code><code class="s1">'Notification Action'</code><code class="p">,</code> <code class="nx">url</code><code class="p">(</code><code class="s1">'/'</code><code class="p">))</code>&#13;
                    <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'Thank you for using our application!'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the array representation of the notification.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array&lt;string, mixed&gt;</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="c1">//</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We can learn a few things here. First, we’re going to pass relevant data into <span class="keep-together">the constructor.</span> Second, there’s<a data-primary="via() method" data-type="indexterm" id="id1833"/> a <code>via()</code> method that allows us to define, for a given user, which notification channels to use<a data-primary="$notifiable property" data-type="indexterm" id="id1834"/> (<code>$notifiable</code> represents whatever entities you want to notify in your system; for most apps, it’ll be a user, but that’s not always the case). And third, there are individual methods for each notification channel that allow us to specifically define how to send one of these notifications through that channel.</p>&#13;
<div data-type="note" epub:type="note"><h1>When Would a $notifiable Not Be a User?</h1>&#13;
<p>Although the most common notification targets will be users, it’s possible you may want to notify something else. This may simply be because your application has multiple user types—so, you might want to be able to notify both trainers and trainees. But you also might find yourself wanting to notify a group, a company, or <span class="keep-together">a server.</span></p>&#13;
</div>&#13;
&#13;
<p>So, let’s modify this class for our <code>WorkoutAvailable</code> example. Take<a data-primary="" data-startref="Ncreate15" data-type="indexterm" id="id1835"/> a look at <a data-type="xref" href="#EX1419">Example 15-14</a>.</p>&#13;
<div data-type="example" id="EX1419">&#13;
<h5><span class="label">Example 15-14. </span>Our <code>WorkoutAvailable</code> notification class</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">WorkoutAvailable</code> <code class="k">extends</code> <code class="nx">Notification</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">Queueable</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="k">public</code> <code class="nv">$workout</code><code class="p">)</code> <code class="p">{}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">via</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// This method doesn't exist on the User... we're going to make it up</code>&#13;
        <code class="k">return</code> <code class="nv">$notifiable</code><code class="o">-&gt;</code><code class="na">preferredNotificationChannels</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toMail</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="nx">MailMessage</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">MailMessage</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'You have a new workout available!'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">action</code><code class="p">(</code><code class="s1">'Check it out now'</code><code class="p">,</code> <code class="nx">route</code><code class="p">(</code><code class="s1">'workout.show'</code><code class="p">,</code> <code class="p">[</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">workout</code><code class="p">]))</code>&#13;
            <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'Thank you for training with us!'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toArray</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining the via() Method for Your Notifiables" data-type="sect2"><div class="sect2" id="id308">&#13;
<h2>Defining the via() Method for Your Notifiables</h2>&#13;
&#13;
<p>As<a data-primary="notifications" data-secondary="defining via() method" data-type="indexterm" id="id1836"/><a data-primary="via() method" data-type="indexterm" id="id1837"/> you can see in <a data-type="xref" href="#EX1419">Example 15-14</a>, we’re responsible for deciding, for each notification and each notifiable, which notification channels we’re going to use.</p>&#13;
&#13;
<p>You could just send everything as mail or just send everything as an SMS (<a data-type="xref" href="#simplest_via_method">Example 15-15</a>).</p>&#13;
<div data-type="example" id="simplest_via_method">&#13;
<h5><span class="label">Example 15-15. </span>Simplest possible <code>via()</code> method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">via</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="s1">'vonage'</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You could also let each user choose a preferred method and save that on the <code>User</code> itself (<a data-type="xref" href="#customizing_via_method">Example 15-16</a>).</p>&#13;
<div data-type="example" id="customizing_via_method">&#13;
<h5><span class="label">Example 15-16. </span>Customizing the <code>via()</code> method per user</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">via</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$notifiable</code><code class="o">-&gt;</code><code class="na">preferred_notification_channel</code><code class="p">;</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Or, as we imagined in <a data-type="xref" href="#EX1419">Example 15-14</a>, you could create a method on each notifiable that allows for some complex notification logic. For example, you could notify the user over certain channels during work hours and other channels in the evening. What is important is that <code>via()</code> is a PHP class method, so you can do whatever complex logic you want there.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending Notifications" data-type="sect2"><div class="sect2" id="id522">&#13;
<h2>Sending Notifications</h2>&#13;
&#13;
<p>There<a data-primary="notifications" data-secondary="sending" data-type="indexterm" id="id1838"/> are two ways to send a notification: using the <code>Notification</code> facade, or adding the <code>Notifiable</code> trait to an Eloquent class (likely your <code>User</code> class).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending notifications using the notification facade" data-type="sect3"><div class="sect3" id="id717">&#13;
<h3>Sending notifications using the notification facade</h3>&#13;
&#13;
<p>The <code>Notification</code> facade is the clumsier of the two methods, since you have to pass both the notifiable and the notification. However, it’s helpful because you can choose to pass more than one notifiable at the same time, as shown in <a data-type="xref" href="#EX1417">Example 15-17</a>.</p>&#13;
<div data-type="example" id="EX1417">&#13;
<h5><span class="label">Example 15-17. </span>Sending a notification using the <code>Notification</code> facade</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Notifications\WorkoutAvailable</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
<code class="nx">Notification</code><code class="o">::</code><code class="na">send</code><code class="p">(</code><code class="nv">$users</code><code class="p">,</code> <code class="k">new</code> <code class="nx">WorkoutAvailable</code><code class="p">(</code><code class="nv">$workout</code><code class="p">));</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sending notifications using the notifiable trait" data-type="sect3"><div class="sect3" id="id718">&#13;
<h3>Sending notifications using the notifiable trait</h3>&#13;
&#13;
<p>Any model that imports the <code>Laravel\Notifications\Notifiable</code> trait (which the <code>App\User</code> class does by default) has a <code>notify()</code> method that can be passed a notification, which will look like <a data-type="xref" href="#EX1418">Example 15-18</a>.</p>&#13;
<div data-type="example" id="EX1418">&#13;
<h5><span class="label">Example 15-18. </span>Sending a notification using the <code>Notifiable</code> trait</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Notifications\WorkoutAvailable</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">notify</code><code class="p">(</code><code class="k">new</code> <code class="nx">WorkoutAvailable</code><code class="p">(</code><code class="nv">$workout</code><code class="p">));</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queueing Notifications" data-type="sect2"><div class="sect2" id="id523">&#13;
<h2>Queueing Notifications</h2>&#13;
&#13;
<p>Most<a data-primary="notifications" data-secondary="queuing" data-type="indexterm" id="id1839"/> notification drivers need to use HTTP requests to send notifications, which could slow down your user experience. To deal with this you’ll probably want to queue your notifications. All notifications import the <code>Queueable</code> trait by default, so all you need to do is add <code>implements ShouldQueue</code> to your notification, and Laravel will instantly move it to a queue.</p>&#13;
&#13;
<p>As with any other queued features, you’ll need to make sure you have your queue settings configured correctly and a queue worker running.</p>&#13;
&#13;
<p>If you’d like to delay the delivery of a notification, you can run the <code>delay()</code> method on the notification:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$delayUntil</code> <code class="o">=</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addMinutes</code><code class="p">(</code><code class="mi">15</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">notify</code><code class="p">((</code><code class="k">new</code> <code class="nx">WorkoutAvailable</code><code class="p">(</code><code class="nv">$workout</code><code class="p">))</code><code class="o">-&gt;</code><code class="na">delay</code><code class="p">(</code><code class="nv">$delayUntil</code><code class="p">));</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Out-of-the-Box Notification Types" data-type="sect2"><div class="sect2" id="id524">&#13;
<h2>Out-of-the-Box Notification Types</h2>&#13;
&#13;
<p>Out of the box, Laravel comes with notification drivers for email, database, broadcast, Vonage SMS, and Slack. I’ll cover each briefly, but I’d recommend referring to the <a href="https://oreil.ly/VzICd">notifications docs</a> for more thorough introductions to each.</p>&#13;
&#13;
<p>It’s<a data-primary="notifications" data-secondary="creating notification drivers" data-type="indexterm" id="id1840"/> also easy to create your own notification drivers, and dozens of people already have; you can find them at the <a href="https://oreil.ly/6d4_L">Laravel Notification Channels website</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Email notifications" data-type="sect3"><div class="sect3" id="id309">&#13;
<h3>Email notifications</h3>&#13;
&#13;
<p>Let’s<a data-primary="notifications" data-secondary="email notifications" data-type="indexterm" id="id1841"/> take a look at how the email from our earlier example, <a data-type="xref" href="#EX1419">Example 15-14</a>, is built:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">toMail</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="nx">MailMessage</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">MailMessage</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'You have a new workout available!'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">action</code><code class="p">(</code><code class="s1">'Check it out now'</code><code class="p">,</code> <code class="nx">route</code><code class="p">(</code><code class="s1">'workouts.show'</code><code class="p">,</code> <code class="p">[</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">workout</code><code class="p">]))</code>&#13;
        <code class="o">-&gt;</code><code class="na">line</code><code class="p">(</code><code class="s1">'Thank you for training with us!'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The result is shown in <a data-type="xref" href="#default_notifiation_template">Figure 15-1</a>. The email notification system puts your application’s name in the header of the email; you can customize that app name in the <code>name</code> key of <em>config/app.php</em>.</p>&#13;
&#13;
<p>This email is automatically sent to the <code>email</code> property on the notifiable, but you can customize this behavior by adding a method to your notifiable class named <span class="keep-together"><code>routeNotificationForMail()</code></span> that returns the email address you’d like email notifications sent to.</p>&#13;
&#13;
<p>The email’s subject is set by parsing the notification class name and converting it to words. So, our <code>WorkoutAvailable</code> notification would have the default subject of “Workout Available.” You can also customize this by chaining the <code>subject()</code> method on the <code>MailMessage</code> in the <code>toMail()</code> method.</p>&#13;
&#13;
<p>If<a data-primary="--tag flag" data-type="indexterm" id="id1842"/> you want to modify the templates, publish them and edit to your heart’s content:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan vendor:publish --tag=laravel-notifications</pre>&#13;
&#13;
<figure><div class="figure" id="default_notifiation_template">&#13;
<img alt="An email sent with with the default notification template" src="assets/lur3_1501.png"/>&#13;
<h6><span class="label">Figure 15-1. </span>An email sent with the default notification template</h6>&#13;
</div></figure>&#13;
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1843">&#13;
<h1>Markdown Mail Notifications</h1>&#13;
<p>If<a data-primary="Markdown mailables" data-type="indexterm" id="id1844"/> you like working with Markdown emails (see <a data-type="xref" href="#markdown_mailables">“Markdown Mailables”</a>), you can also use the same <code>markdown()</code> method in your notifications, as shown in <a data-type="xref" href="#public-function-notification">Example 15-19</a>:</p>&#13;
<div data-type="example" id="public-function-notification">&#13;
<h5><span class="label">Example 15-19. </span>Using the <code>markdown()</code> method with notifications</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">toMail</code><code class="p">(</code><code class="nx">object</code> <code class="nv">$notifiable</code><code class="p">)</code><code class="o">:</code> <code class="nx">MailMessage</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">MailMessage</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">subject</code><code class="p">(</code><code class="s1">'Workout Available'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">markdown</code><code class="p">(</code><code class="s1">'emails.workout-available'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'workout'</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">workout</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can change the style of the default template to be an “error” message, which uses slightly different language and changes the primary button color to red. To do this, just add a call to the <code>error()</code> method to your <code>MailMessage</code> call chain in the <code>toMail()</code> method.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Database notifications" data-type="sect3"><div class="sect3" id="id525">&#13;
<h3>Database notifications</h3>&#13;
&#13;
<p>You<a data-primary="notifications" data-secondary="database notifications" data-type="indexterm" id="id1845"/><a data-primary="databases" data-secondary="database notifications" data-type="indexterm" id="id1846"/> can send notifications to a database table using the <code>database</code> notification channel. First, create your table with <code>php artisan notifications:table</code>. Next, create a <code>toDatabase()</code> method on your notification and return an array of data there. This data will be encoded as JSON and stored in the database table’s <code>data</code> column.</p>&#13;
&#13;
<p>The <code>Notifiable</code> trait adds a <code>notifications</code> relationship to any model it’s imported into, allowing you to easily access records in the notifications table. So if you’re using database notifications, you could do something like <a data-type="xref" href="#database-notifications">Example 15-20</a>:</p>&#13;
<div data-type="example" id="database-notifications">&#13;
<h5><span class="label">Example 15-20. </span>Iterating over a user’s database notifications</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">notifications</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Do something</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>The <code>database</code> notification channel also has the concept of whether or not a notification is “read.” You can scope to only the “unread” notifications as shown in <a data-type="xref" href="#unread-notifications">Example 15-21</a>:</p>&#13;
<div data-type="example" id="unread-notifications">&#13;
<h5><span class="label">Example 15-21. </span>Iterating over a user’s unread database notifications</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">unreadNotifications</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Do something</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>And you can mark one or all notifications as read, as <a data-type="xref" href="#marking-read-notifications">Example 15-22</a> demonstrates.</p>&#13;
<div data-type="example" id="marking-read-notifications">&#13;
<h5><span class="label">Example 15-22. </span>Marking database notifications as read</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Individual</code>&#13;
<code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">unreadNotifications</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nv">$condition</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$notification</code><code class="o">-&gt;</code><code class="na">markAsRead</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// All</code>&#13;
<code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">unreadNotifications</code><code class="o">-&gt;</code><code class="na">markAsRead</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Broadcast notifications" data-type="sect3"><div class="sect3" id="id310">&#13;
<h3>Broadcast notifications</h3>&#13;
&#13;
<p>The<a data-primary="notifications" data-secondary="broadcast notifications" data-type="indexterm" id="id1847"/><a data-primary="broadcast notifications" data-type="indexterm" id="id1848"/> <code>broadcast</code> channel sends notifications using Laravel’s event broadcasting features, which are powered by WebSockets (we’ll learn more about these in <a data-type="xref" href="ch16.html#broadcasting_events">“Broadcasting Events Over WebSockets, and Laravel Echo”</a>).</p>&#13;
&#13;
<p>Create a <code>toBroadcast()</code> method on your notification and return an array of data. If your app is correctly configured for event broadcasting, that data will be broadcast on a private channel named <code><em>notifiable.id</em></code>. The <code><em>id</em></code> will be the ID of the notifiable, and <code><em>notifiable</em></code> will be the notifiable’s fully qualified class name, with the slashes replaced by periods—​for example, the private channel for the <code>App\User</code> with the ID of <code>1</code> will be <code>App.User.1</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="SMS notifications" data-type="sect3"><div class="sect3" id="id311">&#13;
<h3>SMS notifications</h3>&#13;
&#13;
<p>SMS notifications<a data-primary="notifications" data-secondary="SMS notifications" data-type="indexterm" id="id1849"/><a data-primary="SMS notifications" data-type="indexterm" id="id1850"/> are sent via <a href="https://www.vonage.com">Vonage</a>, so if you want to send SMS notifications, sign up for a Vonage account and follow the instructions in the <a href="https://oreil.ly/VzICd">notifications docs</a>. Like with the other channels, you’ll be setting up a <code>toVonage()</code> method and customizing the SMS message there.</p>&#13;
<div data-type="note" epub:type="note"><h1>SMS Notification Package Install</h1>&#13;
<p>In Laravel, the SMS notification channel is a first-party package. If you want to use Vonage SMS notifications, simply require this package with Composer:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>laravel/vonage-notification-channel<code class="w"> </code><code class="se">\</code>&#13;
<code class="w">    </code>guzzlehttp/guzzle<code class="w"/></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Slack notifications" data-type="sect3"><div class="sect3" id="id312">&#13;
<h3>Slack notifications</h3>&#13;
&#13;
<p>The<a data-primary="notifications" data-secondary="slack notifications" data-type="indexterm" id="id1851"/><a data-primary="slack notifications" data-type="indexterm" id="id1852"/> <code>slack</code> notification channel allows you to customize the appearance of your notifications and even attach files to them. As with the other channels, you’ll set up a <code>toSlack()</code> method and customize the message there.</p>&#13;
<div data-type="note" epub:type="note"><h1>Slack Notification Package Install</h1>&#13;
<p>Laravel’s Slack notification channel is a first-party package. If you want to use Slack notifications, simply require this package with Composer:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>laravel/slack-notification-channel<code class="w"/></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other notifications" data-type="sect3"><div class="sect3" id="id526">&#13;
<h3>Other notifications</h3>&#13;
&#13;
<p>Looking<a data-primary="notifications" data-secondary="other channels for" data-type="indexterm" id="id1853"/> to send your notifications through other channels than those that come out of the box? There’s a robust community effort to provide an incredible variety of notification channels; check out what’s on offer at the <a href="https://oreil.ly/6d4_L">Laravel Notifications Channels website</a>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id719">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Let’s take a look at how to test mail and notifications.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mail" data-type="sect2"><div class="sect2" id="id527">&#13;
<h2>Mail</h2>&#13;
&#13;
<p>There<a data-primary="mail" data-secondary="testing" data-type="indexterm" id="Mtest15"/><a data-primary="testing" data-secondary="mail services" data-type="indexterm" id="Tmailserv15"/> are two aspects of our mail we can write assertions against: the mail’s content and attributes, and the fact that it was actually triggered to be sent. Let’s start with assertions against the mail’s content.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Asserting against the mail" data-type="sect3"><div class="sect3" id="id528">&#13;
<h3>Asserting against the mail</h3>&#13;
&#13;
<p>First, we<a data-primary="assertions" data-secondary="against emails" data-type="indexterm" id="Aemail15"/> can run assertions against the <code>envelope()</code> type data, as you can see in <a data-type="xref" href="#asserting_mailable_envelope_data">Example 15-23</a>.</p>&#13;
<div data-type="example" id="asserting_mailable_envelope_data">&#13;
<h5><span class="label">Example 15-23. </span>Asserting against a mailable’s envelope data</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$mailable</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">AssignmentCreated</code><code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nx">trainee</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertFrom</code><code class="p">(</code><code class="s1">'noreply@mytrainingapp.com'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertTo</code><code class="p">(</code><code class="s1">'user@gmail.com'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasCc</code><code class="p">(</code><code class="s1">'trainer@mytrainingapp.com'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasBcc</code><code class="p">(</code><code class="s1">'records@mytrainingapp.com'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasReplyTo</code><code class="p">(</code><code class="s1">'trainer@mytrainingap.com'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasSubject</code><code class="p">(</code><code class="s1">'New assignment from Faith Elizabeth'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasTag</code><code class="p">(</code><code class="s1">'assignments'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasMetadata</code><code class="p">(</code><code class="s1">'clientId'</code><code class="p">,</code> <code class="mi">4</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>Next, we can run assertions against the contents of the message, as you can see in <a data-type="xref" href="#asserting_mailable_contents">Example 15-24</a>.</p>&#13;
<div data-type="example" id="asserting_mailable_contents">&#13;
<h5><span class="label">Example 15-24. </span>Asserting against a mailable’s contents</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertSeeInHtml</code><code class="p">(</code><code class="nv">$trainee</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertSeeInHtml</code><code class="p">(</code><code class="s1">'You have received a new training assignment'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertSeeInOrderInHtml</code><code class="p">([</code><code class="s1">'Hey'</code><code class="p">,</code> <code class="s1">'You have received'</code><code class="p">]);</code>&#13;
&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertSeeInText</code><code class="p">(</code><code class="nv">$trainee</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertSeeInOrderInText</code><code class="p">([</code><code class="s1">'Hey'</code><code class="p">,</code> <code class="s1">'You have received'</code><code class="p">]);</code></pre></div>&#13;
&#13;
<p>We can assert against attachments, as you can see in <a data-type="xref" href="#asserting_mailable_attachments">Example 15-25</a>.</p>&#13;
<div data-type="example" id="asserting_mailable_attachments">&#13;
<h5><span class="label">Example 15-25. </span>Asserting against mailable attachments</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasAttachment</code><code class="p">(</code><code class="s1">'/pdfs/assignment-24.pdf'</code><code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasAttachment</code><code class="p">(</code><code class="nx">Attachment</code><code class="o">::</code><code class="na">fromPath</code><code class="p">(</code><code class="s1">'/pdfs/assignment-24.pdf'</code><code class="p">));</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasAttachedData</code><code class="p">(</code><code class="nv">$pdfData</code><code class="p">,</code> <code class="s1">'assignment-24.pdf'</code><code class="p">,</code> <code class="p">[</code>&#13;
    <code class="s1">'mime'</code> <code class="o">=&gt;</code> <code class="s1">'application/pdf'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasAttachmentFromStorage</code><code class="p">(</code>&#13;
    <code class="s1">'/pdfs/assignment-24.pdf'</code><code class="p">,</code>&#13;
    <code class="s1">'assignment-24.pdf'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="s1">'mime'</code> <code class="o">=&gt;</code> <code class="s1">'application/pdf'</code><code class="p">]</code>&#13;
<code class="p">);</code>&#13;
<code class="nv">$mailable</code><code class="o">-&gt;</code><code class="na">assertHasAttachmentFromStorageDisk</code><code class="p">(</code>&#13;
    <code class="s1">'s3'</code><code class="p">,</code>&#13;
    <code class="s1">'/pdfs/assignment-24.pdf'</code><code class="p">,</code>&#13;
    <code class="s1">'assignment-24.pdf'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="s1">'mime'</code> <code class="o">=&gt;</code> <code class="s1">'application/pdf'</code><code class="p">]</code>&#13;
<code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Asserting whether the mail was sent" data-type="sect3"><div class="sect3" id="id313">&#13;
<h3>Asserting whether the mail was sent</h3>&#13;
&#13;
<p>To test what mail was (or wasn’t) sent, we’ll first want to run <code>Mail::fake()</code> to capture the mail actions for inspection. Then, we can run our various assertions, as you can see in <a data-type="xref" href="#asserting_against_mail_sending">Example 15-26</a>.</p>&#13;
<div data-type="example" id="asserting_against_mail_sending">&#13;
<h5><span class="label">Example 15-26. </span>Asserting against whether or not mail was sent</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Mail</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Call the code that sends the email</code>&#13;
&#13;
<code class="c1">// Assert that no mailables were sent</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertNothingSent</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Assert that a mailable was sent</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Assert a mailable was sent a certain number of times</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="mi">4</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Assert a mailable was not sent</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertNotSent</code><code class="p">(</code><code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Assertions for queued emails</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertQueued</code><code class="p">(</code><code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertNotQueued</code><code class="p">(</code><code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="nx">Mail</code><code class="o">::</code><code class="na">assertNothingQueued</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Laravel also allows us to pass a closure as the second parameter to these assertions, inspecting the emails to make sure they fit what we’re expecting. Take a look at <a data-type="xref" href="#examining_email_in_assertions">Example 15-27</a>.</p>&#13;
<div data-type="example" id="examining_email_in_assertions">&#13;
<h5><span class="label">Example 15-27. </span>Examining an email’s properties in assertions</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code>&#13;
    <code class="nx">AssignmentCreated</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="k">function</code> <code class="p">(</code><code class="nx">AssignmentCreated</code> <code class="nv">$mail</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$trainer</code><code class="p">,</code> <code class="nv">$trainee</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">hasTo</code><code class="p">(</code><code class="nv">$trainee</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">)</code> <code class="o">&amp;&amp;</code>&#13;
            <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">hasSubject</code><code class="p">(</code><code class="s1">'New assignment from '</code> <code class="o">.</code> <code class="nv">$trainer</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">);</code></pre></div>&#13;
&#13;
<p>You<a data-primary="" data-startref="Mtest15" data-type="indexterm" id="id1854"/><a data-primary="" data-startref="Tmailserv15" data-type="indexterm" id="id1855"/><a data-primary="" data-startref="Aemail15" data-type="indexterm" id="id1856"/> can also use <code>hasCc()</code>, <code>hasBcc()</code>, <code>hasReplyTo()</code>, and <code>hasFrom()</code>.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Notifications" data-type="sect2"><div class="sect2" id="id529">&#13;
<h2>Notifications</h2>&#13;
&#13;
<p>Laravel provides<a data-primary="notifications" data-secondary="testing" data-type="indexterm" id="id1857"/><a data-primary="testing" data-secondary="notifications" data-type="indexterm" id="id1858"/> a built-in set of assertions for testing your notifications. <a data-type="xref" href="#asserting_notifications_were_sent">Example 15-28</a> demonstrates.</p>&#13;
<div data-type="example" id="asserting_notifications_were_sent">&#13;
<h5><span class="label">Example 15-28. </span>Asserting notifications were sent</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_new_signups_triggers_admin_notification</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertSentTo</code><code class="p">(</code><code class="nv">$user</code><code class="p">,</code> <code class="nx">NewUsersSignedup</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">,</code> <code class="nv">$channels</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$notification</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">email</code> <code class="o">==</code> <code class="s1">'user-who-signed-up@gmail.com'</code>&#13;
            <code class="o">&amp;&amp;</code> <code class="nv">$channels</code> <code class="o">==</code> <code class="p">[</code><code class="s1">'mail'</code><code class="p">];</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Assert that the email was sent to a given user</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertSentTo</code><code class="p">(</code>&#13;
        <code class="p">[</code><code class="nv">$user</code><code class="p">],</code>&#13;
        <code class="nx">NewUsersSignedup</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// You can also use assertNotSentTo()</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertNotSentTo</code><code class="p">(</code>&#13;
        <code class="p">[</code><code class="nv">$userDidntSignUp</code><code class="p">],</code> <code class="nx">NewUsersSignedup</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id530">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Laravel’s mail and notification<a data-primary="mail" data-secondary="overview of" data-type="indexterm" id="id1859"/><a data-primary="notifications" data-secondary="overview of" data-type="indexterm" id="id1860"/> features provide simple, consistent interfaces to a variety of messaging systems. Laravel’s mail system uses mailables, PHP classes that represent emails, to provide a consistent syntax to different mail drivers. The notification system makes it easy to build a single notification that can be delivered in many different media—​from emails to SMS messages to physical postcards.</p>&#13;
</div></section>&#13;
</div></section></body></html>