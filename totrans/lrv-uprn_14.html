<html><head></head><body><section data-pdf-bookmark="Chapter 14. Storage and Retrieval" data-type="chapter" epub:type="chapter"><div class="chapter" id="storage_and_retrieval">&#13;
<h1><span class="label">Chapter 14. </span>Storage and Retrieval</h1>&#13;
&#13;
&#13;
<p>We looked at how to store data in relational databases in <a data-type="xref" href="ch05.html#database_and_eloquent">Chapter 5</a>, but there’s a lot more that can be stored, both locally and remotely. In this chapter we’ll cover filesystem and in-memory storage, file uploads and manipulation, nonrelational data stores, sessions, the cache, logging, cookies, and full-text search.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Local and Cloud File Managers" data-type="sect1"><div class="sect1" id="id280">&#13;
<h1>Local and Cloud File Managers</h1>&#13;
&#13;
<p>Laravel<a data-primary="storage and retrieval" data-secondary="available connections" data-type="indexterm" id="id1725"/> provides a series of file manipulation tools through the <code>Storage</code> facade and a few helper functions.</p>&#13;
&#13;
<p>Laravel’s filesystem access tools can connect to the local filesystem as well as to S3, Rackspace, and FTP. The S3 and Rackspace file drivers are provided by <a href="https://oreil.ly/2lP4P">Flysystem</a>, and it’s simple to<a data-primary="Flysystem providers" data-type="indexterm" id="id1726"/> add additional Flysystem providers, such as Dropbox or WebDAV, to your Laravel app.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuring File Access" data-type="sect2"><div class="sect2" id="id281">&#13;
<h2>Configuring File Access</h2>&#13;
&#13;
<p>The<a data-primary="storage and retrieval" data-secondary="local and cloud file managers" data-tertiary="configuring file access" data-type="indexterm" id="id1727"/> definitions for Laravel’s file manager live in <em>config/filesystems.php</em>. Each connection is called a “disk,” and <a data-type="xref" href="#default_available_storage_disks">Example 14-1</a> lists the disks that are available out of <span class="keep-together">the box.</span></p>&#13;
<div data-type="example" id="default_available_storage_disks">&#13;
<h5><span class="label">Example 14-1. </span>Default available storage disks</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="s1">'disks'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'local'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'local'</code><code class="p">,</code>&#13;
        <code class="s1">'root'</code> <code class="o">=&gt;</code> <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'app'</code><code class="p">),</code>&#13;
        <code class="s1">'throw'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
    <code class="s1">'public'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'local'</code><code class="p">,</code>&#13;
        <code class="s1">'root'</code> <code class="o">=&gt;</code> <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'app/public'</code><code class="p">),</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'APP_URL'</code><code class="p">)</code><code class="o">.</code><code class="s1">'/storage'</code><code class="p">,</code>&#13;
        <code class="s1">'visibility'</code> <code class="o">=&gt;</code> <code class="s1">'public'</code><code class="p">,</code>&#13;
        <code class="s1">'throw'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
    <code class="s1">'s3'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'s3'</code><code class="p">,</code>&#13;
        <code class="s1">'key'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_ACCESS_KEY_ID'</code><code class="p">),</code>&#13;
        <code class="s1">'secret'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_SECRET_ACCESS_KEY'</code><code class="p">),</code>&#13;
        <code class="s1">'region'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_DEFAULT_REGION'</code><code class="p">),</code>&#13;
        <code class="s1">'bucket'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_BUCKET'</code><code class="p">),</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'endpoint'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_ENDPOINT'</code><code class="p">),</code>&#13;
        <code class="s1">'use_path_style_endpoint'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'AWS_USE_PATH_STYLE_ENDPOINT'</code><code class="p">,</code> <code class="k">false</code><code class="p">),</code>&#13;
        <code class="s1">'throw'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
<code class="p">],</code></pre></div>&#13;
<div data-type="tip"><h1>The storage_path() Helper</h1>&#13;
<p>The <code>storage_path()</code> helper<a data-primary="helpers" data-secondary="storage_path() helper" data-type="indexterm" id="id1728"/><a data-primary="storage_path() helper" data-type="indexterm" id="id1729"/> used in <a data-type="xref" href="#default_available_storage_disks">Example 14-1</a> links to Laravel’s configured storage directory, <em>storage/</em>. Anything you pass to it <span class="keep-together">is added</span> to the end of the directory name, so  <code class="keep-together">storage</code><code>_path(</code><code class="keep-together">'public')</code> will return the string <code>storage/public</code>.</p>&#13;
</div>&#13;
&#13;
<p>The <code>local</code> disk connects to your local storage system and presumes it will be interacting with the <em>app</em> directory of the storage path, which is <em>storage/app</em>.</p>&#13;
&#13;
<p>The <code>public</code> disk is also a local disk (although you can change it if you’d like), which is intended for use with any files you intend to be served by your application. It defaults to the <em>storage/app/public</em> directory, and if you want to use this directory to serve files to the public, you’ll need to add a symbolic link (<em>symlink</em>) to somewhere within the <em>public/</em> directory. Thankfully, there’s an Artisan command that maps <em>public/storage</em> to serve the files from <em>storage/app/public</em>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>storage:link<code class="w"/></pre>&#13;
&#13;
<p>The <code>s3</code> disk shows how Laravel connects to cloud-based file storage systems. If you’ve ever connected to S3 or any other cloud storage provider, this will be familiar; pass it your key and secret and some information defining the “folder” you’re working with, which in S3 is the region and the bucket.</p>&#13;
<aside class="pagebreak-before less_space" data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1730">&#13;
<h1>S3, FTP, or SFTP Drivers Packages Required</h1>&#13;
<p>To<a data-primary="Composer" data-secondary="S3, STP, or SFTP drivers and" data-type="indexterm" id="id1731"/> use the S3, FTP, or SFTP drivers, you first need to install a Composer package for the desired driver.</p>&#13;
&#13;
<p>For S3:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>-W<code class="w"> </code>league/flysystem-aws-s3-v3<code class="w"> </code><code class="s2">"^3.0"</code><code class="w"/></pre>&#13;
&#13;
<p>For FTP:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>league/flysystem-ftp<code class="w"> </code><code class="s2">"^3.0"</code><code class="w"/></pre>&#13;
&#13;
<p>For SFTP:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>league/flysystem-sftp-v3<code class="w"> </code><code class="s2">"^3.0"</code><code class="w"/></pre>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the Storage Facade" data-type="sect2"><div class="sect2" id="id584">&#13;
<h2>Using the Storage Facade</h2>&#13;
&#13;
<p>In <em>config/filesystem.php</em> you<a data-primary="storage and retrieval" data-secondary="local and cloud file managers" data-tertiary="using the storage facade" data-tertiary-sortas="storage facade" data-type="indexterm" id="id1732"/> can set the default disk, which is what will be used any time you call the <code>Storage</code> facade without specifying a disk. To specify a disk, call <code>disk('<em>diskname</em>')</code> on the facade:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Storage</code><code class="o">::</code><code class="na">disk</code><code class="p">(</code><code class="s1">'s3'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'file.jpg'</code><code class="p">);</code></pre>&#13;
&#13;
<p>The filesystems all provide the following methods:</p>&#13;
<dl>&#13;
<dt><code>get('<em>file.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Retrieves the file at <code><em>file.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>json('<em>file.json</em>', $flags)</code></dt>&#13;
<dd>&#13;
<p>Retrieves the file at <code><em>file.json</em></code> and decodes its JSON contents</p>&#13;
</dd>&#13;
<dt><code>put('<em>file.jpg</em>', <em>$contentsOrStream</em>)</code></dt>&#13;
<dd>&#13;
<p>Puts the given file contents to <code><em>file.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>putFile('<em>myDir</em>', <em>$file</em>)</code></dt>&#13;
<dd>&#13;
<p>Puts the contents of a provided file (in the form of an instance of either <span class="keep-together"><code>Illuminate</code></span><code>\Http\File</code> or <code>Illuminate\Http\UploadedFile</code>) to the <code><em>myDir</em></code> directory, but with Laravel managing the entire streaming process and naming the file</p>&#13;
</dd>&#13;
<dt><code>exists('<em>file.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether <code><em>file.jpg</em></code> exists</p>&#13;
</dd>&#13;
<dt><code>getVisibility('<em>myPath</em>')</code></dt>&#13;
<dd>&#13;
<p>Gets the visibility for the given path (“public” or “private”)</p>&#13;
</dd>&#13;
<dt><code>setVisibility('<em>myPath</em>')</code></dt>&#13;
<dd>&#13;
<p>Sets the visibility for the given path (“public” or “private”)</p>&#13;
</dd>&#13;
<dt><code>copy('<em>file.jpg</em>', '<em>newfile.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Copies <code><em>file.jpg</em></code> to <code><em>newfile.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>move('<em>file.jpg</em>', '<em>newfile.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Moves <code><em>file.jpg</em></code> to <code><em>newfile.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>prepend('<em>my.log</em>', '<em>log text</em>')</code></dt>&#13;
<dd>&#13;
<p>Adds the <em><code>log text</code></em> content at the beginning of <code><em>my.log</em></code></p>&#13;
</dd>&#13;
<dt><code>append('<em>my.log</em>', '<em>log text</em>')</code></dt>&#13;
<dd>&#13;
<p>Adds the <em><code>log text</code></em> content to the end of <code><em>my.log</em></code></p>&#13;
</dd>&#13;
<dt><code>delete('<em>file.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Deletes <code><em>file.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>size('<em>file.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns the size in bytes of <code><em>file.jpg</em></code></p>&#13;
</dd>&#13;
<dt><code>lastModified('<em>file.jpg</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns the Unix timestamp when <code><em>file.jpg</em></code> was last modified</p>&#13;
</dd>&#13;
<dt><code>files('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns an array of filenames in the directory <code><em>myDir</em></code></p>&#13;
</dd>&#13;
<dt><code>allFiles('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns an array of filenames in the directory <code><em>myDir</em></code> and all its subdirectories</p>&#13;
</dd>&#13;
<dt><code>directories('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns an array of directory names in the directory <code><em>myDir</em></code></p>&#13;
</dd>&#13;
<dt><code>allDirectories('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Returns an array of directory names in the directory <code><em>myDir</em></code> and all its &#13;
<span class="keep-together">subdirectories</span></p>&#13;
</dd>&#13;
<dt><code>makeDirectory('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Creates a new directory</p>&#13;
</dd>&#13;
<dt><code>deleteDirectory('<em>myDir</em>')</code></dt>&#13;
<dd>&#13;
<p>Deletes <code><em>myDir</em></code></p>&#13;
</dd>&#13;
<dt><code>readStream('<em>my.log</em>')</code></dt>&#13;
<dd>&#13;
<p>Gets a resource to read <code><em>my.log</em></code></p>&#13;
</dd>&#13;
<dt><code>writeStream('<em>my.log</em>', $resource)</code></dt>&#13;
<dd>&#13;
<p>Writes a new file (<code><em>my.log</em></code>) using a stream</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="tip"><h1>Injecting an Instance</h1>&#13;
<p>If you’d prefer injecting an instance instead of using the <code>File</code> facade, typehint or inject <code>Illuminate\Filesystem\Filesystem</code> and you’ll have all the same methods available to you.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding Additional Flysystem Providers" data-type="sect2"><div class="sect2" id="id282">&#13;
<h2>Adding Additional Flysystem Providers</h2>&#13;
&#13;
<p>If<a data-primary="storage and retrieval" data-secondary="local and cloud file managers" data-tertiary="adding additional Flysystem providers" data-type="indexterm" id="id1733"/><a data-primary="Flysystem providers" data-type="indexterm" id="id1734"/> you want to add an additional Flysystem provider, you’ll need to “extend” Laravel’s native storage system. In a service provider somewhere—it could be the <code>boot()</code> method of <code>AppServiceProvider</code>, but it’d be more appropriate to create a unique service provider for each new binding—​use the <code>Storage</code> facade to add new storage systems, as seen in <a data-type="xref" href="#add_additional_Flysytem_providers">Example 14-2</a>.</p>&#13;
<div data-type="example" id="add_additional_Flysytem_providers">&#13;
<h5><span class="label">Example 14-2. </span>Adding additional Flysystem providers</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Some service provider</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">extend</code><code class="p">(</code><code class="s1">'dropbox'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$app</code><code class="p">,</code> <code class="nv">$config</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$client</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">DropboxClient</code><code class="p">(</code>&#13;
            <code class="nv">$config</code><code class="p">[</code><code class="s1">'accessToken'</code><code class="p">],</code> <code class="nv">$config</code><code class="p">[</code><code class="s1">'clientIdentifier'</code><code class="p">]</code>&#13;
        <code class="p">);</code>&#13;
&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">Filesystem</code><code class="p">(</code><code class="k">new</code> <code class="nx">DropboxAdapter</code><code class="p">(</code><code class="nv">$client</code><code class="p">));</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic File Uploads and Manipulation" data-type="sect1"><div class="sect1" id="id500">&#13;
<h1>Basic File Uploads and Manipulation</h1>&#13;
&#13;
<p>One<a data-primary="storage and retrieval" data-secondary="basic file uploads and manipulation" data-type="indexterm" id="id1735"/> of the more common usages for the <code>Storage</code> facade is accepting file uploads from your application’s users. Let’s look at a common workflow for that in <a data-type="xref" href="#common_user_upload_work_flow">Example 14-3</a>.</p>&#13;
<div data-type="example" id="common_user_upload_work_flow">&#13;
<h5><span class="label">Example 14-3. </span>Common user upload workflow</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">DogController</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">updatePicture</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">Dog</code> <code class="nv">$dog</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Storage</code><code class="o">::</code><code class="na">put</code><code class="p">(</code>&#13;
            <code class="s2">"dogs/</code><code class="si">{</code><code class="nv">$dog</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s2">"</code><code class="p">,</code>&#13;
            <code class="nb">file_get_contents</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s1">'picture'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">getRealPath</code><code class="p">())</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We <code>put()</code> to a file named <em>dogs/id</em>, and we grab our contents from the uploaded file. Every uploaded file is a descendant of the <code>SplFileInfo</code> class, which provides a <code>getRealPath()</code> method that returns the path to the file’s location. So, we get the temporary upload path for the user’s uploaded file, read it with <code>file_get_contents()</code>, and pass it into <code>Storage::put()</code>.</p>&#13;
&#13;
<p>Since we have this file available to us here, we can do anything we want to the file before we store it—use an image manipulation package to resize it if it’s an image, validate it and reject it if it doesn’t meet our criteria, or whatever else we like.</p>&#13;
&#13;
<p>If we want to upload this same file to S3 and we have our credentials stored in <em>config/filesystems.php</em>, we can simply adjust <a data-type="xref" href="#common_user_upload_work_flow">Example 14-3</a> to call <code>Storage::disk('s3')-&gt;put()</code>; we’ll now be uploading to S3. Take a look at <a data-type="xref" href="#uploads_using_intervention">Example 14-4</a> to see a more complex upload example.</p>&#13;
<div data-type="example" id="uploads_using_intervention">&#13;
<h5><span class="label">Example 14-4. </span>A more complex example of file uploads, using Intervention</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">DogController</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">updatePicture</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">Dog</code> <code class="nv">$dog</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$original</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s1">'picture'</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Resize image to max width 150</code>&#13;
        <code class="nv">$image</code> <code class="o">=</code> <code class="nx">Image</code><code class="o">::</code><code class="na">make</code><code class="p">(</code><code class="nv">$original</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">resize</code><code class="p">(</code><code class="mi">150</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$constraint</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nv">$constraint</code><code class="o">-&gt;</code><code class="na">aspectRatio</code><code class="p">();</code>&#13;
        <code class="p">})</code><code class="o">-&gt;</code><code class="na">encode</code><code class="p">(</code><code class="s1">'jpg'</code><code class="p">,</code> <code class="mi">75</code><code class="p">);</code>&#13;
&#13;
        <code class="nx">Storage</code><code class="o">::</code><code class="na">put</code><code class="p">(</code>&#13;
            <code class="s2">"dogs/thumbs/</code><code class="si">{</code><code class="nv">$dog</code><code class="o">-&gt;</code><code class="na">id</code><code class="si">}</code><code class="s2">"</code><code class="p">,</code>&#13;
            <code class="nv">$image</code><code class="o">-&gt;</code><code class="na">getEncoded</code><code class="p">()</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>I used an image library called <a href="http://image.intervention.io">Intervention</a> in <a data-type="xref" href="#uploads_using_intervention">Example 14-4</a> just as an example; you can use any library you want. The important point is that you have the freedom to manipulate the files however you want before you store them.</p>&#13;
<div data-type="tip"><h1>Using store() and storeAs() on the Uploaded File</h1>&#13;
<p>You can also store an uploaded file using the file itself. Learn more in <a data-type="xref" href="ch07.html#EX611">Example 7-18</a>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Simple File Downloads" data-type="sect1"><div class="sect1" id="id501">&#13;
<h1>Simple File Downloads</h1>&#13;
&#13;
<p>Just<a data-primary="storage and retrieval" data-secondary="simple file downloads" data-type="indexterm" id="id1736"/> like <code>Storage</code> makes it easy to accept uploads from users, it also simplifies the task of returning files to them. Take a look at <a data-type="xref" href="#simple_file_downloads">Example 14-5</a> for the simplest example.</p>&#13;
<div data-type="example" id="simple_file_downloads">&#13;
<h5><span class="label">Example 14-5. </span>Simple file downloads</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">downloadMyFile</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Storage</code><code class="o">::</code><code class="na">download</code><code class="p">(</code><code class="s1">'my-file.pdf'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Sessions" data-type="sect1"><div class="sect1" id="id283">&#13;
<h1>Sessions</h1>&#13;
&#13;
<p>Session storage<a data-primary="storage and retrieval" data-secondary="session storage" data-type="indexterm" id="SRsess14"/><a data-primary="sessions" data-type="indexterm" id="sessions14"/> is the primary tool we use in web applications to store state between page requests. Laravel’s session manager supports session drivers using files, cookies, a database, Memcached or Redis, DynamoDB, or in-memory arrays (which expire after the page request and are only good for tests).</p>&#13;
&#13;
<p>You can configure all of your session settings and drivers in <em>config/session.php</em>. You can choose whether or not to encrypt your session data, select which driver to use (<code>file</code> is the default), and specify more connection-specific details like the length of session storage and which files or database tables to use. Take a look at <a href="https://oreil.ly/AMp4T">the session docs</a> to learn about specific dependencies and settings you need to prepare for whichever driver you choose to use.</p>&#13;
&#13;
<p>The general API of the session tools allows you to save and retrieve data based on individual keys: <code>session()-&gt;put('<em>user_id</em>')</code> and <code>session()-&gt;get('<em>user_id</em>')</code>, for example. Make sure to avoid saving anything to a <code>flash</code> session key, since Laravel uses that internally for flash (only available for the next page request) session storage.</p>&#13;
<section class="" data-pdf-bookmark="Accessing the Session" data-type="sect2"><div class="sect2" id="accessing-the-session-J6uwfDCy">&#13;
<h2 class="less_space">Accessing the Session</h2>&#13;
&#13;
<p>The most common way to access the session is using the <code>Session</code> facade:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Session</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">);</code></pre>&#13;
&#13;
<p>But you can also use the <code>session()</code> method on any given Illuminate <code>Request</code> object, as in <a data-type="xref" href="#using_the_session_method">Example 14-6</a>.</p>&#13;
<div data-type="example" id="using_the_session_method">&#13;
<h5><span class="label">Example 14-6. </span>Using the <code>session()</code> method on a <code>Request</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Or you can inject an instance of <code>Illuminate\Session\Store</code>, as in <a data-type="xref" href="#injecting_the_backing_class_for_sessions">Example 14-7</a>.</p>&#13;
<div data-type="example" id="injecting_the_backing_class_for_sessions">&#13;
<h5><span class="label">Example 14-7. </span>Injecting the backing class for sessions</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Illuminate\Session\Store</code> <code class="nv">$session</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$session</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Finally, you can use the global <code>session()</code> helper. Use it with no parameters to get a session instance, with a single string parameter to “get” from the session, or with an array to “put” to the session, as demonstrated in <a data-type="xref" href="#using_the_global_session_helper">Example 14-8</a>.</p>&#13;
<div data-type="example" id="using_the_global_session_helper">&#13;
<h5><span class="label">Example 14-8. </span>Using the global <code>session()</code> helper</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Get</code>&#13;
<code class="nv">$value</code> <code class="o">=</code> <code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'key'</code><code class="p">);</code>&#13;
<code class="nv">$value</code> <code class="o">=</code> <code class="nx">session</code><code class="p">(</code><code class="s1">'key'</code><code class="p">);</code>&#13;
<code class="c1">// Put</code>&#13;
<code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">);</code>&#13;
<code class="nx">session</code><code class="p">([</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">]);</code></pre></div>&#13;
&#13;
<p>If you’re new to Laravel and not sure which to use, I’d recommend using the global helper.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Methods Available on Session Instances" data-type="sect2"><div class="sect2" id="id702">&#13;
<h2>Methods Available on Session Instances</h2>&#13;
&#13;
<p>The two most common methods are <code>get()</code> and <code>put()</code>, but let’s take a look at each of the available methods and their parameters:</p>&#13;
<dl>&#13;
<dt><code>session()-&gt;get(<em>$key</em>, <em>$fallbackValue</em>)</code></dt>&#13;
<dd>&#13;
<p><code>get()</code> pulls the value of the provided key out of the session. If there is no value attached to that key, it will return the fallback value instead (and if you don’t provide a fallback, it will return <code>null</code>). The fallback value can be a simple value or a closure, as you can see in the following examples:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$points</code> <code class="o">=</code> <code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'points'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$points</code> <code class="o">=</code> <code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'points'</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$points</code> <code class="o">=</code> <code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'points'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">(</code><code class="k">new</code> <code class="nx">PointGetterService</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">getPoints</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
</dd>&#13;
<dt><code>session()-&gt;put(<em>$key</em>, <em>$value</em>)</code></dt>&#13;
<dd>&#13;
<p><code>put()</code> stores the provided value in the session at the provided key:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'points'</code><code class="p">,</code> <code class="mi">45</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$points</code> <code class="o">=</code> <code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'points'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>session()-&gt;push(<em>$key</em>, <em>$value</em>)</code></dt>&#13;
<dd>&#13;
<p>If any of your session values are arrays, you can use <code>push()</code> to add a value to the array:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'friends'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'Saúl'</code><code class="p">,</code> <code class="s1">'Quang'</code><code class="p">,</code> <code class="s1">'Mechteld'</code><code class="p">]);</code>&#13;
&#13;
<code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">push</code><code class="p">(</code><code class="s1">'friends'</code><code class="p">,</code> <code class="s1">'Javier'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>session()-&gt;has(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p><code>has()</code> checks whether there’s a value set at the provided key:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'points'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// Do something</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>You can also pass an array of keys, and it only returns <code>true</code> if all of the keys exist.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>session()-&gt;has() and Null Values</h1>&#13;
<p>If a session value is set but the value is <code>null</code>, <code>session()</code><span class="keep-together"><code>-&gt;</code></span><code>has()</code> will return <code>false</code>.</p>&#13;
</div>&#13;
</dd>&#13;
<dt><code>session()-&gt;exists(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p><code>exists()</code> checks whether there’s a value set at the provided key, like <code>has()</code>, but unlike <code>has()</code>, it will return <code>true</code> even if the set value is <code>null</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">exists</code><code class="p">(</code><code class="s1">'points'</code><code class="p">))</code> <code class="p">{</code>&#13;
    <code class="c1">// returns true even if 'points' is set to null</code>&#13;
<code class="p">}</code></pre>&#13;
</dd>&#13;
<dt><code>session()-&gt;all()</code></dt>&#13;
<dd>&#13;
<p><code>all()</code> returns an array of everything that’s in the session, including those values set by the framework. You’ll likely see values under keys like <code>_token</code> (CSRF tokens), <code>_previous</code> (previous page, for <code>back()</code> redirects), and <code>flash</code> (for flash storage).</p>&#13;
</dd>&#13;
<dt><code>session()-&gt;only()</code></dt>&#13;
<dd>&#13;
<p><code>only()</code> returns an array of only the specified values in the session.</p>&#13;
</dd>&#13;
<dt><code>session()-&gt;forget(<em>$key</em>)</code>, <code>session()-&gt;flush()</code></dt>&#13;
<dd>&#13;
<p><code>forget()</code> removes a previously set session value. <code>flush()</code> removes every session value, even those set by the framework:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'awesome'</code><code class="p">);</code>&#13;
<code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'b'</code><code class="p">,</code> <code class="s1">'bodacious'</code><code class="p">);</code>&#13;
&#13;
<code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">forget</code><code class="p">(</code><code class="s1">'a'</code><code class="p">);</code>&#13;
<code class="c1">// a is no longer set; b is still set</code>&#13;
<code class="nx">session</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">flush</code><code class="p">();</code>&#13;
<code class="c1">// Session is now empty</code></pre>&#13;
</dd>&#13;
<dt><code>session()-&gt;pull(<em>$key</em>, <em>$fallbackValue</em>)</code></dt>&#13;
<dd>&#13;
<p><code>pull()</code> is the same as <code>get()</code>, except that it deletes the value from the session after pulling it.</p>&#13;
</dd>&#13;
<dt><code>session()-&gt;regenerate()</code></dt>&#13;
<dd>&#13;
<p>It’s not common, but if you need to regenerate your session ID, <code>regenerate()</code> is there for you.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Flash Session Storage" data-type="sect2"><div class="sect2" id="id284">&#13;
<h2>Flash Session Storage</h2>&#13;
&#13;
<p>There<a data-primary="flash session storage" data-type="indexterm" id="id1737"/> are three more methods we haven’t covered yet, and they all have to do with something called <em>flash session storage</em>.</p>&#13;
&#13;
<p>One very common pattern for session storage is to set a value that you only want available for the next page load. For example, you might want to store a message like “Updated post successfully.” You could manually get that message and then wipe it on the next page load, but if you use this pattern a lot it can get wasteful. Enter flash session storage: keys that are expected to only last for a single page request.</p>&#13;
&#13;
<p>Laravel handles the work for you, and all you need to do is use <code>flash()</code> instead of <code>put()</code>. These are the useful methods here:</p>&#13;
<dl>&#13;
<dt><code>session()-&gt;flash(<em>$key</em>, <em>$value</em>)</code></dt>&#13;
<dd>&#13;
<p><code>flash()</code> sets the session key to the provided value for just the next page request.</p>&#13;
</dd>&#13;
<dt><code>session()-&gt;reflash()</code>, <code>session()-&gt;keep(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p>If you need the previous page’s flash session data to stick around for one more request, you can use <code>reflash()</code> to restore all of it for the next request or <code>keep(<em>$key</em>)</code> to just restore a single flash value for the next request. <code>keep()</code> can also accept an array of keys to reflash.<a data-primary="" data-startref="SRsess14" data-type="indexterm" id="id1738"/><a data-primary="" data-startref="sessions14" data-type="indexterm" id="id1739"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cache" data-type="sect1"><div class="sect1" id="id502">&#13;
<h1>Cache</h1>&#13;
&#13;
<p>Caches<a data-primary="storage and retrieval" data-secondary="caches" data-type="indexterm" id="SRcach14"/><a data-primary="caching" data-secondary="common uses for" data-type="indexterm" id="id1740"/> are structured very similarly to sessions. You provide a key and Laravel stores it for you. The biggest difference is that the data in a cache is cached per application, and the data in a session is cached per user. That means caches are more commonly used for storing results from database queries, API calls, or other slow queries that can stand to get a little bit “stale.”</p>&#13;
&#13;
<p>The cache configuration settings are available at <em>config/cache.php</em>. Just like with a session, you can set the specific configuration details for any of your drivers and also choose which will be your default. Laravel uses the <code>file</code> cache driver by default, but you can also use Memcached or Redis, APC, DynamoDB, or a database, or write your own cache driver. Take a look at <a href="https://laravel.com/docs/cache">the cache docs</a> to learn about specific dependencies and settings you need to prepare for whichever driver you choose to use.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accessing the Cache" data-type="sect2"><div class="sect2" id="id503">&#13;
<h2>Accessing the Cache</h2>&#13;
&#13;
<p>Just<a data-primary="caching" data-secondary="accessing the cache" data-type="indexterm" id="id1741"/> like with sessions, there are several ways to access a cache. You can use <span class="keep-together">the facade:</span></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$users</code> <code class="o">=</code> <code class="nx">Cache</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'users'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Or you can get an instance from the container, as in <a data-type="xref" href="#get_instance_from_container">Example 14-9</a>.</p>&#13;
<div data-type="example" id="get_instance_from_container">&#13;
<h5><span class="label">Example 14-9. </span>Injecting an instance of the cache</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Illuminate\Contracts\Cache\Repository</code> <code class="nv">$cache</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$cache</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'users'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You can also use the global <code>cache()</code> helper, as in <a data-type="xref" href="#global_cache_helper">Example 14-10</a>.</p>&#13;
<div data-type="example" id="global_cache_helper">&#13;
<h5><span class="label">Example 14-10. </span>Using the global <code>cache()</code> helper</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Get from cache</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">cache</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'default value'</code><code class="p">);</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'default value'</code><code class="p">);</code>&#13;
<code class="c1">// Put for $seconds duration</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">cache</code><code class="p">([</code><code class="s1">'key'</code> <code class="o">=&gt;</code> <code class="s1">'value'</code><code class="p">],</code> <code class="nv">$seconds</code><code class="p">);</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">,</code> <code class="nv">$seconds</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>If you’re new to Laravel and not sure which to use, I’d recommend using the global helper.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Methods Available on Cache Instances" data-type="sect2"><div class="sect2" id="id285">&#13;
<h2>Methods Available on Cache Instances</h2>&#13;
&#13;
<p>Let’s<a data-primary="caching" data-secondary="methods available on cache instances" data-type="indexterm" id="id1742"/> take a look at the methods you can call on a <code>Cache</code> instance:</p>&#13;
<dl>&#13;
<dt><code>cache()-&gt;get(<em>$key</em>, <em>$fallbackValue</em>)</code>, <br/><code>cache()-&gt;pull(<em>$key</em>, <em>$fallbackValue</em>)</code></dt>&#13;
<dd>&#13;
<p><code>get()</code> makes it easy to retrieve the value for any given key. <code>pull()</code> is the same as <code>get()</code> except it removes the cached value after retrieving it.</p>&#13;
</dd>&#13;
<dt><code>cache()-&gt;put(<em>$key</em>, <em>$value</em>, <em>$secondsOrExpiration</em>)</code></dt>&#13;
<dd>&#13;
<p><code>put()</code> sets the value of the specified key for a given number of seconds.&#13;
If you’d prefer setting an expiration date/time instead of a number of seconds, you can pass a Carbon object as the third parameter:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">put</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addDay</code><code class="p">());</code></pre>&#13;
</dd>&#13;
<dt><code>cache()-&gt;add(<em>$key</em>, <em>$value</em>)</code></dt>&#13;
<dd>&#13;
<p><code>add()</code> is similar to <code>put()</code>, except if the value already exists, <code>add()</code> won’t set it. Also, the method returns a Boolean indicating whether or not the value was actually added:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$someDate</code> <code class="o">=</code> <code class="nx">now</code><code class="p">();</code>&#13;
<code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">add</code><code class="p">(</code><code class="s1">'someDate'</code><code class="p">,</code> <code class="nv">$someDate</code><code class="p">);</code> <code class="c1">// returns true</code>&#13;
<code class="nv">$someOtherDate</code> <code class="o">=</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addHour</code><code class="p">();</code>&#13;
<code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">add</code><code class="p">(</code><code class="s1">'someDate'</code><code class="p">,</code> <code class="nv">$someOtherDate</code><code class="p">);</code> <code class="c1">// returns false</code></pre>&#13;
</dd>&#13;
<dt><code>cache()-&gt;forever(<em>$key</em>, <em>$value</em>)</code></dt>&#13;
<dd>&#13;
<p><code>forever()</code> saves a value to the cache for a specific key; it’s the same as <code>put()</code>, except the values will never expire (until they’re removed with <code>forget()</code>).</p>&#13;
</dd>&#13;
<dt><code>cache()-&gt;has(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p><code>has()</code> returns a Boolean indicating whether or not there’s a value at the provided key.</p>&#13;
</dd>&#13;
<dt><code>cache()-&gt;remember(<em>$key</em>, <em>$seconds</em>,</code> <code><em>$closure</em>)</code>, <br/><code>cache()-&gt;rememberForever(<em>$key</em>,</code> <code><em>$closure</em>)</code></dt>&#13;
<dd>&#13;
<p><code>remember()</code> provides a single method to handle a very common flow: look up whether a value exists in the cache for a certain key, and if it doesn’t, get that value somehow, save it to the cache, and return it.</p>&#13;
&#13;
<p><code>remember()</code> lets you provide a key to look up, the number of seconds it should be saved for, and a closure to define how to look it up, in case the key has no value set. <code>rememberForever()</code> is the same, except it doesn’t need you to set the number of seconds it should be saved for. Take a look at the following example to see a common user scenario for <code>remember()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Either returns the value cached at "users" or gets "User::all()",</code>&#13;
<code class="c1">// caches it at "users", and returns it</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">cache</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">remember</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="mi">7200</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">User</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
</dd>&#13;
<dt><code>cache()-&gt;increment(<em>$key</em>, <em>$amount</em>)</code>, <code>cache()-&gt;decrement(<em>$key</em>, <em>$amount</em>)</code></dt>&#13;
<dd>&#13;
<p><code>increment()</code> and <code>decrement()</code> allow you to increment and decrement integer values in the cache. If there is no value at the given key, it’ll be treated as if it were <code>0</code>, and if you pass a second parameter to increment or decrement, it’ll increment or decrement by that amount instead of by 1.</p>&#13;
</dd>&#13;
<dt><code>cache()-&gt;forget(<em>$key</em>)</code>, <code>cache()-&gt;flush()</code></dt>&#13;
<dd>&#13;
<p><code>forget()</code> works just like <code>Session</code>’s <code>forget()</code> method: pass it a key and it’ll wipe that key’s value. <code>flush()</code> wipes the entire cache.<a data-primary="" data-startref="SRcach14" data-type="indexterm" id="id1743"/></p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cookies" data-type="sect1"><div class="sect1" id="id504">&#13;
<h1>Cookies</h1>&#13;
&#13;
<p>You<a data-primary="storage and retrieval" data-secondary="cookies" data-type="indexterm" id="SScook14"/> might expect cookies to work the same as sessions and the cache. A facade and a global helper are available for these too, and our mental models of all three are similar: you can get or set their values in the same way.</p>&#13;
&#13;
<p>But because cookies are inherently attached to the requests and responses, you’ll <span class="keep-together">need to</span> interact with cookies differently. Let’s look really briefly at what makes cookies different.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cookies in Laravel" data-type="sect2"><div class="sect2" id="id505">&#13;
<h2>Cookies in Laravel</h2>&#13;
&#13;
<p>Cookies<a data-primary="cookies" data-secondary="in Laravel" data-secondary-sortas="Laravel" data-type="indexterm" id="id1744"/> can exist in three places in Laravel. They can come in via the request, which means the user had the cookie when they visited the page. You can read that with the <code>Cookie</code> facade, or you can read it off of the request object.</p>&#13;
&#13;
<p>They can also be sent out with a response, which means the response will instruct the user’s browser to save the cookie for future visits. You can do this by adding the cookie to your response object before returning it.</p>&#13;
&#13;
<p>And last, a cookie can be <em>queued</em>. If you use the <code>Cookie</code> facade to set a cookie, you have put it into a “CookieJar” queue, and it will be removed and added to the response object by the <code>AddQueuedCookiesToResponse</code> middleware.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accessing the Cookie Tools" data-type="sect2"><div class="sect2" id="id703">&#13;
<h2>Accessing the Cookie Tools</h2>&#13;
&#13;
<p>You can get and set cookies in three places: the <code>Cookie</code> facade, the <code>cookie()</code> global helper, and the request and response objects.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The cookie facade" data-type="sect3"><div class="sect3" id="id506">&#13;
<h3>The cookie facade</h3>&#13;
&#13;
<p>The<a data-primary="cookies" data-secondary="tools for" data-tertiary="Cookie facade" data-type="indexterm" id="id1745"/> <code>Cookie</code> facade is the most full-featured option, allowing you to not only read and make cookies, but also to queue them to be added to the response. It provides the following methods:</p>&#13;
<dl>&#13;
<dt><code>Cookie::get(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p>To pull the value of a cookie that came in with the request, you can just run <code>Cookie::get('<em>cookie-name</em>')</code>. This is the simplest option.</p>&#13;
</dd>&#13;
<dt><code>Cookie::has(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p>You can check whether a cookie came in with the request using <code>Cookie::has('<em>cookie-name</em>')</code>, which returns a Boolean.</p>&#13;
</dd>&#13;
<dt><code>Cookie::make(<em>...params</em>)</code></dt>&#13;
<dd>&#13;
<p>If you want to <em>make</em> a cookie without queueing it anywhere, you can use <code>Cookie::make()</code>. The most likely use for this would be to make a cookie and then manually attach it to the response object, which we’ll cover in a bit.</p>&#13;
&#13;
<p>Here are the parameters for <code>make()</code>, in order:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>$name</code> is the name of the cookie.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$value</code> is the content of the cookie.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$minutes</code> specifies how many minutes the cookie should live.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$path</code> is the path under which your cookie should be valid.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$domain</code> lists the domains for which your cookie should work.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$secure</code> indicates whether the cookie should only be transmitted over a secure (HTTPS) connection.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$httpOnly</code> indicates whether the cookie will be made accessible only through the HTTP protocol.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$raw</code> indicates whether the cookie should be sent without URL encoding.</p>&#13;
</li>&#13;
<li>&#13;
<p><code>$sameSite</code> indicates whether the cookie should be available for cross-site requests; options are <code>lax</code>, <code>strict</code>, or <code>null</code>.</p>&#13;
</li>&#13;
</ul>&#13;
</dd>&#13;
<dt><code>Cookie::make()</code></dt>&#13;
<dd>&#13;
<p>Returns an instance of <code>Symfony\Component\HttpFoundation\Cookie</code>.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Default Settings for Cookies</h1>&#13;
<p>The<a data-primary="cookies" data-secondary="default setting for" data-type="indexterm" id="id1746"/> <code>CookieJar</code> used by the <code>Cookie</code> facade instance reads its defaults from the session config. So, if you change any of the configuration values for the session cookie in <em>config/session.php</em>, those same defaults will be applied to all of your cookies that you create using the <code>Cookie</code> facade.</p>&#13;
</div>&#13;
</dd>&#13;
<dt><code>Cookie::queue(<em>Cookie || params</em>)</code></dt>&#13;
<dd>&#13;
<p>If you use <code>Cookie::make()</code>, you’ll still need to attach the cookie to your response, which we’ll cover shortly. <code>Cookie::queue()</code> has the same syntax as <code>Cookie::make()</code>, but it enqueues the created cookie to be automatically attached to the response by middleware.</p>&#13;
&#13;
<p>If you’d like, you can also just pass a cookie you’ve created yourself into <code>Cookie::queue()</code>.</p>&#13;
&#13;
<p>Here’s the simplest possible way to add a cookie to the response in Laravel:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Cookie</code><code class="o">::</code><code class="na">queue</code><code class="p">(</code><code class="s1">'dismissed-popup'</code><code class="p">,</code> <code class="k">true</code><code class="p">,</code> <code class="mi">15</code><code class="p">);</code></pre>&#13;
<div data-type="warning" epub:type="warning"><h1>When Your Queued Cookies Won’t Get Set</h1>&#13;
<p>Cookies<a data-primary="cookies" data-secondary="queued cookies" data-type="indexterm" id="id1747"/><a data-primary="queues and queueing" data-secondary="queued cookies" data-type="indexterm" id="id1748"/> can only be returned as part of a response. So, if you enqueue cookies with the <code>Cookie</code> facade and then your response isn’t returned correctly—for example, if you use PHP’s <code>exit()</code> or something halts the execution of your script—your cookies won’t be set.</p>&#13;
</div>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The cookie() global helper" data-type="sect3"><div class="sect3" id="id507">&#13;
<h3>The cookie() global helper</h3>&#13;
&#13;
<p>The<a data-primary="cookies" data-secondary="tools for" data-tertiary="cookie() global helper" data-type="indexterm" id="id1749"/><a data-primary="helpers" data-secondary="cookie() global helper" data-type="indexterm" id="id1750"/> <code>cookie()</code> global helper will return a <code>CookieJar</code> instance if you call it with no parameters. However, two of the most convenient methods on the <code>Cookie</code> facade—<code>has()</code> and <code>get()</code>—exist <em>only</em> on the facade, not on the <code>CookieJar</code>. So, in this context, I think the global helper is actually less useful than the other options.</p>&#13;
&#13;
<p>The one task for which the <code>cookie()</code> global helper is useful is creating a cookie. If you pass parameters to <code>cookie()</code>, they’ll be passed directly to the equivalent of <code>Cookie::make()</code>, so this is the fastest way to create a cookie:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$cookie</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">(</code><code class="s1">'dismissed-popup'</code><code class="p">,</code> <code class="k">true</code><code class="p">,</code> <code class="mi">15</code><code class="p">);</code></pre>&#13;
<div data-type="tip"><h1>Injecting an Instance</h1>&#13;
<p>You can also inject an instance of <code>Illuminate\Cookie\CookieJar</code> anywhere in the app, but you’ll have the same limitations discussed here.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cookies on Request and Response objects" data-type="sect3"><div class="sect3" id="id585">&#13;
<h3>Cookies on Request and Response objects</h3>&#13;
&#13;
<p>Since<a data-primary="cookies" data-secondary="tools for" data-tertiary="cookies on Request and Response objects" data-type="indexterm" id="id1751"/> cookies come in as a part of the request and are set as a part of the response, those Illuminate objects are the places they actually live. The <code>Cookie</code> facade’s <code>get()</code>, <code>has()</code>, and <code>queue()</code> methods are just proxies to interact with the <code>Request</code> and <code>Response</code> objects.</p>&#13;
&#13;
<p>So, the simplest way to interact with cookies is to pull cookies from the request and set them on the response.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Reading cookies from Request objects" data-type="sect4"><div class="sect4" id="id508">&#13;
<h4>Reading cookies from Request objects</h4>&#13;
&#13;
<p>Once<a data-primary="Request objects" data-secondary="reading cookies from" data-type="indexterm" id="id1752"/> you have a copy of your <code>Request</code> object—​if you don’t know how to get one, just try <code>app('request')</code>—you can use the <code>Request</code> object’s <code>cookie()</code> method to read its cookies, as shown in <a data-type="xref" href="#reading_cookie_from_request_object">Example 14-11</a>.</p>&#13;
<div data-type="example" id="reading_cookie_from_request_object">&#13;
<h5><span class="label">Example 14-11. </span>Reading a cookie from a <code>Request</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Illuminate\Http\Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$userDismissedPopup</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="s1">'dismissed-popup'</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>As you can see in this example, the <code>cookie()</code> method has two parameters: the cookie’s name and, optionally, the fallback value.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting cookies on Response objects" data-type="sect4"><div class="sect4" id="id286">&#13;
<h4>Setting cookies on Response objects</h4>&#13;
&#13;
<p>When<a data-primary="Response objects" data-secondary="setting cookies on" data-type="indexterm" id="id1753"/> you have your <code>Response</code> object ready, you can use the <code>cookie()</code> method on it to add a cookie to the response, like in <a data-type="xref" href="#setting_cookie_on_response_object">Example 14-12</a>.</p>&#13;
<div data-type="example" id="setting_cookie_on_response_object">&#13;
<h5><span class="label">Example 14-12. </span>Setting a cookie on a <code>Response</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$cookie</code> <code class="o">=</code> <code class="nx">cookie</code><code class="p">(</code><code class="s1">'saw-dashboard'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">Response</code><code class="o">::</code><code class="na">view</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="nv">$cookie</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If you’re new to Laravel and not sure which option to use, I’d recommend setting cookies on the <code>Request</code> and <code>Response</code> objects. It’s a bit more work, but will lead to fewer surprises if future developers don’t understand the <code>CookieJar</code> queue.<a data-primary="" data-startref="SScook14" data-type="indexterm" id="id1754"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Logging" data-type="sect1"><div class="sect1" id="id509">&#13;
<h1>Logging</h1>&#13;
&#13;
<p>We’ve<a data-primary="storage and retrieval" data-secondary="logging" data-type="indexterm" id="SRlog14"/><a data-primary="logging" data-secondary="purpose of" data-type="indexterm" id="id1755"/> seen a few really brief examples of logging so far in this book when we were talking about other concepts like the container and facades, so let’s briefly look at what options you have with logging beyond just <code>Log::info('Message')</code>.</p>&#13;
&#13;
<p>The purpose of logs is to increase <em>discoverability</em>, or your ability to understand what’s going on at any given moment in your application.</p>&#13;
&#13;
<p>Logs are short messages, sometimes with some data embedded in a human-readable form, that your code generates for the sake of understanding what’s happening during the execution of an app. Each log must be captured at a specific <em>level</em>, which can vary from <code>emergency</code> (something very bad happened) to <code>debug</code> (something of almost no significance happened).</p>&#13;
&#13;
<p>Without any modifications, your app will write any log statements to a file located at <em>storage/logs/laravel.log</em>, and each log statement will look a little bit like this:</p>&#13;
&#13;
<pre data-type="programlisting">[2018-09-22 21:34:38] local.ERROR: Something went wrong.</pre>&#13;
&#13;
<p>You can see we have the date, time, environment, error level, and message all on one line. However, Laravel also (by default) logs any uncaught exceptions, and in that case you’ll see the entire stack trace inline.</p>&#13;
&#13;
<p>We’ll cover how to log, why to log, and how to log elsewhere (for example, in Slack) in this following section.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="When and Why to Use Logs" data-type="sect2"><div class="sect2" id="id510">&#13;
<h2>When and Why to Use Logs</h2>&#13;
&#13;
<p>The<a data-primary="logging" data-secondary="when and why to use" data-type="indexterm" id="id1756"/> most common use case for logs is to act as a semidisposable record of things that have happened that you <em>may</em> care about later, but to which you definitively don’t need programmatic access. The logs are more about learning what’s going on in the app and less about creating structured data your app can consume.</p>&#13;
&#13;
<p>For example, if you want to have code that consumes a record of every user login and does something interesting with it, that’s a use case for a <em>logins</em> database table. However, if you have a casual interest in those logins but you’re not entirely certain whether you care or whether you need that information programmatically, you may just throw a <code>debug</code>- or <code>info</code>-level log on it and forget about it.</p>&#13;
&#13;
<p>Logs are also common when you need to see the value of something at the moment it goes wrong, or at a certain time of day, or something else that means you want the data at a time when you’re not around. Throw a log statement in the code, get the data you need out of the logs, and either keep it in the code for later usage or just delete it again.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Writing to the Logs" data-type="sect2"><div class="sect2" id="id511">&#13;
<h2>Writing to the Logs</h2>&#13;
&#13;
<p>The<a data-primary="logging" data-secondary="writing to logs" data-type="indexterm" id="id1757"/> simplest way to write a log entry in Laravel is to use the <code>Log</code> facade and use the method on that facade that matches the severity level you’d like to record. The levels are the same as those defined in <a href="https://oreil.ly/6ODcf">RFC 5424</a>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Log</code><code class="o">::</code><code class="na">emergency</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">alert</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">critical</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">error</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">warning</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">notice</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">info</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code>&#13;
<code class="nx">Log</code><code class="o">::</code><code class="na">debug</code><code class="p">(</code><code class="nv">$message</code><code class="p">);</code></pre>&#13;
&#13;
<p>You can also, optionally, pass a second parameter that’s an array of connected data:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Log</code><code class="o">::</code><code class="na">error</code><code class="p">(</code><code class="s1">'Failed to upload user image.'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'user'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="p">]);</code></pre>&#13;
&#13;
<p>This additional information may be captured differently by different log destinations, but here’s how this looks in the default local log (although it will be just a single line in the log):</p>&#13;
&#13;
<pre data-type="programlisting">[2018-09-27 20:53:31] local.ERROR: Failed to upload user image. {&#13;
    "user":"[object] (App\\User: {&#13;
        \"id\":1,&#13;
        \"name\":\"Matt\",&#13;
        \"email\":\"matt@tighten.co\",&#13;
        \"email_verified_at\":null,&#13;
        \"api_token\":\"long-token-here\",&#13;
        \"created_at\":\"2018-09-22 21:39:55\",&#13;
        \"updated_at\":\"2018-09-22 21:40:08\"&#13;
    })"&#13;
}</pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Log Channels" data-type="sect2"><div class="sect2" id="id512">&#13;
<h2>Log Channels</h2>&#13;
&#13;
<p>Like<a data-primary="logging" data-secondary="log channels" data-type="indexterm" id="Lchannel14"/> many other aspects of Laravel (file storage, database, mail, etc.), you can configure your logs to use one or more predefined log types, which you define in the config file. Using each type involves passing various configuration details to a specific log driver.</p>&#13;
&#13;
<p>These log types are called <em>channels</em>, and out of the box you’ll have options for <code>stack</code>, <code>single</code>, <code>daily</code>, <code>slack</code>, <code>stderr</code>, <code>syslog</code>, and <code>errorlog</code>. Each channel is connected to a single driver; the available drivers are <code>stack</code>, <code>single</code>, <code>daily</code>, <code>slack</code>, <code>syslog</code>, <code>errorlog</code>, <code>monolog</code>, and <code>custom</code>.</p>&#13;
&#13;
<p>We’ll cover the most common channels here: <code>single</code>, <code>daily</code>, <code>slack</code>, and <code>stack</code>. To learn more about the drivers and the full list of channels available, take a look at the <a href="https://oreil.ly/vrJvj">logging docs</a>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The single channel" data-type="sect3"><div class="sect3" id="id704">&#13;
<h3>The single channel</h3>&#13;
&#13;
<p>The <code>single</code> channel writes every log entry to a single file, which you’ll define in the <code>path</code> key. You can see its default configuration in <a data-type="xref" href="#EX14g">Example 14-13</a>:</p>&#13;
<div data-type="example" id="EX14g">&#13;
<h5><span class="label">Example 14-13. </span>Default configuration for the <code>single</code> channel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'single'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'single'</code><code class="p">,</code>&#13;
    <code class="s1">'path'</code> <code class="o">=&gt;</code> <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'logs/laravel.log'</code><code class="p">),</code>&#13;
    <code class="s1">'level'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">,</code> <code class="s1">'debug'</code><code class="p">),</code>&#13;
<code class="p">],</code></pre></div>&#13;
&#13;
<p>This means it’ll only log events at the <code>debug</code> level or higher, and it will write them all to a single file, <em>storage/logs/laravel.log</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The daily channel" data-type="sect3"><div class="sect3" id="id705">&#13;
<h3>The daily channel</h3>&#13;
&#13;
<p>The <code>daily</code> channel splits out a new file for each day. You can see its default config in <a data-type="xref" href="#EX14a">Example 14-14</a>.</p>&#13;
<div data-type="example" id="EX14a">&#13;
<h5><span class="label">Example 14-14. </span>Default configuration for the <code>daily</code> channel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'daily'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'daily'</code><code class="p">,</code>&#13;
    <code class="s1">'path'</code> <code class="o">=&gt;</code> <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'logs/laravel.log'</code><code class="p">),</code>&#13;
    <code class="s1">'level'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">,</code> <code class="s1">'debug'</code><code class="p">),</code>&#13;
    <code class="s1">'days'</code> <code class="o">=&gt;</code> <code class="mi">14</code><code class="p">,</code>&#13;
<code class="p">],</code></pre></div>&#13;
&#13;
<p>It’s similar to <code>single</code>, but we now can set how many days of logs to keep before they’re cleaned up, and the date will be appended to the filename we specify. For example, the preceding config will generate a file named <em>storage/logs/laravel-&lt;yyyy-mm-dd&gt;.log</em>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Slack channel" data-type="sect3"><div class="sect3" id="id706">&#13;
<h3>The Slack channel</h3>&#13;
&#13;
<p>The <code>slack</code> channel makes it easy to send your logs (or, more likely, only certain logs) over to Slack.</p>&#13;
&#13;
<p>It also illustrates that you’re not limited to just the handlers that come out of the box with Laravel. We’ll cover this in a second, but this isn’t a custom Slack implementation; it’s just Laravel building a log driver that connects to the Monolog Slack handler, and if you can use any Monolog handler, you have a <em>lot</em> of options available to you.</p>&#13;
&#13;
<p>The default configuration for this channel is shown in <a data-type="xref" href="#EX14b">Example 14-15</a>.</p>&#13;
<div data-type="example" id="EX14b">&#13;
<h5><span class="label">Example 14-15. </span>Default configuration for the <code>slack</code> channel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'slack'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'slack'</code><code class="p">,</code>&#13;
    <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'LOG_SLACK_WEBHOOK_URL'</code><code class="p">),</code>&#13;
    <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="s1">'Laravel Log'</code><code class="p">,</code>&#13;
    <code class="s1">'emoji'</code> <code class="o">=&gt;</code> <code class="s1">':boom:'</code><code class="p">,</code>&#13;
    <code class="s1">'level'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">,</code> <code class="s1">'critical'</code><code class="p">),</code>&#13;
<code class="p">],</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The stack channel" data-type="sect3"><div class="sect3" id="id287">&#13;
<h3>The stack channel</h3>&#13;
&#13;
<p>The <code>stack</code> channel is the channel that’s enabled by default on your application. Its default configuration is shown in <a data-type="xref" href="#EX14c">Example 14-16</a>.</p>&#13;
<div data-type="example" id="EX14c">&#13;
<h5><span class="label">Example 14-16. </span>Default configuration for the <code>stack</code> channel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'stack'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'stack'</code><code class="p">,</code>&#13;
    <code class="s1">'channels'</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'single'</code><code class="p">],</code>&#13;
    <code class="s1">'ignore_exceptions'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
<code class="p">],</code></pre></div>&#13;
&#13;
<p>The <code>stack</code> channel allows you to send all your logs to more than one channel (listed in the <code>channels</code> array). So, while this is the channel that’s configured by default on your Laravel apps, because its <code>channels</code> array is set to <code>single</code> by default, in reality your app is just using the <code>single</code> log channel.</p>&#13;
&#13;
<p>But what if you wanted everything of the level <code>info</code> and above to go to the daily files, but you wanted <code>critical</code> and higher log messages to go to Slack? It’s easy with the <code>stack</code> driver, as <a data-type="xref" href="#EX14d">Example 14-17</a> demonstrates.<a data-primary="" data-startref="Lchannel14" data-type="indexterm" id="id1758"/></p>&#13;
<div data-type="example" id="EX14d">&#13;
<h5><span class="label">Example 14-17. </span>Customizing the <code>stack</code> driver</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'channels'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
    <code class="s1">'stack'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'stack'</code><code class="p">,</code>&#13;
        <code class="s1">'channels'</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'daily'</code><code class="p">,</code> <code class="s1">'slack'</code><code class="p">],</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'daily'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'daily'</code><code class="p">,</code>&#13;
        <code class="s1">'path'</code> <code class="o">=&gt;</code> <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'logs/laravel.log'</code><code class="p">),</code>&#13;
        <code class="s1">'level'</code> <code class="o">=&gt;</code> <code class="s1">'info'</code><code class="p">,</code>&#13;
        <code class="s1">'days'</code> <code class="o">=&gt;</code> <code class="mi">14</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'slack'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'slack'</code><code class="p">,</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'LOG_SLACK_WEBHOOK_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="s1">'Laravel Log'</code><code class="p">,</code>&#13;
        <code class="s1">'emoji'</code> <code class="o">=&gt;</code> <code class="s1">':boom:'</code><code class="p">,</code>&#13;
        <code class="s1">'level'</code> <code class="o">=&gt;</code> <code class="s1">'critical'</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
<code class="p">]</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Writing to specific log channels" data-type="sect3"><div class="sect3" id="id288">&#13;
<h3>Writing to specific log channels</h3>&#13;
&#13;
<p>There<a data-primary="logging" data-secondary="writing to specific channels" data-type="indexterm" id="id1759"/> may also be times when you want to control exactly which log messages go where. You can do that by specifying the channel when you call the <code>Log</code> facade:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Log</code><code class="o">::</code><code class="na">channel</code><code class="p">(</code><code class="s1">'slack'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">info</code><code class="p">(</code><code class="s2">"This message will go to Slack."</code><code class="p">);</code></pre>&#13;
<div data-type="tip"><h1>Advanced Log Configuration</h1>&#13;
<p>If<a data-primary="logging" data-secondary="advanced log configuration" data-type="indexterm" id="id1760"/> you’d like to customize how each log is sent to each channel, or implement custom Monolog handlers, check out the <a href="https://oreil.ly/vrJvj">logging docs</a> to learn more.<a data-primary="" data-startref="SRlog14" data-type="indexterm" id="id1761"/></p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Full-Text Search with Laravel Scout" data-type="sect1"><div class="sect1" id="introducing_laravel_scout">&#13;
<h1>Full-Text Search with Laravel Scout</h1>&#13;
&#13;
<p>Laravel Scout<a data-primary="storage and retrieval" data-secondary="full-text search" data-type="indexterm" id="SARrull14"/><a data-primary="Scout" data-type="indexterm" id="scout14"/><a data-primary="search, full-text" data-type="indexterm" id="searachFT14"/> is a separate package that you can bring into your Laravel apps to add full-text search to your Eloquent models. Scout makes it easy to index and search the contents of your Eloquent models; it ships with drivers for Algolia, Meilisearch, and databases (MySQL/PostgreSQL), but there are also community packages for other providers. I’ll assume you’re using Algolia.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Scout" data-type="sect2"><div class="sect2" id="id290">&#13;
<h2>Installing Scout</h2>&#13;
&#13;
<p>First, pull in the package in any Laravel app:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>laravel/scout<code class="w"/></pre>&#13;
&#13;
<p>Next<a data-primary="--provider flag" data-type="indexterm" id="id1762"/> you’ll want to set up your Scout configuration. Run this command:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">vendor</code><code class="o">:</code><code class="nx">publish</code> <code class="o">--</code><code class="nx">provider</code><code class="o">=</code><code class="s2">"Laravel\Scout\ScoutServiceProvider"</code></pre>&#13;
&#13;
<p>and paste your Algolia credentials in <em>config/scout.php</em>.</p>&#13;
&#13;
<p>Finally, install the Algolia SDK:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>algolia/algoliasearch-client-php<code class="w"/></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Marking Your Model for Indexing" data-type="sect2"><div class="sect2" id="id513">&#13;
<h2>Marking Your Model for Indexing</h2>&#13;
&#13;
<p>In<a data-primary="indexes" data-secondary="in full-text search" data-secondary-sortas="full-text search" data-type="indexterm" id="INfull14"/> your model (we’ll use <code>Review</code>, for a book review, for this example), import the <span class="keep-together"><code>Laravel\Scout\Searchable</code></span> trait.</p>&#13;
&#13;
<p>You can define which properties are searchable using the <code>toSearchableArray()</code> method (it defaults to mirroring <code>toArray()</code>), and define the name of the model’s index using the <code>searchableAs()</code> method (it defaults to the table name).</p>&#13;
&#13;
<p>Scout subscribes to the create/delete/update events on your marked models. When you create, update, or delete any rows, Scout will sync those changes up to Algolia. It’ll either make those changes synchronously with your updates or, if you configure Scout to use a queue, queue the updates.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Searching Your Index" data-type="sect2"><div class="sect2" id="id707">&#13;
<h2>Searching Your Index</h2>&#13;
&#13;
<p>Scout’s syntax is simple. For example, to find any <code>Review</code> with the word <code>Llew</code> in it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Review</code><code class="o">::</code><code class="na">search</code><code class="p">(</code><code class="s1">'Llew'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also modify your queries as you would with regular Eloquent calls:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Get all records from the Review that match the term "Llew",</code>&#13;
<code class="c1">// limited to 20 per page and reading the page query parameter,</code>&#13;
<code class="c1">// just like Eloquent pagination</code>&#13;
<code class="nx">Review</code><code class="o">::</code><code class="na">search</code><code class="p">(</code><code class="s1">'Llew'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">paginate</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Get all records from the Review that match the term "Llew"</code>&#13;
<code class="c1">// and have the account_id field set to 2</code>&#13;
<code class="nx">Review</code><code class="o">::</code><code class="na">search</code><code class="p">(</code><code class="s1">'Llew'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'account_id'</code><code class="p">,</code> <code class="mi">2</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>What comes back from these searches? A collection of Eloquent models, rehydrated from your database. The IDs are stored in Algolia, which returns a list of matched IDs; Scout then pulls the database records for those and returns them as Eloquent objects.</p>&#13;
&#13;
<p>You don’t have full access to the complexity of SQL <code>WHERE</code> commands, but it provides a basic framework for comparison checks like you can see in the code samples here.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Queues and Scout" data-type="sect2"><div class="sect2" id="id708">&#13;
<h2>Queues and Scout</h2>&#13;
&#13;
<p>At this point your app will be making HTTP requests to Algolia on every request that modifies any database records. This can slow down your application quickly, which is why Scout makes it easy to push all of its actions onto a queue.</p>&#13;
&#13;
<p>In <em>config/scout.php</em>, set <code>queue</code> to <code>true</code> so that these updates are indexed asynchronously. Your full-text index is now operating under “eventual consistency”; your database records will receive the updates immediately, and the updates to your search indexes will be queued and updated as fast as your queue worker allows.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Performing Operations Without Indexing" data-type="sect2"><div class="sect2" id="id709">&#13;
<h2>Performing Operations Without Indexing</h2>&#13;
&#13;
<p>If you need to perform a set of operations and avoid triggering the indexing <span class="keep-together">in response,</span> wrap the operations in the <code>withoutSyncingToSearch()</code> method on your model:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Review</code><code class="o">::</code><code class="na">withoutSyncingToSearch</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Make a bunch of reviews, e.g.</code>&#13;
    <code class="nx">Review</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conditionally Indexing Models" data-type="sect2"><div class="sect2" id="id710">&#13;
<h2>Conditionally Indexing Models</h2>&#13;
&#13;
<p>Sometimes you might only want to index records if they meet a certain condition. You may use the <code>shouldBeSearchable()</code> method on the model class to achieve this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">shouldBeSearchable</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">isApproved</code><code class="p">();</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manually Triggering Indexing via Code" data-type="sect2"><div class="sect2" id="id711">&#13;
<h2>Manually Triggering Indexing via Code</h2>&#13;
&#13;
<p>If you want to manually trigger indexing your model, you can do it using code in your app or via the command line.</p>&#13;
&#13;
<p>To manually trigger indexing from your code, add <code>searchable()</code> to the end of any Eloquent query and it will index all of the records that were found in that query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Review</code><code class="o">::</code><code class="na">all</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">searchable</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also choose to scope the query to only those records you want to index. However, Scout is smart enough to insert new records and update old records, so you may choose to just reindex the entire contents of the model’s database table.</p>&#13;
&#13;
<p>You can also run <code>searchable()</code> on relationship methods:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">reviews</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">searchable</code><code class="p">();</code></pre>&#13;
&#13;
<p>If you want to unindex any records with the same sort of query chaining, just use <code>unsearchable()</code> instead:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Review</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'sucky'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">unsearchable</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Manually Triggering Indexing via the CLI" data-type="sect2"><div class="sect2" id="id291">&#13;
<h2>Manually Triggering Indexing via the CLI</h2>&#13;
&#13;
<p>You can also trigger indexing with an Artisan command:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan scout:import "App\Review"</pre>&#13;
&#13;
<p>This will chunk all of the <code>Review</code> models and index them all.<a data-primary="" data-startref="INfull14" data-type="indexterm" id="id1763"/><a data-primary="" data-startref="searachFT14" data-type="indexterm" id="id1764"/><a data-primary="" data-startref="scout14" data-type="indexterm" id="id1765"/><a data-primary="" data-startref="SARrull14" data-type="indexterm" id="id1766"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The HTTP Client" data-type="sect1"><div class="sect1" id="id292">&#13;
<h1>The HTTP Client</h1>&#13;
&#13;
<p>Laravel’s HTTP client<a data-primary="storage and retrieval" data-secondary="HTTP client" data-type="indexterm" id="SRhttp14"/><a data-primary="HTTP client" data-type="indexterm" id="httpclient14"/> isn’t quite a storage mechanism, but it is a retrieval mechanism, and to be honest, I’m not sure where else it fits in this book. Let’s get to it!</p>&#13;
&#13;
<p>The HTTP client makes it possible for your Laravel app to make calls—<code>POST</code>, <code>GET</code>, whatever—​to external web services and APIs with a simple, clean interface.</p>&#13;
&#13;
<p>If you’ve ever worked with Guzzle, you understand what it can do, and you can also likely understand why a simple interface is worth mentioning: Guzzle is incredibly powerful, but also incredibly complex, and it’s become increasingly so over the years.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the HTTP Facade" data-type="sect2"><div class="sect2" id="id712">&#13;
<h2>Using the HTTP Facade</h2>&#13;
&#13;
<p>Most of the time, if you’re working with the HTTP client, you’ll rely on its facade, calling methods like <code>get()</code> and <code>post()</code> directly on the facade. Take a look at <a data-type="xref" href="#EX14f">Example 14-18</a> for an example.</p>&#13;
<div data-type="example" id="EX14f">&#13;
<h5><span class="label">Example 14-18. </span>Basic usage examples of the HTTP facade</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Http</code><code class="p">;</code>&#13;
&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'http://my-api.com/posts'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'http://my-api.com/posts/2/comments'</code><code class="p">,</code> <code class="p">[</code>&#13;
    <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'I loved this post!'</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre></div>&#13;
&#13;
<p>The <code>$response</code> you receive back from a call on the HTTP facade is an instance of <code>Illuminate\Http\Client\Response</code>, which gives you a suite of methods to inspect the response. You can take a look at <a href="https://oreil.ly/N4XXS">the docs</a> for a full list, but you can also see a few common methods in <a data-type="xref" href="#EX14h">Example 14-19</a>.</p>&#13;
<div data-type="example" id="EX14h">&#13;
<h5><span class="label">Example 14-19. </span>Commonly used methods on the HTTP <code>Client Response</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'http://my-api.com/posts'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">body</code><code class="p">();</code> <code class="c1">// string</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">();</code> <code class="c1">// array</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'default'</code><code class="p">)</code> <code class="c1">// string</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">successful</code><code class="p">();</code> <code class="c1">// bool</code></pre></div>&#13;
&#13;
<p>As you can see from <a data-type="xref" href="#EX14f">Example 14-18</a>, you can send data along with <code>POST</code> requests, but there are many other ways you can send data along with your requests.</p>&#13;
&#13;
<p>Once again, here are a few common examples, and you can see more in the docs:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">withHeaders</code><code class="p">([</code>&#13;
    <code class="s1">'X-Custom-Header'</code> <code class="o">=&gt;</code> <code class="s1">'header value here'</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="cm">/* ... */</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">withToken</code><code class="p">(</code><code class="nv">$authToken</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="cm">/* ... */</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">accept</code><code class="p">(</code><code class="s1">'application/json'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'http://my-api.com/users'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Errors and Timeouts and Checking Statuses" data-type="sect2"><div class="sect2" id="id293">&#13;
<h2>Handling Errors and Timeouts and Checking Statuses</h2>&#13;
&#13;
<p>By default, the HTTP client<a data-primary="timeouts" data-type="indexterm" id="id1767"/><a data-primary="error messages" data-secondary="handling with HTTP client" data-type="indexterm" id="id1768"/><a data-primary="statuses, checking" data-type="indexterm" id="id1769"/><a data-primary="messages" data-secondary="error messages" data-type="indexterm" id="id1770"/> will wait 30 seconds before failing out of a request, and not retry it at all. But you can customize many aspects of how the client responds to unexpected situations.</p>&#13;
&#13;
<p>To define the timeout, chain <code>timeout()</code> and pass the number of seconds it should wait:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">timeout</code><code class="p">(</code><code class="mi">120</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="cm">/* ... */</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you expect there to be failures with your attempts, you can define that the client should retry each request a given number of times, using the <code>retry()</code> chained method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nx">Http</code><code class="o">::</code><code class="na">retry</code><code class="p">(</code><code class="nv">$retries</code><code class="p">,</code> <code class="nv">$millisecondsBetweenRetries</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="cm">/* ... */</code><code class="p">);</code></pre>&#13;
&#13;
<p>Some<a data-primary="HTTP status codes" data-type="indexterm" id="id1771"/> of the other methods on the response object allow us to check whether the request worked and what HTTP status we got back; here are a few:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code><code class="o">-&gt;</code><code class="na">successful</code><code class="p">();</code> <code class="c1">// 200 or 300</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">failed</code><code class="p">();</code> <code class="c1">// 400 or 500 errors</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">clientError</code><code class="p">();</code> <code class="c1">// 400 errors</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">serverError</code><code class="p">();</code> <code class="c1">// 500 errors</code>&#13;
&#13;
<code class="c1">// A few of the specific checks we can run for given status codes</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">ok</code><code class="p">();</code> <code class="c1">// 200 OK</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">movedPermanently</code><code class="p">();</code> <code class="c1">// 301 Moved Permanently</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">unauthorized</code><code class="p">();</code> <code class="c1">// 401 Unauthorized</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">serverError</code><code class="p">();</code> <code class="c1">// 500 Internal Server Error</code></pre>&#13;
&#13;
<p>You can also define a callback to be run any time there’s an<a data-primary="" data-startref="SRhttp14" data-type="indexterm" id="id1772"/><a data-primary="" data-startref="httpclient14" data-type="indexterm" id="id1773"/> error:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code><code class="o">-&gt;</code><code class="na">onError</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Response</code> <code class="nv">$response</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// handle error</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id713">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Testing most of these features is as simple as using them in your tests; no need to mock or stub. The default configuration will already work—​for example, take a look at <em>phpunit.xml</em> to see that your session driver and cache driver have been set to values appropriate for tests.</p>&#13;
&#13;
<p>However, there are a few convenience methods and a few gotchas that you should know about before you attempt to test them all.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="File Storage" data-type="sect2"><div class="sect2" id="id586">&#13;
<h2>File Storage</h2>&#13;
&#13;
<p>Testing<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="file storage" data-type="indexterm" id="id1774"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="file storage" data-type="indexterm" id="id1775"/> file uploads can be a bit of a pain, but follow these steps and it will be clear.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Uploading fake files" data-type="sect3"><div class="sect3" id="id714">&#13;
<h3>Uploading fake files</h3>&#13;
&#13;
<p>First, let’s look at how to manually create an <code>Illuminate\Http\UploadedFile</code> object for use in our application testing (<a data-type="xref" href="#create_fake_UploadedFile">Example 14-20</a>).</p>&#13;
<div data-type="example" id="create_fake_UploadedFile">&#13;
<h5><span class="label">Example 14-20. </span>Creating a fake <code>UploadedFile</code> object for testing</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_file_should_be_stored</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">fake</code><code class="p">(</code><code class="s1">'public'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$file</code> <code class="o">=</code> <code class="nx">UploadedFile</code><code class="o">::</code><code class="na">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">image</code><code class="p">(</code><code class="s1">'avatar.jpg'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">postJson</code><code class="p">(</code><code class="s1">'/avatar'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'avatar'</code> <code class="o">=&gt;</code> <code class="nv">$file</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="c1">// Assert the file was stored</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">disk</code><code class="p">(</code><code class="s1">'public'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">assertExists</code><code class="p">(</code><code class="s2">"avatars/</code><code class="si">{</code><code class="nv">$file</code><code class="o">-&gt;</code><code class="na">hashName</code><code class="p">()</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a file does not exist</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">disk</code><code class="p">(</code><code class="s1">'public'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">assertMissing</code><code class="p">(</code><code class="s1">'missing.jpg'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>We’ve created a new instance of <code>UploadedFile</code> that refers to our testing file, and we can now use it to test our routes.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Returning fake files" data-type="sect3"><div class="sect3" id="id715">&#13;
<h3>Returning fake files</h3>&#13;
&#13;
<p>If your route is expecting a real file to exist, sometimes the best way to make it <span class="keep-together">testable</span> is to make that real file actually exist. Let’s say every user must have a profile picture.</p>&#13;
&#13;
<p>First, let’s set up the model factory for the user to use Faker to make a copy of the picture, as in <a data-type="xref" href="#returning_fake_files">Example 14-21</a>.</p>&#13;
<div data-type="example" id="returning_fake_files">&#13;
<h5><span class="label">Example 14-21. </span>Returning fake files with Faker</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code> <code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'picture'</code> <code class="o">=&gt;</code> <code class="nx">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code>&#13;
            <code class="nx">base_path</code><code class="p">(</code><code class="s1">'tests/stubs/images'</code><code class="p">),</code> <code class="c1">// Source directory</code>&#13;
            <code class="nx">storage_path</code><code class="p">(</code><code class="s1">'app'</code><code class="p">),</code> <code class="c1">// Target directory</code>&#13;
            <code class="k">false</code><code class="p">,</code> <code class="c1">// Return just filename, not full path</code>&#13;
        <code class="p">),</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nx">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">(),</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">};</code></pre></div>&#13;
&#13;
<p>Faker’s <code>file()</code> method picks a random file from the source directory, copies it to the target directory, and then returns the filename. So, we’ve just picked a random file from the <em>tests/stubs/images</em> directory, copied it to the <em>storage/app</em> directory, and set its filename as the <code>picture</code> property on our <code>User</code>. At this point we can use a <code>User</code> in tests on routes that expect the <code>User</code> to have a picture, as seen in <a data-type="xref" href="#asserting_URL_echo">Example 14-22</a>.</p>&#13;
<div data-type="example" id="asserting_URL_echo">&#13;
<h5><span class="label">Example 14-22. </span>Asserting that an image’s URL is echoed</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_user_profile_picture_echoes_correctly</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'users.show'</code><code class="p">,</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">));</code>&#13;
&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">picture</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Of course, in many contexts you can just generate a random string there without even copying a file. But if your routes check for the file’s existence or run any operations on the file, this is your best option.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Session" data-type="sect2"><div class="sect2" id="id294">&#13;
<h2>Session</h2>&#13;
&#13;
<p>If<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="sessions" data-type="indexterm" id="id1776"/><a data-primary="sessions" data-type="indexterm" id="id1777"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="sessions" data-type="indexterm" id="id1778"/> you need to assert something has been set in the session, you can use some convenience methods Laravel makes available in every test. All of these methods are available in your tests on the <code>Illuminate\Testing\TestResponse</code> object:</p>&#13;
<dl>&#13;
<dt><code>assertSessionHas(<em>$key</em>, <em>$value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the session has a value for a particular key, and, if the second parameter is passed, that that key is a particular value:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_some_thing</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Do stuff that ends up with a $response object...</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHas</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
</dd>&#13;
<dt><code>assertSessionHasAll(<em>array $bindings</em>)</code></dt>&#13;
<dd>&#13;
<p>If passed an array of key/value pairs, asserts that all of the keys are equal to all of the values. If one or more of the array entries is just a value (with PHP’s default numeric key), it will just be checked for existence in the session:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$check</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="s1">'has'</code><code class="p">,</code>&#13;
    <code class="s1">'hasWithThisValue'</code> <code class="o">=&gt;</code> <code class="s1">'thisValue'</code><code class="p">,</code>&#13;
<code class="p">];</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasAll</code><code class="p">(</code><code class="nv">$check</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>assertSessionMissing(<em>$key</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the session does <em>not</em> have a value for a particular key.</p>&#13;
</dd>&#13;
<dt><code>assertSessionHasErrors(<em>$bindings = []</em>, <em>$format = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the session has an <code>errors</code> value. This is the key Laravel uses to send errors back from validation failures.</p>&#13;
&#13;
<p>If the array contains just keys, it will check that errors are set with those keys:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'test-route'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'failing'</code> <code class="o">=&gt;</code> <code class="s1">'data'</code><code class="p">]);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">([</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'email'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>You can also pass values for those keys, and, optionally, a <em><code>$format</code></em>, to check that the messages for those errors came back the way you expected:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'test-route'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'failing'</code> <code class="o">=&gt;</code> <code class="s1">'data'</code><code class="p">]);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">([</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'&lt;strong&gt;The email field is required.&lt;/strong&gt;'</code><code class="p">,</code>&#13;
<code class="p">],</code> <code class="s1">'&lt;strong&gt;:message&lt;/strong&gt;'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cache" data-type="sect2"><div class="sect2" id="id514">&#13;
<h2>Cache</h2>&#13;
&#13;
<p>There’s<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="caching" data-type="indexterm" id="id1779"/><a data-primary="caching" data-secondary="testing" data-type="indexterm" id="id1780"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="caching" data-type="indexterm" id="id1781"/> nothing special about testing your features that use the cache—​just do it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Cache</code><code class="o">::</code><code class="na">put</code><code class="p">(</code><code class="s1">'key'</code><code class="p">,</code> <code class="s1">'value'</code><code class="p">,</code> <code class="mi">900</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEquals</code><code class="p">(</code><code class="s1">'value'</code><code class="p">,</code> <code class="nx">Cache</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'key'</code><code class="p">));</code></pre>&#13;
&#13;
<p>Laravel uses the <code>array</code> cache driver by default in your testing environment, which just stores your cache values in memory.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Cookies" data-type="sect2"><div class="sect2" id="id515">&#13;
<h2>Cookies</h2>&#13;
&#13;
<p>What<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="cookies" data-type="indexterm" id="id1782"/><a data-primary="cookies" data-secondary="testing" data-type="indexterm" id="id1783"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="cookies" data-type="indexterm" id="id1784"/> if you need to set a cookie before testing a route in your application tests? You can set cookies on a request using the <code>withCookies()</code> method. To learn more, check out <a data-type="xref" href="ch12.html#testing">Chapter 12</a>.</p>&#13;
<div data-type="tip"><h1>Excluding Your Cookie from Encryption During Testing</h1>&#13;
<p>Your<a data-primary="cookies" data-secondary="encryption middleware" data-type="indexterm" id="id1785"/><a data-primary="middleware" data-secondary="cookie encryption middleware" data-type="indexterm" id="id1786"/> cookies won’t work in your tests unless you exclude them from Laravel’s cookie encryption middleware. You can do this by teaching the <code>EncryptCookies</code> middleware to temporarily disable itself for those cookies:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Cookie\Middleware\EncryptCookies</code><code class="p">;</code>&#13;
<code class="o">...</code>&#13;
&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><code class="na">app</code><code class="o">-&gt;</code><code class="na">resolving</code><code class="p">(</code>&#13;
    <code class="nx">EncryptCookies</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="k">function</code> <code class="p">(</code><code class="nv">$object</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$object</code><code class="o">-&gt;</code><code class="na">disableFor</code><code class="p">(</code><code class="s1">'cookie-name'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">);</code>&#13;
&#13;
<code class="c1">// ...run test</code></pre>&#13;
</div>&#13;
&#13;
<p>That means you can set a cookie and check against it with something like <a data-type="xref" href="#running_tests_against_cookies">Example 14-23</a>.</p>&#13;
<div data-type="example" id="running_tests_against_cookies">&#13;
<h5><span class="label">Example 14-23. </span>Running unit tests against cookies</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_cookie</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">app</code><code class="o">-&gt;</code><code class="na">resolving</code><code class="p">(</code><code class="nx">EncryptCookies</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$object</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$object</code><code class="o">-&gt;</code><code class="na">disableFor</code><code class="p">(</code><code class="s1">'my-cookie'</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="p">(</code>&#13;
        <code class="s1">'get'</code><code class="p">,</code>&#13;
        <code class="s1">'route-echoing-my-cookie-value'</code><code class="p">,</code>&#13;
        <code class="p">[],</code>&#13;
        <code class="p">[</code><code class="s1">'my-cookie'</code> <code class="o">=&gt;</code> <code class="s1">'baz'</code><code class="p">]</code>&#13;
    <code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="s1">'baz'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If you want to test that a response has a cookie set, you can use <code>assertCookie()</code> to test for the cookie:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'cookie-setting-route'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertCookie</code><code class="p">(</code><code class="s1">'cookie-name'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Or you could use <code>assertPlainCookie()</code> to test for the cookie and to assert that it’s not encrypted.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Log" data-type="sect2"><div class="sect2" id="id516">&#13;
<h2>Log</h2>&#13;
&#13;
<p>The<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="logging" data-type="indexterm" id="id1787"/><a data-primary="logging" data-secondary="testing" data-type="indexterm" id="id1788"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="logging" data-type="indexterm" id="id1789"/> simplest way to test that a certain log was written is by making assertions against the <code>Log</code> facade (learn more in <a data-type="xref" href="ch12.html#faking_facades">“Faking Other Facades”</a>). <a data-type="xref" href="#EX14e">Example 14-24</a> shows how this works.</p>&#13;
<div data-type="example" id="EX14e">&#13;
<h5><span class="label">Example 14-24. </span>Making assertions against the <code>Log</code> facade</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Test file</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_new_accounts_generate_log_entries</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Log</code><code class="o">::</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'info'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">once</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'New account created!'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Create a new account</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'accounts.store'</code><code class="p">),</code> <code class="p">[</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'matt@mattstauffer.com'</code><code class="p">]);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// AccountController</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Create account</code>&#13;
&#13;
    <code class="nx">Log</code><code class="o">::</code><code class="na">info</code><code class="p">(</code><code class="s1">'New account created!'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>There’s also a package called <a href="https://oreil.ly/TCBMm">Log Fake</a> that expands on what you can do with the facade testing shown here and allows you to write more customized assertions against your logs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scout" data-type="sect2"><div class="sect2" id="id295">&#13;
<h2>Scout</h2>&#13;
&#13;
<p>If<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="Scout" data-type="indexterm" id="id1790"/><a data-primary="Scout" data-type="indexterm" id="id1791"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="Scout" data-type="indexterm" id="id1792"/> you need to test code that uses Scout data, you’re probably not going to want your tests triggering indexing actions or reading from Scout. Simply add an environment variable to your <em>phpunit.xml</em> to disable Scout’s connection to Algolia:</p>&#13;
&#13;
<pre data-code-language="xml" data-type="programlisting"><code class="nt">&lt;env</code><code class="w"> </code><code class="na">name=</code><code class="s">"SCOUT_DRIVER"</code><code class="w"> </code><code class="na">value=</code><code class="s">"null"</code><code class="nt">/&gt;</code><code class="w"/></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Client" data-type="sect2"><div class="sect2" id="id296">&#13;
<h2>HTTP Client</h2>&#13;
&#13;
<p>One<a data-primary="storage and retrieval" data-secondary="testing" data-tertiary="HTTP client" data-type="indexterm" id="id1793"/><a data-primary="testing" data-secondary="storage and retrieval" data-tertiary="HTTP client" data-type="indexterm" id="id1794"/><a data-primary="HTTP client" data-type="indexterm" id="id1795"/> incredible benefit of using Laravel’s HTTP client is that it makes it possible to fake responses in your tests with minimal configuration.</p>&#13;
&#13;
<p>The simplest option is to run <code>Http::fake()</code>, which will return an empty successful response from every call you make.</p>&#13;
&#13;
<p>However, you can also customize the specific responses you want to come back from your HTTP client calls, as you can see in <a data-type="xref" href="#EX14i">Example 14-25</a>.</p>&#13;
<div data-type="example" id="EX14i">&#13;
<h5><span class="label">Example 14-25. </span>Customizing responses to HTTP clients by URL</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Http</code><code class="o">::</code><code class="na">fake</code><code class="p">([</code>&#13;
    <code class="c1">// Return a JSON response for a particular API</code>&#13;
    <code class="s1">'my-api.com/*'</code> <code class="o">=&gt;</code> <code class="nx">Http</code><code class="o">::</code><code class="na">response</code><code class="p">([</code><code class="s1">'key'</code> <code class="o">=&gt;</code> <code class="s1">'value'</code><code class="p">],</code> <code class="mi">200</code><code class="p">,</code> <code class="nv">$headersArray</code><code class="p">),</code>&#13;
&#13;
    <code class="c1">// Return a string response for all other endpoints</code>&#13;
    <code class="s1">'*'</code> <code class="o">=&gt;</code> <code class="nx">Http</code><code class="o">::</code><code class="na">response</code><code class="p">(</code><code class="s1">'This is a fake API response'</code><code class="p">,</code> <code class="mi">200</code><code class="p">,</code> <code class="nv">$headersArray</code><code class="p">),</code>&#13;
<code class="p">]);</code></pre></div>&#13;
&#13;
<p>If, instead, you need to define that requests made to a given endpoint (or that match a given endpoint pattern) follow a particular sequence, you can also define that, as you can see in <a data-type="xref" href="#EX14j">Example 14-26</a>.</p>&#13;
<div data-type="example" id="EX14j">&#13;
<h5><span class="label">Example 14-26. </span>Defining a sequence of responses to a given endpoint</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Http</code><code class="o">::</code><code class="na">fake</code><code class="p">([</code>&#13;
    <code class="c1">// Return a sequence of responses for consecutive calls to this API</code>&#13;
    <code class="s1">'my-api.com/*'</code> <code class="o">=&gt;</code> <code class="nx">Http</code><code class="o">::</code><code class="na">sequence</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">push</code><code class="p">(</code><code class="s1">'Initial string response'</code><code class="p">,</code> <code class="mi">200</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">push</code><code class="p">([</code><code class="s1">'secondary'</code> <code class="o">=&gt;</code> <code class="s1">'response'</code><code class="p">],</code> <code class="mi">200</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">pushStatus</code><code class="p">(</code><code class="mi">404</code><code class="p">),</code>&#13;
<code class="p">]);</code></pre></div>&#13;
&#13;
<p>You can also make assertions against the data your application is sending to particular endpoints, as in <a data-type="xref" href="#EX14k">Example 14-27</a>.</p>&#13;
<div data-type="example" id="EX14k">&#13;
<h5><span class="label">Example 14-27. </span>Asserting against the calls your application makes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Http</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
<code class="nx">Http</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">hasHeader</code><code class="p">(</code><code class="s1">'X-Custom-Header'</code><code class="p">,</code> <code class="s1">'certain-value'</code><code class="p">)</code> <code class="o">&amp;&amp;</code>&#13;
        <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">url</code><code class="p">()</code> <code class="o">==</code> <code class="s1">'http://my-api.com/users/2/comments'</code> <code class="o">&amp;&amp;</code>&#13;
        <code class="nv">$request</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]</code> <code class="o">==</code> <code class="s1">'New User'</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id517">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Laravel provides simple interfaces<a data-primary="storage and retrieval" data-secondary="overview of" data-type="indexterm" id="id1796"/> to many common storage operations: filesystem access, sessions, cookies, the cache, and search. Each of these APIs is the same regardless of which provider you use, which Laravel enables by allowing multiple “drivers” to serve the same public interface. This makes it simple to switch providers depending on the environment or as the needs of the application change.</p>&#13;
</div></section>&#13;
</div></section></body></html>