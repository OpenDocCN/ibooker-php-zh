<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>PHP Cookbook</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 13. Debugging and Testing"><div class="chapter" id="chapter_debugging">
<h1><span class="label">Chapter 13. </span>Debugging and Testing</h1>


<p>Despite developers’ best efforts, no code is ever perfect. You will inevitably introduce a bug that impacts the production behavior of your application or causes an end user distress when something doesn’t operate as expected.</p>

<p>Properly handling errors within your application is critical.<sup><a data-type="noteref" id="idm45875143879696-marker" href="ch13.html#idm45875143879696">1</a></sup> However, not every error your application throws is expected—or even catchable. In these circumstances, you must understand how to properly <em>debug</em> your application—how to track down the offending line of code so it can be fixed.</p>

<p>Among the first steps any PHP engineer uses <a data-type="indexterm" data-primary="debugging" data-secondary="echo statement" id="idm45875143877376"></a><a data-type="indexterm" data-primary="echo statement" id="idm45875143876400"></a><a data-type="indexterm" data-primary="statements" data-secondary="echo" id="idm45875143875728"></a>to debug their code is the <code>echo</code> statement. Without a formal debugger, it’s common to see development code littered with <code>echo "Here!";</code> statements so the team can track where things might be broken.</p>

<p>The Laravel framework has made similar functionality popular and easily accessible while working on new projects by exposing a function called <a href="https://oreil.ly/N-bOz"><code>dd()</code></a> (short for “dump and die”). This function is actually provided by the Symfony <a href="https://oreil.ly/8pXGo"><code>var-dumper</code></a> module and works effectively in both PHP’s native command-line interface and when leveraging an interactive debugger. The function itself is defined as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">dd</code><code class="p">(</code><code class="o">...</code><code class="nv">$vars</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">in_array</code><code class="p">(</code><code class="nx">\PHP_SAPI</code><code class="p">,</code> <code class="p">[</code><code class="s1">'cli'</code><code class="p">,</code> <code class="s1">'phpdbg'</code><code class="p">],</code> <code class="k">true</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="nb">headers_sent</code><code class="p">())</code> <code class="p">{</code>
        <code class="nb">header</code><code class="p">(</code><code class="s1">'HTTP/1.1 500 Internal Server Error'</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">foreach</code> <code class="p">(</code><code class="nv">$vars</code> <code class="k">as</code> <code class="nv">$v</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">VarDumper</code><code class="o">::</code><code class="na">dump</code><code class="p">(</code><code class="nv">$v</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The preceding function, when used in a Laravel application, will print the contents of any variable you pass it to the screen and then halt the program’s execution immediately. Like using <code>echo</code>, it’s not the most elegant way to debug an application. However, it is fast, reliable, and a common way developers will debug a system in a hurry.</p>

<p>One of the best ways to preemptively debug your code is through unit testing. By breaking your code down into the smallest units of logic, you can write additional code that automatically tests and verifies the functionality of those units of logic. You then wire these tests to your integration and deployment pipeline and can ensure that nothing has broken in your application prior to deployment.</p>

<p>The open source <a href="https://phpunit.de">PHPUnit</a> project makes it simple and straightforward to instrument your entire application and automatically test its behavior. All of your tests are written in PHP, load your application’s functions and classes directly, and explicitly document the correct behavior of the application.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>An alternative to PHPUnit is the open source <a href="https://oreil.ly/mAWR5">Behat</a> library. Whereas PHPUnit focuses on test-driven development (TDD), Behat focuses on an alternative <em>behavior</em>-driven development (BDD) paradigm. Both <a data-type="indexterm" data-primary="TDD (test-driven development)" id="idm45875143812560"></a><a data-type="indexterm" data-primary="BDD (behavior-driven development)" id="idm45875143811888"></a><a data-type="indexterm" data-primary="testing" data-secondary="TDD (test-driven development)" id="idm45875143811248"></a><a data-type="indexterm" data-primary="testing" data-secondary="BDD (behavior-driven development)" id="idm45875143810336"></a>are equally useful for testing your code, and your team should choose which approach to take. PHPUnit is a more established project, though, and will be referenced throughout this chapter.</p>
</div>

<p>Hands down, the best way to debug your code is to <a data-type="indexterm" data-primary="Xdebug" id="idm45875143808784"></a><a data-type="indexterm" data-primary="debugging" data-secondary="Xdebug" id="idm45875143794784"></a>use an interactive debugger. <a href="https://xdebug.org">Xdebug</a> is a debugging extension for PHP that improves error handling, supports tracing or profiling an application’s behavior, and integrates with testing tools like PHPUnit to illustrate test coverage of application code. More importantly, Xdebug also supports interactive, step-through debugging of your application.</p>

<p>Armed with Xdebug and a compatible IDE, you can place flags in your code called <em>breakpoints</em>. When the <a data-type="indexterm" data-primary="debugging" data-secondary="breakpoints" id="idm45875143792224"></a><a data-type="indexterm" data-primary="breakpoints" id="idm45875143791216"></a>application is running and hits these breakpoints, it pauses execution and allows you to interactively inspect the state of the application. This means you can view all variables in scope, where they came from, and continue executing the program one command at a time in your hunt for bugs. It is by far the most powerful tool in your arsenal as a PHP developer!</p>

<p>The following recipes cover the basics of debugging PHP applications. You will learn how to set up interactive debugging, capture errors, properly test your code to prevent regressions, and quickly identify when and where a breaking change has been introduced.</p>






<section data-type="sect1" data-pdf-bookmark="13.1 Using a Debugger Extension"><div class="sect1" id="idm45875143789904">
<h1>13.1 Using a Debugger Extension</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875143788656">
<h2>Problem</h2>

<p>You want to leverage a robust, external <a data-type="indexterm" data-primary="debugging" data-secondary="external debuggers" id="dbgxbg"></a><a data-type="indexterm" data-primary="Xdebug" data-secondary="installing" id="xdgslg"></a><a data-type="indexterm" data-primary="debugging" data-secondary="Xdebug" data-tertiary="installing" id="bgxglg"></a>debugger to inspect and manage your application so you can identify, profile, and eliminate errors in business logic.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875143782864">
<h2>Solution</h2>

<p>Install Xdebug, an open source debugging extension for PHP. Xdebug can be installed directly on Linux operating systems by using the default package manager. On Ubuntu, for example, install Xdebug by using <code>apt</code>:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>sudo<code class="w"> </code>apt<code class="w"> </code>install<code class="w"> </code>php-xdebug<code class="w"></code></pre>

<p>As package managers can sometimes install an outdated version of the project, you can also install it directly with the PECL extension manager:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>pecl<code class="w"> </code>install<code class="w"> </code>xdebug<code class="w"></code></pre>

<p>Once Xdebug is live on your system, it will embellish error pages for you automatically, presenting rich stack traces and debugging information to make it easier to identify errors when things go wrong.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875143717536">
<h2>Discussion</h2>

<p>Xdebug is a powerful extension for PHP. It empowers you to fully test, profile, and debug your applications in effective ways the language does not support natively. One of the most useful features you get by default with no additional configuration is a vast improvement to error reporting.</p>

<p>By default, Xdebug will automatically capture any errors thrown by your application and expose additional information about the following:</p>

<ul>
<li>
<p>The call stack (as illustrated in <a data-type="xref" href="#xdebug_stack_trace">Figure 13-1</a>), including both timing and memory utilization data. This helps you identify exactly when the program failed and where in code the function calls were occurring.</p>
</li>
<li>
<p>Variables from the local scope so you don’t need to guess what data was in memory when the error was thrown.</p>
</li>
</ul>

<figure><div id="xdebug_stack_trace" class="figure">
<img src="assets/phpc_1301.png" alt="Xdebug enriches and formats the information presented when errors occur" width="600" height="313"/>
<h6><span class="label">Figure 13-1. </span>Xdebug enriches and formats the information presented when errors occur</h6>
</div></figure>

<p>Advanced integrations with tools like <a href="https://oreil.ly/OXg9b">Webgrind</a> also allow you to dynamically profile the performance of your application. Xdebug will (optionally) record the execution time of every function invocation and record both that time and the “cost” of a function call to disk. The Webgrind application then presents a handy visualization to help you identify bottlenecks in your code to optimize the program as necessary.</p>

<p>You can even pair Xdebug directly with <a data-type="indexterm" data-primary="Xdebug" data-secondary="development environment and" id="idm45875143741872"></a>your development environment for <a href="https://oreil.ly/FK9iz">step-through debugging</a>. By pairing your environment (e.g., <a href="https://oreil.ly/u4dZy">Visual Studio Code</a>) with an Xdebug configuration, you can place breakpoints in your code and literally pause execution when the PHP interpreter hits those points.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The <a href="https://oreil.ly/vVCVY">PHP Debug</a> extension makes integration between Xdebug and Visual Studio Code incredibly straightforward. It adds all of the additional interfaces you’d expect directly to your IDE, in terms of both breakpoints and environment introspection. It’s also maintained directly by the Xdebug community, so you can be sure it’s in sync with the overall project.</p>
</div>

<p>While debugging in step-through mode, your <a data-type="indexterm" data-primary="debugging" data-secondary="step-through mode" id="idm45875143737184"></a>application will pause on a breakpoint and give you direct access to all variables within the program scope. You can both inspect <em>and modify</em> these variables to test your environment. Further, while paused in a breakpoint, you have full console access to the application to further identify what might be going on. The call stack is directly exposed, so you can dive deep into which function or method object has led to the breakpoint and make changes where 
<span class="keep-together">necessary</span>.</p>

<p>While in a breakpoint, you can either step through the program one line at a time or opt to “continue” execution <a data-type="indexterm" data-primary="debugging" data-secondary="breakpoints" id="idm45875143712448"></a>either until the next breakpoint or until the first error thrown by the program. Breakpoints can also be disabled without removing them from the IDE, so you can continue execution as necessary but revisit particular trouble spots later on demand.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Xdebug is an immensely powerful development tool for any PHP development team. However, it has been known to add significant performance overhead to even the smallest application. Ensure that you are only ever enabling this extension for local development or in protected environments with test <a data-type="indexterm" data-primary="debugging" data-secondary="external debuggers" data-startref="dbgxbg" id="idm45875143710368"></a><a data-type="indexterm" data-primary="Xdebug" data-secondary="installing" data-startref="xdgslg" id="idm45875143709120"></a><a data-type="indexterm" data-primary="debugging" data-secondary="Xdebug" data-tertiary="installing" data-startref="bgxglg" id="idm45875143707904"></a>deployments. Never deploy your application to production with Xdebug installed!</p>
</div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875143705904">
<h2>See Also</h2>

<p>Documentation and home page for <a href="https://xdebug.org">Xdebug</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.2 Writing a Unit Test"><div class="sect1" id="unit_testing">
<h1>13.2 Writing a Unit Test</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875143701984">
<h2>Problem</h2>

<p>You want to validate the behavior of a <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="writing tests" id="tstutgwr"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="writing tests" id="uttwtst"></a>piece of code to ensure that future refactoring doesn’t change the functionality of your application.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875143697392">
<h2>Solution</h2>

<p>Write a class that extends PHPUnit’s <code>TestCase</code> and explicitly tests the behavior of the application. For example, if your function is intended to extract a domain name from an email address, you would define it as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">extractDomain</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$email</code><code class="p">)</code><code class="o">:</code> <code class="nx">string</code>
<code class="p">{</code>
    <code class="nv">$parts</code> <code class="o">=</code> <code class="nb">explode</code><code class="p">(</code><code class="s1">'@'</code><code class="p">,</code> <code class="nv">$email</code><code class="p">);</code>

    <code class="k">return</code> <code class="nv">$parts</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>
<code class="p">}</code></pre>

<p>Then create a class to test and validate the functionality of this code. Such a test would look like the following:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">use</code> <code class="nx">PHPUnit\Framework\TestCase</code><code class="p">;</code>

<code class="k">final</code> <code class="k">class</code> <code class="nc">FunctionTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">testSimpleDomainExtraction</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEquals</code><code class="p">(</code><code class="s1">'example.com'</code><code class="p">,</code> <code class="nx">extractDomain</code><code class="p">(</code><code class="s1">'php@example.com'</code><code class="p">));</code>
    <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875143551872">
<h2>Discussion</h2>

<p>The most important aspect of PHPUnit is how you organize your project. First of all, the project needs to leverage Composer for autoloading both your application code and for loading any dependencies (including PHPUnit itself).<sup><a data-type="noteref" id="idm45875143583840-marker" href="ch13.html#idm45875143583840">2</a></sup> Typically, you will place your application code in a <em>src/</em> directory within the root of your project, and all of your test code will live in a <em>tests/</em> directory alongside it.</p>

<p>In the Solution example, you would place your <code>extractDomain()</code> function in <em>src/functions.php</em> and the <code>FunctionTest</code> class in <em>tests/FunctionTest.php</em>. Assuming autoloading is properly configured via Composer, you would then run the test using PHPUnit’s bundled command-line tool as follows:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>./vendor/bin/phpunit<code class="w"> </code>tests<code class="w"></code></pre>

<p>The preceding command will, by default, automatically identify and run every test class defined in your <em>tests/</em> directory via PHPUnit. To more comprehensively control the way PHPUnit runs, you can leverage a local configuration file to describe test suites, file allow lists, and configure any specific environment variables needed during testing.</p>

<p>The XML-based configuration is not often used except for complex or complicated projects, but the <a href="https://oreil.ly/Gz86n">project documentation</a> details at length how to configure it. A basic <em>phpunit.xml</em> file usable with this recipe or other similarly simple projects would look something like <a data-type="xref" href="#basic_phpunit_xml_config">Example 13-1</a>.</p>
<div id="basic_phpunit_xml_config" data-type="example">
<h5><span class="label">Example 13-1. </span>Basic PHPUnit XML configuration</h5>

<pre data-type="programlisting" data-code-language="xml"><code class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</code><code class="w"></code>

<code class="nt">&lt;phpunit</code><code class="w"> </code><code class="na">bootstrap=</code><code class="s">"vendor/autoload.php"</code><code class="w"></code>
<code class="w">         </code><code class="na">backupGlobals=</code><code class="s">"false"</code><code class="w"></code>
<code class="w">         </code><code class="na">backupStaticAttributes=</code><code class="s">"false"</code><code class="w"></code>
<code class="w">         </code><code class="na">colors=</code><code class="s">"true"</code><code class="w"></code>
<code class="w">         </code><code class="na">convertErrorsToExceptions=</code><code class="s">"true"</code><code class="w"></code>
<code class="w">         </code><code class="na">convertNoticesToExceptions=</code><code class="s">"true"</code><code class="w"></code>
<code class="w">         </code><code class="na">convertWarningsToExceptions=</code><code class="s">"true"</code><code class="w"></code>
<code class="w">         </code><code class="na">processIsolation=</code><code class="s">"false"</code><code class="w"></code>
<code class="w">         </code><code class="na">stopOnFailure=</code><code class="s">"false"</code><code class="nt">&gt;</code><code class="w"></code>

<code class="w">  </code><code class="nt">&lt;coverage&gt;</code><code class="w"></code>
<code class="w">    </code><code class="nt">&lt;include&gt;</code><code class="w"></code>
<code class="w">      </code><code class="nt">&lt;directory</code><code class="w"> </code><code class="na">suffix=</code><code class="s">".php"</code><code class="nt">&gt;</code>src/<code class="nt">&lt;/directory&gt;</code><code class="w"></code>
<code class="w">    </code><code class="nt">&lt;/include&gt;</code><code class="w"></code>
<code class="w">  </code><code class="nt">&lt;/coverage&gt;</code><code class="w"></code>

<code class="w">  </code><code class="nt">&lt;testsuites&gt;</code><code class="w"></code>
<code class="w">    </code><code class="nt">&lt;testsuite</code><code class="w"> </code><code class="na">name=</code><code class="s">"unit"</code><code class="nt">&gt;</code><code class="w"></code>
<code class="w">      </code><code class="nt">&lt;directory&gt;</code>tests<code class="nt">&lt;/directory&gt;</code><code class="w"></code>
<code class="w">    </code><code class="nt">&lt;/testsuite&gt;</code><code class="w"></code>
<code class="w">  </code><code class="nt">&lt;/testsuites&gt;</code><code class="w"></code>

<code class="w">  </code><code class="nt">&lt;php&gt;</code><code class="w"></code>
<code class="w">    </code><code class="nt">&lt;env</code><code class="w"> </code><code class="na">name=</code><code class="s">"APP_ENV"</code><code class="w"> </code><code class="na">value=</code><code class="s">"testing"</code><code class="nt">/&gt;</code><code class="w"></code>
<code class="w">  </code><code class="nt">&lt;/php&gt;</code><code class="w"></code>

<code class="nt">&lt;/phpunit&gt;</code><code class="w"></code></pre></div>

<p>Armed with the preceding <em>phpunit.xml</em> file in your project, you merely need to invoke PHPUnit itself to run your tests. You no longer need to specify the <em>tests/</em> directory, as that’s now provided by the <code>testsuite</code> definition in the application configuration.</p>

<p>Similarly, you can also specify <em>multiple</em> test suites for <a data-type="indexterm" data-primary="unit testing" data-secondary="multiple test suites" id="idm45875143495600"></a><a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="multiple test suites" id="idm45875143494624"></a>different scenarios. Perhaps one set of tests is built by your development team proactively as they’re writing code (<em>unit</em> in the preceding example). Another set of <a data-type="indexterm" data-primary="testing" data-secondary="user-reported bugs" id="idm45875143492768"></a>tests might be written by your quality assurance (QA) team to replicate user-reported bugs (<em>regressions</em>). The advantage of the second test suite is that you can then refactor your application until the tests pass (i.e., the bugs are fixed) while also ensuring that you haven’t modified the overall behavior of your application.</p>

<p>You can also ensure that old bugs don’t reappear down the line!</p>

<p>In addition, you can choose which test suite runs at which time by passing the optional <code>--testsuite</code> flag to PHPUnit when it’s run. Most tests are going to be fast, meaning they can be run frequently without costing your development team any additional time. Fast tests should be run as frequently as possible during development to ensure that your code is working and that no new (or old) bugs have crept into the codebase. At times, though, you might need to write a test that is too costly to run very often. These tests should be kept in a separate test suite so you can test around them. The tests remain and can be used before a deployment but won’t slow down day-to-day development when standard tests run frequently.</p>

<p>Function tests, like that in <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="function tests" id="idm45875143489520"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="function tests" id="idm45875143488272"></a>the Solution example, are quite simple. Object tests are similar in that you are instantiating an object within a test and exercising its methods. The hardest part, however, is simulating multiple possible inputs to a particular function or method. PHPUnit solves this with data providers.</p>

<p>For a simple example, consider the <code>add()</code> function in <a data-type="xref" href="#simple_addition_for_testing">Example 13-2</a>. This function explicitly uses loose typing to add two values (regardless of their types) together.</p>
<div id="simple_addition_for_testing" data-type="example">
<h5><span class="label">Example 13-2. </span>Simple addition function</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">)</code><code class="o">:</code> <code class="nx">mixed</code>
<code class="p">{</code>
    <code class="k">return</code> <code class="nv">$a</code> <code class="o">+</code> <code class="nv">$b</code><code class="p">;</code>
<code class="p">}</code></pre></div>

<p>Since the parameters in the preceding function can be of different types (<code>int</code>/<code>int</code>, <code>int</code>/<code>float</code>, <code>string</code>/<code>float</code>, etc.), you should test the various combinations to ensure that nothing breaks. Such a test structure would look like the class in <a data-type="xref" href="#simple_addition_test">Example 13-3</a>.</p>
<div id="simple_addition_test" data-type="example">
<h5><span class="label">Example 13-3. </span>Simple test of PHP addition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">final</code> <code class="k">class</code> <code class="nc">FunctionTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>
<code class="p">{</code>
    <code class="c1">// ...</code>

    <code class="sd">/**</code>
<code class="sd">     * @dataProvider additionProvider</code>
<code class="sd">     */</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">testAdd</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">,</code> <code class="nv">$expected</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertSame</code><code class="p">(</code><code class="nv">$expected</code><code class="p">,</code> <code class="nx">add</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">));</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">additionProvider</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="p">[</code>
            <code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">],</code>
            <code class="p">[</code><code class="mi">2</code><code class="p">,</code> <code class="mf">3.0</code><code class="p">,</code> <code class="mf">5.0</code><code class="p">],</code>
            <code class="p">[</code><code class="mf">2.0</code><code class="p">,</code> <code class="s1">'3'</code><code class="p">,</code> <code class="mf">5.0</code><code class="p">],</code>
            <code class="p">[</code><code class="s1">'2'</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">5</code><code class="p">]</code>
        <code class="p">];</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p>The <code>@dataProvider</code> annotation tells PHPUnit the name of a function within the test’s class that should be used to provide data for testing. Rather than writing four separate tests, you’ve now provided PHPUnit with the ability to run a single test four times with differing inputs and expected outputs. The end result is the same—four separate tests of your <code>add()</code> function—but without the need to explicitly write those extra tests.</p>

<p>Given the structure of the <code>add()</code> function defined in <a data-type="xref" href="#simple_addition_for_testing">Example 13-2</a>, you might run afoul of certain type restrictions in PHP. While it’s possible to pass numeric strings into the function (they’re cast to numeric values before addition), passing non-numeric data will result in a PHP warning. In a world where user input is passed to this function, that kind of issue can and will come up. It’s best to protect against it by explicitly checking the input values with <code>is_numeric()</code> and throwing a known exception that can be caught elsewhere.</p>

<p>To accomplish this, first write a new test to <em>expect</em> that exception and validate that it’s thrown appropriately. Such a test would look like <a data-type="xref" href="#testing_exceptions">Example 13-4</a>.</p>
<div id="testing_exceptions" data-type="example">
<h5><span class="label">Example 13-4. </span>Testing the expected presence of exceptions in your code</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">final</code> <code class="k">class</code> <code class="nc">FunctionTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>
<code class="p">{</code>
    <code class="c1">// ...</code>

    <code class="sd">/**</code>
<code class="sd">     * @dataProvider invalidAdditionProvider</code>
<code class="sd">     */</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">testInvalidInput</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">,</code> <code class="nv">$expected</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">expectException</code><code class="p">(</code><code class="nx">InvalidArgumentException</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>
        <code class="nx">add</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">invalidAdditionProvider</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="p">[</code>
            <code class="p">[</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'invalid'</code><code class="p">,</code> <code class="k">null</code><code class="p">],</code>
            <code class="p">[</code><code class="s1">'invalid'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="k">null</code><code class="p">],</code>
            <code class="p">[</code><code class="s1">'invalid'</code><code class="p">,</code> <code class="s1">'invalid'</code><code class="p">,</code> <code class="k">null</code><code class="p">]</code>
        <code class="p">];</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Writing tests before changing your code is valuable because it gives you a precise target to achieve while refactoring. However, this new test will fail until you make the changes to the application code. Take care not to commit failing tests to your project’s version control or you will compromise your team’s ability to practice continuous integration!</p>
</div>

<p>With the preceding test in place, the test suite now fails as the function does not match the documented or expected behavior. Take time to add the appropriate <code>is_numeric()</code> checks to the function as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nv">$a</code><code class="p">,</code> <code class="nv">$b</code><code class="p">)</code><code class="o">:</code> <code class="nx">mixed</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">is_numeric</code><code class="p">(</code><code class="nv">$a</code><code class="p">)</code> <code class="o">||</code> <code class="o">!</code><code class="nb">is_numeric</code><code class="p">(</code><code class="nv">$b</code><code class="p">))</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">InvalidArgumentException</code><code class="p">(</code><code class="s1">'Input must be numeric!'</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="nv">$a</code> <code class="o">+</code> <code class="nv">$b</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>Unit tests are an effective way to document the expected and appropriate behavior of your application since they are executable code that also validates that the application is functioning properly. You can test both success <em>and</em> failure conditions and even go so far as to mock various dependencies within your code.</p>

<p>The PHPUnit project also provides the ability to proactively identify the percentage of your application code <a href="https://oreil.ly/PEdVd">that is covered by unit tests</a>. A higher percentage of coverage is not a guarantee against bugs but is a reliable way to ensure that bugs can be found and <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="writing tests" data-startref="tstutgwr" id="idm45875143033408"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="writing tests" data-startref="uttwtst" id="idm45875143031952"></a>corrected quickly with minimal impact to end users.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875143584496">
<h2>See Also</h2>

<p>Documentation on how to leverage <a href="https://oreil.ly/5oYv4">PHPUnit</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.3 Automating Unit Tests"><div class="sect1" id="automating_unit_tests">
<h1>13.3 Automating Unit Tests</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875143027216">
<h2>Problem</h2>

<p>You want your project’s unit tests <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="automating tests" id="tsutaut"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="automating" id="uttstamt"></a>to run frequently, without user interaction, before any changes to the codebase are committed to version control.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875143017024">
<h2>Solution</h2>

<p>Leverage a Git commit hook to automatically <a data-type="indexterm" data-primary="Git commit hooks, unit tests and" id="idm45875143015504"></a>run your unit tests <em>before</em> a commit is made locally. For example, the <code>pre-commit</code> hook in <a data-type="xref" href="#simple_git_pre_commit">Example 13-5</a> will automatically run PHPUnit every time the user runs <code>git commit</code> but before any data is actually written to the repository.</p>
<div id="simple_git_pre_commit" data-type="example">
<h5><span class="label">Example 13-5. </span>Simple Git <code>pre-commit</code> hook for PHPUnit</h5>

<pre data-type="programlisting" data-code-language="sh"><code class="ch">#!/usr/bin/env php</code>
&lt;?php<code class="w"></code>

<code class="nb">echo</code><code class="w"> </code><code class="s2">"Running tests.. "</code><code class="p">;</code><code class="w"></code>
exec<code class="o">(</code><code class="s1">'vendor/bin/phpunit'</code>,<code class="w"> </code><code class="nv">$output</code>,<code class="w"> </code><code class="nv">$returnCode</code><code class="o">)</code><code class="p">;</code><code class="w"></code>

<code class="k">if</code><code class="w"> </code><code class="o">(</code><code class="nv">$returnCode</code><code class="w"> </code>!<code class="o">==</code><code class="w"> </code><code class="m">0</code><code class="o">)</code><code class="w"> </code><code class="o">{</code><code class="w"></code>
<code class="w">  </code><code class="nb">echo</code><code class="w"> </code>PHP_EOL<code class="w"> </code>.<code class="w"> </code>implode<code class="o">(</code><code class="nv">$output</code>,<code class="w"> </code>PHP_EOL<code class="o">)</code><code class="w"> </code>.<code class="w"> </code>PHP_EOL<code class="p">;</code><code class="w"></code>
<code class="w">  </code><code class="nb">echo</code><code class="w"> </code><code class="s2">"Aborting commit.."</code><code class="w"> </code>.<code class="w"> </code>PHP_EOL<code class="p">;</code><code class="w"></code>
<code class="w">  </code>exit<code class="o">(</code><code class="m">1</code><code class="o">)</code><code class="p">;</code><code class="w"></code>
<code class="o">}</code><code class="w"></code>

<code class="nb">echo</code><code class="w"> </code>array_pop<code class="o">(</code><code class="nv">$output</code><code class="o">)</code><code class="w"> </code>.<code class="w"> </code>PHP_EOL<code class="p">;</code><code class="w"></code>

exit<code class="o">(</code><code class="m">0</code><code class="o">)</code><code class="p">;</code><code class="w"></code></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875142932976">
<h2>Discussion</h2>

<p>Git is by far the most popular distributed version control system available and is also the system used by the core PHP development team. It’s open source and highly flexible both in how it hosts repositories and how you can customize workflows and project structures to fit your development cycle.</p>

<p>Specifically, Git allows customization by way of hooks. Your hooks live in the <em>.git/hooks</em> directory within your project alongside other information Git uses to track the state of your project itself. By default, even an empty Git repository includes several sample hooks, as shown in <a data-type="xref" href="#sample_git_hooks">Figure 13-2</a>.</p>

<figure><div id="sample_git_hooks" class="figure">
<img src="assets/phpc_1302.png" alt="Git initializes even an empty repository with sample hooks" width="600" height="346"/>
<h6><span class="label">Figure 13-2. </span>Git initializes even an empty repository with sample hooks</h6>
</div></figure>

<p>Each of the sample hooks is postfixed with a <code>.sample</code> extension that will disable it by default. If the sample hooks are ever something you do want to use, merely remove that extension, and the hook will run on that action.</p>

<p>In the case of automated testing, you want the <code>pre-commit</code> hook explicitly and should create a file with that name containing the contents of <a data-type="xref" href="#simple_git_pre_commit">Example 13-5</a>. With the hook in place, Git will always run this script before it commits the code.</p>

<p>The <code>0</code> exit status at the end of the script tells Git everything is OK and it can continue with the commit. Should any of your unit tests fail, the <code>1</code> exit status will flag that something went wrong, and the commit will abort without modifying your 
<span class="keep-together">repository</span>.</p>

<p>If you are absolutely sure you know what you’re doing and need to override the hook for any reason, you can bypass the hook by adding the <code>--no-verify</code> flag when committing your code.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The <code>pre-commit</code> hook is run entirely on the client side and lives outside your code repository. Every developer will need to install the hook individually. Aside from team guidelines or company policy, there isn’t an effective way to enforce that the hook is being used (or that someone isn’t bypassing it with <code>--no-verify</code>).</p>
</div>

<p>If your team is using Git for version control, there’s a very good chance you’re also using GitHub to host a version of your repository. If so, you can <a href="https://oreil.ly/BmGZC">leverage GitHub Actions to run PHPUnit tests</a> on GitHub’s server as part of your integration and deployment pipeline.</p>

<p>Running tests locally helps protect against accidentally committing a <em>regression</em> (code that reintroduces a known bug) or other error to the repository. Running the same tests in the cloud provides even greater functionality as you can do so across a matrix of potential configurations. Developers will typically run only a single version of PHP locally, but you can run your application code and tests in containers on the server that are leveraging various versions of PHP or even different dependency versions.</p>

<p>Using GitHub Actions to run tests also provides the following benefits:</p>

<ul>
<li>
<p>If a new developer hasn’t yet set up their Git <code>pre-commit</code> hook and commits broken code, the Action runner will immediately flag the commit as broken and prevent that developer from accidentally releasing a bug into production.</p>
</li>
<li>
<p>Using a deterministic environment in the cloud protects your team against “well, it worked on my machine” issues, where code works in one local environment but then fails in a production environment that has a different configuration.</p>
</li>
<li>
<p>Your integration and deployment workflow should build new deployment artifacts from every commit. Wiring this build process to your tests ensures that every build artifact is <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="automating tests" data-startref="tsutaut" id="idm45875142862368"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="automating" data-startref="uttstamt" id="idm45875142860848"></a>free from known defects and is, in fact, deployable.</p>
</li>
</ul>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875142932384">
<h2>See Also</h2>

<p>Documentation on customizing Git by <a href="https://oreil.ly/TzVOA">using hooks</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.4 Using Static Code Analysis"><div class="sect1" id="idm45875142856848">
<h1>13.4 Using Static Code Analysis</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875142855632">
<h2>Problem</h2>

<p>You want to leverage an external tool <a data-type="indexterm" data-primary="testing" data-secondary="static code analysis" id="tstscys"></a><a data-type="indexterm" data-primary="static code analysis" id="stscdys"></a><a data-type="indexterm" data-primary="code analysis, static" id="cdlytt"></a>to ensure that your code is free from as many errors as possible before it ever runs.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875142850784">
<h2>Solution</h2>

<p>Use a static code analysis tool like <a href="https://phpstan.org">PHPStan</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875142848544">
<h2>Discussion</h2>

<p>PHPStan is a static code analysis <a data-type="indexterm" data-primary="PHPStan" id="idm45875142847008"></a>tool for PHP that helps minimize errors in production code by flagging them for correction long before you’ve shipped your application. It’s best when used with strict typing and helps your team write more manageable and understandable applications.<sup><a data-type="noteref" id="idm45875142846176-marker" href="ch13.html#idm45875142846176">3</a></sup></p>

<p>Like many other development tools, PHPStan can be installed into your project via Composer with the following:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>composer<code class="w"> </code>require<code class="w"> </code>--dev<code class="w"> </code>phpstan/phpstan<code class="w"></code></pre>

<p>You can then run PHPStan against your project, analyzing both your application code and your tests directly. For example:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>./vendor/bin/phpstan<code class="w"> </code>analyze<code class="w"> </code>src<code class="w"> </code>tests<code class="w"></code></pre>

<p>By default, PHPStan runs at level 0, which is the absolute loosest level of static analysis possible. You can specify a higher level of scanning by passing the <code>--level</code> flag at the command line with a number greater than 0. <a data-type="xref" href="#phpstan_rule_levels">Table 13-1</a> enumerates the various levels available. For well-maintained, strictly typed applications, a level 9 analysis is the best way to ensure quality code.</p>
<table id="phpstan_rule_levels">
<caption><span class="label">Table 13-1. </span>PHPStan rule levels</caption>
<thead>
<tr>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>0</p></td>
<td><p>Basic checks for unknown classes, functions, or class methods. Will also check number of arguments in function calls and any variables that are never defined.</p></td>
</tr>
<tr>
<td><p>1</p></td>
<td><p>Checks for possibly undefined variables, unknown magic methods, and dynamic properties retrieved through magic getters.</p></td>
</tr>
<tr>
<td><p>2</p></td>
<td><p>Validates unknown methods on all expressions and validates functional documentation (docblocks in code).</p></td>
</tr>
<tr>
<td><p>3</p></td>
<td><p>Checks return types and property type assignment.</p></td>
</tr>
<tr>
<td><p>4</p></td>
<td><p>Checks for dead code (e.g., conditionals that are always false) and unreachable code paths.</p></td>
</tr>
<tr>
<td><p>5</p></td>
<td><p>Checks argument types.</p></td>
</tr>
<tr>
<td><p>6</p></td>
<td><p>Reports on missing type hints.</p></td>
</tr>
<tr>
<td><p>7</p></td>
<td><p>Reports partially incorrect union types.<sup><a data-type="noteref" id="idm45875142772624-marker" href="ch13.html#idm45875142772624">a</a></sup></p></td>
</tr>
<tr>
<td><p>8</p></td>
<td><p>Checks for any method calls or property access on nullable types.</p></td>
</tr>
<tr>
<td><p>9</p></td>
<td><p>Strict checks on usage of <code>mixed</code> typing.</p></td>
</tr>
</tbody>
<tbody><tr class="footnotes"><td colspan="2"><p data-type="footnote" id="idm45875142772624"><sup><a href="ch13.html#idm45875142772624-marker">a</a></sup> For examples of union types, see the discussion of <a data-type="xref" href="ch03.html#type_solution_rewrite">Example 3-9</a>.</p></td></tr></tbody></table>

<p>Once you’ve run the analysis tool, you can work on updating your application to fix basic flaws and validation errors. You can also automate the use of static analysis, similarly to the way you automated testing in <a data-type="xref" href="#automating_unit_tests">Recipe 13.3</a> to ensure that the <a data-type="indexterm" data-primary="testing" data-secondary="static code analysis" data-startref="tstscys" id="idm45875142766368"></a><a data-type="indexterm" data-primary="static code analysis" data-startref="stscdys" id="idm45875142765120"></a><a data-type="indexterm" data-primary="code analysis, static" data-startref="cdlytt" id="idm45875142764176"></a>team is running analyses (and fixing identified errors) regularly.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875142762848">
<h2>See Also</h2>

<p>The <a href="https://phpstan.org">PHPStan project home page and documentation</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.5 Logging Debugging Information"><div class="sect1" id="recipe_logging">
<h1>13.5 Logging Debugging Information</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875142758992">
<h2>Problem</h2>

<p>You want to log information about <a data-type="indexterm" data-primary="debugging" data-secondary="logging and" id="dbgggg"></a>your program when things go wrong so you can debug any potential errors later.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875142756032">
<h2>Solution</h2>

<p>Leverage the open source <a href="https://oreil.ly/yDIM7">Monolog</a> project to implement a comprehensive logging interface within your application. First install the package by <a data-type="indexterm" data-primary="Monolog, debugging and" id="mnlgdbg"></a>using Composer as 
<span class="keep-together">follows</span>:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>composer<code class="w"> </code>require<code class="w"> </code>monolog/monolog<code class="w"></code></pre>

<p>Then wire the logger into your application so you can emit warnings and errors whenever necessary. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">use</code> <code class="nx">Monolog\Level</code><code class="p">;</code>
<code class="k">use</code> <code class="nx">Monolog\Logger</code><code class="p">;</code>
<code class="k">use</code> <code class="nx">Monolog\Handler\StreamHandler</code><code class="p">;</code>

<code class="nv">$logPath</code>  <code class="o">=</code> <code class="nb">getenv</code><code class="p">(</code><code class="s1">'LOG_PATH'</code><code class="p">)</code>  <code class="o">??</code> <code class="s1">'/var/log/php/error.log'</code><code class="p">;</code>
<code class="nv">$logLevel</code> <code class="o">=</code> <code class="nb">getenv</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">)</code> <code class="o">!==</code> <code class="k">false</code>
            <code class="o">?</code> <code class="nx">Level</code><code class="o">::</code><code class="na">from</code><code class="p">(</code><code class="nb">intval</code><code class="p">(</code><code class="nb">getenv</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">)))</code>
            <code class="o">:</code> <code class="nx">Level</code><code class="o">::</code><code class="na">Warning</code><code class="p">;</code>

<code class="nv">$logger</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Logger</code><code class="p">(</code><code class="s1">'default'</code><code class="p">);</code>
<code class="nv">$logger</code><code class="o">-&gt;</code><code class="na">pushHandler</code><code class="p">(</code><code class="k">new</code> <code class="nx">StreamHandler</code><code class="p">(</code><code class="nv">$logPath</code><code class="p">,</code> <code class="nv">$logLevel</code><code class="p">));</code>

<code class="nv">$log</code><code class="o">-&gt;</code><code class="na">warning</code><code class="p">(</code><code class="s1">'Hello!'</code><code class="p">);</code>
<code class="nv">$log</code><code class="o">-&gt;</code><code class="na">error</code><code class="p">(</code><code class="s1">'World!'</code><code class="p">);</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875142695760">
<h2>Discussion</h2>

<p>The easiest way to log information from PHP is via its built-in <a href="https://oreil.ly/kXYJP"><code>error_log()</code> function</a>. This will log errors either to the server error log or to a flat file as configured in <em>php.ini</em>. The only problem is that the function explicitly logs <em>errors</em> in the application.</p>

<p>A result is that any content logged by <code>error_log()</code> is treated <a data-type="indexterm" data-primary="error_log() function" id="idm45875142500352"></a><a data-type="indexterm" data-primary="functions" data-secondary="error_log()" id="idm45875142499616"></a>as an error by any system parsing the log file. This can make it difficult to disambiguate between true errors (e.g., user login failures) and messages logged for debugging purposes. The intermingling of true errors and debugging statements can make runtime configuration difficult, particularly when you want to turn off certain logging in various environments. A workaround is to wrap any calls to <code>error_log()</code> in a check for the current logging level as shown in <a data-type="xref" href="#selective_logging">Example 13-6</a>.</p>
<div id="selective_logging" data-type="example">
<h5><span class="label">Example 13-6. </span>Selectively logging errors with <code>error_log()</code></h5>

<pre data-type="programlisting" data-code-language="php"><code class="nx">enum</code><code> </code><code class="nx">LogLevel</code><code class="o">:</code><code> </code><code class="nx">int</code><code> </code><a class="co" id="co_debugging_and_testing_CO1-1" href="#callout_debugging_and_testing_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="p">{</code><code>
    </code><code class="k">case</code><code> </code><code class="nx">Debug</code><code>   </code><code class="o">=</code><code> </code><code class="mi">100</code><code class="p">;</code><code>
    </code><code class="k">case</code><code> </code><code class="nx">Info</code><code>    </code><code class="o">=</code><code> </code><code class="mi">200</code><code class="p">;</code><code>
    </code><code class="k">case</code><code> </code><code class="nx">Warning</code><code> </code><code class="o">=</code><code> </code><code class="mi">300</code><code class="p">;</code><code>
    </code><code class="k">case</code><code> </code><code class="nx">Error</code><code>   </code><code class="o">=</code><code> </code><code class="mi">400</code><code class="p">;</code><code>
</code><code class="p">}</code><code>

</code><code class="nv">$logLevel</code><code> </code><code class="o">=</code><code> </code><code class="nb">getenv</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">)</code><code> </code><code class="o">!==</code><code> </code><code class="k">false</code><code> </code><a class="co" id="co_debugging_and_testing_CO1-2" href="#callout_debugging_and_testing_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
            </code><code class="o">?</code><code> </code><code class="nx">LogLevel</code><code class="o">::</code><code class="na">from</code><code class="p">(</code><code class="nb">intval</code><code class="p">(</code><code class="nb">getenv</code><code class="p">(</code><code class="s1">'LOG_LEVEL'</code><code class="p">)))</code><code>
            </code><code class="o">:</code><code> </code><code class="nx">LogLevel</code><code class="o">::</code><code class="na">Debug</code><code class="p">;</code><code>

</code><code class="c1">// Some application code ...
</code><code class="k">if</code><code> </code><code class="p">(</code><code class="nx">user_session_expired</code><code class="p">())</code><code> </code><code class="p">{</code><code>
    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="nv">$logLevel</code><code> </code><code class="o">&gt;=</code><code> </code><code class="nx">LogLevel</code><code class="o">::</code><code class="na">Info</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" id="co_debugging_and_testing_CO1-3" href="#callout_debugging_and_testing_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a><code>
        </code><code class="nb">error_log</code><code class="p">(</code><code class="s1">'User session expired. Logging out ...'</code><code class="p">);</code><code>
    </code><code class="p">}</code><code>

    </code><code class="nx">logout</code><code class="p">();</code><code>
    </code><code class="k">exit</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_debugging_and_testing_CO1-1" href="#co_debugging_and_testing_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The easiest way to enumerate logging levels is with a literal <code>enum</code> type in PHP.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO1-2" href="#co_debugging_and_testing_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>The log level should be retrievable from the system environment. If it’s not provided, then you should fall back on a sane, hardcoded default.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO1-3" href="#co_debugging_and_testing_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Whenever you invoke <code>error_log()</code>, you’ll need to explicitly check the current logging level and decide whether or not to actually emit the error.</p></dd>
</dl></div>

<p>The problem with <a data-type="xref" href="#selective_logging">Example 13-6</a> isn’t the use of an <code>enum</code>, nor is it the fact that you need to dynamically load the logging level from the environment. The problem is that you have to explicitly check the logging level prior to every invocation of <code>error_log()</code> to ensure that the program <em>actually should</em> emit an error. This frequent checking leads to a lot of spaghetti code and makes your application both less readable and more difficult to maintain.</p>

<p>A seasoned developer will realize the perfect solution here would be to wrap all of the logging logic (including log level checking) in a functional interface to keep the application clean. That’s absolutely the right approach, and the entire reason the Monolog package exists!</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>While Monolog is a popular PHP package for application logging, it is not the only package available. Monolog implements <a href="https://oreil.ly/76eAV">PHP’s standard Logger interface</a>; any package implementing the same interface can be dropped into your application in place of Monolog to provide similar functionality.</p>
</div>

<p>Monolog is far more powerful than merely printing strings to an error log. It also supports channels, various handlers, processors, and logging levels.</p>

<p>When instantiating a new logger, you first define a channel for that object. This allows you to create multiple logging instances side by side, keep their contents separate, and even route them to different means of output. By default, a logger needs more than a channel to operate, so you must also push a handler onto the call stack.</p>

<p><a href="https://oreil.ly/_1wLC">A handler</a> defines what Monolog should do with any message passed into a particular channel. It could route data to a file, store messages in a database, send errors via email, notify a team or channel on Slack of an issue, or even communicate with systems like RabbitMQ or Telegram.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Monolog also supports different formatters that can be attached to various handlers. Each formatter defines how messages will be serialized and sent out to the defined handler—for example, as a one-line string, a JSON blob, or an Elasticsearch document. Unless you’re working with a handler that requires data in a specific format, you’ll likely be just fine with the default formatter.</p>
</div>

<p>A processor is an optional extra step that can add data to a message. For example, the <a href="https://oreil.ly/jp-US">IntrospectionProcessor</a> will automatically add the line, file, class, and/or method from which the log call was made to the log itself. A basic 
<span class="keep-together">Monolog</span> setup to log to a flat file with introspection would look something like <a data-type="xref" href="#monolog_configuration_with_introspection">Example 13-7</a>.</p>
<div id="monolog_configuration_with_introspection" data-type="example">
<h5><span class="label">Example 13-7. </span>Monolog configuration with introspection</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">use</code> <code class="nx">Monolog\Level</code><code class="p">;</code>
<code class="k">use</code> <code class="nx">Monolog\Logger</code><code class="p">;</code>
<code class="k">use</code> <code class="nx">Monolog\Handler\StreamHandler</code><code class="p">;</code>
<code class="k">use</code> <code class="nx">Monolog\Processor\IntrospectionProcessor</code><code class="p">;</code>

<code class="nv">$logger</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Logger</code><code class="p">(</code><code class="s1">'default'</code><code class="p">);</code>
<code class="nv">$logger</code><code class="o">-&gt;</code><code class="na">pushHandler</code><code class="p">(</code><code class="k">new</code> <code class="nx">StreamHandler</code><code class="p">(</code><code class="s1">'/var/log/app.log'</code><code class="p">,</code> <code class="nx">Level</code><code class="o">::</code><code class="na">Debug</code><code class="p">));</code>
<code class="nv">$logger</code><code class="o">-&gt;</code><code class="na">pushProcessor</code><code class="p">(</code><code class="k">new</code> <code class="nx">IntrospectionProcessor</code><code class="p">());</code>

<code class="c1">// ...</code>

<code class="nv">$logger</code><code class="o">-&gt;</code><code class="na">debug</code><code class="p">(</code><code class="s1">'Something happened ...'</code><code class="p">);</code></pre></div>

<p>The last line of <a data-type="xref" href="#monolog_configuration_with_introspection">Example 13-7</a> invokes your configured logger and sends a literal string through the processor to the handler you’ve wired in. In addition, you can optionally pass additional data about the execution context or the error itself in an array as an optional second parameter.</p>

<p>Even without the additional context, if this entire code block lives in a file called <em>/src/app.php</em>, it will produce something resembling the following in the application log:</p>

<pre data-type="programlisting" data-code-language="text">[2023-01-08T22:02:00.734710+00:00] default.DEBUG: Something happened ...
[] {"file":"/src/app.php","line":15,"class":null,"callType":null,"function":null}</pre>

<p>All you needed to do was create a single line of text (<code>Something happened ...</code>), and Monolog automatically captured the event timestamp, the error level, and details about the call stack thanks to the registered processor. All of this information makes debugging and potential error correction that much easier for you and your development team.</p>

<p>Monolog also abstracts away the burden of checking the error level on each call. Instead, you define the error level at play in two locations:</p>

<ul>
<li>
<p>When registering a handler to the logger instance itself. Only errors of this error level or higher will be captured by the handler.</p>
</li>
<li>
<p>When emitting a message to the logger channel, you explicitly identify the error level attributed to it. For example, <code>::debug()</code> sends a message with an explicit error level of <code>Debug</code> assigned to it.</p>
</li>
</ul>

<p>Monolog supports the eight error levels listed in <a data-type="xref" href="#monolog_error_levels">Table 13-2</a>, all illustrated by the syslog protocol described by <a href="https://oreil.ly/Jtm9k">RFC 5424</a>.</p>
<table id="monolog_error_levels">
<caption><span class="label">Table 13-2. </span>Monolog error levels</caption>
<thead>
<tr>
<th>Error level</th>
<th>Logger method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>Level::Debug</code></p></td>
<td><p><code>::debug()</code></p></td>
<td><p>Detailed debugging information.</p></td>
</tr>
<tr>
<td><p><code>Level::Info</code></p></td>
<td><p><code>::info()</code></p></td>
<td><p>Normal events like SQL logs or information application events.</p></td>
</tr>
<tr>
<td><p><code>Level::Notice</code></p></td>
<td><p><code>::notice()</code></p></td>
<td><p>Normal events that have greater significance than informational messages.</p></td>
</tr>
<tr>
<td><p><code>Level::Warning</code></p></td>
<td><p><code>::warning()</code></p></td>
<td><p>Application warnings that could become errors in the future if action is not taken.</p></td>
</tr>
<tr>
<td><p><code>Level::Error</code></p></td>
<td><p><code>::error()</code></p></td>
<td><p>Application errors requiring immediate attention.</p></td>
</tr>
<tr>
<td><p><code>Level::Critical</code></p></td>
<td><p><code>::critical()</code></p></td>
<td><p>Critical conditions impacting the operation of the application. For example, instability or lack of availability in a key component.</p></td>
</tr>
<tr>
<td><p><code>Level::Alert</code></p></td>
<td><p><code>::alert()</code></p></td>
<td><p>Immediate action is required because of a key system failure. In critical applications, this error level should page an on-call engineer.</p></td>
</tr>
<tr>
<td><p><code>Level::Emergency</code></p></td>
<td><p><code>::emergency()</code></p></td>
<td><p>The application is unusable.</p></td>
</tr>
</tbody>
</table>

<p>Through Monolog, you can intelligently wrap error messages in the appropriate logger method and determine when these errors are actually sent to a handler based on the error level used when creating the logger itself. If you instantiate a logger only for <code>Error</code>-level messages and above, any calls to <code>::debug()</code> will <em>not</em> result in a log. The ability to discretely control your log output in production versus <a data-type="indexterm" data-primary="debugging" data-secondary="logging and" data-startref="dbgggg" id="idm45875142358000"></a><a data-type="indexterm" data-primary="Monolog, debugging and" data-startref="mnlgdbg" id="idm45875142356752"></a>development is vital to building a stable and well-logged application.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875142503504">
<h2>See Also</h2>

<p>Usage instructions for the <a href="https://oreil.ly/_5wx6">Monolog package</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.6 Dumping Variable Contents as Strings"><div class="sect1" id="idm45875142353840">
<h1>13.6 Dumping Variable Contents as Strings</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875142352560">
<h2>Problem</h2>

<p>You want to inspect the contents <a data-type="indexterm" data-primary="variables" data-secondary="complex, contents" id="vrbmpx"></a><a data-type="indexterm" data-primary="complex variables, contents" id="cpxvbltt"></a><a data-type="indexterm" data-primary="variables" data-secondary="contents as strings" id="vbttsgs"></a><a data-type="indexterm" data-primary="strings" data-secondary="variable contents as" id="stgvtts"></a>of a complex variable.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875142346256">
<h2>Solution</h2>

<p>Use <code>var_dump()</code> to convert <a data-type="indexterm" data-primary="var_dump() function" id="vdmpf"></a><a data-type="indexterm" data-primary="functions" data-secondary="var_dump()" id="vcvdp"></a>the variable into a human-readable format and print it to the current output stream (like the command-line console). For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$info</code> <code class="o">=</code> <code class="k">new</code> <code class="k">stdClass</code><code class="p">;</code>
<code class="nv">$info</code><code class="o">-&gt;</code><code class="na">name</code> <code class="o">=</code> <code class="s1">'Book Reader'</code><code class="p">;</code>
<code class="nv">$info</code><code class="o">-&gt;</code><code class="na">profession</code> <code class="o">=</code> <code class="s1">'PHP Developer'</code><code class="p">;</code>
<code class="nv">$info</code><code class="o">-&gt;</code><code class="na">favorites</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'PHP'</code><code class="p">,</code> <code class="s1">'MySQL'</code><code class="p">,</code> <code class="s1">'Linux'</code><code class="p">];</code>

<code class="nb">var_dump</code><code class="p">(</code><code class="nv">$info</code><code class="p">);</code></pre>

<p>The preceding code will print the following to the console when run in the CLI:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nx">object</code><code class="p">(</code><code class="k">stdClass</code><code class="p">)</code><code class="c1">#1 (3) {</code>
  <code class="p">[</code><code class="s2">"name"</code><code class="p">]</code><code class="o">=&gt;</code>
  <code class="nx">string</code><code class="p">(</code><code class="mi">11</code><code class="p">)</code> <code class="s2">"Book Reader"</code>
  <code class="p">[</code><code class="s2">"profession"</code><code class="p">]</code><code class="o">=&gt;</code>
  <code class="nx">string</code><code class="p">(</code><code class="mi">13</code><code class="p">)</code> <code class="s2">"PHP Developer"</code>
  <code class="p">[</code><code class="s2">"favorites"</code><code class="p">]</code><code class="o">=&gt;</code>
  <code class="k">array</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code> <code class="p">{</code>
    <code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="o">=&gt;</code>
    <code class="nx">string</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code> <code class="s2">"PHP"</code>
    <code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="o">=&gt;</code>
    <code class="nx">string</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code> <code class="s2">"MySQL"</code>
    <code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="o">=&gt;</code>
    <code class="nx">string</code><code class="p">(</code><code class="mi">5</code><code class="p">)</code> <code class="s2">"Linux"</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875142200816">
<h2>Discussion</h2>

<p>Every form of data in PHP has some string representation. Objects can enumerate their types, fields, and methods. Arrays can enumerate their members. Scalar types can expose both their types and values. It’s possible for developers to get at the inner contents of any variable in any of three slightly different but equally valuable ways.</p>

<p>First, <code>var_dump()</code> as used in the Solution example directly prints the contents of a variable to the console. This string representation details the types involved, the names of fields, and the value of interior members directly. It’s useful as a quick way to inspect what lives within a variable, but it isn’t much use beyond that.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Take care to ensure that <code>var_dump()</code> doesn’t make its way into production. This function does not escape data and could render unsanitized user input to your application’s output, introducing a serious security vulnerability.<sup><a data-type="noteref" id="idm45875142222400-marker" href="ch13.html#idm45875142222400">4</a></sup></p>
</div>

<p>More helpful is PHP’s <code>var_export()</code> function. By default, it also prints the contents of any variable passed in, except the output format is itself executable PHP code. The same <code>$info</code> object from the Solution example would print as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="p">(</code><code class="nx">object</code><code class="p">)</code> <code class="k">array</code><code class="p">(</code>
   <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Book Reader'</code><code class="p">,</code>
   <code class="s1">'profession'</code> <code class="o">=&gt;</code> <code class="s1">'PHP Developer'</code><code class="p">,</code>
   <code class="s1">'favorites'</code> <code class="o">=&gt;</code>
  <code class="k">array</code> <code class="p">(</code>
    <code class="mi">0</code> <code class="o">=&gt;</code> <code class="s1">'PHP'</code><code class="p">,</code>
    <code class="mi">1</code> <code class="o">=&gt;</code> <code class="s1">'MySQL'</code><code class="p">,</code>
    <code class="mi">2</code> <code class="o">=&gt;</code> <code class="s1">'Linux'</code><code class="p">,</code>
  <code class="p">),</code>
<code class="p">)</code></pre>

<p>Unlike <code>var_dump()</code>, <code>var_export()</code> accepts an optional second parameter that will instruct the function to <em>return</em> its output rather than print it to the screen. This results in a string literal that represents the contents of the variable being returned, which could then itself be stored elsewhere for future reference.</p>

<p>A third and final alternative is to use PHP’s <code>print_r()</code> function. Like both of the preceding functions, it produces a human-readable representation of the variable’s contents. As with <code>var_export()</code>, you can pass an optional second parameter to the variable to return its output rather than print it to the screen.</p>

<p>Unlike both of the preceding functions, though, not all typing information is exposed directly by <code>print_r()</code>. For example, the same <code>$info</code> object from the Solution example would print as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">stdClass</code> <code class="nx">Object</code>
<code class="p">(</code>
    <code class="p">[</code><code class="nx">name</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="nx">Book</code> <code class="nx">Reader</code>
    <code class="p">[</code><code class="nx">profession</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="nx">PHP</code> <code class="nx">Developer</code>
    <code class="p">[</code><code class="nx">favorites</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="k">Array</code>
        <code class="p">(</code>
            <code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="nx">PHP</code>
            <code class="p">[</code><code class="mi">1</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="nx">MySQL</code>
            <code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">=&gt;</code> <code class="nx">Linux</code>
        <code class="p">)</code>
<code class="p">)</code></pre>

<p>Each function displays a different amount of information pertaining to the variable in question. Which version works best for you depends on how exactly you intend to use the resulting information. In a debugging or logging context, the ability of <code>var_export()</code> and <code>print_r()</code> to return a string representation rather than printing directly to the console would be valuable, particularly when paired with a tool like Monolog as described in <a data-type="xref" href="#recipe_logging">Recipe 13.5</a>.</p>

<p>If you want to export variable contents in a way to easily reimport them into PHP directly, the executable output of <code>var_export()</code> would serve you best. If you’re debugging variable contents and need deep typing and size information, the default output of <code>var_dump()</code> might be the most informative, even if it can’t be directly exported as a string.</p>

<p>If you <em>do</em> need to leverage <code>var_dump()</code> and want to export its output as a string, you can leverage <a href="https://oreil.ly/2AUks">output buffering</a> in PHP to do just that. Specifically, create an output buffer prior to invoking <code>var_dump()</code>, then store the contents of that buffer in a variable for future use, as shown in <a data-type="xref" href="#output_buffering_capture">Example 13-8</a>.</p>
<div id="output_buffering_capture" data-type="example">
<h5><span class="label">Example 13-8. </span>Output buffering to capture variable contents</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nb">ob_start</code><code class="p">();</code><code> </code><a class="co" id="co_debugging_and_testing_CO2-1" href="#callout_debugging_and_testing_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
</code><code class="nb">var_dump</code><code class="p">(</code><code class="nv">$info</code><code class="p">);</code><code> </code><a class="co" id="co_debugging_and_testing_CO2-2" href="#callout_debugging_and_testing_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>

</code><code class="nv">$contents</code><code> </code><code class="o">=</code><code> </code><code class="nb">ob_get_clean</code><code class="p">();</code><code> </code><a class="co" id="co_debugging_and_testing_CO2-3" href="#callout_debugging_and_testing_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_debugging_and_testing_CO2-1" href="#co_debugging_and_testing_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Create an output buffer. Any code that prints to the console after this invocation will be captured by the buffer.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO2-2" href="#co_debugging_and_testing_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Dump the contents of the variable in question to the console/buffer.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO2-3" href="#co_debugging_and_testing_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Get the contents of the buffer and delete it afterwards.</p></dd>
</dl></div>

<p>The result of the preceding example code will be a string representation of the 
<span class="keep-together">dumped</span> contents of <code>$info</code> stored in <code>$contents</code> for future reference. Proceeding to dump the contents of <code>$contents</code> itself would yield the following:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nx">string</code><code class="p">(</code><code class="mi">244</code><code class="p">)</code> <code class="s2">"object(stdClass)#1 (3) {</code>
<code class="s2">  ["</code><code class="nx">name</code><code class="s2">"]=&gt;</code>
<code class="s2">  string(11) "</code><code class="nx">Book</code> <code class="nx">Reader</code><code class="s2">"</code>
<code class="s2">  ["</code><code class="nx">profession</code><code class="s2">"]=&gt;</code>
<code class="s2">  string(13) "</code><code class="nx">PHP</code> <code class="nx">Developer</code><code class="s2">"</code>
<code class="s2">  ["</code><code class="nx">favorites</code><code class="s2">"]=&gt;</code>
<code class="s2">  array(3) {</code>
<code class="s2">    [0]=&gt;</code>
<code class="s2">    string(3) "</code><code class="nx">PHP</code><code class="s2">"</code>
<code class="s2">    [1]=&gt;</code>
<code class="s2">    string(5) "</code><code class="nx">MySQL</code><code class="s2">"</code>
<code class="s2">    [2]=&gt;</code>
<code class="s2">    string(5) "</code><code class="nx">Linux</code><code class="s2">"</code>
<code class="s2">  }</code>
<code class="s2">}</code>
<code class="s2">"</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875141875840">
<h2>See Also</h2>

<p>Documentation <a data-type="indexterm" data-primary="variables" data-secondary="complex, contents" data-startref="vrbmpx" id="idm45875141911200"></a><a data-type="indexterm" data-primary="complex variables, contents" data-startref="cpxvbltt" id="idm45875141909952"></a><a data-type="indexterm" data-primary="variables" data-secondary="contents as strings" data-startref="vbttsgs" id="idm45875141909040"></a><a data-type="indexterm" data-primary="strings" data-secondary="variable contents as" data-startref="stgvtts" id="idm45875141907824"></a><a data-type="indexterm" data-primary="var_dump() function" data-startref="vdmpf" id="idm45875141906608"></a><a data-type="indexterm" data-primary="functions" data-secondary="var_dump()" data-startref="vcvdp" id="idm45875141905664"></a>on <a href="https://oreil.ly/uYuoV"><code>var_dump()</code></a>, <a href="https://oreil.ly/V_vZ-"><code>var_export()</code></a>, and <a href="https://oreil.ly/0D891"><code>print_r()</code></a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.7 Using the Built-in Web Server to Quickly Run 
an Application"><div class="sect1" id="idm45875141901648">
<h1>13.7 Using the Built-in Web Server to Quickly Run 
<span class="keep-together">an Application</span></h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875141859504">
<h2>Problem</h2>

<p>You want to launch a web application <a data-type="indexterm" data-primary="web applications, launching localling" id="wbpplcc"></a><a data-type="indexterm" data-primary="web server, built-in" id="wbsvbt"></a><a data-type="indexterm" data-primary="testing" data-secondary="built-in web server and" id="ttsbwvs"></a><a data-type="indexterm" data-primary="debugging" data-secondary="built-in web server and" id="dbggwsv"></a>locally without configuring an actual web server like Apache or NGINX.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875141853472">
<h2>Solution</h2>

<p>Use PHP’s built-in web server to quickly launch a script such that it is accessible from a web browser. For example, if your application lives in a <em>public_html/</em> directory, launch the web server from that directory as follows:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code><code class="nb">cd</code><code class="w"> </code>~/public_html<code class="w"></code>
$<code class="w"> </code>php<code class="w"> </code>-S<code class="w"> </code>localhost:8000<code class="w"></code></pre>

<p>Then visit <em>http://localhost:8000</em> in your browser to view any file (static HTML, images, or even executable PHP) that resides within that directory.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875141847200">
<h2>Discussion</h2>

<p>The PHP CLI provides a built-in web server that makes it easy to test or demonstrate applications or scripts in a controlled, local environment. The CLI supports both running PHP scripts and returning static content from the request path.</p>

<p>Static content could include rendered HTML files or anything from the following standard MIME types/extensions:</p>

<pre data-type="programlisting" data-code-language="text">.3gp, .apk, .avi, .bmp, .css, .csv, .doc, .docx, .flac, .gif, .gz, .gzip, .htm,
.html, .ics, .jpe, .jpeg, .jpg, .js, .kml, .kmz, .m4a, .mov, .mp3, .mp4, .mpeg,
.mpg, .odp, .ods, .odt, .oga, .ogg, .ogv, .pdf, .png, .pps, .pptx, .qt, .svg,
.swf, .tar, .text, .tif, .txt, .wav, .webm, .wmv, .xls, .xlsx, .xml, .xsl, .xsd,
and .zip.</pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The built-in web server is intended for development and debugging purposes. It should not be used in a production context. For production purposes, always leverage a fully fledged web server in front of PHP. Either NGINX or Apache in front of PHP-FPM are reasonable choices.</p>
</div>

<p>In addition, you can pass a particular script as a <em>router script</em> to the web server, resulting in PHP directing every request to that script. The advantage to such an approach is that it mimics the use of popular PHP frameworks that utilize routers. The disadvantage is that you need to manually handle routing for static assets.</p>

<p>In an Apache or NGINX environment, browser requests for images, documents, or other static content are served directly without invoking PHP. When leveraging the CLI web server, you must first check for these assets and return an explicit <code>false</code> in order for the development server to handle them properly.</p>

<p>A framework router script must then check to see if you’re running in CLI mode and, if so, route content accordingly. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">if</code> <code class="p">(</code><code class="nb">php_sapi_name</code><code class="p">()</code> <code class="o">===</code> <code class="s1">'cli-server'</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nb">preg_match</code><code class="p">(</code><code class="s1">'/\.(?:png|jpg|jpeg|gif)$/'</code><code class="p">,</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s2">"REQUEST_URI"</code><code class="p">]))</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">false</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code>

<code class="c1">// Continue router execution</code></pre>

<p>The preceding <em>router.php</em> file could then be used to bootstrap a local web server as follows:</p>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>php<code class="w"> </code>-S<code class="w"> </code>localhost:8000<code class="w"> </code>router.php<code class="w"></code></pre>

<p>The development web server could be made accessible to any interface (available on the local network) by passing <code>0.0.0.0</code> instead of <code>localhost</code> when invoking it. However, remember that this server is not designed for production use and is not structured in a way to protect <a data-type="indexterm" data-primary="web applications, launching localling" data-startref="wbpplcc" id="idm45875141760944"></a><a data-type="indexterm" data-primary="web server, built-in" data-startref="wbsvbt" id="idm45875141760176"></a><a data-type="indexterm" data-primary="testing" data-secondary="built-in web server and" data-startref="ttsbwvs" id="idm45875141759232"></a><a data-type="indexterm" data-primary="debugging" data-secondary="built-in web server and" data-startref="dbggwsv" id="idm45875141758016"></a>your application from abuse by bad actors. <em>Do not use this web server on a public network!</em></p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875141846608">
<h2>See Also</h2>

<p>Documentation on PHP’s <a href="https://oreil.ly/Hm9U7">built-in web server</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="13.8 Using Unit Tests to Detect Regressions in a 
Version-Controlled Project with git-bisect"><div class="sect1" id="idm45875141724560">
<h1>13.8 Using Unit Tests to Detect Regressions in a 
<span class="keep-together">Version-Controlled</span> Project with git-bisect</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875141722592">
<h2>Problem</h2>

<p>You want to quickly identify which <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="regressions, git-bisect and" id="tstutgvcr"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="regressions, git-bisect and" id="uttgvtrl"></a><a data-type="indexterm" data-primary="regressions, git-bisect and" id="rgrgbs"></a><a data-type="indexterm" data-primary="git-bisect" id="gtbsct"></a>commit in a version-controlled application introduced a particular bug so you can fix it.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875141700000">
<h2>Solution</h2>

<p>Use <code>git bisect</code> to track down the first bad commit in your source tree, as follows:</p>
<ol>
<li>
<p>Create a new branch on the project.</p>
</li>
<li>
<p>Write a failing unit test (a test that reproduces the bug currently but, if the bug were fixed, it would pass).</p>
</li>
<li>
<p>Commit that test to the new branch.</p>
</li>
<li>
<p>Leverage <code>git rebase</code> to move that commit that introduces your new test to an earlier point in the project’s history.</p>
</li>
<li>
<p>Use <code>git bisect</code> from that earlier point in history to automatically run your unit tests on subsequent commits to find the first commit where the test failed.</p>
</li>

</ol>

<p>Once you rebase your project’s commit history, the hashes of all of your commits will change. Keep track of the <em>new</em> commit hash for your unit test so you can properly target <code>git bisect.</code> For example, assume this commit has a hash of <code>48cc8f0</code> after being moved in your commit history. In that case, as shown in <a data-type="xref" href="#git-bisect-navigation">Example 13-9</a>, you would identify this commit as “good” and the <code>HEAD</code> (the latest commit) in the project as “bad.”</p>
<div id="git-bisect-navigation" data-type="example">
<h5><span class="label">Example 13-9. </span>Example <code>git bisect</code> navigation after rebasing a test case</h5>

<pre data-type="programlisting" data-code-language="sh"><code>$</code><code class="w"> </code><code>git</code><code class="w"> </code><code>bisect</code><code class="w"> </code><code>start</code><code class="w">
</code><code>$</code><code class="w"> </code><code>git</code><code class="w"> </code><code>bisect</code><code class="w"> </code><code>good</code><code class="w"> </code><code>48cc8f0</code><code class="w"> </code><a class="co" id="co_debugging_and_testing_CO3-1" href="#callout_debugging_and_testing_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code class="w">
</code><code>$</code><code class="w"> </code><code>git</code><code class="w"> </code><code>bisect</code><code class="w"> </code><code>bad</code><code class="w"> </code><code>HEAD</code><code class="w"> </code><a class="co" id="co_debugging_and_testing_CO3-2" href="#callout_debugging_and_testing_CO3-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code class="w">
</code><code>$</code><code class="w"> </code><code>git</code><code class="w"> </code><code>bisect</code><code class="w"> </code><code>run</code><code class="w"> </code><code>vendor/bin/phpunit</code><code class="w"> </code><a class="co" id="co_debugging_and_testing_CO3-3" href="#callout_debugging_and_testing_CO3-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_debugging_and_testing_CO3-1" href="#co_debugging_and_testing_CO3-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>You must tell Git the first good commit it needs to look at.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO3-2" href="#co_debugging_and_testing_CO3-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Since you don’t know for sure where the broken commit is, pass the <code>HEAD</code> constant and Git will look at every commit after the good one referenced earlier.</p></dd>
<dt><a class="co" id="callout_debugging_and_testing_CO3-3" href="#co_debugging_and_testing_CO3-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Git can run a specific command for every suspect commit. In this case, run your test suite. Git will continue looking at your project commit history until it finds the first commit where the test suite fails.</p></dd>
</dl></div>

<p>Once Git has identified the first bad commit (e.g., <code>16c43d7</code>), use <code>git diff</code> to see what actually changed at that commit, as shown in <a data-type="xref" href="#comparing_known_bad_git">Example 13-10</a>.</p>
<div id="comparing_known_bad_git" data-type="example">
<h5><span class="label">Example 13-10. </span>Comparing a known-bad Git commit</h5>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>git<code class="w"> </code>diff<code class="w"> </code>16c43d7<code class="w"> </code>HEAD<code class="w"></code></pre></div>

<p>Once you know what’s broken, run <code>git bisect reset</code> to return your repository to normal operations. At this point, move back to your main branch (and possibly delete the test branch as well) so you can begin correcting the identified bug.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875148531152">
<h2>Discussion</h2>

<p>Git’s bisect tool is a powerful way to track down and identify a bad commit to your project. It’s particularly useful on larger, active projects where there might be several commits between a known-good and known-bad state. With larger projects, it’s often cost prohibitive in terms of developer time to iterate through every commit to test its validity on an individual basis.</p>

<p>The <code>git bisect</code> command works with a binary search approach. It finds the commit at the midpoint between the known-good and known-bad ones and tests that commit. It then moves closer to the known-good or the known-bad commits based on the output of that test.</p>

<p>By default, <code>git bisect</code> expects you to manually test each suspect commit until it finds the “first bad” commit. However, the <code>git bisect run</code> subcommand empowers you to delegate this check to an automated system like PHPUnit. If the test command returns a default status of <code>0</code> (or success), the commit is assumed to be good. This works well because PHPUnit exits with an error code of <code>0</code> when all tests pass.</p>

<p>If the tests fail, PHPUnit returns an error code of <code>1</code>, which <code>git bisect</code> interprets as a bad commit. In this way, you can fully automate the detection of a bad commit over thousands of potential commits quickly and easily.</p>

<p>In the Solution example, you first created a new branch. This is merely to keep your project clean so you can throw any potential test commits away once you’ve identified the bad commit. On this branch, you committed a single test to replicate a bug identified in your project. Leveraging <code>git log</code>, you can quickly visualize the history of your project, including this test commit, as shown in <a data-type="xref" href="#git_bisect_log">Figure 13-3</a>.</p>

<figure><div id="git_bisect_log" class="figure">
<img src="assets/phpc_1303.png" alt="Git log demonstrating a main branch and a testing branch with a single commit" width="600" height="199"/>
<h6><span class="label">Figure 13-3. </span>Git log demonstrating a main branch and a testing branch with a single commit</h6>
</div></figure>

<p>This log is useful as it provides you with the short hash for both your test commit and every other commit in the project. If you know a historical commit that is known to be good, you can rebase your project to move the test commit to <em>just after</em> that known commit.</p>

<p>In <a data-type="xref" href="#git_bisect_log">Figure 13-3</a>, the test commit hash is <code>d442759</code>, and the last known “good” commit is <code>916161c</code>. To reorder your project, use <code>git rebase</code> interactively from the project’s initial commit (<code>8550717</code>) to move the test commit earlier in the project. The exact command would start as shown in <a data-type="xref" href="#interactive_git_rebase">Example 13-11</a>.</p>
<div id="interactive_git_rebase" data-type="example">
<h5><span class="label">Example 13-11. </span>Interactive <code>git rebase</code> to reorder commits</h5>

<pre data-type="programlisting" data-code-language="sh">$<code class="w"> </code>git<code class="w"> </code>rebase<code class="w"> </code>-i<code class="w"> </code><code class="m">8550717</code><code class="w"></code></pre></div>

<p>Git will open a text editor and present the same SHA hashes for each possible commit. You want to retain your commit history (so keep the <code>pick</code> keywords in place), but move the test commit to just after the known-good commit, as shown in <a data-type="xref" href="#git_rebase_interactive">Figure 13-4</a>.</p>

<figure><div id="git_rebase_interactive" class="figure">
<img src="assets/phpc_1304.png" alt="Interactive Git rebasing allows for modifying or reordering commits at will" width="600" height="433"/>
<h6><span class="label">Figure 13-4. </span>Interactive Git rebasing allows for modifying or reordering commits at will</h6>
</div></figure>

<p>Save the file, and Git will work at reconstructing your project history based on the moved commit. If and when there are conflicts, reconcile them locally first and commit the results. Then leverage <code>git rebase --continue</code> to keep moving. Once you’re done, your project will be restructured such that the new test case appears immediately after the known-good commit.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The known-good commit will have the same commit hash, as will any commits that came before it. Your moved commit and all the ones that follow, however, will have new commit hashes applied. Take care to ensure that you’re using the correct commit hashes in any subsequent Git commands!</p>
</div>

<p>Once the rebase is complete, use <code>git log --oneline</code> to again visualize your commit history and reference the <em>new</em> commit attributed to your unit test. Then you can run <code>git bisect</code> from that commit to the <code>HEAD</code> of your project as you did in <a data-type="xref" href="#git-bisect-navigation">Example 13-9</a>. Git will run PHPunit on each suspect commit until it finds the first “bad” commit, producing output similar to that in <a data-type="xref" href="#git_bisect_run">Figure 13-5</a>.</p>

<figure><div id="git_bisect_run" class="figure">
<img src="assets/phpc_1305.png" alt="Git bisect runs until it finds the first 'bad' commit in the tree" width="600" height="433"/>
<h6><span class="label">Figure 13-5. </span>Git bisect runs until it finds the first “bad” commit in the tree</h6>
</div></figure>

<p>Armed with knowledge of the first bad commit, you can view the diff at that point and see exactly where and how the bug crept into your project. At this point, return to the main branch and start prepping your fixes.</p>

<p>It’s a good idea to pull in your new unit test as well.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>While you could leverage <code>git rebase</code> again to move your test commit back to where it belongs, the rebase operation might still leave your project history modified from its former state. Instead, return to <code>main</code> and create a <em>new</em> branch for actually fixing the bug at that <a data-type="indexterm" data-primary="testing" data-secondary="unit testing" data-tertiary="regressions, git-bisect and" data-startref="tstutgvcr" id="idm45875141598928"></a><a data-type="indexterm" data-primary="unit testing" data-secondary="regressions, git-bisect and" data-startref="uttgvtrl" id="idm45875141568864"></a><a data-type="indexterm" data-primary="regressions, git-bisect and" data-startref="rgrgbs" id="idm45875141567776"></a><a data-type="indexterm" data-primary="git-bisect" data-startref="gtbsct" id="idm45875141566928"></a>point. Pull in your test commit (perhaps via <a href="https://oreil.ly/tTFx3"><code>git cherry-pick</code></a>) and make whatever changes are 
<span class="keep-together">necessary</span>.</p>
</div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875142714608">
<h2>See Also</h2>

<p>Documentation on <a href="https://oreil.ly/LXgBP"><code>git bisect</code></a>.</p>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45875143879696"><sup><a href="ch13.html#idm45875143879696-marker">1</a></sup> For more on error handling, review <a data-type="xref" href="ch12.html#chapter_errors">Chapter 12</a>.</p><p data-type="footnote" id="idm45875143583840"><sup><a href="ch13.html#idm45875143583840-marker">2</a></sup> For more on Composer, see <a data-type="xref" href="ch15.html#composer_definition">Recipe 15.1</a>.</p><p data-type="footnote" id="idm45875142846176"><sup><a href="ch13.html#idm45875142846176-marker">3</a></sup> Strict typing is discussed at length in <a data-type="xref" href="ch03.html#argument_and_return_typing">Recipe 3.4</a>.</p><p data-type="footnote" id="idm45875142222400"><sup><a href="ch13.html#idm45875142222400-marker">4</a></sup> For more on data sanitization, see <a data-type="xref" href="ch09.html#recipe_sanitize_input">Recipe 9.1</a>.</p></div></div></section></div>
</div>
</body>
</html>