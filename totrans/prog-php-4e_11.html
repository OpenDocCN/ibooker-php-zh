<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Graphics"><div class="chapter" id="graphic">
<h1><span class="label">Chapter 10. </span>Graphics</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" id="ix_graphics_ch10"/>The web is much more visual than textual; that is obvious. Images appear in the form of logos, buttons, photographs, charts, advertisements, and icons. Many of these images are static and never change, built with tools such as Photoshop. But many are dynamically created—from advertisements for Amazon’s referral program that include your name to graphs of stock performance.</p>
<p>PHP supports graphics creation with the built-in <a contenteditable="false" data-type="indexterm" data-primary="GD extension" id="idm45922761849784"/>GD extension library. In this chapter, we’ll show you how to generate images dynamically within PHP.</p>
<section data-type="sect1" data-pdf-bookmark="Embedding an Image in a Page"><div class="sect1" id="embedding_an_image_in_a_page">
<h1>Embedding an Image in a Page</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="web pages" data-secondary="embedding graphics in" id="ix_webpage_graphicsin"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="embedding in a page" id="ix_graphics_embedding"/>A common misconception is that there is a mixture of text and graphics flowing across a single HTTP request. After all, when you view a page, you see a single page containing such a mixture. <a contenteditable="false" data-type="indexterm" data-primary="HTTP (HyperText Transfer Protocol)" data-secondary="server information" id="idm45922762123656"/>It is important to understand that a standard web page containing text and graphics is created through a series of HTTP requests from the web browser; each request is answered by a response from the web server. Each response can contain one and only one type of data, and each image requires a separate HTTP request and web server response. Thus, if you see a page that contains some text and two images, you know that it has taken three HTTP requests and corresponding responses to construct this page.</p>
<p>Take this HTML page, for example:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Example Page<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 This page contains two images.
 <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image1.png"</code> <code class="na">alt=</code><code class="s">"Image 1"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image2.png"</code> <code class="na">alt=</code><code class="s">"Image 2"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
<p>The series of requests sent by the web browser for this page looks something like this:</p>
<pre data-type="programlisting">GET /page.html HTTP/1.0
GET /image1.png HTTP/1.0
GET /image2.png HTTP/1.0</pre>
<p>The web server sends back a response to each of these requests. The <code>Content-Type</code> headers in these responses look like this:</p>
<pre data-type="programlisting">Content-Type: text/html
Content-Type: image/png
Content-Type: image/png</pre>
<p>To embed a PHP-generated image in an HTML page, pretend that the PHP script that generates the image is actually the image. Thus, if we have <em>image1.php</em> and <em>image2.php</em> scripts that create images, we can modify the previous HTML to look like this (the image names are PHP extensions now):</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Example Page<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 This page contains two images.
 <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image1.php"</code> <code class="na">alt=</code><code class="s">"Image 1"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image2.php"</code> <code class="na">alt=</code><code class="s">"Image 2"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
<p>Instead of referring to real images on your web server, the <code>&lt;img&gt;</code> tags now refer to the PHP scripts that generate and return image data.</p>
<p>Furthermore, you can pass variables to these scripts, so instead of having separate scripts to generate each image, you could write your <code>&lt;img&gt;</code> tags like this:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_embedding" id="idm45922762084504"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_webpage_graphicsin" id="idm45922762083160"/></p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image.php?num=1"</code> <code class="na">alt=</code><code class="s">"Image 1"</code> <code class="nt">/&gt;</code>
<code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"image.php?num=2"</code> <code class="na">alt=</code><code class="s">"Image 2"</code> <code class="nt">/&gt;</code></pre>
<p>Then, inside the called PHP file <em>image.php</em>, you can access the request parameter <code>$_GET['num']</code> to generate the appropriate image.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Basic Graphics Concepts"><div class="sect1" id="basic_graphics_concepts">
<h1>Basic Graphics Concepts</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="basics" id="idm45922762035320"/>An <em>image</em> is a rectangle of pixels of various colors. Colors are identified by their position in the <a contenteditable="false" data-type="indexterm" data-primary="colors" data-secondary="images" id="idm45922762033032"/><a contenteditable="false" data-type="indexterm" data-primary="color palette" id="idm45922762031656"/><em>palette</em>, an array of colors. Each entry in the palette has three separate color values—one each for red, green, and blue. Each value ranges from <code>0</code> (color not present) to <code>255</code> (color at full intensity). This is known as its <a contenteditable="false" data-type="indexterm" data-primary="RGB value, defined" id="idm45922761956264"/><em>RGB value</em>. There are also hexadecimal, or “hex” values—alphanumeric representations of colors that are commonly used in HTML. Some image tools, such as <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="ColorPic" id="idm45922761954584"/><a href="https://oreil.ly/F-Z3e">ColorPic</a>, will convert RGB values to hex for you.</p>
<p>Image files are rarely a straightforward dump of the pixels and the palette. Instead, various <a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="file formats for" id="idm45922761952056"/><em>file formats</em> (GIF, JPEG, PNG, etc.) have been created that attempt to compress the data somewhat to make smaller files.</p>
<p>Different file formats handle image <a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="transparency of" id="idm45922761949720"/><a contenteditable="false" data-type="indexterm" data-primary="transparency of graphics" id="idm45922761948344"/><em>transparency</em>, which controls whether and how the background shows through the image, in different ways. Some, such as PNG, support an <a contenteditable="false" data-type="indexterm" data-primary="alpha channel" id="idm45922761946712"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="alpha channel" id="idm45922761945608"/><em>alpha channel</em>, an extra value for every pixel reflecting the transparency at that point. Others, such as GIF, simply designate one entry in the palette as indicating transparency. Still others, like JPEG, don’t support transparency at all.</p>
<p>Rough and jagged edges, an effect known as <em>aliasing</em>, can make for unappealing images. <a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="antialiasing for" id="idm45922761942680"/><a contenteditable="false" data-type="indexterm" data-primary="antialiasing" id="idm45922761992248"/><em>Antialiasing</em> involves moving or recoloring pixels at the edge of a shape to transition more gradually between the shape and its background. Some functions that draw on an image implement antialiasing.</p>
<p>With 256 possible values for each of red, green, and blue, there are 16,777,216 possible colors for each pixel. Some file formats limit the number of colors you can have in a palette (e.g., GIF supports no more than 256 colors); others let you have as many colors as you need. The latter are known as <a contenteditable="false" data-type="indexterm" data-primary="true color indexes" id="idm45922761989784"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="true color indexes for" id="idm45922761988680"/><em>true color</em> formats, because 24-bit color (8 bits each for red, green, and blue) gives more hues than the human eye can <span class="keep-together">distinguish.</span></p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Creating and Drawing Images"><div class="sect1" id="creating_and_drawing_images">
<h1>Creating and Drawing Images</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="creating and drawing" id="ix_graphics_creating_ch10"/>For now, let’s start with the simplest possible GD example. <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a> is a script that generates a black-filled square. The code works with any version of GD that supports the PNG image format.</p>
<div data-type="example" id="example_onezero_onedot_a_black_square_o">
<h5><span class="label">Example 10-1. </span>A black square on a white background (black.php)</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>

<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>
<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a> illustrates the basic steps in generating any image: creating the image, allocating colors, drawing the image, and then saving or sending the image. <a data-type="xref" href="#a_black_square_on_a_white_background">Figure 10-1</a> shows the output of <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a>.</p>
<figure><div id="a_black_square_on_a_white_background" class="figure">
<img src="Images/php4_1001.png" alt="A black square on a white background" width="331" height="348"/>
<h6><span class="label">Figure 10-1. </span>A black square on a white background</h6>
</div></figure>
<p>To see the result, simply point your browser at the <em>black.php</em> page. To embed this image in a web page, use:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"black.php"</code> <code class="nt">/&gt;</code></pre>
<section data-type="sect2" data-pdf-bookmark="The Structure of a Graphics Program"><div class="sect2" id="the_structure_of_a_graphics_program">
<h2>The Structure of a Graphics Program</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="structure of a program" id="idm45922761749624"/>Most dynamic image-generation programs follow the same basic steps outlined in <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a>.</p>
<p>You can create a 256-color image with the <a contenteditable="false" data-type="indexterm" data-primary="imagecreate function" id="idm45922761746744"/><code>imagecreate()</code> function, which returns an image handle:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreate</code><code class="p">(</code><em><code class="nx">width</code></em><code class="p">,</code><code> </code><em><code class="nx">height</code></em><code class="p">);</code></pre>
<p>All colors used in an image must be allocated with the <a contenteditable="false" data-type="indexterm" data-primary="imagecolorallocate function" id="idm45922761720456"/><code>imagecolorallocate()</code> function. The first color allocated becomes the background color for the image:<sup><a data-type="noteref" id="ch10fn1-marker" href="ch10.xhtml#ch10fn1">1</a></sup></p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$color</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorallocate</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">red</code></em><code class="p">,</code><code> </code><em><code class="nx">green</code></em><code class="p">,</code><code> </code><em><code class="nx">blue</code></em><code class="p">);</code></pre>
<p>The arguments are the numeric RGB (red, green, blue) components of the color. In <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a>, we wrote the color values in hexadecimal to bring the function call closer to the HTML color representation <code>#FFFFFF</code> and <code>#000000</code>.</p>
<p>There are many drawing primitives in GD. <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a> uses <a contenteditable="false" data-type="indexterm" data-primary="imagefilledrectangle function" id="idm45922761676728"/><code>imagefilledrectangle()</code>, in which you specify the dimensions of the rectangle by passing the coordinates of the top-left and bottom-right corners:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagefilledrectangle</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">tlx</code></em><code class="p">,</code><code> </code><em><code class="nx">tly</code></em><code class="p">,</code><code> </code><em><code class="nx">brx</code></em><code class="p">,</code><code> </code><em><code class="nx">bry</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>The next step is to send a <a contenteditable="false" data-type="indexterm" data-primary="Content-Type header" id="idm45922761635656"/><code>Content-Type</code> header to the browser with the appropriate content type for the kind of image being created. Once that is done, we call the appropriate output function. The <a contenteditable="false" data-type="indexterm" data-primary="imagejpg function" id="idm45922761634168"/><code>imagejpeg()</code>, <a contenteditable="false" data-type="indexterm" data-primary="imagegif function" id="idm45922761632648"/><code>imagegif()</code>, <a contenteditable="false" data-type="indexterm" data-primary="imagepng function" id="idm45922761631096"/><code>imagepng()</code>, and <a contenteditable="false" data-type="indexterm" data-primary="imagewbmp function" id="idm45922761629544"/><code>imagewbmp()</code> functions create GIF, JPEG, PNG, and WBMP files from the image, respectively:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagegif</code><code class="p">(</code><em><code class="nx">image</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">filename</code></em><code> </code><code class="p">]);</code><code>
</code><code class="nb">imagejpeg</code><code class="p">(</code><em><code class="nx">image</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">filename</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">quality</code></em><code> </code><code class="p">]]);</code><code>
</code><code class="nb">imagepng</code><code class="p">(</code><em><code class="nx">image</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">filename</code></em><code> </code><code class="p">]);</code><code>
</code><code class="nb">imagewbmp</code><code class="p">(</code><em><code class="nx">image</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">filename</code></em><code> </code><code class="p">]);</code></pre>
<p>If no <em>filename</em> is given, the image is output to the browser; otherwise, it creates (or overwrites) the image to the given file path. The <em>quality</em> argument for JPEGs is a value from <code>0</code> (worst-looking) to <code>100</code> (best-looking). The lower the quality, the smaller the JPEG file. The default setting is <code>75</code>.</p>
<p>In <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a>, we set the HTTP header immediately before calling the output-generating function <code>imagepng()</code>. If you set the <code>Content-Type</code> at the very start of the script, any errors that are generated are treated as image data and the browser displays a broken image icon. <a data-type="xref" href="#content_type_values_for_image_formats">Table 10-1</a> lists the image formats and their <code>Content-Type</code> values.</p>
<table class="border" id="content_type_values_for_image_formats">
<caption><span class="label">Table 10-1. </span>Content-Type values for image formats</caption>
<thead>
<tr>
<th>Format</th>
<th><code>Content-Type</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>GIF</td>
<td><code>image/gif</code></td>
</tr>
<tr>
<td>JPEG</td>
<td><code>image/jpeg</code></td>
</tr>
<tr>
<td>PNG</td>
<td><code>image/png</code></td>
</tr>
<tr>
<td>WBMP</td>
<td><code>image/vnd.wap.wbmp</code></td>
</tr>
</tbody>
</table>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Changing the Output Format"><div class="sect2" id="changing_the_output_format">
<h2>Changing the Output Format</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="file formats for" id="ix_graphics_fileformats"/>As you may have deduced, generating an image stream of a different type requires only two changes to the script: send a different <code>Content-Type</code> and use a different image-generating function. <a data-type="xref" href="#example_onezero_twodot_jpeg_version_of">Example 10-2</a> shows <a data-type="xref" href="#example_onezero_onedot_a_black_square_o">Example 10-1</a> modified to generate a JPEG instead of a PNG image.</p>
<div data-type="example" id="example_onezero_twodot_jpeg_version_of">
<h5><span class="label">Example 10-2. </span>JPEG version of the black square</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>

<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/jpeg"</code><code class="p">);</code>
<code class="nb">imagejpeg</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Testing for Supported Image Formats"><div class="sect2" id="testing_for_supported_image_formats">
<h2>Testing for Supported Image Formats</h2>
<p>If you are writing code that must be portable across systems that may support different image formats, use the <a contenteditable="false" data-type="indexterm" data-primary="imagetypes function" id="idm45922761442872"/><code>imagetypes()</code> function to check which image types are supported. This function returns a bit field; you can use the bitwise AND operator (<code>&amp;</code>) to check if a given bit is set. The constants <code>IMG_GIF</code>, <code>IMG_JPG</code>, <code>IMG_PNG</code>, and <code>IMG_WBMP</code> correspond to the bits for those image formats.</p>
<p><a data-type="xref" href="#example_onezero_threedot_checking_for_i">Example 10-3</a> generates PNG files if PNG is supported, JPEG files if PNG is not supported, and GIF files if neither PNG nor JPEG is supported.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_fileformats" id="idm45922761437640"/></p>
<div data-type="example" id="example_onezero_threedot_checking_for_i">
<h5><span class="label">Example 10-3. </span>Checking for image format support</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>

<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">imagetypes</code><code class="p">()</code> <code class="o">&amp;</code> <code class="nx">IMG_PNG</code><code class="p">)</code> <code class="p">{</code>
 <code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
 <code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code>
<code class="p">}</code>
<code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nb">imagetypes</code><code class="p">()</code> <code class="o">&amp;</code> <code class="nx">IMG_JPG</code><code class="p">)</code> <code class="p">{</code>
 <code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/jpeg"</code><code class="p">);</code>
 <code class="nb">imagejpeg</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code>
<code class="p">}</code>
<code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nb">imagetypes</code><code class="p">()</code> <code class="o">&amp;</code> <code class="nx">IMG_GIF</code><code class="p">)</code> <code class="p">{</code>
 <code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/gif"</code><code class="p">);</code>
 <code class="nb">imagegif</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code>
<code class="p">}</code></pre>
</div>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Reading an Existing File"><div class="sect2" id="reading_an_existing_file">
<h2>Reading an Existing File</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="reading existing graphics files" id="idm45922761432200"/>If you want to start with an existing image and then modify it, use <a contenteditable="false" data-type="indexterm" data-primary="imagetypes function" id="idm45922761330440"/><code>imagecreatefromgif()</code>, <a contenteditable="false" data-type="indexterm" data-primary="imagecreatefromjpeg function" id="idm45922761328920"/><code>imagecreatefromjpeg()</code>, or <a contenteditable="false" data-type="indexterm" data-primary="imagecreatefrompng function" id="idm45922761327352"/><code>imagecreatefrompng()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreatefromgif</code><code class="p">(</code><em><code class="nx">filename</code></em><code class="p">);</code><code>
</code><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreatefromjpeg</code><code class="p">(</code><em><code class="nx">filename</code></em><code class="p">);</code><code>
</code><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreatefrompng</code><code class="p">(</code><em><code class="nx">filename</code></em><code class="p">);</code></pre>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Basic Drawing Functions"><div class="sect2" id="basic_drawing_functions">
<h2>Basic Drawing Functions</h2>
<p>GD has functions for drawing basic points, lines, arcs, rectangles, and polygons. This section describes the base functions supported by GD 2.x.</p>
<p>The most basic function is <a contenteditable="false" data-type="indexterm" data-primary="imagesetpixel function" id="idm45922761304392"/><code>imagesetpixel()</code>, which sets the color of a specified pixel:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagesetpixel</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>There are two functions for drawing lines, <a contenteditable="false" data-type="indexterm" data-primary="imageline function" id="idm45922761211272"/><code>imageline()</code> and <a contenteditable="false" data-type="indexterm" data-primary="imagedashedline function" id="idm45922761209960"/><code>imagedashedline()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imageline</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">start_x</code></em><code class="p">,</code><code> </code><em><code class="nx">start_</code><code> </code><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">end_x</code></em><code class="p">,</code><code> </code><em><code class="nx">end_</code><code> </code><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code><code>
</code><code class="nb">imagedashedline</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">start_x</code></em><code class="p">,</code><code> </code><em><code class="nx">start_</code><code> </code><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">end_x</code></em><code class="p">,</code><code> </code><em><code class="nx">end_</code><code> </code><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p><a contenteditable="false" data-type="indexterm" data-primary="imagefilledrectangle function" id="idm45922761135720"/><a contenteditable="false" data-type="indexterm" data-primary="imagerectangle function" id="idm45922761134744"/>There are two functions for drawing rectangles, one that simply draws the outline and one that fills the rectangle with the specified color:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagerectangle</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">tlx</code></em><code class="p">,</code><code> </code><em><code class="nx">tly</code></em><code class="p">,</code><code> </code><em><code class="nx">brx</code></em><code class="p">,</code><code> </code><em><code class="nx">bry</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code><code>
</code><code class="nb">imagefilledrectangle</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">tlx</code></em><code class="p">,</code><code> </code><em><code class="nx">tly</code></em><code class="p">,</code><code> </code><em><code class="nx">brx</code></em><code class="p">,</code><code> </code><em><code class="nx">bry</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>Specify the location and size of the rectangle by passing the coordinates of the top-left and bottom-right corners.</p>
<p>You can draw arbitrary polygons with the <a contenteditable="false" data-type="indexterm" data-primary="imagepolygon function" id="idm45922761073944"/><code>imagepolygon()</code> and <a contenteditable="false" data-type="indexterm" data-primary="imagefilledpolygon function" id="idm45922761082376"/><code>imagefilled</code>​<span class="keep-together"><code>polygon()</code></span> functions:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagepolygon</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">points</code></em><code class="p">,</code><code> </code><em><code class="nx">number</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code><code>
</code><code class="nb">imagefilledpolygon</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">points</code></em><code class="p">,</code><code> </code><em><code class="nx">number</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>Both functions take an array of points. This array has two integers (the <em>x</em> and <em>y</em> coordinates) for each vertex on the polygon. The <em>number</em> argument is the number of vertices in the array (typically <code>count($points)/2</code>).</p>
<p>The <a contenteditable="false" data-type="indexterm" data-primary="imagearc function" id="idm45922761003480"/><code>imagearc()</code> function draws an arc (a portion of an ellipse):</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagearc</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">center_x</code></em><code class="p">,</code><code> </code><em><code class="nx">center_y</code></em><code class="p">,</code><code> </code><em><code class="nx">width</code></em><code class="p">,</code><code> </code><em><code class="nx">height</code></em><code class="p">,</code><code> </code><em><code class="nx">start</code></em><code class="p">,</code><code> </code><em><code class="nb">end</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>The ellipse is defined by its center, width, and height (height and width are the same for a circle). The start and end points of the arc are given as degrees counting counterclockwise from 3 o’clock. Draw the full ellipse with a <em>start</em> of <code>0</code> and an <em>end</em> of <code>360</code>.</p>
<p>There are two ways to fill in already-drawn shapes. The <a contenteditable="false" data-type="indexterm" data-primary="imagefill function" id="idm45922760963480"/><code>imagefill()</code> function performs a flood fill, changing the color of the pixels starting at the given location. Any change in pixel color marks the limits of the fill. The <a contenteditable="false" data-type="indexterm" data-primary="imagefilltoborder function" id="idm45922760961896"/><code>imagefilltoborder()</code> function lets you pass the particular color of the limits of the fill:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagefill</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code><code>
</code><code class="nb">imagefilltoborder</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">border_color</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<p>Another thing that you may want to do with your images is rotate them. This could be helpful if you are trying to create a web-style brochure, for example. The <a contenteditable="false" data-type="indexterm" data-primary="imagerotate function" id="idm45922760903736"/><code>image</code><span class="keep-together"><code>rotate()</code></span> function allows you to rotate an image by an arbitrary angle:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagerotate</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">angle</code></em><code class="p">,</code><code> </code><em><code class="nx">background_color</code></em><code class="p">);</code></pre>
<p>The code in <a data-type="xref" href="#example_onezero_fourdot_image_rotation">Example 10-4</a> shows the black box image from before, rotated by 45 degrees. The <em>background_color</em> option, used to specify the color of the uncovered area after the image is rotated, has been set to <code>1</code> to show the contrast of the black and white colors. <a data-type="xref" href="#black_box_image_rotated_fourfive_degree">Figure 10-2</a> shows the result of this code.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_creating_ch10" id="idm45922760872728"/></p>
<div data-type="example" id="example_onezero_fourdot_image_rotation">
<h5><span class="label">Example 10-4. </span>Image rotation example</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>
<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="nv">$rotated</code> <code class="o">=</code> <code class="nb">imagerotate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">45</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$rotated</code><code class="p">);</code></pre>
</div>
<figure><div id="black_box_image_rotated_fourfive_degree" class="figure">
<img src="Images/php4_1002.png" alt="Black box image rotated 45 degrees" width="366" height="339"/>
<h6><span class="label">Figure 10-2. </span>Black box image rotated 45 degrees</h6>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Images with Text"><div class="sect1" id="images_with_text">
<h1>Images with Text</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="text in" id="ix_graphics_textin"/><a contenteditable="false" data-type="indexterm" data-primary="text" data-secondary="ix_text_ingraphics" data-startref="ix_text_ingraphics" id="idm45922760778504"/>Often it is necessary to <a contenteditable="false" data-type="indexterm" data-primary="text" data-secondary="adding to images" id="ix_text_add_to_images"/>add text to images. GD has built-in fonts for this purpose. <a data-type="xref" href="#example_onezero_fivedot_adding_text_to">Example 10-5</a> adds some text to our black square image.</p>
<div data-type="example" id="example_onezero_fivedot_adding_text_to">
<h5><span class="label">Example 10-5. </span>Adding text to an image</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>

<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>
<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">160</code><code class="p">,</code> <code class="s2">"A Black Box"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#the_black_box_image_with_added_text">Figure 10-3</a> shows the output of <a data-type="xref" href="#example_onezero_fivedot_adding_text_to">Example 10-5</a>.</p>
<figure><div id="the_black_box_image_with_added_text" class="figure">
<img src="Images/php4_1003.png" alt="The black box image with added text" width="274" height="259"/>
<h6><span class="label">Figure 10-3. </span>The black box image with added text</h6>
</div></figure>
<p>The <a contenteditable="false" data-type="indexterm" data-primary="imagestring function" id="idm45922760545544"/><code>imagestring()</code> function adds text to an image. Specify the top-left point of the text, as well as the color and the font (by GD font identifier) to use:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagestring</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">font_id</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">text</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">);</code></pre>
<section data-type="sect2" data-pdf-bookmark="Fonts"><div class="sect2" id="fonts">
<h2>Fonts</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="fonts for graphics" id="ix_fonts_graphics_ch10"/>GD identifies fonts by an ID. Five fonts are built in, and you can load additional fonts through the <a contenteditable="false" data-type="indexterm" data-primary="imageloadfont function" id="idm45922760521672"/><code>imageloadfont()</code> function. The five built-in fonts are shown in <a data-type="xref" href="#native_gd_fonts">Figure 10-4</a>.</p>
<figure><div id="native_gd_fonts" class="figure">
<img src="Images/php4_1004.png" alt="Native GD fonts" width="215" height="217"/>
<h6><span class="label">Figure 10-4. </span>Native GD fonts</h6>
</div></figure>
<p>Here is the code used to show you these fonts:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="mi">200</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">);</code>

<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="s2">"Font 1: ABCDEfghij"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>
<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">30</code><code class="p">,</code> <code class="s2">"Font 2: ABCDEfghij"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>
<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="s2">"Font 3: ABCDEfghij"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>
<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">70</code><code class="p">,</code> <code class="s2">"Font 4: ABCDEfghij"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>
<code class="nb">imagestring</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">10</code><code class="p">,</code> <code class="mi">90</code><code class="p">,</code> <code class="s2">"Font 5: ABCDEfghij"</code><code class="p">,</code> <code class="nv">$black</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
<p>You can create your own bitmap fonts and load them into GD using the <code>imageloadfont()</code> function. However, these fonts are binary and architecture-dependent, making them nonportable from machine to machine. Using TrueType fonts with the TrueType functions in GD provides much more flexibility.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="TrueType Fonts"><div class="sect2" id="truetype_fonts">
<h2>TrueType Fonts</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="TrueType fonts for graphics" id="idm45922760622728"/>TrueType is an outline font standard; it provides more precise control over the rendering of the characters. To add text in a TrueType font to an image, use <a contenteditable="false" data-type="indexterm" data-primary="imagettftext function" id="idm45922760621352"/><code>imagettftext()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagettftext</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">size</code></em><code class="p">,</code><code> </code><em><code class="nx">angle</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">,</code><code> </code><em><code class="nx">color</code></em><code class="p">,</code><code> </code><em><code class="nx">font</code></em><code class="p">,</code><code> </code><em><code class="nx">text</code></em><code class="p">);</code></pre>
<p>The <em>size</em> is measured in pixels. The <em>angle</em> is in degrees from 3 o’clock (<code>0</code> gives horizontal text, <code>90</code> gives vertical text going up the image, etc.). The <em>x</em> and <em>y</em> coordinates specify the lower-left corner of the baseline for the text. The text may include UTF-8<sup><a data-type="noteref" id="ch10fn2-marker" href="ch10.xhtml#ch10fn2">2</a></sup> sequences of the form <code>&amp;#234;</code> to print high-bit ASCII characters.</p>
<p>The font parameter is the location of the TrueType font to use for rendering the string. If the font does not begin with a leading <code>/</code> character, the <em>.ttf</em> extension is added and the font is looked up in <em>/usr/share/fonts/truetype</em>.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="antialiasing" id="idm45922760422808"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="antialiasing for" id="idm45922760421704"/>By default, text in a TrueType font is antialiased. This makes most fonts much easier to read, although very slightly blurred. Antialiasing can make very small text harder to read, though—small characters have fewer pixels, so the adjustments of antialiasing are more significant.</p>
<p>You can turn off antialiasing by using a negative color index (e.g., <code>−4</code> means to use color index 4 without antialiasing the text).</p>
<p><a data-type="xref" href="#example_onezero_sixdot_using_a_truetype">Example 10-6</a> uses a TrueType font to add text to an image, searching for the font in the same location as the script, but still having to provide the full path to the location of the font file (included in the book’s code examples).</p>
<div data-type="example" id="example_onezero_sixdot_using_a_truetype">
<h5><span class="label">Example 10-6. </span>Using a TrueType font</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code><code>
</code><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreate</code><code class="p">(</code><code class="mi">350</code><code class="p">,</code><code> </code><code class="mi">70</code><code class="p">);</code><code>
</code><code class="nv">$white</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">);</code><code>
</code><code class="nv">$black</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">);</code><code>


</code><code class="nv">$fontname</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">c:/wamp64/www/bookcode/chapter_10/IndieFlower.ttf</code><code class="s2">"</code><code class="p">;</code><code>

</code><em><code class="nb">imagettftext</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">40</code><code class="p">,</code><code> </code><code class="nv">$black</code><code class="p">,</code><code> </code><code class="nv">$fontname</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">The Quick Brown Fox</code><code class="s2">"</code><code class="p">);</code><code>

</code><code class="nb">header</code><code class="p">(</code><code class="s2">"</code><code class="s2">Content-Type: image/png</code><code class="s2">"</code><code class="p">);</code><code>
</code><code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#indie_flower_truetype_font">Figure 10-5</a> shows the output of <a data-type="xref" href="#example_onezero_sixdot_using_a_truetype">Example 10-6</a>.</p>
<figure><div id="indie_flower_truetype_font" class="figure">
<img src="Images/php4_1005.png" alt="Indie Flower TrueType font" width="374" height="103"/>
<h6><span class="label">Figure 10-5. </span>Indie Flower TrueType font</h6>
</div></figure>
<p><a data-type="xref" href="#example_onezero_sevendot_displaying_ver">Example 10-7</a> uses <a contenteditable="false" data-type="indexterm" data-primary="imagettftext function" id="idm45922760297608"/><code>imagettftext()</code> to add vertical text to an image.</p>
<div data-type="example" id="example_onezero_sevendot_displaying_ver">
<h5><span class="label">Example 10-7. </span>Displaying vertical TrueType text</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code><code>
</code><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagecreate</code></em><code class="p">(</code><code class="mi">70</code><code class="p">,</code><code> </code><code class="mi">350</code><code class="p">);</code><code>
</code><code class="nv">$white</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagecolorallocate</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mi">255</code><code class="p">,</code><code> </code><code class="mi">255</code><code class="p">,</code><code> </code><code class="mi">255</code><code class="p">);</code><code>
</code><code class="nv">$black</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagecolorallocate</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">);</code><code>

</code><code class="nv">$fontname</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">c:/wamp64/www/bookcode/chapter_10/IndieFlower.ttf</code><code class="s2">"</code><code class="p">;</code><code>

</code><em><code class="nb">imagettftext</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mi">20</code><code class="p">,</code><code> </code><code class="mi">270</code><code class="p">,</code><code> </code><code class="mi">28</code><code class="p">,</code><code> </code><code class="mi">10</code><code class="p">,</code><code> </code><code class="nv">$black</code><code class="p">,</code><code> </code><code class="nv">$fontname</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">The Quick Brown Fox</code><code class="s2">"</code><code class="p">);</code><code>

</code><em><code class="nb">header</code></em><code class="p">(</code><code class="s2">"</code><code class="s2">Content-Type: image/png</code><code class="s2">"</code><code class="p">);</code><code>
</code><em><code class="nb">imagepng</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p class="pagebreak-before"><a data-type="xref" href="#vertical_truetype_text">Figure 10-6</a> shows the output of <a data-type="xref" href="#example_onezero_sevendot_displaying_ver">Example 10-7</a>.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_text_add_to_images" id="idm45922760140680"/></p>
<figure><div id="vertical_truetype_text" class="figure">
<img src="Images/php4_1006.png" alt="Vertical TrueType text" width="117" height="385"/>
<h6><span class="label">Figure 10-6. </span>Vertical TrueType text</h6>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Dynamically Generated Buttons"><div class="sect1" id="dynamically_generated_buttons">
<h1>Dynamically Generated Buttons</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="for buttons, dynamic" data-secondary-sortas="buttons" id="ix_graphics_buttons"/><a contenteditable="false" data-type="indexterm" data-primary="buttons, creating dynamic" id="ix_buttons_create_cache"/>Creating images for buttons on the fly is one popular use for generating images (this topic was introduced in <a data-type="xref" href="ch01.xhtml#introduction_to_php">Chapter 1</a>). Typically, this involves compositing text over a preexisting background image, as shown in <a data-type="xref" href="#example_onezero_eightdot_creating_a_dyn">Example 10-8</a>.</p>
<div data-type="example" id="example_onezero_eightdot_creating_a_dyn">
<h5><span class="label">Example 10-8. </span>Creating a dynamic button</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code><code>
</code><code class="nv">$font</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">c:/wamp64/www/bookcode/chapter_10/IndieFlower.ttf</code><code class="s2">"</code><code> </code><code class="p">;</code><code>
</code><code class="nv">$size</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">isset</code></em><code class="p">(</code><strong><code class="nv">$_GET</code></strong><code class="p">[</code><code class="s1">'size'</code><code class="p">])</code><code> </code><code class="o">?</code><code> </code><strong><code class="nv">$_GET</code></strong><code class="p">[</code><code class="s1">'size'</code><code class="p">]</code><code> </code><code class="o">:</code><code> </code><code class="mi">12</code><code class="p">;</code><code>
</code><code class="nv">$text</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">isset</code></em><code class="p">(</code><strong><code class="nv">$_GET</code></strong><code class="p">[</code><code class="s1">'text'</code><code class="p">])</code><code> </code><code class="o">?</code><code> </code><strong><code class="nv">$_GET</code></strong><code class="p">[</code><code class="s1">'text'</code><code class="p">]</code><code> </code><code class="o">:</code><code> </code><code class="s1">'some text'</code><code class="p">;</code><code>

</code><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagecreatefrompng</code></em><code class="p">(</code><code class="s2">"</code><code class="s2">button.png</code><code class="s2">"</code><code class="p">);</code><code>
</code><code class="nv">$black</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagecolorallocate</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">);</code><code>

</code><strong><code class="k">if</code></strong><code> </code><code class="p">(</code><code class="nv">$text</code><code class="p">)</code><code> </code><code class="p">{</code><code>
 </code><code class="c1">// calculate position of text
</code><code> </code><code class="nv">$tsize</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">imagettfbbox</code></em><code class="p">(</code><code class="nv">$size</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nv">$font</code><code class="p">,</code><code> </code><code class="nv">$text</code><code class="p">);</code><code>
 </code><code class="nv">$dx</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">abs</code></em><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code><code>
 </code><code class="nv">$dy</code><code> </code><code class="o">=</code><code> </code><em><code class="nb">abs</code></em><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">5</code><code class="p">]</code><code> </code><code class="o">-</code><code> </code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">3</code><code class="p">]);</code><code>
 </code><code class="nv">$x</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><em><code class="nb">imagesx</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="nv">$dx</code><code> </code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code class="p">;</code><code>
 </code><code class="nv">$y</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><em><code class="nb">imagesy</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">)</code><code> </code><code class="o">-</code><code> </code><code class="nv">$dy</code><code> </code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">2</code><code> </code><code class="o">+</code><code> </code><code class="nv">$dy</code><code class="p">;</code><code>

 </code><code class="c1">// draw text
</code><code> </code><em><code class="nb">imagettftext</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">,</code><code> </code><code class="nv">$size</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">,</code><code> </code><code class="nv">$x</code><code class="p">,</code><code> </code><code class="nv">$y</code><code class="p">,</code><code> </code><code class="nv">$black</code><code class="p">,</code><code> </code><code class="nv">$font</code><code class="p">,</code><code> </code><code class="nv">$text</code><code class="p">);</code><code>
</code><code class="p">}</code><code>

</code><em><code class="nb">header</code></em><code class="p">(</code><code class="s2">"</code><code class="s2">Content-Type: image/png</code><code class="s2">"</code><code class="p">);</code><code>
</code><em><code class="nb">imagepng</code></em><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p>In this case, the blank button (<em>button.png</em>) is overwritten with the default text, as shown in <a data-type="xref" href="#dynamic_button_with_default_text">Figure 10-7</a>.</p>
<figure><div id="dynamic_button_with_default_text" class="figure">
<img src="Images/php4_1007.png" alt="Dynamic button with default text" width="119" height="51"/>
<h6><span class="label">Figure 10-7. </span>Dynamic button with default text</h6>
</div></figure>
<p>The script in <a data-type="xref" href="#example_onezero_eightdot_creating_a_dyn">Example 10-8</a> can be called from a page like this:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"button.php?text=PHP+Button"</code> <code class="nt">/&gt;</code></pre>
<p>This HTML generates the button shown in <a data-type="xref" href="#button_with_generated_text_label">Figure 10-8</a>.</p>
<figure><div id="button_with_generated_text_label" class="figure">
<img src="Images/php4_1008.png" alt="Button with generated text label" width="104" height="40"/>
<h6><span class="label">Figure 10-8. </span>Button with generated text label</h6>
</div></figure>
<p>The + character in the URL is the encoded form of a space. Spaces are illegal in URLs and must be encoded. Use PHP’s <a contenteditable="false" data-type="indexterm" data-primary="urlencode function" id="idm45922759920872"/><code>urlencode()</code> function to encode your button strings. For example:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_textin" id="idm45922759919352"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_text_ingraphics" id="idm45922759917976"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_fonts_graphics_ch10" id="idm45922759916600"/></p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;img</code> <code class="na">src=</code><code class="s">"button.php?text=</code><code class="cp">&lt;?</code><code class="o">=</code> <code class="nb">urlencode</code><code class="p">(</code><code class="s2">"PHP Button"</code><code class="p">);</code> <code class="cp">?&gt;</code><code class="s">"</code> <code class="nt">/&gt;</code></pre>
<section data-type="sect2" data-pdf-bookmark="Caching the Dynamically Generated Buttons"><div class="sect2" id="caching_the_dynamically_generated_butto">
<h2>Caching the Dynamically Generated Buttons</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="caching" data-secondary="for dynamically generated buttons" data-secondary-sortas="dynamically" id="ix_caching_buttons"/>It is somewhat slower to generate an image than to send a static image. For buttons that will always look the same when called with the same text argument, you can implement a simple cache mechanism.</p>
<p><a data-type="xref" href="#example_onezero_ninedot_caching_dynamic">Example 10-9</a> generates the button only when no cache file for that button is found. The <code>$path</code> variable holds a directory, writable by the web server user, where buttons can be cached; make sure it can be reached from where you run this code. The <a contenteditable="false" data-type="indexterm" data-primary="filesize function" id="idm45922759835384"/><code>filesize()</code> function returns the size of a file, and <a contenteditable="false" data-type="indexterm" data-primary="readfile function" id="idm45922759833864"/><code>readfile()</code> sends the contents of a file to the browser. Because this script uses the text form parameter as the filename, it is very insecure. (<a data-type="xref" href="ch14.xhtml#security">Chapter 14</a>, which covers security issues, explains why and how to fix it.)</p>
<div class="pagebreak-before" data-type="example" id="example_onezero_ninedot_caching_dynamic">
<h5 class="less_space"><span class="label">Example 10-9. </span>Caching dynamic buttons</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>

<code class="nv">$font</code> <code class="o">=</code> <code class="s2">"c:/wamp64/www/bookcode/chapter_10/IndieFlower.ttf"</code><code class="p">;</code>
<code class="nv">$size</code> <code class="o">=</code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_GET</code><code class="p">[</code><code class="s1">'size'</code><code class="p">])</code> <code class="o">?</code> <code class="nv">$_GET</code><code class="p">[</code><code class="s1">'size'</code><code class="p">]</code> <code class="o">:</code> <code class="mi">12</code><code class="p">;</code>
<code class="nv">$text</code> <code class="o">=</code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_GET</code><code class="p">[</code><code class="s1">'text'</code><code class="p">])</code> <code class="o">?</code> <code class="nv">$_GET</code><code class="p">[</code><code class="s1">'text'</code><code class="p">]</code> <code class="o">:</code> <code class="s1">'some text'</code><code class="p">;</code>

<code class="nv">$path</code> <code class="o">=</code> <code class="s2">"/tmp/buttons"</code><code class="p">;</code> <code class="c1">// button cache directory</code>

<code class="c1">// send cached version</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$bytes</code> <code class="o">=</code> <code class="o">@</code><code class="nb">filesize</code><code class="p">(</code><code class="s2">"</code><code class="si">{</code><code class="nv">$path</code><code class="si">}</code><code class="s2">/button.png"</code><code class="p">))</code> <code class="p">{</code>
 <code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
 <code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Length: </code><code class="si">{</code><code class="nv">$bytes</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code>
 <code class="nb">readfile</code><code class="p">(</code><code class="s2">"</code><code class="si">{</code><code class="nv">$path</code><code class="si">}</code><code class="s2">/button.png"</code><code class="p">);</code>

 <code class="k">exit</code><code class="p">;</code>
<code class="p">}</code>

<code class="c1">// otherwise, we have to build it, cache it, and return it</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatefrompng</code><code class="p">(</code><code class="s2">"button.png"</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$text</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// calculate position of text</code>
 <code class="nv">$tsize</code> <code class="o">=</code> <code class="nb">imagettfbbox</code><code class="p">(</code><code class="nv">$size</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$font</code><code class="p">,</code> <code class="nv">$text</code><code class="p">);</code>
 <code class="nv">$dx</code> <code class="o">=</code> <code class="nb">abs</code><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">-</code> <code class="nv">$tsize</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>
 <code class="nv">$dy</code> <code class="o">=</code> <code class="nb">abs</code><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">5</code><code class="p">]</code> <code class="o">-</code> <code class="nv">$tsize</code><code class="p">[</code><code class="mi">3</code><code class="p">]);</code>
 <code class="nv">$x</code> <code class="o">=</code> <code class="p">(</code><code class="nb">imagesx</code><code class="p">(</code><code class="nv">$image</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$dx</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
 <code class="nv">$y</code> <code class="o">=</code> <code class="p">(</code><code class="nb">imagesy</code><code class="p">(</code><code class="nv">$image</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$dy</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="nv">$dy</code><code class="p">;</code>

 <code class="c1">// draw text</code>
 <code class="nb">imagettftext</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$size</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="nv">$y</code><code class="p">,</code> <code class="nv">$black</code><code class="p">,</code> <code class="nv">$font</code><code class="p">,</code> <code class="nv">$text</code><code class="p">);</code>

 <code class="c1">// save image to file</code>
 <code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$path</code><code class="si">}</code><code class="s2">/</code><code class="si">{</code><code class="nv">$text</code><code class="si">}</code><code class="s2">.png"</code><code class="p">);</code>
<code class="p">}</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
</div></section>
<section data-type="sect2" data-pdf-bookmark="A Faster Cache"><div class="sect2" id="a_faster_cache">
<h2>A Faster Cache</h2>
<p><a data-type="xref" href="#example_onezero_ninedot_caching_dynamic">Example 10-9</a> is still not as quick as it could be. Using Apache directives, you can bypass the PHP script entirely and load the cached image directly once it is created.</p>
<p>First, create a <em>buttons</em> directory somewhere under your web server’s <code>DocumentRoot</code> and make sure that your web server user has permissions to write to this directory. For example, if the <code>DocumentRoot</code> directory is <em>/var/www/html</em>, create <em>/var/www/html/buttons</em>.</p>
<p>Second, edit your Apache <em>httpd.conf</em> file and add the following block:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;Location</code> <code class="err">/</code><code class="na">buttons</code><code class="nt">/&gt;</code>
 ErrorDocument 404 /button.php
<code class="nt">&lt;/Location&gt;</code></pre>
<p>This tells Apache that requests for nonexistent files in the <em>buttons</em> directory should be sent to your <em>button.php</em> script.</p>
<p>Third, save <a data-type="xref" href="#example_onezero_onezerodot_more_efficie">Example 10-10</a> as <em>button.php</em>. This script creates new buttons, saving them to the cache and sending them to the browser. There are several differences from <a data-type="xref" href="#example_onezero_ninedot_caching_dynamic">Example 10-9</a>, though. We don’t have form parameters in <code>$_GET</code>, because Apache handles error pages as redirections. Instead, we have to pull apart values in <code>$_SERVER</code> to find out which button we’re generating. While we’re at it, we delete the <code>'..'</code> in the filename to fix the security hole from <a data-type="xref" href="#example_onezero_ninedot_caching_dynamic">Example 10-9</a>.</p>
<p>Once <em>button.php</em> is installed, when a request comes in for something like <em>http://your.site/buttons/php.png</em>, the web server checks whether the <em>buttons/php.png</em> file exists. If it does not, the request is redirected to the <em>button.php</em> script, which creates the image (with the text “php”) and saves it to <em>buttons/php.png</em>. Any subsequent requests for this file are served up directly without a line of PHP being run.</p>
<div data-type="example" id="example_onezero_onezerodot_more_efficie">
<h5><span class="label">Example 10-10. </span>More efficient caching of dynamic buttons</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="c1">// bring in redirected URL parameters, if any</code>
<code class="nb">parse_str</code><code class="p">(</code><code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'REDIRECT_QUERY_STRING'</code><code class="p">]);</code>

<code class="nv">$cacheDir</code> <code class="o">=</code> <code class="s2">"/buttons/"</code><code class="p">;</code>
<code class="nv">$url</code> <code class="o">=</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'REDIRECT_URL'</code><code class="p">];</code>

<code class="c1">// pick out the extension</code>
<code class="nv">$extension</code> <code class="o">=</code> <code class="nb">substr</code><code class="p">(</code><code class="nv">$url</code><code class="p">,</code> <code class="nb">strrpos</code><code class="p">(</code><code class="nv">$url</code><code class="p">,</code> <code class="s1">'.'</code><code class="p">));</code>

<code class="c1">// remove directory and extension from $url string</code>
<code class="nv">$file</code> <code class="o">=</code> <code class="nb">substr</code><code class="p">(</code><code class="nv">$url</code><code class="p">,</code> <code class="nb">strlen</code><code class="p">(</code><code class="nv">$cacheDir</code><code class="p">),</code> <code class="o">-</code><code class="nb">strlen</code><code class="p">(</code><code class="nv">$extension</code><code class="p">));</code>

<code class="c1">// security - don't allow '..' in filename</code>
<code class="nv">$file</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'..'</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="nv">$file</code><code class="p">);</code>

<code class="c1">// text to display in button</code>
<code class="nv">$text</code> <code class="o">=</code> <code class="nb">urldecode</code><code class="p">(</code><code class="nv">$file</code><code class="p">);</code>

<code class="nv">$font</code> <code class="o">=</code> <code class="s2">"c:/wamp64/www/bookcode/chapter_10/IndieFlower.ttf"</code> <code class="p">;</code>

<code class="c1">// build it, cache it, and return it</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatefrompng</code><code class="p">(</code><code class="s2">"button.png"</code><code class="p">);</code>
<code class="nv">$black</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$text</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// calculate position of text</code>
 <code class="nv">$tsize</code> <code class="o">=</code> <code class="nb">imagettfbbox</code><code class="p">(</code><code class="nv">$size</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$font</code><code class="p">,</code> <code class="nv">$text</code><code class="p">);</code>
 <code class="nv">$dx</code> <code class="o">=</code> <code class="nb">abs</code><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code> <code class="o">-</code> <code class="nv">$tsize</code><code class="p">[</code><code class="mi">0</code><code class="p">]);</code>
 <code class="nv">$dy</code> <code class="o">=</code> <code class="nb">abs</code><code class="p">(</code><code class="nv">$tsize</code><code class="p">[</code><code class="mi">5</code><code class="p">]</code> <code class="o">-</code> <code class="nv">$tsize</code><code class="p">[</code><code class="mi">3</code><code class="p">]);</code>
 <code class="nv">$x</code> <code class="o">=</code> <code class="p">(</code><code class="nb">imagesx</code><code class="p">(</code><code class="nv">$image</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$dx</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
 <code class="nv">$y</code> <code class="o">=</code> <code class="p">(</code><code class="nb">imagesy</code><code class="p">(</code><code class="nv">$image</code><code class="p">)</code> <code class="o">-</code> <code class="nv">$dy</code> <code class="p">)</code> <code class="o">/</code> <code class="mi">2</code> <code class="o">+</code> <code class="nv">$dy</code><code class="p">;</code>

 <code class="c1">// draw text</code>
 <code class="nb">imagettftext</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$size</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="nv">$y</code><code class="p">,</code> <code class="nv">$black</code><code class="p">,</code> <code class="nv">$font</code><code class="p">,</code> <code class="nv">$text</code><code class="p">);</code>

 <code class="c1">// save image to file</code>
 <code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'DOCUMENT_ROOT'</code><code class="p">]</code><code class="si">}{</code><code class="nv">$cacheDir</code><code class="si">}{</code><code class="nv">$file</code><code class="si">}</code><code class="s2">.png"</code><code class="p">);</code>
<code class="p">}</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p>One significant drawback to the mechanism in <a data-type="xref" href="#example_onezero_onezerodot_more_efficie">Example 10-10</a> is that the button text cannot contain any characters that are illegal in a filename. Nonetheless, this is the most efficient way to cache dynamically generated images. If you change the look of your buttons and you need to regenerate the cached images, simply delete all the images in your <em>buttons</em> directory, and they will be re-created as they are requested.</p>
<p>You can also take this a step further and get your <em>button.php</em> script to support multiple image types. Simply check <code>$extension</code> and call the appropriate <code>imagepng()</code>, <code>imagejpeg()</code>, or <code>imagegif()</code> function at the end of the script. You can also parse the filename and add modifiers such as color, size, and font, or pass them right in the URL. Because of the <a contenteditable="false" data-type="indexterm" data-primary="parse_str function" id="idm45922759356424"/><code>parse_str()</code> call in the example, a URL such as <em>http://your.site/buttons/php.png?size=16</em> displays “php” in a font size of 16.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_buttons_create_cache" id="idm45922759354312"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_buttons" id="idm45922759352968"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_caching_buttons" id="idm45922759351592"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Scaling Images"><div class="sect1" id="scaling_images">
<h1>Scaling Images</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="scaling" id="idm45922759348616"/>There are two ways to change the size of an image. The <a contenteditable="false" data-type="indexterm" data-primary="imagecopyresized function" id="idm45922759347112"/><code>imagecopyresized()</code> function is fast but crude, and may produce jagged edges in your new images. The <a contenteditable="false" data-type="indexterm" data-primary="imagecopyresampled function" id="idm45922759345576"/><code>imagecopyresampled()</code> function is slower, but uses pixel interpolation to generate smooth edges and give clarity to the resized image. Both functions take the same arguments:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">imagecopyresized</code><code class="p">(</code><em><code class="nx">dest</code></em><code class="p">,</code><code> </code><em><code class="nx">src</code></em><code class="p">,</code><code> </code><em><code class="nx">dx</code></em><code class="p">,</code><code> </code><em><code class="nx">dy</code></em><code class="p">,</code><code> </code><em><code class="nx">sx</code></em><code class="p">,</code><code> </code><em><code class="nx">sy</code></em><code class="p">,</code><code> </code><em><code class="nx">dw</code></em><code class="p">,</code><code> </code><em><code class="nx">dh</code></em><code class="p">,</code><code> </code><em><code class="nx">sw</code></em><code class="p">,</code><code> </code><em><code class="nx">sh</code></em><code class="p">);</code><code>
</code><code class="nb">imagecopyresampled</code><code class="p">(</code><em><code class="nx">dest</code></em><code class="p">,</code><code> </code><em><code class="nx">src</code></em><code class="p">,</code><code> </code><em><code class="nx">dx</code></em><code class="p">,</code><code> </code><em><code class="nx">dy</code></em><code class="p">,</code><code> </code><em><code class="nx">sx</code></em><code class="p">,</code><code> </code><em><code class="nx">sy</code></em><code class="p">,</code><code> </code><em><code class="nx">dw</code></em><code class="p">,</code><code> </code><em><code class="nx">dh</code></em><code class="p">,</code><code> </code><em><code class="nx">sw</code></em><code class="p">,</code><code> </code><em><code class="nx">sh</code></em><code class="p">);</code></pre>
<p>The <em>dest</em> and <em>src</em> parameters are image handles. The point <code>(</code><em>dx</em><code>,</code> <em>dy</em><code>)</code> is the point in the destination image where the region will be copied. The point <code>(</code><em>sx</em><code>,</code> <em>sy</em><code>)</code> is the upper-left corner of the source image. The <em>sw</em>, <em>sh</em>, <em>dw</em>, and <em>dh</em> parameters give the width and height of the copy regions in the source and destination.</p>
<p><a data-type="xref" href="#example_onezero_oneonedot_resizing_with">Example 10-11</a> takes the <em>php.jpg</em> image shown in <a data-type="xref" href="#original_phpdotjpg_image">Figure 10-9</a> and smoothly scales it down to one-quarter of its size, yielding the image in <a data-type="xref" href="#resulting_onesolidusfour_sized_image">Figure 10-10</a>.</p>
<div data-type="example" id="example_onezero_oneonedot_resizing_with">
<h5><span class="label">Example 10-11. </span>Resizing with imagecopyresampled()</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$source</code> <code class="o">=</code> <code class="nb">imagecreatefromjpeg</code><code class="p">(</code><code class="s2">"php_logo_big.jpg"</code><code class="p">);</code>

<code class="nv">$width</code> <code class="o">=</code> <code class="nb">imagesx</code><code class="p">(</code><code class="nv">$source</code><code class="p">);</code>
<code class="nv">$height</code> <code class="o">=</code> <code class="nb">imagesy</code><code class="p">(</code><code class="nv">$source</code><code class="p">);</code>
<code class="nv">$x</code> <code class="o">=</code> <code class="nv">$width</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>
<code class="nv">$y</code> <code class="o">=</code> <code class="nv">$height</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code>

<code class="nv">$destination</code> <code class="o">=</code> <code class="nb">imagecreatetruecolor</code><code class="p">(</code><code class="nv">$x</code><code class="p">,</code> <code class="nv">$y</code><code class="p">);</code>
<code class="nb">imagecopyresampled</code><code class="p">(</code><code class="nv">$destination</code><code class="p">,</code> <code class="nv">$source</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="nv">$y</code><code class="p">,</code> <code class="nv">$width</code><code class="p">,</code> <code class="nv">$height</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$destination</code><code class="p">);</code></pre>
</div>
<figure><div id="original_phpdotjpg_image" class="figure">
<img src="Images/php4_1009.png" alt="Original php.jpg image" width="329" height="182"/>
<h6><span class="label">Figure 10-9. </span>Original php.jpg image</h6>
</div></figure>
<figure><div id="resulting_onesolidusfour_sized_image" class="figure">
<img src="Images/php4_1010.png" alt="Resulting 1/4-sized image" width="172" height="95"/>
<h6><span class="label">Figure 10-10. </span>Resulting 1/4-sized image</h6>
</div></figure>
<p>Dividing the height and the width by 4 instead of 2 produces the output shown in <a data-type="xref" href="#resulting_onesolidusonesix_sized_image">Figure 10-11</a>.</p>
<figure><div id="resulting_onesolidusonesix_sized_image" class="figure">
<img src="Images/php4_1011.png" alt="Resulting 1/16-sized image" width="91" height="51"/>
<h6><span class="label">Figure 10-11. </span>Resulting 1/16-sized image</h6>
</div></figure>
</div></section>
<section class="pagebreak-before" data-type="sect1" data-pdf-bookmark="Color Handling"><div class="sect1" id="color_handling">
<h1 class="less_space">Color Handling</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="colors" data-secondary="images" id="ix_colors_graphics"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="color handling" id="ix_graphics_colors"/>The GD library supports both 8-bit palette (256 color) images and true color images with alpha channel transparency.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="color palette" id="idm45922759080328"/>To create an 8-bit palette image, use the <a contenteditable="false" data-type="indexterm" data-primary="imagecreate function" id="idm45922759079096"/><code>imagecreate()</code> function. The image’s background is subsequently filled with the first color you allocate using <a contenteditable="false" data-type="indexterm" data-primary="imagecolorallocate function" id="idm45922759077464"/><code>imagecolor</code><span class="keep-together"><code>allocate()</code></span>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$width</code> <code class="o">=</code> <code class="mi">128</code><code class="p">;</code>
<code class="nv">$height</code> <code class="o">=</code> <code class="mi">256</code><code class="p">;</code>

<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreate</code><code class="p">(</code><code class="nv">$width</code><code class="p">,</code> <code class="nv">$height</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">);</code></pre>
<p>To create a true color image with a 7-bit alpha channel, use the <a contenteditable="false" data-type="indexterm" data-primary="imagecreatetruecolor function" id="idm45922759073736"/><code>imagecreatetruecolor()</code> function:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$image</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecreatetruecolor</code><code class="p">(</code><em><code class="nx">width</code></em><code class="p">,</code><code> </code><em><code class="nx">height</code></em><code class="p">);</code></pre>
<p>Use <a contenteditable="false" data-type="indexterm" data-primary="imagecolorallocatealpha function" id="idm45922759024376"/><code>imagecolorallocatealpha()</code> to create a color index that includes transparency:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$color</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorallocatealpha</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">red</code></em><code class="p">,</code><code> </code><em><code class="nx">green</code></em><code class="p">,</code><code> </code><em><code class="nx">blue</code></em><code class="p">,</code><code> </code><em><code class="nx">alpha</code></em><code class="p">);</code></pre>
<p>The <em>alpha</em> value is between 0 (opaque) and 127 (transparent).</p>
<p>While most people are used to an 8-bit (0–255) alpha channel, it is actually quite handy that GD’s is 7-bit (0–127). Each pixel is represented by a 32-bit signed integer, with the four 8-bit bytes arranged like this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">High</code> <code class="nx">Byte</code> <code class="nx">Low</code> <code class="nx">Byte</code>
<code class="p">{</code><code class="nx">Alpha</code> <code class="nx">Channel</code><code class="p">}</code> <code class="p">{</code><code class="nx">Red</code><code class="p">}</code> <code class="p">{</code><code class="nx">Green</code><code class="p">}</code> <code class="p">{</code><code class="nx">Blue</code><code class="p">}</code></pre>
<p>For a signed integer, the leftmost bit, or the highest bit, is used to indicate whether the value is negative, thus leaving only 31 bits of actual information. PHP’s default integer value is a signed long into which we can store a single GD palette entry. Whether that integer is positive or negative tells us whether antialiasing is enabled for that palette entry.</p>
<p>Unlike with palette images, with true color images the first color you allocate does not automatically become your background color. Instead, the image is initially filled with fully transparent pixels. Call <a contenteditable="false" data-type="indexterm" data-primary="imagefilledrectangle function" id="idm45922758756072"/><code>imagefilledrectangle()</code> to fill the image with any background color you want.</p>
<p><a data-type="xref" href="#example_onezero_onetwodot_a_simple_oran">Example 10-12</a> creates a true color image and draws a semitransparent orange ellipse on a white background.</p>
<div data-type="example" id="example_onezero_onetwodot_a_simple_oran">
<h5><span class="label">Example 10-12. </span>A simple orange ellipse on a white background</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatetruecolor</code><code class="p">(</code><code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>
<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">255</code><code class="p">);</code>

<code class="nb">imagealphablending</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>
<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$white</code><code class="p">);</code>

<code class="nv">$red</code> <code class="o">=</code> <code class="nb">imagecolorallocatealpha</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">50</code><code class="p">);</code>
<code class="nb">imagefilledellipse</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">75</code><code class="p">,</code> <code class="mi">75</code><code class="p">,</code> <code class="mi">80</code><code class="p">,</code> <code class="mi">63</code><code class="p">,</code> <code class="nv">$red</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#an_orange_ellipse_on_a_white_background">Figure 10-12</a> shows the output of <a data-type="xref" href="#example_onezero_onetwodot_a_simple_oran">Example 10-12</a>.</p>
<figure><div id="an_orange_ellipse_on_a_white_background" class="figure">
<img src="Images/php4_1012.png" alt="An orange ellipse on a white background" width="166" height="166"/>
<h6><span class="label">Figure 10-12. </span>An orange ellipse on a white background</h6>
</div></figure>
<p>You can use the <a contenteditable="false" data-type="indexterm" data-primary="imagetruecolortopalette function" id="idm45922758655608"/><code>imagetruecolortopalette()</code> function to convert a true color image to one with a color index (also known as a <em>paletted</em> image).</p>
<section data-type="sect2" data-pdf-bookmark="Using the Alpha Channel"><div class="sect2" id="using_the_alpha_channel">
<h2>Using the Alpha Channel</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="alpha channel" id="idm45922758651784"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="alpha channel" id="idm45922758650680"/>In <a data-type="xref" href="#example_onezero_onetwodot_a_simple_oran">Example 10-12</a>, we turned off <em>alpha blending</em> before drawing our background and our ellipse. Alpha blending is a toggle that determines whether the alpha channel, if present, should be applied when the image is drawn. If alpha blending is off, the old pixel is replaced with the new pixel. If an alpha channel exists for the new pixel, it is maintained, but all pixel information for the original pixel being overwritten is lost.</p>
<p><a data-type="xref" href="#example_onezero_onethreedot_a_gray_rect">Example 10-13</a> illustrates alpha blending by drawing a gray rectangle with a 50% alpha channel over an orange ellipse.</p>
<div data-type="example" id="example_onezero_onethreedot_a_gray_rect">
<h5><span class="label">Example 10-13. </span>A gray rectangle with a 50% alpha channel overlaid</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatetruecolor</code><code class="p">(</code><code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">);</code>
<code class="nb">imagealphablending</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>

<code class="nv">$white</code> <code class="o">=</code> <code class="nb">imagecolorallocate</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">255</code><code class="p">);</code>
<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="mi">150</code><code class="p">,</code> <code class="nv">$white</code><code class="p">);</code>

<code class="nv">$red</code> <code class="o">=</code> <code class="nb">imagecolorallocatealpha</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">63</code><code class="p">);</code>
<code class="nb">imagefilledellipse</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">75</code><code class="p">,</code> <code class="mi">75</code><code class="p">,</code> <code class="mi">80</code><code class="p">,</code> <code class="mi">50</code><code class="p">,</code> <code class="nv">$red</code><code class="p">);</code>

<code class="nb">imagealphablending</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>

<code class="nv">$gray</code> <code class="o">=</code> <code class="nb">imagecolorallocatealpha</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">70</code><code class="p">,</code> <code class="mi">70</code><code class="p">,</code> <code class="mi">70</code><code class="p">,</code> <code class="mi">63</code><code class="p">);</code>
<code class="nb">imagefilledrectangle</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">60</code><code class="p">,</code> <code class="mi">60</code><code class="p">,</code> <code class="mi">120</code><code class="p">,</code> <code class="mi">120</code><code class="p">,</code> <code class="nv">$gray</code><code class="p">);</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#a_gray_rectangle_over_the_orange_ellips">Figure 10-13</a> shows the output of <a data-type="xref" href="#example_onezero_onethreedot_a_gray_rect">Example 10-13</a> (alpha blending is still turned off).</p>
<figure><div id="a_gray_rectangle_over_the_orange_ellips" class="figure">
<img src="Images/php4_1013.png" alt="A gray rectangle over the orange ellipse" width="165" height="161"/>
<h6><span class="label">Figure 10-13. </span>A gray rectangle over the orange ellipse</h6>
</div></figure>
<p>If we change <a data-type="xref" href="#example_onezero_onethreedot_a_gray_rect">Example 10-13</a> to enable alpha blending just before the call to <a contenteditable="false" data-type="indexterm" data-primary="imagefilledrectangle function" id="idm45922758394360"/><code>image</code>​<span class="keep-together"><code>filledrectangle()</code></span>, we get the image shown in <a data-type="xref" href="#image_with_alpha_blending_enabled">Figure 10-14</a>.</p>
<figure><div id="image_with_alpha_blending_enabled" class="figure">
<img src="Images/php4_1014.png" alt="Image with alpha blending enabled" width="163" height="160"/>
<h6><span class="label">Figure 10-14. </span>Image with alpha blending enabled</h6>
</div></figure>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Identifying Colors"><div class="sect2" id="identifying_colors">
<h2>Identifying Colors</h2>
<p>To check the color index for a specific pixel in an image, use <a contenteditable="false" data-type="indexterm" data-primary="imagecolorat function" id="idm45922758386920"/><code>imagecolorat()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$color</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorat</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">x</code></em><code class="p">,</code><code> </code><em><code class="nx">y</code></em><code class="p">);</code></pre>
<p>For images with an 8-bit color palette, the function returns a color index that you then pass to <a contenteditable="false" data-type="indexterm" data-primary="imagecolorsforindex function" id="idm45922758371912"/><code>imagecolorsforindex()</code> to get the actual RGB values:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$values</code><code> </code><code class="o">=</code><code> </code><code class="nb">imagecolorsforindex</code><code class="p">(</code><em><code class="nx">image</code></em><code class="p">,</code><code> </code><em><code class="nx">index</code></em><code class="p">);</code></pre>
<p>The array returned by <code>imagecolorsforindex()</code> has the keys <code>'red'</code>, <code>'green'</code>, and <code>'blue'</code>. If you call <code>imagecolorsforindex()</code> on a color from a true color image, the returned array also has a value for the key <code>'alpha'</code>. The values for these keys correspond to the 0–255 color values and the 0–127 alpha value used when calling <code>image</code>​<span class="keep-together"><code>colorallocate()</code></span> and <code>imagecolorallocatealpha()</code>.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="True Color Indexes"><div class="sect2" id="true_color_indexes">
<h2>True Color Indexes</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="true color indexes" id="ix_true_color_index"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="true color indexes for" id="ix_graphics_true_color"/>The color index returned by <a contenteditable="false" data-type="indexterm" data-primary="imagecolorallocatealpha function" id="idm45922758333960"/><code>imagecolorallocatealpha()</code> is really a 32-bit signed long, with the first three bytes holding the red, green, and blue values, respectively. The next bit indicates whether antialiasing is enabled for this color, and the remaining seven bits hold the transparency value.</p>
<p>For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$green</code> <code class="o">=</code> <code class="nb">imagecolorallocatealpha</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">255</code><code class="p">,</code> <code class="mi">127</code><code class="p">);</code></pre>
<p>This code sets <code>$green</code> to <code>2130771712</code>, which in hex is <code>0x7F00FF00</code> and in binary is <code>01111111000000001111111100000000</code>.</p>
<p>This is equivalent to the following <a contenteditable="false" data-type="indexterm" data-primary="imagecolorresolvealpha function" id="idm45922758577512"/><code>imagecolorresolvealpha()</code> call:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$green</code> <code class="o">=</code> <code class="p">(</code><code class="mi">127</code> <code class="o">&lt;&lt;</code> <code class="mi">24</code><code class="p">)</code> <code class="o">|</code> <code class="p">(</code><code class="mi">0</code> <code class="o">&lt;&lt;</code> <code class="mi">16</code><code class="p">)</code> <code class="o">|</code> <code class="p">(</code><code class="mi">255</code> <code class="o">&lt;&lt;</code> <code class="mi">8</code><code class="p">)</code> <code class="o">|</code> <code class="mi">0</code><code class="p">;</code></pre>
<p>You can also drop the two <code>0</code> entries in this example and just make it:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$green</code> <code class="o">=</code> <code class="p">(</code><code class="mi">127</code> <code class="o">&lt;&lt;</code> <code class="mi">24</code><code class="p">)</code> <code class="o">|</code> <code class="p">(</code><code class="mi">255</code> <code class="o">&lt;&lt;</code> <code class="mi">8</code><code class="p">);</code></pre>
<p>To deconstruct this value, you can use something like this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$a</code> <code class="o">=</code> <code class="p">(</code><code class="nv">$col</code> <code class="o">&amp;</code> <code class="mh">0x7F000000</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">24</code><code class="p">;</code>
<code class="nv">$r</code> <code class="o">=</code> <code class="p">(</code><code class="nv">$col</code> <code class="o">&amp;</code> <code class="mh">0x00FF0000</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">16</code><code class="p">;</code>
<code class="nv">$g</code> <code class="o">=</code> <code class="p">(</code><code class="nv">$col</code> <code class="o">&amp;</code> <code class="mh">0x0000FF00</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
<code class="nv">$b</code> <code class="o">=</code> <code class="p">(</code><code class="nv">$col</code> <code class="o">&amp;</code> <code class="mh">0x000000FF</code><code class="p">);</code></pre>
<p>Direct manipulation of color values like this is rarely necessary. One application is to generate a color-testing image that shows the pure shades of red, green, and blue. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatetruecolor</code><code class="p">(</code><code class="mi">256</code><code class="p">,</code> <code class="mi">60</code><code class="p">);</code>

<code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="mi">256</code><code class="p">;</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
 <code class="nb">imageline</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">19</code><code class="p">,</code> <code class="nv">$x</code><code class="p">);</code>
 <code class="nb">imageline</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="mi">255</code> <code class="o">-</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">20</code><code class="p">,</code> <code class="mi">255</code> <code class="o">-</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">39</code><code class="p">,</code> <code class="nv">$x</code> <code class="o">&lt;&lt;</code> <code class="mi">8</code><code class="p">);</code>
 <code class="nb">imageline</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">40</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="mi">59</code><code class="p">,</code> <code class="nv">$x</code><code class="o">&lt;&lt;</code><code class="mi">16</code><code class="p">);</code>
<code class="p">}</code>

<code class="nb">header</code><code class="p">(</code><code class="s2">"Content-Type: image/png"</code><code class="p">);</code>
<code class="nb">imagepng</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code></pre>
<p class="pagebreak-before"><a data-type="xref" href="#the_color_test">Figure 10-15</a> shows the output of the color-testing program.</p>
<figure><div id="the_color_test" class="figure">
<img src="Images/php4_1015.png" alt="The color test" width="281" height="87"/>
<h6><span class="label">Figure 10-15. </span>The color test</h6>
</div></figure>
<p>Obviously it will be much more colorful than what we can show you here in black and white print, so try this example for yourself. In this particular example, it is much easier to simply calculate the pixel color than to call <code>imagecolorallocatealpha()</code> for every color.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_true_color" id="idm45922758101816"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_true_color_index" id="idm45922758100440"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Text Representation of an Image"><div class="sect2" id="text_representation_of_an_image">
<h2>Text Representation of an Image</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="text representation of image" id="idm45922758097448"/><a contenteditable="false" data-type="indexterm" data-primary="graphics" data-secondary="text representation of" id="idm45922758096152"/>An interesting use of the <a contenteditable="false" data-type="indexterm" data-primary="imagecolorat function" id="idm45922758094648"/><code>imagecolorat()</code> function is to loop through each pixel in an image and do something with that color data. <a data-type="xref" href="#example_onezero_onefourdot_converting_a">Example 10-14</a> prints <code>#</code> for each pixel in the image <em>php-tiny.jpg</em> in that pixel’s color.</p>
<div data-type="example" id="example_onezero_onefourdot_converting_a">
<h5><span class="label">Example 10-14. </span>Converting an image to text</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;&lt;body</code> <code class="na">bgcolor=</code><code class="s">"#000000"</code><code class="nt">&gt;</code>

<code class="nt">&lt;tt&gt;</code><code class="cp">&lt;?php</code>
<code class="nv">$image</code> <code class="o">=</code> <code class="nb">imagecreatefromjpeg</code><code class="p">(</code><code class="s2">"php_logo_tiny.jpg"</code><code class="p">);</code>

<code class="nv">$dx</code> <code class="o">=</code> <code class="nb">imagesx</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code>
<code class="nv">$dy</code> <code class="o">=</code> <code class="nb">imagesy</code><code class="p">(</code><code class="nv">$image</code><code class="p">);</code>

<code class="k">for</code> <code class="p">(</code><code class="nv">$y</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$y</code> <code class="o">&lt;</code> <code class="nv">$dy</code><code class="p">;</code> <code class="nv">$y</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">for</code> <code class="p">(</code><code class="nv">$x</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$x</code> <code class="o">&lt;</code> <code class="nv">$dx</code><code class="p">;</code> <code class="nv">$x</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$colorIndex</code> <code class="o">=</code> <code class="nb">imagecolorat</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$x</code><code class="p">,</code> <code class="nv">$y</code><code class="p">);</code>
 <code class="nv">$rgb</code> <code class="o">=</code> <code class="nb">imagecolorsforindex</code><code class="p">(</code><code class="nv">$image</code><code class="p">,</code> <code class="nv">$colorIndex</code><code class="p">);</code>

 <code class="nb">printf</code><code class="p">(</code><code class="s1">'&lt;font color=#%02x%02x%02x&gt;#&lt;/font&gt;'</code><code class="p">,</code>
 <code class="nv">$rgb</code><code class="p">[</code><code class="s1">'red'</code><code class="p">],</code> <code class="nv">$rgb</code><code class="p">[</code><code class="s1">'green'</code><code class="p">],</code> <code class="nv">$rgb</code><code class="p">[</code><code class="s1">'blue'</code><code class="p">]);</code>
 <code class="p">}</code>

 <code class="k">echo</code> <code class="s2">"&lt;br&gt;</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="p">}</code> <code class="cp">?&gt;</code><code class="nt">&lt;/tt&gt;</code>

<code class="nt">&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
<p class="pagebreak-before">The result is an ASCII representation of the image, as shown in <a data-type="xref" href="#ascii_representation_of_an_image">Figure 10-16</a>.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_ch10" id="idm45922757821656"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_graphics_colors" id="idm45922757820344"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_colors_graphics" id="idm45922757818968"/></p>
<figure><div id="ascii_representation_of_an_image" class="figure">
<img src="Images/php4_1016.png" alt="ASCII representation of an image" width="253" height="250"/>
<h6><span class="label">Figure 10-16. </span>ASCII representation of an image</h6>
</div></figure>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What’s Next"><div class="sect1" id="whatapostrophes_next-id00068">
<h1>What’s Next</h1>
<p>There are many different ways to manipulate images on the fly with PHP. This certainly dispels the myth that PHP is useful only for generating web HTML content. If you have the time and desire to explore what’s possible in more depth, feel free to experiment with the code samples here. In the next chapter we’ll be looking at another myth-buster in generating dynamic PDF documents. Stay tuned!</p>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="ch10fn1"><sup><a href="ch10.xhtml#ch10fn1-marker">1</a></sup> This is true only for images with a color palette. True color images created using <code>ImageCreateTrueColor()</code> do not obey this rule.</p><p data-type="footnote" id="ch10fn2"><sup><a href="ch10.xhtml#ch10fn2-marker">2</a></sup> UTF-8 is an 8-bit Unicode (<a href="http://www.unicode.org"><em class="hyperlink">http://www.unicode.org</em></a>) encoding scheme.</p></div></div></section></div>



  </body></html>