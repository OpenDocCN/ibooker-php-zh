<html><head></head><body><section data-pdf-bookmark="Chapter 12. Testing" data-type="chapter" epub:type="chapter"><div class="chapter" id="testing">&#13;
<h1><span class="label">Chapter 12. </span>Testing</h1>&#13;
&#13;
&#13;
<p>Most developers know that testing your code is a good thing. We’re supposed to do it. We likely have an idea of why it’s good, and we might’ve even read some tutorials about how it’s supposed to work.</p>&#13;
&#13;
<p>But the gap between knowing <em>why</em> you should test and knowing <em>how</em> to test is wide. Thankfully, tools like PHPUnit, Mockery, and PHPSpec provide an incredible number of options for testing in PHP—but it can still be pretty overwhelming to get everything set up.</p>&#13;
&#13;
<p>Out<a data-primary="testing" data-secondary="options included in Laravel" data-type="indexterm" id="id1484"/> of the box, Laravel comes with baked-in integrations to PHPUnit (unit testing), Mockery (mocking), and Faker (creating fake data for seeding and testing). It also provides its own simple and powerful suite of application testing tools, which allow you to “crawl” your site’s URIs, submit forms, check HTTP status codes, and validate and assert against JSON. It also provides a robust frontend testing framework called Dusk that can even interact with your JavaScript applications and test against them. In case this hasn’t made it clear, we’re going to cover a lot of ground in this chapter.</p>&#13;
&#13;
<p>To make it easy for you to get started, Laravel’s testing setup comes with sample application tests that can run successfully the moment you create a new app. That means you don’t have to spend any time configuring your testing environment, and that’s one less barrier to writing your tests.</p>&#13;
<section class="pagebreak-before" data-pdf-bookmark="Testing Basics" data-type="sect1"><div class="sect1" id="testing_basics">&#13;
<h1 class="less_space">Testing Basics</h1>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1485">&#13;
<h1>Testing Terms</h1>&#13;
<p>It’s<a data-primary="testing" data-secondary="terminology used in" data-type="indexterm" id="id1486"/> hard to get any group of programmers to agree on one set of terms to define different types of tests.</p>&#13;
&#13;
<p>In this chapter, I’ll use four primary terms:</p>&#13;
<dl>&#13;
<dt>Unit tests</dt>&#13;
<dd>&#13;
<p>Unit tests<a data-primary="unit tests" data-secondary="purpose of" data-type="indexterm" id="id1487"/> target small, relatively isolated units—​a class or method, usually.</p>&#13;
</dd>&#13;
<dt>Feature tests</dt>&#13;
<dd>&#13;
<p>Feature tests<a data-primary="feature tests" data-type="indexterm" id="id1488"/> test the way individual units work together and pass messages.</p>&#13;
</dd>&#13;
<dt>Application tests</dt>&#13;
<dd>&#13;
<p>Often<a data-primary="application tests" data-type="indexterm" id="id1489"/><a data-primary="acceptance tests" data-type="indexterm" id="id1490"/><a data-primary="functional tests" data-type="indexterm" id="id1491"/> called acceptance or functional tests, application tests test the entire behavior of the application, usually at an outer boundary, like HTTP calls.</p>&#13;
</dd>&#13;
<dt>Regression tests</dt>&#13;
<dd>&#13;
<p>Similar<a data-primary="regression tests" data-type="indexterm" id="id1492"/> to application tests, regression tests are a little more focused on describing exactly what a user should be able to do and ensuring that behavior doesn’t stop working. The line between application and regression tests is thin, but the difference is primarily based on the level of fidelity of your tests. For example, an application test might say “browser can <code>POST</code> to the <code>people</code> endpoint and then there should be a new entry in the <code>users</code> table” (relatively low fidelity, because you are mimicking what the browser is doing), but a regression test would more likely say “after clicking this button with this form data entered, the user should see that result on that page” (higher fidelity, because you’re describing the actual behavior of your users).</p>&#13;
</dd>&#13;
</dl>&#13;
</div></aside>&#13;
&#13;
<p>Tests in Laravel<a data-primary="testing" data-secondary="basics of" data-type="indexterm" id="Tbasic12"/> live in the <em>tests</em> folder. There are two files in the root: <em>TestCase.php</em>, which is the base root test that all of your tests will extend, and <em>CreatesApplication.php</em>, a trait (imported by <em>TestCase.php</em>) that allows any class to boot a sample Laravel application for testing.</p>&#13;
<div data-type="note" epub:type="note"><h1>Laravel test Command</h1>&#13;
<p>Laravel<a data-primary="testing" data-secondary="Laravel test command" data-type="indexterm" id="id1493"/> has an Artisan command for running your tests: <code>php artisan test</code>. It’s a wrapper around the <code>./vendor/bin/phpunit</code> command, which will additionally show more output for each test.</p>&#13;
</div>&#13;
&#13;
<p>There are also two subfolders: <em>Features</em>, for tests that cover the interaction between multiple units, and <em>Unit</em>, for tests that are intended to cover just one unit of your code (class, module, function, etc.). Each of these folders contains an <em>ExampleTest.php</em> file, each of which has a single sample test inside it, ready to run.</p>&#13;
&#13;
<p>The <code>ExampleTest</code> in your <em>Unit</em> directory contains one simple assertion: <code>$this</code><span class="keep-together"><code>-&gt;</code></span><code>assertTrue(true)</code>. Anything in your unit tests is likely to be relatively simple PHPUnit syntax (asserting that values are equal or different, looking for entries in arrays, checking Booleans, etc.), so there’s not much to learn there.</p>&#13;
<div data-type="tip"><h1>The Basics of PHPUnit Assertions</h1>&#13;
<p>In PHPUnit, most<a data-primary="PHPUnit assertions" data-type="indexterm" id="id1494"/><a data-primary="assertions" data-secondary="basics of" data-type="indexterm" id="id1495"/> of our assertions will be run on the <code>$this</code> object with this syntax:</p>&#13;
<pre data-code-language="php" data-type="program-listing">&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><em><code class="na">assertWHATEVER</code></em><code class="p">(</code><em><code class="nv">$expected</code></em><code class="p">,</code><code> </code><em><code class="nv">$real</code></em><code class="p">);</code><code>&#13;
</code></pre>&#13;
&#13;
<p>So, for example, if we’re asserting that two variables should be equal, we’ll pass it first our expected result, and second the actual outcome of the object or system we’re testing:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$multiplicationResult</code> <code class="o">=</code> <code class="nv">$myCalculator</code><code class="o">-&gt;</code><code class="na">multiply</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">3</code><code class="p">);</code>&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEqual</code><code class="p">(</code><code class="mi">15</code><code class="p">,</code> <code class="nv">$multiplicationResult</code><code class="p">);</code></pre>&#13;
</div>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#EX1201">Example 12-1</a>, the <code>ExampleTest</code> in the <em>Feature</em> directory makes a simulated HTTP request to the page at the root path of your application and checks that its HTTP status is 200 (successful). If it is, it’ll pass; if not, it’ll fail. Unlike your average PHPUnit test, we’re running these assertions on the <code>TestResponse</code> object that’s returned when we make test HTTP calls.</p>&#13;
<div data-type="example" id="EX1201">&#13;
<h5><span class="label">Example 12-1. </span>tests/Feature/ExampleTest.php</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Tests\Feature</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// use Illuminate\Foundation\Testing\RefreshDatabase;</code>&#13;
<code class="k">use</code> <code class="nx">Tests\TestCase</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ExampleTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * A basic test example.</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">test_the_application_returns_a_successful_response</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>&#13;
&#13;
        <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To run the tests, run <code>php artisan test</code> on the command line from the root folder of your application. You should see something like the output in <a data-type="xref" href="#EX1202">Example 12-2</a>.</p>&#13;
<div data-type="example" id="EX1202">&#13;
<h5><span class="label">Example 12-2. </span>Sample <code>ExampleTest</code> output</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="w">  </code>PASS<code class="w">  </code>Tests<code class="se">\U</code>nit<code class="se">\E</code>xampleTest<code class="w"/>&#13;
<code class="w">  </code>✓<code class="w"> </code>that<code class="w"> </code><code class="nb">true</code><code class="w"> </code>is<code class="w"> </code><code class="nb">true</code><code class="w"/>&#13;
&#13;
<code class="w">   </code>PASS<code class="w">  </code>Tests<code class="se">\F</code>eature<code class="se">\E</code>xampleTest<code class="w"/>&#13;
<code class="w">  </code>✓<code class="w"> </code>the<code class="w"> </code>application<code class="w"> </code>returns<code class="w"> </code>a<code class="w"> </code>successful<code class="w"> </code>response<code class="w"/>&#13;
&#13;
<code class="w">  </code>Tests:<code class="w">  </code><code class="m">2</code><code class="w"> </code>passed<code class="w"> </code><code class="o">(</code><code class="m">2</code><code class="w"> </code>assertions<code class="o">)</code><code class="w"/>&#13;
<code class="w">  </code>Time:<code class="w">   </code><code class="m">0</code>.25s<code class="w"/></pre></div>&#13;
&#13;
<p>You just ran your first Laravel application test! Those two checkmarks indicate that you have two passing tests. As you can see, you’re set up out of the box not only with a functioning PHPUnit instance, but also a full-fledged application testing suite that can make mock HTTP calls and test your application’s responses.</p>&#13;
&#13;
<p>In case you’re not familiar with PHPUnit, let’s take a look at what it’s like to have a test fail. Instead of modifying the previous test, we’ll make our own. Run <code>php artisan make:test FailingTest</code>. This will create the file <em>tests/Feature/FailingTest.php</em>; you can modify its <code>testExample()</code> method to look like <a data-type="xref" href="#EX1203">Example 12-3</a>.</p>&#13;
<div data-type="example" id="EX1203">&#13;
<h5><span class="label">Example 12-3. </span>tests/Feature/FailingTest.php, edited to fail</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_example</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">301</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, it’s the same as the test we ran previously, but we’re now testing against the wrong status. Let’s run PHPUnit again.</p>&#13;
<div data-type="tip"><h1>Generating Unit Tests</h1>&#13;
<p>If<a data-primary="unit tests" data-secondary="generating" data-type="indexterm" id="id1496"/> you want your test to be generated in the <code>Unit</code> directory instead of the <code>Feature</code> directory, pass the <code>--unit</code> flag:&#13;
<a data-primary="--unit flag" data-type="indexterm" id="id1497"/></p>&#13;
&#13;
<pre data-type="programlisting">php artisan make:test SubscriptionTest --unit</pre>&#13;
</div>&#13;
&#13;
<p>Whoops! This time the output will probably look a bit like <a data-type="xref" href="#EX1204">Example 12-4</a>.</p>&#13;
<div data-type="example" id="EX1204">&#13;
<h5><span class="label">Example 12-4. </span>Sample failing test output</h5>&#13;
&#13;
<pre data-type="programlisting">   PASS  Tests\Unit\ExampleTest&#13;
  ✓ that true is true&#13;
&#13;
   PASS  Tests\Feature\ExampleTest&#13;
  ✓ the application returns a successful response&#13;
&#13;
   FAIL  Tests\Feature\FailingTest&#13;
  ✕ example&#13;
&#13;
  FAILED  Tests\Feature\FailingTest &gt; example&#13;
  Expected status code [301] but received 200. Failed asserting that&#13;
    301 is identical to 200.&#13;
&#13;
  at tests/Feature/FailingTest.php:20&#13;
    16|     public function test_example()&#13;
    17|     {&#13;
    18|         $response = $this-&gt;get('/');&#13;
    19|&#13;
  &gt; 20|         $response-&gt;assertStatus(301);&#13;
    21|     }&#13;
    22| }&#13;
    23|&#13;
&#13;
  Tests:  1 failed, 2 passed (3 assertions)&#13;
  Duration: 1.10s</pre></div>&#13;
&#13;
<p>Let’s break this down. Last time there were two passing tests, but this time one failed and two passed.</p>&#13;
&#13;
<p>Then, for each error, we see the test name (here, <code>Test\Feature\FailingTest &gt; example</code>), the error message (“Expected status code...”), and a partial stack trace, so we can see the line where the failure occurred.</p>&#13;
&#13;
<p>Now that we’ve run both a passing test and a failing test, it’s time for you to learn more about Laravel’s testing environment.<a data-primary="" data-startref="Tbasic12" data-type="indexterm" id="id1498"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Naming Tests" data-type="sect1"><div class="sect1" id="id467">&#13;
<h1>Naming Tests</h1>&#13;
&#13;
<p>By<a data-primary="testing" data-secondary="naming of" data-type="indexterm" id="id1499"/><a data-primary="names and naming" data-secondary="tests" data-type="indexterm" id="id1500"/> default, Laravel’s testing system will run any file in the <em>tests</em> directory whose name ends with the word <em>Test</em>. That’s why <em>tests/ExampleTest.php</em> was run by default.</p>&#13;
&#13;
<p>If you’re not familiar with PHPUnit, you might not know that only the methods in your tests with names that start with the word <code>test</code> will be run—or methods with a <code>@test</code> documentation block, or <em>docblock</em>. See <a data-type="xref" href="#EX1205">Example 12-5</a> for which methods will and won’t run.</p>&#13;
<div data-type="example" id="EX1205">&#13;
<h5><span class="label">Example 12-5. </span>Naming PHPUnit methods</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">NamingTest</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_names_things_well</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Runs as "It names things well"</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">testItNamesThingsWell</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Runs as "It names things well"</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/** @test */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">it_names_things_well</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Runs as "It names things well"</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">it_names_things_well</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Doesn't run</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Testing Environment" data-type="sect1"><div class="sect1" id="id468">&#13;
<h1>The Testing Environment</h1>&#13;
&#13;
<p>Any<a data-primary="testing" data-secondary="environment for" data-type="indexterm" id="id1501"/><a data-primary="development environment" data-secondary="for testing" data-secondary-sortas="testing" data-type="indexterm" id="id1502"/> time a Laravel application is running, it has a current “environment” name <span class="keep-together">that represents</span> the environment it’s running in. This name may be set to <code>local</code>, <code class="keep-together">staging</code>, <code>production</code>, or anything else you want. You can retrieve this by running <code>app()-&gt;environment()</code>, or you can run <code class="keep-together">if (app()-&gt;</code><code>environment('local'))</code> or something similar to test whether the current environment matches the passed name.</p>&#13;
&#13;
<p>When you run tests, Laravel automatically sets the environment to <code>testing</code>. This means you can test for <code>if (app()-&gt;environment('testing'))</code> to enable or disable certain behaviors in the testing environment.</p>&#13;
&#13;
<p>Additionally, Laravel doesn’t load the normal environment variables from <em>.env</em> for testing. If you want to set any environment variables for your tests, edit <em>phpunit.xml</em> and, in the <code>&lt;php&gt;</code> section, add a new <code>&lt;env&gt;</code> for each environment variable you want to pass in—for example, <code>&lt;env name="DB_CONNECTION" value="sqlite"/&gt;</code>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1503">&#13;
<h1>Using .env.testing to Exclude Testing Environment <br/>Variables from Version Control</h1>&#13;
<p>If<a data-primary="variables" data-secondary="excluding from testing" data-type="indexterm" id="id1504"/> you want to set environment variables for your tests, you can do so in <em>phpunit.xml</em> as just described. But what if you have environment variables for your tests that you want to be different for each testing environment? Or what if you want them to be excluded from source control?</p>&#13;
&#13;
<p>Thankfully, handling these conditions is pretty easy. First, create an <em>.env.testing.example</em> file, just like Laravel’s <em>.env.example</em> file. Next, add the variables you’d like to be environment-specific to <em>.env.testing.example</em>, just like they’re set in <em>.env.example</em>. Then, make a copy of <em>.env.testing.example</em> and name it <em>.env.testing</em>. Finally, add <em>.env.testing</em> to your <em>.gitignore</em> file just below <em>.env</em> and set any values you want in <em>.env.testing</em>.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Testing Traits" data-type="sect1"><div class="sect1" id="id469">&#13;
<h1>The Testing Traits</h1>&#13;
&#13;
<p>Before<a data-primary="testing" data-secondary="testing traits" data-type="indexterm" id="id1505"/> we get into the methods you can use for testing, you need to know about the four testing traits you can pull into any test class.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="RefreshDatabase" data-type="sect2"><div class="sect2" id="id231">&#13;
<h2>RefreshDatabase</h2>&#13;
&#13;
<p><code>Illuminate\Foundation\Testing\RefreshDatabase</code> is<a data-primary="RefreshDatabase" data-type="indexterm" id="id1506"/> imported at the top of every newly generated test file, and it’s the most commonly used database migration trait.</p>&#13;
&#13;
<p>The point of this, and the other database traits, is to ensure your database tables are correctly migrated at the start of each test.</p>&#13;
&#13;
<p><code>RefreshDatabase</code> takes two steps to do this. First, it runs your migrations on your test database <em>once</em> at the beginning of each test run (when you run <code>phpunit</code>, not for each individual test method). And second, it wraps each individual test method in a database transaction and rolls back the transaction at the end of the test.</p>&#13;
&#13;
<p>That means you have your database migrated for your tests and cleared out fresh after each test runs, without having to run your migrations again before every test—making this the fastest possible option. When in doubt, stick with this.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="DatabaseMigrations" data-type="sect2"><div class="sect2" id="id579">&#13;
<h2>DatabaseMigrations</h2>&#13;
&#13;
<p>If<a data-primary="databases" data-secondary="testing" data-tertiary="database migrations" data-type="indexterm" id="id1507"/> you import the <code>Illuminate\Foundation\Testing\DatabaseMigrations</code> trait instead of the <code>RefreshDatabase</code> trait, it will run your entire set of database migrations fresh before each test. Laravel makes this happen by running <code>php artisan migrate:fresh</code> in the <code>setUp()</code> method before every test runs.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="DatabaseTransactions" data-type="sect2"><div class="sect2" id="id580">&#13;
<h2>DatabaseTransactions</h2>&#13;
&#13;
<p>On the other hand, <code>Illuminate\Foundation\Testing\DatabaseTransactions</code> <a data-primary="databases" data-secondary="testing" data-tertiary="database transactions" data-type="indexterm" id="id1508"/> expects your database to be properly migrated before your tests start. It wraps every test in a database transaction, which it rolls back at the end of each test. This means that, at the end of each test, your database will be returned to the exact same state it was in prior to the test.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="WithoutMiddleware" data-type="sect2"><div class="sect2" id="id470">&#13;
<h2>WithoutMiddleware</h2>&#13;
&#13;
<p>If<a data-primary="middleware" data-secondary="testing" data-type="indexterm" id="id1509"/> you import <code>Illuminate\Foundation\Testing\WithoutMiddleware</code> into your test class, it will disable all middleware for any test in that class. This means you won’t have to worry about the authentication middleware, or CSRF protection, or anything else that might be useful in the real application but distracting in a test.</p>&#13;
&#13;
<p>If you’d like to disable middleware for just a single method instead of the entire test class, call <code>$this-&gt;withoutMiddleware()</code> at the top of the method for that test.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Simple Unit Tests" data-type="sect1"><div class="sect1" id="id471">&#13;
<h1>Simple Unit Tests</h1>&#13;
&#13;
<p>With<a data-primary="testing" data-secondary="simple unit tests" data-type="indexterm" id="id1510"/><a data-primary="unit tests" data-secondary="simple unit tests" data-type="indexterm" id="id1511"/> simple unit tests, you almost don’t need any of these traits. You <em>may</em> reach for database access or inject something out of the container, but it’s very likely that unit tests in your applications won’t rely on the framework very much. Take a look at <a data-type="xref" href="#simple_unit_test">Example 12-6</a> for an example of what a simple test might look like.</p>&#13;
<div data-type="example" id="simple_unit_test">&#13;
<h5><span class="label">Example 12-6. </span>A simple unit test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">GeometryTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_calculates_area</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$square</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Square</code><code class="p">;</code>&#13;
        <code class="nv">$square</code><code class="o">-&gt;</code><code class="na">sideLength</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>&#13;
&#13;
        <code class="nv">$calculator</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">GeometryCalculator</code><code class="p">;</code>&#13;
&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEquals</code><code class="p">(</code><code class="mi">16</code><code class="p">,</code> <code class="nv">$calculator</code><code class="o">-&gt;</code><code class="na">area</code><code class="p">(</code><code class="nv">$square</code><code class="p">));</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Obviously, this example is a bit contrived. But you can see here that we’re testing a single class (<code>GeometryCalculator</code>) and its single method (<code>area()</code>), and we’re doing so without worrying about the entire Laravel application.</p>&#13;
&#13;
<p>Some unit tests might be testing something that technically is connected to the framework—​for example, Eloquent models—​but you can still test them without worrying about the framework. For example, in <a data-type="xref" href="#complex_unit_test">Example 12-7</a>, we use <code>Package::make()</code> instead of <code>Package::create()</code> so the object is created and evaluated in memory without ever hitting the database.</p>&#13;
<div data-type="example" id="complex_unit_test">&#13;
<h5><span class="label">Example 12-7. </span>A more complicated unit test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">PopularityTest</code> <code class="k">extends</code> <code class="nx">TestCase</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">RefreshDatabase</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">test_votes_matter_more_than_views</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$package1</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">make</code><code class="p">([</code><code class="s1">'votes'</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'views'</code> <code class="o">=&gt;</code> <code class="mi">0</code><code class="p">]);</code>&#13;
        <code class="nv">$package2</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">make</code><code class="p">([</code><code class="s1">'votes'</code> <code class="o">=&gt;</code> <code class="mi">0</code><code class="p">,</code> <code class="s1">'views'</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">]);</code>&#13;
&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$package1</code><code class="o">-&gt;</code><code class="na">popularity</code> <code class="o">&gt;</code> <code class="nv">$package2</code><code class="o">-&gt;</code><code class="na">popularity</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Some people may call this an integration or feature test, since this “unit” will likely touch the database in actual usage and it’s connected to the entire Eloquent codebase. The most important point is that you can have simple tests that test a single class or method, even when the objects under test are framework-connected.</p>&#13;
&#13;
<p>All of this said, it’s still going to be more likely that your tests—​especially as you first get started—​are broader and more at the “application” level. Accordingly, for the rest of the chapter we’re going to dig deeper into application testing.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Application Testing: How It Works" data-type="sect1"><div class="sect1" id="id232">&#13;
<h1>Application Testing: How It Works</h1>&#13;
&#13;
<p>In <a data-type="xref" href="#testing_basics">“Testing Basics”</a> we<a data-primary="testing" data-secondary="application testing" data-type="indexterm" id="id1512"/><a data-primary="application tests" data-type="indexterm" id="id1513"/> saw that, with a <span class="keep-together">few lines</span> of code, we can “request”  URIs in our application and actually check the status of the response. But how can PHPUnit request pages as if it were <span class="keep-together">a browser?</span></p>&#13;
&#13;
<p>Any application tests should extend the <code>TestCase</code> class (<em>tests/TestCase.php</em>) that’s included with Laravel by default. Your application’s <code>TestCase</code> class will extend the abstract <code>Illuminate\Foundation\Testing\TestCase</code> class, which brings in quite a few goodies.</p>&#13;
&#13;
<p>The first thing the two <code>TestCase</code> classes (yours and its abstract parent) do is handle booting the Illuminate application instance for you, so you have a fully bootstrapped application available. They also “refresh” the application between each test, which means they’re not <em>entirely</em> recreating the application between tests but rather making sure you don’t have any data lingering.</p>&#13;
&#13;
<p>The parent <code>TestCase</code> also sets up a system of hooks that allow callbacks to be run before and after the application is created, and imports a series of traits that provide you with methods for interacting with every aspect of your application. These traits include <code>InteractsWithContainer</code>, <code>MakesHttpRequests</code>, and <code>InteractsWithConsole</code>, and they bring in a broad variety of custom assertions and testing methods.</p>&#13;
&#13;
<p>As a result, your application tests have access to a fully bootstrapped application instance and application-test-minded custom assertions, with a series of simple and powerful wrappers around each to make them easy to use.</p>&#13;
&#13;
<p>That means you can write <code>$this-&gt;get('/')-&gt;assertStatus(200)</code> and know that your application is actually behaving as if it were responding to a normal HTTP request, and that the response is being fully generated and then checked as a browser would check it. It’s pretty powerful stuff, considering how little work you had to do to get it running.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="HTTP Tests" data-type="sect1"><div class="sect1" id="id233">&#13;
<h1>HTTP Tests</h1>&#13;
&#13;
<p>Let’s<a data-primary="HTTP tests" data-type="indexterm" id="HTTPtests12"/><a data-primary="testing" data-secondary="HTTP tests" data-type="indexterm" id="Thttp12"/> take a look at our options for writing HTTP-based tests. You’ve already  seen <code>$this-&gt;get('/')</code>, but let’s dive deeper into how you can use that call, how you can assert against its results, and what other HTTP calls you can make.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing Basic Pages with $this-&gt;get() and Other HTTP Calls" data-type="sect2"><div class="sect2" id="id234">&#13;
<h2>Testing Basic Pages with $this-&gt;get() and Other HTTP Calls</h2>&#13;
&#13;
<p>At<a data-primary="HTTP tests" data-secondary="with $this-&gt;get() and other HTTP calls" data-secondary-sortas="$this-&gt;get() and other HTTP calls" data-type="indexterm" id="id1514"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="with $this-&gt;get() and other HTTP calls" data-tertiary-sortas="$this-&gt;get() and other HTTP calls" data-type="indexterm" id="id1515"/><a data-primary="$this-&gt;get() method" data-type="indexterm" id="id1516"/> the very basic level, Laravel’s HTTP testing allows you to make simple HTTP requests (<code>GET</code>, <code>POST</code>, etc.) and then make simple assertions about their impact or response.</p>&#13;
&#13;
<p>There are more tools we’ll cover later (<a data-type="xref" href="#dusk_testing">“Testing with Dusk”</a>) that allow for more complex page interactions and assertions, but let’s start at the base level. Here are the calls you can make:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>$this-&gt;get(<em>$uri, $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;post(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;put(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;patch(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;delete(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;option(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These methods are the basis of the HTTP testing framework. Each takes at least a URI (usually relative) and headers, and all but <code>get()</code> also allow for passing data along with the request.</p>&#13;
&#13;
<p>And, importantly, each returns a <code>$response</code> object that represents the HTTP response. This response object is almost exactly the same as an Illuminate <code>Response</code> object, the same thing we return out of our controllers. However, it’s actually an instance of <code>Illuminate\Testing\TestResponse</code>, which wraps a normal <code>Response</code> with some assertions for testing.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#simple_post_test">Example 12-8</a> to see a common usage of <code>post()</code> and a common response assertion.</p>&#13;
<div data-type="example" id="simple_post_test">&#13;
<h5><span class="label">Example 12-8. </span>A simple use of <code>post()</code> in testing</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_it_stores_new_packages</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.store'</code><code class="p">),</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'The greatest package'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertOk</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>In most examples like <a data-type="xref" href="#simple_post_test">Example 12-8</a>, you’ll also test that the record exists in the database and shows up on the index page, and maybe that it doesn’t test successfully unless you define the package author and are logged in. But don’t worry, we’ll get to all of that. For now, you can make calls to your application routes with many different verbs and make assertions against both the response and the state of your application afterward. Great!</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing JSON APIs with $this-&gt;getJson() and Other JSON HTTP Calls" data-type="sect2"><div class="sect2" id="id235">&#13;
<h2>Testing JSON APIs with $this-&gt;getJson() and Other JSON HTTP Calls</h2>&#13;
&#13;
<p>You<a data-primary="HTTP tests" data-secondary="with $this-&gt;getJson() and other JSON HTTP calls" data-secondary-sortas="$this-&gt;getJson() and other JSON HTTP calls" data-type="indexterm" id="id1517"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="with $this-&gt;getJson() and other JSON HTTP calls" data-tertiary-sortas="$this-&gt;getJson() and other JSON HTTP calls" data-type="indexterm" id="id1518"/><a data-primary="$this-&gt;getJson() method" data-type="indexterm" id="id1519"/><a data-primary="JSON operations" data-secondary="testing JSON APIs" data-type="indexterm" id="id1520"/> can also do all of the same sorts of HTTP tests with your JSON APIs. There are convenience methods for that, too:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>$this-&gt;getJson(<em>$uri, $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;postJson(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;putJson(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;patchJson(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;deleteJson(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>$this-&gt;optionJson(<em>$uri, $data = [], $headers = []</em>)</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>These methods work just the same as the normal HTTP call methods, except they also add JSON-specific <code>Accept</code>, <code>CONTENT_LENGTH</code>, and <code>CONTENT_TYPE</code> headers. Take a look at <a data-type="xref" href="#simple_json_api_test">Example 12-9</a> to see an example.</p>&#13;
<div class="pagebreak-before less_space" data-type="example" id="simple_json_api_test">&#13;
<h5><span class="label">Example 12-9. </span>A simple use of <code>postJson()</code> in testing</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_the_api_route_stores_new_packages</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">postJson</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'api.packages.store'</code><code class="p">),</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'The greatest package'</code><code class="p">,</code>&#13;
    <code class="p">],</code> <code class="p">[</code><code class="s1">'X-API-Version'</code> <code class="o">=&gt;</code> <code class="s1">'17'</code><code class="p">]);</code>&#13;
&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertOk</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Assertions Against $response" data-type="sect2"><div class="sect2" id="id236">&#13;
<h2>Assertions Against $response</h2>&#13;
&#13;
<p>There<a data-primary="$response, assertions against" data-type="indexterm" id="id1521"/><a data-primary="Response objects" data-secondary="assertions against" data-type="indexterm" id="ROassertions12"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="assertions against $response" data-type="indexterm" id="id1522"/><a data-primary="HTTP tests" data-secondary="assertions against $response" data-type="indexterm" id="id1523"/> are more than 50 assertions available on the <code>$response</code> object, so I’ll refer you to the <a href="https://oreil.ly/CXk24">testing docs</a> for details on all of them. Let’s look at a few of the most important and most common ones:</p>&#13;
<dl>&#13;
<dt><code>$response-&gt;assertOk()</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response’s status code is 200:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'terms'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertOk</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertSuccessful()</code></dt>&#13;
<dd>&#13;
<p>Although <code>assertOk()</code> asserts that the code is exactly 200, <code>assertSuccessful()</code> checks if the code is anything in the 200 group:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'articles'</code><code class="p">,</code> <code class="p">[</code>&#13;
    <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'Testing Laravel'</code><code class="p">,</code>&#13;
    <code class="s1">'body'</code>  <code class="o">=&gt;</code> <code class="s1">'My article about testing Laravel'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
<code class="c1">// Assuming this returns 201 CREATED...</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSuccessful</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertUnauthorized()</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response’s status code is 401:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">patch</code><code class="p">(</code><code class="s1">'settings'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="s1">'abc'</code><code class="p">]);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertUnauthorized</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertForbidden()</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response’s status code is 403:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$normalUser</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'admin'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertForbidden</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertNotFound()</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response’s status code is 404:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'posts/first-post'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertNotFound</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertStatus(<em>$status</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response’s status code is equal to the provided <code><em>$status</em></code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'admin'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">401</code><code class="p">);</code> <code class="c1">// Unauthorized</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertSee(<em>$text</em>)</code>, <code>$response-&gt;assertDontSee(<em>$text</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response contains (or doesn’t contain) the provided <code><em>$text</em></code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$package</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.index'</code><code class="p">));</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertJson(<em>array $json</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the passed array is represented (in JSON format) in the returned JSON:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">postJson</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.store'</code><code class="p">),</code> <code class="p">[</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'GreatPackage2000'</code><code class="p">]);</code>&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">getJson</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.index'</code><code class="p">));</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertJson</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'GreatPackage2000'</code><code class="p">]);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertViewHas(<em>$key, $value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the view on the visited page had a piece of data available at <code><em>$key</em></code>, and optionally checks that the value of that variable was <code><em>$value</em></code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$package</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.show'</code><code class="p">));</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertViewHas</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertSessionHas(<em>$key, $value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the session has data set at <code><em>$key</em></code>, and optionally checks that the value of that data is <code><em>$value</em></code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'beta/enable'</code><code class="p">);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHas</code><code class="p">(</code><code class="s1">'beta-enabled'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertSessionHasInput(<em>$key, $value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the given keys and values are flashed in the session array input. This is helpful when testing whether the validation error returns the correct old &#13;
<span class="keep-together">values</span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Abdullah'</code><code class="p">]);</code>&#13;
<code class="c1">// Assuming it errored, check that the entered name is flashed;</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasInput</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Abdullah'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertSessionHasErrors()</code></dt>&#13;
<dd>&#13;
<p>With no parameters, asserts that there’s at least one error set in Laravel’s special <code>errors</code> session container. Its first parameter can be an array of key/value pairs that define the errors that should be set and its second parameter can be the string format that the checked errors should be formatted against, as demonstrated here:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Assuming the "/form" route requires an email field, and we're</code>&#13;
<code class="c1">// posting an empty submission to it to trigger the error</code>&#13;
<code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'form'</code><code class="p">,</code> <code class="p">[]);</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">();</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">([</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'The email field is required.'</code><code class="p">,</code>&#13;
 <code class="p">]);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertSessionHasErrors</code><code class="p">(</code>&#13;
    <code class="p">[</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'&lt;p&gt;The email field is required.&lt;/p&gt;'</code><code class="p">],</code>&#13;
    <code class="s1">'&lt;p&gt;:message&lt;/p&gt;'</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>If you’re working with named error bags, you can pass the error bag name as the third parameter.</p>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertCookie(<em>$name, $value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response contains a cookie with name <code><em>$name</em></code>, and optionally checks that its value is <code><em>$value</em></code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'settings'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'dismiss-warning'</code><code class="p">]);</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertCookie</code><code class="p">(</code><code class="s1">'warning-dismiss'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertCookieExpired(<em>$name</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response contains a cookie with name <code><em>$name</em></code> and that it is expired:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertCookieExpired</code><code class="p">(</code><code class="s1">'warning-dismiss'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertCookieNotExpired(<em>$name</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the response contains a cookie with name <code><em>$name</em></code> and that it is not expired:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertCookieNotExpired</code><code class="p">(</code><code class="s1">'warning-dismiss'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>$response-&gt;assertRedirect(<em>$uri</em>)</code></dt>&#13;
<dd>&#13;
<p>Asserts that the requested route returns a redirect to the given URI:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.store'</code><code class="p">),</code> <code class="p">[</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'invalid'</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertRedirect</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.create'</code><code class="p">));</code></pre>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>For each of these assertions, you can assume that there are many related assertions I haven’t listed here. For example, in addition to <code>assertSessionHasErrors()</code> there are also <code>assertSessionHasNoErrors()</code> and <code>assertSessionHasErrorsIn()</code> assertions; as well as <code>assertJson()</code>, there are also <code>assertJsonCount()</code>, <code>assertJsonFragment()</code>, <code>assertJsonPath()</code>, <code>assertJsonMissing()</code>, <code>assertJsonMissingExact()</code>, <code>assertJsonStructure()</code>, and <code>assertJsonValidationErrors()</code> assertions. Again, take a look at the docs and make yourself familiar with the whole list.<a data-primary="" data-startref="ROassertions12" data-type="indexterm" id="id1524"/></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authenticating Responses" data-type="sect2"><div class="sect2" id="id472">&#13;
<h2>Authenticating Responses</h2>&#13;
&#13;
<p>One<a data-primary="HTTP tests" data-secondary="authenticating responses" data-type="indexterm" id="id1525"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="authenticating responses" data-type="indexterm" id="id1526"/><a data-primary="authentication and authorization" data-secondary="authenticating HTTP responses" data-type="indexterm" id="id1527"/> piece of your application it’s common to test with application tests is authentication and authorization. Most of the time, your needs will be met with the <code>actingAs()</code> chainable method, which takes a user (or other <code>Authenticatable</code> object, depending on how your system is set up), as you can see in <a data-type="xref" href="#basic_auth_in_testing">Example 12-10</a>.</p>&#13;
<div data-type="example" id="basic_auth_in_testing">&#13;
<h5><span class="label">Example 12-10. </span>Basic auth in testing</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_guests_cant_view_dashboard</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">guest</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">401</code><code class="p">);</code> <code class="c1">// Unauthorized</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_members_can_view_dashboard</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">member</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertOk</code><code class="p">();</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_members_and_guests_cant_view_statistics</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$guest</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">guest</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$guest</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'statistics'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">401</code><code class="p">);</code> <code class="c1">// Unauthorized</code>&#13;
&#13;
    <code class="nv">$member</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">member</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$member</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'statistics'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertStatus</code><code class="p">(</code><code class="mi">401</code><code class="p">);</code> <code class="c1">// Unauthorized</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_admins_can_view_statistics</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">admin</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">actingAs</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'statistics'</code><code class="p">);</code>&#13;
    <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">assertOk</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="tip"><h1>Using Factory States for Authorization</h1>&#13;
<p>It’s<a data-primary="authentication and authorization" data-secondary="using factory states for authorization" data-type="indexterm" id="id1528"/><a data-primary="model factories" data-secondary="using for authorization" data-type="indexterm" id="id1529"/> common to use model factories (discussed in <a data-type="xref" href="ch05.html#model_factories">“Model Factories”</a>) in testing, and model factory states make tasks like creating users with different access levels simple.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Few Other Customizations to Your HTTP Tests" data-type="sect2"><div class="sect2" id="id237">&#13;
<h2>A Few Other Customizations to Your HTTP Tests</h2>&#13;
&#13;
<p>If<a data-primary="HTTP tests" data-secondary="customizations for" data-type="indexterm" id="id1530"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="customizations for" data-type="indexterm" id="id1531"/><a data-primary="withSession() method" data-type="indexterm" id="id1532"/> you’d like to set session variables on your requests, you can also chain <span class="keep-together"><code>withSession()</code>:</span></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">withSession</code><code class="p">([</code>&#13;
    <code class="s1">'alert-dismissed'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">);</code></pre>&#13;
&#13;
<p>If you’d prefer to set your request headers fluently, you can chain <code>withHeaders()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">withHeaders</code><code class="p">([</code>&#13;
    <code class="s1">'X-THE-ANSWER'</code> <code class="o">=&gt;</code> <code class="s1">'42'</code><code class="p">,</code>&#13;
<code class="p">])</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'the-restaurant-at-the-end-of-the-universe'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Handling Exceptions in Application Tests" data-type="sect2"><div class="sect2" id="id238">&#13;
<h2>Handling Exceptions in Application Tests</h2>&#13;
&#13;
<p>Usually, an<a data-primary="HTTP tests" data-secondary="handling exceptions in application tests" data-type="indexterm" id="id1533"/><a data-primary="application tests" data-type="indexterm" id="id1534"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="handling exceptions in application tests" data-type="indexterm" id="id1535"/><a data-primary="exceptions" data-secondary="handling in HTTP tests" data-type="indexterm" id="id1536"/> exception that’s thrown inside your application when you’re making HTTP calls will be captured by Laravel’s exception handler and processed as it would be in a normal application. So, the test and route in <a data-type="xref" href="#swallowed_exception">Example 12-11</a> would still pass, since the exception would never bubble up the whole way to our test.</p>&#13;
<div data-type="example" id="swallowed_exception">&#13;
<h5><span class="label">Example 12-11. </span>An exception that will be captured by Laravel’s exception handler and result in a passing test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'has-exceptions'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">throw</code> <code class="k">new</code> <code class="nx">Exception</code><code class="p">(</code><code class="s1">'Stop!'</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// tests/Feature/ExceptionsTest.php</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_exception_in_route</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/has-exceptions'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>In a lot of cases, this might make sense; maybe you’re expecting a validation exception, and you want it to be caught like it would normally be by the framework.</p>&#13;
&#13;
<p>But if you want to temporarily disable the exception handler, that’s an option; just run <code>$this-&gt;withoutExceptionHandling()</code>, as shown in <a data-type="xref" href="#EX12a">Example 12-12</a>.</p>&#13;
<div data-type="example" id="EX12a">&#13;
<h5><span class="label">Example 12-12. </span>Temporarily disabling exception handling in a single test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// tests/Feature/ExceptionsTest.php</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_exception_in_route</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Now throws an error</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">withoutExceptionHandling</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/has-exceptions'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>And if for some reason you need to turn it back on (maybe you turned it off in <code>setUp()</code> but want it back on for just one test), you can run <code>$this</code><span class="keep-together"><code>-&gt;</code></span><code>withExceptionHandling()</code>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Debugging Responses" data-type="sect2"><div class="sect2" id="id239">&#13;
<h2>Debugging Responses</h2>&#13;
&#13;
<p>You<a data-primary="HTTP tests" data-secondary="debugging responses" data-type="indexterm" id="id1537"/><a data-primary="testing" data-secondary="HTTP tests" data-tertiary="debugging responses" data-type="indexterm" id="id1538"/><a data-primary="Response objects" data-secondary="debugging responses" data-type="indexterm" id="id1539"/><a data-primary="dumpHeaders() method" data-type="indexterm" id="id1540"/><a data-primary="dump() method" data-type="indexterm" id="id1541"/> can easily dump out the headers with <code>dumpHeaders()</code> or the body with <code>dump()</code> or <code>dd()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">dumpHeaders</code><code class="p">();</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">dump</code><code class="p">();</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">dd</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also easily dump all or only the specified keys on the<a data-primary="" data-startref="HTTPtests12" data-type="indexterm" id="id1542"/><a data-primary="" data-startref="Thttp12" data-type="indexterm" id="id1543"/> session:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">dumpSession</code><code class="p">();</code>&#13;
<code class="nv">$response</code><code class="o">-&gt;</code><code class="na">dumpSession</code><code class="p">([</code><code class="s1">'message'</code><code class="p">]);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Database Tests" data-type="sect1"><div class="sect1" id="id696">&#13;
<h1>Database Tests</h1>&#13;
&#13;
<p>Often, the effect we want to test for after our tests have run is in the database. Imagine you want to test that the “create package” page works correctly. What’s the best way? Make an HTTP call to the “store package” endpoint and then assert that that package exists in the database. It’s easier and safer than inspecting the resulting “list packages” page.</p>&#13;
&#13;
<p>We have four primary assertions for the database, and two Eloquent-specific &#13;
<span class="keep-together">assertions</span>.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Asserting Against the Database" data-type="sect2"><div class="sect2" id="id240">&#13;
<h2>Asserting Against the Database</h2>&#13;
&#13;
<p>For<a data-primary="databases" data-secondary="testing" data-tertiary="asserting against the database" data-type="indexterm" id="id1544"/><a data-primary="testing" data-secondary="databases" data-tertiary="asserting against the database" data-type="indexterm" id="id1545"/><a data-primary="$this-&gt;assertDatabaseHas() method" data-type="indexterm" id="id1546"/><a data-primary="$this-&gt;assertDatabaseMissing() method" data-type="indexterm" id="id1547"/><a data-primary="$this-&gt;assertDeleted() method" data-type="indexterm" id="id1548"/><a data-primary="assertions" data-secondary="against databases" data-type="indexterm" id="id1549"/><a data-primary="$this-&gt;assertSoftDeleted() method" data-type="indexterm" id="id1550"/> direct assertions agains the database, we have <code>$this-&gt;assertDatabaseHas()</code> and <code>$this-&gt;assertDatabaseMissing()</code>, and <code>$this-&gt;assertDeleted()</code> and <code>$this-&gt;assertSoftDeleted()</code>. For both, pass the table name as the first parameter, the data you’re looking for as the second, and, optionally, the specific database connection you want to test as the third.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#example_database_tests">Example 12-13</a> to see how you might use them.</p>&#13;
<div data-type="example" id="example_database_tests">&#13;
<h5><span class="label">Example 12-13. </span>Sample database tests</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_create_package_page_stores_package</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.store'</code><code class="p">),</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Package-a-tron'</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'packages'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Package-a-tron'</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, the second parameter of <code>assertDatabaseHas()</code> is structured like a SQL <code>WHERE</code> statement—you pass a key and a value (or multiple keys and values), and then Laravel looks for any records in the specified database table that match your key(s) and value(s).</p>&#13;
&#13;
<p>As you’d expect, <code>assertDatabaseMissing()</code> is the inverse.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Asserting Against Eloquent Models" data-type="sect2"><div class="sect2" id="id473">&#13;
<h2>Asserting Against Eloquent Models</h2>&#13;
&#13;
<p>While <code>assertDatabaseHas()</code> and <code>assertDatabaseMissing()</code> allow<a data-primary="databases" data-secondary="testing" data-tertiary="asserting against Eloquent models" data-type="indexterm" id="id1551"/><a data-primary="testing" data-secondary="databases" data-tertiary="asserting against Eloquent models" data-type="indexterm" id="id1552"/><a data-primary="Eloquent" data-secondary="asserting against Eloquent models" data-type="indexterm" id="id1553"/> you to identify rows by passing keys and values, Laravel also provides convenience methods for directly asserting that a given Eloquent record does or does not exist: <code>assertModelExists()</code> and <code>assertModelMissing()</code>, as you can see in <a data-type="xref" href="#database_tests_assert_against_models">Example 12-14</a>.</p>&#13;
<div data-type="example" id="database_tests_assert_against_models">&#13;
<h5><span class="label">Example 12-14. </span>Assert against model existence</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_undeletable_packages_cant_be_deleted</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Create undeletable model</code>&#13;
    <code class="nv">$package</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Package-a-tron'</code><code class="p">,</code>&#13;
        <code class="s1">'is_deletable'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">,</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.delete'</code><code class="p">,</code> <code class="nv">$package</code><code class="p">));</code>&#13;
&#13;
    <code class="c1">// Can check existence or whether it was soft deleted</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertModelExists</code><code class="p">(</code><code class="nv">$package</code><code class="p">);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertNotSoftDeleted</code><code class="p">(</code><code class="nv">$package</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'is_deletable'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.delete'</code><code class="p">,</code> <code class="nv">$package</code><code class="p">));</code>&#13;
&#13;
    <code class="c1">// Can check existence or whether it was soft deleted</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertModelMissing</code><code class="p">(</code><code class="nv">$package</code><code class="p">);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertSoftDeleted</code><code class="p">(</code><code class="nv">$package</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using Model Factories in Tests" data-type="sect2"><div class="sect2" id="id474">&#13;
<h2>Using Model Factories in Tests</h2>&#13;
&#13;
<p>Model factories<a data-primary="databases" data-secondary="testing" data-tertiary="using model factories in" data-type="indexterm" id="id1554"/><a data-primary="testing" data-secondary="databases" data-tertiary="using model factories in" data-type="indexterm" id="id1555"/><a data-primary="model factories" data-secondary="using in tests" data-type="indexterm" id="id1556"/> are amazing tools that make it easy to seed randomized, well-structured database data for testing (or other purposes). You’ve already seen them in use in several examples in this chapter, and we’ve already covered them in depth, so check out <a data-type="xref" href="ch05.html#model_factories">“Model Factories”</a> to learn more.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Seeding in Tests" data-type="sect2"><div class="sect2" id="id475">&#13;
<h2>Seeding in Tests</h2>&#13;
&#13;
<p>If<a data-primary="databases" data-secondary="testing" data-tertiary="seeding in" data-type="indexterm" id="id1557"/><a data-primary="testing" data-secondary="databases" data-tertiary="seeding in" data-type="indexterm" id="id1558"/><a data-primary="seeding" data-secondary="in tests" data-secondary-sortas="tests" data-type="indexterm" id="id1559"/> you use seeds in your application, you can run the equivalent of <code>php artisan db:seed</code> by running <code>$this-&gt;seed()</code> in your test.</p>&#13;
&#13;
<p>You can also pass a seeder class name to just seed that one class:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">seed</code><code class="p">();</code> <code class="c1">// Seeds all</code>&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><code class="na">seed</code><code class="p">(</code><code class="nx">UserSeeder</code><code class="o">::</code><code class="na">class</code><code class="p">);</code> <code class="c1">// Seeds users</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing Other Laravel Systems" data-type="sect1"><div class="sect1" id="id476">&#13;
<h1>Testing Other Laravel Systems</h1>&#13;
&#13;
<p>When<a data-primary="facades" data-secondary="faking for testing" data-type="indexterm" id="Ffaking12"/> testing Laravel systems, you’ll often want to pause their true function for the duration of the testing and instead write tests against what has happened to those systems. You can do this by “faking” different facades, such as <code>Event</code>, <code>Mail</code>, and <code>Notification</code>. We’ll talk more about what fakes are in <a data-type="xref" href="#intro_to_mocking">“Mocking”</a>, but first, let’s look at some examples. All of the following features in Laravel have their own set of assertions you can make after faking them, but you can also just choose to fake them to restrict their effects.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Event Fakes" data-type="sect2"><div class="sect2" id="id477">&#13;
<h2>Event Fakes</h2>&#13;
&#13;
<p>Let’s<a data-primary="testing" data-secondary="other Laravel Systems" data-tertiary="event fakes" data-type="indexterm" id="id1560"/><a data-primary="events" data-secondary="event fakes" data-type="indexterm" id="id1561"/> use event fakes as our first example of how Laravel makes it possible to mock its internal systems. There are likely going to be times when you want to fake events just for the sake of suppressing their actions. For example, suppose your app pushes notifications to Slack every time a new user signs up. You have a “user signed up” event that’s dispatched when this happens, and it has a listener that notifies a Slack channel that a user has signed up. You don’t want those notifications to go to Slack every time you run your tests, but you might want to assert that the event was sent, or the listener was triggered, or something else. This is one reason for faking certain aspects of Laravel in our tests: to pause the default behavior and instead make assertions against the system we’re testing.</p>&#13;
&#13;
<p>Let’s take a look at how to suppress these events by calling the <code>fake()</code> method on <code>Illuminate\Support\Facades\Event</code>, as shown in <a data-type="xref" href="#suppressing_events_with_no_assertions">Example 12-15</a>.</p>&#13;
<div data-type="example" id="suppressing_events_with_no_assertions">&#13;
<h5><span class="label">Example 12-15. </span>Suppressing events without adding assertions</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_controller_does_some_thing</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Call controller and assert it does whatever you want without</code>&#13;
    <code class="c1">// worrying about it pinging Slack</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Once we’ve run the <code>fake()</code> method, we can also call special assertions on the <code>Event</code> facade: namely, <code>assertDispatched()</code> and <code>assertNotDispatched()</code>. Take a look at <a data-type="xref" href="#event_assertions">Example 12-16</a> to see them in use.</p>&#13;
<div data-type="example" id="event_assertions">&#13;
<h5><span class="label">Example 12-16. </span>Making assertions against events</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_signing_up_users_notifies_slack</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Sign user up</code>&#13;
&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">assertDispatched</code><code class="p">(</code><code class="nx">UserJoined</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$event</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$user</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$event</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Or sign multiple users up and assert it was dispatched twice</code>&#13;
&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">assertDispatched</code><code class="p">(</code><code class="nx">UserJoined</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Or sign up with validation failures and assert it wasn't dispatched</code>&#13;
&#13;
    <code class="nx">Event</code><code class="o">::</code><code class="na">assertNotDispatched</code><code class="p">(</code><code class="nx">UserJoined</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Note that the (optional) closure we passed to <code>assertDispatched()</code> means we’re not just asserting that the event was dispatched, but also that the dispatched event contains certain data.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Event::fake() Disables Eloquent Model Events</h1>&#13;
<p><code>Event::fake()</code> also disables Eloquent model events. So if you have any important code, for example, in a model’s <code>creating</code> event, make sure to create your models (through your factories or however else) <em>before</em> calling <code>Event::fake()</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bus and Queue Fakes" data-type="sect2"><div class="sect2" id="id241">&#13;
<h2>Bus and Queue Fakes</h2>&#13;
&#13;
<p>The <code>Bus</code> facade, which<a data-primary="testing" data-secondary="other Laravel Systems" data-tertiary="bus and queue fakes" data-type="indexterm" id="id1562"/><a data-primary="bus fakes" data-type="indexterm" id="id1563"/><a data-primary="queues and queueing" data-secondary="queue fakes" data-type="indexterm" id="id1564"/><a data-primary="fakes" data-secondary="bus and queue fakes" data-type="indexterm" id="id1565"/> represents how Laravel dispatches jobs, works just like <code>Event</code>. You can run <code>fake()</code> on it to disable the impact of your jobs, and after faking it you can run <code>assertDispatched()</code> or <code>assertNotDispatched()</code>.</p>&#13;
&#13;
<p>The <code>Queue</code> facade represents how Laravel dispatches jobs when they’re pushed up to queues. Its available methods are <code>assertedPushed()</code>, <code>assertPushedOn()</code>, and <code>assertNotPushed()</code>.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#job_fakes">Example 12-17</a> to see how to use both.</p>&#13;
<div data-type="example" id="job_fakes">&#13;
<h5><span class="label">Example 12-17. </span>Faking jobs and queued jobs</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_popularity_is_calculated</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Synchronize package data...</code>&#13;
&#13;
    <code class="c1">// Assert a job was dispatched</code>&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">assertDispatched</code><code class="p">(</code>&#13;
        <code class="nx">CalculatePopularity</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="k">function</code> <code class="p">(</code><code class="nv">$job</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">package</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">;</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a job was not dispatched</code>&#13;
    <code class="nx">Bus</code><code class="o">::</code><code class="na">assertNotDispatched</code><code class="p">(</code><code class="nx">DestroyPopularityMaybe</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_popularity_calculation_is_queued</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Queue</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Synchronize package data...</code>&#13;
&#13;
    <code class="c1">// Assert a job was pushed to any queue</code>&#13;
    <code class="nx">Queue</code><code class="o">::</code><code class="na">assertPushed</code><code class="p">(</code>&#13;
        <code class="nx">CalculatePopularity</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="k">function</code> <code class="p">(</code><code class="nv">$job</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$job</code><code class="o">-&gt;</code><code class="na">package</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">;</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a job was pushed to a given queue named "popularity"</code>&#13;
    <code class="nx">Queue</code><code class="o">::</code><code class="na">assertPushedOn</code><code class="p">(</code><code class="s1">'popularity'</code><code class="p">,</code> <code class="nx">CalculatePopularity</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a job was pushed twice</code>&#13;
    <code class="nx">Queue</code><code class="o">::</code><code class="na">assertPushed</code><code class="p">(</code><code class="nx">CalculatePopularity</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a job was not pushed</code>&#13;
    <code class="nx">Queue</code><code class="o">::</code><code class="na">assertNotPushed</code><code class="p">(</code><code class="nx">DestroyPopularityMaybe</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mail Fakes" data-type="sect2"><div class="sect2" id="id242">&#13;
<h2>Mail Fakes</h2>&#13;
&#13;
<p>The<a data-primary="testing" data-secondary="other Laravel Systems" data-tertiary="mail fakes" data-type="indexterm" id="id1566"/><a data-primary="mail fakes" data-type="indexterm" id="id1567"/><a data-primary="fakes" data-secondary="mail fakes" data-type="indexterm" id="id1568"/> <code>Mail</code> facade, when faked, offers four methods: <code>assertSent()</code>, <code>assertNotSent()</code>, <code>assertQueued()</code>, and <code>assertNotQueued()</code>. Use the <code>Queued</code> methods when your mail is queued and the <code>Sent</code> methods when it’s not.</p>&#13;
&#13;
<p>Just like with <code>assertDispatched()</code>, the first parameter will be the name of the &#13;
<span class="keep-together">mailable</span> and the second parameter can be empty, the number of times the mailable has been sent, or a closure testing that the mailable has the right data in it. Take a look at <a data-type="xref" href="#mail_fakes">Example 12-18</a> to see a few of these methods in action.</p>&#13;
<div data-type="example" id="mail_fakes">&#13;
<h5><span class="label">Example 12-18. </span>Making assertions against mail</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_package_authors_receive_launch_emails</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Mail</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Make a package public for the first time...</code>&#13;
&#13;
    <code class="c1">// Assert a message was sent to a given email address</code>&#13;
    <code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="nx">PackageLaunched</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$mail</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">package</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Assert a message was sent to given email addresses</code>&#13;
    <code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="nx">PackageLaunched</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$mail</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">hasTo</code><code class="p">(</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">author</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">)</code> <code class="o">&amp;&amp;</code>&#13;
               <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">hasCc</code><code class="p">(</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">collaborators</code><code class="p">)</code> <code class="o">&amp;&amp;</code>&#13;
               <code class="nv">$mail</code><code class="o">-&gt;</code><code class="na">hasBcc</code><code class="p">(</code><code class="s1">'admin@novapackages.com'</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="c1">// Or, launch two packages...</code>&#13;
&#13;
    <code class="c1">// Assert a mailable was sent twice</code>&#13;
    <code class="nx">Mail</code><code class="o">::</code><code class="na">assertSent</code><code class="p">(</code><code class="nx">PackageLaunched</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a mailable was not sent</code>&#13;
    <code class="nx">Mail</code><code class="o">::</code><code class="na">assertNotSent</code><code class="p">(</code><code class="nx">PackageLaunchFailed</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>All of the messages checking for recipients (<code>hasTo()</code>, <code>hasCc()</code>, and <code>hasBcc()</code>) can take either a single email address or an array or collection of addresses.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Notification Fakes" data-type="sect2"><div class="sect2" id="id243">&#13;
<h2>Notification Fakes</h2>&#13;
&#13;
<p>The<a data-primary="testing" data-secondary="other Laravel Systems" data-tertiary="notification fakes" data-type="indexterm" id="id1569"/><a data-primary="notification fakes" data-type="indexterm" id="id1570"/><a data-primary="fakes" data-secondary="notification fakes" data-type="indexterm" id="id1571"/> <code>Notification</code> facade, when faked, offers two methods: <code>assertSentTo()</code> and <code>assertNothingSent()</code>.</p>&#13;
&#13;
<p>Unlike with the <code>Mail</code> facade, you’re not going to test who the notification was sent to manually in a closure. Rather, the assertion itself requires the first parameter be either a single notifiable object or an array or collection of them. Only after you’ve passed in the desired notification target can you test anything about the notification itself.</p>&#13;
&#13;
<p>The second parameter is the class name for the notification, and the (optional) third parameter can be a closure defining more expectations about the notification. Take a look at <a data-type="xref" href="#notification_fakes">Example 12-19</a> to learn more.</p>&#13;
<div data-type="example" id="notification_fakes">&#13;
<h5><span class="label">Example 12-19. </span>Notification fakes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_users_are_notified_of_new_package_ratings</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="c1">// Perform package rating...</code>&#13;
&#13;
    <code class="c1">// Assert author was notified</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertSentTo</code><code class="p">(</code>&#13;
        <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">author</code><code class="p">,</code>&#13;
        <code class="nx">PackageRatingReceived</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">,</code> <code class="nv">$channels</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$notification</code><code class="o">-&gt;</code><code class="na">package</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">;</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// Assert a notification was sent to the given users</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertSentTo</code><code class="p">(</code>&#13;
        <code class="p">[</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">collaborators</code><code class="p">],</code> <code class="nx">PackageRatingReceived</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">);</code>&#13;
&#13;
    <code class="c1">// Or, perform a duplicate package rating...</code>&#13;
&#13;
    <code class="c1">// Assert a notification was not sent</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertNotSentTo</code><code class="p">(</code>&#13;
        <code class="p">[</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">author</code><code class="p">],</code> <code class="nx">PackageRatingReceived</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You may also find yourself wanting to assert that your channel selection is working—​that notifications are sent via the right channels. You can test that as well, as you can see in <a data-type="xref" href="#testing_notification_channels">Example 12-20</a>.</p>&#13;
<div data-type="example" id="testing_notification_channels">&#13;
<h5><span class="label">Example 12-20. </span>Testing notification channels</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_users_are_notified_by_their_preferred_channel</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">fake</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code><code class="s1">'slack_preferred'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">]);</code>&#13;
&#13;
    <code class="c1">// Perform package rating...</code>&#13;
&#13;
    <code class="c1">// Assert author was notified via Slack</code>&#13;
    <code class="nx">Notification</code><code class="o">::</code><code class="na">assertSentTo</code><code class="p">(</code>&#13;
        <code class="nv">$user</code><code class="p">,</code>&#13;
        <code class="nx">PackageRatingReceived</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="k">function</code> <code class="p">(</code><code class="nv">$notification</code><code class="p">,</code> <code class="nv">$channels</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$package</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$notification</code><code class="o">-&gt;</code><code class="na">package</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">===</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code>&#13;
                <code class="o">&amp;&amp;</code> <code class="nb">in_array</code><code class="p">(</code><code class="s1">'slack'</code><code class="p">,</code> <code class="nv">$channels</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Storage Fakes" data-type="sect2"><div class="sect2" id="id244">&#13;
<h2>Storage Fakes</h2>&#13;
&#13;
<p>Testing files<a data-primary="testing" data-secondary="other Laravel Systems" data-tertiary="storage fakes" data-type="indexterm" id="id1572"/><a data-primary="storage fakes" data-type="indexterm" id="id1573"/><a data-primary="fakes" data-secondary="storage fakes" data-type="indexterm" id="id1574"/> can be extraordinarily complex. Many traditional methods require you to actually move files around in your test directories, and formatting the form input and output can be very complicated.</p>&#13;
&#13;
<p>Thankfully, if you use Laravel’s <code>Storage</code> facade, it’s infinitely simpler to test file uploads and other storage-related items, as <a data-type="xref" href="#storage_fakes">Example 12-21</a> demonstrates.<a data-primary="" data-startref="Ffaking12" data-type="indexterm" id="id1575"/></p>&#13;
<div data-type="example" id="storage_fakes">&#13;
<h5><span class="label">Example 12-21. </span>Testing storage and file uploads with storage fakes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_package_screenshot_upload</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">fake</code><code class="p">(</code><code class="s1">'screenshots'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Upload a fake image</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">postJson</code><code class="p">(</code><code class="s1">'screenshots'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'screenshot'</code> <code class="o">=&gt;</code> <code class="nx">UploadedFile</code><code class="o">::</code><code class="na">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">image</code><code class="p">(</code><code class="s1">'screenshot.jpg'</code><code class="p">),</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="c1">// Assert the file was stored</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">disk</code><code class="p">(</code><code class="s1">'screenshots'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">assertExists</code><code class="p">(</code><code class="s1">'screenshot.jpg'</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Or, assert a file does not exist</code>&#13;
    <code class="nx">Storage</code><code class="o">::</code><code class="na">disk</code><code class="p">(</code><code class="s1">'screenshots'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">assertMissing</code><code class="p">(</code><code class="s1">'missing.jpg'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Working with Time in Tests" data-type="sect1"><div class="sect1" id="id245">&#13;
<h1>Working with Time in Tests</h1>&#13;
&#13;
<p>It’s<a data-primary="testing" data-secondary="working with time in" data-type="indexterm" id="id1576"/><a data-primary="time, working with in testing" data-type="indexterm" id="id1577"/> common that, when we test sections of our application that interact with time, we want to test how these sections behave differently as time passes.</p>&#13;
&#13;
<p>In<a data-primary="$this-&gt;travel() method" data-type="indexterm" id="id1578"/> our tests, we can use <code>$this-&gt;travel()</code> to “travel” through time as the test progresses. We can travel forward and backward relative to the current time, travel to specific moments, or freeze the passage of time, allowing us to test how components behave once the time they’re checking looks different.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#EX1213">Example 12-22</a> to see how you might want to use this feature, or <a href="https://oreil.ly/1PNzc">the docs</a> to learn more about all the ways you can interact with time.</p>&#13;
<div data-type="example" id="EX1213">&#13;
<h5><span class="label">Example 12-22. </span>Changing the time in a test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_posts_are_no_longer_editable_after_thirty_minutes</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$post</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">travel</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">seconds</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">travelTo</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="o">-&gt;</code><code class="na">copy</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addMinutes</code><code class="p">(</code><code class="mi">31</code><code class="p">));</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertFalse</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can also provide a closure to each of these time-traveling methods; if you do, the test’s time is only modified for the duration of the closure, allowing you to more directly connect your traveling and the resulting tests, as you can see in <a data-type="xref" href="#EX1215">Example 12-23</a>.</p>&#13;
<div data-type="example" id="EX1215">&#13;
<h5><span class="label">Example 12-23. </span>Changing the time in a test using closures</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_posts_are_no_longer_editable_after_thirty_minutes</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$post</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">travel</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">seconds</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">travelTo</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">created_at</code><code class="o">-&gt;</code><code class="na">copy</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">addMinutes</code><code class="p">(</code><code class="mi">31</code><code class="p">),</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertFalse</code><code class="p">(</code><code class="nv">$post</code><code class="o">-&gt;</code><code class="na">isEditable</code><code class="p">());</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mocking" data-type="sect1"><div class="sect1" id="intro_to_mocking">&#13;
<h1>Mocking</h1>&#13;
&#13;
<p>Mocks<a data-primary="stubs" data-secondary="testing with" data-type="indexterm" id="Stest12"/> (and their brethren, spies and stubs and dummies and fakes and any number of other tools) are common in testing. We saw some examples of fakes in the previous section. I won’t go into too much detail here, but it’s unlikely you can thoroughly test an application of any size without mocking at least one thing or another.</p>&#13;
&#13;
<p>So, lets take a quick look at mocking in Laravel and how to use Mockery, the mocking library.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Quick Introduction to Mocking" data-type="sect2"><div class="sect2" id="id479">&#13;
<h2>A Quick Introduction to Mocking</h2>&#13;
&#13;
<p>Essentially, mocks<a data-primary="testing" data-secondary="mocking" data-tertiary="introduction to mocking" data-type="indexterm" id="id1579"/><a data-primary="mocking" data-secondary="introduction to mocking" data-type="indexterm" id="id1580"/> and other similar tools make it possible to create an object that in some way mimics a real class, but for testing purposes isn’t the real class. Sometimes this is done because the real class is too difficult to instantiate just to inject it into a test, or maybe because the real class communicates with an external service.</p>&#13;
&#13;
<p>As you can probably tell from the examples that follow, Laravel encourages working with the real application as much as possible—which means avoiding too much dependence on mocks. But they have their place, which is why Laravel includes Mockery, a mocking library, out of the box, and is why many of its core services offer faking utilities.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="A Quick Introduction to Mockery" data-type="sect2"><div class="sect2" id="id246">&#13;
<h2>A Quick Introduction to Mockery</h2>&#13;
&#13;
<p>Mockery<a data-primary="testing" data-secondary="mocking" data-tertiary="introduction to Mockery library" data-type="indexterm" id="Tmlib12"/><a data-primary="mocking" data-secondary="introduction to Mockery library" data-type="indexterm" id="Mlib12"/> allows you to quickly and easily create mocks from any PHP class in your application. Imagine you have a class that depends on a Slack client, but you don’t want the calls to actually go out to Slack. Mockery makes it simple to create a fake Slack client to use in your tests, like you can see in <a data-type="xref" href="#EX1206">Example 12-24</a>.</p>&#13;
<div data-type="example" id="EX1206">&#13;
<h5><span class="label">Example 12-24. </span>Using Mockery in Laravel</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/SlackClient.php</code>&#13;
<code class="k">class</code> <code class="nc">SlackClient</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// ...</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">send</code><code class="p">(</code><code class="nv">$message</code><code class="p">,</code> <code class="nv">$channel</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Actually sends a message to Slack</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// app/Notifier.php</code>&#13;
<code class="k">class</code> <code class="nc">Notifier</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">private</code> <code class="nv">$slack</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nx">SlackClient</code> <code class="nv">$slack</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">slack</code> <code class="o">=</code> <code class="nv">$slack</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">notifyAdmins</code><code class="p">(</code><code class="nv">$message</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">slack</code><code class="o">-&gt;</code><code class="na">send</code><code class="p">(</code><code class="nv">$message</code><code class="p">,</code> <code class="s1">'admins'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// tests/Unit/NotifierTest.php</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_notifier_notifies_admins</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$slackMock</code> <code class="o">=</code> <code class="nx">Mockery</code><code class="o">::</code><code class="na">mock</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">shouldIgnoreMissing</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$notifier</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Notifier</code><code class="p">(</code><code class="nv">$slackMock</code><code class="p">);</code>&#13;
    <code class="nv">$notifier</code><code class="o">-&gt;</code><code class="na">notifyAdmins</code><code class="p">(</code><code class="s1">'Test message'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>There are a lot of elements at work here, but if you look at them one by one, they make sense. We have a class named <code>Notifier</code> that we’re testing. It has a dependency named <code>SlackClient</code> that does something that we don’t want it to do when we’re running our tests: it sends actual Slack notifications. So we’re going to mock it.</p>&#13;
&#13;
<p>We use Mockery to get a mock of our <code>SlackClient</code> class. If we don’t care about &#13;
<span class="keep-together">what happens</span> to that class—​if it should simply exist to keep our tests from throwing &#13;
<span class="keep-together">errors—​we</span> can just use <code>shouldIgnoreMissing()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$slackMock</code> <code class="o">=</code> <code class="nx">Mockery</code><code class="o">::</code><code class="na">mock</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">shouldIgnoreMissing</code><code class="p">();</code></pre>&#13;
&#13;
<p>No matter what <code>Notifier</code> calls on <code>$slackMock</code>, it’ll just accept it and return <code>null</code>.</p>&#13;
&#13;
<p>But take a look at <code>test_notifier_notifies_admins()</code>. At this point, it doesn’t actually <em>test</em> anything.</p>&#13;
&#13;
<p>We could just keep <code>shouldIgnoreMissing()</code> and then write some assertions below it. That’s usually what we do with <code>shouldIgnoreMissing()</code>, which makes this object a “fake” or a “stub.”</p>&#13;
&#13;
<p>But what if we want to actually assert that a call was made to the <code>send()</code> method of <code>SlackClient</code>? That’s when we drop <code>shouldIgnoreMissing()</code> and reach for the other <code>should*</code> methods (<a data-type="xref" href="#EX1207">Example 12-25</a>).</p>&#13;
<div data-type="example" id="EX1207">&#13;
<h5><span class="label">Example 12-25. </span>Using the <code>shouldReceive()</code> method on a Mockery mock</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_notifier_notifies_admins</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$slackMock</code> <code class="o">=</code> <code class="nx">Mockery</code><code class="o">::</code><code class="na">mock</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="nv">$slackMock</code><code class="o">-&gt;</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'send'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$notifier</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Notifier</code><code class="p">(</code><code class="nv">$slackMock</code><code class="p">);</code>&#13;
    <code class="nv">$notifier</code><code class="o">-&gt;</code><code class="na">notifyAdmins</code><code class="p">(</code><code class="s1">'Test message'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p><code>shouldReceive('send')-&gt;once()</code> is the same as saying “assert that <code>$slackMock</code> <span class="keep-together">will have</span> its <code>send()</code> method called once and only once.” So, we’re now asserting that <code>Notifier</code>, when we call <code>notifyAdmins()</code>, makes a single call to the <code>send()</code> method on <code>SlackClient</code>.</p>&#13;
&#13;
<p>We could also use something like <code>shouldReceive('send')-&gt;times(3)</code> or <code>shouldReceive('send')-&gt;never()</code>. We can define what parameter we expect to be passed along with that <code>send()</code> call using <code>with()</code>, and we can define what to return with <code>andReturn()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$slackMock</code><code class="o">-&gt;</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'send'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'Hello, world!'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">andReturn</code><code class="p">(</code><code class="k">true</code><code class="p">);</code></pre>&#13;
&#13;
<p>What if we wanted to use the IoC container to resolve our instance of the <code>Notifier</code>? This might be useful if <code>Notifier</code> had several other dependencies that we didn’t need to mock.</p>&#13;
&#13;
<p>We can do that! We just use the <code>instance()</code> method on the container, as in <a data-type="xref" href="#EX1208">Example 12-26</a>, to tell Laravel to provide an instance of our mock to any classes that request it (which, in this example, will be <code>Notifier</code>).</p>&#13;
<div data-type="example" id="EX1208">&#13;
<h5><span class="label">Example 12-26. </span>Binding a Mockery instance to the container</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_notifier_notifies_admins</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$slackMock</code> <code class="o">=</code> <code class="nx">Mockery</code><code class="o">::</code><code class="na">mock</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="nv">$slackMock</code><code class="o">-&gt;</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'send'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">app</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">instance</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="nv">$slackMock</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$notifier</code> <code class="o">=</code> <code class="nx">app</code><code class="p">(</code><code class="nx">Notifier</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="nv">$notifier</code><code class="o">-&gt;</code><code class="na">notifyAdmins</code><code class="p">(</code><code class="s1">'Test message'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p class="pagebreak-before">There’s also a convenient shortcut to create and bind a Mockery instance to the container (<a data-type="xref" href="#EX1211">Example 12-27</a>):</p>&#13;
<div data-type="example" id="EX1211">&#13;
<h5><span class="label">Example 12-27. </span>Binding Mockery instances to the container more easily</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">mock</code><code class="p">(</code><code class="nx">SlackClient</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$mock</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$mock</code><code class="o">-&gt;</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'send'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>There’s a lot more you can do with Mockery: you can use spies, partial spies, and much more. Going deeper into how to use Mockery is outside the scope of this book, but I encourage you to learn more about the library and how it works by reading<a data-primary="" data-startref="Tmlib12" data-type="indexterm" id="id1581"/><a data-primary="" data-startref="Mlib12" data-type="indexterm" id="id1582"/> the <a href="https://oreil.ly/EBulp">Mockery docs</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Faking Other Facades" data-type="sect2"><div class="sect2" id="faking_facades">&#13;
<h2>Faking Other Facades</h2>&#13;
&#13;
<p>There’s<a data-primary="testing" data-secondary="mocking" data-tertiary="faking other facades" data-type="indexterm" id="Tmockfake12"/><a data-primary="mocking" data-secondary="faking other facades" data-type="indexterm" id="Mfake12"/><a data-primary="fakes" data-secondary="faking other facades" data-type="indexterm" id="Fother12"/><a data-primary="facades" data-secondary="faking other facades" data-type="indexterm" id="Ffake12"/> one other clever thing you can do with Mockery: you can use Mockery methods (e.g., <code>shouldReceive()</code>) on any facades in your app.</p>&#13;
&#13;
<p>Imagine we have a controller method that uses a facade that’s not one of the fakeable systems we’ve already covered; we want to test that controller method and assert that a certain facade call was made.</p>&#13;
&#13;
<p>Thankfully, it’s simple: we can run our Mockery-style methods on the facade, as you can see in <a data-type="xref" href="#EX1209">Example 12-28</a>.</p>&#13;
<div data-type="example" id="EX1209">&#13;
<h5><span class="label">Example 12-28. </span>Mocking a facade</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// PersonController</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Cache</code><code class="o">::</code><code class="na">remember</code><code class="p">(</code><code class="s1">'people'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Person</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// PeopleTest</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_all_people_route_should_be_cached</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$person</code> <code class="o">=</code> <code class="nx">Person</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nx">Cache</code><code class="o">::</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'remember'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">once</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">andReturn</code><code class="p">(</code><code class="nx">collect</code><code class="p">([</code><code class="nv">$person</code><code class="p">]));</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'people'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">assertJsonFragment</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nv">$person</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, you can use methods like <code>shouldReceive()</code> on the facades, just like you do on a <code>Mockery</code> object.</p>&#13;
&#13;
<p>You can also use your facades as spies, which means you can <span class="keep-together">set your</span> assertions at the end and use <code>shouldHaveReceived()</code> instead of <code class="keep-together">should</code><code class="keep-together">Receive()</code>. <a data-type="xref" href="#EX1210">Example 12-29</a> illustrates this.</p>&#13;
<div data-type="example" id="EX1210">&#13;
<h5><span class="label">Example 12-29. </span>Facade spies</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_package_should_be_cached_after_visit</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Cache</code><code class="o">::</code><code class="na">spy</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$package</code> <code class="o">=</code> <code class="nx">Package</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="nx">route</code><code class="p">(</code><code class="s1">'packages.show'</code><code class="p">,</code> <code class="p">[</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]));</code>&#13;
&#13;
    <code class="nx">Cache</code><code class="o">::</code><code class="na">shouldHaveReceived</code><code class="p">(</code><code class="s1">'put'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">once</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'packages.'</code> <code class="o">.</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">,</code> <code class="nv">$package</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="p">());</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can also partially mock facades, as you can<a data-primary="" data-startref="Tmockfake12" data-type="indexterm" id="id1583"/><a data-primary="" data-startref="Mfake12" data-type="indexterm" id="id1584"/><a data-primary="" data-startref="Stest12" data-type="indexterm" id="id1585"/><a data-primary="" data-startref="Fother12" data-type="indexterm" id="id1586"/><a data-primary="" data-startref="Ffake12" data-type="indexterm" id="id1587"/> see in <a data-type="xref" href="#partial_mock_facades">Example 12-30</a>.</p>&#13;
<div data-type="example" id="partial_mock_facades">&#13;
<h5><span class="label">Example 12-30. </span>Partially mocking facades</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Full mock</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'someMethod'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">();</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">someMethod</code><code class="p">();</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">anotherMethod</code><code class="p">();</code> <code class="c1">// Fails</code>&#13;
&#13;
<code class="c1">// Partial mock</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">partialMock</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">shouldReceive</code><code class="p">(</code><code class="s1">'someMethod'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">once</code><code class="p">();</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">someMethod</code><code class="p">();</code> <code class="c1">// Uses the mocked object</code>&#13;
<code class="nx">CustomFacade</code><code class="o">::</code><code class="na">anotherMethod</code><code class="p">();</code> <code class="c1">// Uses the method on the actual Facade</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing Artisan Commands" data-type="sect1"><div class="sect1" id="id248">&#13;
<h1>Testing Artisan Commands</h1>&#13;
&#13;
<p>We’ve<a data-primary="testing" data-secondary="Artisan commands" data-type="indexterm" id="id1588"/><a data-primary="Artisan" data-secondary="testing" data-type="indexterm" id="id1589"/> covered a lot in this chapter, but we’re almost done! We have just three more pieces of Laravel’s testing arsenal to cover: Artisan, parallel testing, and the browser.</p>&#13;
&#13;
<p>The best way to test Artisan commands is to call them with <code>$this-&gt;artisan(<em>$commandName</em>, <em>$parameters</em>)</code> and then test their impact, like in <a data-type="xref" href="#simple_artisan_test">Example 12-31</a>.</p>&#13;
<div class="pagebreak-before less_space" data-type="example" id="simple_artisan_test">&#13;
<h5><span class="label">Example 12-31. </span>Simple Artisan tests</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_promote_console_command_promotes_user</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">artisan</code><code class="p">(</code><code class="s1">'user:promote'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'userId'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">isPromoted</code><code class="p">());</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can make assertions against the response code you get from Artisan, as you can see in <a data-type="xref" href="#manually_asserting_artisan_exit_codes">Example 12-32</a>.</p>&#13;
<div data-type="example" id="manually_asserting_artisan_exit_codes">&#13;
<h5><span class="label">Example 12-32. </span>Manually asserting Artisan exit codes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$code</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">artisan</code><code class="p">(</code><code class="s1">'do:thing'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'--flagOfSomeSort'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">]);</code>&#13;
<code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEquals</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="nv">$code</code><code class="p">);</code> <code class="c1">// 0 means "no errors were returned"</code></pre></div>&#13;
&#13;
<p>You can also chain three methods onto your <code>$this-&gt;artisan()</code> call: <code>expectsQuestion()</code>, <code>expectsOutput()</code>, and <code>assertExitCode()</code>. The <code>expects</code>* methods will work on any of the interactive prompts, including <code>confirm()</code> and <code>anticipate()</code>, and the <code>assertExitCode()</code> method is a shortcut to what we saw in <a data-type="xref" href="#manually_asserting_artisan_exit_codes">Example 12-32</a>.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#basic_artisan_expects">Example 12-33</a> to see how<a data-primary="--expanded flag" data-type="indexterm" id="id1590"/> it works.</p>&#13;
<div data-type="example" id="basic_artisan_expects">&#13;
<h5><span class="label">Example 12-33. </span>Basic Artisan “expects” tests</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/console.php</code>&#13;
<code class="nx">Artisan</code><code class="o">::</code><code class="na">command</code><code class="p">(</code><code class="s1">'make:post {--expanded}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$title</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">ask</code><code class="p">(</code><code class="s1">'What is the post title?'</code><code class="p">);</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">comment</code><code class="p">(</code><code class="s1">'Creating at '</code> <code class="o">.</code> <code class="nx">Str</code><code class="o">::</code><code class="na">slug</code><code class="p">(</code><code class="nv">$title</code><code class="p">)</code> <code class="o">.</code> <code class="s1">'.md'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$category</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">choice</code><code class="p">(</code><code class="s1">'What category?'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'technology'</code><code class="p">,</code> <code class="s1">'construction'</code><code class="p">],</code> <code class="mi">0</code><code class="p">);</code>&#13;
&#13;
    <code class="c1">// Create post here</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">comment</code><code class="p">(</code><code class="s1">'Post created'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Test file</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_make_post_console_commands_performs_as_expected</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">artisan</code><code class="p">(</code><code class="s1">'make:post'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'--expanded'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">])</code>&#13;
        <code class="o">-&gt;</code><code class="na">expectsQuestion</code><code class="p">(</code><code class="s1">'What is the post title?'</code><code class="p">,</code> <code class="s1">'My Best Post Now'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">expectsOutput</code><code class="p">(</code><code class="s1">'Creating at my-best-post-now.md'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">expectsQuestion</code><code class="p">(</code><code class="s1">'What category?'</code><code class="p">,</code> <code class="s1">'construction'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">expectsOutput</code><code class="p">(</code><code class="s1">'Post created'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">assertExitCode</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, the first parameter of <code>expectsQuestion()</code> is the text we’re expecting to see from the question, and the second parameter is the text we’re answering with. <code>expectsOutput()</code> just tests that the passed string is returned.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Parallel Testing" data-type="sect1"><div class="sect1" id="id249">&#13;
<h1>Parallel Testing</h1>&#13;
&#13;
<p>By<a data-primary="testing" data-secondary="parallel testing" data-type="indexterm" id="id1591"/><a data-primary="parallel testing" data-type="indexterm" id="id1592"/> default, tests in Laravel run in a single thread. The more tests you have, and the more complex they are, the longer your test suite can take to run, and this can have a significant impact on how likely your team is to run your test suite.</p>&#13;
&#13;
<p>If you want to speed up your test suite, you can run your tests in parallel. You’ll need to install a<a data-primary="--dev flag" data-type="indexterm" id="devflag12"/> dependency called <code>paratest</code>:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">composer<code class="w"> </code>require<code class="w"> </code>brianium/paratest<code class="w"> </code>--dev<code class="w"/></pre>&#13;
&#13;
<p>Once you’ve installed <code>paratest</code>, you can run your tests in<a data-primary="--parallel flag" data-type="indexterm" id="id1593"/><a data-primary="--processes flag" data-type="indexterm" id="id1594"/> parallel using the &#13;
<span class="keep-together"><code>--parallel</code></span> flag, as you can see in <a data-type="xref" href="#parallel_testing">Example 12-34</a>.</p>&#13;
<div data-type="example" id="parallel_testing">&#13;
<h5><span class="label">Example 12-34. </span>Running tests in parallel</h5>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting"><code class="c1"># Use as many processes as your CPU can offer</code>&#13;
php<code class="w"> </code>artisan<code class="w"> </code><code class="nb">test</code><code class="w"> </code>--parallel<code class="w"/>&#13;
&#13;
<code class="c1"># Specify the desired number of processes</code>&#13;
php<code class="w"> </code>artisan<code class="w"> </code><code class="nb">test</code><code class="w"> </code>--parallel<code class="w"> </code>--processes<code class="o">=</code><code class="m">3</code><code class="w"/></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Browser Tests" data-type="sect1"><div class="sect1" id="id697">&#13;
<h1>Browser Tests</h1>&#13;
&#13;
<p>We’ve made it to browser tests! These allow you to actually interact with the DOM of your pages: in browser tests you can click buttons, fill out and submit forms, and even interact with JavaScript.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Choosing a Tool" data-type="sect2"><div class="sect2" id="id480">&#13;
<h2>Choosing a Tool</h2>&#13;
&#13;
<p>For<a data-primary="testing" data-secondary="browser tests" data-tertiary="choosing a tool" data-type="indexterm" id="id1595"/><a data-primary="browser tests" data-secondary="choosing a tool" data-type="indexterm" id="id1596"/> browser testing for non-SPAs, I recommend you use Dusk. If you’re working with SPAs or some JavaScript-heavy applications, they may work better with frontend test suites, which are out of the scope of this book.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing with Dusk" data-type="sect2"><div class="sect2" id="dusk_testing">&#13;
<h2>Testing with Dusk</h2>&#13;
&#13;
<p>Dusk<a data-primary="testing" data-secondary="browser tests" data-tertiary="using Dusk for" data-tertiary-sortas="Dusk for" data-type="indexterm" id="TbrowDusk12"/><a data-primary="browser tests" data-secondary="using Dusk" data-type="indexterm" id="BTDusk12"/><a data-primary="Dusk" data-secondary="testing with" data-type="indexterm" id="id1597"/> is a Laravel tool (installable as a Composer package) that makes it easy to direct an embedded instance of Google Chrome (called ChromeDriver) to interact with your app. Dusk’s API is simple, and it’s easy to write code to interact with it by hand. Take a look:</p>&#13;
&#13;
<pre class="pagebreak-before less_space" data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">browse</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$browser</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="s1">'/register'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'email'</code><code class="p">,</code> <code class="s1">'test@example.com'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'password'</code><code class="p">,</code> <code class="s1">'secret'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">press</code><code class="p">(</code><code class="s1">'Sign Up'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">assertPathIs</code><code class="p">(</code><code class="s1">'/dashboard'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>With Dusk, there’s an actual browser spinning up your entire application and interacting with it. That means you can have complex interactions with your JavaScript and get screenshots of failure states—but it also means everything’s a bit slower and it’s more prone to failure than Laravel’s base application testing suite.</p>&#13;
&#13;
<p>Personally, I’ve found that Dusk is most useful as a regression testing suite, and it works better than something like Selenium. Rather than using it for any sort of test-driven development, I use it to assert that the user experience hasn’t broken (“regressed”) as the app continues to develop. Think of this more like writing tests about your user interface after the interface is built.</p>&#13;
&#13;
<p>The <a href="https://oreil.ly/ZqNtP">Dusk docs</a> are robust, so I’m not going to go into great depth here, but I want to show you the basics of working with Dusk.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Installing Dusk" data-type="sect3"><div class="sect3" id="id250">&#13;
<h3>Installing Dusk</h3>&#13;
&#13;
<p>To<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="installing Dusk" data-type="indexterm" id="id1598"/><a data-primary="Dusk" data-secondary="installing" data-type="indexterm" id="id1599"/> install Dusk, run these two commands:</p>&#13;
&#13;
<pre data-type="programlisting">composer require --dev laravel/dusk&#13;
php artisan dusk:install</pre>&#13;
&#13;
<p>Then edit your <em>.env</em> file to set your <code>APP_URL</code> variable to the same URL  you use to view your site in your local browser; something like <code>http://mysite.test</code>.</p>&#13;
&#13;
<p>To<a data-primary="" data-startref="devflag12" data-type="indexterm" id="id1600"/> run your Dusk tests, just run <code>php artisan dusk</code>. You can pass in all the same<a data-primary="--filter flag" data-type="indexterm" id="id1601"/> parameters you’re used to from PHPUnit (e.g., <code>php artisan dusk -⁠-⁠f⁠i⁠l⁠t⁠e⁠r​=⁠m⁠y⁠_⁠b⁠e⁠s⁠t⁠_⁠t⁠e⁠s⁠t</code>).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Writing Dusk tests" data-type="sect3"><div class="sect3" id="id482">&#13;
<h3>Writing Dusk tests</h3>&#13;
&#13;
<p>To<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="writing Dusk tests" data-type="indexterm" id="id1602"/><a data-primary="Dusk" data-secondary="writing tests" data-type="indexterm" id="id1603"/> generate a new Dusk test, use a command like the following:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan dusk:make RatingTest</pre>&#13;
&#13;
<p>This test will be placed in <em>tests/Browser/RatingTest.php</em>.</p>&#13;
<div data-type="tip"><h1>Customizing Dusk Environment Variables</h1>&#13;
<p>You<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="customizing environment variables" data-type="indexterm" id="id1604"/><a data-primary="Dusk" data-secondary="customizing environment variables" data-type="indexterm" id="id1605"/><a data-primary="variables" data-secondary="customizing environment variables" data-type="indexterm" id="id1606"/> can customize the environment variables for Dusk by creating a new file named <em>.env.dusk.local</em> (and you can replace <em>.local</em> if you’re working in a different environment, like “staging”).</p>&#13;
</div>&#13;
&#13;
<p>To write your Dusk tests, imagine that you’re directing one or more web browsers to visit your application and take certain actions. That’s what the syntax will look like, as you can see in <a data-type="xref" href="#first_dusk_test">Example 12-35</a>.</p>&#13;
<div data-type="example" id="first_dusk_test">&#13;
<h5><span class="label">Example 12-35. </span>A simple Dusk test</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">testBasicExample</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">browse</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$browser</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$user</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="s1">'login'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'email'</code><code class="p">,</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'password'</code><code class="p">,</code> <code class="s1">'secret'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">press</code><code class="p">(</code><code class="s1">'Login'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">assertPathIs</code><code class="p">(</code><code class="s1">'/home'</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p><code>$this-&gt;browse()</code> creates a browser, which you pass into a closure; then, within the closure, you instruct the browser which actions to take.</p>&#13;
&#13;
<p>It’s important to note that—unlike Laravel’s other application testing tools, which mimic the behavior of your forms—Dusk is actually spinning up a browser, sending events to the browser to type those words, and then sending an event to the browser to press that button. This is a real browser and Dusk is fully driving it.</p>&#13;
&#13;
<p>You can also “ask” for more than one browser by adding parameters to the closure, which allows you to test how multiple users might interact with the website (for example, with a chat system). Take a look at <a data-type="xref" href="#multiple_dusk_browsers">Example 12-36</a>, from the docs.</p>&#13;
<div data-type="example" id="multiple_dusk_browsers">&#13;
<h5><span class="label">Example 12-36. </span>Multiple Dusk browsers</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">browse</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$first</code><code class="p">,</code> <code class="nv">$second</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$first</code><code class="o">-&gt;</code><code class="na">loginAs</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">1</code><code class="p">))</code>&#13;
        <code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="s1">'home'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">waitForText</code><code class="p">(</code><code class="s1">'Message'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$second</code><code class="o">-&gt;</code><code class="na">loginAs</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code>&#13;
        <code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="s1">'home'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">waitForText</code><code class="p">(</code><code class="s1">'Message'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'message'</code><code class="p">,</code> <code class="s1">'Hey Taylor'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">press</code><code class="p">(</code><code class="s1">'Send'</code><code class="p">);</code>&#13;
&#13;
    <code class="nv">$first</code><code class="o">-&gt;</code><code class="na">waitForText</code><code class="p">(</code><code class="s1">'Hey Taylor'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="s1">'Jeffrey Way'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>There’s a huge suite of actions and assertions available that we won’t cover here (check the docs), but let’s look at a few of the other tools Dusk provides.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Authentication and databases" data-type="sect3"><div class="sect3" id="id251">&#13;
<h3>Authentication and databases</h3>&#13;
&#13;
<p>As<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="authentication and databases" data-type="indexterm" id="id1607"/><a data-primary="Dusk" data-secondary="authentication and databases" data-type="indexterm" id="id1608"/><a data-primary="RefreshDatabase" data-type="indexterm" id="id1609"/><a data-primary="Database Migrations trait" data-type="indexterm" id="id1610"/> you can see in <a data-type="xref" href="#multiple_dusk_browsers">Example 12-36</a>, the syntax for authentication is a little different from the rest of the Laravel application testing: <code>$browser-&gt;loginAs(<em>$user</em>)</code>.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Avoid the RefreshDatabase trait with Dusk</h1>&#13;
<p>Don’t use the <code>RefreshDatabase</code> trait with Dusk! Use the <code>DatabaseMigrations</code> trait instead; transactions, which <code>RefreshDatabase</code> uses, don’t persist across requests.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Interactions with the page" data-type="sect3"><div class="sect3" id="id483">&#13;
<h3>Interactions with the page</h3>&#13;
&#13;
<p>If<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="interaction with the page" data-type="indexterm" id="id1611"/><a data-primary="Dusk" data-secondary="interaction with the page" data-type="indexterm" id="id1612"/> you’ve ever written jQuery, interacting with the page using Dusk will come naturally. Take a look at <a data-type="xref" href="#selecting_dusk_elements">Example 12-37</a> to see the common patterns for selecting items with Dusk.</p>&#13;
<div data-type="example" id="selecting_dusk_elements">&#13;
<h5><span class="label">Example 12-37. </span>Selecting items with Dusk</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting"><code class="p">&lt;</code><code class="nt">--</code> <code class="na">Template</code> <code class="na">--</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">div</code> <code class="na">class</code><code class="o">=</code><code class="s">"search"</code><code class="p">&gt;&lt;</code><code class="nt">input</code><code class="p">&gt;&lt;</code><code class="nt">button</code> <code class="na">id</code><code class="o">=</code><code class="s">"search-button"</code><code class="p">&gt;&lt;/</code><code class="nt">button</code><code class="p">&gt;&lt;/</code><code class="nt">div</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;</code><code class="nt">button</code> <code class="na">dusk</code><code class="o">=</code><code class="s">"expand-nav"</code><code class="p">&gt;&lt;/</code><code class="nt">button</code><code class="p">&gt;</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Dusk tests</code>&#13;
<code class="c1">// Option 1: jQuery-style syntax</code>&#13;
<code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">click</code><code class="p">(</code><code class="s1">'.search button'</code><code class="p">);</code>&#13;
<code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">click</code><code class="p">(</code><code class="s1">'#search-button'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Option 2: dusk="selector-here" syntax; recommended</code>&#13;
<code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">click</code><code class="p">(</code><code class="s1">'@expand-nav'</code><code class="p">);</code></pre></div>&#13;
&#13;
<p>As you can see, adding the <code>dusk</code> attribute to your page elements allows you to reference them directly in a way that won’t change when the display or layout of the page changes later; when any method asks for a selector, pass in the <code>@</code> sign and then the content of your <code>dusk</code> attribute.</p>&#13;
&#13;
<p>Let’s take a look at a few of the methods you can call on <code>$browser</code>.</p>&#13;
&#13;
<p>To work with text and attribute values, use these methods:</p>&#13;
<dl>&#13;
<dt><code>value(<em>$selector, $value = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns the value of any text input if only one parameter is passed; sets the value of an input if a second parameter is passed.</p>&#13;
</dd>&#13;
<dt><code>text(<em>$selector</em>)</code></dt>&#13;
<dd>&#13;
<p>Gets the text content of a nonfillable item like a <code>&lt;div&gt;</code> or a <code>&lt;span&gt;</code>.</p>&#13;
</dd>&#13;
<dt><code>attribute(<em>$selector, $attributeName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns the value of a particular attribute on the element matching <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Methods for working with forms and files include the following:</p>&#13;
<dl>&#13;
<dt><code>type(<em>$selector, $valueToType</em>)</code></dt>&#13;
<dd>&#13;
<p>Similar to <code>value()</code>, but actually types the characters rather than directly setting the value.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h1>Dusk’s Selector matching order</h1>&#13;
<p>With methods like <code>type()</code> that target inputs, Dusk will start by trying to match a Dusk or CSS selector, and then will look for an input with the provided name, and finally will try to find a <code>&lt;textarea&gt;</code> with the provided name.</p>&#13;
</div>&#13;
<dl>&#13;
<dt><code>select(<em>$selector, $optionValue</em>)</code></dt>&#13;
<dd>&#13;
<p>Selects the option with the value of <code><em>$optionValue</em></code> in a drop-down selectable by <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
<dt><code>check(<em>$selector</em>)</code>, <code>uncheck(<em>$selector</em>)</code></dt>&#13;
<dd>&#13;
<p>Checks or unchecks a checkbox selectable by <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
<dt><code>radio(<em>$selector, $optionValue</em>)</code></dt>&#13;
<dd>&#13;
<p>Selects the option with the value of <code><em>$optionValue</em></code> in a radio group selectable by <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
<dt><code>attach(<em>$selector, $filePath</em>)</code></dt>&#13;
<dd>&#13;
<p>Attaches a file at <code><em>$filePath</em></code> to the file input selectable by <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The methods for keyboard and mouse input are:</p>&#13;
<dl>&#13;
<dt><code>clickLink(<em>$selector</em>)</code></dt>&#13;
<dd>&#13;
<p>Follows a text link to its target.</p>&#13;
</dd>&#13;
<dt><code>click(<em>$selector</em>)</code>, <code>mouseover(<em>$selector</em>)</code></dt>&#13;
<dd>&#13;
<p>Triggers a mouse click or a mouseover event on <code><em>$selector</em></code>.</p>&#13;
</dd>&#13;
<dt><code>drag(<em>$selectorToDrag, $selectorToDragTo</em>)</code></dt>&#13;
<dd>&#13;
<p>Drags an item to another item.</p>&#13;
</dd>&#13;
<dt><code>dragLeft()</code>, <code>dragRight()</code>, <code>dragUp()</code>, <code>dragDown()</code></dt>&#13;
<dd>&#13;
<p>Given a first parameter of a selector and a second parameter of a number of pixels, drags the selected item that many pixels in the given direction.</p>&#13;
</dd>&#13;
<dt><code>keys(<em>$selector, $instructions</em>)</code></dt>&#13;
<dd>&#13;
<p>Sends keypress events within the context of <code><em>$selector</em></code> according to the instructions in <code><em>$instructions</em></code>. You can even combine modifiers with your typing:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">keys</code><code class="p">(</code><code class="s1">'selector'</code><code class="p">,</code> <code class="s1">'this is '</code><code class="p">,</code> <code class="p">[</code><code class="s1">'{shift}'</code><code class="p">,</code> <code class="s1">'great'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>This would type “this is GREAT.” As you can see, adding an array to the list of items to type allows you to combine modifiers (wrapped with <code>{}</code>) with typing. You can see a full list of the possible modifiers in the <a href="https://oreil.ly/_gKa4">Facebook WebDriver source</a>.</p>&#13;
&#13;
<p>If you’d like to just send your key sequence to the page (for example, to trigger a keyboard shortcut), you can target the top level of your app or page as your selector. For example, if it’s a Vue app and the top level is a <code>&lt;div&gt;</code> with an ID of <code>app</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">keys</code><code class="p">(</code><code class="s1">'#app'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'{command}'</code><code class="p">,</code> <code class="s1">'/'</code><code class="p">]);</code></pre>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Waiting" data-type="sect3"><div class="sect3" id="id484">&#13;
<h3>Waiting</h3>&#13;
&#13;
<p>Because<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="waiting" data-type="indexterm" id="id1613"/><a data-primary="Dusk" data-secondary="waiting" data-type="indexterm" id="id1614"/> Dusk interacts with JavaScript and is directing an actual browser, the concept of time and timeouts and “waiting” needs to be addressed. Dusk offers several methods you can use to ensure your tests handle timing issues correctly. Some of these methods are useful for interacting with intentionally slow or delayed elements of the page, but some of them are also just useful for getting around initialization times on your components. The available methods include the following:</p>&#13;
<dl>&#13;
<dt><code>pause(<em>$milliseconds</em>)</code></dt>&#13;
<dd>&#13;
<p>Pauses the execution of Dusk tests for the given number of milliseconds.&#13;
This is the simplest “wait” option; it makes any future commands you send to the browser wait that amount of time before operating.</p>&#13;
&#13;
<p>You can use this and other waiting methods in the midst of an assertion chain, as shown here:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">click</code><code class="p">(</code><code class="s1">'chat'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">pause</code><code class="p">(</code><code class="mi">500</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="s1">'How can we help?'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>waitFor(<em>$selector, $maxSeconds = null</em>)</code>, <code>waitUntilMissing(<em>$selector</em>,</code> <span class="keep-together"><code><em>$maxSeconds</em></code></span> <code><em>= null</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits until the given element exists on the page (<code>waitFor()</code>) or disappears from the page (<code>waitUntilMissing()</code>) or times out after the optional second parameter’s second count:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitFor</code><code class="p">(</code><code class="s1">'@chat'</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>&#13;
<code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitUntilMissing</code><code class="p">(</code><code class="s1">'@loading'</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>whenAvailable(<em>$selector, $callback</em>)</code></dt>&#13;
<dd>&#13;
<p>Similar to <code>waitFor()</code>, but accepts a closure as the second parameter, which will define what action to take when the specified element becomes available:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">whenAvailable</code><code class="p">(</code><code class="s1">'@chat'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$chat</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$chat</code><code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="s1">'How can we help you?'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
</dd>&#13;
<dt><code>waitForText(<em>$text, $maxSeconds = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits for text to show up on the page, or times out after the optional second parameter’s second count:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitForText</code><code class="p">(</code><code class="s1">'Your purchase has been completed.'</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>waitForLink(<em>$linkText, $maxSeconds = null</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits for a link to exist with the given link text, or times out after the optional second parameter’s second count:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitForLink</code><code class="p">(</code><code class="s1">'Clear these results'</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>waitForLocation(<em>$path</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits until the page URL matches the provided path:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitForLocation</code><code class="p">(</code><code class="s1">'auth/login'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>waitForRoute(<em>$routeName</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits until the page URL matches the URL for the provided route:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitForRoute</code><code class="p">(</code><code class="s1">'packages.show'</code><code class="p">,</code> <code class="p">[</code><code class="nv">$package</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]);</code></pre>&#13;
</dd>&#13;
<dt><code>waitForReload()</code></dt>&#13;
<dd>&#13;
<p>Waits until the page reloads.</p>&#13;
</dd>&#13;
<dt><code>waitUntil(<em>$expression</em>)</code></dt>&#13;
<dd>&#13;
<p>Waits until the provided JavaScript expression evaluates as true:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">waitUntil</code><code class="p">(</code><code class="s1">'App.packages.length &gt; 0'</code><code class="p">,</code> <code class="mi">7</code><code class="p">);</code></pre>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Assertions" data-type="sect3"><div class="sect3" id="id485">&#13;
<h3>Other Assertions</h3>&#13;
&#13;
<p>As<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="other assertions" data-type="indexterm" id="id1615"/><a data-primary="Dusk" data-secondary="other assertions" data-type="indexterm" id="id1616"/><a data-primary="assertions" data-secondary="commonly used" data-type="indexterm" id="id1617"/> I’ve mentioned, there’s a huge list of assertions you can make against your app with Dusk. Here are a few that I use most commonly—you can see the full list in the <a href="https://oreil.ly/ZqNtP">Dusk docs</a>:</p>&#13;
&#13;
<ul>&#13;
<li>&#13;
<p><code>assertTitleContains(<em>$text</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertQueryStringHas(<em>$keyName</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertHasCookie(<em>$cookieName</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertSourceHas(<em>$htmlSourceCode</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertChecked(<em>$selector</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertSelectHasOption(<em>$selectorForSelect, $optionValue</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertVisible(<em>$selector</em>)</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertFocused()</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>assertVue(<em>$dataLocation, $dataValue, $selector</em>)</code></p>&#13;
</li>&#13;
</ul>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other organizational structures" data-type="sect3"><div class="sect3" id="id581">&#13;
<h3>Other organizational structures</h3>&#13;
&#13;
<p>So far, everything<a data-primary="browser tests" data-secondary="using Dusk" data-tertiary="other organizational structures" data-type="indexterm" id="id1618"/><a data-primary="Dusk" data-secondary="other organizational structures" data-tertiary="complex applications and" data-type="indexterm" id="id1619"/> we’ve covered makes it possible to test individual elements on our pages. But we’ll often use Dusk to test more complex applications and single-page apps, which means we’re going to need organizational structures around our &#13;
<span class="keep-together">assertions</span>.</p>&#13;
&#13;
<p>The first organizational structures we have encountered have been the <code>dusk</code> attribute (e.g., <code>&lt;div dusk="abc"&gt;</code>, creating a selector named <code>@abc</code> we can refer to later) and the closures we can use to wrap certain portions of our code (e.g., with <code>when</code><span class="keep-together"><code>Available()</code>).</span></p>&#13;
&#13;
<p>Dusk offers two more organizational tools: pages and components. Let’s start with pages.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pages" data-type="sect4"><div class="sect4" id="id582">&#13;
<h4>Pages</h4>&#13;
&#13;
<p>A<a data-primary="Dusk" data-secondary="other organizational structures" data-tertiary="pages" data-type="indexterm" id="id1620"/> page is a class that you’ll generate which contains two pieces of functionality: first, a URL and assertions to define which page in your app should be attached to this Dusk page; and second, shorthand like we used inline (the <code>@abc</code> selector generated by the <code>dusk="abc"</code> attribute in our HTML) but just for this page, and without needing to edit our HTML.</p>&#13;
&#13;
<p>Let’s imagine our app has a “create package” page. We can generate a Dusk page for it as follows:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">dusk</code><code class="o">:</code><code class="nx">page</code> <code class="nx">CreatePackage</code></pre>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#generated_dusk_page">Example 12-38</a> to see what our generated class will look like.</p>&#13;
<div data-type="example" id="generated_dusk_page">&#13;
<h5><span class="label">Example 12-38. </span>The generated Dusk page</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Tests\Browser\Pages</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Laravel\Dusk\Browser</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">CreatePackage</code> <code class="k">extends</code> <code class="nx">Page</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the URL for the page</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return string</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">url</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s1">'/'</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Assert that the browser is on the page</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @param  Browser  $browser</code>&#13;
<code class="sd">     * @return void</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">assert</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertPathIs</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">url</code><code class="p">());</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the element shortcuts for the page</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">elements</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'@element'</code> <code class="o">=&gt;</code> <code class="s1">'#selector'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The <code>url()</code> method defines the location where Dusk should expect this page to be, <code>assert()</code> lets you run additional assertions to verify you’re on the right page, and <code>elements()</code> provides shortcuts for <code>@dusk</code>-style selectors.</p>&#13;
&#13;
<p>Let’s make a few quick modifications to our “create package” page, to make it look like <a data-type="xref" href="#create_package_basic_dusk_page">Example 12-39</a>.</p>&#13;
<div data-type="example" id="create_package_basic_dusk_page">&#13;
<h5><span class="label">Example 12-39. </span>A simple “create package” Dusk page</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">CreatePackage</code> <code class="k">extends</code> <code class="nx">Page</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">url</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s1">'/packages/create'</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">assert</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertTitleContains</code><code class="p">(</code><code class="s1">'Create Package'</code><code class="p">);</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertPathIs</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">url</code><code class="p">());</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">elements</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'@title'</code> <code class="o">=&gt;</code> <code class="s1">'input[name=title]'</code><code class="p">,</code>&#13;
            <code class="s1">'@instructions'</code> <code class="o">=&gt;</code> <code class="s1">'textarea[name=instructions]'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now that we have a functional page, we can navigate to it and access its defined <span class="keep-together">elements:</span></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In a test</code>&#13;
<code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="k">new</code> <code class="nx">Tests\Browser\Pages\CreatePackage</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'@title'</code><code class="p">,</code> <code class="s1">'My package title'</code><code class="p">);</code></pre>&#13;
&#13;
<p>One common use for pages is to define a common action you want to take in your tests; consider these almost like macros for Dusk. You can define a method on your page and then call it from your code, as you can see in <a data-type="xref" href="#dusk_custom_page_methods">Example 12-40</a>.</p>&#13;
<div data-type="example" id="dusk_custom_page_methods">&#13;
<h5><span class="label">Example 12-40. </span>Defining and using a custom page method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">CreatePackage</code> <code class="k">extends</code> <code class="nx">Page</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// ... url(), assert(), elements()</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">fillBasicFields</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">,</code> <code class="nv">$packageTitle</code> <code class="o">=</code> <code class="s1">'Best package'</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'@title'</code><code class="p">,</code> <code class="nv">$packageTitle</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">type</code><code class="p">(</code><code class="s1">'@instructions'</code><code class="p">,</code> <code class="s1">'Do this stuff and then that stuff'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="k">new</code> <code class="nx">CreatePackage</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">fillBasicFields</code><code class="p">(</code><code class="s1">'Greatest Package Ever'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">press</code><code class="p">(</code><code class="s1">'Create Package'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="s1">'Greatest Package Ever'</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Components" data-type="sect4"><div class="sect4" id="id252">&#13;
<h4>Components</h4>&#13;
&#13;
<p>If<a data-primary="Dusk" data-secondary="other organizational structures" data-tertiary="components" data-type="indexterm" id="id1621"/> you want the same functionality as Dusk pages offer, but without it being constrained to a specific URL, you’ll likely want to reach for Dusk <em>components</em>. These classes are shaped very similarly to pages, but instead of being bound to a URL, they’re each bound to a selector.</p>&#13;
&#13;
<p>In <em>NovaPackages.com</em>, we have a little Vue component for rating packages and displaying ratings. Let’s make a Dusk component for it:</p>&#13;
&#13;
<pre data-type="programlisting">php artisan dusk:component RatingWidget</pre>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="#generated_dusk_component">Example 12-41</a> to see what that will generate.</p>&#13;
<div data-type="example" id="generated_dusk_component">&#13;
<h5><span class="label">Example 12-41. </span>The default source of a generated Dusk component</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Tests\Browser\Components</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Laravel\Dusk\Browser</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Laravel\Dusk\Component</code> <code class="k">as</code> <code class="nx">BaseComponent</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">RatingWidget</code> <code class="k">extends</code> <code class="nx">BaseComponent</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the root selector for the component</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return string</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">selector</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s1">'#selector'</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Assert that the browser page contains the component</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @param  Browser  $browser</code>&#13;
<code class="sd">     * @return void</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">assert</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertVisible</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">selector</code><code class="p">());</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Get the element shortcuts for the component</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return array</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">elements</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'@element'</code> <code class="o">=&gt;</code> <code class="s1">'#selector'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, this is basically the same as a Dusk page, but we’re encapsulating our work to an HTML element instead of a URL. Everything else is basically the same. Take a look at <a data-type="xref" href="#simple_dusk_component">Example 12-42</a> to see our rating widget example in Dusk component form.</p>&#13;
<div data-type="example" id="simple_dusk_component">&#13;
<h5><span class="label">Example 12-42. </span>A Dusk component for the rating widget</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">RatingWidget</code> <code class="k">extends</code> <code class="nx">BaseComponent</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">selector</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s1">'.rating-widget'</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">assert</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertVisible</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">selector</code><code class="p">());</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">elements</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'@5-star'</code> <code class="o">=&gt;</code> <code class="s1">'.five-star-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@4-star'</code> <code class="o">=&gt;</code> <code class="s1">'.four-star-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@3-star'</code> <code class="o">=&gt;</code> <code class="s1">'.three-star-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@2-star'</code> <code class="o">=&gt;</code> <code class="s1">'.two-star-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@1-star'</code> <code class="o">=&gt;</code> <code class="s1">'.one-star-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@average'</code> <code class="o">=&gt;</code> <code class="s1">'.average-rating'</code><code class="p">,</code>&#13;
            <code class="s1">'@mine'</code> <code class="o">=&gt;</code> <code class="s1">'.current-user-rating'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">ratePackage</code><code class="p">(</code><code class="nx">Browser</code> <code class="nv">$browser</code><code class="p">,</code> <code class="nv">$rating</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">click</code><code class="p">(</code><code class="s2">"@</code><code class="si">{</code><code class="nv">$rating</code><code class="si">}</code><code class="s2">-star"</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">assertSeeIn</code><code class="p">(</code><code class="s1">'@mine'</code><code class="p">,</code> <code class="nv">$rating</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Using components works just like using pages, as you can see in <a data-type="xref" href="#using_dusk_components">Example 12-43</a>.</p>&#13;
<div data-type="example" id="using_dusk_components">&#13;
<h5><span class="label">Example 12-43. </span>Using Dusk components</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">visit</code><code class="p">(</code><code class="s1">'/packages/tightenco/nova-stock-picker'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">within</code><code class="p">(</code><code class="k">new</code> <code class="nx">RatingWidget</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$browser</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">ratePackage</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>&#13;
        <code class="nv">$browser</code><code class="o">-&gt;</code><code class="na">assertSeeIn</code><code class="p">(</code><code class="s1">'@average'</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>&#13;
    <code class="p">});</code></pre></div>&#13;
&#13;
<p>That’s a good, brief overview of what Dusk can do. There’s a lot more—more assertions, more edge cases, more gotchas, more examples—in the <a href="https://oreil.ly/ZqNtP">Dusk docs</a>, so I’d recommend a read through there if you plan to work with Dusk.<a data-primary="" data-startref="TbrowDusk12" data-type="indexterm" id="id1622"/><a data-primary="" data-startref="BTDusk12" data-type="indexterm" id="id1623"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pest" data-type="sect1"><div class="sect1" id="id253">&#13;
<h1>Pest</h1>&#13;
&#13;
<p>Pest<a data-primary="testing" data-secondary="using Pest" data-secondary-sortas="Pest" data-type="indexterm" id="id1624"/><a data-primary="Pest testing framework" data-type="indexterm" id="id1625"/> is a third-party testing framework for Laravel. It’s a layer on top of PHPUnit that provides customized console output, easy parallel testing and code coverage, architecture testing, and more.</p>&#13;
&#13;
<p>Pest also offers a different testing syntax, inspired by Ruby’s RSpec. You can use Pest and get all of its benefits without switching to its unique testing syntax, but if you do want to try it out, take a look at <a data-type="xref" href="#EX1214">Example 12-44</a> to see how the syntax looks.</p>&#13;
<div data-type="example" id="EX1214">&#13;
<h5><span class="label">Example 12-44. </span>Sample Pest syntax</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">it</code><code class="p">(</code><code class="s1">'has a welcome page'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>&#13;
&#13;
    <code class="nx">expect</code><code class="p">(</code><code class="nv">$response</code><code class="o">-&gt;</code><code class="na">status</code><code class="p">())</code><code class="o">-&gt;</code><code class="na">toBe</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>To learn more about Pest, check out <a class="orm:hideurl" href="https://pestphp.com"><em>pestphp.com</em></a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id486">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Laravel<a data-primary="testing" data-secondary="overview of" data-type="indexterm" id="id1626"/> can work with any modern PHP testing framework, but it’s optimized for PHPUnit (especially if your tests extend Laravel’s <code>TestCase</code>). Laravel’s application testing framework makes it simple to send fake HTTP and console requests through your application and inspect the results.</p>&#13;
&#13;
<p>Tests in Laravel can easily and powerfully interact with and assert against the database, cache, session, filesystem, mail, and many other systems. Quite a few of these systems have fakes built in to make them even easier to test. You can test DOM and browser-like interactions with Dusk.</p>&#13;
&#13;
<p>Laravel brings in Mockery in case you need mocks, stubs, spies, dummies, or anything else, but the testing philosophy of Laravel is to use real collaborators as much as possible. Don’t fake it unless you have to.</p>&#13;
</div></section>&#13;
</div></section></body></html>