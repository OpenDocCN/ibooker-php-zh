<html><head></head><body><div id="sbo-rt-content" class="calibre1"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Accessing MySQL Using PHP" class="calibre4"><div class="preface" id="accessing_mysql_using_php">
<h1 class="calibre10"><span class="keep-together">Chapter 11. </span>Accessing MySQL Using PHP</h1>

<p class="author1">If<a contenteditable="false" data-primary="MySQL" data-secondary="database queries with PHP" data-type="indexterm" id="MSQdataq10" class="calibre6"/><a contenteditable="false" data-primary="PHP programming language" data-secondary="database queries to MySQL" data-type="indexterm" id="PHPdbq10" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-see="also MySQL; databases" data-type="indexterm" id="idm45694719133304" class="calibre6"/><a contenteditable="false" data-primary="querying databases" data-see="database queries" data-type="indexterm" id="idm45694719131928" class="calibre6"/> you worked through the previous chapters, you’re proficient in using both MySQL and PHP. In this chapter, you will learn how to integrate the two by using PHP’s built-in functions to access MySQL.</p>

<section data-type="sect1" data-pdf-bookmark="Querying a MySQL Database with PHP" class="calibre4"><div class="preface" id="querying_a_mysql_database_with_php">
<h1 class="calibre11">Querying a MySQL Database with PHP</h1>

<p class="author1">The<a contenteditable="false" data-primary="database queries" data-secondary="process of" data-type="indexterm" id="idm45694719128248" class="calibre6"/> reason for using PHP as an interface to MySQL is to format the results of SQL queries in a form visible in a web page. As long as you can log in to your MySQL installation using your username and password, you can also do so from PHP.</p>

<p class="author1">However, instead of using MySQL’s command line to enter instructions and view output, you will create query strings that are passed to MySQL. When MySQL returns its response, it will come as a data structure that PHP can recognize instead of the formatted output you see when you work on the command line. Further PHP commands can retrieve the data and format it for the web page.</p>

<section data-type="sect2" data-pdf-bookmark="The Process" class="calibre4"><div class="preface" id="process">
<h2 class="calibre28">The Process</h2>

<p class="author1">The process of using MySQL with PHP is as follows:</p>

<ol class="calibre25">
	<li class="calibre26">
	<p class="author1">Connect to MySQL and select the database to use.</p>
	</li>
	<li class="calibre26">
	<p class="author1">Prepare a query string.</p>
	</li>
	<li class="calibre26">
	<p class="author1">Perform the query.</p>
	</li>
	<li class="calibre26">
	<p class="author1">Retrieve the results and output them to a web page.</p>
	</li>
	<li class="calibre26">
	<p class="author1">Repeat steps 2 to 4 until all desired data has been retrieved.</p>
	</li>
	<li class="calibre26">
	<p class="author1">Disconnect from MySQL.</p>
	</li>
</ol>

<p class="author1">We’ll work through these steps in turn, but first it’s important to set up your login details in a secure manner so people snooping around on your system have trouble getting access to your database.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Creating a Login File" class="calibre4"><div class="preface" id="creating_a_login_file">
<h2 class="calibre28">Creating a Login File</h2>

<p class="author1">Most<a contenteditable="false" data-primary="database queries" data-secondary="login file creation" data-type="indexterm" id="idm45694719115000" class="calibre6"/> websites developed with PHP contain multiple program files that will require access to MySQL and will thus need the login and password details. Therefore, it’s sensible to create a single file to store these and then include that file wherever it’s needed. <a data-type="xref" href="#logindotphp_file" class="calibre6">Example 11-1</a> shows such a file, which I’ve called <em class="hyperlink">login.php</em>.</p>

<div data-type="example" id="logindotphp_file" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-1. </span>The login.php file</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15"> </code><code class="c">// login.php
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$host</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">'</code><strong class="calibre31"><code class="s2">localhost</code></strong><code class="s">'</code><code class="p">;</code><code class="calibre15">    </code><code class="c">// </code><strong class="calibre31"><code class="c2">Change as necessary</code></strong><code class="c">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$data</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">'</code><strong class="calibre31"><code class="s2">publications</code></strong><code class="s">'</code><code class="p">;</code><code class="calibre15"> </code><code class="c">// </code><strong class="calibre31"><code class="c2">Change as necessary</code></strong><code class="c">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$user</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">'</code><strong class="calibre31"><code class="s2">root</code></strong><code class="s">'</code><code class="p">;</code><code class="calibre15">         </code><code class="c">// </code><strong class="calibre31"><code class="c2">Change as necessary</code></strong><code class="c">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pass</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">'</code><strong class="calibre31"><code class="s2">mysql</code></strong><code class="s">'</code><code class="p">;</code><code class="calibre15">        </code><code class="c">// </code><strong class="calibre31"><code class="c2">Change as necessary</code></strong><code class="c">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$chrs</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">'utf8mb4'</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$attr</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">mysql:host=</code><code class="err">$host</code><code class="s">;dbname=</code><code class="err">$data</code><code class="s">;charset=</code><code class="err">$chrs</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$opts</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">[</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n">PDO</code><code class="o">::</code><code class="na">ATTR_ERRMODE </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="o">=&gt;</code><code class="calibre15"> </code><code class="n">PDO</code><code class="o">::</code><code class="na">ERRMODE_EXCEPTION</code><code class="p">,</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n">PDO</code><code class="o">::</code><code class="na">ATTR_DEFAULT_FETCH_MODE</code><code class="calibre15"> </code><code class="o">=&gt;</code><code class="calibre15"> </code><code class="n">PDO</code><code class="o">::</code><code class="na">FETCH_ASSOC</code><code class="p">,</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n">PDO</code><code class="o">::</code><code class="na">ATTR_EMULATE_PREPARES </code><code class="calibre15"> </code><code class="n"> </code><code class="o">=&gt;</code><code class="calibre15"> </code><code class="k">false</code><code class="p">,</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">];</code><code class="calibre15">
</code><code class="cp">?&gt;</code></pre>
</div>

<p class="author1">Type the example, replacing the username <em class="hyperlink"><code class="calibre18">root</code></em> and password of <em class="hyperlink"><code class="calibre18">mysql</code></em> with the values you use for your MySQL database (and the host and database name too, if necessary), and save it to the document root directory you set up in <a data-type="xref" href="ch02.xhtml#setting_up_a_development_server" class="calibre6">Chapter 2</a>. We’ll be making use of the file shortly.</p>

<p class="author1">The hostname <code class="calibre15">localhost</code> should work as long as you’re using a MySQL database on your local system, and the database <code class="calibre15">publications</code> should work if you’re typing the examples I’ve used so far.</p>

<p class="author1">The<a contenteditable="false" data-primary="&lt;?php and ?&gt; tags" data-type="indexterm" id="idm45694718995304" class="calibre6"/><a contenteditable="false" data-primary="&lt;?php and ?&gt; tags" data-primary-sortas="php tags" data-type="indexterm" id="idm45694718993912" class="calibre6"/><a contenteditable="false" data-primary="security issues" data-secondary="&lt;?php and ?&gt; tags" data-type="indexterm" id="idm45694718998232" class="calibre6"/> enclosing <code class="calibre15">&lt;?php</code> and <code class="calibre15">?&gt;</code> tags are especially important for the <em class="hyperlink">login.php</em> file in <a data-type="xref" href="#logindotphp_file" class="calibre6">Example 11-1</a>, because they mean that the lines between can be interpreted <em class="hyperlink">only</em> as PHP code. If you were to leave them out and someone were to call up the file directly from your website, it would display as text and reveal your secrets. But, with the tags in place, all that person will see is a blank page. The file will correctly include your other PHP files.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>

<p class="author1">In<a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="vs. mysqli" data-secondary-sortas="mysqli" data-type="indexterm" id="idm45694719000072" class="calibre6"/><a contenteditable="false" data-primary="mysqli" data-type="indexterm" id="idm45694719002184" class="calibre6"/> previous versions of the book we have used direct access to MySQL, which was not at all secure, and later on switched to using <em class="hyperlink">mysqli</em>, which was much more secure. But, as they say, time marches on, and now there’s the most secure and easiest way yet to access a MySQL database from PHP, and that’s called PDO, which we now use by default in this edition of the book as a lightweight and consistent interface for accessing databases in PHP. PDO stands for PHP Data Objects and is a data access layer that uses a unified API. Each database driver that implements the PDO interface can expose database-specific features as regular extension functions.</p>
</div>

<p class="author1">The<a contenteditable="false" data-primary="$host variable (PHP)" data-type="indexterm" id="idm45694719006936" class="calibre6"/> <code class="calibre15">$host</code> variable will tell PHP which computer to use when connecting to a database. This is required because you can access MySQL databases on any computer connected to your PHP installation, and that potentially includes any host anywhere on the web. However, the examples in this chapter will be working on the local server. So, in place of specifying a domain such as <code class="calibre15">mysql.myserver.com</code>, you can just use the word <code class="calibre15">localhost</code> (or the IP address <code class="calibre15">127.0.0.1</code>).</p>

<p class="author1">The database we’ll be using, <code class="calibre15">$data</code>, is the one called <em class="hyperlink">publications</em> that we created in <a data-type="xref" href="ch08.xhtml#introduction_to_mysql" class="calibre6">Chapter 8</a> (if you’re using a different database—one provided by your server administrator—you’ll have to modify <em class="hyperlink">login.php</em> accordingly).</p>

<p class="author1"><code class="calibre15">$chrs</code> stands<a contenteditable="false" data-primary="$chrs (character set)" data-type="indexterm" id="idm45694719015576" class="calibre6"/> for character set, and in this case we are using <code class="calibre15">utf8mb4</code>, while <code class="calibre15">$attr</code> and <code class="calibre15">$opts</code> contain additional options needed to access the database.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Another<a contenteditable="false" data-primary="MySQL" data-secondary="storing login details" data-type="indexterm" id="idm45694719021976" class="calibre6"/><a contenteditable="false" data-primary="passwords" data-secondary="MySQL and" data-type="indexterm" id="idm45694719020680" class="calibre6"/> benefit of keeping these login details in a single place is that you can change your password as frequently as you like and there will be only one file to update when you do, no matter how many PHP files access MySQL.</p>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Connecting to a MySQL Database" class="calibre4"><div class="preface" id="connecting_to_a_mysql_database">
<h2 class="calibre28">Connecting to a MySQL Database</h2>

<p class="author1">Now<a contenteditable="false" data-primary="database queries" data-secondary="MySQL database connection" data-type="indexterm" id="DBQmysql10" class="calibre6"/><a contenteditable="false" data-primary="require_once statement (PHP)" data-type="indexterm" id="idm45694719036312" class="calibre6"/><a contenteditable="false" data-primary="include statement (PHP)" data-type="indexterm" id="idm45694719035240" class="calibre6"/> that you have saved the <em class="hyperlink">login.php</em> file, you can include it in any PHP files that will need to access the database by using the <code class="calibre15">require_once</code> statement. This is preferable to an <code class="calibre15">include</code> statement, as it will generate a fatal error if the file is not found—and believe me, not finding the file containing the login details to your database <em class="hyperlink">is</em> a fatal error.</p>

<p class="author1">Also, using <code class="calibre15">require_once</code> instead of <code class="calibre15">require</code> means<a contenteditable="false" data-primary="require statement (PHP)" data-type="indexterm" id="idm45694719009256" class="calibre6"/> that the file will be read in only when it has not previously been included, which prevents wasteful duplicate disk accesses. <a data-type="xref" href="#connecting-to-a-mysql-server-using-pdo" class="calibre6">Example 11-2</a> shows the code<a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="connecting to MySQL server" data-type="indexterm" id="idm45694719040616" class="calibre6"/> to use.</p>

<div data-type="example" id="connecting-to-a-mysql-server-using-pdo" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-2. </span>Connecting to a MySQL server using PDO</h5>

<pre data-code-language="php" data-type="programlisting" class="calibre72">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n"> </code> <code class="k">require_once</code> <code class="s">'login.php'</code><code class="p">;</code>

<code class="n"> </code> <code class="k">try</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$pdo</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code> <code class="nv">$user</code><code class="p">,</code> <code class="nv">$pass</code><code class="p">,</code> <code class="nv">$opts</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="n"> </code> <code class="k">catch</code> <code class="p">(</code><code class="n">PDOException</code> <code class="nv">$e</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">throw</code> <code class="k">new</code> <code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code> <code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>

<p class="author1">This<a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="calling new instances" data-type="indexterm" id="idm45694718890360" class="calibre6"/><a contenteditable="false" data-primary="try...catch command (PHP)" data-type="indexterm" id="idm45694718820808" class="calibre6"/> example creates a new object called <code class="calibre15">$pdo</code> by calling a new instance of the <code class="calibre15">PDO</code> method, passing all the values retrieved from the <em class="hyperlink">login.php</em> file. We achieve error checking by using the <code class="calibre15">try...catch</code> pair of commands.</p>

<p class="author1">The <code class="calibre15">PDO</code> object is used in the following examples to access the MySQL database.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">You<a contenteditable="false" data-primary="security issues" data-secondary="outputting MySQL error messages" data-type="indexterm" id="idm45694718816168" class="calibre6"/> should also never be tempted to output the contents of any error message received from MySQL. Rather than helping your users, you could give away sensitive information to hackers, such as login details. Instead, just guide the user with information on how to overcome their difficulty based on what the error message reports to your code.</p>
</div>

<section data-type="sect3" data-pdf-bookmark="Building and executing a query" class="calibre4"><div class="preface" id="building_and_executing_a_query">
<h3 class="calibre43">Building and executing a query</h3>

<p class="author1">Sending<a contenteditable="false" data-primary="database queries" data-secondary="building/executing" data-type="indexterm" id="idm45694718812280" class="calibre6"/><a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="querying databases with" data-type="indexterm" id="idm45694718810872" class="calibre6"/><a contenteditable="false" data-primary="query method" data-type="indexterm" id="idm45694718809496" class="calibre6"/> a query to MySQL from PHP is as simple as including the relevant SQL in the <code class="calibre15">query</code> method of a connection object. <a data-type="xref" href="#querying-a-database-with-pdo" class="calibre6">Example 11-3</a> shows you how to do this.</p>

<div data-type="example" id="querying-a-database-with-pdo" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-3. </span>Querying a database with PDO</h5>

<pre data-code-language="php" data-type="programlisting" class="calibre72">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n">  </code><code class="nv">$query  </code><code class="o">=</code> <code class="s">"SELECT * FROM classics"</code><code class="p">;</code>
<code class="n">  </code><code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
<code class="cp">?&gt;</code><code class="x"/></pre>
</div>

<p class="author1">As you can see, the MySQL query looks just like what you would type directly at the command line, except that there is no trailing semicolon, as none is needed when you are accessing MySQL from PHP.</p>

<p class="author1">Here the variable <code class="calibre15">$query</code> is assigned a string containing the query to be made and then passed to the <code class="calibre15">query</code> method of the <code class="calibre15">$pdo</code> object, which returns a result that we place in the object <code class="calibre15">$result</code>.</p>

<p class="author1">All the data returned by MySQL is now stored in an easily interrogable format in the <code class="calibre15">$result</code> object.</p>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Fetching a result" class="calibre4"><div class="preface" id="fetching_a_result">
<h3 class="calibre43">Fetching a result</h3>

<p class="author1">Once<a contenteditable="false" data-primary="database queries" data-secondary="fetching results" data-type="indexterm" id="idm45694718776728" class="calibre6"/><a contenteditable="false" data-primary="fetch method" data-type="indexterm" id="idm45694718775320" class="calibre6"/> you have an object returned in <code class="calibre15">$result</code>, you can use it to extract the data you want, one item at a time, using the <code class="calibre15">fetch</code> method of the object. <a data-type="xref" href="#fetching_results_one_row_at_a_time" class="calibre6">Example 11-4</a> combines and extends the previous examples into a program that you can run yourself to retrieve the results (as depicted in <a data-type="xref" href="#output_from_querydotphp" class="calibre6">Figure 11-1</a>). Type this script in and save it using the filename <em class="hyperlink">query.php</em>, or download it from the <a href="https://github.com/RobinNixon/lpmj6" class="calibre6">example repository</a>.</p>

<div data-type="example" id="fetching_results_one_row_at_a_time" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-4. </span>Fetching results one row at a time</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code> <code class="c">// query.php</code>
<code class="n"> </code> <code class="k">require_once</code> <code class="s">'login.php'</code><code class="p">;</code>

<code class="n"> </code> <code class="k">try</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$pdo</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code> <code class="nv">$user</code><code class="p">,</code> <code class="nv">$pass</code><code class="p">,</code> <code class="nv">$opts</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="n"> </code> <code class="k">catch</code> <code class="p">(</code><code class="n">PDOException</code> <code class="nv">$e</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">throw</code> <code class="k">new</code> <code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code> <code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="nv">$query </code> <code class="o">=</code> <code class="s">"SELECT * FROM classics"</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
<code class="n">  </code>
<code class="n"> </code> <code class="k">while</code> <code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">())</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">'Author:   '</code> <code class="o">.</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'author'</code><code class="p">])</code><code class="n">  </code> <code class="o">.</code> <code class="s">"&lt;br&gt;"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">'Title:    '</code> <code class="o">.</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'title'</code><code class="p">])</code><code class="n"> </code>  <code class="n"> </code><code class="o">.</code> <code class="s">"&lt;br&gt;"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">'Category: '</code> <code class="o">.</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'category'</code><code class="p">])</code> <code class="o">.</code> <code class="s">"&lt;br&gt;"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">'Year:     '</code> <code class="o">.</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'year'</code><code class="p">])</code><code class="n"> </code>  <code class="n"> </code> <code class="o">.</code> <code class="s">"&lt;br&gt;"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">'ISBN:     '</code> <code class="o">.</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">])</code><code class="n"> </code>  <code class="n"> </code> <code class="o">.</code> <code class="s">"&lt;br&gt;&lt;br&gt;"</code><code class="p">;</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>

<figure class="calibre23"><div id="output_from_querydotphp" class="figure"><img alt="The output from the query-mysqli.php program in Example 10-5" src="Images/pmj6_1101.png" class="iimagesvscpng"/>
<h6 class="calibre24"><span class="keep-together">Figure 11-1. </span>The output from query.php</h6>
</div></figure>

<p class="author1">Here, each time around the loop, we call the <code class="calibre15">fetch</code> method of the <code class="calibre15">$pdo</code> object to retrieve the value stored in each row, and output the result using <code class="calibre15">echo</code> statements. Don’t worry if you see the results in a different order. This<a contenteditable="false" data-primary="ORDER BY keyword (MySQL)" data-type="indexterm" id="idm45694718606312" class="calibre6"/> is because we have not used an <code class="calibre15">ORDER BY</code> command to specify the order in which they should be returned, so the order will be unspecified.</p>

<p class="author1">When<a contenteditable="false" data-primary="htmlspecialchars function (PHP)" data-type="indexterm" id="idm45694718604248" class="calibre6"/><a contenteditable="false" data-primary="cross-site scripting" data-type="indexterm" id="idm45694718603096" class="calibre6"/><a contenteditable="false" data-primary="XSS attacks" data-type="indexterm" id="idm45694718601992" class="calibre6"/><a contenteditable="false" data-primary="security issues" data-secondary="database hacking prevention" data-type="indexterm" id="idm45694718600888" class="calibre6"/> displaying data in a browser whose source was (or may have been) user input, there’s always a risk of sneaky HTML characters being embedded within it—even if you believe it to have been previously sanitized—which could potentially be used for a cross-site scripting (XSS) attack. The simple way to prevent this possibility is to embed all such output within a call to the function <code class="calibre15">htmlspecialchars</code>, which replaces all such characters with harmless HTML entities. This technique was implemented in the preceding example and will be used in many of the following examples.</p>

<p class="author1">In <a data-type="xref" href="ch09.xhtml#mastering_mysql" class="calibre6">Chapter 9</a>, I talked about First, Second, and Third Normal Form. You may have noticed that the <em class="hyperlink">classics</em> table doesn’t satisfy these, because both author and book details are included within the same table. That’s because we created this table before encountering normalization. However, for the purposes of illustrating access to MySQL from PHP, reusing this table prevents the hassle of typing in a new set of test data, so we’ll stick with it for the time being.</p>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Fetching a row while specifying the style" class="calibre4"><div class="preface" id="fetching_a_row">
<h3 class="calibre43">Fetching a row while specifying the style</h3>

<p class="author1">The <code class="calibre15">fetch</code> method can<a contenteditable="false" data-primary="fetch method" data-type="indexterm" id="idm45694718593768" class="calibre6"/><a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="fetch styles" data-type="indexterm" id="idm45694718592632" class="calibre6"/> return data in various styles, including the following:</p>

<dl class="calibre13">
	<dt class="plain"><code class="calibre15">PDO::FETCH_ASSOC</code></dt>
	<dd class="calibre14">Returns the next row as an array indexed by column name</dd>
	<dt class="plain"><code class="calibre15">PDO::FETCH_BOTH</code> (default)</dt>
	<dd class="calibre14">Returns the next row as an array indexed by both column name and number</dd>
	<dt class="plain"><code class="calibre15">PDO::FETCH_LAZY</code></dt>
	<dd class="calibre14">Returns the next row as an anonymous object with names as properties</dd>
	<dt class="plain"><code class="calibre15">PDO::FETCH_OBJ</code></dt>
	<dd class="calibre14">Returns the next row as an anonymous object with column name as properties</dd>
	<dt class="plain"><code class="calibre15">PDO::FETCH_NUM</code></dt>
	<dd class="calibre14">Returns an array indexed by column number</dd>
</dl>

<p class="author1">For the full list of PDO fetch styles, please refer to the <a href="https://tinyurl.com/pdofetch" class="calibre6">online reference</a>.</p>

<p class="author1">Therefore, the following (slightly changed) example (shown in <a data-type="xref" href="#using-fetch-both" class="calibre6">Example 11-5</a>) shows more clearly the intention of the <code class="calibre15">fetch</code> method in this case. You may wish to save this revised file using the name <em class="hyperlink">fetchrow.php</em>.</p>

<div data-type="example" id="using-fetch-both" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-5. </span>Fetching results one row at a time</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15"> </code><code class="c">//fetchrow.php
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">SELECT * FROM classics</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="n">  </code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">while</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$row</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">(</code><strong class="calibre31"><code class="nx1">PDO</code><code class="o1">::</code><code class="na1">FETCH_BOTH</code></strong><code class="p">))</code><code class="calibre15"> </code><code class="c">// Style of fetch
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">'Author:   '</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'author'</code><code class="p">])</code><code class="n">  </code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">'Title:    '</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'title'</code><code class="p">])</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">'Category: '</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'category'</code><code class="p">])</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">'Year:     '</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'year'</code><code class="p">])</code><code class="n"> </code><code class="calibre15"> </code><code class="n">  </code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">'ISBN:     '</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">])</code><code class="n"> </code><code class="calibre15"> </code><code class="n">  </code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;br&gt;&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">In this modified code, only one-fifth of the interrogations of the <code class="calibre15">$result</code> object are made (compared to the previous example), and only one seek into the object is made in each iteration of the loop, because each row is fetched in its entirety via the <code class="calibre15">fetch</code> method. This returns a single row of data as an array, which is then assigned to the array <code class="calibre15">$row</code>.</p>

<p class="author1">This<a contenteditable="false" data-primary="associative arrays" data-secondary="in PHP" data-type="indexterm" id="idm45694718433496" class="calibre6"/> script uses an associative array. Associative arrays are usually more useful than numeric ones because you can refer to each column by name, such as <code class="calibre15">$row['author']</code>, instead of trying to remember where it is in the column order.</p>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Closing a connection" class="calibre4"><div class="preface" id="closing_a_connection">
<h3 class="calibre43">Closing a connection</h3>

<p class="author1">PHP<a contenteditable="false" data-primary="database queries" data-secondary="closing connections" data-type="indexterm" id="idm45694718212792" class="calibre6"/> will eventually return the memory it has allocated for objects after you have finished with the script, so in small scripts, you don’t usually need to worry about releasing memory yourself. However, should you wish to close a PDO connection manually, you simply set it to <code class="calibre15">null</code> like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$pdo</code> <code class="o">=</code> <code class="k">null</code><code class="p">;</code></pre>
</div></section>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="A Practical Example" class="calibre4"><div class="preface" id="practical_example">
<h1 class="calibre11">A Practical Example</h1>

<p class="author1">It’s time<a contenteditable="false" data-primary="database queries" data-secondary="example of" data-type="indexterm" id="DBQexamp10" class="calibre6"/> to write our first example of inserting data in and deleting it from a MySQL table using PHP. I recommend that you type <a data-type="xref" href="#inserting_and_deleting_using_sqltestdotp" class="calibre6">Example 11-6</a> and save it to your web development directory using the filename <em class="hyperlink">sqltest.php</em>. You can see an example of the program’s output in <a data-type="xref" href="#output_from_example_10-8comma_sqltes" class="calibre6">Figure 11-2</a>.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1"><a data-type="xref" href="#inserting_and_deleting_using_sqltestdotp" class="calibre6">Example 11-6</a> creates a standard HTML form. <a data-type="xref" href="ch12.xhtml#form_handling" class="calibre6">Chapter 12</a> explains forms in detail, but in this chapter I take form handling for granted and just deal with database interaction.</p>
</div>

<div data-type="example" id="inserting_and_deleting_using_sqltestdotp" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-6. </span>Inserting and deleting using sqltest.php</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code> <code class="c">// sqltest.php</code>
<code class="n"> </code> <code class="k">require_once</code> <code class="s">'login.php'</code><code class="p">;</code>

<code class="n"> </code> <code class="k">try</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$pdo</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code> <code class="nv">$user</code><code class="p">,</code> <code class="nv">$pass</code><code class="p">,</code> <code class="nv">$opts</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="n"> </code> <code class="k">catch</code> <code class="p">(</code><code class="n">PDOException</code> <code class="nv">$e</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">throw</code> <code class="k">new</code> <code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code> <code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="k">if</code> <code class="p">(</code><code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'delete'</code><code class="p">])</code> <code class="o">&amp;&amp;</code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">]))</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$isbn </code> <code class="n"> </code><code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'isbn'</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$query </code> <code class="o">=</code> <code class="s">"DELETE FROM classics WHERE isbn=</code><code class="err">$isbn</code><code class="s">"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="k">if</code> <code class="p">(</code><code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'author'</code><code class="p">])</code><code class="n"> </code> <code class="n"> </code><code class="o">&amp;&amp;</code>
<code class="n"> </code> <code class="n"> </code> <code class="n"> </code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'title'</code><code class="p">])</code><code class="n"> </code> <code class="n"> </code> <code class="o">&amp;&amp;</code>
<code class="n"> </code> <code class="n"> </code> <code class="n"> </code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'category'</code><code class="p">])</code> <code class="o">&amp;&amp;</code>
<code class="n"> </code> <code class="n"> </code> <code class="n"> </code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'year'</code><code class="p">])</code><code class="n"> </code> <code class="n"> </code> <code class="n"> </code><code class="o">&amp;&amp;</code>
<code class="n"> </code> <code class="n"> </code> <code class="n"> </code> <code class="nb">isset</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">]))</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$author </code> <code class="n"> </code><code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'author'</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$title </code> <code class="n"> </code> <code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'title'</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$category</code> <code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'category'</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$year </code> <code class="n"> </code> <code class="n"> </code><code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'year'</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$isbn </code> <code class="n"> </code> <code class="n"> </code><code class="o">=</code> <code class="n">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="s">'isbn'</code><code class="p">);</code>
<code class="n"> </code> <code class="n">  </code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$query </code> <code class="n"> </code> <code class="o">=</code> <code class="s">"INSERT INTO classics VALUES"</code> <code class="o">.</code>
<code class="n"> </code> <code class="n"> </code> <code class="n"> </code> <code class="s">"(</code><code class="err">$author</code><code class="s">, </code><code class="err">$title</code><code class="s">, </code><code class="err">$category</code><code class="s">, </code><code class="err">$year</code><code class="s">, </code><code class="err">$isbn</code><code class="s">)"</code><code class="p">;</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="k">echo</code> <code class="s">&lt;&lt;&lt;_END</code>
<code class="s">  &lt;form action="sqltest.php" method="post"&gt;&lt;pre&gt;</code>
<code class="s">    Author &lt;input type="text" name="author"&gt;</code>
<code class="s">     Title &lt;input type="text" name="title"&gt;</code>
<code class="s">  Category &lt;input type="text" name="category"&gt;</code>
<code class="s">      Year &lt;input type="text" name="year"&gt;</code>
<code class="s">      ISBN &lt;input type="text" name="isbn"&gt;</code>
<code class="s">           &lt;input type="submit" value="ADD RECORD"&gt;</code>
<code class="s">  &lt;/pre&gt;&lt;/form&gt;</code>
<code class="s">_END;</code>

<code class="n"> </code> <code class="nv">$query </code> <code class="o">=</code> <code class="s">"SELECT * FROM classics"</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>

<code class="n"> </code> <code class="k">while</code> <code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">())</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$r0</code> <code class="o">=</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'author'</code><code class="p">]);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$r1</code> <code class="o">=</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'title'</code><code class="p">]);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$r2</code> <code class="o">=</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'category'</code><code class="p">]);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$r3</code> <code class="o">=</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'year'</code><code class="p">]);</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$r4</code> <code class="o">=</code> <code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">]);</code>
<code class="n"> </code> <code class="n">  </code>
<code class="n"> </code> <code class="n"> </code> <code class="k">echo</code> <code class="s">&lt;&lt;&lt;_END</code>
<code class="s">  &lt;pre&gt;</code>
<code class="s">    Author $r0</code>
<code class="s">     Title $r1</code>
<code class="s">  Category $r2</code>
<code class="s">      Year $r3</code>
<code class="s">      ISBN $r4</code>
<code class="s">  &lt;/pre&gt;</code>
<code class="s">  &lt;form action='sqltest.php' method='post'&gt;</code>
<code class="s">  &lt;input type='hidden' name='delete' value='yes'&gt;</code>
<code class="s">  &lt;input type='hidden' name='isbn' value='$r4'&gt;</code>
<code class="s">  &lt;input type='submit' value='DELETE RECORD'&gt;&lt;/form&gt;</code>
<code class="s">_END;</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="k">function</code> <code class="nf">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$var</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">quote</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="nv">$var</code><code class="p">]);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>

<figure class="calibre23"><div id="output_from_example_10-8comma_sqltes" class="figure"><img alt="The output from Example 10-8, sqltest.php" src="Images/pmj6_1102.png" class="iimagesvscpng"/>
<h6 class="calibre24"><span class="keep-together">Figure 11-2. </span>The output from <a data-type="xref" href="#inserting_and_deleting_using_sqltestdotp" class="calibre6">Example 11-6</a>, sqltest.php</h6>
</div></figure>

<p class="author1">At almost 80 lines of code, this program may appear daunting, but don’t worry—you’ve already covered many of those lines in <a data-type="xref" href="#fetching_results_one_row_at_a_time" class="calibre6">Example 11-4</a>, and what the code does is actually quite simple.</p>

<p class="author1">It<a contenteditable="false" data-primary="database queries" data-secondary="fetching rows" data-type="indexterm" id="idm45694718153032" class="calibre6"/> first checks for any inputs that may have been made and then either inserts new data into the table <em class="hyperlink">classics</em> of the <em class="hyperlink">publications</em> database or deletes a row from it, according to the input supplied. Regardless of whether there was input, the program then outputs all rows in the table to the browser. So, let’s see how it works.</p>

<p class="author1">The first section of new code starts by using the <code class="calibre15">isset</code> function to check whether values for all the fields have been posted to the program. Upon confirmation, each line within the <code class="calibre15">if</code> statement calls the function <code class="calibre15">get_post</code>, which appears at the end of the program. This function has one small but critical job: fetching input from the browser.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">For reasons of clarity and brevity, and to explain things as simply as possible, many of the following examples omit certain very sensible security precautions that would have made them longer and possibly detract from explaining their function in the clearest manner. Therefore, it is important that you don’t skip past the section later in this chapter on preventing your database from being hacked (<a data-type="xref" href="#preventing_hacking_attempts" class="calibre6">“Preventing Hacking Attempts”</a>), in which you will learn about additional actions you can take with your code to secure it.</p>
</div>

<section data-type="sect2" data-pdf-bookmark="The $_POST Array" class="calibre4"><div class="preface" id="dollar_post_array">
<h2 class="calibre28">The $_POST Array</h2>

<p class="author1">I mentioned<a contenteditable="false" data-primary="MySQL" data-secondary="$_POST arrays" data-secondary-sortas="POST arrays" data-type="indexterm" id="idm45694717756008" class="calibre6"/><a contenteditable="false" data-primary="$_POST arrays" data-type="indexterm" id="idm45694717754328" class="calibre6"/><a contenteditable="false" data-primary="$_POST Array (PHP)" data-primary-sortas="POST Array (PHP)" data-type="indexterm" id="idm45694717753224" class="calibre6"/> in an earlier chapter that a browser sends user input through either a GET request or a POST request. The POST request is usually preferred (because it prevents placing unsightly data in the browser’s address bar), and so we use it here. The web server bundles up all of the user input (even if the form was filled out with a hundred fields) and puts it into an array named <code class="calibre15">$_POST</code>.</p>

<p class="author1"><code class="calibre15">$_POST</code> is an associative array, which you encountered in <a data-type="xref" href="ch06.xhtml#php_arrays" class="calibre6">Chapter 6</a>. Depending<a contenteditable="false" data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="POST method" data-type="indexterm" id="idm45694717748984" class="calibre6"/><a contenteditable="false" data-primary="HTTP (Hypertext Transfer Protocol)" data-secondary="GET method" data-type="indexterm" id="idm45694717747560" class="calibre6"/> on whether a form has been set to use the POST or the GET method, either the <code class="calibre15">$_POST</code> or the <code class="calibre15">$_GET</code> associative array<a contenteditable="false" data-primary="$_GET array" data-primary-sortas="GET array" data-type="indexterm" id="idm45694717745176" class="calibre6"/> will be populated with the form data. They can both be read in exactly the same way.</p>

<p class="author1">Each field has an element in the array named after that field. So, if a form contains a field named <code class="calibre15">isbn</code>, the <code class="calibre15">$_POST</code> array contains an element keyed by the word <code class="calibre15">isbn</code>. The PHP program can read that field by referring to either <code class="calibre15">$_POST['isbn']</code> or <code class="calibre15">$_POST["isbn"]</code> (single and double quotes have the same effect in this case).</p>

<p class="author1">If the <code class="calibre15">$_POST</code> syntax still seems complex to you, rest assured that you can just use the convention I’ve shown in <a data-type="xref" href="#inserting_and_deleting_using_sqltestdotp" class="calibre6">Example 11-6</a>, copy the user’s input to other variables, and forget about <code class="calibre15">$_POST</code> after that. This is normal in PHP programs: they retrieve all the fields from <code class="calibre15">$_POST</code> at the beginning of the program and then ignore it.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">There is no reason to write to an element in the <code class="calibre15">$_POST</code> array. Its only purpose is to communicate information from the browser to the program, and you’re better off copying data to your own variables before altering it.</p>
</div>

<p class="author1">So, back to the <code class="calibre15">get_post</code> function, which passes each item it retrieves through the <code class="calibre15"><span class="keep-together">quote</span></code> method of the PDO object to escape any quotes that a hacker may have inserted in order to break into or alter your database, like this, and it adds quotes around each string for you:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="k">function</code> <code class="nf">get_post</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$var</code><code class="p">)</code>
<code class="p">{</code>
  <code class="k">return</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">quote</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="nv">$var</code><code class="p">]);</code>
<code class="p">}</code></pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Deleting a Record" class="calibre4"><div class="preface" id="deleting_a_record">
<h2 class="calibre28">Deleting a Record</h2>

<p class="author1">Prior<a contenteditable="false" data-primary="tables" data-secondary="deleting data" data-type="indexterm" id="idm45694717718360" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, deleting data in" data-type="indexterm" id="idm45694717716952" class="calibre6"/> to checking whether new data has been posted, the program checks whether the variable <code class="calibre15">$_POST['delete']</code> has a value. If so, the user has clicked the DELETE RECORD button to erase a record. In this case, the value of <code class="calibre15">$isbn</code> will also have been posted.</p>

<p class="author1">As you’ll recall, the ISBN uniquely identifies each record. The HTML form appends the ISBN to the <code class="calibre15">DELETE FROM</code> query string created in the variable <code class="calibre15">$query</code>, which is then passed to the <code class="calibre15">query</code> method of the <code class="calibre15">$conn</code> object to issue it to MySQL.</p>

<p class="author1">If <code class="calibre15">$_POST['delete']</code> is not set (and there is no record to be deleted), <span class="keep-together"><code class="calibre15">$_POST['author']</code></span> and other posted values are checked. If they have all been given values, <code class="calibre15">$query</code> is set to an <code class="calibre15">INSERT INTO</code> command, followed by the five values to be inserted. The string is then passed to the <code class="calibre15">query</code> method.</p>

<p class="author1">If any query fails, the <code class="calibre15">try...catch</code> commands will cause an error to be issued. On a production website, you will not want these very programmer-oriented error messages to show, and you will need to replace your <code class="calibre15">CATCH</code> statement with one in which you handle the error yourself neatly and decide what sort of error message (if any) to give to your users.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Displaying the Form" class="calibre4"><div class="preface" id="displaying_the_form">
<h2 class="calibre28">Displaying the Form</h2>

<p class="author1">Before<a contenteditable="false" data-primary="MySQL" data-secondary="displaying HTML form" data-type="indexterm" id="idm45694717705368" class="calibre6"/><a contenteditable="false" data-primary="htmlspecialchars function (PHP)" data-type="indexterm" id="idm45694717703960" class="calibre6"/> displaying the little form (as shown in <a data-type="xref" href="#output_from_example_10-8comma_sqltes" class="calibre6">Figure 11-2</a>), the program sanitizes copies of the elements we will be outputting from the <code class="calibre15">$row</code> array into the variables <code class="calibre15">$r0</code> through <code class="calibre15">$r4</code> by passing them to the <code class="calibre15">htmlspecialchars</code> function, to replace any potentially dangerous HTML characters with harmless HTML entities.</p>

<p class="author1">Then the part of code that displays the output follows, using an <code class="calibre15">echo &lt;&lt;&lt;_END..._END</code> structure as seen in previous chapters, which outputs everything between the <code class="calibre15">_END</code> tags.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Instead of using the <code class="calibre15">echo</code> command, the program could drop out of PHP using <code class="calibre15">?&gt;</code>, issue the HTML, and then reenter PHP processing with <code class="calibre15">&lt;?php</code>. Which style is used is a matter of programmer preference, but I always recommend staying within PHP code, for these reasons:</p>

<ul class="calibre73">
	<li class="calibre9">
	<p class="author1">It makes it very clear when you’re debugging (and also for other users) that everything within a <em class="hyperlink">.php</em> file is PHP code. Therefore, there is no need to go hunting for dropouts to HTML.</p>
	</li>
	<li class="calibre9">
	<p class="author1">When you wish to include a PHP variable directly within HTML, you can just type it. If you had dropped back to HTML, you would have had to temporarily reenter PHP processing, access the variable, and then drop back out again.</p>
	</li>
</ul>
</div>

<p class="author1">The HTML form section simply sets the form’s action to <em class="hyperlink">sqltest.php</em>. This means that when the form is submitted, the contents of the form fields will be sent to the file <em class="hyperlink">sqltest.php</em>, which is the program itself. The form is also set up to send the fields as a POST rather than a GET request. This is because GET requests are appended to the URL being submitted and can look messy in your browser. They also allow users to easily modify submissions and try to hack your server (although that can also be achieved with in-browser developer tools). Additionally, avoiding GET requests prevents too much information appearing in server logfiles. Therefore, whenever possible, you should use POST submissions, which also have the benefit of revealing less posted data.</p>

<p class="author1">Having output the form fields, the HTML displays a submit button with the name ADD RECORD and closes the form. Note the <code class="calibre15">&lt;pre&gt;</code> and <code class="calibre15">&lt;/pre&gt;</code> tags here, which have been used to force a monospaced font that lines up all the inputs neatly. The carriage returns at the end of each line are also output when inside <code class="calibre15">&lt;pre&gt;</code> tags.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Querying the Database" class="calibre4"><div class="preface" id="querying_the_database">
<h2 class="calibre28">Querying the Database</h2>

<p class="author1">Next, the code returns to the familiar territory of <a data-type="xref" href="#fetching_results_one_row_at_a_time" class="calibre6">Example 11-4</a>, where a query is sent to MySQL asking to see all the records in the <em class="hyperlink">classics</em> table, like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$query</code>  <code class="o">=</code> <code class="s">"SELECT * FROM classics"</code><code class="p">;</code>
<code class="nv">$result</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code></pre>

<p class="author1">Next<a contenteditable="false" data-primary="while loops" data-secondary="in PHP" data-type="indexterm" id="idm45694717518152" class="calibre6"/> a <code class="calibre15">while</code> loop is then entered to display the contents of each row. Then the program populates the array <code class="calibre15">$row</code> with a row of results by calling the <code class="calibre15">fetch</code> method of <code class="calibre15">$result</code>.</p>

<p class="author1">With the data in <code class="calibre15">$row</code>, it’s now a simple matter to display it within the heredoc <code class="calibre15">echo</code> statement that follows, in which I have chosen to use a <code class="calibre15">&lt;pre&gt;</code> tag to line up the display of each record in a pleasing manner.</p>

<p class="author1">After the display of each record, there is a second form that also posts to <em class="hyperlink">sqltest.php</em> (the program itself) but this time contains two hidden fields: <code class="calibre15">delete</code> and <code class="calibre15">isbn</code>. The <code class="calibre15">delete</code> field is set to <code class="calibre15">yes</code> and <code class="calibre15">isbn</code> to the value held in <code class="calibre15">$row[isbn]</code>, which contains the ISBN for the record.</p>

<p class="author1">Then a submit button with the name Delete Record is displayed, and the form is closed. A curly brace then completes the <code class="calibre15">while</code> loop, which will continue until all records have been displayed.</p>

<p class="author1">Finally, you see the definition for the function <code class="calibre15">get_post</code>, which we’ve already looked at. And that’s it—our first PHP program to manipulate a MySQL database. So, let’s check out what it can do.</p>

<p class="author1">Once you have typed the program (and corrected any typing errors), try entering the following data into the various input fields to add a new record for the book <em class="hyperlink">Moby Dick</em> to the database:</p>

<pre data-programming-language="perl" class="calibre29">
Herman Melville
Moby Dick
Fiction
1851
9780199535729</pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Running the Program" class="calibre4"><div class="preface" id="running_the_program">
<h2 class="calibre28">Running the Program</h2>

<p class="author1">When you have submitted this data using the Add Record button, scroll down the web page to see the new addition. It<a contenteditable="false" data-primary="ORDER BY keyword (MySQL)" data-type="indexterm" id="idm45694717494040" class="calibre6"/> should look something like <a data-type="xref" href="#result_of_adding_moby_dick_to_the_da" class="calibre6">Figure 11-3</a>, although since we have not ordered the results using <code class="calibre15">ORDER BY</code> , the position in which it appears is undetermined.</p>

<figure class="calibre23"><div id="result_of_adding_moby_dick_to_the_da" class="figure"><img alt="The result of adding Moby Dick to the database" class="iimagesvscpng" src="Images/pmj6_1103.png"/>
<h6 class="calibre24"><span class="keep-together">Figure 11-3. </span>The result of adding Moby Dick to the database</h6>
</div></figure>

<p class="author1">Now let’s look at how deleting a record works by creating a dummy record. Try entering just the number <code class="calibre15">1</code> in each of the five fields and clicking the Add Record button. If you now scroll down, you’ll see a new record consisting just of 1s. Obviously, this record isn’t useful in this table, so now click the Delete Record button and scroll down again to confirm that the record has been deleted.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Assuming that everything worked, you are now able to add and delete records at will. Try doing this a few times, but leave the main records in place (including the new one for <em class="hyperlink">Moby Dick</em>), as we’ll be using them later. You could also try adding the record with all 1s again a couple of times and note the error message that you receive the second time, indicating that there is already an ISBN with the number 1.<a contenteditable="false" data-primary="" data-startref="DBQexamp10" data-type="indexterm" id="idm45694717486120" class="calibre6"/></p>
</div>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Practical MySQL" class="calibre4"><div class="preface" id="practical_mysql">
<h1 class="calibre11">Practical MySQL</h1>

<p class="author1">You are now ready to look at some practical techniques that you can use in PHP to access the MySQL database, including tasks such as creating and dropping tables; inserting, updating, and deleting data; and protecting your database and website from malicious users. Note that the following examples assume that you’ve already created the <em class="hyperlink">login.php</em> program discussed earlier in this chapter.</p>

<section data-type="sect2" data-pdf-bookmark="Creating a Table" class="calibre4"><div class="preface" id="creating_a_table-id00030">
<h2 class="calibre28">Creating a Table</h2>

<p class="author1">Let’s assume<a contenteditable="false" data-primary="database queries" data-secondary="table creation" data-type="indexterm" id="idm45694717462248" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, creating" data-type="indexterm" id="idm45694717460840" class="calibre6"/> that you are working for a wildlife park and need to create a database to hold details about all the types of cats it houses. You are told that there are nine <em class="hyperlink">families</em> of cats—Lion, Tiger, Jaguar, Leopard, Cougar, Cheetah, Lynx, Caracal, and Domestic—so you’ll need a column for that. Then each cat has been given a <em class="hyperlink">name</em>, so that’s another column, and you also want to keep track of their <em class="hyperlink">ages</em>, which is another. Of course, you will probably need more columns later, perhaps to hold dietary requirements, inoculations, and other details, but for now that’s enough to get going. A unique identifier is also needed for each animal, so you also decide to create a column for that called <em class="hyperlink">id</em>.</p>

<p class="author1"><a data-type="xref" href="#creating_a_table_called_cats" class="calibre6">Example 11-7</a> shows the code you might use to create a MySQL table to hold this data, with the main query assignment in bold text.</p>

<div data-type="example" id="creating_a_table_called_cats" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-7. </span>Creating a table called cats</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">CREATE TABLE cats (
    id SMALLINT NOT NULL AUTO_INCREMENT,
    family VARCHAR(32) NOT NULL,
    name VARCHAR(32) NOT NULL,
    age TINYINT NOT NULL,
    PRIMARY KEY (id)</code></strong><code class="s">
  )</code><code class="s">"</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">As you can see, the MySQL query looks just like what you would type directly at the command line, except without the trailing semicolon.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Describing a Table" class="calibre4"><div class="preface" id="describing_a_table">
<h2 class="calibre28">Describing a Table</h2>

<p class="author1">When<a contenteditable="false" data-primary="tables" data-secondary="describing" data-type="indexterm" id="idm45694717647352" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, describing" data-type="indexterm" id="idm45694717654056" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, describing" data-type="indexterm" id="idm45694717652680" class="calibre6"/> you aren’t logged in to the MySQL command line, here’s a handy piece of code that you can use to verify that a table has been correctly created from inside a browser. It simply issues the query <code class="calibre15">DESCRIBE cats</code> and then outputs an HTML table with four headings—<em class="hyperlink">Column</em>, <em class="hyperlink">Type</em>, <em class="hyperlink">Null</em>, and <em class="hyperlink">Key</em>—underneath which all columns within the table are shown. To use it with other tables, simply replace the name <code class="calibre15">cats</code> in the query with that of the new table (see <a data-type="xref" href="#describing_the_table_cats" class="calibre6">Example 11-8</a>).</p>

<div data-type="example" id="describing_the_table_cats" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-8. </span>Describing the cats table</h5>

<pre data-code-language="php" data-type="programlisting" class="calibre72">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">DESCRIBE cats</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;table&gt;&lt;tr&gt;&lt;th&gt;Column&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Null&lt;/th&gt;&lt;th&gt;Key&lt;/th&gt;&lt;/tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">while</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$row</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">(</code><strong class="calibre31"><code class="nx1">PDO</code><code class="o1">::</code><code class="na1">FETCH_NUM</code></strong><code class="p">))</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">for</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$k</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="mi">0</code><code class="calibre15"> </code><code class="p">;</code><code class="calibre15"> </code><code class="nv">$k</code><code class="calibre15"> </code><code class="o">&lt;</code><code class="calibre15"> </code><code class="mi">4</code><code class="calibre15"> </code><code class="p">;</code><code class="calibre15"> </code><code class="o">++</code><code class="nv">$k</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;td&gt;</code><code class="s">"</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="nv">$k</code><code class="p">])</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/td&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/table&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">See<a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="fetch styles" data-type="indexterm" id="idm45694717174344" class="calibre6"/> how the PDO fetch style of <code class="calibre15">FETCH_NUM</code> is used to return a numeric array so that it is easy to display the contents of the returned data without using names. The output from the program should look like this:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Column Type        Null Key
id     smallint(6) NO   PRI
family varchar(32) NO
name   varchar(32) NO
age    tinyint(4)  NO</strong></pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Dropping a Table" class="calibre4"><div class="preface" id="dropping_a_table">
<h2 class="calibre28">Dropping a Table</h2>

<p class="author1">Dropping<a contenteditable="false" data-primary="tables" data-secondary="dropping" data-type="indexterm" id="idm45694717444840" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, dropping" data-type="indexterm" id="idm45694717443432" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, dropping" data-type="indexterm" id="idm45694717258328" class="calibre6"/> a table is very easy to do and is therefore very dangerous, so be careful. <a data-type="xref" href="#dropping_the_table_cats" class="calibre6">Example 11-9</a> shows the code that you need. However, I don’t recommend that you try it until you have been through the other examples (up to <a data-type="xref" href="#performing_additional_queries" class="calibre6">“Performing Additional Queries”</a>), as it will drop the table <em class="hyperlink">cats</em> and you’ll have to re-create it using <a data-type="xref" href="#creating_a_table_called_cats" class="calibre6">Example 11-7</a>.</p>

<div data-type="example" id="dropping_the_table_cats" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-9. </span>Dropping the cats table</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">DROP TABLE cats</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Adding Data" class="calibre4"><div class="preface" id="adding_data">
<h2 class="calibre28">Adding Data</h2>

<p class="author1">Let’s add<a contenteditable="false" data-primary="tables" data-secondary="adding data to" data-type="indexterm" id="idm45694716991112" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, adding data to" data-type="indexterm" id="idm45694717055560" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, adding data to" data-type="indexterm" id="idm45694717054184" class="calibre6"/> some data to the table now, using the code in <a data-type="xref" href="#adding_data_to_table_cats" class="calibre6">Example 11-10</a>.</p>

<div data-type="example" id="adding_data_to_table_cats" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-10. </span>Adding data to the cats table</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">INSERT INTO cats VALUES(NULL, 'Lion', 'Leo', 4)</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">You may wish to add a couple more items of data by modifying <code class="calibre15">$query</code> as follows and calling up the program in your browser again:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$query</code> <code class="o">=</code> <code class="s">"INSERT INTO cats VALUES(NULL, 'Cougar', 'Growler', 2)"</code><code class="p">;</code>
<code class="nv">$query</code> <code class="o">=</code> <code class="s">"INSERT INTO cats VALUES(NULL, 'Cheetah', 'Charly', 3)"</code><code class="p">;</code></pre>

<p class="author1">By the way, notice the <code class="calibre15">NULL</code> value passed as the first parameter? This is because the <em class="hyperlink">id</em> column is of type <code class="calibre15">AUTO_INCREMENT</code>, and MySQL will decide what value to assign according to the next available number in sequence. So, we simply pass a <code class="calibre15">NULL</code> value, which will be ignored.</p>

<p class="author1">Of course, the most efficient way to populate MySQL with data is to create an array and insert the data with a single query.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">At this point in the book, I am concentrating on showing you how to directly insert data into MySQL (and providing some security precautions to keep the process safe). However, later in this book we’ll move on to a better method you can employ that involves <span class="keep-together">placeholders</span> (see <a data-type="xref" href="#using_placeholders" class="calibre6">“Using Placeholders”</a>), which make it virtually impossible for users to inject malicious hacks into your database. So, as you read this section, do understand that these are the basics of how MySQL insertion works, and remember that we will improve upon it later.</p>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Retrieving Data" class="calibre4"><div class="preface" id="retrieving_data">
<h2 class="calibre28">Retrieving Data</h2>

<p class="author1">Now<a contenteditable="false" data-primary="tables" data-secondary="retrieving data" data-type="indexterm" id="idm45694717007768" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, retrieving data from" data-type="indexterm" id="idm45694716878168" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, retrieving data from" data-type="indexterm" id="idm45694717015912" class="calibre6"/> that some data has been entered into the <em class="hyperlink">cats</em> table, <a data-type="xref" href="#retrieving-rows-from-the-cats-table" class="calibre6">Example 11-11</a> shows how you can check that it was correctly inserted.</p>

<div data-type="example" id="retrieving-rows-from-the-cats-table" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-11. </span>Retrieving rows from the cats table</h5>

<pre data-code-language="php" data-type="programlisting" class="calibre72">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">SELECT * FROM cats</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;table&gt;&lt;tr&gt; &lt;th&gt;Id&lt;/th&gt; &lt;th&gt;Family&lt;/th&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Age&lt;/th&gt;&lt;/tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">while</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$row</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">(</code><strong class="calibre31"><code class="nx1">PDO</code><code class="o1">::</code><code class="na1">FETCH_NUM</code></strong><code class="p">))</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n">    echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">for</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$k</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="mi">0</code><code class="calibre15"> </code><code class="p">;</code><code class="calibre15"> </code><code class="nv">$k</code><code class="calibre15"> </code><code class="o">&lt;</code><code class="calibre15"> </code><code class="mi">4</code><code class="calibre15"> </code><code class="p">;</code><code class="calibre15"> </code><code class="o">++</code><code class="nv">$k</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;td&gt;</code><code class="s">"</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="nv">$k</code><code class="p">])</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/td&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n">    echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/tr&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&lt;/table&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">This code simply issues the MySQL query <code class="calibre15">SELECT * FROM cats</code> and then displays all the rows returned by requiring them in the form of numerically accessed arrays with the style of <code class="calibre15">PDO::FETCH_NUM</code>. Its output is as follows:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Id Family  Name    Age
1  Lion    Leo     4
2  Cougar  Growler 2
3  Cheetah Charly  3</strong></pre>

<p class="author1">Here you can see that the <em class="hyperlink">id</em> column has correctly auto-incremented.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Updating Data" class="calibre4"><div class="preface" id="updating_data">
<h2 class="calibre28">Updating Data</h2>

<p class="author1">Changing<a contenteditable="false" data-primary="tables" data-secondary="updating data" data-type="indexterm" id="idm45694716774936" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, updating data in" data-type="indexterm" id="idm45694716773528" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, updating data in" data-type="indexterm" id="idm45694716772184" class="calibre6"/> data that you have already inserted is also quite simple. Did you notice the spelling of <em class="hyperlink">Charly</em> for the cheetah’s name? Let’s correct that to <em class="hyperlink">Charlie</em>, as in <a data-type="xref" href="#renaming_charly_the_cheetah_to_charlie" class="calibre6">Example 11-12</a>.</p>

<div data-type="example" id="renaming_charly_the_cheetah_to_charlie" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-12. </span>Changing the name Charly the cheetah to Charlie</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">UPDATE cats SET name='Charlie' WHERE name='Charly'</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">If you run <a data-type="xref" href="#retrieving-rows-from-the-cats-table" class="calibre6">Example 11-11</a> again, you’ll see that it now outputs the following:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Id Family  Name    Age
1  Lion    Leo     4
2  Cougar  Growler 2
3  Cheetah Charlie 3</strong></pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Deleting Data" class="calibre4"><div class="preface" id="deleting_data">
<h2 class="calibre28">Deleting Data</h2>

<p class="author1">Growler<a contenteditable="false" data-primary="tables" data-secondary="deleting data" data-type="indexterm" id="idm45694716363640" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, deleting data in" data-type="indexterm" id="idm45694716362232" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="tables, deleting data in" data-type="indexterm" id="idm45694716746168" class="calibre6"/> the cougar has been transferred to another zoo, so it’s time to remove him from the database; see <a data-type="xref" href="#removing_growler_the_cougar_from_the_cat" class="calibre6">Example 11-13</a>.</p>

<div data-type="example" id="removing_growler_the_cougar_from_the_cat" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-13. </span>Removing Growler the cougar from the cats table</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">DELETE FROM cats WHERE name='Growler'</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">This uses a standard <code class="calibre15">DELETE FROM</code> query, and when you run <a data-type="xref" href="#retrieving-rows-from-the-cats-table" class="calibre6">Example 11-11</a>, you can see that the row has been removed in the following output:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Id Family  Name    Age
1  Lion    Leo     4
3  Cheetah Charlie 3</strong></pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using AUTO_INCREMENT" class="calibre4"><div class="preface" id="using_auto_increment">
<h2 class="calibre28">Using AUTO_INCREMENT</h2>

<p class="author1">When<a contenteditable="false" data-primary="MySQL" data-secondary="AUTO_INCREMENT" data-type="indexterm" id="idm45694716239848" class="calibre6"/><a contenteditable="false" data-primary="AUTO_INCREMENT data type (MySQL)" data-type="indexterm" id="idm45694716347672" class="calibre6"/><a contenteditable="false" data-primary="database queries" data-secondary="AUTO_INCREMENT" data-type="indexterm" id="idm45694716346712" class="calibre6"/> using <code class="calibre15">AUTO_INCREMENT</code>, you cannot know what value has been given to a column before a row is inserted. Instead, if you need to know it, you must ask MySQL afterward using the <code class="calibre15">mysql_insert_id</code> function. This need is common: for instance, when you process a purchase, you might insert a new customer into a <em class="hyperlink">Customers</em> table and then refer to the newly created <em class="hyperlink">CustId</em> when inserting a purchase into the <em class="hyperlink">Purchases</em> table.</p>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Using <code class="calibre15">AUTO_INCREMENT</code> is recommended instead of selecting the highest ID in the <em class="hyperlink">id</em> column and incrementing it by one, because concurrent queries could change the values in that column after the highest value has been fetched and before the calculated value is stored.</p>
</div>

<p class="author1"><a data-type="xref" href="#adding_data_to_table_cats" class="calibre6">Example 11-10</a> can be rewritten as <a data-type="xref" href="#adding_data_to_table_cats_and_reporting" class="calibre6">Example 11-14</a> to display this value after each insert.</p>

<div data-type="example" id="adding_data_to_table_cats_and_reporting" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-14. </span>Adding data to the cats table and reporting the insert ID</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n">  </code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">INSERT INTO cats VALUES(NULL, 'Lynx', 'Stumpy', 5</code></strong><code class="s">)</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">The Insert ID was: </code><code class="s">"</code><code class="calibre15"> </code><code class="o">.</code><code class="calibre15"> </code><strong class="calibre31"><code class="nv1">$pdo</code><code class="o1">-&gt;</code><code class="na1">lastInsertId</code><code class="p1">()</code></strong><code class="p">;</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">The contents of the table should now look like the following (note how the previous <em class="hyperlink">id</em> value of <code class="calibre15">2</code> is <em class="hyperlink">not</em> reused, as this could cause complications in some instances):</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Id Family  Name    Age</strong>
1  Lion    Leo     4
3  Cheetah Charlie 3
4  Lynx    Stumpy  5</pre>

<section data-type="sect3" data-pdf-bookmark="Using insert IDs" class="calibre4"><div class="preface" id="using_insert_ids">
<h3 class="calibre43">Using insert IDs</h3>

<p class="author1">It’s very<a contenteditable="false" data-primary="mysql_insert_id function" data-type="indexterm" id="idm45694716075176" class="calibre6"/> common to insert data in multiple tables: a book followed by its author, a customer followed by their purchase, and so on. When doing this with an auto-increment column, you will need to retain the insert ID returned for storing in the related table.</p>

<p class="author1">For example, let’s assume that these cats can be “adopted” by the public as a means of raising funds, and that when a new cat is stored in the <em class="hyperlink">cats</em> table, we also want to create a key to tie it to the animal’s adoptive owner. The code to do this is similar to that in <a data-type="xref" href="#adding_data_to_table_cats_and_reporting" class="calibre6">Example 11-14</a>, except that the returned insert ID is stored in the variable <span class="keep-together"><code class="calibre15">$insertID</code></span> and is then used as part of the subsequent query:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$query</code><code class="calibre15">    </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">INSERT INTO cats VALUES(NULL, 'Lynx', 'Stumpy', 5)</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="nv">$result</code><code class="calibre15">   </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">
</code><strong class="calibre31"><code class="nv1">$insertID</code></strong><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">lastInsertId</code><code class="p">();</code><code class="calibre15">

</code><code class="nv">$query</code><code class="calibre15">    </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">INSERT INTO owners VALUES(</code><strong class="calibre31"><code class="si">$insertID</code></strong><code class="s">, 'Ann', 'Smith')</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="nv">$result</code><code class="calibre15">   </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code></pre>

<p class="author1">Now the cat is connected to its “owner” through the cat’s unique ID, which was created automatically by <code class="calibre15">AUTO_INCREMENT</code>. This example, and especially the last two lines, is theoretical code showing how to use an insert ID as a key if we had created a table called <code class="calibre15">owners</code>.</p>
</div></section>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Performing Additional Queries" class="calibre4"><div class="preface" id="performing_additional_queries">
<h2 class="calibre28">Performing Additional Queries</h2>

<p class="author1">Okay, that’s enough<a contenteditable="false" data-primary="database queries" data-secondary="secondary queries" data-type="indexterm" id="idm45694716057720" class="calibre6"/> feline fun. To explore some slightly more complex queries, we need to revert to using the <em class="hyperlink">customers</em> and <em class="hyperlink">classics</em> tables that you created in <a data-type="xref" href="ch08.xhtml#introduction_to_mysql" class="calibre6">Chapter 8</a>. There will be two customers in the <em class="hyperlink">customers</em> table; the <em class="hyperlink">classics</em> table holds the details of a few books. They also share a common column of ISBNs, called <em class="hyperlink">isbn</em>, that you can use to perform additional queries.</p>

<p class="author1">For example, to display all of the customers along with the titles and authors of the books they have bought, you can use the code in <a data-type="xref" href="#performing_a_secondary_query" class="calibre6">Example 11-15</a>.</p>

<div data-type="example" id="performing_a_secondary_query" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-15. </span>Performing a secondary query</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">SELECT * FROM customers</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$result</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">while</code><code class="calibre15"> </code><code class="p">(</code><code class="nv">$row</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">())</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$custname</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'name'</code><code class="p">]);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$custisbn</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$row</code><code class="p">[</code><code class="s">'isbn'</code><code class="p">]);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="err">$custname</code><code class="s"> purchased ISBN </code><code class="err">$custisbn</code><code class="s">: &lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$subquery </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">SELECT * FROM classics WHERE isbn='</code><code class="si">$custisbn</code><code class="s2">'</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$subresult</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$subquery</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$subrow </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nv">$subresult</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">();</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n">  </code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$custbook </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$subrow</code><code class="p">[</code><code class="s">'title'</code><code class="p">]);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$custauth </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nb">htmlspecialchars</code><code class="p">(</code><code class="nv">$subrow</code><code class="p">[</code><code class="s">'author'</code><code class="p">]);</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">echo</code><code class="calibre15"> </code><code class="s">"</code><code class="s">&amp;nbsp;&amp;nbsp; '</code><code class="err">$custbook</code><code class="s">' by </code><code class="err">$custauth</code><code class="s">&lt;br&gt;&lt;br&gt;</code><code class="s">"</code><code class="p">;</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<p class="author1">This program uses an initial query to the <em class="hyperlink">customers</em> table to look up all the customers and then, given the ISBNs of the books each customer purchased, makes a new query to the <em class="hyperlink">classics</em> table to find out the title and author for each. The output from this code should be similar to the following:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">Joe Bloggs purchased ISBN 9780099533474:
  'The Old Curiosity Shop' by Charles Dickens

Jack Wilson purchased ISBN 9780517123201:
  'The Origin of Species' by Charles Darwin

Mary Smith purchased ISBN 9780582506206:
  'Pride and Prejudice' by Jane Austen</strong></pre>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Of course, although it wouldn’t illustrate performing additional queries, in this particular case you could also return the same information using a <code class="calibre15">NATURAL JOIN</code> query (see <a data-type="xref" href="ch08.xhtml#introduction_to_mysql" class="calibre6">Chapter 8</a>), like this:</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre45">
<code class="k">SELECT</code> <code class="n">name</code><code class="p">,</code><code class="n">isbn</code><code class="p">,</code><code class="n">title</code><code class="p">,</code><code class="n">author</code> <code class="k">FROM</code> <code class="n">customers</code>
 <code class="k">NATURAL</code> <code class="k">JOIN</code> <code class="n">classics</code><code class="p">;</code></pre>
</div>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Preventing Hacking Attempts" class="calibre4"><div class="preface" id="preventing_hacking_attempts">
<h1 class="calibre11">Preventing Hacking Attempts</h1>

<p class="author1">If<a contenteditable="false" data-primary="database queries" data-secondary="hacking prevention" data-type="indexterm" id="DBQhac10" class="calibre6"/><a contenteditable="false" data-primary="security issues" data-secondary="database hacking prevention" data-type="indexterm" id="SIhack10" class="calibre6"/> you haven’t looked into it, you may find it hard to appreciate just how dangerous it is to pass user input unchecked to MySQL. For example, suppose you have a simple piece of code to verify a user, and it looks like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$user</code>  <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'user'</code><code class="p">];</code>
<code class="nv">$pass</code>  <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'pass'</code><code class="p">];</code>
<code class="nv">$query</code> <code class="o">=</code> <code class="s">"SELECT * FROM users WHERE user='</code><code class="err">$user</code><code class="s">' AND pass='</code><code class="err">$pass</code><code class="s">'"</code><code class="p">;</code></pre>

<p class="author1">At first glance, you might think this code is perfectly fine. If the user enters values of <code class="calibre15">fredsmith</code> and <code class="calibre15">mypass</code> for <code class="calibre15">$user</code> and <code class="calibre15">$pass</code>, respectively, then the query string, as passed to MySQL, will be as follows:</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">users</code> <code class="k">WHERE</code> <code class="k">user</code><code class="o">=</code><code class="s">'fredsmith'</code> <code class="k">AND</code> <code class="n">pass</code><code class="o">=</code><code class="s">'mypass'</code></pre>

<p class="author1">This is all well and good, but what if someone enters the following for <code class="calibre15">$user</code> (and doesn’t even enter anything for <code class="calibre15">$pass</code>)?</p>

<pre data-programming-language="perl" class="calibre29">
admin' #</pre>

<p class="author1">Let’s look at the string that would be sent to MySQL:</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">users</code> <code class="k">WHERE</code> <code class="k">user</code><code class="o">=</code><code class="s">'admin'</code> <code class="o">#</code><code class="s">' AND pass='</code><code class="err">'</code></pre>

<p class="author1">Do you see the problem there? An <em class="hyperlink">SQL injection</em> attack has occurred. In MySQL, the <code class="calibre15">#</code> symbol represents the start of a comment. Therefore, the user will be logged in as <em class="hyperlink">admin</em> (assuming there is a user <em class="hyperlink">admin</em>), without having to enter a password. In the following, the part of the query that will be executed is shown in bold; the rest will be ignored.</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<strong class="calibre31"><code class="k1">SELECT</code><code class="calibre17"> </code><code class="o1">*</code><code class="calibre17"> </code><code class="k1">FROM</code><code class="calibre17"> </code><code class="nx1">users</code><code class="calibre17"> </code><code class="k1">WHERE</code><code class="calibre17"> </code><code class="k1">user</code><code class="o1">=</code><code class="s2">'admin'</code><code class="calibre17"> </code><code class="o1">#</code></strong><code class="s">' AND pass='</code><code class="err">'</code></pre>

<p class="author1">But you should count yourself very lucky if that’s all a malicious user does to you. At least you might still be able to go into your application and undo any changes the user makes as <em class="hyperlink">admin</em>. But what about the case in which your application code removes a user from the database? The code might look something like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$user</code>  <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'user'</code><code class="p">];</code>
<code class="nv">$pass</code>  <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'pass'</code><code class="p">];</code>
<code class="nv">$query</code> <code class="o">=</code> <code class="s">"DELETE FROM users WHERE user='</code><code class="err">$user</code><code class="s">' AND pass='</code><code class="err">$pass</code><code class="s">'"</code><code class="p">;</code></pre>

<p class="author1">Again, this looks quite normal at first glance, but what if someone entered the following for <code class="calibre15">$user</code>?</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<code class="n">anything</code><code class="err">'</code> <code class="k">OR</code> <code class="mi">1</code><code class="o">=</code><code class="mi">1</code> <code class="o">#</code></pre>

<p class="author1">This would be interpreted by MySQL as follows:</p>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<strong class="calibre31"><code class="k1">DELETE</code><code class="calibre17"> </code><code class="k1">FROM</code><code class="calibre17"> </code><code class="nx1">users</code><code class="calibre17"> </code><code class="k1">WHERE</code><code class="calibre17"> </code><code class="k1">user</code><code class="o1">=</code><code class="s2">'anything'</code><code class="calibre17"> </code><code class="k1">OR</code><code class="calibre17"> </code><code class="mi1">1</code><code class="o1">=</code><code class="mi1">1</code><code class="calibre17"> </code><code class="o1">#</code></strong><code class="s">' AND pass='</code><code class="err">'</code></pre>

<p class="author1">Ouch—because of the fact that any statement followed by <code class="calibre15">OR 1=1</code> is always <code class="calibre15">TRUE</code>, that SQL query will always be <code class="calibre15">TRUE</code>, and therefore, since the rest of the statement is ignored due to the # character, you’ve now lost your whole <em class="hyperlink">users</em> database! So what can you do about this kind of attack?</p>

<section data-type="sect2" data-pdf-bookmark="Steps You Can Take" class="calibre4"><div class="preface" id="steps_you_can_take">
<h2 class="calibre28">Steps You Can Take</h2>

<p class="author1">The<a contenteditable="false" data-primary="magic quotes feature (PHP)" data-type="indexterm" id="idm45694715448888" class="calibre6"/><a contenteditable="false" data-primary="PHP programming language" data-secondary="magic quotes feature" data-type="indexterm" id="idm45694715447784" class="calibre6"/><a contenteditable="false" data-primary="security issues" data-secondary="magic quotes feature" data-type="indexterm" id="idm45694715446440" class="calibre6"/><a contenteditable="false" data-primary="escape characters" data-secondary="in PHP" data-type="indexterm" id="idm45694715445064" class="calibre6"/> first thing is not to rely on PHP’s built-in <em class="hyperlink">magic quotes</em>, which automatically escape any characters such as single and double quotes by prefacing them with a backslash (<code class="calibre15">\</code>). Why? Because this feature can be turned off. Many programmers do so in order to put their own security code in place, and there is no guarantee that this hasn’t happened on the server you are working on. In fact, the feature was deprecated as of PHP 5.3.0 and removed in PHP 5.4.0.</p>

<p class="author1">Instead, as<a contenteditable="false" data-primary="PDO (PHP Data Objects)" data-secondary="quote method" data-type="indexterm" id="idm45694715423304" class="calibre6"/> we showed earlier on, you could use the <code class="calibre15">quote</code> method of the PDO object to escape all characters and surround strings with quotation marks. <a data-type="xref" href="#how_to_properly_sanitize_user_input_for" class="calibre6">Example 11-16</a> is a function you can use that will remove any magic quotes added to a user-inputted string and then properly sanitize it for you.</p>

<div data-type="example" id="how_to_properly_sanitize_user_input_for" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-16. </span>How to properly sanitize user input for MySQL</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n"> </code> <code class="k">function</code> <code class="nf">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">if</code> <code class="p">(</code><code class="nb">get_magic_quotes_gpc</code><code class="p">())</code> <code class="nv">$string</code> <code class="o">=</code> <code class="nb">stripslashes</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">quote</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/></pre>
</div>

<p class="author1">The <code class="calibre15">get_magic_quotes_gpc</code> function<a contenteditable="false" data-primary="get_magic_quotes_gpc function (PHP)" data-type="indexterm" id="idm45694715381192" class="calibre6"/><a contenteditable="false" data-primary="MySQL" data-secondary="safely accessing with user input" data-type="indexterm" id="idm45694715380184" class="calibre6"/> returns <code class="calibre15">TRUE</code> if magic quotes are active. In that case, any slashes that have been added to a string have to be removed, or the <span class="keep-together"><code class="calibre15">quote</code></span> method could end up double-escaping some characters, creating corrupted strings. <a data-type="xref" href="#how_to_safely_access_mysql_with_user_inp" class="calibre6">Example 11-17</a> illustrates how you would incorporate <code class="calibre15">mysql_fix_string</code> within your own code.</p>

<div data-type="example" id="how_to_safely_access_mysql_with_user_inp" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-17. </span>How to safely access MySQL with user input</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;</code><code class="o">?</code><code class="n">php</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">require_once</code><code class="calibre15"> </code><code class="s">'login.php'</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="k">try</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$user</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$pass</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$opts</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">catch</code><code class="calibre15"> </code><code class="p">(</code><code class="n">PDOException</code><code class="calibre15"> </code><code class="nv">$e</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">throw</code><code class="calibre15"> </code><code class="k">new</code><code class="calibre15"> </code><code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code><code class="calibre15"> </code><code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$user </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="n">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'user'</code><code class="p">]);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$pass </code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="n">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$_POST</code><code class="p">[</code><code class="s">'pass'</code><code class="p">]);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="nv">$query</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><strong class="calibre31"><code class="s2">SELECT * FROM users WHERE user=</code><code class="si">$user</code><code class="s2"> AND pass=</code><code class="si">$pass</code></strong><code class="s">"</code><code class="p">;</code><code class="calibre15">

</code><code class="n"> </code><code class="calibre15"> </code><code class="c">// Etc...
</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="k">function</code><code class="calibre15"> </code><code class="nf">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code><code class="calibre15"> </code><code class="nv">$string</code><code class="p">)</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">{</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">if</code><code class="calibre15"> </code><code class="p">(</code><code class="nb">get_magic_quotes_gpc</code><code class="p">())</code><code class="calibre15"> </code><code class="nv">$string</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="nb">stripslashes</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="n"> </code><code class="calibre15"> </code><code class="k">return</code><code class="calibre15"> </code><code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">quote</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code><code class="calibre15">
</code><code class="n"> </code><code class="calibre15"> </code><code class="p">}</code><code class="calibre15">
</code><code class="cp">?&gt;</code><code class="x">
</code></pre>
</div>

<div data-type="note" epub:type="note" class="calibre19"><h6 class="calibre20">Note</h6>
<p class="author1">Remember<a contenteditable="false" data-primary="sanitized strings" data-type="indexterm" id="idm45694715191576" class="calibre6"/><a contenteditable="false" data-primary="quote method" data-type="indexterm" id="idm45694715190440" class="calibre6"/> that, because the quote method automatically adds quotes around strings, you should <em class="hyperlink">not</em> use them in any query that uses these sanitized strings. So, in place of using this:</p>

<pre class="calibre45" data-code-language="php" data-programming-language="perl">
<code class="calibre15"> </code><code class="nv">$query</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">SELECT * FROM users WHERE user=</code><strong class="calibre31"><code class="s2">'</code><code class="si">$user</code><code class="s2">'</code></strong><code class="s"> AND pass=</code><strong class="calibre31"><code class="s2">'</code><code class="si">$pass</code><code class="s2">'</code></strong><code class="s">"</code><code class="p">;</code></pre>

<p class="author1">you should enter the following:</p>

<pre class="calibre45" data-code-language="php" data-programming-language="perl">
<code class="calibre15"> </code><code class="nv">$query</code><code class="calibre15"> </code><code class="o">=</code><code class="calibre15"> </code><code class="s">"</code><code class="s">SELECT * FROM users WHERE user=</code><strong class="calibre31"><code class="si">$user</code></strong><code class="s"> AND pass=</code><strong class="calibre31"><code class="si">$pass</code></strong><code class="s">"</code><code class="p">;</code></pre>

<p class="author1">These precautions are becoming less important, however, because there’s a much easier and safer way to access MySQL, which obviates the need for these types of functions—the use of placeholders, which is explained next.</p>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using Placeholders" class="calibre4"><div class="preface" id="using_placeholders">
<h2 class="calibre28">Using Placeholders</h2>

<p class="author1">All<a contenteditable="false" data-primary="MySQL" data-secondary="placeholders and" data-type="indexterm" id="MSQplace10" class="calibre6"/><a contenteditable="false" data-primary="placeholders (MySQL)" data-type="indexterm" id="PL10" class="calibre6"/> the methods you have seen so far work with MySQL but had security implications, with strings constantly requiring escaping to prevent security risks. So, now that you know the basics, let me introduce the best and recommended way to interact with MySQL, which is pretty much bulletproof in terms of security. Once you have read this section, you should no longer use direct inserting of data into MySQL (though it was important to show you how to do this) but should always use placeholders instead.</p>

<p class="author1">So what are placeholders? They are positions within prepared statements in which data is transferred directly to the database, without the possibility of user-submitted (or other) data being interpreted as MySQL statements (and the potential for hacking that could then result).</p>

<p class="author1">The technology works by requiring you to first prepare the statement you wish to be executed in MySQL but leave all the parts of the statement that refer to data as simple question marks.</p>

<p class="author1">In plain MySQL, prepared statements look like <a data-type="xref" href="#mysql_placeholders" class="calibre6">Example 11-18</a>.</p>

<div data-type="example" id="mysql_placeholders" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-18. </span>MySQL placeholders</h5>

<pre data-code-language="sql" data-programming-language="perl" class="calibre29">
<code class="k">PREPARE</code> <code class="k">statement</code> <code class="k">FROM</code> <code class="ss">"INSERT INTO classics VALUES(?,?,?,?,?)"</code><code class="p">;</code>

<code class="k">SET</code> <code class="o">@</code><code class="n">author</code>   <code class="o">=</code> <code class="ss">"Emily Brontë"</code><code class="p">,</code>
    <code class="o">@</code><code class="n">title</code>    <code class="o">=</code> <code class="ss">"Wuthering Heights"</code><code class="p">,</code>
    <code class="o">@</code><code class="n">category</code> <code class="o">=</code> <code class="ss">"Classic Fiction"</code><code class="p">,</code>
    <code class="o">@</code><code class="k">year</code>     <code class="o">=</code> <code class="ss">"1847"</code><code class="p">,</code>
    <code class="o">@</code><code class="n">isbn</code>     <code class="o">=</code> <code class="ss">"9780553212587"</code><code class="p">;</code>

<code class="k">EXECUTE</code> <code class="k">statement</code> <code class="k">USING</code> <code class="o">@</code><code class="n">author</code><code class="p">,</code><code class="o">@</code><code class="n">title</code><code class="p">,</code><code class="o">@</code><code class="n">category</code><code class="p">,</code><code class="o">@</code><code class="k">year</code><code class="p">,</code><code class="o">@</code><code class="n">isbn</code><code class="p">;</code>
<code class="k">DEALLOCATE</code> <code class="k">PREPARE</code> <code class="k">statement</code><code class="p">;</code></pre>
</div>

<p class="author1">This can be cumbersome to submit to MySQL, so the <code class="calibre15">PDO</code> extension makes handling placeholders easier for you with a ready-made method called <code class="calibre15">prepare</code>, which you call like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$stmt</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s">'INSERT INTO classics VALUES(?,?,?,?,?)'</code><code class="p">);</code></pre>

<p class="author1">The object <code class="calibre15">$stmt</code> (which is shorthand for <em class="hyperlink">statement</em>) returned by this method is then used for sending the data to the server in place of the question marks. Its first use is to bind some PHP variables to each of the question marks (the placeholder parameters) in turn, like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nv">$author</code><code class="p">,</code><code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">128</code><code class="p">);</code>
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nv">$title</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n">PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">128</code><code class="p">);</code>
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nv">$category</code><code class="p">,</code> <code class="n">PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">16</code> <code class="p">);</code>
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="nv">$year</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_INT </code> <code class="n"> </code> <code class="n"> </code><code class="p">);</code>
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="nv">$isbn</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">13</code> <code class="p">);</code></pre>

<p class="author1">The first argument to <code class="calibre15">bindParam</code> is a number representing the position in the query string of the value to insert (in other words, which question mark placeholder is being referred to). This is followed by the variable that will supply the data for that placeholder, and then the type of data the variable must be, and, if a string, another value follows stating its maximum length.</p>

<p class="author1">With the variables bound to the prepared statement, it is now necessary to populate them with the data to be passed to MySQL, like this:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$author</code>   <code class="o">=</code> <code class="s">'Emily Brontë'</code><code class="p">;</code>
<code class="nv">$title</code>    <code class="o">=</code> <code class="s">'Wuthering Heights'</code><code class="p">;</code>
<code class="nv">$category</code> <code class="o">=</code> <code class="s">'Classic Fiction'</code><code class="p">;</code>
<code class="nv">$year</code>     <code class="o">=</code> <code class="s">'1847'</code><code class="p">;</code>
<code class="nv">$isbn</code>     <code class="o">=</code> <code class="s">'9780553212587'</code><code class="p">;</code></pre>

<p class="author1">At this point, PHP has everything it needs to execute the prepared statement, so you can issue the following command, which calls the <code class="calibre15">execute</code> method of the <code class="calibre15">$stmt</code> object created earlier, passing the values to be inserted in the form of an array:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code><code class="nv">$author</code><code class="p">,</code> <code class="nv">$title</code><code class="p">,</code> <code class="nv">$category</code><code class="p">,</code> <code class="nv">$year</code><code class="p">,</code> <code class="nv">$isbn</code><code class="p">]);</code></pre>

<p class="author1">Before going any further, it makes sense to verify whether the command was executed successfully. Here’s how you can do that by calling the <code class="calibre15">rowCount</code> method of <code class="calibre15">$stmt</code>:</p>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="nb">printf</code><code class="p">(</code><code class="s">"%d Row inserted.</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">rowCount</code><code class="p">());</code></pre>

<p class="author1">In this case, the output should indicate that one row was inserted.</p>

<p class="author1">When you put all this together, the result is <a data-type="xref" href="#issuing_prepared_statements" class="calibre6">Example 11-19</a>.</p>

<div data-type="example" id="issuing_prepared_statements" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-19. </span>Issuing prepared statements</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n"> </code> <code class="k">require_once</code> <code class="s">'login.php'</code><code class="p">;</code>

<code class="n"> </code> <code class="k">try</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$pdo</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code> <code class="nv">$user</code><code class="p">,</code> <code class="nv">$pass</code><code class="p">,</code> <code class="nv">$opts</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="n"> </code> <code class="k">catch</code> <code class="p">(</code><code class="n">PDOException</code> <code class="nv">$e</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">throw</code> <code class="k">new</code> <code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code> <code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="nv">$stmt</code> <code class="o">=</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s">'INSERT INTO classics VALUES(?,?,?,?,?)'</code><code class="p">);</code>
<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="nv">$author</code><code class="p">,</code><code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">128</code><code class="p">);</code>
<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="nv">$title</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n">PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">128</code><code class="p">);</code>
<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">3</code><code class="p">,</code> <code class="nv">$category</code><code class="p">,</code> <code class="n">PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">16</code> <code class="p">);</code>
<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="nv">$year</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_INT </code> <code class="n"> </code> <code class="n"> </code><code class="p">);</code>
<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="nv">$isbn</code><code class="p">,</code><code class="n"> </code> <code class="n"> </code> <code class="n"> PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">,</code> <code class="mi">13</code> <code class="p">);</code>
<code class="n">  </code>
<code class="n"> </code> <code class="nv">$author </code> <code class="n"> </code><code class="o">=</code> <code class="s">'Emily Brontë'</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$title </code> <code class="n"> </code> <code class="o">=</code> <code class="s">'Wuthering Heights'</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$category</code> <code class="o">=</code> <code class="s">'Classic Fiction'</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$year </code> <code class="n"> </code> <code class="n"> </code><code class="o">=</code> <code class="s">'1847'</code><code class="p">;</code>
<code class="n"> </code> <code class="nv">$isbn </code> <code class="n"> </code> <code class="n"> </code><code class="o">=</code> <code class="s">'9780553212587'</code><code class="p">;</code>

<code class="n"> </code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code><code class="nv">$author</code><code class="p">,</code> <code class="nv">$title</code><code class="p">,</code> <code class="nv">$category</code><code class="p">,</code> <code class="nv">$year</code><code class="p">,</code> <code class="nv">$isbn</code><code class="p">]);</code>
<code class="n"> </code> <code class="nb">printf</code><code class="p">(</code><code class="s">"%d Row inserted.</code><code class="se">\n</code><code class="s">"</code><code class="p">,</code> <code class="nv">$stmt</code><code class="o">-&gt;</code><code class="na">rowCount</code><code class="p">());</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>

<p class="author1">Every time you are able to use prepared statements in place of nonprepared ones, you will be closing a potential security hole, so it’s worth spending some time getting to know how to use them.<a contenteditable="false" data-primary="" data-startref="PL10" data-type="indexterm" id="idm45694714763768" class="calibre6"/><a contenteditable="false" data-primary="" data-startref="MSQplace10" data-type="indexterm" id="idm45694714762552" class="calibre6"/></p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Preventing JavaScript Injection into HTML" class="calibre4"><div class="preface" id="preventing_html_injection">
<h2 class="calibre28">Preventing JavaScript Injection into HTML</h2>

<p class="author1">There’s another<a contenteditable="false" data-primary="security issues" data-secondary="JavaScript injection prevention" data-type="indexterm" id="idm45694714507880" class="calibre6"/><a contenteditable="false" data-primary="cross-site scripting" data-type="indexterm" id="idm45694714506504" class="calibre6"/><a contenteditable="false" data-primary="XSS attacks" data-type="indexterm" id="idm45694714505400" class="calibre6"/><a contenteditable="false" data-primary="HTML injection" data-type="indexterm" id="idm45694714504296" class="calibre6"/> type of injection you need to concern yourself about—not for the safety of your own websites but for your users’ privacy and protection. That’s <em class="hyperlink">cross-site scripting</em>, also referred to as an <em class="hyperlink">XSS attack</em>.</p>

<p class="author1">This occurs when you allow HTML or, more often, JavaScript code to be input by a user and then displayed by your website. One place this is common is in a comment form. What happens most often is that a malicious user will try to write code that steals cookies from your site’s users, which even allows them to discover username and password pairs if those are poorly handled, or other information that could enable session hijacking (in which a user’s login is taken over by a hacker, who could then take over that person’s account!). Or the malicious user might launch an attack to download a Trojan onto a user’s computer.</p>

<p class="author1">Preventing<a contenteditable="false" data-primary="htmlentities function (PHP)" data-type="indexterm" id="idm45694714500552" class="calibre6"/> this is as simple as calling the <code class="calibre15">htmlentities</code> function, which strips out all HTML markup and replaces it with a form that displays the characters but does not allow a browser to act on them. For example, consider this HTML:</p>

<pre data-code-language="html" data-programming-language="perl" class="calibre29">
<code class="nt">&lt;script </code><code class="na">src=</code><code class="s">'http://x.com/hack.js'</code><code class="nt">&gt;&lt;/script&gt;</code>
<code class="nt">&lt;script&gt;</code><code class="n">hack</code><code class="p">();</code><code class="nt">&lt;/script&gt;</code></pre>

<p class="author1">This code loads in a JavaScript program and then executes malicious functions. But if it is first passed through <code class="calibre15">htmlentities</code>, it will be turned into the following totally harmless string:</p>

<pre data-programming-language="perl" class="calibre29">
<strong class="calibre31">&amp;lt;</strong>script src='http://x.com/hack.js'<strong class="calibre31">&amp;gt;</strong> <strong class="calibre31">&amp;lt;</strong>/script<strong class="calibre31">&amp;gt;</strong>
<strong class="calibre31">&amp;lt;</strong>script<strong class="calibre31">&amp;gt;</strong>hack();<strong class="calibre31">&amp;lt;</strong>/script<strong class="calibre31">&amp;gt;</strong></pre>

<p class="author1">Therefore, if you are ever going to display anything that your users enter, either immediately or after storing it in a database, you need to first sanitize it using the <code class="calibre15">htmlentities</code> function. To do this, I recommend that you create a new function, like the first one in <a data-type="xref" href="#functions_for_preventing_both_sql_and_xs" class="calibre6">Example 11-20</a>, which can sanitize for both SQL and XSS injections.</p>

<div data-type="example" id="functions_for_preventing_both_sql_and_xs" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-20. </span>Functions for preventing both SQL and XSS injection attacks</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n"> </code> <code class="k">function</code> <code class="nf">mysql_entities_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nb">htmlentities</code><code class="p">(</code><code class="n">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">));</code>
<code class="n"> </code> <code class="p">}</code><code class="n"> </code> <code class="n">  </code>

<code class="n"> </code> <code class="k">function</code> <code class="nf">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">if</code> <code class="p">(</code><code class="nb">get_magic_quotes_gpc</code><code class="p">())</code> <code class="nv">$string</code> <code class="o">=</code> <code class="nb">stripslashes</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">real_escape_string</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>

<p class="author1">The <code class="calibre15">mysql_entities_fix_string</code> function first calls <code class="calibre15">mysql_fix_string</code> and then passes the result through <code class="calibre15">htmlentities</code> before returning the fully sanitized string. To use either of these functions, you must already have an active connection object open to a MySQL database.</p>

<p class="author1"><a data-type="xref" href="#how_to_safely_access_mysql_and_prevent_x" class="calibre6">Example 11-21</a> shows the new “higher protection” version of <a data-type="xref" href="#how_to_safely_access_mysql_with_user_inp" class="calibre6">Example 11-17</a>. This is just example code, and you need to add the code to access the results returned where you see the <code class="calibre15">//Etc...</code> comment line.</p>

<div data-type="example" id="how_to_safely_access_mysql_and_prevent_x" class="calibre41">
<h5 class="calibre42"><span class="keep-together">Example 11-21. </span>How to safely access MySQL and prevent XSS attacks</h5>

<pre data-code-language="php" data-programming-language="perl" class="calibre29">
<code class="o">&lt;?</code><code class="n">php</code>
<code class="n"> </code> <code class="k">require_once</code> <code class="s">'login.php'</code><code class="p">;</code>

<code class="n"> </code> <code class="k">try</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="nv">$pdo</code> <code class="o">=</code> <code class="k">new</code> <code class="n">PDO</code><code class="p">(</code><code class="nv">$attr</code><code class="p">,</code> <code class="nv">$user</code><code class="p">,</code> <code class="nv">$pass</code><code class="p">,</code> <code class="nv">$opts</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="n"> </code> <code class="k">catch</code> <code class="p">(</code><code class="n">PDOException</code> <code class="nv">$e</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">throw</code> <code class="k">new</code> <code class="n">PDOException</code><code class="p">(</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">(),</code> <code class="p">(</code><code class="n">int</code><code class="p">)</code><code class="nv">$e</code><code class="o">-&gt;</code><code class="na">getCode</code><code class="p">());</code>
<code class="n"> </code> <code class="p">}</code>

<code class="n"> </code> <code class="nv">$user </code> <code class="o">=</code> <code class="n">mysql_entities_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'user'</code><code class="p">]);</code>
<code class="n"> </code> <code class="nv">$pass </code> <code class="o">=</code> <code class="n">mysql_entities_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s">'pass'</code><code class="p">]);</code>
<code class="n"> </code> <code class="nv">$query</code> <code class="o">=</code> <code class="s">"SELECT * FROM users WHERE user='</code><code class="err">$user</code><code class="s">' AND pass='</code><code class="err">$pass</code><code class="s">'"</code><code class="p">;</code>

<code class="n"> </code> <code class="c">//Etc…</code>

<code class="n"> </code> <code class="k">function</code> <code class="nf">mysql_entities_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nb">htmlentities</code><code class="p">(</code><code class="n">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">));</code>
<code class="n"> </code> <code class="p">}</code><code class="n"> </code> <code class="n">  </code>

<code class="n"> </code> <code class="k">function</code> <code class="nf">mysql_fix_string</code><code class="p">(</code><code class="nv">$pdo</code><code class="p">,</code> <code class="nv">$string</code><code class="p">)</code>
<code class="n"> </code> <code class="p">{</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">if</code> <code class="p">(</code><code class="nb">get_magic_quotes_gpc</code><code class="p">())</code> <code class="nv">$string</code> <code class="o">=</code> <code class="nb">stripslashes</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="n"> </code> <code class="k">return</code> <code class="nv">$pdo</code><code class="o">-&gt;</code><code class="na">quote</code><code class="p">(</code><code class="nv">$string</code><code class="p">);</code>
<code class="n"> </code> <code class="p">}</code>
<code class="cp">?&gt;</code><code class="x"/>
</pre>
</div>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Questions" class="calibre4"><div class="preface" id="questions-id00031">
<h1 class="calibre11">Questions</h1>

<ol class="calibre25">
	<li class="calibre26">
	<p class="author1">How do you connect to a MySQL database using PDO?</p>
	</li>
	<li class="calibre26">
	<p class="author1">How do you submit a query to MySQL using PDO?</p>
	</li>
	<li class="calibre26">
	<p class="author1">What style of the <code class="calibre15">fetch</code> method can be used to return a row as an array indexed by column number?</p>
	</li>
	<li class="calibre26">
	<p class="author1">How can you manually close a PDO connection?</p>
	</li>
	<li class="calibre26">
	<p class="author1">When adding a row to a table with an <code class="calibre15">AUTO_INCREMENT</code> column, what value should be passed to that column?</p>
	</li>
	<li class="calibre26">
	<p class="author1">Which PDO method can be used to properly escape user input to prevent code injection?</p>
	</li>
	<li class="calibre26">
	<p class="author1">What is the best way to ensure database security when accessing it?<a contenteditable="false" data-startref="DBQhac10" data-type="indexterm" id="idm45694713244184" class="calibre6"/><a contenteditable="false" data-startref="SIhack10" data-type="indexterm" id="idm45694713243080" class="calibre6"/><a contenteditable="false" data-startref="PHPdbq10" data-type="indexterm" id="idm45694713241976" class="calibre6"/><a contenteditable="false" data-startref="MSQdataq10" data-type="indexterm" id="idm45694713240872" class="calibre6"/></p>
	</li>
</ol>

<p class="author1">See <a data-type="xref" href="app01_split_010.xhtml#chapter_11_answers" class="calibre6">“Chapter 11 Answers”</a> in the <a data-type="xref" href="app01_split_000.xhtml#solutions_to_the_chapter_questions" class="calibre6">Appendix A</a> for the answers to these <span class="keep-together">questions</span>.</p>
</div></section>
</div></section></div></body></html>