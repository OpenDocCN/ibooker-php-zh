<html><head></head><body><section data-pdf-bookmark="Chapter 5. Databases and Eloquent" data-type="chapter" epub:type="chapter"><div class="chapter" id="database_and_eloquent">&#13;
<h1><span class="label">Chapter 5. </span>Databases and Eloquent</h1>&#13;
&#13;
&#13;
<p>Laravel provides a suite of tools for interacting with your application’s databases, the most notable of which is Eloquent, Laravel’s ActiveRecord ORM.</p>&#13;
&#13;
<p>Eloquent is one of Laravel’s most popular and influential features. It’s a great example of how Laravel is different from the majority of PHP frameworks; in a world of DataMapper ORMs that are powerful but complex, Eloquent stands out for its simplicity. There’s one class per table, which is responsible for retrieving, representing, and persisting data in that table.</p>&#13;
&#13;
<p>Whether or not you choose to use Eloquent, you’ll still get a ton of benefit from the other database tools Laravel provides. So before we dig into Eloquent, we’ll start by covering the basics of Laravel’s database functionality: migrations, seeders, and the query builder.</p>&#13;
&#13;
<p>Then we’ll cover Eloquent: defining your models; inserting, updating, and deleting; customizing your responses with accessors, mutators, and attribute casting; and, finally, relationships. There’s a lot going on here, and it’s easy to get overwhelmed, but if we take it one step at a time, we’ll make it through.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Configuration" data-type="sect1"><div class="sect1" id="id401">&#13;
<h1>Configuration</h1>&#13;
&#13;
<p>Before<a data-primary="databases" data-secondary="configuring credentials and connections" data-type="indexterm" id="DBconfig05"/> we get into how to use Laravel’s database tools, let’s pause for a second and go over how to configure your database credentials and connections.</p>&#13;
&#13;
<p>The configuration for database access lives in <em>config/database.php</em> and <em>.env</em>. Like many other configuration areas in Laravel, you can define multiple “connections” and then decide which the code will use by default.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Database Connections" data-type="sect2"><div class="sect2" id="id645">&#13;
<h2>Database Connections</h2>&#13;
&#13;
<p>By default, there’s one connection for each of the drivers, as you can see in <a data-type="xref" href="#EX801">Example 5-1</a>.</p>&#13;
<div data-type="example" id="EX801">&#13;
<h5><span class="label">Example 5-1. </span>The default database connections list</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="s1">'connections'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
&#13;
    <code class="s1">'sqlite'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'sqlite'</code><code class="p">,</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DATABASE_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'database'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_DATABASE'</code><code class="p">,</code> <code class="nx">database_path</code><code class="p">(</code><code class="s1">'database.sqlite'</code><code class="p">)),</code>&#13;
        <code class="s1">'prefix'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
        <code class="s1">'foreign_key_constraints'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_FOREIGN_KEYS'</code><code class="p">,</code> <code class="k">true</code><code class="p">),</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'mysql'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'mysql'</code><code class="p">,</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DATABASE_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'host'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_HOST'</code><code class="p">,</code> <code class="s1">'127.0.0.1'</code><code class="p">),</code>&#13;
        <code class="s1">'port'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PORT'</code><code class="p">,</code> <code class="s1">'3306'</code><code class="p">),</code>&#13;
        <code class="s1">'database'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_DATABASE'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_USERNAME'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PASSWORD'</code><code class="p">,</code> <code class="s1">''</code><code class="p">),</code>&#13;
        <code class="s1">'unix_socket'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_SOCKET'</code><code class="p">,</code> <code class="s1">''</code><code class="p">),</code>&#13;
        <code class="s1">'charset'</code> <code class="o">=&gt;</code> <code class="s1">'utf8mb4'</code><code class="p">,</code>&#13;
        <code class="s1">'collation'</code> <code class="o">=&gt;</code> <code class="s1">'utf8mb4_unicode_ci'</code><code class="p">,</code>&#13;
        <code class="s1">'prefix'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
        <code class="s1">'prefix_indexes'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
        <code class="s1">'strict'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
        <code class="s1">'engine'</code> <code class="o">=&gt;</code> <code class="k">null</code><code class="p">,</code>&#13;
        <code class="s1">'options'</code> <code class="o">=&gt;</code> <code class="nb">extension_loaded</code><code class="p">(</code><code class="s1">'pdo_mysql'</code><code class="p">)</code> <code class="o">?</code> <code class="nb">array_filter</code><code class="p">([</code>&#13;
            <code class="nx">PDO</code><code class="o">::</code><code class="na">MYSQL_ATTR_SSL_CA</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'MYSQL_ATTR_SSL_CA'</code><code class="p">),</code>&#13;
        <code class="p">])</code> <code class="o">:</code> <code class="p">[],</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'pgsql'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'pgsql'</code><code class="p">,</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DATABASE_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'host'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_HOST'</code><code class="p">,</code> <code class="s1">'127.0.0.1'</code><code class="p">),</code>&#13;
        <code class="s1">'port'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PORT'</code><code class="p">,</code> <code class="s1">'5432'</code><code class="p">),</code>&#13;
        <code class="s1">'database'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_DATABASE'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_USERNAME'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PASSWORD'</code><code class="p">,</code> <code class="s1">''</code><code class="p">),</code>&#13;
        <code class="s1">'charset'</code> <code class="o">=&gt;</code> <code class="s1">'utf8'</code><code class="p">,</code>&#13;
        <code class="s1">'prefix'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
        <code class="s1">'prefix_indexes'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
        <code class="s1">'search_path'</code> <code class="o">=&gt;</code> <code class="s1">'public'</code><code class="p">,</code>&#13;
        <code class="s1">'sslmode'</code> <code class="o">=&gt;</code> <code class="s1">'prefer'</code><code class="p">,</code>&#13;
    <code class="p">],</code>&#13;
&#13;
    <code class="s1">'sqlsrv'</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
        <code class="s1">'driver'</code> <code class="o">=&gt;</code> <code class="s1">'sqlsrv'</code><code class="p">,</code>&#13;
        <code class="s1">'url'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DATABASE_URL'</code><code class="p">),</code>&#13;
        <code class="s1">'host'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_HOST'</code><code class="p">,</code> <code class="s1">'localhost'</code><code class="p">),</code>&#13;
        <code class="s1">'port'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PORT'</code><code class="p">,</code> <code class="s1">'1433'</code><code class="p">),</code>&#13;
        <code class="s1">'database'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_DATABASE'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'username'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_USERNAME'</code><code class="p">,</code> <code class="s1">'forge'</code><code class="p">),</code>&#13;
        <code class="s1">'password'</code> <code class="o">=&gt;</code> <code class="nx">env</code><code class="p">(</code><code class="s1">'DB_PASSWORD'</code><code class="p">,</code> <code class="s1">''</code><code class="p">),</code>&#13;
        <code class="s1">'charset'</code> <code class="o">=&gt;</code> <code class="s1">'utf8'</code><code class="p">,</code>&#13;
        <code class="s1">'prefix'</code> <code class="o">=&gt;</code> <code class="s1">''</code><code class="p">,</code>&#13;
        <code class="s1">'prefix_indexes'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
        <code class="c1">// 'encrypt' =&gt; env('DB_ENCRYPT', 'yes'),</code>&#13;
        <code class="c1">// 'trust_server_certificate' =&gt; env('DB_TRUST_SERVER_CERTIFICATE', 'false'),</code>&#13;
    <code class="p">],</code>&#13;
&#13;
<code class="p">]</code></pre></div>&#13;
&#13;
<p>Nothing is stopping you from deleting or modifying these named connections or creating your own. You can create new named connections, and you’ll be able to set the drivers (MySQL, PostgreSL, etc.) in them. So although there’s one connection per driver by default, that’s not a constraint; you could have five different connections, all with the <code>mysql</code> driver, if you wanted.</p>&#13;
&#13;
<p>Each connection allows you to define the properties necessary for connecting to and customizing each connection type.</p>&#13;
&#13;
<p>There are a few reasons for the idea of multiple drivers. To start with, the “connections” section as it comes out of the box is a simple template that makes it easy to start apps that use any of the supported database connection types. In many apps, you can pick the database connection you’ll be using, fill out its information, and even delete the others if you’d like. I usually just keep them all there, in case I might eventually use them.</p>&#13;
&#13;
<p>But there are also some cases where you might need multiple connections within the same application. For example, you might use different database connections for two different types of data, or you might read from one and write to another. Support for multiple connections makes this possible.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="URL Configurations" data-type="sect2"><div class="sect2" id="id402">&#13;
<h2>URL Configurations</h2>&#13;
&#13;
<p>Often<a data-primary="Uniform Resource Locators (URLs)" data-secondary="database configurations using" data-type="indexterm" id="id960"/> services like Heroku will provide an environment variable with a URL that contains all of the information you need to connect to the database. It’ll look something like this:</p>&#13;
&#13;
<pre data-type="programlisting">mysql://root:password@127.0.0.1/forge?charset=UTF-8</pre>&#13;
&#13;
<p>You don’t have to write code to parse this URL out; instead, pass it in as the <code>DATABASE_URL</code> environment variable, and Laravel will understand it.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Other Database Configuration Options" data-type="sect2"><div class="sect2" id="id70">&#13;
<h2>Other Database Configuration Options</h2>&#13;
&#13;
<p>The <em>config/database.php</em> configuration section has quite a few other configuration settings. You can configure Redis access, customize the table name used for migrations, determine the default connection, and toggle whether non-Eloquent calls return <code>stdClass</code> or array instances.</p>&#13;
&#13;
<p>With any service in Laravel that allows connections from multiple sources—sessions can be backed by the database or file storage, the cache can use Redis or Memcached, databases can use MySQL or PostgreSQL—you can define multiple connections and also choose that a particular connection will be the “default,” meaning it will be used any time you don’t explicitly ask for a particular connection. Here’s how you ask for a specific connection, if you<a data-primary="" data-startref="DBconfig05" data-type="indexterm" id="id961"/> want to:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">connection</code><code class="p">(</code><code class="s1">'secondary'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'select * from users'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Migrations" data-type="sect1"><div class="sect1" id="id560">&#13;
<h1>Migrations</h1>&#13;
&#13;
<p>Modern frameworks<a data-primary="databases" data-secondary="migrating" data-tertiary="ease of" data-type="indexterm" id="id962"/> like Laravel make it easy to define your database structure with code-driven migrations. Every new table, column, index, and key can be defined in code, and any new environment can be brought from bare database to your app’s perfect schema in seconds.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining Migrations" data-type="sect2"><div class="sect2" id="id71">&#13;
<h2>Defining Migrations</h2>&#13;
&#13;
<p>A<a data-primary="databases" data-secondary="migrating" data-tertiary="defining migrations" data-type="indexterm" id="id963"/> migration is a single file that defines two things: the modifications desired when running this migration <em>up</em> and, optionally, the modifications desired when running this migration <em>down</em>.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id964">&#13;
<h1>“Up” and “Down” in Migrations</h1>&#13;
<p>Migrations<a data-primary="databases" data-secondary="migrating" data-tertiary="“up” and “down” in migrations" data-tertiary-sortas="“up” and “down” in migrations" data-type="indexterm" id="id965"/> are always run in order by date. Every migration file is named something like this: <em>2018_10_12_000000_create_users_table.php</em>. When<a data-primary="up() method" data-type="indexterm" id="id966"/><a data-primary="down() method" data-type="indexterm" id="id967"/> a new system is migrated, the system grabs each migration, starting at the earliest date, and runs its <code>up()</code> method—​you’re migrating it “up” at this point. But the migration system also allows you to “roll back” your most recent set of migrations. It’ll grab each of them and run its <code>down()</code> method, which should undo whatever changes the up migration made.</p>&#13;
&#13;
<p>So, the <code>up()</code> method of a migration should “do” its migration, and the <code>down()</code> method should “undo” it.</p>&#13;
</div></aside>&#13;
&#13;
<p><a data-type="xref" href="#EX802">Example 5-2</a> shows what the default “create users table” migration that comes with Laravel looks like.</p>&#13;
<div data-type="example" id="EX802">&#13;
<h5><span class="label">Example 5-2. </span>Laravel’s default “create users table” migration</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Migrations\Migration</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Schema\Blueprint</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Schema</code><code class="p">;</code>&#13;
&#13;
<code class="k">return</code> <code class="k">new</code> <code class="k">class</code> <code class="nc">extends</code> <code class="nx">Migration</code>&#13;
<code class="p">{</code>&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Run the migrations.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return void</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">up</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Schema</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">();</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'email'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">unique</code><code class="p">();</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">timestamp</code><code class="p">(</code><code class="s1">'email_verified_at'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">nullable</code><code class="p">();</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'password'</code><code class="p">);</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">rememberToken</code><code class="p">();</code>&#13;
            <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">timestamps</code><code class="p">();</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Reverse the migrations.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @return void</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">down</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Schema</code><code class="o">::</code><code class="na">dropIfExists</code><code class="p">(</code><code class="s1">'users'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">};</code></pre></div>&#13;
<div data-type="tip"><h1>Email Verification</h1>&#13;
<p>The <code>email_verified_at</code> column stores a timestamp indicating when the user verified their email address.</p>&#13;
</div>&#13;
&#13;
<p>As you can see, we have an <code>up()</code> method and a <code>down()</code> method. <code>up()</code> tells the migration to create a new table named <code>users</code> with a few fields, and <code>down()</code> tells it to drop the <code>users</code> table.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a migration" data-type="sect3"><div class="sect3" id="id72">&#13;
<h3>Creating a migration</h3>&#13;
&#13;
<p>As<a data-primary="databases" data-secondary="migrating" data-tertiary="creating migrations" data-type="indexterm" id="id968"/> you will see in <a data-type="xref" href="ch08.html#artisan_and_tinker">Chapter 8</a>, Laravel provides a series of command-line tools you can use to interact with your app and generate boilerplate files. One of these commands allows you to create a migration file. You can run it using <code>php artisan make:migration</code>, and it has a single parameter, which is the name of the migration. For example, to create the table we just covered, you would run <code>php artisan make:migration create_users_table</code>.</p>&#13;
&#13;
<p>There<a data-primary="--create flag" data-type="indexterm" id="id969"/> are two flags you can optionally pass to this command. <code>--create=<em>table_name</em></code> prefills the migration with code designed to create a<a data-primary="--table_name flag" data-type="indexterm" id="id970"/> table named <code><em>table_name</em></code>, and <code class="keep-together">--table=<em>table_name</em></code> just prefills the migration for modifications to an existing table.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">migration</code> <code class="nx">create_users_table</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">migration</code> <code class="nx">add_votes_to_users_table</code> <code class="o">--</code><code class="nx">table</code><code class="o">=</code><code class="nx">users</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">migration</code> <code class="nx">create_users_table</code> <code class="o">--</code><code class="nx">create</code><code class="o">=</code><code class="nx">users</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating tables" data-type="sect3"><div class="sect3" id="id561">&#13;
<h3>Creating tables</h3>&#13;
&#13;
<p>We<a data-primary="databases" data-secondary="migrating" data-tertiary="creating tables" data-type="indexterm" id="id971"/> already saw in the default <code>create_users_table</code> migration that our migrations depend on the <code>Schema</code> facade and its methods. Everything we can do in these migrations will rely on the methods of <code>Schema</code>.</p>&#13;
&#13;
<p>To create a new table in a migration, use the <code>create()</code> method—the first parameter is the table name, and the second is a closure that defines its columns:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Create columns here</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating columns" data-type="sect3"><div class="sect3" id="id562">&#13;
<h3>Creating columns</h3>&#13;
&#13;
<p>To<a data-primary="databases" data-secondary="migrating" data-tertiary="creating columns" data-type="indexterm" id="id972"/> create new columns in a table, whether in a create table call or a modify table call, use the instance of <code>Blueprint</code> that’s passed into your closure:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Let’s look at the various methods available on <code>Blueprint</code> instances for creating columns. I’ll describe how they work in MySQL, but if you’re using another database, Laravel will just use the closest equivalent.</p>&#13;
&#13;
<p>The following are the simple field <code>Blueprint</code> methods:</p>&#13;
<dl>&#13;
<dt><code>id()</code></dt>&#13;
<dd>&#13;
<p>An alias for <code>$table-&gt;bigIncrements('id')</code></p>&#13;
</dd>&#13;
</dl>&#13;
<dl class="pagebreak-before">&#13;
<dt><code>integer(<em>colName</em>)</code>, <code>tinyInteger(<em>colName</em>)</code>, <code>smallInteger(<em>colName</em>)</code>, <span class="keep-together"><code>mediumInteger(<em>colName</em>)</code></span>, <code>bigInteger(<em>colName</em>)</code>, <code>unsignedTinyInteger(<em>colName</em>)</code>, <code>unsignedSmallInteger(<em>colName</em>)</code>, <code>unsignedMediumInteger(<em>colName</em>)</code>, <br/><code>unsignedBigInteger(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds an <code>INTEGER</code> type column, or one of its many variations</p>&#13;
</dd>&#13;
<dt><code>string(<em>colName</em>, <em>length</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>VARCHAR</code> type column with an optional length</p>&#13;
</dd>&#13;
<dt><code>binary(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>BLOB</code> type column</p>&#13;
</dd>&#13;
<dt><code>boolean(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>BOOLEAN</code> type column (a <code>TINYINT(1)</code> in MySQL)</p>&#13;
</dd>&#13;
<dt><code>char(<em>colName</em>, <em>length</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>CHAR</code> column with an optional length</p>&#13;
</dd>&#13;
<dt><code>date(<em>colName</em>)</code>, <code>datetime(<em>colName</em>)</code>, <code>dateTimeTz(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>DATE</code> or  <code>DATETIME</code> column; if time zone awareness is needed, use the <code>dateTimeTz()</code> method to create a <code>DATETIME</code> column with time zone</p>&#13;
</dd>&#13;
<dt><code>decimal(<em>colName</em>, <em>precision</em>, <em>scale</em>)</code>, <br/><code>unsignedDecimal(<em>colName</em>, <em>precision</em>, <em>scale</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>DECIMAL</code> column, with precision and scale—for example, <code>decimal('<em>amount</em>', <em>5</em>, <em>2</em>)</code> specifies a precision of 5 and a scale of 2; for an unsigned column, use the unsignedDecimal method</p>&#13;
</dd>&#13;
<dt><code>double(<em>colName</em>, <em>total digits</em>, <em>digits after decimal</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>DOUBLE</code> column—​for example, <code>double('<em>tolerance</em>', <em>12</em>, <em>8</em>)</code> specifies 12 digits long, with 8 of those digits to the right of the decimal place, as in <code>7204.05691739</code></p>&#13;
</dd>&#13;
<dt><code>enum(<em>colName</em>, [<em>choiceOne</em>, <em>choiceTwo</em>])</code></dt>&#13;
<dd>&#13;
<p>Adds an <code>ENUM</code> column, with provided choices</p>&#13;
</dd>&#13;
<dt><code>float(<em>colName</em>, <em>precision</em>, <em>scale</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>FLOAT</code> column (same as <code>double</code> in MySQL)</p>&#13;
</dd>&#13;
<dt><code>foreignId(<em>colName</em>)</code>, <code>foreignUuid(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds an <code>UNSIGNED BIGINT</code> or a <code>UUID</code> column, with provided choices</p>&#13;
</dd>&#13;
<dt><code>foreignIdFor(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds an <code>UNSIGNED BIG INT</code> column with the name <em><code>colName</code></em></p>&#13;
</dd>&#13;
<dt><code>geometry(<em>colName</em>)</code>, <code>geometryCollection(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>GEOMETRY</code> or a <code>GEOMETRYCOLLECTION</code> column</p>&#13;
</dd>&#13;
<dt><code>ipAddress(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>VARCHAR</code> column</p>&#13;
</dd>&#13;
<dt><code>json(<em>colName</em>)</code>, <code>jsonb(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>JSON</code> or <code>JSONB</code> column</p>&#13;
</dd>&#13;
<dt><code>lineString(<em>colName</em>)</code>, <code>multiLineString(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>LINESTRING</code> or <code>MULTILINESTRING</code> column with the given <em><code>colName</code></em></p>&#13;
</dd>&#13;
<dt><code>text(<em>colName</em>)</code>, <code>tinyText(<em>colName</em>)</code>, <code>mediumText(<em>colName</em>)</code>, <code>longText(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>TEXT</code> column (or its various sizes)</p>&#13;
</dd>&#13;
<dt><code>macAddress(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>MACADDRESS</code> column in the databases that support it (like PostgreSQL); on other database systems, it creates a string equivalent</p>&#13;
</dd>&#13;
<dt><code>multiPoint(<em>colName</em>)</code>, <code>multiPolygon(<em>colName</em>)</code>, <code>polygon(<em>colName</em>)</code>, <br/><code>point(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds columns of the types <code>MULTIPOINT</code>, <code>MULTIPOLYGON</code>, <code>POLYGON</code>, and <code>POINT</code>, respectively</p>&#13;
</dd>&#13;
<dt><code>set(<em>colName</em>, <em>membersArray</em>)</code></dt>&#13;
<dd>&#13;
<p>Creates a <code>SET</code> column with the <em><code>colName</code></em> name and <em><code>membersArray</code></em> as members</p>&#13;
</dd>&#13;
<dt><code>time(<em>colName</em>, <em>precision</em>), timeTz(<em>colName</em>, <em>precision</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>TIME</code> column with <em><code>colName</code></em> name; for time zone awareness, use the <code>timeTz()</code> method</p>&#13;
</dd>&#13;
<dt><code>timestamp(<em>colName</em>, <em>precision</em>)</code>, <br/><code>timestampTz(<em>colName</em>, <em>precision</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>TIMESTAMP</code> column; for time zone awareness, use the <code>timestampTz()</code> method</p>&#13;
</dd>&#13;
<dt><code>uuid(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>UUID</code> column (<code>CHAR(36)</code> in MySQL)</p>&#13;
</dd>&#13;
<dt><code>year()</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>YEAR</code> column</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p class="pagebreak-before">And these are the special (joined) <code>Blueprint</code> methods:</p>&#13;
<dl>&#13;
<dt><code>increments(<em>colName</em>)</code>, <code>tinyIncrements(<em>colName</em>)</code>, <code>smallIncrements(<em>colName</em>)</code>, <code>mediumIncrements(<em>colName</em>)</code>, <code>bigIncrements(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds an unsigned incrementing <code>INTEGER</code> primary key ID, or one of its many &#13;
<span class="keep-together">variations</span></p>&#13;
</dd>&#13;
<dt><code>timestamps(<em>precision</em>)</code>, <code>nullableTimestamps(<em>precision</em>)</code>, <br/> <code>timestampsTz(<em>precision</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds <code>created_at</code> and <code>updated_at</code> timestamp columns with optional precision, nullable, and time zone–aware variations</p>&#13;
</dd>&#13;
<dt><code>rememberToken()</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>remember_token</code> column (<code>VARCHAR(100)</code>) for user “remember me” tokens</p>&#13;
</dd>&#13;
<dt><code>softDeletes(<em>colName</em>, <em>precision</em>)</code>, <code>softDeletesTz(<em>colName</em>, <em>precision</em>)</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>deleted_at</code> timestamp for use with soft deletes with optional precision and time zone–aware variations</p>&#13;
</dd>&#13;
<dt><code>morphs(<em>colName</em>)</code>, <code>nullableMorphs(<em>colName</em>)</code>, <code>uuidMorphs(<em>relationshipName</em>)</code>, <br/><code>nullableUuidMorphs(<em>relationshipName</em>)</code></dt>&#13;
<dd>&#13;
<p>For a provided <em><code>colName</code></em>, adds an integer <code>colName_id</code> and a string <code>colName_type</code> (e.g., <code>morphs(tag)</code> adds integer <code>tag_id</code> and string <code>tag_type</code>); for use in polymorphic relationships, using IDs or UUIDs, and can be set as nullable as per method name</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Building extra properties fluently" data-type="sect3"><div class="sect3" id="id563">&#13;
<h3>Building extra properties fluently</h3>&#13;
&#13;
<p>Most<a data-primary="databases" data-secondary="migrating" data-tertiary="building extra properties fluently" data-type="indexterm" id="id973"/> of the properties of a field definition—its length, for example—are set as the second parameter of the field creation method, as we saw in the previous section. But there are a few other properties that we’ll set by chaining more method calls after the creation of the column. For example, this <code>email</code> field is nullable and will be placed (in MySQL) right after the <code>last_name</code> field:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'email'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">nullable</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">after</code><code class="p">(</code><code class="s1">'last_name'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>The following methods are some of those used to set additional properties of a field; look to the <a href="https://oreil.ly/4Z-gC">migrations docs</a> for an exhaustive list.</p>&#13;
<dl>&#13;
<dt><code>nullable()</code></dt>&#13;
<dd>&#13;
<p>Allows <code>NULL</code> values to be inserted into this column</p>&#13;
</dd>&#13;
<dt><code>default('<em>default content</em>')</code></dt>&#13;
<dd>&#13;
<p>Specifies the default content for this column if no value is provided</p>&#13;
</dd>&#13;
<dt><code>unsigned()</code></dt>&#13;
<dd>&#13;
<p>Marks integer columns as unsigned (not negative or positive, but just an integer)</p>&#13;
</dd>&#13;
<dt><code>first()</code> (MySQL only)</dt>&#13;
<dd>&#13;
<p>Places the column first in the column order</p>&#13;
</dd>&#13;
<dt><code>after(<em>colName</em>)</code> (MySQL only)</dt>&#13;
<dd>&#13;
<p>Places the column after another column in the column order</p>&#13;
</dd>&#13;
<dt><code>charset(<em>charset</em>)</code> (MySQL only)</dt>&#13;
<dd>&#13;
<p>Sets the charset for a column</p>&#13;
</dd>&#13;
<dt><code>collation(<em>collation</em>)</code></dt>&#13;
<dd>&#13;
<p>Sets the collation for a column</p>&#13;
</dd>&#13;
<dt><code>invisible()</code> (MySQL only)</dt>&#13;
<dd>&#13;
<p>Makes the column invisible to <code>SELECT</code> queries</p>&#13;
</dd>&#13;
<dt><code>useCurrent()</code></dt>&#13;
<dd>&#13;
<p>Used on <code>TIMESTAMP</code> columns to use <code>CURRENT_TIMESTAMP</code> as the default value</p>&#13;
</dd>&#13;
<dt><code>isGeometry()</code> (PostgreSQL only)</dt>&#13;
<dd>&#13;
<p>Sets a column type to <code>GEOMETRY</code> (the default is <code>GEOGRAPHY</code>)</p>&#13;
</dd>&#13;
<dt><code>unique()</code></dt>&#13;
<dd>&#13;
<p>Adds a <code>UNIQUE</code> index</p>&#13;
</dd>&#13;
<dt><code>primary()</code></dt>&#13;
<dd>&#13;
<p>Adds a primary key index</p>&#13;
</dd>&#13;
<dt><code>index()</code></dt>&#13;
<dd>&#13;
<p>Adds a basic index</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Note that <code>unique()</code>, <code>primary()</code>, and <code>index()</code> can also be used outside of the fluent column building context, which we’ll cover later.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Dropping tables" data-type="sect3"><div class="sect3" id="id564">&#13;
<h3>Dropping tables</h3>&#13;
&#13;
<p>If<a data-primary="databases" data-secondary="migrating" data-tertiary="dropping tables" data-type="indexterm" id="id974"/> you want to drop a table, use the <code>dropIfExists()</code> method on <code>Schema</code>, which takes one parameter, the table name:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">dropIfExists</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modifying columns" data-type="sect3"><div class="sect3" id="id565">&#13;
<h3>Modifying columns</h3>&#13;
&#13;
<p>To<a data-primary="databases" data-secondary="migrating" data-tertiary="modifying columns" data-type="indexterm" id="id975"/> modify a column, just write the code you would write to create the column as if it were new, and then append a call to the <code>change()</code> method after it.</p>&#13;
<div data-type="warning" epub:type="warning"><h1>Required Dependency Before Modifying Columns</h1>&#13;
<p>If you are not using a database that natively supports renaming and dropping columns (the latest versions of the most common databases support these operations), before you can modify any columns, you’ll need to run <code>composer require doctrine/dbal</code>.</p>&#13;
</div>&#13;
&#13;
<p>So, if we have a string column named <code>name</code> that has a length of <code>255</code> and we want to change its length to <code>100</code>, this is how we would write it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">change</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>The same is true if we want to adjust any of its properties that aren’t defined in the method name. To make a field nullable, we do this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'deleted_at'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">nullable</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">change</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Here’s how we rename a column:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">renameColumn</code><code class="p">(</code><code class="s1">'promoted'</code><code class="p">,</code> <code class="s1">'is_promoted'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>And this is how we drop a column:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropColumn</code><code class="p">(</code><code class="s1">'votes'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id976">&#13;
<h1>Modifying Multiple Columns at Once in SQLite</h1>&#13;
<p>If<a data-primary="databases" data-secondary="migrating" data-tertiary="modifying multiple columns at once" data-type="indexterm" id="id977"/> you try to drop or modify multiple columns within a single migration closure and you are using SQLite, you’ll run into errors.</p>&#13;
&#13;
<p>In <a data-type="xref" href="ch12.html#testing">Chapter 12</a> I recommend that you use SQLite for your testing database, so even if you’re using a more traditional database, you may want to consider this a limitation for testing purposes.</p>&#13;
&#13;
<p>However, you don’t have to create a new migration for each. Instead, just create multiple calls to <code>Schema::table()</code> within the <code>up()</code> method of your migration:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">up</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropColumn</code><code class="p">(</code><code class="s1">'is_promoted'</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
&#13;
    <code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropColumn</code><code class="p">(</code><code class="s1">'alternate_email'</code><code class="p">);</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Squashing migrations" data-type="sect3"><div class="sect3" id="id73">&#13;
<h3>Squashing migrations</h3>&#13;
&#13;
<p>If<a data-primary="databases" data-secondary="migrating" data-tertiary="squashing migrations" data-type="indexterm" id="id978"/> you have too many migrations to reason with, you can merge them all into a single SQL file that Laravel will run before it runs any future migrations. This is called “squashing” your migrations.<a data-primary="--prune flag" data-type="indexterm" id="id979"/></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Squash the schema but keep your existing migrations</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">schema</code><code class="o">:</code><code class="nx">dump</code>&#13;
&#13;
<code class="c1">// Dump the current database schema and delete all existing migrations</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">schema</code><code class="o">:</code><code class="nx">dump</code> <code class="o">--</code><code class="nx">prune</code></pre>&#13;
&#13;
<p>Laravel only runs these dumps if it detects no migrations have been run so far. That means you can squash your migrations and it won’t break your already-deployed applications.</p>&#13;
<div data-type="warning" epub:type="warning"><h6>Warning</h6>&#13;
<p>If you use schema dumps, you can’t use in-memory SQLite; it only works on MySQL, PostgreSQL, and local file SQLite.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Indexes and foreign keys" data-type="sect3"><div class="sect3" id="id74">&#13;
<h3>Indexes and foreign keys</h3>&#13;
&#13;
<p>We’ve<a data-primary="databases" data-secondary="migrating" data-tertiary="indexes and foreign keys" data-type="indexterm" id="id980"/><a data-primary="indexes" data-secondary="in database migration" data-secondary-sortas="database migration" data-type="indexterm" id="id981"/><a data-primary="foreign keys" data-type="indexterm" id="id982"/> covered how to create, modify, and delete columns. Let’s move on to indexing and relating them.</p>&#13;
&#13;
<p>If you’re not familiar with indexes, your databases can survive if you just never use them, but they’re pretty important for performance optimization and for some data integrity controls with regard to related tables. I’d recommend reading up on them, but if you absolutely must, you can skip this section for now.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding indexes" data-type="sect4"><div class="sect4" id="id646">&#13;
<h4>Adding indexes</h4>&#13;
&#13;
<p>Check out <a data-type="xref" href="#adding-col-ix">Example 5-3</a> for examples of how to add indexes to your column.</p>&#13;
<div data-type="example" id="adding-col-ix">&#13;
<h5><span class="label">Example 5-3. </span>Adding column indexes in migrations</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// After columns are created...</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">primary</code><code class="p">(</code><code class="s1">'primary_id'</code><code class="p">);</code> <code class="c1">// Primary key; unnecessary if used increments()</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">primary</code><code class="p">([</code><code class="s1">'first_name'</code><code class="p">,</code> <code class="s1">'last_name'</code><code class="p">]);</code> <code class="c1">// Composite keys</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">unique</code><code class="p">(</code><code class="s1">'email'</code><code class="p">);</code> <code class="c1">// Unique index</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">unique</code><code class="p">(</code><code class="s1">'email'</code><code class="p">,</code> <code class="s1">'optional_custom_index_name'</code><code class="p">);</code> <code class="c1">// Unique index</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">index</code><code class="p">(</code><code class="s1">'amount'</code><code class="p">);</code> <code class="c1">// Basic index</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">index</code><code class="p">(</code><code class="s1">'amount'</code><code class="p">,</code> <code class="s1">'optional_custom_index_name'</code><code class="p">);</code> <code class="c1">// Basic index</code></pre></div>&#13;
&#13;
<p>Note that the first example, <code>primary()</code>, is not necessary if you’re using the <code class="keep-together">increments()</code> or <code>bigIncrements()</code> methods to create your index; this will automatically add a primary key index for you.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Removing indexes" data-type="sect4"><div class="sect4" id="id647">&#13;
<h4>Removing indexes</h4>&#13;
&#13;
<p>We can remove indexes as shown in <a data-type="xref" href="#rm-col-ix">Example 5-4</a>.</p>&#13;
<div data-type="example" id="rm-col-ix">&#13;
<h5><span class="label">Example 5-4. </span>Removing column indexes in migrations</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropPrimary</code><code class="p">(</code><code class="s1">'contacts_id_primary'</code><code class="p">);</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropUnique</code><code class="p">(</code><code class="s1">'contacts_email_unique'</code><code class="p">);</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropIndex</code><code class="p">(</code><code class="s1">'optional_custom_index_name'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// If you pass an array of column names to dropIndex, it will</code>&#13;
<code class="c1">// guess the index names for you based on the generation rules</code>&#13;
<code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropIndex</code><code class="p">([</code><code class="s1">'email'</code><code class="p">,</code> <code class="s1">'amount'</code><code class="p">]);</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding and removing foreign keys" data-type="sect4"><div class="sect4" id="id648">&#13;
<h4>Adding and removing foreign keys</h4>&#13;
&#13;
<p>To add a foreign key that defines that a particular column references a column on another table, Laravel’s syntax is simple and clear:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">foreign</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">references</code><code class="p">(</code><code class="s1">'id'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">on</code><code class="p">(</code><code class="s1">'users'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Here we’re adding a <code>foreign</code> index on the <code>user_id</code> column, showing that it references the <code>id</code> column on the <code>users</code> table. Couldn’t get much simpler.</p>&#13;
&#13;
<p>If we want to specify foreign key constraints, we can do that too, with <code>cascadeOnUpdate()</code>, <code>restrictOnUpdate()</code>, <code>cascadeOnDelete()</code>, <code>restrictOnDelete()</code>, and &#13;
<span class="keep-together"><code>nullOnDelete()</code></span>. For example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">foreign</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">references</code><code class="p">(</code><code class="s1">'id'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">on</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">cascadeOnDelete</code><code class="p">();</code></pre>&#13;
&#13;
<p>There is also an alias for creating foreign key constraints. Using it, the above example can be written like so:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">foreignId</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">constrained</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">cascadeOnDelete</code><code class="p">();</code></pre>&#13;
&#13;
<p>To drop a foreign key, we can either delete it by referencing its index name (which is automatically generated by combining the names of the columns and tables being &#13;
<span class="keep-together">referenced</span>):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropForeign</code><code class="p">(</code><code class="s1">'contacts_user_id_foreign'</code><code class="p">);</code></pre>&#13;
&#13;
<p>or by passing it an array of the fields that it’s referencing in the local table:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$table</code><code class="o">-&gt;</code><code class="na">dropForeign</code><code class="p">([</code><code class="s1">'user_id'</code><code class="p">]);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Running Migrations" data-type="sect2"><div class="sect2" id="running_migrations">&#13;
<h2>Running Migrations</h2>&#13;
&#13;
<p>Once<a data-primary="databases" data-secondary="migrating" data-tertiary="running migrations" data-type="indexterm" id="id983"/> you have your migrations defined, how do you run them? There’s an<a data-primary="Artisan" data-secondary="running database migrations" data-type="indexterm" id="id984"/> Artisan command for that:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>migrate<code class="w"/></pre>&#13;
&#13;
<p>This command runs all “outstanding” migrations (by running the <code>up()</code> method on each). Laravel keeps track of which migrations you have run and which you haven’t. Every time you run this command, it checks whether you’ve run all available migrations, and if you haven’t, it’ll run any that remain.</p>&#13;
&#13;
<p>There<a data-primary="--seed flag" data-type="indexterm" id="seed05"/> are a few options in this namespace that you can work with. First, you can run your migrations <em>and</em> your seeds (which we’ll cover next):</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>migrate<code class="w"> </code>--seed<code class="w"/></pre>&#13;
&#13;
<p>You can also run any of the following commands:</p>&#13;
<dl>&#13;
<dt><code>migrate:install</code></dt>&#13;
<dd>&#13;
<p>Creates the database table that keeps track of which migrations you have and haven’t run; this is run automatically when you run your migrations, so you can basically ignore it.</p>&#13;
</dd>&#13;
<dt><code>migrate:reset</code></dt>&#13;
<dd>&#13;
<p>Rolls back every database migration you’ve run on this instance.</p>&#13;
</dd>&#13;
<dt><code>migrate:refresh</code></dt>&#13;
<dd>&#13;
<p>Rolls back every database migration you’ve run on this instance, and then runs every migration available. It’s the same as running <code>migrate:reset</code> followed by <code>migrate</code>.</p>&#13;
</dd>&#13;
<dt><code>migrate:fresh</code></dt>&#13;
<dd>&#13;
<p>Drops all of your tables and runs every migration again. It’s the same as <code>refresh</code> but doesn’t bother with the “down” migrations—​it just deletes the tables and then runs the “up” migrations again.</p>&#13;
</dd>&#13;
<dt><code>migrate:rollback</code></dt>&#13;
<dd>&#13;
<p>Rolls back <em>just</em> the migrations that ran the last time you ran <code>migrate</code>, or, with the added<a data-primary="--step flag" data-type="indexterm" id="id985"/> option <code>--step=<em>n</em></code>, rolls back the number of migrations you specify.</p>&#13;
</dd>&#13;
<dt><code>migrate:status</code></dt>&#13;
<dd>&#13;
<p>Shows a table listing every migration, with a <code>Y</code> or <code>N</code> next to each indicating whether or not it has run yet in this environment.</p>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h1>Migrating with Homestead/Vagrant</h1>&#13;
<p>If<a data-primary="Homestead" data-secondary="migrating databases with" data-type="indexterm" id="id986"/><a data-primary="Vagrant" data-type="indexterm" id="id987"/> you’re running migrations on your local machine and your <em>.env</em> file points to a database in a Vagrant box, your migrations will fail. You’ll need to <code>ssh</code> into your Vagrant box and then run the migrations from there. The same is true for seeds and any other Artisan commands that affect or read from the database.</p>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inspecting Your Database" data-type="sect1"><div class="sect1" id="id403">&#13;
<h1>Inspecting Your Database</h1>&#13;
&#13;
<p>If<a data-primary="databases" data-secondary="inspecting" data-type="indexterm" id="id988"/> you want to dig into the status or definition of your database, its tables, and its models, there are a few Artisan commands for exactly that purpose:</p>&#13;
<dl>&#13;
<dt><code>db:show</code></dt>&#13;
<dd>&#13;
<p>Shows a table overview of your entire database, including the connection details, tables, size, and open connections</p>&#13;
</dd>&#13;
<dt><code>db:table {<em>tableName</em>}</code></dt>&#13;
<dd>&#13;
<p>Passed a table name, shows the size and lists the columns</p>&#13;
</dd>&#13;
<dt><code>db:monitor</code></dt>&#13;
<dd>&#13;
<p>List, the number of open connections to the database</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Seeding" data-type="sect1"><div class="sect1" id="id76">&#13;
<h1>Seeding</h1>&#13;
&#13;
<p>Seeding<a data-primary="databases" data-secondary="seeding" data-tertiary="overview of" data-type="indexterm" id="id989"/><a data-primary="databases" data-secondary="seeding" data-type="indexterm" id="DBseed05"/><a data-primary="seeding" data-secondary="overview of" data-type="indexterm" id="id990"/> with Laravel is so simple, it has gained widespread adoption as a part of normal development workflows in a way it hasn’t in previous PHP frameworks. There’s a <em>database/seeders</em> folder that comes with a <code>DatabaseSeeder</code> class, which has a <code>run()</code> method that is called when you call the seeder.</p>&#13;
&#13;
<p>There are two primary ways to run the seeders: along with a migration or separately.</p>&#13;
&#13;
<p>To<a data-primary="" data-startref="seed05" data-type="indexterm" id="id991"/> run a seeder along with a migration, just add <code>--seed</code> to any migration call:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">migrate</code> <code class="o">--</code><code class="nx">seed</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">migrate</code><code class="o">:</code><code class="nx">refresh</code> <code class="o">--</code><code class="nx">seed</code></pre>&#13;
&#13;
<p>And to run it independently:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">db</code><code class="o">:</code><code class="nx">seed</code>&#13;
<code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">db</code><code class="o">:</code><code class="nx">seed</code> <code class="nx">VotesTableSeeder</code></pre>&#13;
&#13;
<p>This will call the <code>run()</code> method of the <code>DatabaseSeeder</code> by default, or the seeder class specified when you pass in a class name.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a Seeder" data-type="sect2"><div class="sect2" id="id404">&#13;
<h2>Creating a Seeder</h2>&#13;
&#13;
<p>To<a data-primary="databases" data-secondary="seeding" data-tertiary="creating seeders" data-type="indexterm" id="id992"/><a data-primary="seeding" data-secondary="creating seeders" data-type="indexterm" id="id993"/> create a seeder, use the <code>make:seeder</code> Artisan command:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">seeder</code> <code class="nx">ContactsTableSeeder</code></pre>&#13;
&#13;
<p>You’ll now see a <code>ContactsTableSeeder</code> class show up in the <em>database/seeders</em> directory. Before we edit it, let’s add it to the <code>DatabaseSeeder</code> class, as shown in <a data-type="xref" href="#EX5x">Example 5-5</a>, so it will run when we run our seeders.</p>&#13;
<div data-type="example" id="EX5x">&#13;
<h5><span class="label">Example 5-5. </span>Calling a custom seeder from DatabaseSeeder.php</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// database/seeders/DatabaseSeeder.php</code>&#13;
<code class="o">...</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">run</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">call</code><code class="p">(</code><code class="nx">ContactsTableSeeder</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now let’s edit the seeder itself. The simplest thing we can do there is manually insert a record using the <code>DB</code> facade, as illustrated in <a data-type="xref" href="#EX5y">Example 5-6</a>.</p>&#13;
<div data-type="example" id="EX5y">&#13;
<h5><span class="label">Example 5-6. </span>Inserting database records in a custom seeder</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Database\Seeders</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Seeder</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ContactsTableSeeder</code> <code class="k">extends</code> <code class="nx">Seeder</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">run</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">insert</code><code class="p">([</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
        <code class="p">]);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>This will get us a single record, which is a good start. But for truly functional seeds, you’ll likely want to loop over some sort of random generator and run this <code>insert()</code> many times, right? Laravel has a feature for that.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Model Factories" data-type="sect2"><div class="sect2" id="model_factories">&#13;
<h2>Model Factories</h2>&#13;
&#13;
<p>Model factories<a data-primary="seeding" data-secondary="model factories" data-type="indexterm" id="id994"/><a data-primary="databases" data-secondary="seeding" data-tertiary="model factories" data-type="indexterm" id="id995"/><a data-primary="model factories" data-secondary="purpose of" data-type="indexterm" id="id996"/> define one (or more) patterns for creating fake entries for your database tables. By<a data-primary="names and naming" data-secondary="model factories" data-type="indexterm" id="id997"/> default, each factory is named after an Eloquent class.</p>&#13;
&#13;
<p>Theoretically<a data-primary="model factories" data-secondary="naming" data-type="indexterm" id="id998"/> you can name these factories anything you like, but naming the factory after your Eloquent class is the most idiomatic approach. If you follow a different convention to name your factories, you can set the factory class name in the related model.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating a model factory" data-type="sect3"><div class="sect3" id="id77">&#13;
<h3>Creating a model factory</h3>&#13;
&#13;
<p>Model factories<a data-primary="model factories" data-secondary="creating" data-type="indexterm" id="id999"/> are located in <em>database/factories</em>. Each factory is defined in its own class, with a definition method. In this method you define the attributes and their values to be used when creating a model with the factory.</p>&#13;
&#13;
<p>To generate a new factory class, use the Artisan <code>make:factory</code> command; again, it’s most common to name factory classes after the Eloquent models they’re meant to generate instances of:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">factory</code> <code class="nx">ContactFactory</code></pre>&#13;
&#13;
<p>This will generate a new file within the <em>database/factories</em> directory called <em>ContactFactory.php</em>. The simplest factory we could define for a contact might look something like <a data-type="xref" href="#EX880">Example 5-7</a>:</p>&#13;
<div data-type="example" id="EX880">&#13;
<h5><span class="label">Example 5-7. </span>The simplest possible factory definition</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Database\Factories</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\Models\Contact</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Factories\Factory</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ContactFactory</code> <code class="k">extends</code> <code class="nx">Factory</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You now need to use the <code>Illuminate\Database\Eloquent\Factories\HasFactory</code> trait in your model.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">namespace</code> <code class="nx">App\Models</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Factories\HasFactory</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">HasFactory</code><code class="p">;</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>The <code>HasFactory</code> trait provides a <code>factory()</code> static method, which uses Laravel conventions to determine the proper factory for the model. It will look for a factory in <code>Database\Factories</code> namespace that has a class name matching the model name and is suffixed with <code>Factory</code>. If you don’t follow these conventions, you can override the <code>newFactory()</code> method in your model to specify the factory class that should be used:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/Models/Contact.php</code>&#13;
<code class="o">...</code>&#13;
 <code class="o">*</code> <code class="nx">Create</code> <code class="nx">a</code> <code class="k">new</code> <code class="nx">factory</code> <code class="nx">instance</code> <code class="k">for</code> <code class="nx">the</code> <code class="nx">model</code><code class="o">.</code>&#13;
 <code class="o">*</code>&#13;
 <code class="o">*</code> <code class="o">@</code><code class="k">return</code> <code class="nx">\Illuminate\Database\Eloquent\Factories\Factory</code>&#13;
 <code class="o">*/</code>&#13;
<code class="k">protected</code> <code class="k">static</code> <code class="k">function</code> <code class="nf">newFactory</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">\Database\Factories\Base\ContactFactory</code><code class="o">::</code><code class="na">new</code><code class="p">();</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Now we can call the static <code>factory()</code> method on the model, to create an instance of <code>Contact</code> in our seeding and testing:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Create one</code>&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Create many</code>&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">20</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre>&#13;
&#13;
<p>However, if we used that factory to create 20 contacts, all 20 would have the same information. That’s less useful.</p>&#13;
&#13;
<p>We will get even more benefit from model factories when we take advantage of <a href="https://oreil.ly/gxnrI">Faker</a>, which is globally available in Laravel via the <code>fake()</code> helper; Faker makes it easy to randomize the creation of structured fake data. The previous example now turns into <a data-type="xref" href="#EX881">Example 5-8</a>.</p>&#13;
<div data-type="example" id="EX881">&#13;
<h5><span class="label">Example 5-8. </span>A simple factory, modified to use Faker</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Database\Factories</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\Models\Contact</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Factories\Factory</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ContactFactory</code> <code class="k">extends</code> <code class="nx">Factory</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="nx">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">(),</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nx">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">(),</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now, every time we create a fake contact using this model factory, all of our properties will be randomly generated.</p>&#13;
&#13;
<p>Model factories need, at minimum, to return the required database fields for this table.</p>&#13;
<div data-type="tip"><h1>Guaranteeing the Uniqueness of Randomly Generated Data</h1>&#13;
<p>If<a data-primary="randomly generated data" data-type="indexterm" id="id1000"/><a data-primary="Faker library" data-type="indexterm" id="id1001"/><a data-primary="unique() method" data-type="indexterm" id="id1002"/><a data-primary="data" data-secondary="randomly generated" data-type="indexterm" id="id1003"/> you want to guarantee that the randomly generated values of any given entry are unique compared to the other randomly generated values during that PHP process, you can use Faker’s <code>unique()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="p">[</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nx">fake</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">unique</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">email</code><code class="p">()];</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using a model factory" data-type="sect3"><div class="sect3" id="id406">&#13;
<h3>Using a model factory</h3>&#13;
&#13;
<p>There<a data-primary="model factories" data-secondary="using" data-type="indexterm" id="id1004"/> are two primary contexts in which we’ll use model factories: testing, which we’ll cover in <a data-type="xref" href="ch12.html#testing">Chapter 12</a>, and seeding, which we’ll cover here. Let’s write a seeder using a model factory; take a look at <a data-type="xref" href="#EX803">Example 5-9</a>.</p>&#13;
<div data-type="example" id="EX803">&#13;
<h5><span class="label">Example 5-9. </span>Using model factories</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$post</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
    <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s1">'My greatest post ever'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="c1">// Pro-level factory; but don't get overwhelmed!</code>&#13;
<code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">20</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="nx">Address</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">2</code><code class="p">))</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">()</code></pre></div>&#13;
&#13;
<p>To create an object, we use the <code>factory()</code> method on the model. Then we can run one of two methods on it: <code>make()</code> or <code>create()</code>.</p>&#13;
&#13;
<p>Both methods generate an instance of this specified model, using the definition in the factory class. The difference is that <code>make()</code> creates the instance but doesn’t (yet) save it to the database, whereas <code>create()</code> saves it to the database instantly.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Overriding properties when calling a model factory" data-type="sect4"><div class="sect4" id="id649">&#13;
<h4>Overriding properties when calling a model factory</h4>&#13;
&#13;
<p>If you pass an array to either <code>make()</code> or <code>create()</code>, you can override specific keys from the factory, like we did in <a data-type="xref" href="#EX803">Example 5-9</a> to manually set the <code>title</code> on the post.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Generating more than one instance with a model factory" data-type="sect4"><div class="sect4" id="id650">&#13;
<h4>Generating more than one instance with a model factory</h4>&#13;
&#13;
<p>If you call the <code>count()</code> method after the <code>factory()</code> method, you can specify that you’re creating more than one instance. Instead of returning a single instance, it’ll return a collection of instances. This means you can treat the result like an array, iterating over them or passing them to any method that takes more than one object:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$posts</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">6</code><code class="p">);</code></pre>&#13;
&#13;
<p>You can also, optionally, define a “sequence” of how to override each:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$posts</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">6</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">state</code><code class="p">(</code><code class="k">new</code> <code class="nx">Sequence</code><code class="p">(</code>&#13;
        <code class="p">[</code><code class="s1">'is_published'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">],</code>&#13;
        <code class="p">[</code><code class="s1">'is_published'</code> <code class="o">=&gt;</code> <code class="k">false</code><code class="p">],</code>&#13;
    <code class="p">))</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Pro-level model factories" data-type="sect3"><div class="sect3" id="id407">&#13;
<h3>Pro-level model factories</h3>&#13;
&#13;
<p>Now<a data-primary="model factories" data-secondary="pro-level" data-type="indexterm" id="id1005"/> that we’ve covered the most common uses for and arrangements of model factories, let’s dive into some of the more complicated ways we can use them.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attaching relationships when defining model factories" data-type="sect4"><div class="sect4" id="id651">&#13;
<h4>Attaching relationships when defining model factories</h4>&#13;
&#13;
<p>Sometimes you need to create a related item along with the item you’re creating. You can call the factory method on the related model to pull its ID, as shown in <a data-type="xref" href="#EX5a">Example 5-10</a>.</p>&#13;
<div data-type="example" id="EX5a">&#13;
<h5><span class="label">Example 5-10. </span>Creating a related item in a factory</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">Database\Factories</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\Models\Contact</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Factories\Factory</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ContactFactory</code> <code class="k">extends</code> <code class="nx">Factory</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$model</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
            <code class="s1">'company_id'</code> <code class="o">=&gt;</code> <code class="nx">\App\Models\Company</code><code class="o">::</code><code class="na">factory</code><code class="p">(),</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can also pass a closure where a single parameter is passed, which contains the array form of the generated item up until that point. This can be used in other ways, as demonstrated in <a data-type="xref" href="#EX5b">Example 5-11</a>.</p>&#13;
<div data-type="example" id="EX5b">&#13;
<h5><span class="label">Example 5-11. </span>Using values from other parameters in a factory</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// ContactFactory.php</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="p">[</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
        <code class="s1">'company_id'</code> <code class="o">=&gt;</code> <code class="nx">Company</code><code class="o">::</code><code class="na">factory</code><code class="p">(),</code>&#13;
        <code class="s1">'company_size'</code> <code class="o">=&gt;</code> <code class="k">function</code> <code class="p">(</code><code class="k">array</code> <code class="nv">$attributes</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="c1">// Uses the "company_id" property generated above</code>&#13;
            <code class="k">return</code> <code class="nx">Company</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="nv">$attributes</code><code class="p">[</code><code class="s1">'company_id'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">size</code><code class="p">;</code>&#13;
        <code class="p">},</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attaching related items when generating model factory instances" data-type="sect4"><div class="sect4" id="id652">&#13;
<h4>Attaching related items when generating model factory instances</h4>&#13;
&#13;
<p>While we’ve already covered how to define a relationship in a factory definition, it’s much more common that we’ll be defining our instance’s related items right when we create it.</p>&#13;
&#13;
<p>There are two main methods we’ll use for this: <code>has()</code> and <code>for()</code>. <code>has()</code> allows us to define that the instance we’re creating “has” children or other items in a “hasMany” type relationship, whereas <code>for()</code> allows us to define that the instance we’re creating “belongsTo” another item. Let’s look at a few examples to get a better sense of how they work.</p>&#13;
&#13;
<p>In <a data-type="xref" href="#EX5g">Example 5-12</a>, let’s assume a <code>Contact</code> has many <code>Addresses</code>.</p>&#13;
<div data-type="example" id="EX5g">&#13;
<h5><span class="label">Example 5-12. </span>Using <code>has()</code> when generating related models</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Attach 3 addresses</code>&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="nx">Address</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">3</code><code class="p">))</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">()</code>&#13;
&#13;
<code class="c1">// Accessing information about each user in the child factory</code>&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code>&#13;
        <code class="nx">Address</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
            <code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">state</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="k">array</code> <code class="nv">$attributes</code><code class="p">,</code> <code class="nx">User</code> <code class="nv">$user</code><code class="p">)</code> <code class="p">{</code>&#13;
                <code class="k">return</code> <code class="p">[</code><code class="s1">'label'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">name</code> <code class="o">.</code> <code class="s1">' address'</code><code class="p">];</code>&#13;
            <code class="p">})</code>&#13;
    <code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Now let’s imagine we’re creating the child instance instead of the parent instance. Let’s generate an address.</p>&#13;
&#13;
<p>In these sorts of circumstances, you usually can assume the child’s factory definition would take care of generating the parent instance. So, what’s the use of <code>for()</code> at all? It’s most helpful if you want to specifically define something about the parent, usually either one or more of its properties, or pass in a specific model instance. Take a look at <a data-type="xref" href="#EX5h">Example 5-13</a> to see how it’s most commonly used.</p>&#13;
<div data-type="example" id="EX5h">&#13;
<h5><span class="label">Example 5-13. </span>Using <code>for()</code> when generating related models</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Specify details about the created parent</code>&#13;
<code class="nx">Address</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">for</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">state</code><code class="p">([</code>&#13;
        <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Imani Carette'</code><code class="p">,</code>&#13;
    <code class="p">]))</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Use an existing parent model (assuming we already have it as $contact)</code>&#13;
<code class="nx">Address</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">for</code><code class="p">(</code><code class="nv">$contact</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Defining and accessing multiple model factory states" data-type="sect4"><div class="sect4" id="id653">&#13;
<h4>Defining and accessing multiple model factory states</h4>&#13;
&#13;
<p>Let’s go back to <em>ContactFactory.php</em> (from Examples <a data-type="xref" data-xrefstyle="select:labelnumber" href="#EX880">5-7</a> and <a data-type="xref" data-xrefstyle="select:labelnumber" href="#EX881">5-8</a>) for a second. We have a base <code>Contact</code> factory defined:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">ContactFactory</code> <code class="k">extends</code> <code class="nx">Factory</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$model</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>But sometimes you need more than one factory for a class of object. What if we need to be able to add some contacts who are very important people (VIPs)? We can use the <code>state()</code> method to define a second factory state for this, as seen in <a data-type="xref" href="#EX804">Example 5-14</a>. The <code>state()</code> method receives an array of any attributes you want to specifically set for this state.</p>&#13;
<div data-type="example" id="EX804">&#13;
<h5><span class="label">Example 5-14. </span>Defining multiple factory states for the same model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">ContactFactory</code> <code class="k">extends</code> <code class="nx">Factory</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$model</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">definition</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Lupita Smith'</code><code class="p">,</code>&#13;
            <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'lupita@gmail.com'</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">vip</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">state</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="k">array</code> <code class="nv">$attributes</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="p">[</code>&#13;
                <code class="s1">'vip'</code> <code class="o">=&gt;</code> <code class="k">true</code><code class="p">,</code>&#13;
                <code class="c1">// Uses the "company_id" property from the $attributes</code>&#13;
                <code class="s1">'company_size'</code> <code class="o">=&gt;</code> <code class="k">function</code> <code class="p">()</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$attributes</code><code class="p">)</code> <code class="p">{</code>&#13;
                    <code class="k">return</code> <code class="nx">Company</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="nv">$attributes</code><code class="p">[</code><code class="s1">'company_id'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">size</code><code class="p">;</code>&#13;
                <code class="p">},</code>&#13;
            <code class="p">];</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Now, let’s make an instance of a specific state:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$vip</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">vip</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$vips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">(</code><code class="mi">3</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">vip</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using the same model as the relationship in complex factory Setups" data-type="sect4"><div class="sect4" id="id78">&#13;
<h4>Using the same model as the relationship in complex factory Setups</h4>&#13;
&#13;
<p>Sometimes you have a factory that creates related items through their factories, and two or more of those have the same relationship. Maybe generating a <code>Trip</code> with your factory automatically creates a <code>Reservation</code> and a <code>Receipt</code>, and all three should be attached to the same <code>User</code>. When you go to create the <code>Trip</code>, the factories will each create their own user manually, unless you tell them to do otherwise.</p>&#13;
&#13;
<p>With the <code>recycle()</code> method, you can instruct that every factory called up the chain uses the same instance of a given object. As you can see in <a data-type="xref" href="#EX5i">Example 5-15</a>, this gives a simple syntax for ensuring the same model is used in every place throughout a factory chain.</p>&#13;
<div data-type="example" id="EX5i">&#13;
<h5><span class="label">Example 5-15. </span>Using <code>recycle()</code> to use the same instance for every relationship in a factory chain</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$trip</code> <code class="o">=</code> <code class="nx">Trip</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code>&#13;
    <code class="o">-&gt;</code><code class="na">recycle</code><code class="p">(</code><code class="nv">$user</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Whew. That was a lot. Don’t worry if that was tough to follow—​the last bit was definitely higher-level stuff. Let’s get back down to the basics and talk about the core of Laravel’s database tooling: the query builder.<a data-primary="" data-startref="DBseed05" data-type="indexterm" id="id1006"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Query Builder" data-type="sect1"><div class="sect1" id="id408">&#13;
<h1>Query Builder</h1>&#13;
&#13;
<p>Now<a data-primary="databases" data-secondary="query builder" data-type="indexterm" id="DBquerybuild05"/><a data-primary="query builder" data-secondary="benefits of" data-type="indexterm" id="id1007"/><a data-primary="databases" data-secondary="query builder" data-tertiary="benefits of" data-type="indexterm" id="id1008"/> that you’re connected and you’ve migrated and seeded your tables, let’s get started with how to use the database tools. At the core of every piece of Laravel’s <span class="keep-together">database</span> functionality is the <em>query builder</em>, a fluent interface for interacting with several different types of databases with a single clear API.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="fluent">&#13;
<h1>What Is a Fluent Interface?</h1>&#13;
<p>A <em>fluent interface</em> is<a data-primary="fluent interfaces" data-secondary="versus non-fluent" data-secondary-sortas="non-fluent" data-type="indexterm" id="id1009"/> one that primarily uses method chaining to provide a simpler API to the end user. Rather than expecting all of the relevant data to be passed into either a constructor or a method call, fluent call chains can be built gradually, with consecutive calls. Consider this comparison:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Non-fluent:</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">select</code><code class="p">([</code><code class="s1">'table'</code> <code class="o">=&gt;</code> <code class="s1">'users'</code><code class="p">,</code> <code class="s1">'where'</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'type'</code> <code class="o">=&gt;</code> <code class="s1">'donor'</code><code class="p">]]);</code>&#13;
&#13;
<code class="c1">// Fluent:</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'type'</code><code class="p">,</code> <code class="s1">'donor'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></aside>&#13;
&#13;
<p>Laravel’s database architecture can connect to MySQL, PostgreSQL, SQLite, and SQL Server through a single interface, with just the change of a few configuration settings.</p>&#13;
&#13;
<p>If you’ve ever used a PHP framework, you’ve likely used a tool that allows you to run “raw” SQL queries with basic escaping for security. The query builder is that, with a lot of convenience layers and helpers on top. So, let’s start with some simple calls.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic Usage of the DB Facade" data-type="sect2"><div class="sect2" id="id79">&#13;
<h2>Basic Usage of the DB Facade</h2>&#13;
&#13;
<p>Before<a data-primary="query builder" data-secondary="using DB facade" data-type="indexterm" id="id1010"/><a data-primary="databases" data-secondary="query builder" data-tertiary="using DB facade" data-type="indexterm" id="id1011"/><a data-primary="DB facade" data-type="indexterm" id="id1012"/> we get into building complex queries with fluent method chaining, let’s take a look at a few sample query builder commands. The <code>DB</code> facade is used both for query builder chaining and for simpler raw queries, as illustrated in <a data-type="xref" href="#EX806">Example 5-16</a>.</p>&#13;
<div data-type="example" id="EX806">&#13;
<h5><span class="label">Example 5-16. </span>Sample raw SQL and query builder usage</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Basic statement</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">statement</code><code class="p">(</code><code class="s1">'drop table users'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Raw select, and parameter binding</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">select</code><code class="p">(</code><code class="s1">'select * from contacts where validated = ?'</code><code class="p">,</code> <code class="p">[</code><code class="k">true</code><code class="p">]);</code>&#13;
&#13;
<code class="c1">// Select using the fluent builder</code>&#13;
<code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Joins and other complex calls</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">join</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$join</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$join</code><code class="o">-&gt;</code><code class="na">on</code><code class="p">(</code><code class="s1">'users.id'</code><code class="p">,</code> <code class="s1">'='</code><code class="p">,</code> <code class="s1">'contacts.user_id'</code><code class="p">)</code>&#13;
             <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'contacts.type'</code><code class="p">,</code> <code class="s1">'donor'</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw SQL" data-type="sect2"><div class="sect2" id="id80">&#13;
<h2>Raw SQL</h2>&#13;
&#13;
<p>As<a data-primary="query builder" data-secondary="raw SQL" data-type="indexterm" id="id1013"/><a data-primary="databases" data-secondary="query builder" data-tertiary="raw SQL" data-type="indexterm" id="id1014"/><a data-primary="raw SQL" data-type="indexterm" id="id1015"/><a data-primary="structured query language (SQL)" data-type="indexterm" id="id1016"/><a data-primary="SQL (structured query language)" data-type="indexterm" id="id1017"/> you saw in <a data-type="xref" href="#EX806">Example 5-16</a>, it’s possible to make any raw call to the database using the <code>DB</code> facade and the <code>statement()</code> method: <code>DB::statement('<em>SQL statement here</em>')</code>.</p>&#13;
&#13;
<p>But there are also specific methods for various common actions: <code>select()</code>, <code>insert()</code>, <code>update()</code>, and <code>delete()</code>. These are still raw calls, but there are differences. First, using <code>update()</code> and <code>delete()</code> will return the number of rows affected, whereas <span class="keep-together"><code>statement()</code></span> won’t; second, with these methods it’s clearer to future developers exactly what sort of statement you’re making.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw selects" data-type="sect3"><div class="sect3" id="id654">&#13;
<h3>Raw selects</h3>&#13;
&#13;
<p>The simplest of the specific <code>DB</code> methods is <code>select()</code>. You can run it without any additional parameters:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">select</code><code class="p">(</code><code class="s1">'select * from users'</code><code class="p">);</code></pre>&#13;
&#13;
<p>This will return an array of <code>stdClass</code> objects.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Parameter bindings and named bindings" data-type="sect3"><div class="sect3" id="parameter_bindings">&#13;
<h3>Parameter bindings and named bindings</h3>&#13;
&#13;
<p>Laravel’s database architecture allows for the use of PDO (PHP data object, PHP’s native database access layer) parameter binding, which protects your queries from potential SQL attacks. Passing a parameter to a statement is as simple as replacing the value in your statement with a <code>?</code>, then adding the value to the second parameter of your call:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$usersOfType</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">select</code><code class="p">(</code>&#13;
    <code class="s1">'select * from users where type = ?'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="nv">$type</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>You can also name those parameters for clarity:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$usersOfType</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">select</code><code class="p">(</code>&#13;
    <code class="s1">'select * from users where type = :type'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="s1">'type'</code> <code class="o">=&gt;</code> <code class="nv">$userType</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw inserts" data-type="sect3"><div class="sect3" id="id656">&#13;
<h3>Raw inserts</h3>&#13;
&#13;
<p>From here, the raw commands all look pretty much the same. Raw inserts look like this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">insert</code><code class="p">(</code>&#13;
    <code class="s1">'insert into contacts (name, email) values (?, ?)'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="s1">'sally'</code><code class="p">,</code> <code class="s1">'sally@me.com'</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw updates" data-type="sect3"><div class="sect3" id="id657">&#13;
<h3>Raw updates</h3>&#13;
&#13;
<p>Updates look like this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$countUpdated</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">update</code><code class="p">(</code>&#13;
    <code class="s1">'update contacts set status = ? where id = ?'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="s1">'donor'</code><code class="p">,</code> <code class="nv">$id</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Raw deletes" data-type="sect3"><div class="sect3" id="id658">&#13;
<h3>Raw deletes</h3>&#13;
&#13;
<p>And deletes look like this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$countDeleted</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">delete</code><code class="p">(</code>&#13;
    <code class="s1">'delete from contacts where archived = ?'</code><code class="p">,</code>&#13;
    <code class="p">[</code><code class="k">true</code><code class="p">]</code>&#13;
<code class="p">);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chaining with the Query Builder" data-type="sect2"><div class="sect2" id="id409">&#13;
<h2>Chaining with the Query Builder</h2>&#13;
&#13;
<p>Up<a data-primary="query builder" data-secondary="chaining with" data-type="indexterm" id="QBchain05"/><a data-primary="databases" data-secondary="query builder" data-tertiary="chaining with" data-type="indexterm" id="id1018"/> until now, we haven’t actually used the query builder, per se. We’ve just used simple method calls on the <code>DB</code> facade. Let’s actually build some queries.</p>&#13;
&#13;
<p>The query builder makes it possible to chain methods together to, you guessed it, <em>build a query</em>. At the end of your chain you’ll use some method—likely <code>get()</code>—to trigger the actual execution of the query you’ve just built.</p>&#13;
&#13;
<p>Let’s take a look at a quick example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$usersOfType</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'type'</code><code class="p">,</code> <code class="nv">$type</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>Here, we built our query—<code>users</code> table, <code>$type</code> type—​and then we executed the query and got our result. Note that, unlike the previous calls, this will return a <em>collection</em> of <code>stdClass</code> objects instead of an array.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1019">&#13;
<h1>Illuminate Collections</h1>&#13;
<p>The<a data-primary="collections" data-secondary="chained methods and" data-type="indexterm" id="id1020"/> <code>DB</code> facade, like Eloquent, returns a collection for any chained method that returns (or can return) multiple rows and an array for any nonchained method that returns (or can return) multiple rows. The <code>DB</code> facade returns an instance of <code>Illuminate\Support\Collection</code> and Eloquent returns an instance of <code>Illuminate\Database\Eloquent\Collection</code>, which extends <code>Illuminate\Support\Collection</code> with a few Eloquent-specific methods.</p>&#13;
&#13;
<p><code>Collection</code> is like a PHP array with superpowers, allowing you to run <code>map()</code>, <code class="keep-together">filter()</code>, <code>reduce()</code>, <code>each()</code>, and much more on your data. You can learn more about collections in <a data-type="xref" href="ch17.html#helpers_and_collections">Chapter 17</a>.</p>&#13;
</div></aside>&#13;
&#13;
<p>Let’s take a look at what methods the query builder allows you to chain. The methods can be split up into what I’ll call constraining methods, modifying methods, conditional methods, and ending/returning methods.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Constraining methods" data-type="sect3"><div class="sect3" id="id81">&#13;
<h3>Constraining methods</h3>&#13;
&#13;
<p>These<a data-primary="query builder" data-secondary="chaining with" data-tertiary="constraining methods" data-type="indexterm" id="id1021"/><a data-primary="constraining methods (query builder)" data-type="indexterm" id="constrainmeth05"/> methods take the query as it is and constrain it to return a smaller subset of possible data:</p>&#13;
<dl>&#13;
<dt><code>select()</code></dt>&#13;
<dd>&#13;
<p>Allows you to choose which columns you’re selecting:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$emails</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'email'</code><code class="p">,</code> <code class="s1">'email2 as second_email'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
<code class="c1">// Or</code>&#13;
<code class="nv">$emails</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'email'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">addSelect</code><code class="p">(</code><code class="s1">'email2 as second_email'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>where()</code></dt>&#13;
<dd>&#13;
<p>Allows you to limit the scope of what’s being returned using <code>WHERE</code>. By default, the signature of the <code>where()</code> method takes three parameters—the column, the comparison operator, and the value:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$newContacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contact'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subDay</code><code class="p">())</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>However, if your comparison is <code>=</code>, which is the most common comparison, you can drop the second operator:</p>&#13;
&#13;
<pre data-type="programlisting">$vipContacts = DB::table('contacts')-&gt;where('vip',true)-&gt;get();</pre>&#13;
&#13;
<p>If you want to combine <code>where()</code> statements, you can either chain them after each other, or pass an array of arrays:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$newVips</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subDay</code><code class="p">());</code>&#13;
<code class="c1">// Or</code>&#13;
<code class="nv">$newVips</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">([</code>&#13;
    <code class="p">[</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subDay</code><code class="p">()],</code>&#13;
<code class="p">]);</code></pre>&#13;
</dd>&#13;
<dt><code>orWhere()</code></dt>&#13;
<dd>&#13;
<p>Creates simple <code>OR WHERE</code> statements:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$priorityContacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orWhere</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subDay</code><code class="p">())</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>To create a more complex <code>OR WHERE</code> statement with multiple conditions, pass <code>orWhere()</code> a closure:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orWhere</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subDay</code><code class="p">())</code>&#13;
            <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'trial'</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
</dl>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1022">&#13;
<h1>Potential Confusion with Multiple where() and orWhere() Calls</h1>&#13;
<p>If you are using <code>orWhere()</code> calls in conjunction with multiple <code>where()</code> calls, you need to be very careful to ensure the query is doing what you think it is. This isn’t because of any fault with Laravel, but because a query like the following might not do what <span class="keep-together">you expect:</span></p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$canEdit</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'admin'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orWhere</code><code class="p">(</code><code class="s1">'plan'</code><code class="p">,</code> <code class="s1">'premium'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'is_plan_owner'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<pre data-code-language="sql" data-type="programlisting"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">users</code>&#13;
    <code class="k">WHERE</code> <code class="k">admin</code> <code class="o">=</code> <code class="mi">1</code>&#13;
    <code class="k">OR</code> <code class="n">plan</code> <code class="o">=</code> <code class="s1">'premium'</code>&#13;
    <code class="k">AND</code> <code class="n">is_plan_owner</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code></pre>&#13;
&#13;
<p>If you want to write SQL that says “if this OR (this and this),” which is clearly the intention in the previous example, you’ll want to pass a closure into the <code>orWhere()</code> call:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$canEdit</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'admin'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orWhere</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'plan'</code><code class="p">,</code> <code class="s1">'premium'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'is_plan_owner'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<pre data-code-language="sql" data-type="programlisting"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">users</code>&#13;
    <code class="k">WHERE</code> <code class="k">admin</code> <code class="o">=</code> <code class="mi">1</code>&#13;
    <code class="k">OR</code> <code class="p">(</code><code class="n">plan</code> <code class="o">=</code> <code class="s1">'premium'</code> <code class="k">AND</code> <code class="n">is_plan_owner</code> <code class="o">=</code> <code class="mi">1</code><code class="p">);</code></pre>&#13;
</div></aside>&#13;
<dl>&#13;
<dt><code>whereBetween(<em>colName</em>, [<em>low</em>, <em>high</em>])</code></dt>&#13;
<dd>&#13;
<p>Allows you to scope a query to return only rows where a column is between two values (inclusive of the two values):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$mediumDrinks</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'drinks'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">whereBetween</code><code class="p">(</code><code class="s1">'size'</code><code class="p">,</code> <code class="p">[</code><code class="mi">6</code><code class="p">,</code> <code class="mi">12</code><code class="p">])</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>The same works for <code>whereNotBetween()</code>, but it will select the inverse.</p>&#13;
</dd>&#13;
<dt><code>whereIn(<em>colName</em>, [<em>1</em>, <em>2</em>, <em>3</em>])</code></dt>&#13;
<dd>&#13;
<p>Allows you to scope a query to return only rows where a column value is in an <span class="keep-together">explicitly</span> provided list of options:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$closeBy</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">whereIn</code><code class="p">(</code><code class="s1">'state'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'FL'</code><code class="p">,</code> <code class="s1">'GA'</code><code class="p">,</code> <code class="s1">'AL'</code><code class="p">])</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>The same works for <code>whereNotIn()</code>, but it will select the inverse.</p>&#13;
</dd>&#13;
<dt><code>whereNull(<em>colName</em>)</code>, <code>whereNotNull(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Allows you to select only rows where a given column is <code>NULL</code> or is <code>NOT NULL</code>, respectively.</p>&#13;
</dd>&#13;
<dt><code>whereRaw()</code></dt>&#13;
<dd>&#13;
<p>Allows you to pass in a raw, unescaped string to be added after the <code>WHERE</code> &#13;
<span class="keep-together">statement</span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$goofs</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">whereRaw</code><code class="p">(</code><code class="s1">'id = 12345'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="warning" epub:type="warning"><h1>Beware of SQL Injection!</h1>&#13;
<p>Any<a data-primary="SQL injection attacks" data-type="indexterm" id="id1023"/> SQL queries passed to <code>whereRaw()</code> will not be escaped. Use this method carefully and infrequently; this is a prime opportunity for SQL injection attacks in your app.</p>&#13;
</div>&#13;
<dl>&#13;
<dt><code>whereExists()</code></dt>&#13;
<dd>&#13;
<p>Allows you to select only rows that, when passed into a provided subquery, return at least one row. Imagine you only want to get those users who have left at least one comment:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$commenters</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">whereExists</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'id'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">from</code><code class="p">(</code><code class="s1">'comments'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">whereRaw</code><code class="p">(</code><code class="s1">'comments.user_id = users.id'</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>distinct()</code></dt>&#13;
<dd>&#13;
<p>Selects only rows where the selected data is unique when compared to the other rows in the returned data. Usually this is paired with <code>select()</code>, because if you <span class="keep-together">use a</span> primary key, there will be no duplicated<a data-primary="" data-startref="constrainmeth05" data-type="indexterm" id="id1024"/> rows:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$lastNames</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'city'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">distinct</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Modifying methods" data-type="sect3"><div class="sect3" id="id82">&#13;
<h3>Modifying methods</h3>&#13;
&#13;
<p>These<a data-primary="modifying methods (query builder)" data-type="indexterm" id="id1025"/><a data-primary="query builder" data-secondary="chaining with" data-tertiary="modifying methods" data-type="indexterm" id="id1026"/> methods change the way the query’s results will be output, rather than just limiting its results:</p>&#13;
<dl>&#13;
<dt><code>orderBy(<em>colName</em>, <em>direction</em>)</code></dt>&#13;
<dd>&#13;
<p>Orders the results. The second parameter may be either <code>asc</code> (the default, ascending order) or <code>desc</code> (descending order):</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orderBy</code><code class="p">(</code><code class="s1">'last_name'</code><code class="p">,</code> <code class="s1">'asc'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>groupBy()</code>, <code>having()</code>, <code>havingRaw()</code></dt>&#13;
<dd>&#13;
<p>Groups your results by a column. Optionally, <code>having()</code> and <code>havingRaw()</code> allow you to filter your results based on properties of the groups. For example, you could look for only cities with at least 30 people in them:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$populousCities</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">groupBy</code><code class="p">(</code><code class="s1">'city'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">havingRaw</code><code class="p">(</code><code class="s1">'count(contact_id) &gt; 30'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>skip()</code>, <code>take()</code></dt>&#13;
<dd>&#13;
<p>Most often used for pagination, these allow you to define how many rows to return and how many to skip before starting the return—​like a page number and a page size in a pagination system:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// returns rows 31-40</code>&#13;
<code class="nv">$page4</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">skip</code><code class="p">(</code><code class="mi">30</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">take</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>latest(<em>colName</em>)</code>, <code>oldest(<em>colName</em>)</code></dt>&#13;
<dd>&#13;
<p>Sorts by the passed column (or <code>created_at</code> if no column name is passed) in descending (<code>latest()</code>) or ascending (<code>oldest()</code>) order.</p>&#13;
</dd>&#13;
<dt><code>inRandomOrder()</code></dt>&#13;
<dd>&#13;
<p>Sorts the result randomly.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Conditional methods" data-type="sect3"><div class="sect3" id="id83">&#13;
<h3>Conditional methods</h3>&#13;
&#13;
<p>There<a data-primary="conditional methods (query builder)" data-type="indexterm" id="id1027"/><a data-primary="query builder" data-secondary="chaining with" data-tertiary="modifying methods" data-type="indexterm" id="id1028"/> are two methods that allow you to conditionally apply their “contents” (a closure you pass to them) based on the Boolean state of a value you pass in:</p>&#13;
<dl>&#13;
<dt><code>when()</code></dt>&#13;
<dd>&#13;
<p>Given a truthy first parameter, applies the query modification contained in the closure; given a falsy first parameter, it does nothing. Note that the first parameter could be a Boolean (e.g., <code>$ignoreDrafts</code>, set to <code>true</code> or <code>false</code>), an optional value (<code>$status</code>, pulled from user input and defaulting to <code>null</code>), or a closure that returns either; what matters is that it evaluates to truthy or falsy. For example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$status</code> <code class="o">=</code> <code class="nx">request</code><code class="p">(</code><code class="s1">'status'</code><code class="p">);</code> <code class="c1">// Defaults to null if not set</code>&#13;
&#13;
<code class="nv">$posts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="nv">$status</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$status</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="nv">$status</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Or</code>&#13;
<code class="nv">$posts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">when</code><code class="p">(</code><code class="nv">$ignoreDrafts</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'draft'</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also pass a third parameter, another closure, which will be applied only if the first parameter is falsy.</p>&#13;
</dd>&#13;
<dt><code>unless()</code></dt>&#13;
<dd>&#13;
<p>The exact inverse of <code>when()</code>. If the first parameter is falsy, it will run the second closure.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Ending/returning methods" data-type="sect3"><div class="sect3" id="id84">&#13;
<h3>Ending/returning methods</h3>&#13;
&#13;
<p>These<a data-primary="ending/returning methods (query builder)" data-type="indexterm" id="id1029"/><a data-primary="query builder" data-secondary="chaining with" data-tertiary="ending/returning methods" data-type="indexterm" id="id1030"/> methods stop the query chain and trigger the execution of the SQL query. Without one of these at the end of the query chain, your return will always just be an instance of the query builder; chain one of these onto a query builder, and you’ll actually get a result:</p>&#13;
<dl>&#13;
<dt><code>get()</code></dt>&#13;
<dd>&#13;
<p>Gets all results for the built query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
<code class="nv">$vipContacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</dd>&#13;
<dt><code>first()</code>, <code>firstOrFail()</code></dt>&#13;
<dd>&#13;
<p>Gets only the first result—​like <code>get()</code>, but with a <code>LIMIT 1</code> added:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$newestContact</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orderBy</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'desc'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code></pre>&#13;
&#13;
<p><code>first()</code> fails silently if there are no results, whereas <code>firstOrFail()</code> will throw an exception.</p>&#13;
&#13;
<p>If you pass an array of column names to either method, it will return the data for just those columns instead of all columns.</p>&#13;
</dd>&#13;
<dt><code>find(<em>id</em>)</code>, <code>findOrFail(<em>id</em>)</code></dt>&#13;
<dd>&#13;
<p>Like <code>first()</code>, but you pass in an ID value that corresponds to the primary key to look up. <code>find()</code> fails silently if a row with that ID doesn’t exist, while <span class="keep-together"><code>findOrFail()</code></span> throws an exception:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contactFive</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">find</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>value()</code></dt>&#13;
<dd>&#13;
<p>Plucks just the value from a single field from the first row. Like <code>first()</code>, but if you only want a single column:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$newestContactEmail</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">orderBy</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'desc'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">value</code><code class="p">(</code><code class="s1">'email'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>count()</code></dt>&#13;
<dd>&#13;
<p>Returns an integer count of all of the matching results:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$countVips</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">count</code><code class="p">();</code></pre>&#13;
</dd>&#13;
</dl>&#13;
<dl class="pagebreak-before">&#13;
<dt><code>min()</code>, <code>max()</code></dt>&#13;
<dd>&#13;
<p>Returns the minimum or maximum value of a particular column:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$highestCost</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'orders'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">max</code><code class="p">(</code><code class="s1">'amount'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>sum()</code>, <code>avg()</code></dt>&#13;
<dd>&#13;
<p>Returns the sum or average of all of the values in a particular column:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$averageCost</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'orders'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="s1">'completed'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">avg</code><code class="p">(</code><code class="s1">'amount'</code><code class="p">);</code></pre>&#13;
</dd>&#13;
<dt><code>dd()</code>, <code>dump()</code></dt>&#13;
<dd>&#13;
<p>Dumps the underlying SQL query and the bindings, and, if using <code>dd()</code>, ends the script.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Wilbur Powery'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">dd</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// "select * from `users` where `name` = ?"</code>&#13;
<code class="c1">// array:1 [ 0 =&gt; "Wilbur Powery"]</code></pre>&#13;
</dd>&#13;
</dl>&#13;
<div data-type="note" epub:type="note"><h1>Explain Method</h1>&#13;
<p>The<a data-primary="explain() method" data-type="indexterm" id="id1031"/> <code>explain()</code> method returns an explanation of how SQL will execute the query. You can use it alongside the <code>dd()</code> or <code>dump()</code> methods to debug your query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">User</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Wilbur Powery'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">explain</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">dd</code><code class="p">();</code>&#13;
&#13;
<code class="cm">/*</code>&#13;
<code class="cm">array:1 [</code>&#13;
<code class="cm">    0 =&gt; {#5111</code>&#13;
<code class="cm">        +"id": 1</code>&#13;
<code class="cm">        +"select_type": "SIMPLE"</code>&#13;
<code class="cm">        +"table": "users"</code>&#13;
<code class="cm">        +"type": "ALL"</code>&#13;
<code class="cm">        +"possible_keys": null</code>&#13;
<code class="cm">        +"key": null</code>&#13;
<code class="cm">        +"key_len": null</code>&#13;
<code class="cm">        +"ref": null</code>&#13;
<code class="cm">        +"rows": "209"</code>&#13;
<code class="cm">        +"Extra": "Using where"</code>&#13;
<code class="cm">      }</code>&#13;
<code class="cm">]</code>&#13;
<code class="cm">*/</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Writing raw queries inside query builder methods with DB::raw" data-type="sect3"><div class="sect3" id="id85">&#13;
<h3>Writing raw queries inside query builder methods with DB::raw</h3>&#13;
&#13;
<p>You’ve<a data-primary="query builder" data-secondary="chaining with" data-tertiary="writing raw queries with DB::raw" data-type="indexterm" id="id1032"/><a data-primary="DB::raw" data-type="indexterm" id="id1033"/><a data-primary="raw SQL" data-type="indexterm" id="id1034"/><a data-primary="structured query language (SQL)" data-type="indexterm" id="id1035"/><a data-primary="SQL (structured query language)" data-type="indexterm" id="id1036"/> already seen a few custom methods for raw statements—for example, <code>select()</code> has a <code>selectRaw()</code> counterpart that allows you to pass in a string for the query builder to place after the <code>WHERE</code> statement.</p>&#13;
&#13;
<p>You can also, however, pass in the result of a <code>DB::raw()</code> call to almost any method in the query builder to achieve the same result:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="nx">DB</code><code class="o">::</code><code class="na">raw</code><code class="p">(</code><code class="s1">'*, (score * 100) AS integer_score'</code><code class="p">))</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Joins" data-type="sect3"><div class="sect3" id="id86">&#13;
<h3>Joins</h3>&#13;
&#13;
<p>Joins<a data-primary="query builder" data-secondary="chaining with" data-tertiary="joins" data-type="indexterm" id="id1037"/><a data-primary="joins (query builder)" data-type="indexterm" id="id1038"/> can sometimes be a pain to define, and there’s only so much a framework can do to make them simpler, but the query builder does its best. Let’s look at a sample:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$users</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">join</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="s1">'users.id'</code><code class="p">,</code> <code class="s1">'='</code><code class="p">,</code> <code class="s1">'contacts.user_id'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">select</code><code class="p">(</code><code class="s1">'users.*'</code><code class="p">,</code> <code class="s1">'contacts.name'</code><code class="p">,</code> <code class="s1">'contacts.status'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>The <code>join()</code> method creates an inner join. You can also chain together multiple joins one after another, or use <code>leftJoin()</code> to get a left join.</p>&#13;
&#13;
<p>Finally, you can create more complex joins by passing a closure into the <code>join()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">join</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$join</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$join</code>&#13;
            <code class="o">-&gt;</code><code class="na">on</code><code class="p">(</code><code class="s1">'users.id'</code><code class="p">,</code> <code class="s1">'='</code><code class="p">,</code> <code class="s1">'contacts.user_id'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">orOn</code><code class="p">(</code><code class="s1">'users.id'</code><code class="p">,</code> <code class="s1">'='</code><code class="p">,</code> <code class="s1">'contacts.proxy_user_id'</code><code class="p">);</code>&#13;
    <code class="p">})</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Unions" data-type="sect3"><div class="sect3" id="id87">&#13;
<h3>Unions</h3>&#13;
&#13;
<p>You<a data-primary="query builder" data-secondary="chaining with" data-tertiary="unions" data-type="indexterm" id="id1039"/><a data-primary="unions (query builder)" data-type="indexterm" id="id1040"/> can union two queries (join their results together into one result set) by creating them first and then using the <code>union()</code> or <code>unionAll()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$first</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">whereNull</code><code class="p">(</code><code class="s1">'first_name'</code><code class="p">);</code>&#13;
&#13;
<code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">whereNull</code><code class="p">(</code><code class="s1">'last_name'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">union</code><code class="p">(</code><code class="nv">$first</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inserts" data-type="sect3"><div class="sect3" id="id88">&#13;
<h3>Inserts</h3>&#13;
&#13;
<p>The<a data-primary="query builder" data-secondary="chaining with" data-tertiary="inserts" data-type="indexterm" id="id1041"/><a data-primary="inserts (query builder)" data-type="indexterm" id="id1042"/> <code>insert()</code> method is pretty simple. Pass it as an array to insert a single row or as an array of arrays to insert multiple rows, and use <code>insertGetId()</code> instead of <code>insert()</code> to get the autoincrementing primary key ID back as a return:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$id</code> <code class="o">=</code> <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">insertGetId</code><code class="p">([</code>&#13;
    <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Abe Thomas'</code><code class="p">,</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'athomas1987@gmail.com'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">insert</code><code class="p">([</code>&#13;
    <code class="p">[</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Tamika Johnson'</code><code class="p">,</code> <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'tamikaj@gmail.com'</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Jim Patterson'</code><code class="p">,</code> <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'james.patterson@hotmail.com'</code><code class="p">],</code>&#13;
<code class="p">]);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Updates" data-type="sect3"><div class="sect3" id="id89">&#13;
<h3>Updates</h3>&#13;
&#13;
<p>Updates<a data-primary="query builder" data-secondary="chaining with" data-tertiary="updates" data-type="indexterm" id="id1043"/><a data-primary="updates (query builder)" data-type="indexterm" id="id1044"/> are also simple. Create your update query and, instead of <code>get()</code> or <code>first()</code>, just use <code>update()</code> and pass it an array of parameters:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'points'</code><code class="p">,</code> <code class="s1">'&gt;'</code><code class="p">,</code> <code class="mi">100</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'vip'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>You can also quickly increment and decrement columns using the <code>increment()</code> and <code>decrement()</code> methods. The first parameter of each is the column name, and the second (optional) parameter is the number to increment/decrement by:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">increment</code><code class="p">(</code><code class="s1">'tokens'</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">decrement</code><code class="p">(</code><code class="s1">'tokens'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deletes" data-type="sect3"><div class="sect3" id="id90">&#13;
<h3>Deletes</h3>&#13;
&#13;
<p>Deletes<a data-primary="query builder" data-secondary="chaining with" data-tertiary="deletes" data-type="indexterm" id="id1045"/><a data-primary="deletes (query builder)" data-type="indexterm" id="id1046"/> are even simpler. Build your query and then end it with <code>delete()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'last_login'</code><code class="p">,</code> <code class="s1">'&lt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subYear</code><code class="p">())</code>&#13;
    <code class="o">-&gt;</code><code class="na">delete</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also truncate the table, which deletes every row and also resets the autoincrementing ID:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">truncate</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON operations" data-type="sect3"><div class="sect3" id="id91">&#13;
<h3>JSON operations</h3>&#13;
&#13;
<p>If<a data-primary="query builder" data-secondary="chaining with" data-tertiary="JSON operations" data-type="indexterm" id="id1047"/><a data-primary="JSON operations" data-secondary="query builder" data-type="indexterm" id="id1048"/> you have JSON columns, you can update or select rows based on aspects of the JSON structure by using the arrow syntax to<a data-primary="" data-startref="QBchain05" data-type="indexterm" id="id1049"/> traverse children:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Select all records where the "isAdmin" property of the "options"</code>&#13;
<code class="c1">// JSON column is set to true</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'options-&gt;isAdmin'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Update all records, setting the "verified" property</code>&#13;
<code class="c1">// of the "options" JSON column to true</code>&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'options-&gt;isVerified'</code><code class="p">,</code> <code class="k">true</code><code class="p">]);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Transactions" data-type="sect2"><div class="sect2" id="id92">&#13;
<h2>Transactions</h2>&#13;
&#13;
<p><em>Database transactions</em> are<a data-primary="query builder" data-secondary="transactions" data-type="indexterm" id="id1050"/><a data-primary="transactions (database)" data-type="indexterm" id="id1051"/><a data-primary="databases" data-secondary="database transactions" data-type="indexterm" id="id1052"/><a data-primary="databases" data-secondary="query builder" data-tertiary="transactions" data-type="indexterm" id="id1053"/> tools that enable you to wrap up a series of database queries to be performed in a batch, which you can choose to roll back, undoing the entire series of queries. Transactions are often used to ensure that <em>all</em> or <em>none</em>, but not <em>some</em>, of a series of related queries are performed—if one fails, the ORM will roll back the entire series of queries.</p>&#13;
&#13;
<p>With the Laravel query builder’s transaction feature, if any exceptions are thrown at any point within the transaction closure, all the queries in the transaction will be rolled back. If the transaction closure finishes successfully, all the queries will be committed and not rolled back.</p>&#13;
&#13;
<p>Let’s take a look at the sample transaction in <a data-type="xref" href="#EX807">Example 5-17</a>.</p>&#13;
<div data-type="example" id="EX807">&#13;
<h5><span class="label">Example 5-17. </span>A simple database transaction</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">transaction</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$userId</code><code class="p">,</code> <code class="nv">$numVotes</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Possibly failing DB query</code>&#13;
    <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'users'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'id'</code><code class="p">,</code> <code class="nv">$userId</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'votes'</code> <code class="o">=&gt;</code> <code class="nv">$numVotes</code><code class="p">]);</code>&#13;
&#13;
    <code class="c1">// Caching query that we don't want to run if the above query fails</code>&#13;
    <code class="nx">DB</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'votes'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'user_id'</code><code class="p">,</code> <code class="nv">$userId</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">delete</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>In this example, we can assume we had some previous process that summarized the number of votes from the <code>votes</code> table for a given user. We want to cache that number in the <code>users</code> table and then wipe those votes from the <code>votes</code> table. But, of course, we don’t want to wipe the votes <em>until</em> the update to the <code>users</code> table has run successfully. And we don’t want to keep the updated number of votes in the <code>users</code> table if the <code>votes</code> table deletion fails.</p>&#13;
&#13;
<p>If anything goes wrong with either query, the other won’t be applied. That’s the magic of database transactions.</p>&#13;
&#13;
<p>Note that you can also manually begin and end transactions—and this applies for both query builder queries and Eloquent queries. Start with <code>DB::beginTransaction()</code>, end with <code>DB::commit()</code>, and abort<a data-primary="" data-startref="DBquerybuild05" data-type="indexterm" id="id1054"/> with <code>DB::rollBack()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">DB</code><code class="o">::</code><code class="na">beginTransaction</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Take database actions</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$badThingsHappened</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nx">DB</code><code class="o">::</code><code class="na">rollBack</code><code class="p">();</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Take other database actions</code>&#13;
&#13;
<code class="nx">DB</code><code class="o">::</code><code class="na">commit</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introduction to Eloquent" data-type="sect1"><div class="sect1" id="eloquent">&#13;
<h1>Introduction to Eloquent</h1>&#13;
&#13;
<p>Now<a data-primary="Eloquent" data-secondary="basics of" data-type="indexterm" id="id1055"/> that we’ve covered the query builder, let’s talk about Eloquent, Laravel’s flagship database tool that’s built on the query builder.</p>&#13;
&#13;
<p>Eloquent is an <em>ActiveRecord ORM</em>, which means it’s a database abstraction layer that provides a single interface to interact with multiple database types. “ActiveRecord” means that a single Eloquent class is responsible for not only providing the ability to interact with the table as a whole (e.g., <code>User::all()</code> gets all users), but also representing an individual table row (e.g., <code>$sharon = new User</code>). Additionally, each instance is capable of managing its own persistence; you can call <code>$sharon-&gt;save()</code> or <code>$sharon</code><code class="keep-together">-&gt;</code><code>delete()</code>.</p>&#13;
&#13;
<p>Eloquent has a primary focus on simplicity, and like the rest of the framework, it relies on “convention over configuration” to allow you to build powerful models with minimal code.</p>&#13;
&#13;
<p>For example, you can perform all of the operations in <a data-type="xref" href="#EX809">Example 5-19</a> with the model defined in <a data-type="xref" href="#EX808">Example 5-18</a>.</p>&#13;
<div data-type="example" id="EX808">&#13;
<h5><span class="label">Example 5-18. </span>The simplest Eloquent model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code> <code class="p">{}</code></pre></div>&#13;
<div data-type="example" id="EX809">&#13;
<h5><span class="label">Example 5-19. </span>Operations achievable with the simplest Eloquent model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// In a controller</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">save</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Create and save a new contact from user input</code>&#13;
    <code class="nv">$contact</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Contact</code><code class="p">();</code>&#13;
    <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">first_name</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'first_name'</code><code class="p">);</code>&#13;
    <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">last_name</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'last_name'</code><code class="p">);</code>&#13;
    <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">email</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'email'</code><code class="p">);</code>&#13;
    <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nv">$contactId</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Return a JSON representation of a contact based on a URL segment;</code>&#13;
    <code class="c1">// if the contact doesn't exist, throw an exception</code>&#13;
    <code class="k">return</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$contactId</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">vips</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// Unnecessarily complex example, but still possible with basic Eloquent</code>&#13;
    <code class="c1">// class; adds a "formalName" property to every VIP entry</code>&#13;
    <code class="k">return</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">map</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">formalName</code> <code class="o">=</code> <code class="s2">"The exalted </code><code class="si">{</code><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">first_name</code><code class="si">}</code><code class="s2"> of the</code>&#13;
<code class="s2">         </code><code class="si">{</code><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">last_name</code><code class="si">}</code><code class="s2">s"</code><code class="p">;</code>&#13;
&#13;
        <code class="k">return</code> <code class="nv">$contact</code><code class="p">;</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>How? Convention. Eloquent assumes the table name (<code>Contact</code> becomes <code>contacts</code>), and with that, you have a fully functional Eloquent model.</p>&#13;
&#13;
<p>Let’s cover how we work with Eloquent models.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating and Defining Eloquent Models" data-type="sect2"><div class="sect2" id="id93">&#13;
<h2>Creating and Defining Eloquent Models</h2>&#13;
&#13;
<p>First, let’s<a data-primary="Eloquent" data-secondary="creating and defining models" data-type="indexterm" id="id1056"/> create a model. There’s an Artisan command for that:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:model<code class="w"> </code>Contact<code class="w"/></pre>&#13;
&#13;
<p>This is what we’ll get, in <em>app/Models/Contact.php</em>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Models</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">//</code>&#13;
<code class="p">}</code></pre>&#13;
<div data-type="tip"><h1>Creating a Migration Along with Your Model</h1>&#13;
<p>If<a data-primary="databases" data-secondary="migrating" data-tertiary="along with model creation" data-type="indexterm" id="id1057"/> you want to automatically create a migration when you create your model, pass<a data-primary="--migration flag" data-type="indexterm" id="id1058"/> the <code>-m</code> or <code>--migration</code> flag:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">php</code> <code class="nx">artisan</code> <code class="nx">make</code><code class="o">:</code><code class="nx">model</code> <code class="nx">Contact</code> <code class="o">--</code><code class="nx">migration</code></pre>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Table name" data-type="sect3"><div class="sect3" id="id411">&#13;
<h3>Table name</h3>&#13;
&#13;
<p>The<a data-primary="names and naming" data-secondary="tables" data-type="indexterm" id="id1059"/> default behavior for table names is that Laravel “snake cases” and pluralizes your class name, so <code>SecondaryContact</code> would access a table named <code>secondary_contacts</code>. If you’d like to customize the name, set the <code>$table</code> property explicitly on the model:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">protected</code> <code class="nv">$table</code> <code class="o">=</code> <code class="s1">'contacts_secondary'</code><code class="p">;</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Primary key" data-type="sect3"><div class="sect3" id="id94">&#13;
<h3>Primary key</h3>&#13;
&#13;
<p>Laravel<a data-primary="primary keys" data-type="indexterm" id="id1060"/> assumes, by default, that each table will have an autoincrementing integer primary key, and it will be named <code>id</code>.</p>&#13;
&#13;
<p>If you want to change the name of your primary key, change the <code>$primaryKey</code> &#13;
<span class="keep-together">property</span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">protected</code> <code class="nv">$primaryKey</code> <code class="o">=</code> <code class="s1">'contact_id'</code><code class="p">;</code></pre>&#13;
&#13;
<p>And if you want to set it to be nonincrementing, use:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">public</code> <code class="nv">$incrementing</code> <code class="o">=</code> <code class="k">false</code><code class="p">;</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1061">&#13;
<h1>Printing a Summary of an Eloquent Model</h1>&#13;
<p>As<a data-primary="Eloquent" data-secondary="model summaries" data-type="indexterm" id="id1062"/> your project grows, it may become a bit challenging to keep track of each model’s definition, attributes, and relations. The <code>model:show</code> command can help with this by giving you a summary of your model, printing database and table names. It also lists attributes along with SQL column modifiers, type, and size; lists mutators along with the attributes; lists all model relations; and lists model observers.</p>&#13;
</div></aside>&#13;
<section data-pdf-bookmark="Timestamps" data-type="sect3"><div class="sect3" id="timestamps-YKsKUASNUo">&#13;
<h3>Timestamps</h3>&#13;
&#13;
<p>Eloquent expects every table to have <code>created_at</code> and <code>updated_at</code> timestamp columns. If your table won’t have them, disable the <code>$timestamps</code> functionality:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">public</code> <code class="nv">$timestamps</code> <code class="o">=</code> <code class="k">false</code><code class="p">;</code></pre>&#13;
&#13;
<p>You can customize the format Eloquent uses to store your timestamps to the database by setting the <code>$dateFormat</code> class property to a custom string. The string will be parsed using PHP’s <code>date()</code> syntax, so the following example will store the date as seconds since the Unix epoch:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">protected</code> <code class="nv">$dateFormat</code> <code class="o">=</code> <code class="s1">'U'</code><code class="p">;</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Retrieving Data with Eloquent" data-type="sect2"><div class="sect2" id="id412">&#13;
<h2>Retrieving Data with Eloquent</h2>&#13;
&#13;
<p>Most<a data-primary="Eloquent" data-secondary="retrieving data" data-type="indexterm" id="Eretdata05"/><a data-primary="data" data-secondary="retrieving with Eloquent" data-type="indexterm" id="Dretriev05"/> of the time when you pull data from your database with Eloquent, you’ll use static calls on your Eloquent model.</p>&#13;
&#13;
<p>Let’s start by getting everything:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$allContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code></pre>&#13;
&#13;
<p>That was easy. Let’s filter it a bit:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$vipContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>We can see that the <code>Eloquent</code> facade gives us the ability to chain constraints, and from there the constraints get very familiar:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$newestContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">orderBy</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'desc'</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">take</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>&#13;
    <code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>It turns out that once you move past the initial facade name, you’re just working <span class="keep-together">with Laravel’s</span> query builder. You can do a lot more—we’ll cover that soon—but everything you can do with the query builder on the <code>DB</code> facade, you also can do on your Eloquent objects.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get one" data-type="sect3"><div class="sect3" id="id660">&#13;
<h3>Get one</h3>&#13;
&#13;
<p>Like we covered earlier in the chapter, you can use <code>first()</code> to return only the first record from a query, or use <code>find()</code> to pull just the record with the provided ID. For either, if you append “OrFail” to the method name, it will throw an exception if there are no matching results. This makes <code>findOrFail()</code> a common tool for looking up an entity by a URL segment (or throwing an exception if a matching entity doesn’t exist), like you can see in <a data-type="xref" href="#EX810">Example 5-20</a>.</p>&#13;
<div data-type="example" id="EX810">&#13;
<h5><span class="label">Example 5-20. </span>Using an Eloquent <code>OrFail()</code> method in a controller method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// ContactController</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nv">$contactId</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'contacts.show'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'contact'</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$contactId</code><code class="p">));</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Any method intended to return a single record (<code>first()</code>, <code>firstOrFail()</code>, <code>find()</code>, or <code>findOrFail()</code>) will return an instance of the Eloquent class. So, <code>Contact::first()</code> will return an instance of the class <code>Contact</code> with the data from the first row in the table filling it out.</p>&#13;
&#13;
<p>You can also use the <code>firstWhere()</code> method, which is a shortcut combining <code>where()</code> and <code>first()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// With where() and first()</code>&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Wilbur Powery'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// With firstWhere()</code>&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">firstWhere</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'Wilbur Powery'</code><code class="p">);</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Exceptions</h1>&#13;
<p>As you can see in <a data-type="xref" href="#EX810">Example 5-20</a>, we don’t need to catch Eloquent’s model not found exception (<code>Illuminate\Database\Eloquent</code><span class="keep-together"><code>\ModelNotFoundException)</code></span> in our controllers; Laravel’s routing system will catch it and throw a 404 for us.</p>&#13;
&#13;
<p>You could, of course, catch that particular exception and handle it, if you’d like.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Get many" data-type="sect3"><div class="sect3" id="id661">&#13;
<h3>Get many</h3>&#13;
&#13;
<p><code>get()</code> works with Eloquent just like it does in normal query builder calls—build a query and call <code>get()</code> at the end to get the results:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$vipContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>However, there is an Eloquent-only method, <code>all()</code>, which you’ll often see people use when they want to get an unfiltered list of all data in the table:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code></pre>&#13;
<div data-type="tip"><h1>Using get() Instead of all()</h1>&#13;
<p>Any time you can use <code>all()</code>, you could use <code>get()</code>. <code>Contact::get()</code> has the same response as <code>Contact::all()</code>. However, the moment you start modifying your query—​adding a <code>where()</code> filter, for example—<code>all()</code> will no longer work, but <code>get()</code> will continue working.</p>&#13;
&#13;
<p>So, even though <code>all()</code> is very common, I’d recommend using <code>get()</code> for everything and ignoring the fact that <code>all()</code> even exists.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Chunking responses with chunk()" data-type="sect3"><div class="sect3" id="id662">&#13;
<h3>Chunking responses with chunk()</h3>&#13;
&#13;
<p>If you’ve ever needed to process a large amount (thousands or more) of records at a time, you may have run into memory or locking issues. Laravel makes it possible to break your requests into smaller pieces (chunks) and process them in batches, keeping the memory load of your large request smaller. <a data-type="xref" href="#EX811">Example 5-21</a> illustrates the use of <code>chunk()</code> to split a query into “chunks” of 100 records each.</p>&#13;
<div data-type="example" id="EX811">&#13;
<h5><span class="label">Example 5-21. </span>Chunking an Eloquent query to limit memory usage</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">chunk</code><code class="p">(</code><code class="mi">100</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$contacts</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">foreach</code> <code class="p">(</code><code class="nv">$contacts</code> <code class="k">as</code> <code class="nv">$contact</code><code class="p">)</code>  <code class="p">{</code>&#13;
        <code class="c1">// Do something with $contact</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Aggregates" data-type="sect3"><div class="sect3" id="id95">&#13;
<h3>Aggregates</h3>&#13;
&#13;
<p>The aggregates that are available on the query builder are available on Eloquent queries as well.<a data-primary="" data-startref="Dretriev05" data-type="indexterm" id="id1063"/><a data-primary="" data-startref="Eretdata05" data-type="indexterm" id="id1064"/> For example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$countVips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">count</code><code class="p">();</code>&#13;
<code class="nv">$sumVotes</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">sum</code><code class="p">(</code><code class="s1">'votes'</code><code class="p">);</code>&#13;
<code class="nv">$averageSkill</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">avg</code><code class="p">(</code><code class="s1">'skill_level'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inserts and Updates with Eloquent" data-type="sect2"><div class="sect2" id="id413">&#13;
<h2>Inserts and Updates with Eloquent</h2>&#13;
&#13;
<p>Inserting<a data-primary="Eloquent" data-secondary="inserting and updating values" data-type="indexterm" id="EQinsert05"/> and updating values is one of the places where Eloquent starts to diverge from normal query builder syntax.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Inserts" data-type="sect3"><div class="sect3" id="id96">&#13;
<h3>Inserts</h3>&#13;
&#13;
<p>There<a data-primary="inserting database values" data-type="indexterm" id="id1065"/> are two primary ways to insert a new record using Eloquent.</p>&#13;
&#13;
<p>First, you can create a new instance of your Eloquent class, set your properties manually, and call <code>save()</code> on that instance, like in <a data-type="xref" href="#EX812">Example 5-22</a>.</p>&#13;
<div data-type="example" id="EX812">&#13;
<h5><span class="label">Example 5-22. </span>Inserting an Eloquent record by creating a new instance</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Contact</code><code class="p">;</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">name</code> <code class="o">=</code> <code class="s1">'Ken Hirata'</code><code class="p">;</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">email</code> <code class="o">=</code> <code class="s1">'ken@hirata.com'</code><code class="p">;</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Contact</code><code class="p">([</code>&#13;
    <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Ken Hirata'</code><code class="p">,</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'ken@hirata.com'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">make</code><code class="p">([</code>&#13;
    <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Ken Hirata'</code><code class="p">,</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'ken@hirata.com'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Until you <code>save()</code>, this instance of <code>Contact</code> represents the contact fully—​except it has never been saved to the database. That means it doesn’t have an <code>id</code>, it won’t persist if the application quits, and it doesn’t have its <code>created_at</code> and <code>updated_at</code> values set.</p>&#13;
&#13;
<p>You can also pass an array to <code>Model::create()</code>, as shown in <a data-type="xref" href="#EX813">Example 5-23</a>. Unlike <code>make()</code>, <code>create()</code> saves the instance to the database as soon as it’s called.</p>&#13;
<div data-type="example" id="EX813">&#13;
<h5><span class="label">Example 5-23. </span>Inserting an Eloquent record by passing an array to <code>create()</code></h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">create</code><code class="p">([</code>&#13;
    <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Keahi Hale'</code><code class="p">,</code>&#13;
    <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'halek481@yahoo.com'</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre></div>&#13;
&#13;
<p>Also be aware that in any context where you are passing an array (to <code>new Model()</code>, <code>Model::make()</code>, <code>Model::create()</code>, or <code>Model::update()</code>), every property you set via <code>Model::create()</code> has to be approved for “mass assignment,” which we’ll cover shortly. This is not necessary with the first example in <a data-type="xref" href="#EX812">Example 5-22</a>, where you assign each property individually.</p>&#13;
&#13;
<p>Note that if you’re using <code>Model::create()</code>, you don’t need to <code>save()</code> the instance—​that’s handled as a part of the model’s <code>create()</code> method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Updates" data-type="sect3"><div class="sect3" id="id97">&#13;
<h3>Updates</h3>&#13;
&#13;
<p>Updating records<a data-primary="updating database values" data-type="indexterm" id="id1066"/> looks very similar to inserting. You can get a specific instance, change its properties, and then save, or you can make a single call and pass an array of updated properties. <a data-type="xref" href="#EX814">Example 5-24</a> illustrates the first approach.</p>&#13;
<div data-type="example" id="EX814">&#13;
<h5><span class="label">Example 5-24. </span>Updating an Eloquent record by updating an instance and saving</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">email</code> <code class="o">=</code> <code class="s1">'natalie@parkfamily.com'</code><code class="p">;</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code></pre></div>&#13;
&#13;
<p>Since this record already exists, it will already have a <code>created_at</code> timestamp and an <code>id</code>, which will stay the same, but the <code>updated_at</code> field will be changed to the current date and time. <a data-type="xref" href="#EX815">Example 5-25</a> illustrates the second approach.</p>&#13;
<div data-type="example" id="EX815">&#13;
<h5><span class="label">Example 5-25. </span>Updating one or more Eloquent records by passing an array to the <code>update()</code> method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'&lt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subYear</code><code class="p">())</code>&#13;
    <code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'longevity'</code> <code class="o">=&gt;</code> <code class="s1">'ancient'</code><code class="p">]);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'longevity'</code> <code class="o">=&gt;</code> <code class="s1">'ancient'</code><code class="p">]);</code></pre></div>&#13;
&#13;
<p>This method expects an array where each key is the column name and each value is the column value.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mass assignment" data-type="sect3"><div class="sect3" id="mass_assignment">&#13;
<h3>Mass assignment</h3>&#13;
&#13;
<p>We’ve<a data-primary="mass assignment" data-type="indexterm" id="id1067"/><a data-primary="Eloquent" data-secondary="mass assignment concept" data-type="indexterm" id="id1068"/> looked at a few examples of how to pass arrays of values into Eloquent class methods. However, none of these will actually work until you define which fields are “fillable” on the model.</p>&#13;
&#13;
<p>The goal of this is to protect you from (possibly malicious) user input accidentally setting new values on fields you don’t want changed. Consider the common scenario in <a data-type="xref" href="#EX816">Example 5-26</a>.</p>&#13;
<div data-type="example" id="EX816">&#13;
<h5><span class="label">Example 5-26. </span>Updating an Eloquent model using the entirety of a request’s input</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// ContactController</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">update</code><code class="p">(</code><code class="nx">Contact</code> <code class="nv">$contact</code><code class="p">,</code> <code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>The Illuminate <code>Request</code> object in <a data-type="xref" href="#EX816">Example 5-26</a> will take every piece of user input and pass it to the <code>update()</code> method. That <code>all()</code> method includes things like URL parameters and form inputs, so a malicious user could easily add some things in there, like <code>id</code> and <code>owner_id</code>, that you likely don’t want updated.</p>&#13;
&#13;
<p>Thankfully, that won’t actually work until you define your model’s fillable fields. You can either define the allowed “fillable fields or the disallowed <em>guarded</em> fields to determine which fields” can or cannot be edited via mass <em>assignment</em>—that is, by passing an array of values into either <code>create()</code> or <code>update()</code>. Note that nonfillable properties can still be changed by direct assignment (e.g., <code>$contact-&gt;password = '<em>abc</em>';</code>). <a data-type="xref" href="#EX817">Example 5-27</a> shows both approaches.</p>&#13;
<div data-type="example" id="EX817">&#13;
<h5><span class="label">Example 5-27. </span>Using Eloquent’s fillable or guarded properties to define mass-assignable fields</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$fillable</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'email'</code><code class="p">];</code>&#13;
&#13;
    <code class="c1">// or</code>&#13;
&#13;
    <code class="k">protected</code> <code class="nv">$guarded</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'id'</code><code class="p">,</code> <code class="s1">'created_at'</code><code class="p">,</code> <code class="s1">'updated_at'</code><code class="p">,</code> <code class="s1">'owner_id'</code><code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="tip"><h1>Using Request::only() with Eloquent Mass Assignment</h1>&#13;
<p>In <a data-type="xref" href="#EX816">Example 5-26</a>, we needed<a data-primary="request::only()" data-type="indexterm" id="id1069"/> Eloquent’s mass-assignment guard because we were using the <code>all()</code> method on the <code>Request</code> object to pass in the <em>entirety</em> of the user input.</p>&#13;
&#13;
<p>Eloquent’s mass-assignment protection is a great tool here, but there’s also a helpful trick to keep you from accepting any old input from the user.</p>&#13;
&#13;
<p>The <code>Request</code> class has an <code>only()</code> method that allows you to pluck only a few keys from the user input. So now you can do this:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">only</code><code class="p">(</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'email'</code><code class="p">));</code></pre>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="firstOrCreate() and firstOrNew()" data-type="sect3"><div class="sect3" id="id99">&#13;
<h3>firstOrCreate() and firstOrNew()</h3>&#13;
&#13;
<p>Sometimes<a data-primary="firstOrCreate() method" data-type="indexterm" id="id1070"/><a data-primary="firstOrNew() method" data-type="indexterm" id="id1071"/> you want to tell your application, “Get me an instance with these properties, or if it doesn’t exist, create it.” This is where the <code>firstOr*()</code> methods come in.</p>&#13;
&#13;
<p>The <code>firstOrCreate()</code> and <code>firstOrNew()</code> methods take an array of keys and values as their first parameter:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">firstOrCreate</code><code class="p">([</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'luis.ramos@myacme.com'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>They’ll both look for and retrieve the first record matching those parameters, and if there are no matching records, they’ll create an instance with those properties; <span class="keep-together"><code>firstOrCreate()</code></span> will persist that instance to the database and then return it, while <code>firstOrNew()</code> will return it without saving it.</p>&#13;
&#13;
<p>If you pass an array of values as the second parameter, those values will be added to the created entry (if it’s created) but <em>won’t</em> be used to look up whether the entry exists.<a data-primary="" data-startref="EQinsert05" data-type="indexterm" id="id1072"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Deleting with Eloquent" data-type="sect2"><div class="sect2" id="id100">&#13;
<h2>Deleting with Eloquent</h2>&#13;
&#13;
<p>Deleting<a data-primary="Eloquent" data-secondary="deleting items" data-type="indexterm" id="EQdelete05"/><a data-primary="deleting items (Eloquent)" data-type="indexterm" id="delEQ05"/> with Eloquent is very similar to updating with Eloquent, but with (optional) soft deletes, you can archive your deleted items for later inspection or even recovery.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Normal deletes" data-type="sect3"><div class="sect3" id="id663">&#13;
<h3>Normal deletes</h3>&#13;
&#13;
<p>The simplest way to delete a model record is to call the <code>delete()</code> method on the instance itself:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">5</code><code class="p">);</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">delete</code><code class="p">();</code></pre>&#13;
&#13;
<p>However, if you only have the ID, there’s no reason to look up an instance just to delete it; you can pass an ID or an array of IDs to the model’s <code>destroy()</code> method to delete them directly:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">destroy</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
<code class="c1">// or</code>&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">destroy</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">7</code><code class="p">]);</code></pre>&#13;
&#13;
<p>Finally, you can delete all of the results of a query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'updated_at'</code><code class="p">,</code> <code class="s1">'&lt;'</code><code class="p">,</code> <code class="nx">now</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">subYear</code><code class="p">())</code><code class="o">-&gt;</code><code class="na">delete</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Soft deletes" data-type="sect3"><div class="sect3" id="id101">&#13;
<h3>Soft deletes</h3>&#13;
&#13;
<p><em>Soft deletes</em> mark<a data-primary="soft deletes" data-type="indexterm" id="id1073"/> database rows as deleted without actually deleting them from the database. This gives you the ability to inspect them later, to have records that show more than “no information, deleted” when displaying historic information, and to allow your users (or admins) to restore some or all data.</p>&#13;
&#13;
<p>The hard part about handcoding an application with soft deletes is that <em>every query</em> you ever write will need to exclude the soft-deleted data. Thankfully, if you use Eloquent’s soft deletes, every query you ever make will be scoped to ignore soft deletes by default, unless you explicitly ask to bring them back.</p>&#13;
&#13;
<p>Eloquent’s soft delete functionality requires a <code>deleted_at</code> column to be added to the table. Once you enable soft deletes on that Eloquent model, every query you ever write (unless you explicitly include soft-deleted records) will be scoped to ignore soft-deleted rows.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1074">&#13;
<h1>When Should I Use Soft Deletes?</h1>&#13;
<p>Just because a feature exists, doesn’t mean you should always use it. Many folks in the Laravel community default to using soft deletes on every project just because the feature is there. There are real costs to soft deletes, though. It’s pretty likely that, if you view your database directly in a tool like Sequel Pro, you’ll forget to check the <code>deleted_at</code> column at least once. And if you don’t clean up old soft-deleted records, your databases will get larger and larger.</p>&#13;
&#13;
<p>Here’s my recommendation: don’t use soft deletes by default. Instead, use them when you need them, and when you do, clean out old soft deletes as aggressively as you can using a tool like <a href="https://oreil.ly/c8nVL">Quicksand</a>. The soft delete feature is a powerful tool, but not worth using unless you need it.</p>&#13;
</div></aside>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Enabling soft deletes" data-type="sect4"><div class="sect4" id="id664">&#13;
<h4>Enabling soft deletes</h4>&#13;
&#13;
<p>You enable soft deletes by doing two things: adding the <code>deleted_at</code> column in a migration and importing the <code>SoftDeletes</code> trait in the model. There’s a <code>softDeletes()</code> method available on the schema builder to add the <code>deleted_at</code> column to a table, as you can see in <a data-type="xref" href="#EX818">Example 5-28</a>. <a data-type="xref" href="#EX819">Example 5-29</a> shows an Eloquent model with soft deletes enabled.</p>&#13;
<div data-type="example" id="EX818">&#13;
<h5><span class="label">Example 5-28. </span>Migration to add the soft delete column to a table</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Schema</code><code class="o">::</code><code class="na">table</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">softDeletes</code><code class="p">();</code>&#13;
<code class="p">});</code></pre></div>&#13;
<div data-type="example" id="EX819">&#13;
<h5><span class="label">Example 5-29. </span>An Eloquent model with soft deletes enabled</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\SoftDeletes</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">use</code> <code class="nx">SoftDeletes</code><code class="p">;</code> <code class="c1">// use the trait</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Once you make these changes, every <code>delete()</code> and <code>destroy()</code> call will now set the <code>deleted_at</code> column on your row to be the current date and time instead of deleting that row. And all future queries will exclude that row as a result.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Querying with soft deletes" data-type="sect4"><div class="sect4" id="id665">&#13;
<h4>Querying with soft deletes</h4>&#13;
&#13;
<p>So, how do we get soft-deleted items?</p>&#13;
&#13;
<p>First, you can add soft-deleted items to a query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$allHistoricContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">withTrashed</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>Next, you can use the <code>trashed()</code> method to see if a particular instance has been soft-deleted:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">if</code> <code class="p">(</code><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">trashed</code><code class="p">())</code> <code class="p">{</code>&#13;
    <code class="c1">// do something</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>Finally, you can get <em>only</em> soft-deleted items:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$deletedContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">onlyTrashed</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Restoring soft-deleted entities" data-type="sect4"><div class="sect4" id="id666">&#13;
<h4>Restoring soft-deleted entities</h4>&#13;
&#13;
<p>If you want to restore a soft-deleted item, you can run <code>restore()</code> on an instance or a query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">restore</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">onlyTrashed</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">restore</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Force-deleting soft-deleted entities" data-type="sect4"><div class="sect4" id="id667">&#13;
<h4>Force-deleting soft-deleted entities</h4>&#13;
&#13;
<p>You can delete a soft-deleted entity by calling <code>forceDelete()</code> on an entity or query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">forceDelete</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">onlyTrashed</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">forceDelete</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Scopes" data-type="sect2"><div class="sect2" id="id102">&#13;
<h2>Scopes</h2>&#13;
&#13;
<p>We’ve<a data-primary="" data-startref="EQdelete05" data-type="indexterm" id="id1075"/><a data-primary="" data-startref="delEQ05" data-type="indexterm" id="id1076"/><a data-primary="Eloquent" data-secondary="scopes" data-type="indexterm" id="EQscopes05"/><a data-primary="scopes (filters)" data-secondary="purpose of" data-type="indexterm" id="id1077"/> covered “filtered” queries, meaning any query where we’re not just returning every result for a table. But every time we’ve written them so far in this chapter, it’s been a manual process using the query builder.</p>&#13;
&#13;
<p>Local and global scopes in Eloquent allow you to define prebuilt <em>scopes</em> (filters) that you can use either every time a model is queried (global) or every time you query it with a particular method chain (local).</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Local scopes" data-type="sect3"><div class="sect3" id="id103">&#13;
<h3>Local scopes</h3>&#13;
&#13;
<p>Local scopes<a data-primary="scopes (filters)" data-secondary="local scopes" data-type="indexterm" id="id1078"/><a data-primary="local scopes (Eloquent)" data-type="indexterm" id="id1079"/> are the simplest to understand. Let’s take this example:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$activeVips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'trial'</code><code class="p">,</code> <code class="k">false</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>First of all, if we write this combination of query methods over and over, it will get tedious. But additionally, the <em>knowledge</em> of how to define someone being an “active VIP” is now spread around our application. We want to centralize that knowledge. What if we could just write this?</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$activeVips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">activeVips</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>We can—it’s called a local scope. And it’s easy to define on the <code>Contact</code> class, as you can see in <a data-type="xref" href="#EX5d">Example 5-30</a>.</p>&#13;
<div data-type="example" id="EX5d">&#13;
<h5><span class="label">Example 5-30. </span>Defining a local scope on a model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">scopeActiveVips</code><code class="p">(</code><code class="nv">$query</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'vip'</code><code class="p">,</code> <code class="k">true</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'trial'</code><code class="p">,</code> <code class="k">false</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>To define a local scope, we add a method to the Eloquent class that begins with “scope” and then contains the Pascal case version of the scope name. This method is passed a query builder and needs to return a query builder, but of course you can modify the query before returning—​that’s the whole point.</p>&#13;
&#13;
<p>You can also define scopes that accept parameters, as shown in <a data-type="xref" href="#EX5e">Example 5-31</a>.</p>&#13;
<div data-type="example" id="EX5e">&#13;
<h5><span class="label">Example 5-31. </span>Passing parameters to scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">scopeStatus</code><code class="p">(</code><code class="nv">$query</code><code class="p">,</code> <code class="nv">$status</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="nv">$status</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>And you use them in the same way, just passing the parameter to the scope:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$friends</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">status</code><code class="p">(</code><code class="s1">'friend'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also chain <code>orWhere()</code> between two local scopes.</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$activeOrVips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">active</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">orWhere</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">vip</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Global scopes" data-type="sect3"><div class="sect3" id="id104">&#13;
<h3>Global scopes</h3>&#13;
&#13;
<p>Remember<a data-primary="scopes (filters)" data-secondary="global scopes" data-type="indexterm" id="id1080"/><a data-primary="global scopes (Eloquent)" data-type="indexterm" id="id1081"/> how we talked about soft deletes only working if you scope <em>every query</em> on the model to ignore the soft-deleted items? That’s a global scope. And we can define our own global scopes, which will be applied on every query made from a given model.</p>&#13;
&#13;
<p>There are two ways to define a global scope: using a closure or using an entire class. In each, you’ll register the defined scope in the model’s <code>booted()</code> method. Let’s start with the closure method, illustrated in <a data-type="xref" href="#EX820">Example 5-32</a>.</p>&#13;
<div data-type="example" id="EX820">&#13;
<h5><span class="label">Example 5-32. </span>Adding a global scope using a closure</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">static</code> <code class="k">function</code> <code class="nf">booted</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">static</code><code class="o">::</code><code class="na">addGlobalScope</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Builder</code> <code class="nv">$builder</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="nv">$builder</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>That’s it. We just added a global scope named <code>active</code>, and now every query on this model will be scoped to only rows with <code>active</code> set to <code>true</code>.</p>&#13;
&#13;
<p>Next, let’s try the longer way, as shown in <a data-type="xref" href="#EX21">Example 5-33</a>. Run the following command to create a class called ActiveScope.</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:scope<code class="w"> </code>ActiveScope<code class="w"/></pre>&#13;
&#13;
<p>It will have an <code>apply()</code> method that takes an instance of a query builder and an instance of the model.</p>&#13;
<div data-type="example" id="EX21">&#13;
<h5><span class="label">Example 5-33. </span>Creating a global scope class</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Models\Scopes</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Builder</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Scope</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">ActiveScope</code> <code class="k">implements</code> <code class="nx">Scope</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">apply</code><code class="p">(</code><code class="nx">Builder</code> <code class="nv">$builder</code><code class="p">,</code> <code class="nx">Model</code> <code class="nv">$model</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$builder</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'active'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>To apply this scope to a model, once again override the parent’s <code>booted()</code> method and call <code>addGlobalScope()</code> on the class using <code>static</code>, as shown in <a data-type="xref" href="#EX22">Example 5-34</a>.</p>&#13;
<div data-type="example" id="EX22">&#13;
<h5><span class="label">Example 5-34. </span>Applying a class-based global scope</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">App\Models\Scopes</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">static</code> <code class="k">function</code> <code class="nf">booted</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">static</code><code class="o">::</code><code class="na">addGlobalScope</code><code class="p">(</code><code class="k">new</code> <code class="nx">ActiveScope</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
<div data-type="note" epub:type="note"><h1>Contact with No Namespace</h1>&#13;
<p>You may have noticed that several of these examples have used the class <code>Contact</code>, with no namespace. This is abnormal, and I’ve only done this to save space in the book. Normally, even your top-level models would live at something like <code>App\Models\Contact</code>.</p>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section class="pagebreak-before less_space" data-pdf-bookmark="Removing global scopes" data-type="sect4"><div class="sect4" id="id105">&#13;
<h4>Removing global scopes</h4>&#13;
&#13;
<p>There are three ways to remove a global scope, and all three use either the <code>withoutGlobalScope()</code> or <code>withoutGlobalScopes()</code> method. If you’re removing a closure-based scope, the first parameter of that scope’s <code>addGlobalScope()</code> registration will be the key you used to enable it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$allContacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">withoutGlobalScope</code><code class="p">(</code><code class="s1">'active'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>If you’re removing a single class-based global scope, you can pass the class name to <code>withoutGlobalScope()</code> or <code>withoutGlobalScopes()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">withoutGlobalScope</code><code class="p">(</code><code class="nx">ActiveScope</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="nx">Contact</code><code class="o">::</code><code class="na">withoutGlobalScopes</code><code class="p">([</code><code class="nx">ActiveScope</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="nx">VipScope</code><code class="o">::</code><code class="na">class</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>Or, you can just disable all global scopes for a<a data-primary="" data-startref="EQscopes05" data-type="indexterm" id="id1082"/> query:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Contact</code><code class="o">::</code><code class="na">withoutGlobalScopes</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Customizing Field Interactions with Accessors, Mutators, and Attribute Casting" data-type="sect2"><div class="sect2" id="id414">&#13;
<h2>Customizing Field Interactions with Accessors, Mutators, and Attribute Casting</h2>&#13;
&#13;
<p>Now<a data-primary="Eloquent" data-secondary="customizing field interactions" data-type="indexterm" id="Efield05"/> that we’ve covered how to get records into and out of the database with Eloquent, let’s talk about decorating and manipulating the individual attributes on your Eloquent models.</p>&#13;
&#13;
<p>Accessors, mutators, and attribute casting all allow you to customize the way individual attributes of Eloquent instances are input or output. Without using any of these, each attribute of your Eloquent instance is treated like a string, and you can’t have any attributes on your models that don’t exist on the database. But we can change that.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Accessors" data-type="sect3"><div class="sect3" id="id106">&#13;
<h3>Accessors</h3>&#13;
&#13;
<p><em>Accessors</em> allow<a data-primary="accessors (Eloquent)" data-type="indexterm" id="id1083"/> you to define custom attributes on your Eloquent models for when you are <em>reading</em> data from the model instance. This may be because you want to change how a particular column is output, or because you want to create a custom attribute that doesn’t exist in the database table at all.</p>&#13;
&#13;
<p>You define an accessor by creating a method on your model with the name that is your property name, but camelCased. So, if your property name is <code>first_name</code>, the accessor method would be named <code>firstName</code>. Then, this method needs to have its return type show that it returns an instance of <code>Illuminate\Database\Eloquent\Casts\Attribute</code>.</p>&#13;
&#13;
<p>Let’s try it out. First, we’ll decorate a preexisting column (<a data-type="xref" href="#EX823">Example 5-35</a>).</p>&#13;
<div data-type="example" id="EX823">&#13;
<h5><span class="label">Example 5-35. </span>Decorating a preexisting column using Eloquent accessors</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Model definition:</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Casts\Attribute</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">function</code> <code class="nf">name</code><code class="p">()</code><code class="o">:</code> <code class="nx">Attribute</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Attribute</code><code class="o">::</code><code class="na">make</code><code class="p">(</code>&#13;
            <code class="nx">get</code><code class="o">:</code> <code class="nx">fn</code> <code class="p">(</code><code class="nx">string</code> <code class="nv">$value</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nv">$value</code> <code class="o">?:</code> <code class="s1">'(No name provided)'</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Accessor usage:</code>&#13;
<code class="nv">$name</code> <code class="o">=</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">;</code></pre></div>&#13;
&#13;
<p>But we can also use accessors to define attributes that never existed in the database, as seen in <a data-type="xref" href="#EX824">Example 5-36</a>.</p>&#13;
<div data-type="example" id="EX824">&#13;
<h5><span class="label">Example 5-36. </span>Defining an attribute with no backing column using Eloquent accessors</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Model definition:</code>&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">function</code> <code class="nf">fullName</code><code class="p">()</code><code class="o">:</code> <code class="nx">Attribute</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Attribute</code><code class="o">::</code><code class="na">make</code><code class="p">(</code>&#13;
            <code class="nx">get</code><code class="o">:</code> <code class="nx">fn</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">first_name</code> <code class="o">.</code> <code class="s1">' '</code> <code class="o">.</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">last_name</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Accessor usage:</code>&#13;
<code class="nv">$fullName</code> <code class="o">=</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">full_name</code><code class="p">;</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Mutators" data-type="sect3"><div class="sect3" id="id107">&#13;
<h3>Mutators</h3>&#13;
&#13;
<p><em>Mutators</em> work<a data-primary="mutators (Eloquent)" data-type="indexterm" id="id1084"/> the same way as accessors, except they’re for determining how to process <em>setting</em> the data instead of <em>getting</em> it. Just like with accessors, you can use them to modify the process of writing data to existing columns, or to allow for setting columns that don’t exist in the database.</p>&#13;
&#13;
<p>Mutators are defined the same way as accessors, but instead of the <code>get</code> parameter, we’ll be setting the <code>set</code> parameter.</p>&#13;
&#13;
<p>Let’s try it out. First, we’ll add a constraint to updating a preexisting column (<a data-type="xref" href="#EX825">Example 5-37</a>).</p>&#13;
<div data-type="example" id="EX825">&#13;
<h5><span class="label">Example 5-37. </span>Modifying setting the value of an attribute using Eloquent mutators</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Defining the mutator</code>&#13;
<code class="k">class</code> <code class="nc">Order</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">function</code> <code class="nf">amount</code><code class="p">()</code><code class="o">:</code> <code class="nx">Attribute</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Attribute</code><code class="o">::</code><code class="na">make</code><code class="p">(</code>&#13;
            <code class="nx">set</code><code class="o">:</code> <code class="nx">fn</code> <code class="p">(</code><code class="nx">string</code> <code class="nv">$value</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nv">$value</code> <code class="o">&gt;</code> <code class="mi">0</code> <code class="o">?</code> <code class="nv">$value</code> <code class="o">:</code> <code class="mi">0</code><code class="p">,</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Using the mutator</code>&#13;
<code class="nv">$order</code><code class="o">-&gt;</code><code class="na">amount</code> <code class="o">=</code> <code class="s1">'15'</code><code class="p">;</code></pre></div>&#13;
&#13;
<p>Now let’s add a proxy column for setting, as shown in <a data-type="xref" href="#EX826">Example 5-38</a>. If we’re setting values on more than one column at the same time, or if we’re customizing the name of the column we’re setting, we can return an array from the <code>set()</code> method.</p>&#13;
<div data-type="example" id="EX826">&#13;
<h5><span class="label">Example 5-38. </span>Allowing for setting the value of a nonexistent attribute using Eloquent mutators</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Defining the mutator</code>&#13;
<code class="k">class</code> <code class="nc">Order</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="k">function</code> <code class="nf">workgroupName</code><code class="p">()</code><code class="o">:</code> <code class="nx">Attribute</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Attribute</code><code class="o">::</code><code class="na">make</code><code class="p">(</code>&#13;
            <code class="nx">set</code><code class="o">:</code> <code class="nx">fn</code> <code class="p">(</code><code class="nx">string</code> <code class="nv">$value</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">[</code>&#13;
                <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$value</code><code class="si">}</code><code class="s2">@ourcompany.com"</code><code class="p">,</code>&#13;
            <code class="p">],</code>&#13;
        <code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="c1">// Using the mutator</code>&#13;
<code class="nv">$order</code><code class="o">-&gt;</code><code class="na">workgroup_name</code> <code class="o">=</code> <code class="s1">'jstott'</code><code class="p">;</code></pre></div>&#13;
&#13;
<p>As you can probably guess, it’s relatively uncommon to create a mutator for a nonexistent column, because it can be confusing to set one property and have it change a different column—​but it is possible.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Attribute casting" data-type="sect3"><div class="sect3" id="id415">&#13;
<h3>Attribute casting</h3>&#13;
&#13;
<p>You<a data-primary="attributes" data-secondary="attribute casting (Eloquent)" data-type="indexterm" id="attcast05"/> can probably imagine writing accessors to cast all of your integer-type fields as integers, encode and decode JSON to store in a <code>TEXT</code> column, or convert <code>TINYINT</code> <code>0</code> and <code>1</code> to and from Boolean values.</p>&#13;
&#13;
<p>Thankfully, there’s a system for that in Eloquent already. It’s called <em>attribute casting</em>, and it allows you to define that any of your columns should always be treated, both on read and on write, as if they are of a particular data type. The options are listed in <a data-type="xref" href="#poss-att-tabl">Table 5-1</a>.</p>&#13;
<table id="poss-att-tabl">&#13;
<caption><span class="label">Table 5-1. </span>Possible attribute casting column types</caption>&#13;
<thead>&#13;
<tr>&#13;
<th>Type</th>&#13;
<th>Description</th>&#13;
</tr>&#13;
</thead>&#13;
<tbody>&#13;
<tr>&#13;
<td><p><code>int|integer</code></p></td>&#13;
<td><p>Casts with PHP (<code>int</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>real|float|double</code></p></td>&#13;
<td><p>Casts with PHP (<code>float</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>decimal:&lt;digits&gt;</code></p></td>&#13;
<td><p>Casts with PHP <code>number_format()</code> with the number of decimals specified.</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>string</code></p></td>&#13;
<td><p>Casts with PHP (<code>string</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>bool|boolean</code></p></td>&#13;
<td><p>Casts with PHP (<code>bool</code>)</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>object|json</code></p></td>&#13;
<td><p>Parses to/from JSON, as a <code>stdClass</code> object</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>array</code></p></td>&#13;
<td><p>Parses to/from JSON, as an array</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>collection</code></p></td>&#13;
<td><p>Parses to/from JSON, as a collection</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>date|datetime</code></p></td>&#13;
<td><p>Parses from database <code>DATETIME</code> to Carbon, and back</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>timestamp</code></p></td>&#13;
<td><p>Parses from database <code>TIMESTAMP</code> to Carbon, and back</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>encrypted</code></p></td>&#13;
<td><p>Handles the encryption and decryption of a string</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>enum</code></p></td>&#13;
<td><p>Casts to an enum</p></td>&#13;
</tr>&#13;
<tr>&#13;
<td><p><code>hashed</code></p></td>&#13;
<td><p>Handles the hashing of a string</p></td>&#13;
</tr>&#13;
</tbody>&#13;
</table>&#13;
&#13;
<p><a data-type="xref" href="#EX827">Example 5-39</a> shows how you use attribute casting in your model.</p>&#13;
<div data-type="example" id="EX827">&#13;
<h5><span class="label">Example 5-39. </span>Using attribute casting on an Eloquent model</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Enums\SubscriptionStatus</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$casts</code> <code class="o">=</code> <code class="p">[</code>&#13;
        <code class="s1">'vip'</code> <code class="o">=&gt;</code> <code class="s1">'boolean'</code><code class="p">,</code>&#13;
        <code class="s1">'children_names'</code> <code class="o">=&gt;</code> <code class="s1">'array'</code><code class="p">,</code>&#13;
        <code class="s1">'birthday'</code> <code class="o">=&gt;</code> <code class="s1">'date'</code><code class="p">,</code>&#13;
        <code class="s1">'subscription'</code> <code class="o">=&gt;</code> <code class="nx">SubscriptionStatus</code><code class="o">::</code><code class="na">class</code>&#13;
    <code class="p">];</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom attribute casting" data-type="sect3"><div class="sect3" id="id108">&#13;
<h3>Custom attribute casting</h3>&#13;
&#13;
<p>If the built-in attribute types aren’t enough, we can build custom cast types and use them in the <code>$casts</code> array.</p>&#13;
&#13;
<p>A <em>custom cast type</em> can<a data-primary="custom cast types (Eloquent)" data-type="indexterm" id="id1085"/> be defined as a regular PHP class with a <code>get</code> and <code>set</code> method. The <code>get</code> method will be called when retrieving the given attribute from an eloquent model. The <code>set</code> method will be called before saving the attribute in the database, as you can see in <a data-type="xref" href="#ex-05">Example 5-40</a>.</p>&#13;
<div data-type="example" id="ex-05">&#13;
<h5><span class="label">Example 5-40. </span>A sample custom cast type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">&lt;?</code><code class="nx">php</code>&#13;
&#13;
<code class="k">namespace</code> <code class="nx">App\Casts</code><code class="p">;</code>&#13;
&#13;
<code class="k">use</code> <code class="nx">Carbon\Carbon</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Support\Facades\Crypt</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Database\Eloquent\CastsAttributes</code><code class="p">;</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Encrypted</code> <code class="k">implements</code> <code class="nx">CastsAttributes</code>&#13;
<code class="p">{</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Cast the given value.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @param  array&lt;string, mixed&gt;  $attributes</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">get</code><code class="p">(</code><code class="nx">Model</code> <code class="nv">$model</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$key</code><code class="p">,</code> <code class="nx">mixed</code> <code class="nv">$value</code><code class="p">,</code> <code class="k">array</code> <code class="nv">$attributes</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Crypt</code><code class="o">::</code><code class="na">decrypt</code><code class="p">(</code><code class="nv">$value</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * Prepare the given value for storage.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @param  array&lt;string, mixed&gt;  $attributes</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">set</code><code class="p">(</code><code class="nx">Model</code> <code class="nv">$model</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$key</code><code class="p">,</code> <code class="nx">mixed</code> <code class="nv">$value</code><code class="p">,</code> <code class="k">array</code> <code class="nv">$attributes</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Crypt</code><code class="o">::</code><code class="na">encrypt</code><code class="p">(</code><code class="nv">$value</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>You can use custom casts in the <code>$casts</code> property on your Eloquent<a data-primary="" data-startref="attcast05" data-type="indexterm" id="id1086"/> model:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">protected</code> <code class="nv">$casts</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="s1">'ssn'</code> <code class="o">=&gt;</code> <code class="nx">\App\Casts\Encrypted</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="p">];</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Collections" data-type="sect2"><div class="sect2" id="eloquent_collections">&#13;
<h2>Eloquent Collections</h2>&#13;
&#13;
<p>When<a data-primary="Eloquent" data-secondary="collections" data-type="indexterm" id="EQcollect05"/> you make any query call in Eloquent that has the potential to return multiple rows, instead of an array they’ll come packaged in an Eloquent collection, which is a specialized type of collection. Let’s take a look at collections and Eloquent collections, and what makes them better than plain arrays.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Introducing the base collection" data-type="sect3"><div class="sect3" id="id109">&#13;
<h3>Introducing the base collection</h3>&#13;
&#13;
<p>Laravel’s<a data-primary="collections" data-secondary="base collection" data-type="indexterm" id="id1087"/><a data-primary="base collection (Eloquent)" data-type="indexterm" id="id1088"/> <code>Collection</code> objects (<code>Illuminate\Support\Collection</code>) are a little bit like arrays on steroids. The methods they expose on array-like objects are so helpful that, once you’ve been using them for a while, you’ll likely want to pull them into non-Laravel projects—which you can, with the <a href="https://oreil.ly/YWnbl">Illuminate/Collections package</a>.</p>&#13;
&#13;
<p>The simplest way to create a collection is to use the <code>collect()</code> helper. Either pass an array in, or use it without arguments, to create an empty collection and then push items into it later. Let’s try it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$collection</code> <code class="o">=</code> <code class="nx">collect</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]);</code></pre>&#13;
&#13;
<p>Now let’s say we want to filter out any even numbers:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$odds</code> <code class="o">=</code> <code class="nv">$collection</code><code class="o">-&gt;</code><code class="na">reject</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$item</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$item</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">===</code> <code class="mi">0</code><code class="p">;</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Or, what if we want to get a version of the collection where each item is multiplied by 10? We can do that as follows:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$multiplied</code> <code class="o">=</code> <code class="nv">$collection</code><code class="o">-&gt;</code><code class="na">map</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$item</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$item</code> <code class="o">*</code> <code class="mi">10</code><code class="p">;</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>We can even get only the even numbers, multiply them all by 10, and reduce them to a single number by <code>sum()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$sum</code> <code class="o">=</code> <code class="nv">$collection</code>&#13;
    <code class="o">-&gt;</code><code class="na">filter</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$item</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$item</code> <code class="o">%</code> <code class="mi">2</code> <code class="o">==</code> <code class="mi">0</code><code class="p">;</code>&#13;
    <code class="p">})</code><code class="o">-&gt;</code><code class="na">map</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$item</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$item</code> <code class="o">*</code> <code class="mi">10</code><code class="p">;</code>&#13;
    <code class="p">})</code><code class="o">-&gt;</code><code class="na">sum</code><code class="p">();</code></pre>&#13;
&#13;
<p>As you can see, collections provide a series of methods, which can optionally be chained to perform functional operations on your arrays. They provide the same functionality as native PHP methods like <code>array_map()</code> and <code>array_reduce()</code>, but you don’t have to memorize PHP’s unpredictable parameter order, and the method chaining syntax is infinitely more readable.</p>&#13;
&#13;
<p>There are more than 60 methods available in the <code>Collection</code> class, including the methods <code>max()</code>, <code>whereIn()</code>, <code>flatten()</code>, and <code>flip()</code>—there’s not enough space to cover them all here. We’ll talk about more of them in <a data-type="xref" href="ch17.html#helpers_and_collections">Chapter 17</a>, or you can check out the <a href="https://oreil.ly/i83f4">Laravel collections docs</a> to see all of the methods.</p>&#13;
<div data-type="note" epub:type="note"><h1>Collections in the Place of Arrays</h1>&#13;
<p>Collections can also be used in any context (except typehinting) where you can use arrays. They allow for iteration, so you can pass them to <code>foreach</code>; and they allow for array access, so if they’re keyed you can try <code>$a = $collection['a']</code>.</p>&#13;
</div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Lazy collections" data-type="sect3"><div class="sect3" id="id110">&#13;
<h3>Lazy collections</h3>&#13;
&#13;
<p><a href="https://oreil.ly/uyoGf">Lazy collections</a> leverage<a data-primary="lazy collections (Eloquent)" data-type="indexterm" id="id1089"/><a data-primary="collections" data-secondary="lazy collections" data-type="indexterm" id="id1090"/> the power of PHP generators to process very large datasets while keeping the memory usage of your app very low.</p>&#13;
&#13;
<p>Imagine needing to iterate over 100,000 contacts in your database. If you were using Laravel’s normal <code>Collections</code>, you’d probably run into memory issues very quickly; all 100,000 records would be loaded into memory, and that’s a lot to ask of your machine:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$verifiedContacts</code> <code class="o">=</code> <code class="nx">App\Contact</code><code class="o">::</code><code class="na">all</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">filter</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">isVerified</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
&#13;
<p>Eloquent makes it simple to use lazy collections with your Eloquent models. If you use the <code>cursor</code> method, Eloquent models will return an instance of <code>LazyCollection</code> instead of the default <code>Collection</code> class. By using lazy collections, your app will only load one record at a time into memory:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$verifiedContacts</code> <code class="o">=</code> <code class="nx">App\Contact</code><code class="o">::</code><code class="na">cursor</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">filter</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">isVerified</code><code class="p">();</code>&#13;
<code class="p">});</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="What eloquent collections add" data-type="sect3"><div class="sect3" id="id111">&#13;
<h3>What eloquent collections add</h3>&#13;
&#13;
<p>Each<a data-primary="collections" data-secondary="features of" data-type="indexterm" id="id1091"/> Eloquent collection is a normal collection, but extended for the particular needs of a collection of Eloquent results.</p>&#13;
&#13;
<p>Once again, there’s not enough room here to cover all of the additions, but they’re centered around the unique aspects of interacting with a collection not just of generic objects, but objects meant to represent database rows.</p>&#13;
&#13;
<p>For example, every Eloquent collection has a method called <code>modelKeys()</code> that returns an array of the primary keys of every instance in the collection. <code>find($id)</code> looks for an instance that has the primary key of <code>$id</code>.</p>&#13;
&#13;
<p>One additional feature available here is the ability to define that any given model should return its results wrapped in a specific class of collection. So, if you want to add specific methods to any collection of objects of your <code>Order</code> model—possibly related to summarizing the financial details of your orders—​you could create a custom <code>OrderCollection</code> that extends <code>Illuminate\Database\Eloquent\Collection</code>, and then register it in your model, as shown in <a data-type="xref" href="#EX29">Example 5-41</a>.</p>&#13;
<div data-type="example" id="EX29">&#13;
<h5><span class="label">Example 5-41. </span>Custom <code>Collection</code> classes for Eloquent models</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">OrderCollection</code> <code class="k">extends</code> <code class="nx">Collection</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">sumBillableAmount</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">reduce</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$carry</code><code class="p">,</code> <code class="nv">$order</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nv">$carry</code> <code class="o">+</code> <code class="p">(</code><code class="nv">$order</code><code class="o">-&gt;</code><code class="na">billable</code> <code class="o">?</code> <code class="nv">$order</code><code class="o">-&gt;</code><code class="na">amount</code> <code class="o">:</code> <code class="mi">0</code><code class="p">);</code>&#13;
        <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">Order</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">newCollection</code><code class="p">(</code><code class="k">array</code> <code class="nv">$models</code> <code class="o">=</code> <code class="p">[])</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">OrderCollection</code><code class="p">(</code><code class="nv">$models</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Now, any<a data-primary="" data-startref="EQcollect05" data-type="indexterm" id="id1092"/> time you get back a collection of <code>Order</code>s (e.g., from <code>Order::all()</code>), it’ll actually be an instance of the <code>OrderCollection</code> class:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$orders</code> <code class="o">=</code> <code class="nx">Order</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
<code class="nv">$billableAmount</code> <code class="o">=</code> <code class="nv">$orders</code><code class="o">-&gt;</code><code class="na">sumBillableAmount</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Serialization" data-type="sect2"><div class="sect2" id="id112">&#13;
<h2>Eloquent Serialization</h2>&#13;
&#13;
<p><em>Serialization</em> is<a data-primary="Eloquent" data-secondary="serialization" data-type="indexterm" id="Eseral05"/><a data-primary="serialization (Eloquent)" data-type="indexterm" id="serialEQ05"/> what happens when you take something complex—an array or an object—and convert it to a string. In a web-based context, that string is often JSON, but it could take other forms as well.</p>&#13;
&#13;
<p>Serializing complex database records can be, well, complex, and this is one of the places many ORMs fall short. Thankfully, you get two powerful methods for free with Eloquent: <code>toArray()</code> and <code>toJson()</code>. Collections also have <code>toArray()</code> and <code>toJson()</code>, so all of these are valid:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contactArray</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="p">();</code>&#13;
<code class="nv">$contactJson</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">toJson</code><code class="p">();</code>&#13;
<code class="nv">$contactsArray</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="p">();</code>&#13;
<code class="nv">$contactsJson</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">toJson</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also cast an Eloquent instance or collection to a string (<code>$string = (string) $contact;</code>), but both models and collections will just run <code>toJson()</code> and return <span class="keep-together">the result.</span></p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Returning models directly from route methods" data-type="sect3"><div class="sect3" id="id668">&#13;
<h3>Returning models directly from route methods</h3>&#13;
&#13;
<p>Laravel’s router eventually converts everything that route methods return to a string, so there’s a clever trick you can use. If you return the result of an Eloquent call in a controller, it will be automatically cast to a string, and therefore returned as JSON. That means a JSON-returning route can be as simple as either of the ones in <a data-type="xref" href="#EX830">Example 5-42</a>.</p>&#13;
<div data-type="example" id="EX830">&#13;
<h5><span class="label">Example 5-42. </span>Returning JSON from routes directly</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// routes/web.php</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'api/contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'api/contacts/{id}'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$id</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">findOrFail</code><code class="p">(</code><code class="nv">$id</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Hiding attributes from JSON" data-type="sect3"><div class="sect3" id="id113">&#13;
<h3>Hiding attributes from JSON</h3>&#13;
&#13;
<p>It’s very common to use JSON returns in APIs, and it’s very common to want to hide certain attributes in these contexts, so Eloquent makes it easy to hide any attributes every time you cast to JSON.</p>&#13;
&#13;
<p>You can either disallow specific attributes, hiding the ones you list:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="nv">$hidden</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'password'</code><code class="p">,</code> <code class="s1">'remember_token'</code><code class="p">];</code></pre>&#13;
&#13;
<p>or allow specific  attributes, showing only the ones you list:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="nv">$visible</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'name'</code><code class="p">,</code> <code class="s1">'email'</code><code class="p">,</code> <code class="s1">'status'</code><code class="p">];</code></pre>&#13;
&#13;
<p>This also works for relationships:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="nv">$hidden</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'contacts'</code><code class="p">];</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasMany</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Loading the Contents of a Relationship</h1>&#13;
<p>By<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="loading contents of" data-type="indexterm" id="id1093"/> default, the contents of a relationship are not loaded when <span class="keep-together">you get</span> a database record, so it doesn’t matter whether you hide them or not. But, as you’ll learn shortly, it’s possible to get a record <em>with</em> its related items, and in this context, those items will not be included in a serialized copy of that record if you choose to hide that relationship.</p>&#13;
&#13;
<p>In case you’re curious now, you can get a <code>User</code> with all contacts—​assuming you’ve set up the relationship correctly—​with the following call:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">with</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">first</code><code class="p">();</code></pre>&#13;
</div>&#13;
&#13;
<p>There might be times when you want to make an attribute visible just for a single call. That’s possible with the Eloquent method <code>makeVisible()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$array</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">makeVisible</code><code class="p">(</code><code class="s1">'remember_token'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">toArray</code><code class="p">();</code></pre>&#13;
<div data-type="tip"><h1>Adding a Generated Column to Array and JSON Output</h1>&#13;
<p>If you have created an accessor for a column that doesn’t exist—​for example, our <code>full_name</code> column from <a data-type="xref" href="#EX824">Example 5-36</a>—you can add it to <span class="keep-together">the <code>$appends</code></span> array on the model, which will add it to the array and JSON<a data-primary="" data-startref="serialEQ05" data-type="indexterm" id="id1094"/><a data-primary="" data-startref="Eseral05" data-type="indexterm" id="id1095"/> output:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$appends</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'full_name'</code><code class="p">];</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">getFullNameAttribute</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">first_name</code><code class="si">}</code><code class="s2"> </code><code class="si">{</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">last_name</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre>&#13;
</div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Relationships" data-type="sect2"><div class="sect2" id="id417">&#13;
<h2>Eloquent Relationships</h2>&#13;
&#13;
<p>In<a data-primary="Eloquent" data-secondary="relationships" data-type="indexterm" id="EQrelation05"/><a data-primary="Eloquent" data-secondary="relationships" data-tertiary="basics of" data-type="indexterm" id="id1096"/> a relational database model, it’s expected that you will have tables that are <em>related</em> to each other—​hence the name. Eloquent provides simple and powerful tools to make the process of relating your database tables easier than ever before.</p>&#13;
&#13;
<p>Many of our examples in this chapter have been centered around a <em>user</em> who has many <em>contacts</em>, a relatively common situation.</p>&#13;
&#13;
<p>In an ORM like Eloquent, you would call this a <em>one-to-many</em> relationship: the one user <em>has many</em> contacts.</p>&#13;
&#13;
<p>If it was a CRM where a contact could be assigned to many users, then this would be a <em>many-to-many</em> relationship: many users can be related to one contact, and each user can be related to many contacts. A user <em>has and belongs to many</em> contacts.</p>&#13;
&#13;
<p>If each contact can have many phone numbers and a user wanted a database of every phone number for their CRM, you would say the user <em>has many</em> phone numbers <em>through</em> contacts—​that is, a user <em>has many</em> contacts, and the contact <em>has many</em> phone numbers, so the contact is sort of an intermediary.</p>&#13;
&#13;
<p>And what if each contact has an address, but you’re only interested in tracking one address? You could have all the address fields on the <code>Contact</code>, but you might also create an <code>Address</code> model—​meaning the contact <em>has one</em> address.</p>&#13;
&#13;
<p>Finally, what if you want to be able to star (favorite) contacts, but also events? This would be a <em>polymorphic</em> relationship, where a user <em>has many</em> stars, but some may be contacts and some may be events.</p>&#13;
&#13;
<p>So, let’s dig into how to define and access these relationships.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="One to one" data-type="sect3"><div class="sect3" id="id114">&#13;
<h3>One to one</h3>&#13;
&#13;
<p>Let’s<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="one-to-one" data-type="indexterm" id="id1097"/><a data-primary="one-to-one relationships" data-type="indexterm" id="id1098"/> start simple: a <code>Contact</code> <em>has one</em> <code>PhoneNumber</code>. This relationship is defined in <a data-type="xref" href="#EX831">Example 5-43</a>.</p>&#13;
<div data-type="example" id="EX831">&#13;
<h5><span class="label">Example 5-43. </span>Defining a one-to-one relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">phoneNumber</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOne</code><code class="p">(</code><code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can tell, the methods defining relationships are on the Eloquent model itself (<code>$this-&gt;hasOne()</code>) and take, at least in this instance, the fully qualified class name of the class that you’re relating them to.</p>&#13;
&#13;
<p>How should this be defined in your database? Since we’ve defined that the <code>Contact</code> has one <code>PhoneNumber</code>, Eloquent expects that the table supporting the <code>PhoneNumber</code> class (likely <code>phone_numbers</code>) has a <code>contact_id</code> column on it. If you named it something different (for instance, <code>owner_id</code>), you’ll need to change your definition:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOne</code><code class="p">(</code><code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'owner_id'</code><code class="p">);</code></pre>&#13;
&#13;
<p>Here’s how we access the <code>PhoneNumber</code> of a <code>Contact</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$contactPhone</code> <code class="o">=</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phoneNumber</code><code class="p">;</code></pre>&#13;
&#13;
<p>Notice that we define the method in <a data-type="xref" href="#EX831">Example 5-43</a> with <code>phoneNumber()</code>, but <span class="keep-together">we access</span> it with <code>-&gt;phoneNumber</code>. That’s the magic. You could also access it with <code class="keep-together">-&gt;phone_number</code>. This will return a full Eloquent instance of the related <code>PhoneNumber</code> record.</p>&#13;
&#13;
<p>But what if we want to access the <code>Contact</code> from the <code>PhoneNumber</code>? There’s a method for that, too (see <a data-type="xref" href="#EX832">Example 5-44</a>).</p>&#13;
<div data-type="example" id="EX832">&#13;
<h5><span class="label">Example 5-44. </span>Defining a one-to-one relationship’s inverse</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">PhoneNumber</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contact</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsTo</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Then we access it the same way:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nv">$phoneNumber</code><code class="o">-&gt;</code><code class="na">contact</code><code class="p">;</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1099">&#13;
<h1>Inserting Related Items</h1>&#13;
<p>Each<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="inserting related items" data-type="indexterm" id="id1100"/> relationship type has its own quirks for how to relate models, but here’s the core of how it works: pass an instance to <code>save()</code>, or an array of instances to <code>saveMany()</code>. You can also pass properties to <code>create()</code> or <code>createMany()</code> and they’ll make new instances for you:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$phoneNumber</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PhoneNumber</code><code class="p">;</code>&#13;
<code class="nv">$phoneNumber</code><code class="o">-&gt;</code><code class="na">number</code> <code class="o">=</code> <code class="mi">8008675309</code><code class="p">;</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phoneNumbers</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">(</code><code class="nv">$phoneNumber</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phoneNumbers</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">saveMany</code><code class="p">([</code>&#13;
    <code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">1</code><code class="p">),</code>&#13;
    <code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">find</code><code class="p">(</code><code class="mi">2</code><code class="p">),</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phoneNumbers</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code>&#13;
    <code class="s1">'number'</code> <code class="o">=&gt;</code> <code class="s1">'+13138675309'</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="c1">// or</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phoneNumbers</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">createMany</code><code class="p">([</code>&#13;
    <code class="p">[</code><code class="s1">'number'</code> <code class="o">=&gt;</code> <code class="s1">'+13138675309'</code><code class="p">],</code>&#13;
    <code class="p">[</code><code class="s1">'number'</code> <code class="o">=&gt;</code> <code class="s1">'+15556060842'</code><code class="p">],</code>&#13;
<code class="p">]);</code></pre>&#13;
</div></aside>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="One to many" data-type="sect3"><div class="sect3" id="id115">&#13;
<h3>One to many</h3>&#13;
&#13;
<p>The<a data-primary="one-to-many relationships" data-type="indexterm" id="id1101"/><a data-primary="Eloquent" data-secondary="relationships" data-tertiary="one-to-many" data-type="indexterm" id="id1102"/> one-to-many relationship is by far the most common. Let’s take a look at how to define that our <code>User</code> <em>has many</em> <code>Contact</code>s (<a data-type="xref" href="#EX833">Example 5-45</a>).</p>&#13;
<div data-type="example" id="EX833">&#13;
<h5><span class="label">Example 5-45. </span>Defining a one-to-many relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasMany</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Once again, this expects that the <code>Contact</code> model’s backing table (likely <code>contacts</code>) has a <code>user_id</code> column on it. If it doesn’t, override it by passing the correct column name as the second parameter of <code>hasMany()</code>.</p>&#13;
&#13;
<p>We can get a <code>User</code>’s <code>Contact</code>s as follows:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$usersContacts</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">;</code></pre>&#13;
&#13;
<p>Just like with one to one, we use the name of the relationship method and call it as if it were a property instead of a method. However, this method returns a collection instead of a model instance. And this is a normal Eloquent collection, so we can have all sorts of fun with it:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$donors</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="o">-&gt;</code><code class="na">filter</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">status</code> <code class="o">==</code> <code class="s1">'donor'</code><code class="p">;</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nv">$lifetimeValue</code> <code class="o">=</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">orders</code><code class="o">-&gt;</code><code class="na">reduce</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$carry</code><code class="p">,</code> <code class="nv">$order</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$carry</code> <code class="o">+</code> <code class="nv">$order</code><code class="o">-&gt;</code><code class="na">amount</code><code class="p">;</code>&#13;
<code class="p">},</code> <code class="mi">0</code><code class="p">);</code></pre>&#13;
&#13;
<p>Just like with one to one, we can also define the inverse (<a data-type="xref" href="#EX834">Example 5-46</a>).</p>&#13;
<div data-type="example" id="EX834">&#13;
<h5><span class="label">Example 5-46. </span>Defining a one-to-many relationship’s inverse</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">user</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsTo</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>And just like with one to one, we can access the <code>User</code> from the <code>Contact</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$userName</code> <code class="o">=</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">;</code></pre>&#13;
<div data-type="note" epub:type="note"><h1>Attaching and Detaching Related Items from the Attached Item</h1>&#13;
<p>Most<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="attaching and detaching related items" data-type="indexterm" id="id1103"/> of the time we attach an item by running <code>save()</code> on the &#13;
<span class="keep-together">parent</span> and passing in the related item, as in <code>$⁠u⁠s⁠e⁠r⁠-⁠&gt;​c⁠o⁠n⁠t⁠a⁠c⁠t⁠s⁠(⁠)​-⁠&gt;⁠s⁠a⁠v⁠e⁠($contact)</code>. But if you want to perform these behaviors on the attached (“child”) item, you can use <span class="keep-together"><code>associate()</code></span> and <span class="keep-together"><code>dissociate()</code></span> on the method that returns the <code>belongsTo</code> &#13;
<span class="keep-together">relationship</span>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">associate</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">());</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// and later</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">dissociate</code><code class="p">();</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code></pre>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using relationships as query builders" data-type="sect4"><div class="sect4" id="id418">&#13;
<h4>Using relationships as query builders</h4>&#13;
&#13;
<p>Until<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="using as query builder" data-type="indexterm" id="id1104"/><a data-primary="query builder" data-secondary="using relationships" data-type="indexterm" id="id1105"/> now, we’ve taken the method name (e.g., <span class="keep-together"><code>contacts()</code></span>) and called it as if were a property (e.g., <code>$user-&gt;contacts</code>). What happens if we call it as a method? Instead of processing the relationship, it will return a prescoped query builder.</p>&#13;
&#13;
<p>So if you have <code>User 1</code>, and you call its <code>contacts()</code> method, you will now have a query builder prescoped to “all contacts that have a field <code>user_id</code> with the value of <code>1</code>.” You can then build out a functional query from there:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$donors</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="s1">'donor'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Selecting only records that have a related item" data-type="sect4"><div class="sect4" id="id566">&#13;
<h4>Selecting only records that have a related item</h4>&#13;
&#13;
<p>You<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="selecting only records with related items" data-type="indexterm" id="id1106"/> can choose to select only records that meet particular criteria with regard to their related items using <code>has()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$postsWithComments</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">has</code><code class="p">(</code><code class="s1">'comments'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can also adjust the criteria further:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$postsWithManyComments</code> <code class="o">=</code> <code class="nx">Post</code><code class="o">::</code><code class="na">has</code><code class="p">(</code><code class="s1">'comments'</code><code class="p">,</code> <code class="s1">'&gt;='</code><code class="p">,</code> <code class="mi">5</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>You can nest the criteria:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$usersWithPhoneBooks</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">has</code><code class="p">(</code><code class="s1">'contacts.phoneNumbers'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>And finally, you can write custom queries on the related items:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Gets all contacts with a phone number containing the string "867-5309"</code>&#13;
<code class="nv">$jennyIGotYourNumber</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">whereHas</code><code class="p">(</code><code class="s1">'phoneNumbers'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'number'</code><code class="p">,</code> <code class="s1">'like'</code><code class="p">,</code> <code class="s1">'%867-5309%'</code><code class="p">);</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Shortened version of the same code above</code>&#13;
<code class="nv">$jennyIGotYourNumber</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">whereRelation</code><code class="p">(</code>&#13;
    <code class="s1">'phoneNumbers'</code><code class="p">,</code>&#13;
    <code class="s1">'number'</code><code class="p">,</code>&#13;
    <code class="s1">'like'</code><code class="p">,</code>&#13;
<code class="s1">'%867-5309'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Has one of many" data-type="sect3"><div class="sect3" id="id116">&#13;
<h3>Has one of many</h3>&#13;
&#13;
<p>One<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="has-one-of-many" data-type="indexterm" id="id1107"/><a data-primary="has-one-of-many relationships" data-type="indexterm" id="id1108"/> common scenario when retrieving records from a one-to-many relationship is that you want to retrieve just one item from that relationship, often the newest or the oldest. Laravel provides a convenience tool for just these situations: has one of many.</p>&#13;
&#13;
<p>Has-one-of-many relationships allow you to define that a given method should retrieve the newest item in a related collection, or the oldest item, or the item with the minimum or maximum value of any particular column, as you can see in <a data-type="xref" href="#EX853">Example 5-47</a>.</p>&#13;
<div data-type="example" id="EX853">&#13;
<h5><span class="label">Example 5-47. </span>Defining has-one-of-many relationships</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">newestContact</code><code class="p">()</code><code class="o">:</code> <code class="nx">HasOne</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOne</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">latestOfMany</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">oldestContact</code><code class="p">()</code><code class="o">:</code> <code class="nx">HasOne</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOne</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">oldestOfMany</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">emergencyContact</code><code class="p">()</code><code class="o">:</code> <code class="nx">HasOne</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOne</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">ofMany</code><code class="p">(</code><code class="s1">'priority'</code><code class="p">,</code> <code class="s1">'max'</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Has many through" data-type="sect3"><div class="sect3" id="id117">&#13;
<h3>Has many through</h3>&#13;
&#13;
<p><code>hasManyThrough()</code> is<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="has-many-through" data-type="indexterm" id="id1109"/><a data-primary="has-many-through relationships" data-type="indexterm" id="id1110"/> really a convenience method for pulling in relationships of a relationship. Think of the example I gave earlier, where a <code>User</code> has many <code>Contact</code>s and each <code>Contact</code> has many <code>PhoneNumber</code>s. What if you want to get a user’s list of contact phone numbers? That’s a has-many-through relation.</p>&#13;
&#13;
<p>This structure assumes that your <code>contacts</code> table has a <code>user_id</code> to relate the contacts to the users and the <code>phone_numbers</code> table has a <code>contact_id</code> to relate it to the contacts. Then, we define the relationship on the <code>User</code> as in <a data-type="xref" href="#EX835">Example 5-48</a>.</p>&#13;
<div data-type="example" id="EX835">&#13;
<h5><span class="label">Example 5-48. </span>Defining a has-many-through relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">phoneNumbers</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Newer string-based syntax</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">through</code><code class="p">(</code><code class="s1">'contact'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'phoneNumber'</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Traditional syntax</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasManyThrough</code><code class="p">(</code><code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>You’d access this relationship using <code>$user-&gt;phone_numbers</code>. If you need to customize the relationship key on the intermediate or distant models, use the traditional syntax; you can define the key on the intermediate model (with the third parameter of <code>h⁠a⁠s​M⁠a⁠n⁠y⁠Through()</code>) and the relationship key on the distant model (with the fourth &#13;
<span class="keep-together">parameter</span>).</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Has one through" data-type="sect3"><div class="sect3" id="id118">&#13;
<h3>Has one through</h3>&#13;
&#13;
<p><code>hasOneThrough()</code> is<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="has-one-through" data-type="indexterm" id="id1111"/><a data-primary="has-one-through relationships" data-type="indexterm" id="id1112"/> just like <code>hasManyThrough()</code>, but instead of accessing many related items through intermediate items, you’re only accessing a single related item through a single intermediate item.</p>&#13;
&#13;
<p>What if each user belonged to a company, and that company had a single phone number, and you wanted to be able to get a user’s phone number by pulling their company’s phone number? That’s a has-one-through relation, as shown in <a data-type="xref" href="#EX5-48">Example 5-49</a>.</p>&#13;
<div data-type="example" id="EX5-48">&#13;
<h5><span class="label">Example 5-49. </span>Defining a has-one-through relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">phoneNumber</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Newer string-based syntax</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">through</code><code class="p">(</code><code class="s1">'company'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'phoneNumber'</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Traditional syntax</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasOneThrough</code><code class="p">(</code><code class="nx">PhoneNumber</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="nx">Company</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Many to many" data-type="sect3"><div class="sect3" id="id119">&#13;
<h3>Many to many</h3>&#13;
&#13;
<p>This<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="many-to-many" data-type="indexterm" id="id1113"/><a data-primary="many-to-many relationships" data-type="indexterm" id="id1114"/> is where things start to get complex. Let’s take our example of a CRM that allows a <code>User</code> to have many <code>Contact</code>s, and each <code>Contact</code> to be related to multiple <code>User</code>s.</p>&#13;
&#13;
<p>First, we define the relationship on the <code>User</code> as in <a data-type="xref" href="#EX836">Example 5-50</a>.</p>&#13;
<div data-type="example" id="EX836">&#13;
<h5><span class="label">Example 5-50. </span>Defining a many-to-many relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsToMany</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>And since this is many to many, the inverse looks exactly the same (<a data-type="xref" href="#EX837">Example 5-51</a>).</p>&#13;
<div data-type="example" id="EX837">&#13;
<h5><span class="label">Example 5-51. </span>Defining a many-to-many relationship’s inverse</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">users</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsToMany</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Since a single <code>Contact</code> can’t have a <code>user_id</code> column and a single <code>User</code> can’t have a <code>contact_id</code> column, many-to-many relationships rely on a pivot table that connects the two. The conventional naming of this table is done by placing the two singular table names together, ordered alphabetically, and separating them by an underscore.</p>&#13;
&#13;
<p>So, since we’re linking <code>users</code> and <code>contacts</code>, our pivot table should be named <code class="keep-together">contact_user</code> (if you’d like to customize the table name, pass it as the second parameter to the <code>belongsToMany()</code> method). It needs two columns: <code>contact_id</code> and <code>user_id</code>.</p>&#13;
&#13;
<p>Just like with <code>hasMany()</code>, we get access to a collection of the related items, but this time it’s from both sides (<a data-type="xref" href="#EX838">Example 5-52</a>).</p>&#13;
<div data-type="example" id="EX838">&#13;
<h5><span class="label">Example 5-52. </span>Accessing the related items from both sides of a many-to-many relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// do something</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">users</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$user</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// do something</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nv">$donors</code> <code class="o">=</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="s1">'donor'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting data from the pivot table" data-type="sect4"><div class="sect4" id="id120">&#13;
<h4>Getting data from the pivot table</h4>&#13;
&#13;
<p>One<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="data from pivot tables" data-type="indexterm" id="id1115"/><a data-primary="pivot tables" data-type="indexterm" id="id1116"/> thing that’s unique about many to many is that it’s our first relationship that has a pivot table. The less data you have in a pivot table, the better, but there are some cases where it’s valuable to store information in your pivot table—​for example, you might want to store a <code>created_at</code> field to see when this relationship was created.</p>&#13;
&#13;
<p>In order to store these fields, you have to add them to the relationship definition, like in <a data-type="xref" href="#EX839">Example 5-53</a>. You can define specific fields using <code>withPivot()</code> or add <code>created_at</code> and <code>updated_at</code> timestamps using <code>withTimestamps()</code>.</p>&#13;
<div data-type="example" id="EX839">&#13;
<h5><span class="label">Example 5-53. </span>Adding fields to a pivot record</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsToMany</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">withTimestamps</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">withPivot</code><code class="p">(</code><code class="s1">'status'</code><code class="p">,</code> <code class="s1">'preferred_greeting'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>When you get a model instance through a relationship, it will have a <code>pivot</code> property on it, which will represent its place in the pivot table you just pulled it from. So, you can do something like <a data-type="xref" href="#EX840">Example 5-54</a>.</p>&#13;
<div data-type="example" id="EX840">&#13;
<h5><span class="label">Example 5-54. </span>Getting data from a related item’s pivot entry</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">echo</code> <code class="nb">sprintf</code><code class="p">(</code>&#13;
        <code class="s1">'Contact associated with this user at: %s'</code><code class="p">,</code>&#13;
        <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">pivot</code><code class="o">-&gt;</code><code class="na">created_at</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If you’d like, you can customize the <code>pivot</code> key to have a different name using the <code>as()</code> method, as shown in <a data-type="xref" href="#EX5f">Example 5-55</a>.</p>&#13;
<div data-type="example" id="EX5f">&#13;
<h5><span class="label">Example 5-55. </span>Customizing the pivot attribute name</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// User model</code>&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">groups</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsToMany</code><code class="p">(</code><code class="nx">Group</code><code class="o">::</code><code class="na">class</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">withTimestamps</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">as</code><code class="p">(</code><code class="s1">'membership'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Using this relationship:</code>&#13;
<code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">groups</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$group</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">echo</code> <code class="nb">sprintf</code><code class="p">(</code>&#13;
        <code class="s1">'User joined this group at: %s'</code><code class="p">,</code>&#13;
        <code class="nv">$group</code><code class="o">-&gt;</code><code class="na">membership</code><code class="o">-&gt;</code><code class="na">created_at</code>&#13;
    <code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1117">&#13;
<h1>Unique Aspects of Attaching and Detaching <br/>Many-to-Many Related Items</h1>&#13;
<p>Since<a data-primary="many-to-many relationships" data-type="indexterm" id="id1118"/> your pivot table can have its own properties, you need to be able to set those properties when you’re attaching a many-to-many related item. You can do that by passing an array as the second parameter to <code>save()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">(</code><code class="nv">$contact</code><code class="p">,</code> <code class="p">[</code><code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'donor'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>Additionally, you can use <code>attach()</code> and <code>detach()</code> and, instead of passing in an instance of a related item, you can just pass an ID. They work just the same as <code>save()</code> but can also accept an array of IDs without you needing to rename the method to something like <code>attachMany()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="p">[</code><code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'donor'</code><code class="p">]);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="p">([</code>&#13;
    <code class="mi">1</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'donor'</code><code class="p">],</code>&#13;
    <code class="mi">2</code><code class="p">,</code>&#13;
    <code class="mi">3</code><code class="p">,</code>&#13;
<code class="p">]);</code>&#13;
&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">detach</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">detach</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">]);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">detach</code><code class="p">();</code> <code class="c1">// Detaches all contacts</code></pre>&#13;
&#13;
<p>If your goal is not to attach or detach, but instead just to invert whatever the current attachment state is, you want the <code>toggle()</code> method. When you use <code>toggle()</code>, if the given ID is currently attached, it will be detached; and if it is currently detached, it will be attached:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">toggle</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]);</code></pre>&#13;
&#13;
<p>You can also use <code>updateExistingPivot()</code> to make changes just to the pivot record:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">updateExistingPivot</code><code class="p">(</code><code class="nv">$contactId</code><code class="p">,</code> <code class="p">[</code>&#13;
    <code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'inactive'</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre>&#13;
&#13;
<p>And if you’d like to replace the current relationships, effectively detaching all previous relationships and attaching new ones, you can pass an array to <code>sync()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">sync</code><code class="p">([</code><code class="mi">1</code><code class="p">,</code> <code class="mi">2</code><code class="p">,</code> <code class="mi">3</code><code class="p">]);</code>&#13;
<code class="nv">$user</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">sync</code><code class="p">([</code>&#13;
    <code class="mi">1</code> <code class="o">=&gt;</code> <code class="p">[</code><code class="s1">'status'</code> <code class="o">=&gt;</code> <code class="s1">'donor'</code><code class="p">],</code>&#13;
    <code class="mi">2</code><code class="p">,</code>&#13;
    <code class="mi">3</code><code class="p">,</code>&#13;
<code class="p">]);</code></pre>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Polymorphic" data-type="sect3"><div class="sect3" id="id121">&#13;
<h3>Polymorphic</h3>&#13;
&#13;
<p>Remember, our<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="polymorphic" data-type="indexterm" id="id1119"/><a data-primary="polymorphic relationships" data-type="indexterm" id="polym05"/> polymorphic relationship is where we have multiple Eloquent classes corresponding to the same relationship. We’re going to use <code>Star</code>s (like favorites) right now. A user can star both <code>Contact</code>s and <code>Event</code>s, and that’s where the name <em>polymorphic</em> comes from: there’s a single interface to objects of multiple types.</p>&#13;
&#13;
<p>So, we’ll need three tables (<code>stars</code>, <code>contacts</code>, <code>events</code>) and three models (<code>Star</code>, <code>Contact</code>, and <code>Event</code>). Actually, you’ll need four of each because we’ll also need <code>users</code> and <code>User</code>, but we’ll get there in a second. The <code>contacts</code> and <code>events</code> tables <span class="keep-together">will just</span> be as they normally are, and the <code>stars</code> table will contain <code>id</code>, <code>starrable_id</code>, and <code>starrable_type</code> fields. For each <code>Star</code>, we’ll be defining which “type” (e.g., <code>Contact</code> or <code>Event</code>) and which ID of that type (e.g., <code>1</code>) it is.</p>&#13;
&#13;
<p>Let’s create our models, as seen in <a data-type="xref" href="#EX841">Example 5-56</a>.</p>&#13;
<div data-type="example" id="EX841">&#13;
<h5><span class="label">Example 5-56. </span>Creating the models for a polymorphic starring system</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Star</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">starrable</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphTo</code><code class="p">();</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">stars</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphMany</code><code class="p">(</code><code class="nx">Star</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'starrable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Event</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">stars</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphMany</code><code class="p">(</code><code class="nx">Star</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'starrable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>So, how do we create a <code>Star</code>?</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">stars</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code></pre>&#13;
&#13;
<p>It’s that easy. The <code>Contact</code> is now starred.</p>&#13;
&#13;
<p>In order to find all of the <code>Star</code>s on a given <code>Contact</code>, we call the <code>stars()</code> method like in <a data-type="xref" href="#EX842">Example 5-57</a>.</p>&#13;
<div data-type="example" id="EX842">&#13;
<h5><span class="label">Example 5-57. </span>Retrieving the instances of a polymorphic relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">stars</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$star</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Do stuff</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>If we have an instance of <code>Star</code>, we can get its target by calling the method we used to define its <code>morphTo</code> relationship, which in this context is <code>starrable()</code>. Take a look at <a data-type="xref" href="#EX843">Example 5-58</a>.</p>&#13;
<div data-type="example" id="EX843">&#13;
<h5><span class="label">Example 5-58. </span>Retrieving the target of a polymorphic instance</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$stars</code> <code class="o">=</code> <code class="nx">Star</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$stars</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$star</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$star</code><code class="o">-&gt;</code><code class="na">starrable</code><code class="p">);</code> <code class="c1">// An instance of Contact or Event</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>Finally, you might be wondering, “What if I want to know who starred this contact?” That’s a great question. It’s as simple as adding <code>user_id</code> to your <code>stars</code> table, and then setting up that a <code>User</code> <em>has many</em> <code>Star</code>s and a <code>Star</code> <em>belongs to</em> one <code>User</code>—a one-to-many relationship (<a data-type="xref" href="#EX844">Example 5-59</a>). The <code>stars</code> table becomes almost a pivot table between your <code>User</code> and your <code>Contact</code>s and <code>Event</code>s.</p>&#13;
<div data-type="example" id="EX844">&#13;
<h5><span class="label">Example 5-59. </span>Extending a polymorphic system to differentiate by user</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Star</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">starrable</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphsTo</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">user</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsTo</code><code class="p">(</code><code class="nx">User</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">User</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">stars</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">hasMany</code><code class="p">(</code><code class="nx">Star</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>That’s it! You can now run <code>$star-&gt;user</code> or <code>$user-&gt;stars</code> to find a list of a <code>User</code>’s <code>Star</code>s or to find the starring <code>User</code> from a <code>Star</code>. Also, when you create a new <code>Star</code>, you’ll now want to pass the <code>User</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$user</code> <code class="o">=</code> <code class="nx">User</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$event</code> <code class="o">=</code> <code class="nx">Event</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$event</code><code class="o">-&gt;</code><code class="na">stars</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">([</code><code class="s1">'user_id'</code> <code class="o">=&gt;</code> <code class="nv">$user</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Many-to-many polymorphic" data-type="sect3"><div class="sect3" id="id122">&#13;
<h3>Many-to-many polymorphic</h3>&#13;
&#13;
<p>The<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="many-to-many polymorphic" data-type="indexterm" id="id1120"/><a data-primary="many-to-many polymorphic relationships" data-type="indexterm" id="id1121"/> most complex and least common of the relationship types, many-to-many polymorphic relationships are like polymorphic relationships, except instead of being one to many, they’re many to many.</p>&#13;
&#13;
<p>The most common example for this relationship type is the tag, so I’ll keep it safe and use that as our example. Let’s imagine you want to be able to tag <code>Contact</code>s and <code>Event</code>s. The uniqueness of many-to-many polymorphism is that it’s many to many: each tag may be applied to multiple items, and each tagged item might have multiple tags. And to add to that, it’s polymorphic: tags can be related to items of several different types. For the database, we’ll start with the normal structure of the polymorphic relationship but also add a pivot table.</p>&#13;
&#13;
<p>This means we’ll need a <code>contacts</code> table, an <code>events</code> table, and a <code>tags</code> table, all shaped like normal with an ID and whatever properties you want, <em>and</em> a new <code>taggables</code> table, which will have <code>tag_id</code>, <code>taggable_id</code>, and <code>taggable_type</code> fields. Each entry into the <code>taggables</code> table will relate a tag with one of the taggable content types.</p>&#13;
&#13;
<p>Now let’s define this relationship on our models, as seen in <a data-type="xref" href="#EX845">Example 5-60</a>.</p>&#13;
<div data-type="example" id="EX845">&#13;
<h5><span class="label">Example 5-60. </span>Defining a polymorphic many-to-many relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">Contact</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">tags</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphToMany</code><code class="p">(</code><code class="nx">Tag</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'taggable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Event</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">tags</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphToMany</code><code class="p">(</code><code class="nx">Tag</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'taggable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">Tag</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphedByMany</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'taggable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">events</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">morphedByMany</code><code class="p">(</code><code class="nx">Event</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'taggable'</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Here’s how to create your first tag:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$tag</code> <code class="o">=</code> <code class="nx">Tag</code><code class="o">::</code><code class="na">firstOrCreate</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'likes-cheese'</code><code class="p">]);</code>&#13;
<code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">tags</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">attach</code><code class="p">(</code><code class="nv">$tag</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">);</code></pre>&#13;
&#13;
<p>We get the results of this relationship like normal, as<a data-primary="" data-startref="polym05" data-type="indexterm" id="id1122"/> seen in <a data-type="xref" href="#EX846">Example 5-61</a>.</p>&#13;
<div data-type="example" id="EX846">&#13;
<h5><span class="label">Example 5-61. </span>Accessing the related items from both sides of a many-to-many polymorphic relationship</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
&#13;
<code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">tags</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$tag</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Do stuff</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nv">$tag</code> <code class="o">=</code> <code class="nx">Tag</code><code class="o">::</code><code class="na">first</code><code class="p">();</code>&#13;
<code class="nv">$tag</code><code class="o">-&gt;</code><code class="na">contacts</code><code class="o">-&gt;</code><code class="na">each</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="c1">// Do stuff</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Child records updating parent record timestamps" data-type="sect3"><div class="sect3" id="id123">&#13;
<h3>Child records updating parent record timestamps</h3>&#13;
&#13;
<p>Remember, any<a data-primary="Eloquent" data-secondary="relationships" data-tertiary="child records updating parent records" data-type="indexterm" id="id1123"/><a data-primary="timestamps" data-type="indexterm" id="id1124"/> Eloquent models by default will have <code>created_at</code> and <code>updated_at</code> timestamps. Eloquent will set the <code>updated_at</code> timestamp automatically any time you make any changes to a record.</p>&#13;
&#13;
<p>When a related item has a <code>belongsTo</code> or <code>belongsToMany</code> relationship with another item, it might be valuable to mark the other item as updated any time the related item is updated. For example, if a <code>PhoneNumber</code> is updated, maybe the <code>Contact</code> it’s connected to should be marked as having been updated as well.</p>&#13;
&#13;
<p>We can accomplish this by adding the method name for that relationship to a <code>$touches</code> array property on the child class, as in <a data-type="xref" href="#EX847">Example 5-62</a>.</p>&#13;
<div data-type="example" id="EX847">&#13;
<h5><span class="label">Example 5-62. </span>Updating a parent record any time the child record is updated</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">PhoneNumber</code> <code class="k">extends</code> <code class="nx">Model</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">protected</code> <code class="nv">$touches</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'contact'</code><code class="p">];</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">contact</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">belongsTo</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eager Loading" data-type="sect3"><div class="sect3" id="id124">&#13;
<h3>Eager Loading</h3>&#13;
&#13;
<p>By<a data-primary="eager loading" data-type="indexterm" id="eload05"/><a data-primary="lazy loading" data-type="indexterm" id="lazyload05"/> default, Eloquent loads relationships using <em>lazy loading</em>. This means when you first load a model instance, its related models will not be loaded along with it. Rather, they’ll only be loaded once you access them on the model; they’re “lazy” and don’t do any work until called upon.</p>&#13;
&#13;
<p>This can become a problem if you’re iterating over a list of model instances and each has a related item (or items) that you’re working on. The problem with lazy loading is that it can introduce significant database load (often the <em>N</em>+1 problem, if you’re familiar with the term; if not, just ignore this parenthetical remark). For instance, every time the loop in <a data-type="xref" href="#EX848">Example 5-63</a> runs, it executes a new database query to look up the phone numbers for that <code>Contact</code>.</p>&#13;
<div data-type="example" id="EX848">&#13;
<h5><span class="label">Example 5-63. </span>Retrieving one related item for each item in a list (N+1)</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
&#13;
<code class="k">foreach</code> <code class="p">(</code><code class="nv">$contacts</code> <code class="k">as</code> <code class="nv">$contact</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">foreach</code> <code class="p">(</code><code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">phone_numbers</code> <code class="k">as</code> <code class="nv">$phone_number</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">echo</code> <code class="nv">$phone_number</code><code class="o">-&gt;</code><code class="na">number</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If you are loading a model instance and you know you’ll be working with its relationships, you can instead choose to <em>eager load</em> one or many of its sets of related items:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">with</code><code class="p">(</code><code class="s1">'phoneNumbers'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>Using the <code>with()</code> method with a retrieval gets all of the items related to the pulled item(s); as you can see in this example, you pass it the name of the method the relationship is defined by.</p>&#13;
&#13;
<p>When we use eager loading, instead of pulling the related items one at a time when they’re requested (e.g., selecting one contact’s phone numbers each time a <code>foreach</code> loop runs), we have a single query to pull the initial items (selecting all contacts) and a second query to pull all their related items (selecting all phone numbers owned by the contacts we just pulled).</p>&#13;
&#13;
<p>You can eager load multiple relationships by passing an array of the relationships to eager load to the <code>with()</code> call:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">with</code><code class="p">([</code><code class="s1">'phoneNumbers'</code><code class="p">,</code> <code class="s1">'addresses'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
<p>And you can nest eager loading to eager load the relationships of relationships:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$authors</code> <code class="o">=</code> <code class="nx">Author</code><code class="o">::</code><code class="na">with</code><code class="p">(</code><code class="s1">'posts.comments'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Constraining eager loads" data-type="sect4"><div class="sect4" id="id669">&#13;
<h4>Constraining eager loads</h4>&#13;
&#13;
<p>If you want to eager load a relationship but not all of <span class="keep-together">the items,</span> you can pass a closure to <code>with()</code> to define exactly which related items to eager load:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">with</code><code class="p">([</code><code class="s1">'addresses'</code> <code class="o">=&gt;</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$query</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$query</code><code class="o">-&gt;</code><code class="na">where</code><code class="p">(</code><code class="s1">'mailable'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
<code class="p">}])</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Lazy eager loading" data-type="sect4"><div class="sect4" id="id125">&#13;
<h4>Lazy eager loading</h4>&#13;
&#13;
<p>I<a data-primary="lazy eager loading" data-type="indexterm" id="id1125"/> know it sounds crazy, because we just defined eager loading as sort of the opposite of lazy loading, but sometimes you don’t know you want to perform an eager load query until after the initial instances have been pulled. In this context, you’re still able to make a single query to look up all of the related items, avoiding <em>N</em>+1 cost. We call this <em>lazy eager loading</em>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$showPhoneNumbers</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$contacts</code><code class="o">-&gt;</code><code class="na">load</code><code class="p">(</code><code class="s1">'phoneNumbers'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
&#13;
<p>To load a relationship only when it has not already been loaded, use the <span class="keep-together"><code>loadMissing()</code></span> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$contacts</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">();</code>&#13;
&#13;
<code class="k">if</code> <code class="p">(</code><code class="nv">$showPhoneNumbers</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$contacts</code><code class="o">-&gt;</code><code class="na">loadMissing</code><code class="p">(</code><code class="s1">'phoneNumbers'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Preventing lazy loading" data-type="sect4"><div class="sect4" id="id670">&#13;
<h4>Preventing lazy loading</h4>&#13;
&#13;
<p>Because lazy loading can often be an undesirable pattern, you can disable lazy loading for your entire app at once. It’s recommended that you take this action in the <code>boot()</code> method of your <code>AppServiceProvider</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Model</code><code class="o">::</code><code class="na">preventLazyLoading</code><code class="p">(</code><code class="o">!</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">app</code><code class="o">-&gt;</code><code class="na">isProduction</code><code class="p">());</code>&#13;
    <code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eager loading only the count" data-type="sect4"><div class="sect4" id="id126">&#13;
<h4>Eager loading only the count</h4>&#13;
&#13;
<p>If you want to eager load relationships, but only so you can have access to the count of items in each relationship, you can<a data-primary="" data-startref="lazyload05" data-type="indexterm" id="id1126"/><a data-primary="" data-startref="eload05" data-type="indexterm" id="id1127"/><a data-primary="" data-startref="EQrelation05" data-type="indexterm" id="id1128"/> try <code>withCount()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$authors</code> <code class="o">=</code> <code class="nx">Author</code><code class="o">::</code><code class="na">withCount</code><code class="p">(</code><code class="s1">'posts'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
<code class="c1">// Adds a "posts_count" integer to each Author with a count of that</code>&#13;
<code class="c1">// author's related posts</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Eloquent Events" data-type="sect1"><div class="sect1" id="id419">&#13;
<h1>Eloquent Events</h1>&#13;
&#13;
<p>Eloquent models<a data-primary="Eloquent" data-secondary="event firing" data-type="indexterm" id="id1129"/><a data-primary="events" data-secondary="firing events" data-type="indexterm" id="id1130"/> fire events out into the void of your application every time certain actions happen, regardless of whether you’re listening. If you’re familiar with pub/sub, it’s this same model (you’ll learn more about Laravel’s entire event system in <a data-type="xref" href="ch16.html#queues_jobs_events">Chapter 16</a>).</p>&#13;
&#13;
<p>Here’s a quick rundown of binding a listener to when a new <code>Contact</code> is created. We’re going to bind it in the <code>boot()</code> method of <code>AppServiceProvider</code>, and let’s imagine we’re notifying a third-party service every time we create a new <code>Contact</code> (<a data-type="xref" href="#EX5-63b">Example 5-64</a>).</p>&#13;
<div data-type="example" id="EX5-63b">&#13;
<h5><span class="label">Example 5-64. </span>Binding a listener to an Eloquent event</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">class</code> <code class="nc">AppServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$thirdPartyService</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SomeThirdPartyService</code><code class="p">;</code>&#13;
&#13;
        <code class="nx">Contact</code><code class="o">::</code><code class="na">creating</code><code class="p">(</code><code class="k">function</code> <code class="p">(</code><code class="nv">$contact</code><code class="p">)</code> <code class="k">use</code> <code class="p">(</code><code class="nv">$thirdPartyService</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">try</code> <code class="p">{</code>&#13;
                <code class="nv">$thirdPartyService</code><code class="o">-&gt;</code><code class="na">addContact</code><code class="p">(</code><code class="nv">$contact</code><code class="p">);</code>&#13;
            <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">Exception</code> <code class="nv">$e</code><code class="p">)</code> <code class="p">{</code>&#13;
                <code class="nx">Log</code><code class="o">::</code><code class="na">error</code><code class="p">(</code><code class="s1">'Failed adding contact to ThirdPartyService; canceled.'</code><code class="p">);</code>&#13;
&#13;
                <code class="k">return</code> <code class="k">false</code><code class="p">;</code> <code class="c1">// Cancels Eloquent create()</code>&#13;
            <code class="p">}</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>We can see a few things in <a data-type="xref" href="#EX5-63b">Example 5-64</a>. First, we use <code><em>Modelname</em><code>::</code><em>eventName()</em></code> as the method and pass it a closure. The closure gets access to the model instance that is being operated on. Second, we’re going to need to define this listener in a service provider somewhere. And third, if we return <code>false</code>, the operation will cancel and the <code>save()</code> or <code>update()</code> will be canceled.</p>&#13;
&#13;
<p>Here are the events that every Eloquent model fires:</p>&#13;
&#13;
<ul class="two-col">&#13;
<li>&#13;
<p><code>creating</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>created</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>updating</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>updated</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>saving</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>saved</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>deleting</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>deleted</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>restoring</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>restored</code></p>&#13;
</li>&#13;
<li>&#13;
<p><code>retrieved</code></p>&#13;
</li>&#13;
</ul>&#13;
&#13;
<p>Most of these should be pretty clear, except possibly <code>restoring</code> and <code>restored</code>, which fire when you’re restoring a soft-deleted row. Also, <code>saving</code> is fired for both <code>creating</code> and <code>updating</code> and <code>saved</code> is fired for both <code>created</code> and <code>updated</code>.</p>&#13;
&#13;
<p>The <code>retrieved</code> event is fired when an existing model is retrieved from the database.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id127">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Laravel’s entire<a data-primary="Eloquent" data-secondary="testing" data-type="indexterm" id="Etest05"/><a data-primary="databases" data-secondary="testing" data-type="indexterm" id="DBtest05"/><a data-primary="testing" data-secondary="databases" data-tertiary="ease of" data-type="indexterm" id="id1131"/> application testing framework makes it easy to test your database—​not by writing unit tests against Eloquent, but by just being willing to test your entire application.</p>&#13;
&#13;
<p>Take this scenario. You want to test to ensure that a particular page shows one contact but not another. Some of that logic has to do with the interplay between the URL and the controller and the database, so the best way to test it is an application test. You might be thinking about mocking Eloquent calls and trying to avoid the system hitting the database. <em>Don’t do it.</em> Try <a data-type="xref" href="#EX50">Example 5-65</a> instead.<a data-primary="testing" data-secondary="databases" data-tertiary="application tests" data-type="indexterm" id="id1132"/></p>&#13;
<div data-type="example" id="EX50">&#13;
<h5><span class="label">Example 5-65. </span>Testing database interactions with simple application tests</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_active_page_shows_active_and_not_inactive_contacts</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$activeContact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$inactiveContact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">inactive</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'active-contacts'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">assertSee</code><code class="p">(</code><code class="nv">$activeContact</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">assertDontSee</code><code class="p">(</code><code class="nv">$inactiveContact</code><code class="o">-&gt;</code><code class="na">name</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see, model factories and Laravel’s application testing features are great for testing database calls.</p>&#13;
&#13;
<p>Alternatively, you<a data-primary="testing" data-secondary="databases" data-tertiary="assertions" data-type="indexterm" id="id1133"/> can look for that record directly in the database, as in <a data-type="xref" href="#EX51">Example 5-66</a>.</p>&#13;
<div data-type="example" id="EX51">&#13;
<h5><span class="label">Example 5-66. </span>Using <code>assertDatabaseHas()</code> to check for certain records in the database</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_contact_creation_works</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">post</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'jim@bo.com'</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertDatabaseHas</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code>&#13;
        <code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="s1">'jim@bo.com'</code>&#13;
    <code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Eloquent and Laravel’s database framework are tested extensively. <em>You don’t need to test them.</em> You don’t need to mock them. If you really want to avoid hitting the database, you can use a repository and then return unsaved instances of your Eloquent models. But the most important message is this: test the way your application uses your database logic.</p>&#13;
&#13;
<p>If<a data-primary="testing" data-secondary="databases" data-tertiary="custom components" data-type="indexterm" id="id1134"/> you have custom accessors, mutators, scopes, or whatever else, you can also test them directly, as in <a data-type="xref" href="#EX852">Example 5-67</a>.</p>&#13;
<div data-type="example" id="EX852">&#13;
<h5><span class="label">Example 5-67. </span>Testing accessors, mutators, and scopes</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">test_full_name_accessor_works</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$contact</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">make</code><code class="p">([</code>&#13;
        <code class="s1">'first_name'</code> <code class="o">=&gt;</code> <code class="s1">'Alphonse'</code><code class="p">,</code>&#13;
        <code class="s1">'last_name'</code> <code class="o">=&gt;</code> <code class="s1">'Cumberbund'</code>&#13;
    <code class="p">]);</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertEquals</code><code class="p">(</code><code class="s1">'Alphonse Cumberbund'</code><code class="p">,</code> <code class="nv">$contact</code><code class="o">-&gt;</code><code class="na">fullName</code><code class="p">);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">test_vip_scope_filters_out_non_vips</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$vip</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">vip</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
    <code class="nv">$nonVip</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">factory</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">create</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$vips</code> <code class="o">=</code> <code class="nx">Contact</code><code class="o">::</code><code class="na">vips</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertTrue</code><code class="p">(</code><code class="nv">$vips</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="s1">'id'</code><code class="p">,</code> <code class="nv">$vip</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">));</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">assertFalse</code><code class="p">(</code><code class="nv">$vips</code><code class="o">-&gt;</code><code class="na">contains</code><code class="p">(</code><code class="s1">'id'</code><code class="p">,</code> <code class="nv">$nonVip</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">));</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Just<a data-primary="testing" data-secondary="databases" data-tertiary="best practices" data-type="indexterm" id="id1135"/> avoid writing tests that leave you creating complex “Demeter chains” to assert that a particular fluent stack was called on some database mock. If your testing starts to get overwhelming and complex around the database layer, it’s because you’re allowing preconceived notions to force you into unnecessarily<a data-primary="" data-startref="Etest05" data-type="indexterm" id="id1136"/><a data-primary="" data-startref="DBtest05" data-type="indexterm" id="id1137"/> complex systems. Keep <span class="keep-together">it simple.</span></p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id420">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Laravel<a data-primary="databases" data-secondary="overview of" data-type="indexterm" id="id1138"/><a data-primary="Laravel" data-secondary="overview of" data-type="indexterm" id="id1139"/> comes with a suite of powerful database tools, including migrations, seeding, an elegant query builder, and Eloquent, a powerful ActiveRecord ORM. Laravel’s database tools don’t require you to use Eloquent at all—​you can access and manipulate the database with a thin layer of convenience without having to write SQL directly. But adding an ORM, whether it’s Eloquent or Doctrine or whatever else, is easy and can work neatly with Laravel’s core database tools.</p>&#13;
&#13;
<p>Eloquent follows the ActiveRecord pattern, which makes it simple to define a class of database-backed objects, including which table they’re stored in and the shape of their columns, accessors, and mutators. Eloquent can handle every sort of normal SQL action and also complex relationships, up to and including polymorphic many-to-many relationships.</p>&#13;
&#13;
<p>Laravel also has a robust system for testing databases, including model factories.</p>&#13;
</div></section>&#13;
</div></section></body></html>