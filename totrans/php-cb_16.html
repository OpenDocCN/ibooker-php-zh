<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>PHP Cookbook</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 16. Databases"><div class="chapter" id="chapter_databases">
<h1><span class="label">Chapter 16. </span>Databases</h1>


<p>Modern software applications, particularly on the web, use state in order to function. <em>State</em> is a way to represent the current condition of the application for a specific request—who is logged in, what page they’re on, any preferences they’ve configured.</p>

<p>Typically, code is written to be more or <a data-type="indexterm" data-primary="state" id="idm45875138823824"></a>less stateless. It will function the same way regardless of the state of the user’s session (which is what makes system behavior predictable within an application for multiple users). When a web application is deployed, it’s done so again in a stateless manner.</p>

<p>But state is vital for keeping track of user activity and evolving the way the application behaves for the user as they continue to interact with it. In order for an otherwise stateless piece of code to be aware of state, it must retrieve that state from somewhere.</p>

<p>Typically, this is done through the use of a database. Databases are efficient ways to store structured data. There are generally four kinds of databases you will work with in PHP: relational databases, key-value stores, graph databases, and document 
<span class="keep-together">databases</span>.</p>






<section data-type="sect1" data-pdf-bookmark="16.1 Relational Databases"><div class="sect1" id="idm45875138801904">
<h1>16.1 Relational Databases</h1>

<p>A <em>relational database</em> breaks data <a data-type="indexterm" data-primary="databases" data-secondary="relational" id="dtbsrtl"></a><a data-type="indexterm" data-primary="relational databases" id="rltnldbs"></a>down into objects and their relationships with one another. A particular entry—like a book—is represented as a row in a table, with columns containing data about books. These columns might include a title, ISBN, and subject. The key thing to remember about relational databases is that different data types reside in different tables.</p>

<p>While one column in a <code>book</code> table could be an author’s name, it’s more likely you’ll have an entirely separate <code>author</code> table. This table would contain the author’s name, perhaps their biography, and an email address. Both tables would then have separate <code>ID</code> columns, and the <code>book</code> table might have an <code>author_id</code> column referencing the <code>author</code> table. <a data-type="xref" href="#relational_db">Figure 16-1</a> depicts the relations between tables in this form of database.</p>

<figure><div id="relational_db" class="figure">
<img src="assets/phpc_1601.png" alt="Relational databases are defined by tables and references between the items in each" width="600" height="442"/>
<h6><span class="label">Figure 16-1. </span>Relational databases are defined by tables and references between the items in each</h6>
</div></figure>

<p>Examples of relational databases <a data-type="indexterm" data-primary="databases" data-secondary="relational" data-startref="dtbsrtl" id="idm45875138791264"></a><a data-type="indexterm" data-primary="relational databases" data-startref="rltnldbs" id="idm45875138790016"></a>include <a href="https://www.mysql.com">MySQL</a> and <a href="https://oreil.ly/5s4ps">SQLite</a>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.2 Key-Value Stores"><div class="sect1" id="idm45875138787408">
<h1>16.2 Key-Value Stores</h1>

<p>A <em>key-value store</em> is far simpler <a data-type="indexterm" data-primary="databases" data-secondary="key-value stores" id="dtbskyv"></a><a data-type="indexterm" data-primary="key-value stores" id="kyvstr"></a>than a relational database—it’s effectively a single table that maps one identifier (the key) to some stored value. Many applications leverage key-value stores as simple cache utilities, keeping track of primitive values in an efficient, often in-memory lookup system.</p>

<p>As in relational databases, the data stored in a key-value system can be typed. If you’re working with numeric data, most key-value systems expose additional functionality to manipulate that data directly—for example, you can increment integer values without needing to first read the underlying data. <a data-type="xref" href="#kv_store">Figure 16-2</a> demonstrates the one-to-one relationships between keys and values in such a data store.</p>

<figure><div id="kv_store" class="figure">
<img src="assets/phpc_1602.png" alt="Key-value stores are structured as lookups between discrete identifiers mapped to optionally typed values" width="600" height="293"/>
<h6><span class="label">Figure 16-2. </span>Key-value stores are structured as lookups between discrete identifiers mapped to optionally typed values</h6>
</div></figure>

<p>Examples of <a data-type="indexterm" data-primary="databases" data-secondary="key-value stores" data-startref="dtbskyv" id="idm45875138779200"></a><a data-type="indexterm" data-primary="key-value stores" data-startref="kyvstr" id="idm45875138777920"></a>key-value stores include <a href="https://redis.io">Redis</a> and <a href="https://oreil.ly/BYCIM">Amazon DynamoDB</a>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.3 Graph Databases"><div class="sect1" id="idm45875138775344">
<h1>16.3 Graph Databases</h1>

<p>Rather than focusing on <a data-type="indexterm" data-primary="databases" data-secondary="graph" id="dtbssgph"></a><a data-type="indexterm" data-primary="graph databases" id="grpdb"></a><a data-type="indexterm" data-primary="edges, graph databases" id="dggpdtb"></a>structuring the data itself, graph databases focus on modeling the relationships (called <em>edges</em>) between data. Data elements are encapsulated by nodes, and the edges between the nodes link them together and provide semantic context about the data in the system.</p>

<p>Because of the high priority placed on relationships between data, graph databases are well-suited for visualizations like <a data-type="xref" href="#graph_db">Figure 16-3</a>, illustrating the edges and nodes within such a structure. They also provide highly efficient queries on data relationships, making them solid choices for highly interconnected data.</p>

<figure><div id="graph_db" class="figure">
<img src="assets/phpc_1603.png" alt="Graph databases prioritize and illustrate the relationships (edges) between data (nodes)" width="600" height="514"/>
<h6><span class="label">Figure 16-3. </span>Graph databases prioritize and illustrate the relationships (edges) between data (nodes)</h6>
</div></figure>

<p>Examples of graph databases <a data-type="indexterm" data-primary="databases" data-secondary="graph" data-startref="dtbssgph" id="idm45875138766256"></a><a data-type="indexterm" data-primary="graph databases" data-startref="grpdb" id="idm45875138765008"></a><a data-type="indexterm" data-primary="edges, graph databases" data-startref="dggpdtb" id="idm45875138764064"></a>include <a href="https://neo4j.com">Neo4j</a> and <a href="https://oreil.ly/8Uezn">Amazon Neptune</a>.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.4 Document Databases"><div class="sect1" id="idm45875138761328">
<h1>16.4 Document Databases</h1>

<p>It’s also possible to store data specifically <a data-type="indexterm" data-primary="databases" data-secondary="document" id="idm45875138759968"></a><a data-type="indexterm" data-primary="document databases" id="dcmndtbs"></a>as an unstructured or semistructured <em>document</em>. A document could be a well-structured piece of data (like a literal XML document) or a free-form blob of bytes (like a PDF).</p>

<p>The key difference between a document store <a data-type="indexterm" data-primary="document stores" id="idm45875138757120"></a>and the other database types covered in this chapter is structure—<em>document stores</em> are typically unstructured and leverage a dynamic schema to reference data. They’re incredibly useful in some situations, but far more nuanced in their use. For a deep dive into the document-based methodology, read <a class="orm:hideurl" href="https://oreil.ly/psrH8"><em>MongoDB: The Definitive Guide</em></a> by Shannon Bradshaw et al. (O’Reilly).</p>

<p>The following recipes focus primarily on relational databases and how to use them with PHP. You’ll learn how to connect to both local and remote databases, how to leverage fixed data during testing, and even how to use a more sophisticated object-relational mapping (ORM) <a data-type="indexterm" data-primary="ORM (object-relational mapping) library" id="idm45875138754304"></a>library with your data.</p>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.5 Connecting to an SQLite Database"><div class="sect1" id="recipe_sqlite">
<h1>16.5 Connecting to an SQLite Database</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875138751824">
<h2>Problem</h2>

<p>You want to use a local copy of an SQLite <a data-type="indexterm" data-primary="databases" data-secondary="SQLite, connecting" id="dtbsqtct"></a><a data-type="indexterm" data-primary="SQLite database" data-secondary="connecting to" id="sqldbsc"></a>database to store application data. Your application needs to open and close the database appropriately.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875138747520">
<h2>Solution</h2>

<p>Open and close the database as needed <a data-type="indexterm" data-primary="SQLite class" id="idm45875138746000"></a><a data-type="indexterm" data-primary="classes" data-secondary="SQLite" id="idm45875138745296"></a>using the base <code>SQLite</code> class. For efficiency, you can extend the base class with your own constructor and destructor as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">Database</code> <code class="k">extends</code> <code class="nx">SQLite3</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nx">string</code> <code class="nv">$databasePath</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">open</code><code class="p">(</code><code class="nv">$databasePath</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__destruct</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">close</code><code class="p">();</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>Then use your new class to open a database, run some queries, and automatically close the connection when you’re finished. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Database</code><code class="p">(</code><code class="s1">'example.sqlite'</code><code class="p">);</code>

<code class="nv">$create_query</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">CREATE TABLE IF NOT EXISTS users (</code>
<code class="s">    user_id INTEGER PRIMARY KEY,</code>
<code class="s">    first_name TEXT NOT NULL,</code>
<code class="s">    last_name TEXT NOT NULL,</code>
<code class="s">    email TEXT NOT NULL UNIQUE</code>
<code class="s">);</code>
<code class="s">SQL;</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="nv">$create_query</code><code class="p">);</code>

<code class="nv">$insert_query</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">INSERT INTO users (first_name, last_name, email)</code>
<code class="s">VALUES ('Eric', 'Mann', 'eric@phpcookbook.local')</code>
<code class="s">ON CONFLICT(email) DO NOTHING;</code>
<code class="s">SQL;</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="nv">$insert_query</code><code class="p">);</code>

<code class="nv">$results</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="s1">'SELECT * from users;'</code><code class="p">);</code>
<code class="k">while</code> <code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$results</code><code class="o">-&gt;</code><code class="na">fetchArray</code><code class="p">())</code> <code class="p">{</code>
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$row</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875138687184">
<h2>Discussion</h2>

<p>SQLite is a fast, entirely self-contained database engine that stores all of its data in a single file on disk. PHP ships with an extension (enabled by default in most distributions) that directly interfaces with this database, giving you the power to create, write to, and read from databases at will.</p>

<p>The <code>open()</code> method will, by default, create <a data-type="indexterm" data-primary="open() method" id="idm45875138608336"></a>a database file if one does not already exist at the specified path. This behavior can be changed by changing the flags passed in as the second parameter of the method call. By default, PHP will pass <code>SQLITE3_​OPEN_​READWRITE | SQLITE3_OPEN_CREATE</code>, which will open the database for reading <em>and</em> writing as well as create it if it doesn’t already exist.</p>

<p>Three flags are available, as listed in <a data-type="xref" href="#sqlite_open_flags">Table 16-1</a>.</p>
<table id="sqlite_open_flags">
<caption><span class="label">Table 16-1. </span>Optional flags available for opening an SQLite database</caption>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p><code>SQLITE3_OPEN_READONLY</code></p></td>
<td><p>Open a database exclusively for reading</p></td>
</tr>
<tr>
<td><p><code>SQLITE3_OPEN_READWRITE</code></p></td>
<td><p>Open a database for both reading and writing</p></td>
</tr>
<tr>
<td><p><code>SQLITE3_OPEN_CREATE</code></p></td>
<td><p>Create the database if it does not exist</p></td>
</tr>
</tbody>
</table>

<p>The Solution example includes a class that transparently opens an SQLite database at a particular path, creating one if it doesn’t already exist. Given that the class extends the base SQLite class, you can then use it in place of a standard SQLite instance to create tables, insert data, and query that data directly. The class destructor automatically closes the database connection once the instance moves out of scope.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Typically, closing an SQLite connection isn’t explicitly required, as PHP will automatically close the connection when the program exits. If, however, there’s a chance that the application (or thread) might continue running, it’s a good idea to close your connection to free up system resources as you go. While this won’t impact a local, file-based data connection that much, it’s a critical component of working with remote relational databases like MySQL. Being consistent in your database management is a good habit to build.</p>
</div>

<p>The SQLite database is represented by a binary file on disk at the path specified. If you have a development environment like <a href="https://oreil.ly/k_LBl">Visual Studio Code</a>, you can use purpose-built extensions like <a href="https://oreil.ly/QzF0J">SQLite Viewer</a> to <a data-type="indexterm" data-primary="SQLite Viewer" id="idm45875138593376"></a>connect to and visualize your local database as well. Having more than one way to view the schema and data housed within a database is a quick and effective means to <a data-type="indexterm" data-primary="databases" data-secondary="SQLite, connecting" data-startref="dtbsqtct" id="idm45875138592512"></a><a data-type="indexterm" data-primary="SQLite database" data-secondary="connecting to" data-startref="sqldbsc" id="idm45875138591296"></a>validate that your code is doing what you think it’s doing.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875138589696">
<h2>See Also</h2>

<p>PHP documentation for <a href="https://oreil.ly/kMU8Y">the SQLite3 database extension</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.6 Using PDO to Connect to an External Database Provider"><div class="sect1" id="recipe_pdo">
<h1>16.6 Using PDO to Connect to an External Database Provider</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875138585904">
<h2>Problem</h2>

<p>You want to use PDO as an abstraction <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="external database provider connection" id="pdpdxv"></a><a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="as abstraction layer" id="phpdjby"></a><a data-type="indexterm" data-primary="databases" data-secondary="external, PDO connection and" id="dbsxlpdn"></a>layer to connect to and query a remote MySQL database.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875138580368">
<h2>Solution</h2>

<p>First, define a class extending the core <code>PDO</code> definition <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="extending" id="idm45875138578416"></a>that handles creating and closing connections as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">Database</code> <code class="k">extends</code> <code class="nx">PDO</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$config</code> <code class="o">=</code> <code class="s1">'database.ini'</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="nv">$settings</code> <code class="o">=</code> <code class="nb">parse_ini_file</code><code class="p">(</code><code class="nv">$config</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>

        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nv">$settings</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">RuntimeException</code><code class="p">(</code><code class="s2">"Error reading config: `</code><code class="si">{</code><code class="nv">$config</code><code class="si">}</code><code class="s2">`."</code><code class="p">);</code>
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">array_key_exists</code><code class="p">(</code><code class="s1">'database'</code><code class="p">,</code> <code class="nv">$settings</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">RuntimeException</code><code class="p">(</code><code class="s2">"Invalid config: `</code><code class="si">{</code><code class="nv">$config</code><code class="si">}</code><code class="s2">`."</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="nv">$db</code> <code class="o">=</code> <code class="nv">$settings</code><code class="p">[</code><code class="s1">'database'</code><code class="p">];</code>
        <code class="nv">$port</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'port'</code><code class="p">]</code> <code class="o">??</code> <code class="mi">3306</code><code class="p">;</code>
        <code class="nv">$driver</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'driver'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">'mysql'</code><code class="p">;</code>
        <code class="nv">$host</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'host'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">''</code><code class="p">;</code>
        <code class="nv">$schema</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'schema'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">''</code><code class="p">;</code>
        <code class="nv">$username</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">??</code> <code class="k">null</code><code class="p">;</code>
        <code class="nv">$password</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]</code> <code class="o">??</code> <code class="k">null</code><code class="p">;</code>

        <code class="nv">$port</code> <code class="o">=</code> <code class="k">empty</code><code class="p">(</code><code class="nv">$port</code><code class="p">)</code> <code class="o">?</code> <code class="s1">''</code> <code class="o">:</code> <code class="s2">";port=</code><code class="si">{</code><code class="nv">$port</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>
        <code class="nv">$dsn</code> <code class="o">=</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$driver</code><code class="si">}</code><code class="s2">:host=</code><code class="si">{</code><code class="nv">$host</code><code class="si">}{</code><code class="nv">$port</code><code class="si">}</code><code class="s2">;dbname=</code><code class="si">{</code><code class="nv">$schema</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

        <code class="k">parent</code><code class="o">::</code><code class="na">__construct</code><code class="p">(</code><code class="nv">$dsn</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The configuration file for the preceding class needs to be in INI format. For example:</p>

<pre data-type="programlisting" data-code-language="ini"><code class="k">[database]</code>
<code class="na">driver</code> <code class="o">=</code> <code class="s">mysql</code>
<code class="na">host</code> <code class="o">=</code> <code class="s">127.0.0.1</code>
<code class="na">port</code> <code class="o">=</code> <code class="s">3306</code>
<code class="na">schema</code> <code class="o">=</code> <code class="s">cookbook</code>
<code class="na">username</code> <code class="o">=</code> <code class="s">root</code>
<code class="na">password</code> <code class="o">=</code> <code class="s">toor</code></pre>

<p>Once the file is configured, you can query the database directly by using the abstractions provided by PDO as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Database</code><code class="p">();</code>

<code class="nv">$create_query</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">CREATE TABLE IF NOT EXISTS users (</code>
<code class="s">    user_id int NOT NULL AUTO_INCREMENT,</code>
<code class="s">    first_name varchar(255) NOT NULL,</code>
<code class="s">    last_name varchar(255) NOT NULL,</code>
<code class="s">    email varchar(255) NOT NULL UNIQUE,</code>
<code class="s">    PRIMARY KEY (user_id)</code>
<code class="s">);</code>
<code class="s">SQL;</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="nv">$create_query</code><code class="p">);</code>

<code class="nv">$insert_query</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">INSERT IGNORE INTO users (first_name, last_name, email)</code>
<code class="s">VALUES ('Eric', 'Mann', 'eric@phpcookbook.local');</code>
<code class="s">SQL;</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="nv">$insert_query</code><code class="p">);</code>

<code class="k">foreach</code><code class="p">(</code><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="s1">'SELECT * from users;'</code><code class="p">)</code> <code class="k">as</code> <code class="nv">$row</code><code class="p">)</code> <code class="p">{</code>
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$row</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875138386704">
<h2>Discussion</h2>

<p>The Solution example leverages the same table structure and data as previously used by <a data-type="xref" href="#recipe_sqlite">Recipe 16.5</a>, except that it <a data-type="indexterm" data-primary="MySQL database" id="mysqbs"></a>uses the MySQL database engine. <a href="https://www.mysql.com">MySQL</a> is a popular, free, open source database engine maintained by Oracle. According to the maintainers, it powers many popular web applications, including large-scale platforms <a href="https://oreil.ly/fIuva">like Facebook, Netflix, and Uber</a>. In fact, MySQL is so prevalent that many system maintainers ship the MySQL extension with PHP by default, making it even easier to connect to the system and saving you from having to install new drivers by yourself.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Unlike the Solution example from <a data-type="xref" href="#recipe_sqlite">Recipe 16.5</a>, PHP has no method to explicitly close the connection when using PDO. Instead, set the value of your database handle (<code>$db</code> in the Solution example) to <code>null</code> to take the object out of scope and trigger PHP to close the connection.</p>
</div>

<p>In the Solution example, you first defined a class to wrap PDO itself and abstract the connection to a MySQL database. This isn’t required, but as with <a data-type="xref" href="#recipe_sqlite">Recipe 16.5</a> it’s is a good way to get used to maintaining clean data connections. Once the connection is established, you can create a table, insert data, and read that data back efficiently.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>The Solution example assumes the <code>cookbook</code> schema already existed within the database to which you were connecting. Unless you’ve already created that schema directly, this implicit connection will fail with a <code>PDOException</code> complaining about an unknown database. It is critical that you create the schema <em>first</em> within the MySQL database before you try to manipulate it.</p>
</div>

<p>Unlike SQLite, MySQL databases require a totally separate application to house the database and broker the connection to your application. Often this application will run on an entirely different server, and your application will connect over TCP on a specific port (usually 3306). For local development and testing, it’s enough to stand up a database alongside your application by using <a href="https://www.docker.com">Docker</a>. The following one-line command will create a local MySQL database within a Docker container, listening on the default port of 3306 and allowing connections by a <code>root</code> user with the password of <code>toor</code>:</p>

<pre data-type="programlisting">$ docker run --name db -e MYSQL_ROOT_PASSWORD=toor -p 0.0.0.0:3306:3306 -d mysql</pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Whether using MySQL within Docker locally or in a production environment, the <a href="https://oreil.ly/4btCa">official container image</a> details various configuration settings that can be used to customize and secure the environment.</p>
</div>

<p>When the container first starts, it will not have any schemas available to query (meaning the rest of the Solution example is not yet usable). To create a default <code>cookbook</code> schema, you need to connect to the database and create the schema. In <a data-type="xref" href="#using_mysql_cli">Example 16-1</a>, the <code>$</code> character indicates shell commands, and the <code>mysql&gt;</code> prompt indicates a command run within the database itself.</p>
<div id="using_mysql_cli" data-type="example">
<h5><span class="label">Example 16-1. </span>Using the MySQL CLI to create a database schema</h5>

<pre data-type="programlisting">$ mysql --host 127.0.0.1 --user root --password=toor <a class="co" id="co_databases_CO1-1" href="#callout_databases_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a>

mysql&gt; create database `cookbook`; <a class="co" id="co_databases_CO1-2" href="#callout_databases_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a>
mysql&gt; exit <a class="co" id="co_databases_CO1-3" href="#callout_databases_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_databases_CO1-1" href="#co_databases_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>The Docker container is exposing MySQL over TCP to the local environment, which requires you to specify a local host by IP address. Failing to do so defaults to MySQL attempting to connect over a Unix socket, which will fail in this case. You must also pass both the username and password in order to connect.</p></dd>
<dt><a class="co" id="callout_databases_CO1-2" href="#co_databases_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Once connected to the database engine, you can create a new schema within it.</p></dd>
<dt><a class="co" id="callout_databases_CO1-3" href="#co_databases_CO1-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>To disconnect from MySQL, merely type <code>exit</code> or <code>quit</code> and press the Enter key.</p></dd>
</dl></div>

<p>If you don’t have the MySQL command line installed, you can also leverage Docker to connect to the running database container and use <em>its</em> command-line interface instead. <a data-type="xref" href="#docker_hosted_cli">Example 16-2</a> illustrates how to leverage a Docker container to wrap the MySQL CLI while creating a database schema.</p>
<div id="docker_hosted_cli" data-type="example">
<h5><span class="label">Example 16-2. </span>Using a Docker-hosted MySQL CLI to create a database schema</h5>

<pre data-type="programlisting">$ docker exec -it db bash <a class="co" id="co_databases_CO2-1" href="#callout_databases_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a>

$ mysql --user root --password=toor <a class="co" id="co_databases_CO2-2" href="#callout_databases_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a>

mysql&gt; create database `cookbook`; <a class="co" id="co_databases_CO2-3" href="#callout_databases_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a>
mysql&gt; exit

$ exit <a class="co" id="co_databases_CO2-4" href="#callout_databases_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_databases_CO2-1" href="#co_databases_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Since MySQL is already running locally as a container named <code>db</code>, you can execute a command within the container interactively by referencing the same name. Docker’s <code>i</code> and <code>t</code> flags indicate you want to execute a command in an interactive terminal session. The <code>bash</code> command is what you explicitly want to execute; the result is that you are given an interactive terminal session <em>within the container</em> as if you’d connected to it directly.</p></dd>
<dt><a class="co" id="callout_databases_CO2-2" href="#co_databases_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Connecting to the database within the container is as simple as using the MySQL CLI. You don’t need to reference a hostname as, within the container, you can connect directly to the exposed Unix socket.</p></dd>
<dt><a class="co" id="callout_databases_CO2-3" href="#co_databases_CO2-3"><img src="assets/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Creating a table and exiting out of the MySQL CLI is exactly the same as in the previous example.</p></dd>
<dt><a class="co" id="callout_databases_CO2-4" href="#co_databases_CO2-4"><img src="assets/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Once you’ve exited out of the CLI, you still need to exit out of the interactive <code>bash</code> session within the Docker container to return to your main terminal.</p></dd>
</dl></div>

<p>There are two primary advantages of using PDO to connect to a database instead of a direct functional interface to the drivers:</p>
<ol>
<li>
<p>The PDO interfaces are the same for every database technology. While you might need to refactor specific queries to fit one database engine or another (compare the <code>CREATE TABLE</code> syntax of this Solution to that in <a data-type="xref" href="#recipe_sqlite">Recipe 16.5</a>), you don’t need to refactor the PHP code around connections, statement executions, or query processing. PDO is a data-access abstraction layer, giving you the same mode of access and management regardless of the database you happen to be using within your application.</p>
</li>
<li>
<p>PDO supports the use of <em>persistent connections</em> by passing <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="persistent connections" id="idm45875138111968"></a><a data-type="indexterm" data-primary="persistent connections" id="idm45875138110960"></a>a truthy value to the <code>PDO::ATTR_PERSISTENT</code> key as an option when opening a connection. A persistent connection will be opened <em>and remain open</em> even after the <code>PDO</code> instance goes out of scope and your script finishes executing. When PHP attempts to reopen the connection, the system will instead look for a preexisting connection and reuse that if it exists. This helps improve the performance of long-running, 
<span class="keep-together">multitenant</span> applications, where opening multiple, redundant connections would otherwise harm the database itself. (For more on persistent database connections, review <a href="https://oreil.ly/_nHH-">the PHP Manual’s comprehensive documentation</a>.)</p>
</li>

</ol>

<p>Beyond these two advantages, PDO also <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="external database provider connection" data-startref="pdpdxv" id="idm45875138106720"></a><a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="as abstraction layer" data-startref="phpdjby" id="idm45875138105408"></a><a data-type="indexterm" data-primary="databases" data-secondary="external, PDO connection and" data-startref="dbsxlpdn" id="idm45875138104192"></a><a data-type="indexterm" data-primary="MySQL database" data-startref="mysqbs" id="idm45875138102960"></a>supports the concept of prepared statements, which help reduce the risk of malicious SQL injection. For more on prepared statements, review <a data-type="xref" href="#recipe_pdo_sanitization">Recipe 16.7</a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875138408448">
<h2>See Also</h2>

<p>Full documentation on the <a href="https://oreil.ly/_6%E2%80%94%E2%80%8BV">PDO extension</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.7 Sanitizing User Input for a Database Query"><div class="sect1" id="recipe_pdo_sanitization">
<h1>16.7 Sanitizing User Input for a Database Query</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875138097104">
<h2>Problem</h2>

<p>You want to pass user input into a <a data-type="indexterm" data-primary="sanitizing user input" data-secondary="database queries" id="stzupqi"></a><a data-type="indexterm" data-primary="user input" data-secondary="sanitizing" data-tertiary="database queries" id="uputzbq"></a><a data-type="indexterm" data-primary="databases" data-secondary="queries, sanitizing user input" id="dbqzusp"></a><a data-type="indexterm" data-primary="queries, sanatizing user input" id="qruputz"></a>database query but don’t fully trust the user input to not be malicious.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875138090464">
<h2>Solution</h2>

<p>Leverage prepared statements in PDO to automatically <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="sanitizing user input" id="pdpzuu"></a>sanitize user input before it passes into the query as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Database</code><code class="p">();</code>

<code class="nv">$insert_query</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">INSERT IGNORE INTO users (first_name, last_name, email)</code>
<code class="s">VALUES (:first_name, :last_name, :email);</code>
<code class="s">SQL;</code>

<code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$insert_query</code><code class="p">);</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code>
    <code class="s1">'first_name'</code> <code class="o">=&gt;</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'first'</code><code class="p">],</code>
    <code class="s1">'last_name'</code>  <code class="o">=&gt;</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'last'</code><code class="p">],</code>
    <code class="s1">'email'</code>      <code class="o">=&gt;</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'email'</code><code class="p">]</code>
<code class="p">]);</code>

<code class="k">foreach</code><code class="p">(</code><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="s1">'SELECT * from users;'</code><code class="p">)</code> <code class="k">as</code> <code class="nv">$row</code><code class="p">)</code> <code class="p">{</code>
    <code class="nb">var_dump</code><code class="p">(</code><code class="nv">$row</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875138022080">
<h2>Discussion</h2>

<p>The concept of sanitizing user input was discussed earlier as part of <a data-type="xref" href="ch09.html#recipe_sanitize_input">Recipe 9.1</a>, which used explicit filters to sanitize/validate potentially untrusted input. While that approach is quite effective, it’s also easy for developers to forget to include a sanitization filter on user input down the road when making updates. As a result, it’s far safer to explicitly prepare queries for execution to prevent malicious SQL injection.</p>

<p>Consider a query used to look up user data to display profile information. Such a query might leverage user email addresses as indexes to distinguish one user from another in an attempt to only display the current user’s information. For example:</p>

<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">users</code> <code class="k">WHERE</code> <code class="n">email</code> <code class="o">=</code> <code class="o">?</code><code class="p">;</code></pre>

<p>In PHP, you’ll want to pass in the current user’s email address so the query operates effectively. A naive approach using PDO might look something like <a data-type="xref" href="#query_with_interpolation">Example 16-3</a>.</p>
<div id="query_with_interpolation" data-type="example">
<h5><span class="label">Example 16-3. </span>Simple query with string interpolation</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Database</code><code class="p">();</code>

<code class="nv">$statement</code> <code class="o">=</code> <code class="s2">"SELECT * FROM users WHERE email = '</code><code class="si">{</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'email'</code><code class="p">]</code><code class="si">}</code><code class="s2">';"</code><code class="p">;</code>

<code class="nv">$results</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$statement</code><code class="p">);</code>
<code class="nb">var_dump</code><code class="p">(</code><code class="nv">$results</code><code class="p">);</code></pre></div>

<p>If the user is only submitting their own username (say, <code>eric@phpcookbook.local</code>), then this query will return the appropriate data for that user. There’s no guarantee the end user is trustworthy, though, and they might submit a malicious statement instead in <a data-type="indexterm" data-primary="databases" data-secondary="statements, injecting" id="idm45875137992240"></a>the hopes of <em>injecting</em> an arbitrary statement into your database engine. Knowing how the submitted email address is interpolated into the SQL statement, an attacker could submit <code>' OR 1=1;--</code> instead.</p>

<p>This string will complete the quotes (<code>WHERE email = ''</code>), add a composite Boolean statement that matches <em>any</em> result (<code>OR 1=1</code>), and explicitly comment out any additional characters that follow. The result is that your query will return the data for <em>all</em> users rather than the single user who made the request.</p>

<p>Similarly, malicious users could use the same <a data-type="indexterm" data-primary="SQL (Structured Query Language)" data-secondary="INSERT statements" id="idm45875137962912"></a>approach to inject arbitrary <code>INSERT</code> statements (writing new data) where you expected only to read information. They could also illicitly update existing data, delete fields, or otherwise corrupt the reliability of your data store.</p>

<p>SQL injection is incredibly dangerous. It’s also remarkably common in the software world—so much so that injection is recognized as the <a href="https://oreil.ly/Cveyu">third most commonly encountered application security risk by the Open Worldwide Application Security Project (OWASP) Top Ten project</a>.</p>

<p>Luckily, in PHP, injection is also easy to thwart!</p>

<p>The Solution example introduces PDO’s <em>prepared statements</em> interface. Rather than interpolating a string with user-provided <a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="prepared statements" id="idm45875137959104"></a>data, you insert named placeholders into the query. These placeholders should be prefixed with a single colon and can be any valid name you can imagine. When the query is run against the database, PDO will replace these placeholders with literal values passed in at runtime.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>It is also possible to use the question mark character as a placeholder and pass values into the prepared statement based on their position within a simple array. However, the position of elements is easy to confuse during later refactoring, and using this simpler approach is highly inadvisable. Take care to always use named parameters when preparing statements to avoid confusion and to future-proof your code.</p>
</div>

<p>Prepared statements work with both data manipulation statements (insert, update, delete) and arbitrary queries. Using prepared statements, the simple query from <a data-type="xref" href="#query_with_interpolation">Example 16-3</a> could be rewritten as <a data-type="xref" href="#query_with_preparation">Example 16-4</a>.</p>
<div id="query_with_preparation" data-type="example">
<h5><span class="label">Example 16-4. </span>Simple query with prepared statements</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Database</code><code class="p">();</code>

<code class="nv">$query</code> <code class="o">=</code> <code class="s2">"SELECT * FROM users WHERE email = :email;"</code><code class="p">;</code>
<code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code><code class="s1">'email'</code> <code class="o">=&gt;</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'email'</code><code class="p">]]);</code>

<code class="nv">$results</code> <code class="o">=</code> <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">();</code>
<code class="nb">var_dump</code><code class="p">(</code><code class="nv">$results</code><code class="p">);</code></pre></div>

<p>This code leverages PDO to automatically escape user input and pass the value as a literal one to the database engine. If the user had in fact submitted their email address, the query would function as expected and return the anticipated result.</p>

<p>If the user instead submitted a malicious payload (e.g., <code>' OR 1=1;--</code>, as previously discussed), the statement preparation will explicitly escape the passed quote characters before passing them to the database. This would have the result of looking for an email address that exactly matches the malicious payload (and does not exist), yielding zero <a data-type="indexterm" data-primary="sanitizing user input" data-secondary="database queries" data-startref="stzupqi" id="idm45875137799760"></a><a data-type="indexterm" data-primary="user input" data-secondary="sanitizing" data-tertiary="database queries" data-startref="uputzbq" id="idm45875137798640"></a><a data-type="indexterm" data-primary="databases" data-secondary="queries, sanitizing user input" data-startref="dbqzusp" id="idm45875137761520"></a><a data-type="indexterm" data-primary="queries, sanatizing user input" data-startref="qruputz" id="idm45875137760336"></a><a data-type="indexterm" data-primary="PDO (PHP Data Objects)" data-secondary="sanitizing user input" data-startref="pdpzuu" id="idm45875137759424"></a>results of user data.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875138021488">
<h2>See Also</h2>

<p>Documentation on PDO’s <a href="https://oreil.ly/q3DCh"><code>prepare()</code> method</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.8 Mocking Data for Integration Testing with 
a Database"><div class="sect1" id="recipe_data_mocking">
<h1>16.8 Mocking Data for Integration Testing with 
<span class="keep-together">a Database</span></h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875137716352">
<h2>Problem</h2>

<p>You want to leverage a database <a data-type="indexterm" data-primary="databases" data-secondary="integration testing, mocking data" id="dtbgttkdb"></a><a data-type="indexterm" data-primary="integration testing, mocking databases" id="igrtgkd"></a>for production storage but mock that database interface when running automated tests against your application.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875137712384">
<h2>Solution</h2>

<p>Use the repository pattern as <a data-type="indexterm" data-primary="repository interface" id="idm45875137710848"></a><a data-type="indexterm" data-primary="data abstraction" id="dbscton"></a>an abstraction between your business logic and database persistence. For example, define a repository interface as shown in <a data-type="xref" href="#data_repository_interface">Example 16-5</a>.</p>
<div id="data_repository_interface" data-type="example">
<h5><span class="label">Example 16-5. </span>Data repository interface definition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">interface</code> <code class="nx">BookRepository</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">getById</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$bookId</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code><code class="p">;</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">list</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code><code class="p">;</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code><code class="p">;</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">delete</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code><code class="p">;</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">save</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code><code class="p">;</code>
<code class="p">}</code></pre></div>

<p>Then, use the preceding interface to define a concrete database implementation (leveraging something like PDO). Use the same interface to define a mock implementation that returns predictable, static data rather than live data from a remote system. See <a data-type="xref" href="#repository_interface_implementation">Example 16-6</a>.</p>
<div id="repository_interface_implementation" data-type="example">
<h5><span class="label">Example 16-6. </span>Repository interface implementation with mock data</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">MockRepository</code> <code class="k">implements</code> <code class="nx">BookRepository</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="k">array</code> <code class="nv">$books</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code> <code class="o">=</code> <code class="p">[</code>
            <code class="k">new</code> <code class="nx">Book</code><code class="p">(</code><code class="nx">id</code><code class="o">:</code> <code class="mi">0</code><code class="p">),</code>
            <code class="k">new</code> <code class="nx">Book</code><code class="p">(</code><code class="nx">id</code><code class="o">:</code> <code class="mi">1</code><code class="p">),</code>
            <code class="k">new</code> <code class="nx">Book</code><code class="p">(</code><code class="nx">id</code><code class="o">:</code> <code class="mi">2</code><code class="p">)</code>
        <code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">getById</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$bookId</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">[</code><code class="nv">$bookId</code><code class="p">];</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">list</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">=</code> <code class="nb">end</code><code class="p">(</code><code class="nb">array_keys</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">))</code> <code class="o">+</code> <code class="mi">1</code><code class="p">;</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">[]</code> <code class="o">=</code> <code class="nv">$book</code><code class="p">;</code>

        <code class="k">return</code> <code class="nv">$book</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">delete</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nb">unset</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">[</code><code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">save</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">books</code><code class="p">[</code><code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$book</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875137682192">
<h2>Discussion</h2>

<p>The Solution example introduces a simple way to separate your business logic from your data layer via an abstraction. By leveraging a data <em>repository</em> to wrap the database layer, you can ship multiple implementations of the same interface. In a production application, your actual repository might look something like <a data-type="xref" href="#repository_implementation">Example 16-7</a>.</p>
<div id="repository_implementation" data-type="example">
<h5><span class="label">Example 16-7. </span>Concrete database implementation of a repository interface</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">DatabaseRepository</code> <code class="k">implements</code> <code class="nx">BookRepository</code>
<code class="p">{</code>
    <code class="k">private</code> <code class="nx">PDO</code> <code class="nv">$dbh</code><code class="p">;</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$config</code> <code class="o">=</code> <code class="s1">'database.ini'</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="nv">$settings</code> <code class="o">=</code> <code class="nb">parse_ini_file</code><code class="p">(</code><code class="nv">$config</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>

        <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nv">$settings</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">RuntimeException</code><code class="p">(</code><code class="s2">"Error reading config: `</code><code class="si">{</code><code class="nv">$config</code><code class="si">}</code><code class="s2">`."</code><code class="p">);</code>
        <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">array_key_exists</code><code class="p">(</code><code class="s1">'database'</code><code class="p">,</code> <code class="nv">$settings</code><code class="p">))</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="k">new</code> <code class="nx">RuntimeException</code><code class="p">(</code><code class="s2">"Invalid config: `</code><code class="si">{</code><code class="nv">$config</code><code class="si">}</code><code class="s2">`."</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="nv">$db</code> <code class="o">=</code> <code class="nv">$settings</code><code class="p">[</code><code class="s1">'database'</code><code class="p">];</code>
        <code class="nv">$port</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'port'</code><code class="p">]</code> <code class="o">??</code> <code class="mi">3306</code><code class="p">;</code>
        <code class="nv">$driver</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'driver'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">'mysql'</code><code class="p">;</code>
        <code class="nv">$host</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'host'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">''</code><code class="p">;</code>
        <code class="nv">$schema</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'schema'</code><code class="p">]</code> <code class="o">??</code> <code class="s1">''</code><code class="p">;</code>
        <code class="nv">$username</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'username'</code><code class="p">]</code> <code class="o">??</code> <code class="k">null</code><code class="p">;</code>
        <code class="nv">$password</code> <code class="o">=</code> <code class="nv">$db</code><code class="p">[</code><code class="s1">'password'</code><code class="p">]</code> <code class="o">??</code> <code class="k">null</code><code class="p">;</code>

        <code class="nv">$port</code> <code class="o">=</code> <code class="k">empty</code><code class="p">(</code><code class="nv">$port</code><code class="p">)</code> <code class="o">?</code> <code class="s1">''</code> <code class="o">:</code> <code class="s2">";port=</code><code class="si">{</code><code class="nv">$port</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>
        <code class="nv">$dsn</code> <code class="o">=</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$driver</code><code class="si">}</code><code class="s2">:host=</code><code class="si">{</code><code class="nv">$host</code><code class="si">}{</code><code class="nv">$port</code><code class="si">}</code><code class="s2">;dbname=</code><code class="si">{</code><code class="nv">$schema</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PDO</code><code class="p">(</code><code class="nv">$dsn</code><code class="p">,</code> <code class="nv">$username</code><code class="p">,</code> <code class="nv">$password</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">getById</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$bookId</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="nv">$query</code> <code class="o">=</code> <code class="s1">'Select * from books where id = :id;'</code><code class="p">;</code>

        <code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
        <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code><code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="nv">$bookId</code><code class="p">]);</code>

        <code class="nv">$record</code> <code class="o">=</code> <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">();</code>
        <code class="k">if</code> <code class="p">(</code><code class="nv">$record</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">return</code> <code class="nx">Book</code><code class="o">::</code><code class="na">fromRecord</code><code class="p">(</code><code class="nv">$record</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">throw</code> <code class="k">new</code> <code class="nx">Exception</code><code class="p">(</code><code class="s1">'Book not found'</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">list</code><code class="p">()</code><code class="o">:</code> <code class="k">array</code>
    <code class="p">{</code>
        <code class="nv">$books</code> <code class="o">=</code> <code class="p">[];</code>

        <code class="nv">$records</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="s1">'select * from books;'</code><code class="p">);</code>
        <code class="k">foreach</code><code class="p">(</code><code class="nv">$record</code> <code class="k">as</code> <code class="nv">$book</code><code class="p">)</code> <code class="p">{</code>
            <code class="nv">$books</code><code class="p">[]</code> <code class="o">=</code> <code class="nx">Book</code><code class="o">::</code><code class="na">fromRecord</code><code class="p">(</code><code class="nv">$book</code><code class="p">);</code>
        <code class="p">}</code>

        <code class="k">return</code> <code class="nv">$books</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">add</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="nv">$query</code> <code class="o">=</code> <code class="s1">'insert into books (title, author) values (:title, :author);'</code><code class="p">;</code>

        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">beginTransaction</code><code class="p">();</code>
        <code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
        <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code>
            <code class="s1">'title'</code>  <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">title</code><code class="p">,</code>
            <code class="s1">'author'</code> <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">author</code><code class="p">,</code>
        <code class="p">]);</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">commit</code><code class="p">();</code>

        <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">lastInsertId</code><code class="p">();</code>

        <code class="k">return</code> <code class="nv">$book</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">delete</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">void</code>
    <code class="p">{</code>
        <code class="nv">$query</code> <code class="o">=</code> <code class="s1">'delete from books where id = :id'</code><code class="p">;</code>

        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">beginTransaction</code><code class="p">();</code>
        <code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
        <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code><code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">]);</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">commit</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="nf">save</code><code class="p">(</code><code class="nx">Book</code> <code class="nv">$book</code><code class="p">)</code><code class="o">:</code> <code class="nx">Book</code>
    <code class="p">{</code>
        <code class="nv">$query</code> <code class="o">=</code>
            <code class="s1">'update books set title = :title, author = :author where id = :id;'</code><code class="p">;</code>

        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">beginTransaction</code><code class="p">();</code>
        <code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="nv">$query</code><code class="p">);</code>
        <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">([</code>
            <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">title</code><code class="p">,</code>
            <code class="s1">'author'</code> <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">author</code><code class="p">,</code>
            <code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="nv">$book</code><code class="o">-&gt;</code><code class="na">id</code>
        <code class="p">]);</code>
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">dbh</code><code class="o">-&gt;</code><code class="na">commit</code><code class="p">();</code>

        <code class="k">return</code> <code class="nv">$book</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p><a data-type="xref" href="#repository_implementation">Example 16-7</a> implements the same interface as the mock repository from the Solution example, except it connects to a live MySQL database and manipulates data in that separate system. In reality, your production code will use <em>this</em> implementation rather than the mock instance. But when running under test, you can easily swap the <code>DatabaseRepository</code> for a <code>MockRepository</code> instance so long as your business logic is expecting a class that implements <code>BookRepository</code>.</p>

<p>Assume you’re working with the <a href="https://symfony.com">Symfony framework</a>. Your application will be built upon controllers that leverage dependency injection to handle external integrations. For a library API that manages multiple books, you might define a <code>BookController</code> that looks something like the following:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">BookController</code> <code class="k">extends</code> <code class="nx">AbstractController</code>
<code class="p">{</code>
    <code class="c1">#[Route('/book/{id}', name: 'book_show')]</code>
    <code class="k">public</code> <code class="k">function</code> <code class="nf">show</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$id</code><code class="p">,</code> <code class="nx">BookRepository</code> <code class="nv">$repo</code><code class="p">)</code><code class="o">:</code> <code class="nx">Response</code>
    <code class="p">{</code>
        <code class="nv">$book</code> <code class="o">=</code> <code class="nv">$repo</code><code class="o">-&gt;</code><code class="na">getById</code><code class="p">(</code><code class="nv">$id</code><code class="p">);</code>

        <code class="c1">// ...</code>
    <code class="p">}</code>
<code class="p">}</code></pre>

<p>The beauty of the preceding code is that the controller doesn’t care whether you pass it an instance of <code>MockRepository</code> or one of <code>DataRepository</code>. Both classes implement the same <code>BookRepository</code> interface <a data-type="indexterm" data-primary="getByID() method" id="idm45875137017840"></a>and expose a <code>getByID()</code> method with the same signature. To your business logic, the functionality is identical—except that with one, your application will reach out to a remote database to retrieve (and potentially) manipulate data, while the other uses a static, completely deterministic set of fake data.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The default data abstraction layer that <a data-type="indexterm" data-primary="Doctrine" id="idm45875137015712"></a>ships with Symfony is called <a href="https://oreil.ly/JvdG_">Doctrine</a> and leverages the repository pattern by default. Doctrine provides a rich abstraction layer across multiple SQL dialects, including MySQL, without the need to manually wire queries via PDO. It also ships with a command-line utility that automatically writes the PHP code for both stored objects (called <em>entities</em>) and repositories for you!</p>
</div>

<p>When it comes to writing tests, the deterministic and fake data is superior because it will always be the same and means your tests will be very reliable. It also means you won’t accidentally overwrite data in a real database if someone makes a minor configuration error locally.</p>

<p>An added advantage will be the speed at which your tests run. Mocked data interfaces remove the need to send data between your application and an independent database, significantly shortening the latency of any data-related function calls. That said, you will likely still want to flesh out a separate integration test suite to exercise those remote integrations, and you will require a real database to make that separate test <a data-type="indexterm" data-primary="databases" data-secondary="integration testing, mocking data" data-startref="dtbgttkdb" id="idm45875137012848"></a><a data-type="indexterm" data-primary="integration testing, mocking databases" data-startref="igrtgkd" id="idm45875137011632"></a><a data-type="indexterm" data-primary="data abstraction" data-startref="dbscton" id="idm45875137010720"></a>suite usable.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875137681600">
<h2>See Also</h2>

<p>Review <a data-type="xref" href="ch08.html#class_interfaces">Recipe 8.7</a> for more on classes, interfaces, and inheritance. See the Symfony documentation for more on <a href="https://oreil.ly/ucip3">controllers</a> and <a href="https://oreil.ly/WYpxe">dependency injection</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="16.9 Querying an SQL Database with the Eloquent ORM"><div class="sect1" id="recipe_eloquent_orm">
<h1>16.9 Querying an SQL Database with the Eloquent ORM</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875137004192">
<h2>Problem</h2>

<p>You want to manage your database <a data-type="indexterm" data-primary="databases" data-secondary="schema, Eloquent and" id="dbsceq"></a><a data-type="indexterm" data-primary="Eloquent, schema and" id="eqcmn"></a>schema and the data it contains without hand-writing SQL.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875136966800">
<h2>Solution</h2>

<p>Use Laravel’s default ORM, Eloquent, to define <a data-type="indexterm" data-primary="Laraval, Eloquent ORM" id="lrvlq"></a>your data objects and schema dynamically, as shown in <a data-type="xref" href="#eloquent_table_definition">Example 16-8</a>.</p>
<div id="eloquent_table_definition" data-type="example">
<h5><span class="label">Example 16-8. </span>Table definition for use with Laravel</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nx">Schema</code><code class="o">::</code><code class="na">create</code><code class="p">(</code><code class="s1">'books'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Blueprint</code> <code class="nv">$table</code><code class="p">)</code> <code class="p">{</code>
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">id</code><code class="p">();</code>
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'title'</code><code class="p">);</code>
    <code class="nv">$table</code><code class="o">-&gt;</code><code class="na">string</code><code class="p">(</code><code class="s1">'author'</code><code class="p">);</code>
<code class="p">});</code></pre></div>

<p>This code can be used to dynamically create a table to house books, regardless of the type of SQL used with Eloquent. Once the table exists, data within it can be modeled by Eloquent using the following class <a data-type="xref" href="#eloquent_model_definition">Example 16-9</a>.</p>
<div id="eloquent_model_definition" data-type="example">
<h5><span class="label">Example 16-9. </span>Eloquent model definition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">use</code> <code class="nx">Illuminate\Database\Eloquent\Model</code><code class="p">;</code>

<code class="k">class</code> <code class="nc">Book</code> <code class="k">extends</code> <code class="nx">Model</code>
<code class="p">{</code>
    <code class="k">use</code> <code class="nx">HasFactory</code><code class="p">;</code>

    <code class="k">public</code> <code class="nv">$timestamps</code> <code class="o">=</code> <code class="k">false</code><code class="p">;</code>
<code class="p">}</code></pre></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875136629264">
<h2>Discussion</h2>

<p>The Doctrine ORM, mentioned <a data-type="indexterm" data-primary="Doctrine ORM" id="idm45875136623408"></a>briefly in <a data-type="xref" href="#recipe_data_mocking">Recipe 16.8</a>, leverages the repository pattern to map objects stored in a database to their representation in business logic. This works well with the Symfony framework, but is merely one approach to modeling data in a real-world application.</p>

<p>The open source Laravel framework, which itself is built atop Symfony and other components, instead uses the <a href="https://oreil.ly/x7lcI">Eloquent ORM</a> to model data. Unlike Doctrine, Eloquent is based on the active record design pattern in which tables within the database are directly related to corresponding models used to represent that table. Rather than creating/reading/updating/deleting models through a separate repository, the modeled objects present their own methods for direct 
<span class="keep-together">manipulation</span>.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Some development teams can be quite opinionated about the design patterns they do and do not accept in a project. Despite the popularity of the Laravel framework, many developers consider the active record approach to data modeling to be an <em>antipattern</em>—that is, an approach to be avoided. Take care to ensure that your development team is on the same page regarding the abstractions you leverage in your project, as mixing multiple data access patterns can be confusing and will lead to serious maintenance woes down the line.</p>
</div>

<p>The model classes exposed by Eloquent are quite simple, as demonstrated by the terse illustration in the Solution example. However, they are quite dynamic—the actual properties of the model don’t need to be directly defined within the model class itself. Instead, Eloquent automatically reads and parses any columns and data types from the underlying table and adds these as properties to the model class when it’s 
<span class="keep-together">instantiated</span>.</p>

<p>The table in <a data-type="xref" href="#eloquent_table_definition">Example 16-8</a>, for example, defines three columns:</p>

<ul>
<li>
<p>An integer ID</p>
</li>
<li>
<p>A string title</p>
</li>
<li>
<p>A string author name</p>
</li>
</ul>

<p>When Eloquent reads this data directly, it effectively creates objects in PHP that look something like the following:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">Book</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="nx">int</code>    <code class="nv">$id</code><code class="p">;</code>
    <code class="k">public</code> <code class="nx">string</code> <code class="nv">$title</code><code class="p">;</code>
    <code class="k">public</code> <code class="nx">string</code> <code class="nv">$author</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>The <em>actual</em> class will present various additional methods, like <code>save()</code>, but otherwise contains a direct representation of the data as it appears within your SQL table. To create a new record in the database, rather than editing SQL directly, you would merely create a new object and save it as shown in <a data-type="xref" href="#create_object_eloquent">Example 16-10</a>.</p>
<div id="create_object_eloquent" data-type="example">
<h5><span class="label">Example 16-10. </span>Creating a database object with Eloquent</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$book</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Book</code><code class="p">;</code>
<code class="nv">$book</code><code class="o">-&gt;</code><code class="na">title</code> <code class="o">=</code> <code class="s1">'PHP Cookbook'</code><code class="p">;</code>
<code class="nv">$book</code><code class="o">-&gt;</code><code class="na">author</code> <code class="o">=</code> <code class="s1">'Eric Mann'</code><code class="p">;</code>

<code class="nv">$book</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">();</code></pre></div>

<p>Updating data is similarly simple: use Eloquent to retrieve the object you wish to change, make your changes in PHP, and then invoke the object’s <code>save()</code> method to persist your updates directly. <a data-type="xref" href="#update_in_place_eloquent">Example 16-11</a> updates objects in a database to replace one value in a particular field with another.</p>
<div id="update_in_place_eloquent" data-type="example">
<h5><span class="label">Example 16-11. </span>Updating an element in place with Eloquent</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nx">Book</code><code class="o">::</code><code class="na">where</code><code class="p">(</code><code class="s1">'author'</code><code class="p">,</code> <code class="s1">'Eric Mann'</code><code class="p">)</code>
    <code class="o">-&gt;</code><code class="na">update</code><code class="p">([</code><code class="s1">'author'</code><code class="p">,</code> <code class="s1">'Eric A Mann'</code><code class="p">]);</code></pre></div>

<p>The key advantage of using Eloquent is that you can work with your data objects as if they were native PHP objects without needing to write, manage, or maintain SQL statements by hand. The even more powerful feature of an ORM is that it handles escaping user input for you, meaning that the extra steps introduced in <a data-type="xref" href="#recipe_pdo_sanitization">Recipe 16.7</a> are no longer necessary.</p>

<p>Although directly leveraging SQL connections (with or without PDO) is a quick and effective way to start working with a <a data-type="indexterm" data-primary="databases" data-secondary="schema, Eloquent and" data-startref="dbsceq" id="idm45875136504656"></a><a data-type="indexterm" data-primary="Eloquent, schema and" data-startref="eqcmn" id="idm45875136467088"></a><a data-type="indexterm" data-primary="Laraval, Eloquent ORM" data-startref="lrvlq" id="idm45875136466144"></a>database, the sheer power of a fully featured ORM will make your application easier to work with. This is true both in terms of initial development and when it comes time to refactor.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875136464816">
<h2>See Also</h2>

<p>Documentation on <a href="https://oreil.ly/4J-Jz">Eloquent ORM</a>.</p>
</div></section>
</div></section>
</div></section></div>
</div>
</body>
</html>