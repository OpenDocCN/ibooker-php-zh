<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xml:lang="en"
      lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<title>PHP Cookbook</title>
<link rel="stylesheet" type="text/css" href="override_v1.css"/>
<link rel="stylesheet" type="text/css" href="epub.css"/>
</head>
<body>
<div id="book-content">
<div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 12. Error Handling"><div class="chapter" id="chapter_errors">
<h1><span class="label">Chapter 12. </span>Error Handling</h1>

<blockquote>
<p>The best laid plans of mice and men often go awry.</p>
<p data-type="attribution">adapted from Robert Burns</p>
</blockquote>

<p>If you work in programming or software development, you’re probably very familiar with bugs and the process of debugging. You might have even spent as much time, if not more, tracking down bugs as you do writing code in the first place. It’s an unfortunate maxim of software—no matter how hard a team works to build correct software, there will inevitably be a failure that needs to be identified and corrected.</p>

<p>Luckily, PHP makes finding bugs relatively straightforward. The forgiving nature of the language often also renders a bug a nuisance rather than a fatal flaw.</p>

<p>The following recipes introduce the quickest and easiest way to identify and handle bugs in your code. They also detail how to both code and handle custom exceptions thrown by your code in the event of invalid data output by a third-party API or other incorrect system behavior.</p>






<section data-type="sect1" data-pdf-bookmark="12.1 Finding and Fixing Parse Errors"><div class="sect1" id="idm45875145170944">
<h1>12.1 Finding and Fixing Parse Errors</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875145169584">
<h2>Problem</h2>

<p>The PHP compiler has failed to parse a script within your application; you want to find and correct the problem quickly.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875145168000">
<h2>Solution</h2>

<p>Open the offending file in a text editor and review the line called out by the parser for syntax errors. If the problem isn’t immediately apparent, walk backwards through the code one line at a time until you find the problem and make corrections in the file.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875145166416">
<h2>Discussion</h2>

<p>PHP is a relatively forgiving language and will often attempt to let even an incorrect or problematic script run to completion. In many situations, though, the parser cannot properly interpret a line of code to identify what should be done and will instead return an error.</p>

<p>As a contrived example, loop through Western states in the US:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$states</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Washington'</code><code class="p">,</code> <code class="s1">'Oregon'</code><code class="p">,</code> <code class="s1">'California'</code><code class="p">];</code>
<code class="k">foreach</code> <code class="nv">$states</code> <code class="k">as</code> <code class="nv">$state</code> <code class="p">{</code>
    <code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="si">{</code><code class="nv">$state</code><code class="si">}</code><code class="s2"> is on the West coast."</code><code class="p">)</code> <code class="o">.</code> <code class="nx">PHP_EOL</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This code, when run in a PHP interpreter, will throw a <code>Parse error</code> on the second line:</p>

<pre data-type="programlisting">PHP Parse error:  syntax error, unexpected variable "$states", expecting "("
in php shell code on line 2</pre>

<p>Based on this error message alone, you can zero in on the offending line. Remember that, though <code>foreach</code> is a language construct, it is still written similar to a function call with parentheses. The correct way to iterate through the array of states would be as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$states</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Washington'</code><code class="p">,</code> <code class="s1">'Oregon'</code><code class="p">,</code> <code class="s1">'California'</code><code class="p">];</code>
<code class="k">foreach</code> <code class="p">(</code><code class="nv">$states</code> <code class="k">as</code> <code class="nv">$state</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">print</code><code class="p">(</code><code class="s2">"</code><code class="si">{</code><code class="nv">$state</code><code class="si">}</code><code class="s2"> is on the West coast."</code><code class="p">)</code> <code class="o">.</code> <code class="nx">PHP_EOL</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>This particular error—omitting parentheses while leveraging language constructs—is common among developers frequently moving between languages. The same mechanism in Python, for example, looks nearly the same but is syntactically correct when omitting the parentheses on the <code>foreach</code> call. For example:</p>

<pre data-type="programlisting" data-code-language="python"><code class="n">states</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'Washington'</code><code class="p">,</code> <code class="s1">'Oregon'</code><code class="p">,</code> <code class="s1">'California'</code><code class="p">]</code>
<code class="k">for</code> <code class="n">state</code> <code class="ow">in</code> <code class="n">states</code><code class="p">:</code>
    <code class="nb">print</code><code class="p">(</code><code class="sa">f</code><code class="s2">"</code><code class="si">{</code><code class="n">state</code><code class="si">}</code><code class="s2"> is on the West coast."</code><code class="p">)</code></pre>

<p>The syntax of the two languages is confusingly similar. Thankfully, they are different enough that each language’s parser will catch these differences and alert you, should you make such a mistake when moving back and forth between projects.</p>

<p>Conveniently, IDEs like <a href="https://oreil.ly/CkzbA">Visual Studio Code</a> automatically parse your script and highlight any syntax errors for you. <a data-type="xref" href="#vscode_parser_error">Figure 12-1</a> illustrates how this highlighting makes it relatively easy to track down and correct issues before your application ever runs.</p>

<figure><div id="vscode_parser_error" class="figure">
<img src="assets/phpc_1201.png" alt="Visual Studio Code identifies and highlights syntax errors before your application runs" width="453" height="170"/>
<h6><span class="label">Figure 12-1. </span>Visual Studio Code identifies and highlights syntax errors before your application runs</h6>
</div></figure>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875145165792">
<h2>See Also</h2>

<p>The <a href="https://oreil.ly/Zw_1I">list of tokens</a>, various parts of the source code, used by the PHP parser.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="12.2 Creating and Handling Custom Exceptions"><div class="sect1" id="custom_exceptions">
<h1>12.2 Creating and Handling Custom Exceptions</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875144721408">
<h2>Problem</h2>

<p>You want your application to throw (and catch) a custom exception when things go wrong.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875144719824">
<h2>Solution</h2>

<p>Extend the base <code>Exception</code> class to introduce custom behavior, then leverage <code>try</code>/<code>catch</code> blocks to capture and handle exceptions.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875144716928">
<h2>Discussion</h2>

<p>PHP defines a basic <a href="https://oreil.ly/NkLuC"><code>Throwable</code></a> interface implemented by any kind of error or exception in the language. Internal issues are then represented by the <a href="https://oreil.ly/eFMGz"><code>Error</code></a> class and its descendants, while problems in userland are represented by the <code>Exception</code> class and its descendants.</p>

<p>Generally, you will only ever be extending the <code>Exception</code> class within your application, but you can catch any <code>Throwable</code> implementation within a standard <code>try</code>/<code>catch</code> block.</p>

<p>For example, assume you are implementing a division function with very precise, custom functionality:</p>
<ol>
<li>
<p>Division by 0 is not allowed.</p>
</li>
<li>
<p>All decimal values will be rounded down.</p>
</li>
<li>
<p>The integer 42 is never valid as a numerator.</p>
</li>
<li>
<p>The numerator must be an integer, but the denominator can also be a float.</p>
</li>

</ol>

<p>Such a function might leverage built-in errors like <code>ArithmeticError</code> or <code>DivisionByZeroError</code>. But in the preceding list of rules, the third stands out as requiring a custom exception. Before defining your function, you would define a custom exception as in <a data-type="xref" href="#custom_hitchhiker_exception">Example 12-1</a>.</p>
<div id="custom_hitchhiker_exception" data-type="example">
<h5><span class="label">Example 12-1. </span>Simple custom exception definition</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">HitchhikerException</code> <code class="k">extends</code> <code class="nx">Exception</code>
<code class="p">{</code>
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$code</code> <code class="o">=</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">Throwable</code> <code class="nv">$previous</code> <code class="o">=</code> <code class="k">null</code><code class="p">)</code>
    <code class="p">{</code>
        <code class="k">parent</code><code class="o">::</code><code class="na">__construct</code><code class="p">(</code><code class="s1">'42 is indivisible.'</code><code class="p">,</code> <code class="nv">$code</code><code class="p">,</code> <code class="nv">$previous</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="k">public</code> <code class="k">function</code> <code class="fm">__toString</code><code class="p">()</code>
    <code class="p">{</code>
        <code class="k">return</code> <code class="vm">__CLASS__</code> <code class="o">.</code> <code class="s2">": [</code><code class="si">{</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">code</code><code class="si">}</code><code class="s2">]: </code><code class="si">{</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">message</code><code class="si">}</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">}</code></pre></div>

<p>Once the custom exception exists, you can <code>throw</code> it within your custom division function as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">divide</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$numerator</code><code class="p">,</code> <code class="nx">float</code><code class="o">|</code><code class="nx">int</code> <code class="nv">$denominator</code><code class="p">)</code><code class="o">:</code> <code class="nx">int</code>
<code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nv">$denominator</code> <code class="o">===</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">DivisionByZeroError</code><code class="p">;</code>
    <code class="p">}</code> <code class="k">elseif</code> <code class="p">(</code><code class="nv">$numerator</code> <code class="o">===</code> <code class="mi">42</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">throw</code> <code class="k">new</code> <code class="nx">HitchhikerException</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="nb">floor</code><code class="p">(</code><code class="nv">$numerator</code> <code class="o">/</code> <code class="nv">$denominator</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>Once you’ve defined your custom functionality, it’s a matter of leveraging that code in an application. You know the function <em>could</em> throw an error, so it’s important to wrap any invocation in a <code>try</code> statement and handle that error appropriately. <a data-type="xref" href="#division_error_handling">Example 12-2</a> will iterate through four pairs of numbers, attempting division on each, and handling any subsequent errors/exceptions thrown.</p>
<div id="division_error_handling" data-type="example">
<h5><span class="label">Example 12-2. </span>Handling errors in custom division</h5>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$pairs</code><code> </code><code class="o">=</code><code> </code><code class="p">[</code><code>
    </code><code class="p">[</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">],</code><code>
    </code><code class="p">[</code><code class="mi">2</code><code class="p">,</code><code> </code><code class="mi">5</code><code class="p">],</code><code>
    </code><code class="p">[</code><code class="mi">10</code><code class="p">,</code><code> </code><code class="mi">0</code><code class="p">],</code><code>
    </code><code class="p">[</code><code class="mi">42</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">]</code><code>
</code><code class="p">];</code><code>

</code><code class="k">foreach</code><code> </code><code class="p">(</code><code class="nv">$pairs</code><code> </code><code class="k">as</code><code> </code><code class="nv">$pair</code><code class="p">)</code><code> </code><code class="p">{</code><code>
    </code><code class="k">try</code><code> </code><code class="p">{</code><code>
        </code><code class="k">echo</code><code> </code><code class="nx">divide</code><code class="p">(</code><code class="nv">$pair</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code><code> </code><code class="nv">$pair</code><code class="p">[</code><code class="mi">1</code><code class="p">])</code><code> </code><code class="o">.</code><code> </code><code class="nx">PHP_EOL</code><code class="p">;</code><code>
    </code><code class="p">}</code><code> </code><code class="k">catch</code><code> </code><code class="p">(</code><code class="nx">HitchhikerException</code><code> </code><code class="nv">$he</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" id="co_error_handling_CO1-1" href="#callout_error_handling_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>
        </code><code class="k">echo</code><code> </code><code class="s1">'Invalid division of 42!'</code><code> </code><code class="o">.</code><code> </code><code class="nx">PHP_EOL</code><code class="p">;</code><code>
    </code><code class="p">}</code><code> </code><code class="k">catch</code><code> </code><code class="p">(</code><code class="nx">Throwable</code><code> </code><code class="nv">$t</code><code class="p">)</code><code> </code><code class="p">{</code><code> </code><a class="co" id="co_error_handling_CO1-2" href="#callout_error_handling_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a><code>
        </code><code class="k">echo</code><code> </code><code class="s1">'Look, a rabid marmot!'</code><code> </code><code class="o">.</code><code> </code><code class="nx">PHP_EOL</code><code class="p">;</code><code>
    </code><code class="p">}</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_error_handling_CO1-1" href="#co_error_handling_CO1-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>If 42 is ever passed as a numerator, the <code>divide()</code> function will throw a <code>Hitchhi⁠ker​Exception</code> and fail to recover. Capturing this exception allows you to provide feedback either to the application or to the user and move on.</p></dd>
<dt><a class="co" id="callout_error_handling_CO1-2" href="#co_error_handling_CO1-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Any other <code>Error</code> or <code>Exception</code> thrown by the function will be caught as an implementation of <code>Throwable</code>. In this case, you’re throwing that error away and moving on.</p></dd>
</dl></div>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875144716304">
<h2>See Also</h2>

<p>Documentation on the following:</p>

<ul>
<li>
<p>The base <a href="https://oreil.ly/2s4mN"><code>Exception</code> class</a></p>
</li>
<li>
<p>The list of <a href="https://oreil.ly/TdeGN">predefined exceptions</a></p>
</li>
<li>
<p>Additional exceptions <a href="https://oreil.ly/GSDEg">as defined by the Standard PHP Library (SPL)</a></p>
</li>
<li>
<p><a href="https://oreil.ly/-jrVt">Creating custom exceptions through extension</a></p>
</li>
<li>
<p>The <a href="https://oreil.ly/KF1Zd">error hierarchy as of PHP 7</a></p>
</li>
</ul>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="12.3 Hiding Error Messages from End Users"><div class="sect1" id="idm45875144312032">
<h1>12.3 Hiding Error Messages from End Users</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875144310912">
<h2>Problem</h2>

<p>You’ve fixed all of the bugs you know of and are ready to launch your application in production. But you also want to prevent any new errors from being displayed to end users.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875144309520">
<h2>Solution</h2>

<p>To completely suppress errors in production, set both the <code>error_reporting</code> and <code>dis⁠play_​errors</code> directives in <em>php.ini</em> to <code>Off</code> as follows:</p>

<pre data-type="programlisting" data-code-language="ini"><code class="c1">; Disable error reporting</code>
<code class="na">error_reporting</code> <code class="o">=</code> <code class="s">Off</code>
<code class="na">display_errors</code>  <code class="o">=</code> <code class="s">Off</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875144289680">
<h2>Discussion</h2>

<p>The configuration change presented in the Solution example will impact your entire application. Errors will be entirely suppressed and, even if they were to be thrown, will never be displayed to an end user. It’s considered bad practice to present errors or unhandled exceptions directly to users. It might also lead to security issues if stack traces are presented directly to end users of the application.</p>

<p>However, if your application is misbehaving, nothing will be logged for the development team to diagnose and address.</p>

<p>For a production instance, leaving <code>display_errors</code> set to <code>Off</code> will still hide errors from end users, but reverting to the default <code>error_reporting</code> level will reliably send any errors to the logs.</p>

<p>There might be specific pages with known errors (due to legacy code, poorly written dependencies, or known technical debt) that you wish to omit, though. In those situations you can <em>programmatically</em> set the error reporting level by using the <code>error_​reporting()</code> function in PHP. This function accept a new error reporting level and returns whatever level was previously set (the default if not previously configured).</p>

<p>As a result, you can use calls to <code>error_reporting()</code> to wrap problematic blocks of code and prevent too-chatty errors from being presented in the logs. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$error_level</code><code> </code><code class="o">=</code><code> </code><code class="nb">error_reporting</code><code class="p">(</code><code class="k">E_ERROR</code><code class="p">);</code><code> </code><a class="co" id="co_error_handling_CO2-1" href="#callout_error_handling_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a><code>

</code><code class="c1">// ... Call your other application code here.
</code><code>
</code><code class="nb">error_reporting</code><code class="p">(</code><code class="nv">$error_level</code><code class="p">);</code><code> </code><a class="co" id="co_error_handling_CO2-2" href="#callout_error_handling_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_error_handling_CO2-1" href="#co_error_handling_CO2-1"><img src="assets/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Set the error level to the absolute minimum, including only fatal runtime errors that halt script execution.</p></dd>
<dt><a class="co" id="callout_error_handling_CO2-2" href="#co_error_handling_CO2-2"><img src="assets/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Return the error level to its previous state.</p></dd>
</dl>

<p>The default error level is <code>E_ALL</code>, which presents all errors, warnings, and notices.<sup><a data-type="noteref" id="idm45875144247792-marker" href="ch12.html#idm45875144247792">1</a></sup> You can use integer reporting levels to override this, but PHP presents several named 
<span class="keep-together">constants</span> that represent each potential setting. These constants are enumerated in <a data-type="xref" href="#error_reporting_levels">Table 12-1</a>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Prior to PHP 8.0, the default error reporting level started with <code>E_ALL</code> and then explicitly removed diagnostic notices (<code>E_NOTICE</code>), strict type warnings (<code>E_STRICT</code>), and deprecation notices (
<span class="keep-together"><code>E_DEPRECATED</code></span>).</p>
</div>
<table id="error_reporting_levels">
<caption><span class="label">Table 12-1. </span>Error reporting level constants</caption>
<thead>
<tr>
<th>Integer value</th>
<th>Constant</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>1</p></td>
<td><p><code>E_ERROR</code></p></td>
<td><p>Fatal runtime errors that result in script execution halting.</p></td>
</tr>
<tr>
<td><p>2</p></td>
<td><p><code>E_WARNING</code></p></td>
<td><p>Runtime warnings (nonfatal errors) that do not halt script execution.</p></td>
</tr>
<tr>
<td><p>4</p></td>
<td><p><code>E_PARSE</code></p></td>
<td><p>Compile-time errors generated by the parser.</p></td>
</tr>
<tr>
<td><p>8</p></td>
<td><p><code>E_NOTICE</code></p></td>
<td><p>Runtime notices that indicate that the script encountered something that could indicate an error but could also happen in the normal course of running a script.</p></td>
</tr>
<tr>
<td><p>16</p></td>
<td><p><code>E_CORE_ERROR</code></p></td>
<td><p>Fatal errors that occur during PHP’s initial startup. This is like <code>E_ERROR</code>, except it is generated by the core of PHP.</p></td>
</tr>
<tr>
<td><p>32</p></td>
<td><p><code>E_CORE_WARNING</code></p></td>
<td><p>Warnings (nonfatal errors) that occur during PHP’s initial startup. This is like 
<span class="keep-together"><code>E_WARNING</code></span>, except it is generated by the core of PHP.</p></td>
</tr>
<tr>
<td><p>64</p></td>
<td><p><code>E_COMPILE_ERROR</code></p></td>
<td><p>Fatal compile-time errors. This is like <code>E_ERROR</code>, except it is generated by the Zend Scripting Engine.</p></td>
</tr>
<tr>
<td><p>128</p></td>
<td><p><code>E_COMPILE_​WARN⁠ING</code></p></td>
<td><p>Compile-time warnings (nonfatal errors). This is like <code>E_WARNING</code>, except it is generated by the Zend Scripting Engine.</p></td>
</tr>
<tr>
<td><p>256</p></td>
<td><p><code>E_USER_ERROR</code></p></td>
<td><p>User-generated error messages. This is like <code>E_ERROR</code>, except it is generated in PHP code by using the PHP function <a href="https://oreil.ly/eNgVf"><code>trigger_error()</code></a>.</p></td>
</tr>
<tr>
<td><p>512</p></td>
<td><p><code>E_USER_WARNING</code></p></td>
<td><p>User-generated warning messages. This is like <code>E_WARNING</code>, except it is generated in PHP code by using the PHP function <code>trigger_error()</code>.</p></td>
</tr>
<tr>
<td><p>1024</p></td>
<td><p><code>E_USER_NOTICE</code></p></td>
<td><p>User-generated notice messages. This is like <code>E_NOTICE</code>, except it is generated in PHP code by using the PHP function <code>trigger_error()</code>.</p></td>
</tr>
<tr>
<td><p>2048</p></td>
<td><p><code>E_STRICT</code></p></td>
<td><p>Enable to have PHP suggest changes to your code which will ensure the best interoperability and forward compatibility of your code.</p></td>
</tr>
<tr>
<td><p>4096</p></td>
<td><p><code>E_RECOVERA⁠BLE_​ERROR</code></p></td>
<td><p>Catchable fatal errors. A dangerous error occurred, but PHP is not unstable and can recover. If the error is not caught by a user-defined handle (see also <a data-type="xref" href="#recipe_error_handler">Recipe 12.4</a>), the application aborts as if it was an <code>E_ERROR</code>.</p></td>
</tr>
<tr>
<td><p>8192</p></td>
<td><p><code>E_DEPRECATED</code></p></td>
<td><p>Runtime notices. Enable this to receive warnings about code that will not work in future versions.</p></td>
</tr>
<tr>
<td><p>16384</p></td>
<td><p><code>E_USER_​DEPRE⁠CATED</code></p></td>
<td><p>User-generated warning messages. This is like <code>E_DEPRECATED</code>, except it is generated in PHP code by using the PHP function <code>trigger_error()</code>.</p></td>
</tr>
<tr>
<td><p>32767</p></td>
<td><p><code>E_ALL</code></p></td>
<td><p>All errors, warnings, and notices.</p></td>
</tr>
</tbody>
</table>

<p>Note that you can combine error levels via binary operations, creating a bitmask. A simple error reporting level might include errors, warnings, and parser errors alone (omitting core, user errors, and notices). This level would be adequately set with the following:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nb">error_reporting</code><code class="p">(</code><code class="k">E_ERROR</code> <code class="o">|</code> <code class="k">E_WARNING</code> <code class="o">|</code> <code class="k">E_PARSE</code><code class="p">);</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875144289216">
<h2>See Also</h2>

<p>Documentation on <a href="https://oreil.ly/b4eIH"><code>error_reporting()</code></a>, the <a href="https://oreil.ly/t5IW2"><code>error_reporting</code> directive</a>, and the <a href="https://oreil.ly/lxXNs"><code>dis⁠play_​errors</code> directive</a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="12.4 Using a Custom Error Handler"><div class="sect1" id="recipe_error_handler">
<h1>12.4 Using a Custom Error Handler</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875144152464">
<h2>Problem</h2>

<p>You want to customize the way PHP handles and reports errors.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875144150880">
<h2>Solution</h2>

<p>Define your custom handler as a callable function in PHP, then pass that function into <code>set_error_handler()</code> as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">my_error_handler</code><code class="p">(</code><code class="nx">int</code> <code class="nv">$num</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$str</code><code class="p">,</code> <code class="nx">string</code> <code class="nv">$file</code><code class="p">,</code> <code class="nx">int</code> <code class="nv">$line</code><code class="p">)</code>
<code class="p">{</code>
    <code class="k">echo</code> <code class="s2">"Encountered error </code><code class="si">$num</code><code class="s2"> in </code><code class="si">$file</code><code class="s2"> on line </code><code class="si">$line</code><code class="s2">: </code><code class="si">$str</code><code class="s2">"</code> <code class="o">.</code> <code class="nx">PHP_EOL</code><code class="p">;</code>
<code class="p">}</code>

<code class="nb">set_error_handler</code><code class="p">(</code><code class="s1">'my_error_handler'</code><code class="p">);</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875144103104">
<h2>Discussion</h2>

<p>PHP will leverage your custom handler in most situations where an error is recoverable. Fatal errors, core errors, and compile-time issues (like parser errors) either halt or entirely prevent program execution and cannot be handled with a user function. Specifically, <code>E_ERROR</code>, <code>E_PARSE</code>, <code>E_CORE_ERROR</code>, <code>E_CORE_WARNING</code>, <code>E_COMPILE_ERROR</code>, and <code>E_COMPILE_WARNING</code> errors can never be caught. In addition, most <code>E_STRICT</code> errors in the file that invoked <code>set_error_handler()</code> cannot be caught, as the errors will be thrown before the custom handler is properly registered.</p>

<p>If you define a custom error handler consistent with the one presented in the Solution example, any catchable errors will then invoke this function and print data to the screen. As illustrated in <a data-type="xref" href="#catching_runtime_errors">Example 12-3</a>, attempting to <code>echo</code> an undefined variable will cause an <code>E_WARNING</code> error.</p>
<div id="catching_runtime_errors" data-type="example">
<h5><span class="label">Example 12-3. </span>Catching recoverable runtime errors</h5>

<pre data-type="programlisting" data-code-language="php"><code class="k">echo</code> <code class="nv">$foo</code><code class="p">;</code></pre></div>

<p>With <code>my_error_handler()</code> from the Solution example defined and registered, the erroneous code in <a data-type="xref" href="#catching_runtime_errors">Example 12-3</a> will print the following text to the screen, referencing the integer value of the <code>E_WARNING</code> error type:</p>

<pre data-type="programlisting">Encountered error 2 in php shell code on line 1: Undefined variable $foo</pre>

<p>Once you’ve caught an error to handle it, if the error is something that will lead to instability in the application, it is your responsibility to invoke <code>die()</code> to halt execution. PHP won’t do this for you outside the handler and will instead continue processing the application as if no error had been thrown.</p>

<p>If, once you’ve handled errors in part of your application, you wish to restore the original (default) error handler, you should do so by calling <code>restore_error_​han⁠dler()</code>. This merely reverts your earlier error handler registration and restores whatever error handler was previously registered.</p>

<p>Similarly, PHP empowers you to register (and restore) custom exception handlers. These operate the same as custom error handlers but instead capture any exception thrown outside a <code>try</code>/<code>catch</code> block. Unlike error handlers, program execution will halt after the custom exception handler has been called.</p>

<p>For more on exceptions, review <a data-type="xref" href="#custom_exceptions">Recipe 12.2</a> and the documentation for both <a href="https://oreil.ly/_pf4H"><code>set_exception_handler()</code></a> and <a href="https://oreil.ly/TOEuz"><code>restore_exception_&amp;#x200b;han&amp;#x2060;dler()</code></a>.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875144086896">
<h2>See Also</h2>

<p>Documentation on <a href="https://oreil.ly/IAh69"><code>set_error_handler()</code></a> and <a href="https://oreil.ly/SlT_d"><code>restore_error_handler()</code></a>.</p>
</div></section>
</div></section>






<section data-type="sect1" data-pdf-bookmark="12.5 Logging Errors to an External Stream"><div class="sect1" id="idm45875144057712">
<h1>12.5 Logging Errors to an External Stream</h1>








<section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45875144056352">
<h2>Problem</h2>

<p>You want to log application errors to a file or to an external source of some sort for future debugging.</p>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45875144054640">
<h2>Solution</h2>

<p>Use <code>error_log()</code> to write errors to the default log file as follows:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nv">$user_input</code> <code class="o">=</code> <code class="nb">json_decode</code><code class="p">(</code><code class="nv">$raw_input</code><code class="p">);</code>
<code class="k">if</code> <code class="p">(</code><code class="nb">json_last_error</code><code class="p">()</code> <code class="o">!==</code> <code class="nx">JSON_ERROR_NONE</code><code class="p">)</code> <code class="p">{</code>
    <code class="nb">error_log</code><code class="p">(</code><code class="s1">'JSON Error #'</code> <code class="o">.</code> <code class="nb">json_last_error</code><code class="p">()</code> <code class="o">.</code> <code class="s1">': '</code> <code class="o">.</code> <code class="nv">$raw_input</code><code class="p">);</code>
<code class="p">}</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45875144016688">
<h2>Discussion</h2>

<p>By default, <code>error_log()</code> will log errors to whatever location is specified by the <a href="https://oreil.ly/3lVPn"><code>error_log</code> directive</a> in <em>php.ini</em>. Often on Unix-style systems, this will be a file within <em>/var/log</em> but can be customized to be anywhere within your system.</p>

<p>The optional second parameter of <code>error_log()</code> allows you to route error messages where necessary. If the server is set up to send emails, you can specify a message type of <code>1</code> and provide an email address for the optional third parameter to send errors by email. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nb">error_log</code><code class="p">(</code><code class="s1">'Some error message'</code><code class="p">,</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'developer@somedomain.tld'</code><code class="p">);</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Under the hood, <code>error_log()</code> will use the same functionality as <code>mail()</code> to send errors by email. In many cases, this might be disabled for security purposes. Be sure to verify the functionality of any mail systems before relying on this functionality, particularly in a production environment.</p>
</div>

<p>Alternatively, you can specify a file <em>other</em> than the default log location as the destination and pass the integer <code>3</code> as the message type. Rather than writing to the default logs, PHP will append the message to that file directly. For example:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nb">error_log</code><code class="p">(</code><code class="s1">'Some error message'</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'error_log.txt'</code><code class="p">);</code></pre>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>When logging directly to a file with <code>error_log()</code>, the system will <em>not</em> append a newline character automatically. You will be responsible for either appending <code>PHP_EOL</code> to any string or encoding the <code>\r\n</code> newline literals.</p>
</div>

<p><a data-type="xref" href="ch11.html#chapter_streams">Chapter 11</a> covers the file protocol at length as well as the other streams exposed by PHP. Remember that directly referencing a filepath is transparently leveraging the <code>file://</code> protocol so, in reality, you are logging errors to a file <em>stream</em> with the preceding code block. You can just as easily reference any other kind of stream so long as you properly reference the stream protocol. The following example logs errors directly to the console’s standard error stream:</p>

<pre data-type="programlisting" data-code-language="php"><code class="nb">error_log</code><code class="p">(</code><code class="s1">'Some error message'</code><code class="p">,</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'php://stderr'</code><code class="p">);</code></pre>
</div></section>








<section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45875143972064">
<h2>See Also</h2>

<p>Documentation on <a href="https://oreil.ly/QUQRH"><code>error_log()</code></a> and <a data-type="xref" href="ch13.html#recipe_logging">Recipe 13.5</a>’s coverage of Monolog, a more comprehensive logging library for PHP applications.</p>
</div></section>
</div></section>
<div data-type="footnotes"><p data-type="footnote" id="idm45875144247792"><sup><a href="ch12.html#idm45875144247792-marker">1</a></sup> The default error level can be directly set in <em>php.ini</em> and, in many environments, might already be set to something other than <code>E_ALL</code>. Confirm your own environment’s configuration to be sure.</p></div></div></section></div>
</div>
</body>
</html>