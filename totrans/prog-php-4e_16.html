<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 15. Application Techniques"><div class="chapter" id="application_techniques">
<h1><span class="label">Chapter 15. </span>Application Techniques</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="application techniques" id="ix_app_tech_ch15"/>By now, you should have a solid understanding of the details of the PHP language and its use in a variety of common situations. Now we’re going to show you some techniques you may find useful in your PHP applications, such as code libraries, templating systems, efficient output handling, error handling, and performance tuning.</p>
<section data-type="sect1" data-pdf-bookmark="Code Libraries"><div class="sect1" id="code_libraries">
<h1>Code Libraries</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="code libraries" id="idm45922748321992"/><a contenteditable="false" data-type="indexterm" data-primary="extensions (libraries)" data-secondary="creating" id="idm45922748320616"/>As you’ve seen, PHP ships with numerous extension libraries that combine useful functionality into distinct packages that you can access from your scripts. We covered using the GD, FPDF, and Libxslt extension libraries in Chapters <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch10.xhtml#graphic">10</a>, <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch11.xhtml#pdf">11</a>, and <a data-type="xref" data-xrefstyle="select:labelnumber" href="ch12.xhtml#xml">12</a>, respectively.</p>
<p>In addition to using the extensions that ship with PHP, you can create libraries of your own code that you can use in more than one part of your website. The general technique is to store a collection of related functions in a PHP file. Then, when you need to use that functionality in a page, you can use <a contenteditable="false" data-type="indexterm" data-primary="require_once function" id="idm45922748314328"/><code>require_once()</code> to insert the contents of the file into your current script.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Note that there are three other inclusion type functions that can also be employed. They are <code>require()</code>, <a contenteditable="false" data-type="indexterm" data-primary="include_once function" id="idm45922748311272"/><code>include_once()</code>, and <code>include()</code>. <a data-type="xref" href="ch02.xhtml#language_basics">Chapter 2</a> discusses these functions in detail.</p>
</div>
<p>For example, say you have a collection of functions that help create HTML form elements in valid HTML: one function in your collection creates a text field or a <code>text​area</code> (depending on how many characters you set as the maximum), another creates a series of pop ups from which to set a date and time, and so on. Rather than copying the code into many pages—which is tedious, leads to errors, and makes it difficult to fix any bugs found in the functions—creating a function library is the sensible choice.</p>
<p>When you are combining functions into a code library, be careful to maintain a balance between grouping related functions and including functions that are not often used. When you include a code library in a page, all of the functions in that library are parsed, whether you use them all or not. PHP’s parser is quick, but not parsing a function is even faster. At the same time, you don’t want to split your functions across too many libraries, causing you to have to include lots of files in each page, because file access is slow.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Templating Systems"><div class="sect1" id="templating_systems">
<h1>Templating Systems</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="web pages" data-secondary="templating systems for" id="ix_web_page_template"/><a contenteditable="false" data-type="indexterm" data-primary="templating systems" id="ix_template_app_tech_"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="templating systems for" id="ix_app_tech_template"/>A <em>templating system</em> provides a way of separating the code in a web page from the layout of that page. In larger projects, templates can be used to allow designers to deal exclusively with designing web pages and programmers to deal (more or less) exclusively with programming. The basic idea of a templating system is that the web page itself contains special markers that are replaced with dynamic content. A web designer can create the HTML for a page and simply worry about the layout, using the appropriate markers for different kinds of dynamic content that are needed. The programmer, on the other hand, is responsible for creating the code that generates the dynamic content for the markers.</p>
<p>To make this more concrete, let’s look at a simple example. Consider the following web page, which asks the user to supply a name and then, if a name is provided, thanks the user:</p>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>User Information<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="cp">&lt;?php</code> <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">empty</code><code class="p">(</code><code class="nv">$_GET</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="c1">// do something with the supplied values ?&gt;</code>

 <code class="o">&lt;</code><code class="nx">p</code><code class="o">&gt;&lt;</code><code class="nx">font</code> <code class="nx">face</code><code class="o">=</code><code class="s2">"helvetica,arial"</code><code class="o">&gt;</code><code class="nx">Thank</code> <code class="nx">you</code> <code class="k">for</code> <code class="nx">filling</code> <code class="nx">out</code> <code class="nx">the</code> <code class="nx">form</code><code class="p">,</code>
 <code class="o">&lt;?</code><code class="nx">php</code> <code class="k">echo</code> <code class="nv">$_GET</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]</code> <code class="cp">?&gt;</code>.<code class="nt">&lt;/font&gt;&lt;/p&gt;</code>
 <code class="cp">&lt;?php</code> <code class="p">}</code>
<code class="k">else</code> <code class="p">{</code> <code class="cp">?&gt;</code>
 <code class="nt">&lt;p&gt;&lt;font</code> <code class="na">face=</code><code class="s">"helvetica,arial"</code><code class="nt">&gt;</code>Please enter the following information:
 <code class="nt">&lt;/font&gt;&lt;/p&gt;</code>

 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"</code><code class="cp">&lt;?php</code> <code class="k">echo</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'PHP_SELF'</code><code class="p">]</code> <code class="cp">?&gt;</code><code class="s">"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;table&gt;</code>
 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>Name:<code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;td&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">name=</code><code class="s">"name"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
 <code class="nt">&lt;/table&gt;</code>
 <code class="nt">&lt;/form&gt;</code>
<code class="cp">&lt;?php</code> <code class="p">}</code> <code class="cp">?&gt;</code>
<code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
<p>The placement of the different PHP elements within various layout tags, such as the <code>font</code> and <code>table</code> elements, is better left to a designer, especially as the page gets more complex. Using a templating system, we can split this page into separate files, some containing PHP code and some containing the layout. The HTML pages will then contain special markers where dynamic content should be placed. <a data-type="xref" href="#example_onefive_onedot_html_template_fo">Example 15-1</a> shows the new HTML template page for our simple form, which is stored in the file <em>user.template</em>. It uses the <code>{DESTINATION}</code> marker to indicate the script that should process the form.</p>
<div data-type="example" id="example_onefive_onedot_html_template_fo">
<h5><span class="label">Example 15-1. </span>HTML template for user input form</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>User Information<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="nt">&lt;p&gt;</code>Please enter the following information:<code class="nt">&lt;/p&gt;</code>

 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"{DESTINATION}"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;table&gt;</code>
 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>Name:<code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;td&gt;&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">name=</code><code class="s">"name"</code> <code class="nt">/&gt;&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
 <code class="nt">&lt;/table&gt;</code>
 <code class="nt">&lt;/form&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
</div>
<p><a data-type="xref" href="#example_onefive_twodot_html_template_fo">Example 15-2</a> shows the template for the thank-you page, called <em>thankyou.template</em>, which is displayed after the user has filled out the form. This page uses the <code>{NAME}</code> marker to include the value of the user’s name.</p>
<div data-type="example" id="example_onefive_twodot_html_template_fo">
<h5><span class="label">Example 15-2. </span>HTML template for thank-you page</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Thank You<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="nt">&lt;p&gt;</code>Thank you for filling out the form, {NAME}.<code class="nt">&lt;/p&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
<code class="nt">&lt;/html&gt;</code></pre>
</div>
<p>Now we need a script that can process these template pages, filling in the appropriate information for the various markers. <a data-type="xref" href="#example_onefive_threedot_template_scrip">Example 15-3</a> shows the PHP script that uses these templates (one for before the user has given us information and one for after). The PHP code uses the <a contenteditable="false" data-type="indexterm" data-primary="fillTemplate function" id="idm45922748164248"/><code>fillTemplate()</code> function to join our values and the template files. This file is called <em>form_template.php</em>.</p>
<div data-type="example" id="example_onefive_threedot_template_scrip">
<h5><span class="label">Example 15-3. </span>Template script</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nv">$bindings</code><code class="p">[</code><code class="s2">"DESTINATION"</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s2">"PHP_SELF"</code><code class="p">];</code>
<code class="nv">$name</code> <code class="o">=</code> <code class="nv">$_GET</code><code class="p">[</code><code class="s2">"name"</code><code class="p">];</code>

<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">empty</code><code class="p">(</code><code class="nv">$name</code><code class="p">))</code> <code class="p">{</code>
 <code class="c1">// do something with the supplied values</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="s2">"thankyou.template"</code><code class="p">;</code>
 <code class="nv">$bindings</code><code class="p">[</code><code class="s2">"NAME"</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$name</code><code class="p">;</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="s2">"user.template"</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">echo</code> <code class="nx">fillTemplate</code><code class="p">(</code><code class="nv">$template</code><code class="p">,</code> <code class="nv">$bindings</code><code class="p">);</code></pre>
</div>
<p><a data-type="xref" href="#example_onefive_fourdot_the_filltemplat">Example 15-4</a> shows the <code>fillTemplate()</code> function used by the script in <a data-type="xref" href="#example_onefive_threedot_template_scrip">Example 15-3</a>. The function takes a template filename (relative to a directory named <em>templates</em> located in the document root), an array of values, and an optional instruction denoting what to do if a marker is found for which no value is given. The possible values are <code>delete</code>, which deletes the marker; <code>comment</code>, which replaces the marker with a comment noting that the value is missing; or anything else, which just leaves the marker alone. This file is called <em>func_template.php.</em></p>
<div data-type="example" id="example_onefive_fourdot_the_filltemplat">
<h5><span class="label">Example 15-4. </span>The fillTemplate() function</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="k">function</code> <code class="nf">fillTemplate</code><code class="p">(</code><code class="nv">$name</code><code class="p">,</code> <code class="nv">$values</code> <code class="o">=</code> <code class="k">array</code><code class="p">(),</code> <code class="nv">$unhandled</code> <code class="o">=</code> <code class="s2">"delete"</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$templateFile</code> <code class="o">=</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'DOCUMENT_ROOT'</code><code class="p">]</code><code class="si">}</code><code class="s2">/templates/</code><code class="si">{</code><code class="nv">$name</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

 <code class="k">if</code> <code class="p">(</code><code class="nv">$file</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$templateFile</code><code class="p">,</code> <code class="s1">'r'</code><code class="p">))</code> <code class="p">{</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="nb">fread</code><code class="p">(</code><code class="nv">$file</code><code class="p">,</code> <code class="nb">filesize</code><code class="p">(</code><code class="nv">$templateFile</code><code class="p">));</code>
 <code class="nb">fclose</code><code class="p">(</code><code class="nv">$file</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="nv">$keys</code> <code class="o">=</code> <code class="nb">array_keys</code><code class="p">(</code><code class="nv">$values</code><code class="p">);</code>

 <code class="k">foreach</code> <code class="p">(</code><code class="nv">$keys</code> <code class="k">as</code> <code class="nv">$key</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// look for and replace the key everywhere it occurs in the template</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="nb">str_replace</code><code class="p">(</code><code class="s2">"{{$key}}"</code><code class="p">,</code> <code class="nv">$values</code><code class="p">[</code><code class="nv">$key</code><code class="p">],</code> <code class="nv">$template</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">if</code> <code class="p">(</code><code class="nv">$unhandled</code> <code class="o">==</code> <code class="s2">"delete"</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// remove remaining keys</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="nb">preg_replace</code><code class="p">(</code><code class="s2">"/{[^ }]*}/i"</code><code class="p">,</code> <code class="s2">""</code><code class="p">,</code> <code class="nv">$template</code><code class="p">);</code>
 <code class="p">}</code>
 <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nv">$unhandled</code> <code class="o">==</code> <code class="s2">"comment"</code><code class="p">)</code> <code class="p">{</code>
 <code class="c1">// comment remaining keys</code>
 <code class="nv">$template</code> <code class="o">=</code> <code class="nb">preg_replace</code><code class="p">(</code><code class="s2">"/{([^ }]*)}/i"</code><code class="p">,</code> <code class="s2">"&lt;!-- </code><code class="se">\\</code><code class="s2">1 undefined --&gt;"</code><code class="p">,</code> <code class="nv">$template</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="k">return</code> <code class="nv">$template</code><code class="p">;</code>
<code class="p">}</code></pre>
</div>
<p>Clearly, this example of a templating system is somewhat contrived. But if you think of a large PHP application that displays hundreds of news articles, you can imagine how a templating system that used markers such as <code>{HEADLINE}</code>, <code>{BYLINE}</code>, and <span class="keep-together"><code>{ARTICLE}</code></span> might be useful, as it would allow designers to create the layout for article pages without needing to worry about the actual content.</p>
<p>While templates may reduce the amount of PHP code that designers have to see, there is a performance trade-off, as every request incurs the cost of building a page from the template. Performing pattern matches on every outgoing page can really slow down a popular site. <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Smarty templating system" id="idm45922747827960"/><a contenteditable="false" data-type="indexterm" data-primary="Smarty templating system" id="idm45922747826728"/>Andrei Zmievski’s <a href="http://www.smarty.net">Smarty</a> is an efficient templating system that neatly side-steps much of this performance hit by turning the template into straight PHP code and caching it. Instead of doing the template replacement on every request, it does it only when the template file is changed.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_template" id="idm45922747824488"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_template_app_tech_" id="idm45922747823112"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_web_page_template" id="idm45922747821736"/></p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Handling Output"><div class="sect1" id="handling_output">
<h1>Handling Output</h1>
<p>PHP is all about displaying output in the web browser. Accordingly, there are a few different techniques that you can use to handle output more efficiently or <span class="keep-together">conveniently.</span></p>
<section data-type="sect2" data-pdf-bookmark="Output Buffering"><div class="sect2" id="output_buffering-id00039">
<h2>Output Buffering</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="output buffering" id="ix_buffer_app_tech"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="output buffering" id="ix_app_tech_buffer"/>By default, PHP sends the results of <code>echo</code> and similar commands to the browser after each command is executed. Alternately, you can use PHP’s output buffering functions to gather the information that would normally be sent to the browser into a buffer and send it later (or kill it entirely). This allows you to specify the content length of your output after it is generated, capture the output of a function, or discard the output of a built-in function.</p>
<p>You turn on output buffering with the <a contenteditable="false" data-type="indexterm" data-primary="ob_start function" id="idm45922747811176"/><code>ob_start()</code> function:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">ob_start</code><code class="p">([</code><em><code class="nx">callback</code></em><code class="p">]);</code></pre>
<p>The optional <em><code>callback</code></em> parameter is the name of a function that postprocesses the output. If specified, this function is passed the collected output when the buffer is flushed, and it should return a string of output to send to the browser. You can use this, for instance, to turn all occurrences of <em>http://www.yoursite.com</em> to <em>http://www.mysite.com</em>.</p>
<p>While output buffering is enabled, all output is stored in an internal buffer. To get the current length and contents of the buffer, use <a contenteditable="false" data-type="indexterm" data-primary="ob_get_length function" id="idm45922747781784"/><code>ob_get_length()</code> and <a contenteditable="false" data-type="indexterm" data-primary="ob_get_contents function" id="idm45922747780488"/><code>ob_get_</code><span class="keep-together"><code>contents()</code></span>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$len</code> <code class="o">=</code> <code class="nb">ob_get_length</code><code class="p">();</code>
<code class="nv">$contents</code> <code class="o">=</code> <code class="nb">ob_get_contents</code><code class="p">();</code></pre>
<p>If buffering isn’t enabled, these functions return <code>false</code>.</p>
<p>There are two ways to throw away the data in the buffer. The <a contenteditable="false" data-type="indexterm" data-primary="ob_clean function" id="idm45922747753736"/><code>ob_clean()</code> function erases the output buffer but does not turn off buffering for subsequent output. The <a contenteditable="false" data-type="indexterm" data-primary="ob_end_clean function" id="idm45922747752136"/><code>ob_end_clean()</code> function erases the output buffer and ends output buffering.</p>
<p>There are three ways to send the collected output to the browser (this action is known as <em>flushing</em> the buffer). The <a contenteditable="false" data-type="indexterm" data-primary="ob_flush function" id="idm45922747571720"/><code>ob_flush()</code> function sends the output data to the web server and clears the buffer, but doesn’t terminate output buffering. The <a contenteditable="false" data-type="indexterm" data-primary="flush function" id="idm45922747570040"/><code>flush()</code> function not only flushes and clears the output buffer, but also tries to make the web server send the data to the browser immediately. The <a contenteditable="false" data-type="indexterm" data-primary="ob_end_flush function" id="idm45922747568360"/><code>ob_end_flush()</code> function sends the output data to the web server and ends output buffering. In all cases, if you specified a callback with <code>ob_start()</code>, that function is called to decide exactly what gets sent to the server.</p>
<p>If your script ends with output buffering still enabled—that is, if you haven’t called <code>ob_end_flush()</code> or <code>ob_end_clean()</code>—PHP calls <code>ob_end_flush()</code> for you.</p>
<p>The following code collects the output of the <code>phpinfo()</code> function and uses it to determine whether you have the GD graphics module installed:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">ob_start</code><code class="p">();</code>
 <code class="nb">phpinfo</code><code class="p">();</code>
 <code class="nv">$phpinfo</code> <code class="o">=</code> <code class="nb">ob_get_contents</code><code class="p">();</code>
<code class="nb">ob_end_clean</code><code class="p">();</code>

<code class="k">if</code> <code class="p">(</code><code class="nb">strpos</code><code class="p">(</code><code class="nv">$phpinfo</code><code class="p">,</code> <code class="s2">"module_gd"</code><code class="p">)</code> <code class="o">===</code> <code class="k">false</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"You do not have GD Graphics support in your PHP, sorry."</code><code class="p">;</code>
<code class="p">}</code>
<code class="k">else</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Congratulations, you have GD Graphics support!"</code><code class="p">;</code>
<code class="p">}</code></pre>
<p>Of course, a quicker and simpler approach to check if a certain extension is available is to pick a function that you know the extension provides and check if it exists. For the GD extension, you might do:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">if</code> <code class="p">(</code><code class="nb">function_exists</code><code class="p">(</code><code class="s2">"imagecreate"</code><code class="p">))</code> <code class="p">{</code>
 <code class="c1">// do something useful</code>
<code class="p">}</code></pre>
<p>To change all references in a document from <em>http://www.yoursite.com</em> to <em>http://www.mysite.com</em>, simply wrap the page like this:</p>
<pre data-type="programlisting" data-code-language="html+php">ob_start(); ?&gt;

Visit <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://www.yoursite.com/foo/bar"</code><code class="nt">&gt;</code>our site<code class="nt">&lt;/a&gt;</code> now!

<code class="cp">&lt;?php</code> <code class="nv">$contents</code> <code class="o">=</code> <code class="nb">ob_get_contents</code><code class="p">();</code>
<code class="nb">ob_end_clean</code><code class="p">();</code>
</pre>
<pre data-type="programlisting" data-code-language="php"><code class="k">echo</code><code> </code><code class="nb">str_replace</code><code class="p">(</code><code class="s2">"</code><strong><code class="s2">http://www.yoursite.com/</code></strong><code class="s2">"</code><code class="p">,</code><code>
</code><code class="s2">"</code><strong><code class="s2">http://www.mysite.com/</code></strong><code class="s2">"</code><code class="p">,</code><code> </code><code class="nv">$contents</code><code class="p">);</code></pre>
<pre data-type="programlisting" data-code-language="html+php">?&gt;

Visit <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://www.mysite.com/foo/bar"</code><code class="nt">&gt;</code>our site<code class="nt">&lt;/a&gt;</code> now!</pre>
<p>Another way to do this is with a callback. Here, the <code>rewrite()</code> callback changes the text of the page:<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_buffer" id="idm45922747589528"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_buffer_app_tech" id="idm45922747588280"/></p>
<pre data-type="programlisting" data-code-language="php"><code class="k">function</code> <code class="nf">rewrite</code><code class="p">(</code><code class="nv">$text</code><code class="p">)</code> <code class="p">{</code></pre>
<pre data-type="programlisting" data-code-language="php"><code> </code><code class="k">return</code><code> </code><code class="nb">str_replace</code><code class="p">(</code><code class="s2">"</code><strong><code class="s2">http://www.yoursite.com/</code></strong><code class="s2">"</code><code class="p">,</code><code>
</code><code class="s2">"</code><strong><code class="s2">http://www.mysite.com/</code></strong><code class="s2">"</code><code class="p">,</code><code> </code><code class="nv">$text</code><code class="p">);</code></pre>
<pre data-type="programlisting" data-code-language="html+php">}

ob_start("rewrite"); ?&gt;

Visit <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://www.yoursite.com/foo/bar"</code><code class="nt">&gt;</code>our site<code class="nt">&lt;/a&gt;</code> now!
Visit <code class="nt">&lt;a</code> <code class="na">href=</code><code class="s">"http://www.mysite.com/foo/bar"</code><code class="nt">&gt;</code>our site<code class="nt">&lt;/a&gt;</code> now!</pre>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Output Compression"><div class="sect2" id="output_compression">
<h2>Output Compression</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="output compression" id="idm45922747428472"/><a contenteditable="false" data-type="indexterm" data-primary="output compression" id="idm45922747427096"/>Recent browsers support compressing the text of web pages; the server sends compressed text and the browser decompresses it. To automatically compress your web page, wrap it like this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">ob_start</code><code class="p">(</code><code class="s2">"ob_gzhandler"</code><code class="p">);</code></pre>
<p>The built-in <a contenteditable="false" data-type="indexterm" data-primary="ob_gzhandler function" id="idm45922747400376"/><code>ob_gzhandler()</code> function can be used as the callback for a call to <code>ob_start()</code>. It compresses the buffered page according to the <code>Accept-Encoding</code> header sent by the browser. Possible compression techniques are <em>gzip</em>, <em>deflate</em>, or none.</p>
<p>It rarely makes sense to compress short pages, as the time for compression and decompression exceeds the time it would take to simply send the uncompressed text. It does make sense to compress large (greater than 5 KB) web pages, however.</p>
<p>Instead of adding the <code>ob_start()</code> call to the top of every page, you can set the <code>output_handler</code> option in your <em>php.ini</em> file to a callback to be made on every page. For compression, this is <code>ob_gzhandler</code>.</p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Performance Tuning"><div class="sect1" id="performance_tuning">
<h1>Performance Tuning</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" id="ix_perf_tune_app_tech"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="performance tuning for" id="ix_app_tech_perf_tune"/>Before thinking much about performance tuning, take the time to get your code working properly. Once you have sound working code, you can locate the slower sections, or <em>bottlenecks</em>. If you try to optimize your code while writing it, you’ll discover that optimized code tends to be more difficult to read and generally takes more time to write. If you spend that time on a section of code that isn’t actually causing a problem, that’s time wasted, especially down the road when you need to maintain that code and you can no longer read it.</p>
<p>Once you get your code working, you may find that it needs some optimization. Optimizing code tends to fall within one of two areas: shortening execution times and reducing memory requirements.</p>
<p>Before you begin optimization, ask yourself whether you need to optimize at all. Too many programmers have wasted hours wondering whether a complex series of string function calls are faster or slower than a single Perl regular expression, when the page where this code is located is viewed once every five minutes. Optimization is necessary only when a page takes so long to load that the user perceives it as slow. Often this is a symptom of a very popular site—if requests for a page come in fast enough, the time it takes to generate that page can mean the difference between prompt delivery and server overload. With a possible long wait on your site, you can bet that your web visitors won’t take long to decide to look elsewhere for their information.</p>
<p>Once you’ve decided that your page needs optimization (this can best be done with some end user testing and observation), you can move on to working out exactly what is slow. You can use the techniques in the section “Profiling” to time the various subroutines or logical units of your page. This will give you an idea of which parts of your page are taking the longest time to produce—these parts are where you should focus your optimization efforts. If a page is taking 5 seconds to produce, you’ll never get it down to 2 seconds by optimizing a function that accounts for only 0.25 seconds of the total time. Identify the biggest time-wasting blocks of code and focus on them. Time the page and the pieces you’re optimizing to make sure your changes are having a positive, and not a negative, effect.</p>
<p class="pagebreak-before">Finally, know when to quit. Sometimes there is an absolute limit for the speed at which you can get something to run. In these circumstances, the only way to get better performance is to throw new hardware at the problem. The solution might turn out to be faster machines or more web servers with a reverse-proxy cache in front of them.</p>
<section data-type="sect2" data-pdf-bookmark="Benchmarking"><div class="sect2" id="benchmarking">
<h2>Benchmarking</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="speed testing of code" id="idm45922747365368"/><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="benchmarking" id="ix_perf_tune_bench"/><a contenteditable="false" data-type="indexterm" data-primary="benchmarking" id="ix_benchmark_app_tech"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="benchmarking" id="ix_app_tech_benchmark"/>If you’re using Apache, you can use the Apache benchmarking utility, <a contenteditable="false" data-type="indexterm" data-primary="ab benchmarking utility" id="idm45922747343096"/><code>ab</code>, to do high-level performance testing. To use it, run:</p>
<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> /usr/local/apache/bin/ab -c <code class="m">10</code> -n <code class="m">1000</code> http://localhost/info.php</pre>
<p>This command tests the speed of the PHP script <em>info.php</em> 1,000 times, with 10 concurrent requests running at any given time. The benchmarking tool returns various information about the test, including the slowest, fastest, and average load times. You can compare those values to a static HTML page to see how quickly your script <span class="keep-together">performs.</span></p>
<p>For example, here’s the output from 1,000 fetches of a page that simply calls <code>phpinfo()</code>:</p>
<pre data-type="programlisting">This is ApacheBench, Version 1.3d &lt;$Revision: 1.2 $&gt; apache-1.3
Copyright (c) 1996 Adam Twiss, Zeus Technology Ltd,
http://www.zeustech.net/
Copyright (c) 1998-2001 The Apache Group, http://www.apache.org/

Benchmarking localhost (be patient)
Completed 100 requests
Completed 200 requests
Completed 300 requests
Completed 400 requests
Completed 500 requests
Completed 600 requests
Completed 700 requests
Completed 800 requests
Completed 900 requests
Finished 1000 requests
Server Software: Apache/1.3.22
Server Hostname: localhost
Server Port: 80

Document Path: /info.php
Document Length: 49414 bytes

Concurrency Level: 10
Time taken for tests: 8.198 seconds
Complete requests: 1000
Failed requests: 0
Broken pipe errors: 0
Total transferred: 49900378 bytes
HTML transferred: 49679845 bytes
Requests per second: 121.98 [#/sec] (mean)
Time per request: 81.98 [ms] (mean)
Time per request: 8.20 [ms] (mean, across all concurrent requests)
Transfer rate: 6086.90 [Kbytes/sec] received

Connnection Times (ms)
 min mean[+/-sd] median max
Connect: 0 12 16.9 1 72
Processing: 7 69 68.5 58 596
Waiting: 0 64 69.4 50 596
Total: 7 81 66.5 79 596

Percentage of the requests served within a certain time (ms)
 50% 79
 66% 80
 75% 83
 80% 84
 90% 158
 95% 221
 98% 268
 99% 288
 100% 596 (last request)</pre>
<p>If your PHP script uses sessions, the results you get from <code>ab</code> will not be representative of the real-world performance of the scripts. Since a session is locked across a request, results from the concurrent requests run by <code>ab</code> will be extremely poor. However, in normal usage, a session is typically associated with a single user, who isn’t likely to make concurrent requests.</p>
<p>Using <code>ab</code> tells you the overall speed of your page but gives you no information on the speed of individual functions of blocks of code within the page. Use <code>ab</code> to test changes you make to your code as you attempt to improve its speed. We show you how to time individual portions of a page in the next section, but ultimately these microbenchmarks don’t matter if the overall page is still slow to load and run. The ultimate proof that your performance optimizations have been successful comes from the numbers that <code>ab</code> reports.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_benchmark" id="idm45922747333912"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_benchmark_app_tech" id="idm45922747332504"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_perf_tune_bench" id="idm45922747331128"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Profiling"><div class="sect2" id="profiling">
<h2>Profiling</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="profiling for" id="ix_perf_tune_profile"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="profiling" id="ix_app_tech_profiling"/><a contenteditable="false" data-type="indexterm" data-primary="profiling" id="ix_profiling_app_tech"/>PHP does not have a built-in profiler, but there are some techniques you can use to investigate code that you think has performance issues. One technique is to call the <a contenteditable="false" data-type="indexterm" data-primary="microtime function" id="idm45922747309464"/><code>microtime()</code> function to get an accurate representation of the amount of time that elapses. You can surround the code you’re profiling with calls to <code>microtime()</code> and use the values it returns to calculate how long the code took.</p>
<p>For instance, here’s some code you can use to find out just how long it takes to produce the <code>phpinfo()</code> output:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">ob_start</code><code class="p">();</code>
<code class="nv">$start</code> <code class="o">=</code> <code class="nb">microtime</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>

<code class="nb">phpinfo</code><code class="p">();</code>

<code class="nv">$end</code> <code class="o">=</code> <code class="nb">microtime</code><code class="p">(</code><code class="k">true</code><code class="p">);</code>
<code class="nb">ob_end_clean</code><code class="p">();</code>

<code class="k">echo</code> <code class="s2">"phpinfo() took "</code> <code class="o">.</code> <code class="p">(</code><code class="nv">$end</code> <code class="o">-</code> <code class="nv">$start</code><code class="p">)</code> <code class="o">.</code> <code class="s2">" seconds to run.</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code></pre>
<p>Reload this page several times, and you’ll see the number fluctuate slightly. Reload it often enough, and you’ll see it fluctuate quite a lot. The danger of timing a single run of a piece of code is that you may not get a representative machine load—the server might be paging as a user starts <em>emacs</em>, or it may have removed the source file from its cache. The best way to get an accurate representation of the time it takes to do something is to time repeated runs and look at the average of those times.</p>
<p>The <a contenteditable="false" data-type="indexterm" data-primary="Benchmark class, PEAR" id="idm45922747276152"/><a contenteditable="false" data-type="indexterm" data-primary="PEAR (PHP Extension and Application Repository)" id="idm45922747275112"/><code>Benchmark</code> class available in PEAR makes it easy to repeatedly time sections of your script. Here is a simple example that shows how you can use it:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">require_once</code> <code class="s1">'Benchmark/Timer.php'</code><code class="p">;</code>

<code class="nv">$timer</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Benchmark_Timer</code><code class="p">;</code>

<code class="nv">$timer</code><code class="o">-&gt;</code><code class="na">start</code><code class="p">();</code>
 <code class="nb">sleep</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
 <code class="nv">$timer</code><code class="o">-&gt;</code><code class="na">setMarker</code><code class="p">(</code><code class="s1">'Marker 1'</code><code class="p">);</code>
 <code class="nb">sleep</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>
<code class="nv">$timer</code><code class="o">-&gt;</code><code class="na">stop</code><code class="p">();</code>

<code class="nv">$profiling</code> <code class="o">=</code> <code class="nv">$timer</code><code class="o">-&gt;</code><code class="na">getProfiling</code><code class="p">();</code>

<code class="k">foreach</code> <code class="p">(</code><code class="nv">$profiling</code> <code class="k">as</code> <code class="nv">$time</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="nv">$time</code><code class="p">[</code><code class="s2">"name"</code><code class="p">]</code> <code class="o">.</code> <code class="s2">": "</code> <code class="o">.</code> <code class="nv">$time</code><code class="p">[</code><code class="s2">"diff"</code><code class="p">]</code> <code class="o">.</code> <code class="s2">"&lt;br&gt;</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code>
<code class="p">}</code>

<code class="k">echo</code> <code class="s2">"Total: "</code> <code class="o">.</code> <code class="nv">$time</code><code class="p">[</code><code class="s2">"total"</code><code class="p">]</code> <code class="o">.</code> <code class="s2">"&lt;br&gt;</code><code class="se">\n</code><code class="s2">"</code><code class="p">;</code></pre>
<p>The output from this program is:</p>
<pre data-type="programlisting">Start: -
Marker 1: 1.0006979703903
Stop: 2.0100029706955
Total: 3.0107009410858</pre>
<p>That is, it took 1.0006979703903 seconds to get to Marker 1, which is set right after our <code>sleep(1)</code> call, so it is what you would expect. It took just over two seconds to get from Marker 1 to the end, and the entire script took just over three seconds to run. You can add as many markers as you like and thereby time various parts of your script.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_profiling_app_tech" id="idm45922747154392"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_profiling" id="idm45922747153048"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_perf_tune_profile" id="idm45922747151672"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Optimizing Execution Time"><div class="sect2" id="optimizing_execution_time">
<h2>Optimizing Execution Time</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="execution time, optimizing" id="idm45922747148920"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="execution time, optimizing" id="idm45922747147576"/><a contenteditable="false" data-type="indexterm" data-primary="execution time, optimizing" id="idm45922747146232"/>Here are some tips for shortening the execution times of your scripts:</p>
<ul>
<li><p>Avoid <a contenteditable="false" data-type="indexterm" data-primary="printf function" id="idm45922747143912"/><code>printf()</code> when <a contenteditable="false" data-type="indexterm" data-primary="echo construct" id="idm45922747142360"/><code>echo</code> is all you need.</p></li>
<li><p>Avoid recomputing values inside a loop, as PHP’s parser does not remove loop invariants. For example, don’t do this if the size of $array doesn’t change:</p>
<pre data-type="programlisting" data-code-language="php"> <code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="nb">count</code><code class="p">(</code><code class="nv">$array</code><code class="p">);</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* do something */</code> <code class="p">}</code></pre>
<p>Instead, do this:</p>
<pre data-type="programlisting" data-code-language="php"> <code class="nv">$num</code> <code class="o">=</code> <code class="nb">count</code><code class="p">(</code><code class="nv">$array</code><code class="p">);</code>
 <code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="nv">$num</code><code class="p">;</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code> <code class="cm">/* do something */</code> <code class="p">}</code></pre></li>
<li><p>Include only files that you need. Split included files to include only functions that you are sure will be used together. Although the code may be a bit more difficult to maintain, parsing code you don’t use is expensive.</p></li>
<li><p>If you are using a database, use persistent database connections—setting up and tearing down database connections can be slow.</p></li>
<li><p>Don’t use a regular expression when a simple string-manipulation function will do the job. For example, to turn one character into another in a string, use <a contenteditable="false" data-type="indexterm" data-primary="str_replace function" id="idm45922747085416"/><code>str_replace()</code>, not <a contenteditable="false" data-type="indexterm" data-primary="preg_replace function" id="idm45922747083992"/><code>preg_replace()</code>.</p></li>
</ul>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Optimizing Memory Requirements"><div class="sect2" id="optimizing_memory_requirements">
<h2>Optimizing Memory Requirements</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="memory requirements, optimizing" id="idm45922747080904"/><a contenteditable="false" data-type="indexterm" data-primary="memory requirements, optimizing" id="idm45922747079560"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="memory requirements, optimizing" id="idm45922747078488"/>Here are some techniques for reducing the memory requirements of your scripts:</p>
<ul>
<li><p>Use numbers instead of strings whenever possible:</p>
<pre data-type="programlisting" data-code-language="php"><code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="s2">"0"</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="s2">"10"</code><code class="p">;</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="c1">// bad</code>
<code class="k">for</code> <code class="p">(</code><code class="nv">$i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nv">$i</code> <code class="o">&lt;</code> <code class="mi">10</code><code class="p">;</code> <code class="nv">$i</code><code class="o">++</code><code class="p">)</code> <code class="c1">// good</code></pre></li>
<li><p>When you’re done with a large string, set the variable holding the string to an empty string. This frees up the memory to be reused.</p></li>
<li><p>Only include or require files that you need. Use <a contenteditable="false" data-type="indexterm" data-primary="include_once function" id="idm45922746964696"/><code>include_once()</code> and <a contenteditable="false" data-type="indexterm" data-primary="require_once function" id="idm45922746963272"/><code>require_once()</code> instead of <code>include()</code> and <code>require()</code>.</p></li>
<li><p>Release MySQL or other database result sets as soon as you are done with them. There is no benefit to keeping result sets in memory beyond their use.</p></li>
</ul>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Reverse Proxies and Replication"><div class="sect2" id="reverse_proxies_and_replication">
<h2>Reverse Proxies and Replication</h2>
<p>Adding hardware is often the quickest route to better performance. It’s better to benchmark your software first, though, as it’s generally cheaper to fix software than to buy new hardware. Three common solutions to the problem of scaling traffic are reverse-proxy caches, load-balancing servers, and database replication.</p>
<section data-type="sect3" data-pdf-bookmark="Reverse-proxy caches"><div class="sect3" id="reverse_proxy_caches">
<h3>Reverse-proxy caches</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="caching" data-secondary="web caching" id="idm45922746955912"/><a contenteditable="false" data-type="indexterm" data-primary="web caching" id="idm45922746954536"/><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="reverse proxy caches" id="idm45922747022856"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="reverse proxy caches" id="idm45922747021480"/><a contenteditable="false" data-type="indexterm" data-primary="reverse proxy caches" id="idm45922747020104"/>A <em>reverse proxy</em> is a program that sits in front of your web server and handles all connections from client browsers. Proxies are optimized to serve up static files quickly, and despite appearances and implementation, most dynamic sites can be cached for short periods of time without loss of service. Normally, you’ll run the proxy on a separate machine from your web server.</p>
<p>Take, for example, a busy site whose front page is hit 50 times per second. If this first page is built from two database queries and the database changes as often as twice a minute, you can avoid 5,994 database queries per minute by using a <a contenteditable="false" data-type="indexterm" data-primary="Cache-Control header" id="idm45922747017368"/><code>Cache-Control</code> header to tell the reverse proxy to cache the page for 30 seconds. The worst-case scenario is that there will be a 30-second delay from database update to a user seeing this new data. For most applications that’s not a very long delay, and it gives significant performance benefits.</p>
<p>Proxy caches can even intelligently cache content that is personalized or tailored to the browser type, accepted language, or similar feature. The typical solution is to send a <code>Vary</code> header telling the cache exactly which request parameters affect the caching.</p>
<p>There are hardware proxy caches available, but there are also very good software implementations. <a contenteditable="false" data-type="indexterm" data-primary="Squid proxy cache" id="idm45922747013768"/><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Squid proxy cache" id="idm45922747012664"/>For a high-quality and extremely flexible open source proxy cache, have a look at <a href="http://www.squid-cache.org">Squid</a>. <a contenteditable="false" data-type="indexterm" data-primary="Web Caching (O'Reilly)" id="idm45922747010504"/><a contenteditable="false" data-type="indexterm" data-primary="Wessels, Duane (author)" data-secondary="Web Caching (O'Reilly)" id="idm45922747009368"/>See the book <a class="orm:hideurl" href="http://oreil.ly/Web_Caching"><em>Web Caching</em></a> (O’Reilly) by Duane Wessels for more information on proxy caches and how to tune a website to work with one.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Load balancing and redirection"><div class="sect3" id="load_balancing_and_redirection">
<h3>Load balancing and redirection</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="load balancing for" id="idm45922747005352"/><a contenteditable="false" data-type="indexterm" data-primary="load balancing" id="idm45922747003752"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="load balancing" id="idm45922747002648"/>One way to boost performance is to spread the load over a number of machines. A <em>load-balancing system</em> does this by either evenly distributing the load or sending incoming requests to the least-loaded machine. <a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="redirection for" id="idm45922747000600"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="redirection" id="idm45922746999224"/><a contenteditable="false" data-type="indexterm" data-primary="redirection" id="idm45922746997848"/>A <em>redirector</em> is a program that rewrites incoming URLs, allowing fine-grained control over the distribution of requests to individual server machines.</p>
<p>Again, there are hardware HTTP redirectors and load balancers, but redirection and load balancing can also be done effectively in software. By adding redirection logic to Squid through a tool like <a contenteditable="false" data-type="indexterm" data-primary="Squid Guard" id="idm45922746995512"/><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Squid Guard" id="idm45922746994408"/><a href="http://www.squidguard.org">SquidGuard</a>, you can improve performance in a number of ways.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="MySQL replication"><div class="sect3" id="mysql_replication">
<h3>MySQL replication</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="performance tuning" data-secondary="MySQLi replication for" id="idm45922746888744"/><a contenteditable="false" data-type="indexterm" data-primary="MySQL replication" id="idm45922746887528"/><a contenteditable="false" data-type="indexterm" data-primary="application techniques" data-secondary="MySQL replication" id="idm45922746886488"/>Sometimes the database server is the bottleneck—many simultaneous queries can bog down a database server, resulting in sluggish performance. Replication is one of the best solutions. Take everything that happens to one database and quickly bring one or more other databases in sync, so you end up with multiple identical databases. This lets you spread your queries across many database servers instead of loading down only one.</p>
<p>The most effective model is to use one-way replication, where you have a single master database that gets replicated to a number of slave databases. Database writes go to the master server, and database reads are load-balanced across multiple slave databases. This technique is aimed at architectures that do a lot more reads than writes. Most web applications fit this scenario nicely.</p>
<p><a data-type="xref" href="#database_replication_relationship">Figure 15-1</a> shows the relationship between the master and slave databases during replication.</p>
<figure class="width-50"><div id="database_replication_relationship" class="figure">
<img src="Images/php4_1502.png" alt="Database replication relationship" width="840" height="306"/>
<h6><span class="label">Figure 15-1. </span>Database replication relationship</h6>
</div></figure>
<p>Many databases support replication, including MySQL, PostgreSQL, and Oracle.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Putting it all together"><div class="sect3" id="putting_it_all_togethe">
<h3>Putting it all together</h3>
<p>For a really high-powered architecture, pull all these concepts together into a configuration like the one shown in <a data-type="xref" href="#putting_it_all_together">Figure 15-2</a>.</p>

<p>Using five separate machines—one for the reverse proxy and redirector, three web servers, and one master database server—this architecture can handle a huge number of requests. The exact number depends only on the two bottlenecks—the single Squid proxy and the single master database server. With a bit of creativity, either or both of these could be split across multiple servers as well, but as it is, if your application is somewhat cacheable and heavy on database reads, this is a nice approach.</p>

<figure class="width-75"><div id="putting_it_all_together" class="figure">
<img src="Images/php4_1503.png" alt="Putting it all together" width="840" height="504"/>
<h6><span class="label">Figure 15-2. </span>Putting it all together</h6>
</div></figure>

<p>Each Apache server gets its own read-only MySQL database, so all read requests from your PHP scripts go over a Unix-domain local socket to a dedicated MySQL instance. You can add as many of these Apache/PHP/MySQL servers as you need under this framework. Any database writes from your PHP applications will go over a Transmission Control Protocol (TCP) socket to the master MySQL server.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_ch15" id="idm45922746872760"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_app_tech_perf_tune" id="idm45922746871384"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_perf_tune_app_tech" id="idm45922746870008"/></p>
</div></section>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What’s Next"><div class="sect1" id="whatapostrophes_next-id00073">
<h1>What’s Next</h1>
<p>In the next chapter, we’ll dive deeper into using PHP to develop and deploy web <span class="keep-together">services.</span></p>
</div></section>
</div></section></div>



  </body></html>