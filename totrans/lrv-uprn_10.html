<html><head></head><body><section data-pdf-bookmark="Chapter 10. Requests, Responses, and Middleware" data-type="chapter" epub:type="chapter"><div class="chapter" id="requests_and_responses">&#13;
<h1><span class="label">Chapter 10. </span>Requests, Responses, and Middleware</h1>&#13;
&#13;
&#13;
<p>We’ve already talked a bit about the Illuminate <code>Request</code> object. In <a data-type="xref" href="ch03.html#routing">Chapter 3</a>, for example, you saw how you can typehint it in constructors to get an instance or use the <code>request()</code> helper to retrieve it, and in <a data-type="xref" href="ch07.html#collecting_and_handling_user_data">Chapter 7</a> we looked at how you can use it to get information about the user’s input.</p>&#13;
&#13;
<p>In this chapter, you’ll learn more about what the <code>Request</code> object is, how it’s generated, what it represents, and what part it plays in your application’s lifecycle. We’ll <span class="keep-together">also talk</span> about the <code>Response</code> object and Laravel’s implementation of the middleware pattern.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Laravel’s Request Lifecycle" data-type="sect1"><div class="sect1" id="id446">&#13;
<h1>Laravel’s Request Lifecycle</h1>&#13;
&#13;
<p>Every request<a data-primary="Response objects" data-secondary="lifecycle of requests/responses" data-type="indexterm" id="RPlife10"/><a data-primary="Request objects" data-secondary="lifecycle of requests/responses" data-type="indexterm" id="ROlife10"/> coming into a Laravel application, whether generated by an HTTP request or a command-line interaction, is immediately converted into an Illuminate <code>Request</code> object, which then crosses many layers and ends up being parsed by the application itself. The application then generates an Illuminate <code>Response</code> object, which is sent back out across those layers and finally returned to the end user.</p>&#13;
&#13;
<p>This request/response lifecycle is illustrated in <a data-type="xref" href="#FIG1001">Figure 10-1</a>. Let’s take a look at what it takes to make each of these steps happen, from the first line of code to the last.</p>&#13;
&#13;
<figure><div class="figure" id="FIG1001">&#13;
<img alt="lur3 1001" src="assets/lur3_1001.png"/>&#13;
<h6><span class="label">Figure 10-1. </span>Request/response lifecycle</h6>&#13;
</div></figure>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Bootstrapping the Application" data-type="sect2"><div class="sect2" id="id447">&#13;
<h2>Bootstrapping the Application</h2>&#13;
&#13;
<p>Every Laravel application<a data-primary="Composer" data-secondary="bootstrapping Laravel applications" data-type="indexterm" id="id1372"/> has some form of configuration set up at the web server level, in an Apache <em>.htaccess</em> file or an Nginx configuration setting or something similar, that captures every web request regardless of URL and routes it to <em>public/index.php</em> in the Laravel application directory.</p>&#13;
&#13;
<p><em>index.php</em> doesn’t actually have that much code in it. It has three primary functions.</p>&#13;
&#13;
<p>First, it loads Composer’s autoload file, which registers all of the Composer-loaded dependencies.</p>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1373">&#13;
<h1>Composer and Laravel</h1>&#13;
<p>Laravel’s core functionality<a data-primary="Composer" data-secondary="as collection of components" data-secondary-sortas="collection of components" data-type="indexterm" id="id1374"/> is separated into a series of components under the <code class="keep-together">Illuminate</code> namespace, which are all pulled into each Laravel app using Composer. Laravel also pulls in quite a few packages from Symfony and several other community-developed packages. In this way, Laravel is just as much an opinionated collection of components as it is a framework.</p>&#13;
</div></aside>&#13;
&#13;
<p>Next, it kicks off Laravel’s bootstrap, creating the application container (you’ll learn more about the container in <a data-type="xref" href="ch11.html#the_container">Chapter 11</a>) and registering a few core services (including the kernel, which we’ll talk about in just a bit).</p>&#13;
&#13;
<p>Finally, it creates an instance of the kernel, creates a request representing the current user’s web request, and passes the request to the kernel to handle. The kernel responds with an Illuminate <code>Response</code> object, which <em>index.php</em> returns to the end user. Then, the kernel terminates the page request.</p>&#13;
&#13;
<p>The kernel is the core router of every Laravel application, responsible for taking in a user request, processing it through middleware, handling exceptions and passing it to the page router, and then returning the final response. Actually, there are two kernels, but only one is used for each page request. One of the routers handles web requests (the HTTP kernel), and the other handles console, cron, and Artisan requests (the console kernel). Each has a <code>handle()</code> method that’s responsible for taking in an Illuminate <code>Request</code> object and returning an Illuminate <code>Response</code> object.</p>&#13;
&#13;
<p>The kernel runs all of the bootstraps that need to run before every request, including determining which environment the current request is running in (staging, local, production, etc.) and running all of the service providers. The HTTP kernel additionally defines the list of middleware that will wrap each request, including the core middleware responsible for sessions and CSRF protection.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Service Providers" data-type="sect2"><div class="sect2" id="service_providers">&#13;
<h2>Service Providers</h2>&#13;
&#13;
<p>Although<a data-primary="service providers" data-type="indexterm" id="id1375"/> there’s a bit of procedural code in these bootstraps, almost all of Laravel’s bootstrap code is separated into something Laravel calls <em>service providers</em>. A service provider is a class that encapsulates logic that various parts of your application need to run to bootstrap their core functionality.</p>&#13;
&#13;
<p>For example, there’s an <code>AuthServiceProvider</code> that bootstraps all of the registrations necessary for Laravel’s authentication system and a <code>RouteServiceProvider</code> that bootstraps the routing system.</p>&#13;
&#13;
<p>The concept of service providers can be a little hard to understand at first, so think about it this way: many components of your application have bootstrap code that needs to run when the application initializes. Service providers are a tool for grouping that bootstrap code into related classes. If you have any code that needs to run <span class="keep-together"><em>in preparation</em></span> for your application code to work, it’s a strong candidate for a service provider.</p>&#13;
&#13;
<p>For example, if you ever find that the feature you’re working on requires some classes registered in the container (you’ll learn more about this in <a data-type="xref" href="ch11.html#the_container">Chapter 11</a>), you would <span class="keep-together">create</span> a service provider just for that piece of functionality. You might have a <code class="keep-together">GitHubServiceProvider</code> or a <code>MailerServiceProvider</code>.</p>&#13;
&#13;
<p>Service providers<a data-primary="boot() method" data-type="indexterm" id="id1376"/><a data-primary="register() method" data-type="indexterm" id="id1377"/> have two important methods: <code>boot()</code> and <code>register()</code>. There’s also a <code>DeferrableProvider</code> interface that you might choose to use. Here’s how they work.</p>&#13;
&#13;
<p>First, all of the service providers’ <code>register()</code> methods are called. This is where you’ll want to bind classes and aliases to the container. You don’t want to do anything in <code>register()</code> that relies on the entire application being bootstrapped.</p>&#13;
&#13;
<p>Second, all of the service providers’ <code>boot()</code> methods are called. You can now do any other bootstrapping here, like binding event listeners or defining routes—​anything that may rely on the entire Laravel application having been bootstrapped.</p>&#13;
&#13;
<p>If your service provider is only going to register bindings in the container (i.e., teach the container how to resolve a given class or interface), but not perform any other bootstrapping, you can “defer” its registrations, which means they won’t run unless one of their bindings is explicitly requested from the container. This can speed up your application’s average time to bootstrap.</p>&#13;
&#13;
<p>If you want to defer your service provider’s registrations, first implement the <code>Illuminate\Contracts\Support\DeferrableProvider</code> interface; then, give the service provider a <code>provides()</code> method that returns a list of bindings the provider provides, as shown in <a data-type="xref" href="#EX1001">Example 10-1</a>.</p>&#13;
<div data-type="example" id="EX1001">&#13;
<h5><span class="label">Example 10-1. </span>Deferring the registration of a service provider</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Support\DeferrableProvider</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">GitHubServiceProvider</code> <code class="k">extends</code> <code class="nx">ServiceProvider</code> <code class="k">implements</code> <code class="nx">DeferrableProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">provides</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="p">[</code>&#13;
            <code class="nx">GitHubClient</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
        <code class="p">];</code>&#13;
    <code class="p">}</code></pre></div>&#13;
<div data-type="tip"><h1>More Uses for Service Providers</h1>&#13;
<p>Service providers also have a suite of methods and configuration options that can provide advanced functionality to the end user when the provider is published as part of a Composer package. Take a look at the service provider definition in the <a href="https://oreil.ly/uHhap">Laravel source</a> to learn more about how this can work.</p>&#13;
</div>&#13;
&#13;
<p>Now that we’ve covered the application bootstrap, let’s take a look at the <code>Request</code> object, the most important output of the bootstrap.<a data-primary="" data-startref="RPlife10" data-type="indexterm" id="id1378"/><a data-primary="" data-startref="ROlife10" data-type="indexterm" id="id1379"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Request Object" data-type="sect1"><div class="sect1" id="id205">&#13;
<h1>The Request Object</h1>&#13;
&#13;
<p>The <code>Illuminate\Http\Request</code> class<a data-primary="Symfony HttpFoundation" data-type="indexterm" id="id1380"/><a data-primary="Request objects" data-secondary="basics of" data-type="indexterm" id="id1381"/> is a Laravel-specific extension of Symfony’s <span class="keep-together"><code>HttpFoundation</code></span><code>\Request</code> class.</p>&#13;
<div data-type="note" epub:type="note"><h1>Symfony HttpFoundation</h1>&#13;
<p>Symfony’s <code>HttpFoundation</code> suite of classes powers almost every PHP framework in existence at this point; this is the most popular and powerful set of abstractions available in PHP for representing HTTP requests, responses, headers, cookies, and more.</p>&#13;
</div>&#13;
&#13;
<p>The <code>Request</code> object is intended to represent every relevant piece of information you might care to know about a user’s HTTP request.</p>&#13;
&#13;
<p>In native PHP code, you might find yourself looking to <code>$_SERVER</code>, <code>$_GET</code>, <code>$_POST</code>, and other combinations of globals and processing logic to get information about the current user’s request. What files has the user uploaded? What’s their IP address? What fields did they post? All of this is sprinkled around the language—​and your code—​in a way that’s hard to understand and harder to mock.</p>&#13;
&#13;
<p>Symfony’s <code>Request</code> object instead collects all of the information necessary to represent a single HTTP request into a single object, and then tacks on convenience <span class="keep-together">methods</span> to make it easy to get useful information from it. The Illuminate <code>Request</code> object adds even more convenience methods to get information about the request <span class="keep-together">it’s representing.</span></p>&#13;
<div data-type="tip"><h1>Capturing a Request</h1>&#13;
<p>You’ll<a data-primary="Request objects" data-secondary="capturing" data-type="indexterm" id="id1382"/><a data-primary="capture() method" data-type="indexterm" id="id1383"/> very likely never need to do this in a Laravel app, but if you ever need to capture your own Illuminate <code>Request</code> object directly from PHP’s globals, you can use the <code>capture()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code> <code class="o">=</code> <code class="nx">Illuminate\Http\Request</code><code class="o">::</code><code class="na">capture</code><code class="p">();</code></pre>&#13;
</div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting a Request Object in Laravel" data-type="sect2"><div class="sect2" id="id206">&#13;
<h2>Getting a Request Object in Laravel</h2>&#13;
&#13;
<p>Laravel creates<a data-primary="Request objects" data-secondary="getting in Laravel" data-type="indexterm" id="id1384"/> an internal <code>Request</code> object for each request, and there are a few ways you can get access to it.</p>&#13;
&#13;
<p>First—and again, we’ll<a data-primary="typehints" data-type="indexterm" id="id1385"/> cover this more in <a data-type="xref" href="ch11.html#the_container">Chapter 11</a>—you can typehint the class in any constructor or method that’s resolved by the container. That means you can typehint it in a controller method or a service provider, as seen in <a data-type="xref" href="#EX1002">Example 10-2</a>.</p>&#13;
<div data-type="example" id="EX1002">&#13;
<h5><span class="label">Example 10-2. </span>Typehinting in a container-resolved method to receive a <code>Request</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Http\Request</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">PersonController</code> <code class="k">extends</code> <code class="nx">Controller</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$allInput</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">();</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Alternatively, you can use the <code>request()</code> global helper, which allows you to call methods on it (e.g., <code>request()-&gt;input()</code>) and also allows you to call it on its own to get an instance of <code>$request</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code> <code class="o">=</code> <code class="nx">request</code><code class="p">();</code>&#13;
<code class="nv">$allInput</code> <code class="o">=</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">();</code>&#13;
<code class="c1">// or</code>&#13;
<code class="nv">$allInput</code> <code class="o">=</code> <code class="nx">request</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">();</code></pre>&#13;
&#13;
<p>Finally, you can use the <code>app()</code> global method to get an instance of <code>Request</code>. You can pass either the fully qualified class name or the shortcut <code>request</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code> <code class="o">=</code> <code class="nx">app</code><code class="p">(</code><code class="nx">Illuminate\Http\Request</code><code class="o">::</code><code class="na">class</code><code class="p">);</code>&#13;
<code class="nv">$request</code> <code class="o">=</code> <code class="nx">app</code><code class="p">(</code><code class="s1">'request'</code><code class="p">);</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Getting Basic Information About a Request" data-type="sect2"><div class="sect2" id="id448">&#13;
<h2>Getting Basic Information About a Request</h2>&#13;
&#13;
<p>Now<a data-primary="Request objects" data-secondary="getting information about requests" data-type="indexterm" id="ROinfo10"/> that you know how to get an instance of <code>Request</code>, what can you do with it? The primary purpose of the <code>Request</code> object is to represent the current HTTP request, so the primary functionality the <code>Request</code> class offers is to make it easy to get useful information about the current request.</p>&#13;
&#13;
<p>I’ve categorized the methods described here, but note that there’s certainly overlap between the categories, and the categories are a bit arbitrary—​for example, query parameters could just as easily be in “User and request state” as they are in “Basic user input.” Hopefully these categories will make it easy for you to learn what’s available, and then you can throw away the categories.</p>&#13;
&#13;
<p>Also, be aware that there are many more methods available on the <code>Request</code> object; these are just the most commonly used methods.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Basic user input" data-type="sect3"><div class="sect3" id="id207">&#13;
<h3>Basic user input</h3>&#13;
&#13;
<p>The basic user input methods make it simple to get information that the users themselves explicitly provide—​likely through submitting a form or an Ajax component. When I reference “user-provided input” here, I’m talking about input from query strings (<code>GET</code>), form submissions (<code>POST</code>), or JSON. The basic user input methods include the following:</p>&#13;
<dl>&#13;
<dt><code>all()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all user-provided input.</p>&#13;
</dd>&#13;
<dt><code>input(<em>fieldName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns the value of a single user-provided input field.</p>&#13;
</dd>&#13;
<dt><code>only(<em>fieldName</em>|[<em>array,of,field,names</em>])</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all user-provided input for the specified field name(s).</p>&#13;
</dd>&#13;
<dt><code>except(<em>fieldName</em>|[<em>array,of,field,names</em>])</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all user-provided input except for the specified field name(s).</p>&#13;
</dd>&#13;
<dt><code>exists(<em>fieldName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether the field exists in the input. <code>has()</code> is an alias.&#13;
Executes the given callback when the field exists in the input.</p>&#13;
</dd>&#13;
<dt><code>filled(<em>fieldName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether the field exists in the input and is not empty (that is, has a value).</p>&#13;
</dd>&#13;
<dt><code>whenFilled()</code></dt>&#13;
<dd>&#13;
<p>Executes the given callback when the field exists in the input and is not empty (that is, has a value).</p>&#13;
</dd>&#13;
<dt><code>json()</code></dt>&#13;
<dd>&#13;
<p>Returns a <code>ParameterBag</code> if the page had JSON sent to it.</p>&#13;
</dd>&#13;
<dt><code>boolean(<em>fieldName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns value from the input as a Boolean. Converts strings and integers to appropriate booleans (using <code>FILTER_VALIDATE_BOOLEAN</code>). If the key is not present in the request, returns <code>false</code>.</p>&#13;
</dd>&#13;
<dt><code>json(<em>keyName</em>)</code></dt>&#13;
<dd>&#13;
<p>Returns the value of the given key from the JSON sent to the page.</p>&#13;
</dd>&#13;
</dl>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1386">&#13;
<h1>ParameterBag</h1>&#13;
<p>Sometimes<a data-primary="ParameterBag objects" data-type="indexterm" id="id1387"/> in Laravel you’ll run into a <code>ParameterBag</code> object. This class is sort of like an associative array. You can get a particular key using <code>get()</code>:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">echo</code> <code class="nv">$bag</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">(</code><code class="s1">'name'</code><code class="p">);</code></pre>&#13;
&#13;
<p>You can also use <code>has()</code> to check for the existence of a key, <code>all()</code> to get an array of all keys and values, <code>count()</code> to count the number of items, and <code>keys()</code> to get an array of just the keys.</p>&#13;
</div></aside>&#13;
&#13;
<p><a data-type="xref" href="#EX1003">Example 10-3</a> gives a few quick examples of how to use the user-provided information methods from a request.</p>&#13;
<div data-type="example" id="EX1003">&#13;
<h5><span class="label">Example 10-3. </span>Getting basic user-provided information from the request</h5>&#13;
&#13;
<pre data-code-language="html" data-type="programlisting">// form&#13;
<code class="p">&lt;</code><code class="nt">form</code> <code class="na">method</code><code class="o">=</code><code class="s">"POST"</code> <code class="na">action</code><code class="o">=</code><code class="s">"/form"</code><code class="p">&gt;</code>&#13;
    @csrf&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">name</code><code class="o">=</code><code class="s">"name"</code><code class="p">&gt;</code> Name<code class="p">&lt;</code><code class="nt">br</code><code class="p">&gt;</code>&#13;
    <code class="p">&lt;</code><code class="nt">input</code> <code class="na">type</code><code class="o">=</code><code class="s">"submit"</code><code class="p">&gt;</code>&#13;
<code class="p">&lt;/</code><code class="nt">form</code><code class="p">&gt;</code></pre>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Route receiving the form</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'form'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">echo</code> <code class="s1">'name is '</code> <code class="o">.</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'name'</code><code class="p">)</code> <code class="o">.</code> <code class="s1">'&lt;br&gt;'</code><code class="p">;</code>&#13;
    <code class="k">echo</code> <code class="s1">'all input is '</code> <code class="o">.</code> <code class="nb">print_r</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">all</code><code class="p">())</code> <code class="o">.</code> <code class="s1">'&lt;br&gt;'</code><code class="p">;</code>&#13;
    <code class="k">echo</code> <code class="s1">'user provided email address: '</code> <code class="o">.</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">has</code><code class="p">(</code><code class="s1">'email'</code><code class="p">)</code> <code class="o">?</code> <code class="s1">'true'</code> <code class="o">:</code> <code class="s1">'false'</code><code class="p">;</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="User and request state" data-type="sect3"><div class="sect3" id="id689">&#13;
<h3>User and request state</h3>&#13;
&#13;
<p>The user and request state methods include input that wasn’t explicitly provided by the user through a form:</p>&#13;
<dl>&#13;
<dt><code>method()</code></dt>&#13;
<dd>&#13;
<p>Returns the method (<code>GET</code>, <code>POST</code>, <code>PATCH</code>, etc.) used to access this route.</p>&#13;
</dd>&#13;
<dt><code>path()</code></dt>&#13;
<dd>&#13;
<p>Returns the path (without the domain) used to access this page; for example, <code>'http://www.myapp.com/abc/def'</code> would return <code>'abc/def'</code>.</p>&#13;
</dd>&#13;
<dt><code>url()</code></dt>&#13;
<dd>&#13;
<p>Returns the URL (with the domain) used to access this page; for example, <code>'abc'</code> would return <code>'http://www.myapp.com/abc'</code>.</p>&#13;
</dd>&#13;
<dt><code>is()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether or not the current page request fuzzy-matches a provided string (e.g., <code>/a/b/c</code> would be matched by <code>$request-&gt;is('*b*')</code>, where <code>*</code> stands for any characters); uses a custom regex parser found in <code>Str::is()</code>.</p>&#13;
</dd>&#13;
<dt><code>ip()</code></dt>&#13;
<dd>&#13;
<p>Returns the user’s IP address.</p>&#13;
</dd>&#13;
<dt><code>header()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of headers (e.g., <code>['accept-language' =&gt; ['⁠e⁠n⁠-⁠U⁠S⁠,⁠e⁠n⁠;​q⁠=⁠0⁠.⁠8⁠']]</code>), or, if passed a header name as a parameter, returns just that header.</p>&#13;
</dd>&#13;
<dt><code>server()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of the variables traditionally stored in <code>$_SERVER</code> (e.g., <code>REMOTE_ADDR</code>), or, if passed a <code>$_SERVER</code> variable name, returns just that value.</p>&#13;
</dd>&#13;
<dt><code>secure()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether this page was loaded using HTTPS.</p>&#13;
</dd>&#13;
<dt><code>pjax()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether this page request was loaded using Pjax.</p>&#13;
</dd>&#13;
<dt><code>wantsJson()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether this request has any <code>/json</code> content types in its <code>Accept</code> headers.</p>&#13;
</dd>&#13;
<dt><code>isJson()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether this page request has any <code>/json</code> content types in its <code>Content-Type</code> header.</p>&#13;
</dd>&#13;
<dt><code>accepts()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether this page request accepts a given content type.</p>&#13;
</dd>&#13;
</dl>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Files" data-type="sect3"><div class="sect3" id="id690">&#13;
<h3>Files</h3>&#13;
&#13;
<p>So far, all of the input we’ve covered is either explicit (retrieved by methods like <code>all()</code>, <code>input()</code>, etc.) or defined by the browser or referring site (retrieved by methods like <code>pjax()</code>). File inputs are similar to explicit user input, but they’re handled much differently:</p>&#13;
<dl>&#13;
<dt><code>file()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all uploaded files, or, if a key is passed (the file upload field name), returns just the one file.</p>&#13;
</dd>&#13;
<dt><code>allFiles()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all uploaded files; useful as opposed to <code>file()</code> because of clearer naming.</p>&#13;
</dd>&#13;
<dt><code>hasFile()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether a file was uploaded at the specified key.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>Every file that’s uploaded will be an instance of <code>Symfony\Component\HttpFoundation\File\UploadedFile</code>, which provides a suite of tools for validating, processing, and storing uploaded files.</p>&#13;
&#13;
<p>Take a look at <a data-type="xref" href="ch14.html#storage_and_retrieval">Chapter 14</a> for more examples of how to handle uploaded files.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Persistence" data-type="sect3"><div class="sect3" id="id208">&#13;
<h3>Persistence</h3>&#13;
&#13;
<p>The request can also provide functionality for interacting with the session. Most session functionality lives elsewhere, but there are a few methods that are particularly relevant to the current page request:</p>&#13;
<dl>&#13;
<dt><code>flash()</code></dt>&#13;
<dd>&#13;
<p>Flashes the current request’s user input to the session to be retrieved later, which means it’s saved to the session but disappears after the next request.</p>&#13;
</dd>&#13;
<dt><code>flashOnly()</code></dt>&#13;
<dd>&#13;
<p>Flashes the current request’s user input for any keys in the provided array.</p>&#13;
</dd>&#13;
<dt><code>flashExcept()</code></dt>&#13;
<dd>&#13;
<p>Flashes the current request’s user input, except for any keys in the provided array.</p>&#13;
</dd>&#13;
<dt><code>old()</code></dt>&#13;
<dd>&#13;
<p>Returns an array of all previously flashed user input, or, if passed a key, returns the value for that key if it was previously flashed.</p>&#13;
</dd>&#13;
<dt><code>flush()</code></dt>&#13;
<dd>&#13;
<p>Wipes all previously flashed user input.</p>&#13;
</dd>&#13;
<dt><code>cookie()</code></dt>&#13;
<dd>&#13;
<p>Retrieves all cookies from the request, or, if a key is provided, retrieves just that cookie.</p>&#13;
</dd>&#13;
<dt><code>hasCookie()</code></dt>&#13;
<dd>&#13;
<p>Returns a Boolean indicating whether the request has a cookie for the given key.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>The <code>flash*()</code> and <code>old()</code> methods are used for storing user input and retrieving it later, often after the input is validated and rejected.<a data-primary="" data-startref="ROinfo10" data-type="indexterm" id="id1388"/></p>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The Response Object" data-type="sect1"><div class="sect1" id="id449">&#13;
<h1>The Response Object</h1>&#13;
&#13;
<p>Similar<a data-primary="Response objects" data-secondary="basics of" data-type="indexterm" id="id1389"/> to the <code>Request</code> object, there’s an Illuminate <code>Response</code> object that represents the response your application is sending to the end user, complete with headers, cookies, content, and anything else used for sending the end user’s browser instructions on rendering a page.</p>&#13;
&#13;
<p>Just like <code>Request</code>, the <code>Illuminate\Http\Response</code> class extends a Symfony class: <code>Symfony\Component\HttpFoundation\Response</code>. This is a base class with a series of properties and methods that makes it possible to represent and render a response; Illuminate’s <code>Response</code> class decorates it with a few helpful shortcuts.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using and Creating Response Objects in Controllers" data-type="sect2"><div class="sect2" id="id450">&#13;
<h2>Using and Creating Response Objects in Controllers</h2>&#13;
&#13;
<p>Before<a data-primary="Response objects" data-secondary="using and creating in controllers" data-type="indexterm" id="id1390"/><a data-primary="routing and controllers" data-secondary="controllers" data-tertiary="using and creating Response objects in" data-type="indexterm" id="id1391"/> we talk about how you can customize your <code>Response</code> objects, let’s step back and see how we most commonly work with <code>Response</code> objects.</p>&#13;
&#13;
<p>In the end, any <code>Response</code> object returned from a route definition will be converted into an HTTP response. It may define specific headers or specific content, set cookies, or whatever else, but eventually it will be converted into a response your users’ browsers can parse.</p>&#13;
&#13;
<p>Let’s take a look at the simplest possible response, in <a data-type="xref" href="#EX1004">Example 10-4</a>.</p>&#13;
<div data-type="example" id="EX1004">&#13;
<h5><span class="label">Example 10-4. </span>Simplest possible HTTP response</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="k">new</code> <code class="nx">Illuminate\Http\Response</code><code class="p">(</code><code class="s1">'Hello!'</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="c1">// Same, using global function:</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="s1">'Hello!'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>We create a response, give it some core data, and then return it. We can also customize the HTTP status, headers, cookies, and more, like in <a data-type="xref" href="#EX1005">Example 10-5</a>.</p>&#13;
<div data-type="example" id="EX1005">&#13;
<h5><span class="label">Example 10-5. </span>Simple HTTP response with customized status and headers</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'route'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="s1">'Error!'</code><code class="p">,</code> <code class="mi">400</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">header</code><code class="p">(</code><code class="s1">'X-Header-Name'</code><code class="p">,</code> <code class="s1">'header-value'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="s1">'cookie-name'</code><code class="p">,</code> <code class="s1">'cookie-value'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Setting headers" data-type="sect3"><div class="sect3" id="id209">&#13;
<h3>Setting headers</h3>&#13;
&#13;
<p>We<a data-primary="header() fluent method" data-type="indexterm" id="id1392"/> define a header on a response by using the <code>header()</code> fluent method, like in <a data-type="xref" href="#EX1005">Example 10-5</a>. The first parameter is the header name, and the second is the header value.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Adding cookies" data-type="sect3"><div class="sect3" id="id451">&#13;
<h3>Adding cookies</h3>&#13;
&#13;
<p>We<a data-primary="cookies" data-secondary="attaching to responses" data-type="indexterm" id="id1393"/> can also set cookies directly on the <code>Response</code> object if we’d like. We’ll cover Laravel’s cookie handling a bit more in <a data-type="xref" href="ch14.html#storage_and_retrieval">Chapter 14</a>, but take a look at <a data-type="xref" href="#EX1006">Example 10-6</a> for a simple use case for attaching cookies to a response.</p>&#13;
<div data-type="example" id="EX1006">&#13;
<h5><span class="label">Example 10-6. </span>Attaching a cookie to a response</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="nv">$content</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="s1">'signup_dismissed'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Specialized Response Types" data-type="sect2"><div class="sect2" id="id452">&#13;
<h2>Specialized Response Types</h2>&#13;
&#13;
<p>There<a data-primary="Response objects" data-secondary="specialized response types" data-type="indexterm" id="ROspecial10"/> are also a few special response types for views, downloads, files, and JSON. Each is a predefined macro that makes it easy to reuse particular templates for headers or content structure.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="View responses" data-type="sect3"><div class="sect3" id="id576">&#13;
<h3>View responses</h3>&#13;
&#13;
<p>In <a data-type="xref" href="ch03.html#routing">Chapter 3</a>, I<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="view responses" data-type="indexterm" id="id1394"/> used the global <code>view()</code> helper to show how to return a template—​for example, <code>view('<em>view.name.here</em>')</code> or something similar. But if you need to customize the headers, HTTP status, or anything else when returning a view, you can use the <code>view()</code> response type as shown in <a data-type="xref" href="#EX1007">Example 10-7</a>.</p>&#13;
<div data-type="example" id="EX1007">&#13;
<h5><span class="label">Example 10-7. </span>Using the <code>view()</code> response type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">XmlGetterService</code> <code class="nv">$xml</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="nv">$data</code> <code class="o">=</code> <code class="nv">$xml</code><code class="o">-&gt;</code><code class="na">get</code><code class="p">();</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">view</code><code class="p">(</code><code class="s1">'xml-structure'</code><code class="p">,</code> <code class="nv">$data</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">header</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/xml'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Download responses" data-type="sect3"><div class="sect3" id="id577">&#13;
<h3>Download responses</h3>&#13;
&#13;
<p>Sometimes<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="download responses" data-type="indexterm" id="id1395"/> you want your application to force the user’s browser to download a file, whether you’re creating the file in Laravel or serving it from a database or a protected location. The <code>download()</code> response type makes this simple.</p>&#13;
&#13;
<p>The required first parameter is the path for the file you want the browser to download. If it’s a generated file, you’ll need to save it somewhere temporarily.</p>&#13;
&#13;
<p>The optional second parameter is the filename for the downloaded file (e.g., <em>export.csv</em>). If you don’t pass a string here, the name will be generated automatically. The optional third parameter allows you to pass an array of headers. <a data-type="xref" href="#EX1008">Example 10-8</a> illustrates the use of the <code>download()</code> response type.</p>&#13;
<div data-type="example" id="EX1008">&#13;
<h5><span class="label">Example 10-8. </span>Using the <code>download()</code> response type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">export</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">download</code><code class="p">(</code><code class="s1">'file.csv'</code><code class="p">,</code> <code class="s1">'export.csv'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'header'</code> <code class="o">=&gt;</code> <code class="s1">'value'</code><code class="p">]);</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">otherExport</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">download</code><code class="p">(</code><code class="s1">'file.pdf'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>If you wish to delete the original file from the disk after returning a download response, you can chain the <code>deleteFileAfterSend()</code> method after the <code>download()</code> method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">export</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">download</code><code class="p">(</code><code class="s1">'file.csv'</code><code class="p">,</code> <code class="s1">'export.csv'</code><code class="p">)</code>&#13;
        <code class="o">-&gt;</code><code class="na">deleteFileAfterSend</code><code class="p">();</code>&#13;
<code class="p">}</code></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="File responses" data-type="sect3"><div class="sect3" id="id453">&#13;
<h3>File responses</h3>&#13;
&#13;
<p>The<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="file responses" data-type="indexterm" id="id1396"/><a data-primary="files" data-secondary="file responses in request/response process" data-type="indexterm" id="id1397"/> file response is similar to the download response, except it allows the browser to display the file instead of forcing a download. This is most common with images <span class="keep-together">and PDFs.</span></p>&#13;
&#13;
<p>The required first parameter is the filename, and the optional second parameter can be an array of headers (see <a data-type="xref" href="#EX1009">Example 10-9</a>).</p>&#13;
<div data-type="example" id="EX1009">&#13;
<h5><span class="label">Example 10-9. </span>Using the <code>file()</code> response type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">invoice</code><code class="p">(</code><code class="nv">$id</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">file</code><code class="p">(</code><code class="s2">"./invoices/</code><code class="si">{</code><code class="nv">$id</code><code class="si">}</code><code class="s2">.pdf"</code><code class="p">,</code> <code class="p">[</code><code class="s1">'header'</code> <code class="o">=&gt;</code> <code class="s1">'value'</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="JSON responses" data-type="sect3"><div class="sect3" id="id454">&#13;
<h3>JSON responses</h3>&#13;
&#13;
<p>JSON responses<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="JSON responses" data-type="indexterm" id="id1398"/><a data-primary="JSON operations" data-secondary="JSON responses" data-type="indexterm" id="id1399"/> are so common that, even though they’re not really particularly complex to program, there’s a custom response for them as well.</p>&#13;
&#13;
<p>JSON responses convert the passed data to JSON (with <code>json_encode()</code>) and set the <code>Content-Type</code> to <code>application/json</code>. You can also optionally use the <code>setCallback()</code> method to create a JSONP response instead of JSON, as seen in <a data-type="xref" href="#EX1011">Example 10-10</a>.</p>&#13;
<div data-type="example" id="EX1011">&#13;
<h5><span class="label">Example 10-10. </span>Using the <code>json()</code> response type</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">contacts</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">());</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">jsonpContacts</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code>&#13;
        <code class="o">-&gt;</code><code class="na">json</code><code class="p">(</code><code class="nx">Contact</code><code class="o">::</code><code class="na">all</code><code class="p">())</code>&#13;
        <code class="o">-&gt;</code><code class="na">setCallback</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">input</code><code class="p">(</code><code class="s1">'callback'</code><code class="p">));</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">nonEloquentContacts</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">json</code><code class="p">([</code><code class="s1">'Tom'</code><code class="p">,</code> <code class="s1">'Jerry'</code><code class="p">]);</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Redirect responses" data-type="sect3"><div class="sect3" id="id578">&#13;
<h3>Redirect responses</h3>&#13;
&#13;
<p>Redirects aren’t<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="redirect responses" data-type="indexterm" id="id1400"/> commonly called on the <code>response()</code> helper, so they’re a bit different from the other custom response types we’ve discussed already, but they’re still just another sort of response. Redirects, returned from a Laravel route, send the user a redirect (often a 301) to another page or back to the previous page.</p>&#13;
&#13;
<p>You technically <em>can</em> call a redirect from <code>response()</code>, as in <code>return response()</code><code class="keep-together">-&gt;redirectTo('/')</code>. But, more commonly, you’ll use the redirect-specific global helpers.</p>&#13;
&#13;
<p>There is a global <code>redirect()</code> function that can be used to create redirect responses and a global <code>back()</code> function that is a shortcut to <code>redirect()-&gt;back()</code>.</p>&#13;
&#13;
<p>Just like most global helpers, the <code>redirect()</code> global function can either be passed parameters or be used to get an instance of its class that you then chain method calls onto. If you don’t chain, but just pass parameters, <code>redirect()</code> performs the same as <code>redirect()-&gt;to()</code>; it takes a string and redirects to that string URL. <a data-type="xref" href="#EX10011">Example 10-11</a> shows some examples of its use.</p>&#13;
<div data-type="example" id="EX10011">&#13;
<h5><span class="label">Example 10-11. </span>Examples of using the <code>redirect()</code> global helper</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'account/payment'</code><code class="p">);</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">to</code><code class="p">(</code><code class="s1">'account/payment'</code><code class="p">);</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">route</code><code class="p">(</code><code class="s1">'account.payment'</code><code class="p">);</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">action</code><code class="p">(</code><code class="s1">'AccountController@showPayment'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// If redirecting to an external domain</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">away</code><code class="p">(</code><code class="s1">'https://tighten.co'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// If named route or controller needs parameters</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">route</code><code class="p">(</code><code class="s1">'contacts.edit'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="mi">15</code><code class="p">]);</code>&#13;
<code class="k">return</code> <code class="nx">redirect</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">action</code><code class="p">(</code><code class="s1">'ContactController@edit'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'id'</code> <code class="o">=&gt;</code> <code class="mi">15</code><code class="p">]);</code></pre></div>&#13;
&#13;
<p>You can also redirect “back” to the previous page, which is especially useful when handling and validating user input. <a data-type="xref" href="#EX1012">Example 10-12</a> shows a common pattern in validation contexts.</p>&#13;
<div data-type="example" id="EX1012">&#13;
<h5><span class="label">Example 10-12. </span>Redirect back with input</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">store</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="c1">// If validation fails...</code>&#13;
    <code class="k">return</code> <code class="nx">back</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">withInput</code><code class="p">();</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Finally, you can redirect and flash data to the session at the same time. This is common with error and success messages, like in <a data-type="xref" href="#EX1013">Example 10-13</a>.</p>&#13;
<div data-type="example" id="EX1013">&#13;
<h5><span class="label">Example 10-13. </span>Redirect with flashed data</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">post</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Store the contact</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'message'</code><code class="p">,</code> <code class="s1">'Contact created!'</code><code class="p">);</code>&#13;
<code class="p">});</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'dashboard'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// Get the flashed data from session--usually handled in Blade template</code>&#13;
    <code class="k">echo</code> <code class="nx">session</code><code class="p">(</code><code class="s1">'message'</code><code class="p">);</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Custom response macros" data-type="sect3"><div class="sect3" id="id210">&#13;
<h3>Custom response macros</h3>&#13;
&#13;
<p>You can also create your own<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="custom response macros" data-type="indexterm" id="id1401"/><a data-primary="macros" data-type="indexterm" id="id1402"/> custom response types using <em>macros</em>. This allows you to define a series of modifications to make to the response and its provided content.</p>&#13;
&#13;
<p>Let’s re-create the <code>json()</code> custom response type, just to see how it works. As always, you should probably create a custom service provider for these sorts of bindings, but for now we’ll just put it in <code>AppServiceProvider</code>, as seen in <a data-type="xref" href="#EX1014">Example 10-14</a>.</p>&#13;
<div data-type="example" id="EX1014">&#13;
<h5><span class="label">Example 10-14. </span>Creating a custom response macro</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">AppServiceProvider</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nx">Response</code><code class="o">::</code><code class="na">macro</code><code class="p">(</code><code class="s1">'myJson'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nv">$content</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="nb">json_encode</code><code class="p">(</code><code class="nv">$content</code><code class="p">))</code>&#13;
                <code class="o">-&gt;</code><code class="na">withHeaders</code><code class="p">([</code><code class="s1">'Content-Type'</code> <code class="o">=&gt;</code> <code class="s1">'application/json'</code><code class="p">]);</code>&#13;
        <code class="p">});</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Then, we can use it just like we would use the predefined <code>json()</code> macro:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="nx">response</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">myJson</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Sangeetha'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>This will return a response with the body of that array encoded for JSON, with the JSON-appropriate <code>Content-Type</code> header.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="The responsable interface" data-type="sect3"><div class="sect3" id="id211">&#13;
<h3>The responsable interface</h3>&#13;
&#13;
<p>If you’d like to<a data-primary="Response objects" data-secondary="specialized response types" data-tertiary="Responsable interface" data-type="indexterm" id="id1403"/><a data-primary="Responsable interface" data-type="indexterm" id="id1404"/> customize how you’re sending responses and a macro doesn’t offer enough space or enough organization, or if you want any of your objects to be capable of being returned as a “response” with their own logic of how to be displayed, the <code>Responsable</code> interface is for you.</p>&#13;
&#13;
<p>The <code>Responsable</code> interface, <code>Illuminate\Contracts\Support\Responsable</code>, dictates that its implementors must have a <code>toResponse()</code> method. This needs to return an Illuminate <code>Response</code> object. <a data-type="xref" href="#EX1022">Example 10-15</a> illustrates how to create a <code>Responsable</code> object.</p>&#13;
<div data-type="example" id="EX1022">&#13;
<h5><span class="label">Example 10-15. </span>Creating a simple <code>Responsable</code> object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Support\Responsable</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">MyJson</code> <code class="k">implements</code> <code class="nx">Responsable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$content</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">content</code> <code class="o">=</code> <code class="nv">$content</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toResponse</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="nb">json_encode</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">content</code><code class="p">))</code>&#13;
            <code class="o">-&gt;</code><code class="na">withHeaders</code><code class="p">([</code><code class="s1">'Content-Type'</code> <code class="o">=&gt;</code> <code class="s1">'application/json'</code><code class="p">]);</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>Then, we can use it just like our custom macro:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">return</code> <code class="k">new</code> <code class="nx">MyJson</code><code class="p">([</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s1">'Sangeetha'</code><code class="p">]);</code></pre>&#13;
&#13;
<p>This probably looks like a lot of work relative to the response macros we covered earlier. But the <code>Responsable</code> interface really shines when you’re working with more complicated controller manipulations. One common example is to use it to create view models (or view objects), like in <a data-type="xref" href="#EX1023">Example 10-16</a>.</p>&#13;
<div data-type="example" id="EX1023">&#13;
<h5><span class="label">Example 10-16. </span>Using <code>Responsable</code> to create a view object</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">use</code> <code class="nx">Illuminate\Contracts\Support\Responsable</code><code class="p">;</code>&#13;
&#13;
<code class="k">class</code> <code class="nc">GroupDonationDashboard</code> <code class="k">implements</code> <code class="nx">Responsable</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="fm">__construct</code><code class="p">(</code><code class="nv">$group</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">group</code> <code class="o">=</code> <code class="nv">$group</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">budgetThisYear</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// ...</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">giftsThisYear</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// ...</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">toResponse</code><code class="p">()</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'groups.dashboard'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'annual_budget'</code><code class="p">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">budgetThisYear</code><code class="p">())</code>&#13;
            <code class="o">-&gt;</code><code class="na">with</code><code class="p">(</code><code class="s1">'annual_gifts_received'</code><code class="p">,</code> <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">giftsThisYear</code><code class="p">());</code>&#13;
    <code class="p">}</code></pre></div>&#13;
&#13;
<p>It starts to make a little bit more sense in this context—move your complex view preparation into a dedicated, <em>testable</em> object, and keep your controllers clean. Here’s a controller that uses<a data-primary="" data-startref="ROspecial10" data-type="indexterm" id="id1405"/> that <code>Responsable</code> object:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">GroupController</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">index</code><code class="p">(</code><code class="nx">Group</code> <code class="nv">$group</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="k">new</code> <code class="nx">GroupDonationsDashboard</code><code class="p">(</code><code class="nv">$group</code><code class="p">);</code>&#13;
    <code class="p">}</code></pre>&#13;
</div></section>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Laravel and Middleware" data-type="sect1"><div class="sect1" id="id691">&#13;
<h1>Laravel and Middleware</h1>&#13;
&#13;
<p>Take a look back at <a data-type="xref" href="#FIG1001">Figure 10-1</a>, at the start of this chapter.</p>&#13;
&#13;
<p>We’ve covered the requests and responses, but we haven’t actually looked into what middleware are. You may already be familiar with middleware, which aren’t unique to Laravel, but rather a widely used architecture pattern.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="An Introduction to Middleware" data-type="sect2"><div class="sect2" id="id455">&#13;
<h2>An Introduction to Middleware</h2>&#13;
&#13;
<p>The idea of middleware<a data-primary="middleware" data-secondary="introduction to" data-type="indexterm" id="id1406"/> is that there is a series of layers wrapping around your application, like a multilayer cake or an onion.<sup><a data-type="noteref" href="ch10.html#id1407" id="id1407-marker">1</a></sup> Just as shown in <a data-type="xref" href="#FIG1001">Figure 10-1</a>, every request passes through every middleware layer on its way into the application, and then the resulting response passes back through the middleware layers on its way out to the end user.</p>&#13;
&#13;
<p>Middleware are most often considered separate from your application logic, and usually are constructed in a way that should theoretically be applicable to any application, not just the one you’re working on at the moment.</p>&#13;
&#13;
<p>A middleware can inspect a request and decorate it or reject it, based on what it finds. That means middleware are great for something like rate limiting: they can inspect the IP address, check how many times it’s accessed this resource in the last minute, and send back a 429 (Too Many Requests) status if a threshold is passed.</p>&#13;
&#13;
<p>Because middleware also get access to the response on its way out of the application, it’s great for decorating responses. For example, Laravel uses a middleware to add all of the queued cookies from a given request/response cycle to the response right before it is sent to the end user.</p>&#13;
&#13;
<p>But some of the most powerful uses of middleware come from the fact that they can be nearly the <em>first</em> and the <em>last</em> thing to interact with the request/response cycle. That makes middleware perfect for something like enabling sessions—​PHP needs you to open the session very early and close it very late, and middleware are also great for this.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Creating Custom Middleware" data-type="sect2"><div class="sect2" id="id456">&#13;
<h2>Creating Custom Middleware</h2>&#13;
&#13;
<p>Let’s<a data-primary="middleware" data-secondary="creating custom" data-type="indexterm" id="id1408"/> imagine we want to have a middleware that rejects every request that uses the <code>DELETE</code> HTTP method and also sends a cookie back for every request.</p>&#13;
&#13;
<p>There’s an Artisan command to create custom middleware. Let’s try it out:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>make:middleware<code class="w"> </code>BanDeleteMethod<code class="w"/></pre>&#13;
&#13;
<p>You can now open up the file at <em>app/Http/Middleware/BanDeleteMethod.php</em>. The default contents are shown in <a data-type="xref" href="#EX1015">Example 10-17</a>.</p>&#13;
<div data-type="example" id="EX1015">&#13;
<h5><span class="label">Example 10-17. </span>Default middleware contents</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">BanDeleteMethod</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nv">$request</code><code class="p">,</code> <code class="nx">Closure</code> <code class="nv">$next</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$next</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>How this <code>handle()</code> method represents the processing of both the incoming request <em>and</em> the outgoing response is the most difficult thing to understand about middleware, so let’s walk through it.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Understanding middleware’s handle() method" data-type="sect3"><div class="sect3" id="id212">&#13;
<h3>Understanding middleware’s handle() method</h3>&#13;
&#13;
<p>First, remember<a data-primary="handle() method" data-type="indexterm" id="id1409"/> that middleware are layered, one on top of another, and then finally on top of the app. The first middleware that’s registered gets <em>first</em> access to a request when it comes in, then that request is passed to every other middleware in turn, then to the app. Then the resulting response is passed outward through the middleware, and finally the first middleware gets <em>last</em> access to the response when it goes out.</p>&#13;
&#13;
<p>Let’s imagine we’ve registered <code>BanDeleteMethod</code> as the first middleware to run. That means the <code>$request</code> coming into it is the raw request, unadulterated by any other middleware. Now what?</p>&#13;
&#13;
<p>Passing that request to <code>$next()</code> means handing it off to the rest of the middleware. The <code>$next()</code> closure just takes that <code>$request</code> and passes it to the <code>handle()</code> method of the next middleware in the stack. It then gets passed on down the line until there are no more middleware to hand it to, and it finally ends up at the application.</p>&#13;
&#13;
<p>Next, how does the response come out? This is where it might be hard to follow. The application returns a response, which is passed back up the chain of middleware—​because each middleware returns its response. So, within that same <code>handle()</code> method, the middleware can decorate a <code>$request</code> and pass it to the <code>$next()</code> closure, and can then choose to do something with the output it receives before finally returning that output to the end user. Let’s look at some pseudocode to make this clearer (<a data-type="xref" href="#EX1016">Example 10-18</a>).</p>&#13;
<div data-type="example" id="EX1016">&#13;
<h5><span class="label">Example 10-18. </span>Pseudocode explaining the middleware call process</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">BanDeleteMethod</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nv">$request</code><code class="p">,</code> <code class="nx">Closure</code> <code class="nv">$next</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// At this point, $request is the raw request from the user.</code>&#13;
        <code class="c1">// Let's do something with it, just for fun.</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">ip</code><code class="p">()</code> <code class="o">===</code> <code class="s1">'192.168.1.1'</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nx">response</code><code class="p">(</code><code class="s1">'BANNED IP ADDRESS!'</code><code class="p">,</code> <code class="mi">403</code><code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="c1">// Now we've decided to accept it. Let's pass it on to the next</code>&#13;
        <code class="c1">// middleware in the stack. We pass it to $next(), and what is</code>&#13;
        <code class="c1">// returned is the response after the $request has been passed</code>&#13;
        <code class="c1">// down the stack of middleware to the application and the</code>&#13;
        <code class="c1">// application's response has been passed back up the stack.</code>&#13;
        <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$next</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// At this point, we can once again interact with the response</code>&#13;
        <code class="c1">// just before it is returned to the user</code>&#13;
        <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="s1">'visited-our-site'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Finally, we can release this response to the end user</code>&#13;
        <code class="k">return</code> <code class="nv">$response</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Finally, let’s make the middleware do what we actually promised (<a data-type="xref" href="#EX1017">Example 10-19</a>).</p>&#13;
<div data-type="example" id="EX1017">&#13;
<h5><span class="label">Example 10-19. </span>Sample middleware banning the <code>DELETE</code> method</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="o">...</code>&#13;
<code class="k">class</code> <code class="nc">BanDeleteMethod</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nv">$request</code><code class="p">,</code> <code class="nx">Closure</code> <code class="nv">$next</code><code class="p">)</code>&#13;
    <code class="p">{</code>&#13;
        <code class="c1">// Test for the DELETE method</code>&#13;
        <code class="k">if</code> <code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">method</code><code class="p">()</code> <code class="o">===</code> <code class="s1">'DELETE'</code><code class="p">)</code> <code class="p">{</code>&#13;
            <code class="k">return</code> <code class="nx">response</code><code class="p">(</code>&#13;
                <code class="s2">"Get out of here with that delete method"</code><code class="p">,</code>&#13;
                <code class="mi">405</code>&#13;
            <code class="p">);</code>&#13;
        <code class="p">}</code>&#13;
&#13;
        <code class="nv">$response</code> <code class="o">=</code> <code class="nv">$next</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Assign cookie</code>&#13;
        <code class="nv">$response</code><code class="o">-&gt;</code><code class="na">cookie</code><code class="p">(</code><code class="s1">'visited-our-site'</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>&#13;
&#13;
        <code class="c1">// Return response</code>&#13;
        <code class="k">return</code> <code class="nv">$response</code><code class="p">;</code>&#13;
    <code class="p">}</code>&#13;
<code class="p">}</code></pre></div>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Binding Middleware" data-type="sect2"><div class="sect2" id="id457">&#13;
<h2>Binding Middleware</h2>&#13;
&#13;
<p>We’re<a data-primary="middleware" data-secondary="binding" data-type="indexterm" id="Mbind10"/> not quite done yet. We need to register this middleware in one of two ways: globally or for specific routes.</p>&#13;
&#13;
<p>Global middleware are applied to every route; route middleware are applied on a route-by-route basis.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Binding global middleware" data-type="sect3"><div class="sect3" id="id692">&#13;
<h3>Binding global middleware</h3>&#13;
&#13;
<p>Both bindings happen in <em>app/Http/Kernel.php</em>. To add a middleware as global, add its class name to the <code>$middleware</code> property, as in <a data-type="xref" href="#EX1018">Example 10-20</a>.</p>&#13;
<div data-type="example" id="EX1018">&#13;
<h5><span class="label">Example 10-20. </span>Binding global middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/Http/Kernel.php</code>&#13;
<code class="k">protected</code> <code class="nv">$middleware</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="nx">\App\Http\Middleware\TrustProxies</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="nx">\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="nx">\App\Http\Middleware\BanDeleteMethod</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="p">];</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Binding route middleware" data-type="sect3"><div class="sect3" id="id693">&#13;
<h3>Binding route middleware</h3>&#13;
&#13;
<p>Middleware intended for specific routes can be added as route middleware or as part of a middleware group. Let’s start with the former.</p>&#13;
&#13;
<p>Route middleware are added to the <code>$middlewareAliases</code> array in <em>app/Http/Kernel.php</em>. It’s similar to adding them to <code>$middleware</code>, except we have to give each one a key that will be used when applying this middleware to a particular route, as seen in <a data-type="xref" href="#EX1019">Example 10-21</a>.</p>&#13;
<div data-type="example" id="EX1019">&#13;
<h5><span class="label">Example 10-21. </span>Binding route middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// app/Http/Kernel.php</code>&#13;
<code class="k">protected</code> <code class="nv">$middlewareAliases</code> <code class="o">=</code> <code class="p">[</code>&#13;
    <code class="s1">'auth'</code> <code class="o">=&gt;</code> <code class="nx">\App\Http\Middleware\Authenticate</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
    <code class="o">...</code>&#13;
    <code class="s1">'ban-delete'</code> <code class="o">=&gt;</code> <code class="nx">\App\Http\Middleware\BanDeleteMethod</code><code class="o">::</code><code class="na">class</code><code class="p">,</code>&#13;
<code class="p">];</code></pre></div>&#13;
&#13;
<p>We can now use this middleware in our route definitions, like in <a data-type="xref" href="#EX1020">Example 10-22</a>.</p>&#13;
<div data-type="example" id="EX1020">&#13;
<h5><span class="label">Example 10-22. </span>Applying route middleware in route definitions</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// Doesn't make much sense for our current example...</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'contacts'</code><code class="p">,</code> <code class="p">[</code><code class="nx">ContactController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'index'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'ban-delete'</code><code class="p">);</code>&#13;
&#13;
<code class="c1">// Makes more sense for our current example...</code>&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">prefix</code><code class="p">(</code><code class="s1">'api'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'ban-delete'</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="c1">// All routes related to an API</code>&#13;
<code class="p">});</code></pre></div>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Using middleware groups" data-type="sect3"><div class="sect3" id="id694">&#13;
<h3>Using middleware groups</h3>&#13;
&#13;
<p>Middleware groups are essentially prepackaged bundles of middleware that make sense to be together in specific contexts.</p>&#13;
<div data-type="note" epub:type="note"><h1>Middleware Groups in Routes Files</h1>&#13;
<p>Every route in <em>routes/web.php</em> is in the <code>web</code> middleware group. This <em>routes/web.php</em> file is specific for web routes and the <em>routes/api.php</em> file for API routes. If you want to add routes in other groups, read on.</p>&#13;
</div>&#13;
&#13;
<p>Out of the box, there are two groups: <code>web</code> and <code>api</code>. The <code>web</code> group has all the middleware that will be useful on almost every Laravel page request, including middleware for cookies, sessions, and CSRF protection. <code>api</code> has none of those—​it has a throttling middleware and a route model binding middleware, and that’s it. These are all defined in <em>app/Http/Kernel.php</em>.</p>&#13;
&#13;
<p>You can apply middleware groups to routes just like you apply route middleware to routes, with the <code>middleware()</code> fluent method:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">use</code> <code class="nx">App\Http\Controllers\HomeController</code><code class="p">;</code>&#13;
&#13;
<code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">[</code><code class="nx">HomeController</code><code class="o">::</code><code class="na">class</code><code class="p">,</code> <code class="s1">'index'</code><code class="p">]);</code></pre>&#13;
&#13;
<p class="pagebreak-before">You can also create your own middleware groups and add and remove route middleware to and from preexisting middleware groups. It works just like adding route middleware normally, but you’re instead adding them to keyed groups in the <code>$middlewareGroups</code> array.</p>&#13;
&#13;
<p>You might be wondering how these middleware groups match up with the two default route files. Unsurprisingly, the <em>routes/web.php</em> file is wrapped with the <code>web</code> middleware group, and the <em>routes/api.php</em> file is wrapped with the <code>api</code> middleware group.</p>&#13;
&#13;
<p>The <em>routes/*</em> files are loaded in the <code>RouteServiceProvider</code>. Take a look at the <span class="keep-together"><code>map()</code> method</span> there (<a data-type="xref" href="#EX1021">Example 10-23</a>) and you’ll find a <code>mapWebRoutes()</code> method and a <code>mapApiRoutes()</code> method, each of which loads its respective files already wrapped in the appropriate middleware group.</p>&#13;
<div data-type="example" id="EX1021">&#13;
<h5><span class="label">Example 10-23. </span>Default route service provider</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="c1">// App\Providers\RouteServiceProvider</code>&#13;
<code class="k">public</code> <code class="k">const</code> <code class="no">HOME</code> <code class="o">=</code> <code class="s1">'/home'</code><code class="p">;</code>&#13;
&#13;
<code class="c1">// protected $namespace = 'App\\Http\\Controllers';</code>&#13;
&#13;
<code class="k">public</code> <code class="k">function</code> <code class="nf">boot</code><code class="p">()</code><code class="o">:</code> <code class="nx">void</code>&#13;
<code class="p">{</code>&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">configureRateLimiting</code><code class="p">();</code>&#13;
&#13;
    <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">routes</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="nx">Route</code><code class="o">::</code><code class="na">prefix</code><code class="p">(</code><code class="s1">'api'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'api'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">namespace</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">namespace</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="nx">base_path</code><code class="p">(</code><code class="s1">'routes/api.php'</code><code class="p">));</code>&#13;
&#13;
        <code class="nx">Route</code><code class="o">::</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'web'</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">namespace</code><code class="p">(</code><code class="nv">$this</code><code class="o">-&gt;</code><code class="na">namespace</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="nx">base_path</code><code class="p">(</code><code class="s1">'routes/web.php'</code><code class="p">));</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code>&#13;
&#13;
<code class="k">protected</code> <code class="k">function</code> <code class="nf">configureRateLimiting</code><code class="p">()</code>&#13;
<code class="p">{</code>&#13;
    <code class="nx">RateLimiter</code><code class="o">::</code><code class="na">for</code><code class="p">(</code><code class="s1">'api'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nx">Limit</code><code class="o">::</code><code class="na">perMinute</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code>&#13;
            <code class="o">-&gt;</code><code class="na">by</code><code class="p">(</code><code class="nx">optional</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">())</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">?:</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">ip</code><code class="p">());</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#EX1021">Example 10-23</a>, we’re using the router to load a route group with the <code>web</code> middleware group, and another under the <code>api</code> middleware group.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Passing Parameters to Middleware" data-type="sect2"><div class="sect2" id="id213">&#13;
<h2>Passing Parameters to Middleware</h2>&#13;
&#13;
<p>It’s<a data-primary="parameters" data-secondary="passing to middleware" data-type="indexterm" id="id1410"/> not common, but there are times when you need to pass parameters to a route middleware. For example, you might have an authentication middleware that will act differently depending on whether you’re guarding for the <code>member</code> user type or the <code>owner</code> user type:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'company'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'company.admin'</code><code class="p">);</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth:owner'</code><code class="p">);</code></pre>&#13;
&#13;
<p>To make this work, you’ll need to add one or more parameters to the middleware’s <code>handle()</code> method and update that method’s logic accordingly, as shown in <a data-type="xref" href="#EX10a">Example 10-24</a>.</p>&#13;
<div data-type="example" id="EX10a">&#13;
<h5><span class="label">Example 10-24. </span>Defining a route middleware that accepts parameters</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="k">public</code> <code class="k">function</code> <code class="nf">handle</code><code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">,</code> <code class="nx">Closure</code> <code class="nv">$next</code><code class="p">,</code> <code class="nv">$role</code><code class="p">)</code><code class="o">:</code> <code class="nx">Response</code>&#13;
<code class="p">{</code>&#13;
    <code class="k">if</code> <code class="p">(</code><code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">check</code><code class="p">()</code> <code class="o">&amp;&amp;</code> <code class="nx">auth</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">-&gt;</code><code class="na">hasRole</code><code class="p">(</code><code class="nv">$role</code><code class="p">))</code> <code class="p">{</code>&#13;
        <code class="k">return</code> <code class="nv">$next</code><code class="p">(</code><code class="nv">$request</code><code class="p">);</code>&#13;
    <code class="p">}</code>&#13;
&#13;
    <code class="k">return</code> <code class="nx">redirect</code><code class="p">(</code><code class="s1">'login'</code><code class="p">);</code>&#13;
<code class="p">}</code></pre></div>&#13;
&#13;
<p>Note that you can also add more than one parameter to the <code>handle()</code> method and pass multiple parameters to the route definition by separating them with commas:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'company'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">view</code><code class="p">(</code><code class="s1">'company.admin'</code><code class="p">);</code>&#13;
<code class="p">})</code><code class="o">-&gt;</code><code class="na">middleware</code><code class="p">(</code><code class="s1">'auth:owner,view'</code><code class="p">);</code></pre>&#13;
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="id1411">&#13;
<h1>Form Request Objects</h1>&#13;
<p>In this chapter we covered how to inject an Illuminate <code>Request</code> object, which is the base—​and most common—​request object.</p>&#13;
&#13;
<p>However, you can also extend the <code>Request</code> object and inject that instead. You’ll learn more about how to bind and inject custom classes in <a data-type="xref" href="ch11.html#the_container">Chapter 11</a>, but there’s one special type, called the form request, that has its own set of behaviors.</p>&#13;
&#13;
<p>See <a data-type="xref" href="ch07.html#form_requests">“Form Requests”</a> to learn more about creating and using<a data-primary="" data-startref="Mbind10" data-type="indexterm" id="id1412"/> form requests.</p>&#13;
</div></aside>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Default Middleware" data-type="sect1"><div class="sect1" id="id695">&#13;
<h1>Default Middleware</h1>&#13;
&#13;
<p>Laravel comes with quite a few middleware out of the box. Let’s take a look at each.</p>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Maintenance Mode" data-type="sect2"><div class="sect2" id="id214">&#13;
<h2>Maintenance Mode</h2>&#13;
&#13;
<p>Often<a data-primary="middleware" data-secondary="default middleware" data-tertiary="Maintenance Mode feature" data-type="indexterm" id="id1413"/><a data-primary="Maintenance Mode feature" data-type="indexterm" id="id1414"/> we need to take our applications offline temporarily to perform some form of maintenance. Laravel offers tooling for this feature, called “Maintenance Mode,” and there’s a middleware that checks every response to see if the app is in that mode.</p>&#13;
&#13;
<p>You<a data-primary="--refresh flag" data-type="indexterm" id="id1415"/><a data-primary="--retry flag" data-type="indexterm" id="id1416"/><a data-primary="--secret flag" data-type="indexterm" id="id1417"/> can enable maintenance mode for your app with the <code>down</code> Artisan command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>down<code class="w"> </code>--refresh<code class="o">=</code><code class="m">5</code><code class="w"> </code>--retry<code class="o">=</code><code class="m">30</code><code class="w"> </code>--secret<code class="o">=</code><code class="s2">"long-password"</code><code class="w"/></pre>&#13;
<dl>&#13;
<dt><code>refresh</code></dt>&#13;
<dd>&#13;
<p>Sends a header with the response to refresh the browser after the specified number of seconds.</p>&#13;
</dd>&#13;
<dt><code>retry</code></dt>&#13;
<dd>&#13;
<p>Sets the Retry-After header, with the specified number of seconds. Browsers usually ignore this header.</p>&#13;
</dd>&#13;
<dt><code>secret</code></dt>&#13;
<dd>&#13;
<p>Sets a password to allow some users to bypass the maintenance mode. To bypass the maintenance mode navigate to your app URL followed by the secret you set (e.g., <em>app.url/long-password</em>). This will redirect you to the <em>/</em> app URL, while setting a bypass cookie on your browser, allowing you to access the application normally even while it’s in maintenance mode.</p>&#13;
</dd>&#13;
</dl>&#13;
&#13;
<p>To disable maintenance mode, use the <code>up</code> Artisan command:</p>&#13;
&#13;
<pre data-code-language="bash" data-type="programlisting">php<code class="w"> </code>artisan<code class="w"> </code>up<code class="w"/></pre>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Rate Limiting" data-type="sect2"><div class="sect2" id="route_rate_limiting">&#13;
<h2>Rate Limiting</h2>&#13;
&#13;
<p>If<a data-primary="middleware" data-secondary="default middleware" data-tertiary="rate limiting" data-type="indexterm" id="id1418"/><a data-primary="rate limiting" data-type="indexterm" id="id1419"/> you need to limit users such that they can access any given route(s) only a certain number of times in a given time frame (called <em>rate limiting</em>, and most common with APIs), there’s an out-of-the-box middleware for that: <code>throttle</code>. <a data-type="xref" href="#EX41.5">Example 10-25</a> demonstrates its use, using the “api” <code>RateLimiter</code> preset Laravel ships with.</p>&#13;
<div data-type="example" id="EX41.5">&#13;
<h5><span class="label">Example 10-25. </span>Applying the rate limiting middleware to a route</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">Route</code><code class="o">::</code><code class="na">middleware</code><code class="p">([</code><code class="s1">'auth:api'</code><code class="p">,</code> <code class="s1">'throttle:api'</code><code class="p">])</code><code class="o">-&gt;</code><code class="na">group</code><code class="p">(</code><code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
    <code class="nx">Route</code><code class="o">::</code><code class="na">get</code><code class="p">(</code><code class="s1">'/profile'</code><code class="p">,</code> <code class="k">function</code> <code class="p">()</code> <code class="p">{</code>&#13;
        <code class="c1">//</code>&#13;
    <code class="p">});</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You can define as many custom <code>RateLimiter</code> configurations as you need; look at the <code>configureRateLimiting()</code> method of the <code>RouteServiceProvider</code> for the default <code>api</code> configuration, and also to create your own.</p>&#13;
&#13;
<p>As you can see in <a data-type="xref" href="#EX1025">Example 10-26</a>, the default <code>api</code> configuration limits requests to 60 per minute, segmented by either the authenticated ID or, if the user is not logged in, the IP address.</p>&#13;
<div data-type="example" id="EX1025">&#13;
<h5><span class="label">Example 10-26. </span>Default rate limiter definition</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nx">RateLimiter</code><code class="o">::</code><code class="na">for</code><code class="p">(</code><code class="s1">'api'</code><code class="p">,</code> <code class="k">function</code> <code class="p">(</code><code class="nx">Request</code> <code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>&#13;
    <code class="k">return</code> <code class="nx">Limit</code><code class="o">::</code><code class="na">perMinute</code><code class="p">(</code><code class="mi">60</code><code class="p">)</code><code class="o">-&gt;</code><code class="na">by</code><code class="p">(</code><code class="nv">$request</code><code class="o">-&gt;</code><code class="na">user</code><code class="p">()</code><code class="o">?-&gt;</code><code class="na">id</code> <code class="o">?:</code> <code class="nv">$request</code><code class="o">-&gt;</code><code class="na">ip</code><code class="p">());</code>&#13;
<code class="p">});</code></pre></div>&#13;
&#13;
<p>You can also customize the response that’s sent if the rate limit is hit, specify different rate limits based on user or application or request conditions, or even specify a stack of rate limiters that are applied in sequence. Take a look at <a href="https://oreil.ly/dEy4V">the rate limiting docs</a> to learn more.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Trusted Proxies" data-type="sect2"><div class="sect2" id="id216">&#13;
<h2>Trusted Proxies</h2>&#13;
&#13;
<p>If<a data-primary="middleware" data-secondary="default middleware" data-tertiary="TrustedProxy package" data-type="indexterm" id="id1420"/><a data-primary="TrustedProxy package" data-type="indexterm" id="id1421"/> you use any Laravel tools to generate URLs within the app, you’ll notice that Laravel detects whether the current request was via HTTP or HTTPS and generates links using the appropriate protocol.</p>&#13;
&#13;
<p>However, this doesn’t always work when you have a proxy (e.g., a load balancer or other web-based proxy) in front of your app. Many proxies send nonstandard headers like <code>X_FORWARDED_PORT</code> and <code>X_FORWARDED_PROTO</code> to your app, and expect your app to “trust” those, interpret them, and use them as a part of the process of interpreting the HTTP request. To make Laravel correctly treat proxied HTTPS calls like secure calls, and in order for Laravel to process other headers from proxied requests, you need to define how it should do so.</p>&#13;
&#13;
<p>You likely don’t want to allow just <em>any</em> proxy to send traffic to your app; rather, you want to lock your app to only trust certain proxies, and even from those proxies you may only want to trust certain forwarded headers.</p>&#13;
&#13;
<p>Laravel includes the <a href="https://oreil.ly/wYcDc">TrustedProxy package</a>, which makes it possible for you to mark certain sources of traffic as “trusted,” and also mark which forwarded headers you want to trust from those sources and how to map them to normal headers.</p>&#13;
&#13;
<p>To configure which proxies your app will trust, you can edit the <code>App\Http</code><span class="keep-together"><code>\Middleware</code></span><code>\TrustProxies</code> middleware and add the IP address for your load balancer or proxy to the <code>$proxies</code> array, as shown in <a data-type="xref" href="#EX10b">Example 10-27</a>.</p>&#13;
<div data-type="example" id="EX10b">&#13;
<h5><span class="label">Example 10-27. </span>Configuring the <code>TrustProxies</code> middleware</h5>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting">    <code class="sd">/**</code>&#13;
<code class="sd">     * The trusted proxies for this application.</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @var array&lt;int, string&gt;|string|null</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">protected</code> <code class="nv">$proxies</code><code class="p">;</code>&#13;
&#13;
    <code class="sd">/**</code>&#13;
<code class="sd">     * The headers that should be used to detect proxies</code>&#13;
<code class="sd">     *</code>&#13;
<code class="sd">     * @var int</code>&#13;
<code class="sd">     */</code>&#13;
    <code class="k">protected</code> <code class="nv">$headers</code> <code class="o">=</code>&#13;
        <code class="nx">Request</code><code class="o">::</code><code class="na">HEADER_X_FORWARDED_FOR</code> <code class="o">|</code>&#13;
        <code class="nx">Request</code><code class="o">::</code><code class="na">HEADER_X_FORWARDED_HOST</code> <code class="o">|</code>&#13;
        <code class="nx">Request</code><code class="o">::</code><code class="na">HEADER_X_FORWARDED_PORT</code> <code class="o">|</code>&#13;
        <code class="nx">Request</code><code class="o">::</code><code class="na">HEADER_X_FORWARDED_PROTO</code> <code class="o">|</code>&#13;
        <code class="nx">Request</code><code class="o">::</code><code class="na">HEADER_X_FORWARDED_AWS_ELB</code><code class="p">;</code></pre></div>&#13;
&#13;
<p>As you can see, the <code>$headers</code> array defaults to trusting all forwarded headers from the trusted proxies; if you want to customize this list, take a look at the <a href="https://oreil.ly/ur3bg">Symfony docs on trusting proxies</a>.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="CORS" data-type="sect2"><div class="sect2" id="id217">&#13;
<h2>CORS</h2>&#13;
&#13;
<p>Hopefully<a data-primary="middleware" data-secondary="default middleware" data-tertiary="CORS (cross-origin resource sharing)" data-type="indexterm" id="id1422"/><a data-primary="CORS (cross-origin resource sharing)" data-type="indexterm" id="id1423"/> you’ve never had a run in with CORS (cross-origin resource sharing). It’s one of those things that we hope always <em>just works</em>, and when it doesn’t, it’s painful.</p>&#13;
&#13;
<p>Laravel’s built-in CORS middleware runs by default and can be configured in <em>config/cors.php</em>. Its default configuration is reasonable for most apps, but in its config file you can exclude routes from CORS protection, modify the HTTP methods it operates on, and configure how it interacts with CORS headers.</p>&#13;
</div></section>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="Testing" data-type="sect1"><div class="sect1" id="id458">&#13;
<h1>Testing</h1>&#13;
&#13;
<p>Outside of the context of you as a developer using requests, responses, and middleware in your own testing, Laravel itself actually uses each quite a bit.</p>&#13;
&#13;
<p>When<a data-primary="Request objects" data-secondary="testing" data-type="indexterm" id="id1424"/><a data-primary="testing" data-secondary="Request objects" data-type="indexterm" id="id1425"/> you’re doing application testing with calls like <code>$this-&gt;get('/')</code>, you’re instructing Laravel’s application testing framework to generate request objects that represent the interactions you’re describing. Then those request objects are passed to your application, as if they were actual visits. That’s why the application tests are so accurate: your application doesn’t actually “know” that it’s not a real user that’s interacting with it.</p>&#13;
&#13;
<p>In this context, many of the assertions you’re making—​say, <code>assertResponseOk()</code>—are assertions against the response object generated by the application testing framework. The <code>assertResponseOk()</code> method just looks at the response object and asserts that its <code>isOk()</code> method returns <code>true</code>—which is just checking that its status code <span class="keep-together">is 200.</span> In the end, <em>everything</em> in application testing is acting as if this were a real page request.</p>&#13;
&#13;
<p>Find yourself in a context where you need a request to work with in your tests? You can always pull one from the container with <code>$request = request()</code>. Or you could create your own—the constructor parameters for the <code>Request</code> class, all optional, are as follows:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$request</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Illuminate\Http\Request</code><code class="p">(</code>&#13;
    <code class="nv">$query</code><code class="p">,</code>      <code class="c1">// GET array</code>&#13;
    <code class="nv">$request</code><code class="p">,</code>    <code class="c1">// POST array</code>&#13;
    <code class="nv">$attributes</code><code class="p">,</code> <code class="c1">// "attributes" array; empty is fine</code>&#13;
    <code class="nv">$cookies</code><code class="p">,</code>    <code class="c1">// Cookies array</code>&#13;
    <code class="nv">$files</code><code class="p">,</code>      <code class="c1">// Files array</code>&#13;
    <code class="nv">$server</code><code class="p">,</code>     <code class="c1">// Servers array</code>&#13;
    <code class="nv">$content</code>     <code class="c1">// Raw body data</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>If you’re really interested in an example, check out the method Symfony uses to create a new <code>Request</code> from the globals PHP provides: <code>Symfony\Component\HttpFoundation\Request@createFromGlobals()</code>.</p>&#13;
&#13;
<p><code>Response</code> objects<a data-primary="Response objects" data-secondary="testing" data-type="indexterm" id="id1426"/><a data-primary="testing" data-secondary="Response objects" data-type="indexterm" id="id1427"/> are even simpler to create manually, if you need to. Here are the (optional) parameters:</p>&#13;
&#13;
<pre data-code-language="php" data-type="programlisting"><code class="nv">$response</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Illuminate\Http\Response</code><code class="p">(</code>&#13;
    <code class="nv">$content</code><code class="p">,</code> <code class="c1">// response content</code>&#13;
    <code class="nv">$status</code><code class="p">,</code>  <code class="c1">// HTTP status, default 200</code>&#13;
    <code class="nv">$headers</code>  <code class="c1">// array headers array</code>&#13;
<code class="p">);</code></pre>&#13;
&#13;
<p>Finally, if<a data-primary="testing" data-secondary="middleware" data-type="indexterm" id="id1428"/><a data-primary="middleware" data-secondary="testing" data-type="indexterm" id="id1429"/> you need to disable your middleware during an application test, import the <code>WithoutMiddleware</code> trait into that test. You can also use the <code>$this</code><span class="keep-together"><code>-&gt;</code></span><code>withoutMiddleware()</code> method to disable middleware just for a single test method.</p>&#13;
</div></section>&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
&#13;
<section data-pdf-bookmark="TL;DR" data-type="sect1"><div class="sect1" id="id218">&#13;
<h1>TL;DR</h1>&#13;
&#13;
<p>Every<a data-primary="Request objects" data-secondary="overview of" data-type="indexterm" id="id1430"/> request coming into a Laravel application is converted into an Illuminate <code>Request</code> object, which then passes through all the middleware and is processed by the application. The application generates a <code>Response</code> object, which is then passed back through all of the middleware (in reverse order) and returned to the end user.</p>&#13;
&#13;
<p><code>Request</code> and <code>Response</code> objects<a data-primary="Response objects" data-secondary="overview of" data-type="indexterm" id="id1431"/> are responsible for encapsulating and representing every relevant piece of information about the incoming user request and the outgoing server response.</p>&#13;
&#13;
<p>Service providers<a data-primary="service providers" data-type="indexterm" id="id1432"/> gather together related behavior for binding and registering classes for use by the application.</p>&#13;
&#13;
<p>Middleware wrap<a data-primary="middleware" data-secondary="overview of" data-type="indexterm" id="id1433"/> the application and can reject or decorate any request and response.</p>&#13;
</div></section>&#13;
<div data-type="footnotes"><p data-type="footnote" id="id1407"><sup><a href="ch10.html#id1407-marker">1</a></sup> Or an <a href="https://oreil.ly/HQ1zL">ogre</a>.</p></div></div></section></body></html>