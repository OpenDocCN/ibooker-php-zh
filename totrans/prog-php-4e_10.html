<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 9. Databases"><div class="chapter" id="databases-id00007">
<h1><span class="label">Chapter 9. </span>Databases</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" id="ix_databases_ch9"/>PHP has support for over 20 databases, including the most popular commercial and open source varieties. Relational database systems such as MariaDB, MySQL, PostgreSQL, and Oracle are the backbone of most modern dynamic websites. In these are stored shopping-cart information, purchase histories, product reviews, user information, credit card numbers, and sometimes even web pages themselves.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="supported by PHP" id="idm45922765556520"/>This chapter covers how to access databases from PHP. We focus on the built-in <a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="PDO library for" id="idm45922765555016"/><a contenteditable="false" data-type="indexterm" data-primary="PDO (PHP Data Objects) library" id="idm45922765553640"/><em>PHP Data Objects</em> (PDO) library, which lets you use the same functions to access any database, rather than on the myriad database-specific extensions. In this chapter, you’ll learn how to fetch data from the database, store data in the database, and handle errors. We finish with a sample application that shows how to put various database techniques into action.</p>
<p>This book cannot go into all the details of creating web database applications with PHP. <a contenteditable="false" data-type="indexterm" data-primary="Web Database Applications with PHP and MySQL 2nd Edition (O'Reilly)" id="idm45922765551256"/><a contenteditable="false" data-type="indexterm" data-primary="Williams, Hugh (author)" data-secondary="Web Database Applications with PHP and MySQL, 2nd Edition (O'Reilly)" id="idm45922765550184"/><a contenteditable="false" data-type="indexterm" data-primary="Lane, David (author)" data-secondary="Web Database Applications with PHP and MySQL, 2nd Edition (O'Reilly)" id="idm45922765548840"/>For a more in-depth look at the PHP/MySQL combination, see <a class="orm:hideurl" href="http://oreil.ly/web_db_apps_PHP_MySQL"><em>Web Database Applications with PHP and MySQL</em>, Second Edition</a> (O’Reilly), by Hugh Williams and David Lane.</p>
<section data-type="sect1" data-pdf-bookmark="Using PHP to Access a Database"><div class="sect1" id="using_php_to_access_a_database">
<h1>Using PHP to Access a Database</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="accessing" id="idm45922765544408"/>There are two ways to access databases from PHP. One is to use a database-specific extension; the other is to use the database-independent PDO library. There are advantages and disadvantages to each approach.</p>
<p>If you use a database-specific extension, your code is intimately tied to the database you’re using. For example, the MySQL extension’s function names, parameters, error handling, and so on are completely different from those of the other database extensions. If you want to move your database from MySQL to PostgreSQL, it will involve significant changes to your code. PDO, on the other hand, hides the database-specific functions from you with an abstraction layer, so moving between database systems can be as simple as changing one line of your program or your <em>php.ini</em> file.</p>
<p>The portability of an abstraction layer like the PDO library comes at a price, however, as code that uses it is also typically a little slower than code that uses a native database-specific extension.</p>
<p>Keep in mind that an abstraction layer does absolutely nothing when it comes to making sure your actual SQL queries are portable. If your application uses any sort of nongeneric SQL, you’ll have to do significant work to convert your queries from one database to another. We will be looking briefly at both approaches to database interfaces in this chapter and then look at alternative methods to managing dynamic content for the web.</p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Relational Databases and SQL"><div class="sect1" id="relational_databases_and_sql">
<h1>Relational Databases and SQL</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="RDBMS (Relational Database Management System)" id="ix_RDBMS_overview"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="RDBMS" id="ix_databases_RDBMS"/>A Relational Database Management System (RDBMS) is a server that manages data for you. The data is structured into tables, where each table has a number of columns, each of which has a name and a type. For example, to keep track of science fiction books, we might have a “books” table that records the title (a string), the year of release (a number), and the author.</p>
<p>Tables are grouped together into databases, so a science fiction book database might have tables for time periods, authors, and villains. An RDBMS usually has its own user system, which controls access rights for databases (e.g., “user Fred can update database authors”).</p>
<p>PHP communicates with relational databases such as MariaDB and Oracle using the Structured Query Language (SQL). You can use SQL to create, modify, and query relational databases.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="SQL (Structured Query Language)" data-secondary="commands" id="ix_sql_commands_ch9"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="SQL commands for" id="ix_databases_sql_commands"/>The syntax for SQL is divided into two parts. <a contenteditable="false" data-type="indexterm" data-primary="DML (Data Manipulation Language)" id="idm45922765498488"/>The first, Data Manipulation Language (DML), is used to retrieve and modify data in an existing database. DML is remarkably compact, consisting of only four actions or verbs: <a contenteditable="false" data-type="indexterm" data-primary="SELECT command, SQL" id="idm45922765497048"/><code>SELECT</code>, <a contenteditable="false" data-type="indexterm" data-primary="INSERT command, SQL" id="idm45922765495528"/><code>INSERT</code>, <a contenteditable="false" data-type="indexterm" data-primary="UPDATE command, SQL" id="idm45922765493976"/><code>UPDATE</code>, and <a contenteditable="false" data-type="indexterm" data-primary="DELETE command, SQL" id="idm45922765492424"/><code>DELETE</code>. <a contenteditable="false" data-type="indexterm" data-primary="DDL (Data Definition Language)" id="idm45922765490872"/>The set of SQL commands used to create and modify the database structures that hold the data is known as Data Definition Language, or DDL. The syntax for DDL is not as standardized as that for DML, but as PHP just sends any SQL commands you give it to the database, you can use any SQL commands your database supports.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The SQL command file for creating this sample library database is available in a file called <em>library.sql</em>.</p>
</div>
<p>Assuming you have a table called <code>books</code>, this SQL statement would insert a new row:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">books</code> <code class="k">VALUES</code> <code class="p">(</code><code class="k">null</code><code class="p">,</code> <code class="mi">4</code><code class="p">,</code> <code class="s1">'I, Robot'</code><code class="p">,</code> <code class="s1">'0-553-29438-5'</code><code class="p">,</code> <code class="mi">1950</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code></pre>
<p>This SQL statement inserts a new row but specifies the columns for which there are values:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">INSERT</code> <code class="k">INTO</code> <code class="n">books</code> <code class="p">(</code><code class="n">authorid</code><code class="p">,</code> <code class="n">title</code><code class="p">,</code> <code class="n">ISBN</code><code class="p">,</code> <code class="n">pub_year</code><code class="p">,</code> <code class="n">available</code><code class="p">)</code>
 <code class="k">VALUES</code> <code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="s1">'I, Robot'</code><code class="p">,</code> <code class="s1">'0-553-29438-5'</code><code class="p">,</code> <code class="mi">1950</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code></pre>
<p>To delete all books that were published in 1979 (if any), we could use this SQL <span class="keep-together">statement:</span></p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">DELETE</code> <code class="k">FROM</code> <code class="n">books</code> <code class="k">WHERE</code> <code class="n">pub_year</code> <code class="o">=</code> <code class="mi">1979</code><code class="p">;</code></pre>
<p>To change the year for <em>Roots</em> to 1983, use this SQL statement:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">UPDATE</code> <code class="n">books</code> <code class="k">SET</code> <code class="n">pub_year</code><code class="o">=</code><code class="mi">1983</code> <code class="k">WHERE</code> <code class="n">title</code><code class="o">=</code><code class="s1">'Roots'</code><code class="p">;</code></pre>
<p>To fetch only the books published in the 1980s, use:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">books</code> <code class="k">WHERE</code> <code class="n">pub_year</code> <code class="o">&gt;</code> <code class="mi">1979</code> <code class="k">AND</code> <code class="n">pub_year</code> <code class="o">&lt;</code> <code class="mi">1990</code><code class="p">;</code></pre>
<p>You can also specify the fields you want returned. For example:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">title</code><code class="p">,</code> <code class="n">pub_year</code> <code class="k">FROM</code> <code class="n">books</code> <code class="k">WHERE</code> <code class="n">pub_year</code> <code class="o">&gt;</code> <code class="mi">1979</code> <code class="k">AND</code> <code class="n">pub_year</code> <code class="o">&lt;</code> <code class="mi">1990</code><code class="p">;</code></pre>
<p>You can issue queries that bring together information from multiple tables. For example, this query joins together the <code>book</code> and <code>author</code> tables to let us see who wrote each book:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">authors</code><code class="p">.</code><code class="n">name</code><code class="p">,</code> <code class="n">books</code><code class="p">.</code><code class="n">title</code> <code class="k">FROM</code> <code class="n">books</code><code class="p">,</code> <code class="n">authors</code>
 <code class="k">WHERE</code> <code class="n">authors</code><code class="p">.</code><code class="n">authorid</code> <code class="o">=</code> <code class="n">books</code><code class="p">.</code><code class="n">authorid</code><code class="p">;</code></pre>
<p>You can even short-form (or alias) the table names like this:</p>
<pre data-type="programlisting" data-code-language="sql"><code class="k">SELECT</code> <code class="n">a</code><code class="p">.</code><code class="n">name</code><code class="p">,</code> <code class="n">b</code><code class="p">.</code><code class="n">title</code> <code class="k">FROM</code> <code class="n">books</code> <code class="n">b</code><code class="p">,</code> <code class="n">authors</code> <code class="n">a</code> <code class="k">WHERE</code> <code class="n">a</code><code class="p">.</code><code class="n">authorid</code> <code class="o">=</code> <code class="n">b</code><code class="p">.</code><code class="n">authorid</code><code class="p">;</code></pre>
<p><a contenteditable="false" data-type="indexterm" data-primary="Kline, Keven (author)" data-secondary="SQL in a Nutshell (O'Reilly)" id="idm45922765102344"/><a contenteditable="false" data-type="indexterm" data-primary="SQL in a Nutshell (O'Reilly)" id="idm45922765068440"/>For more on SQL, see <a class="orm:hideurl" href="http://oreil.ly/SQL_Nutshell3"><em>SQL in a Nutshell</em></a>, Third Edition (O’Reilly), by Kevin Kline.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_sql_commands" id="idm45922765066152"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_sql_commands_ch9" id="idm45922765064792"/></p>
<section data-type="sect2" data-pdf-bookmark="PHP Data Objects"><div class="sect2" id="php_data_objects">
<h2>PHP Data Objects</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="PDO (PHP Data Objects) library" id="ix_pdo_library_ch9"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="PDO library for" id="ix_databases_pdo_library"/>The <a href="http://php.net">PHP website</a> has this to say about PDO:</p>
<blockquote>
<p>The PHP Data Objects (PDO) extension defines a lightweight, consistent interface for accessing databases in PHP. Each database driver that implements the PDO interface can expose database-specific features as regular extension functions. Note that you cannot perform any database functions using the PDO extension by itself; you must use a database-specific PDO driver to access a database server.</p>
</blockquote>
<p>Among its other unique features, PDO:</p>
<ul>
<li><p>Is a native C extension</p></li>
<li><p>Takes advantage of the latest PHP 7 internals</p></li>
<li><p>Uses buffered reading of data from the result set</p></li>
<li><p>Provides common database features as a base</p></li>
<li><p>Is still able to access database-specific functions</p></li>
<li><p>Can use transaction-based techniques</p></li>
<li><p>Can interact with LOBS (Large Objects) in the database</p></li>
<li><p>Can use prepared and executable SQL statements with bound parameters</p></li>
<li><p>Can implement scrollable cursors</p></li>
<li><p>Has access to <code>SQLSTATE</code> error codes and has very flexible error handling</p></li>
</ul>
<p>Since there are a number of features here, we will touch on only a few of them to illustrate just how beneficial PDO can be.</p>
<p>First, a little about PDO. It has drivers for almost all database engines in existence, and those drivers that PDO does not supply should be accessible through PDO’s generic ODBC connection. PDO is modular in that it has to have at least two extensions enabled to be active: the PDO extension itself and the PDO extension specific to the database to which you will be interfacing. <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="PDO library" id="idm45922765047528"/>See the <a href="http://ca.php.net/pdo">online documentation</a>) to set up the connections for the database of your choice. As an example, for establishing PDO on a Windows server for MySQL interaction, simply enter the following two lines into your <em>php.ini</em> file and restart your server:</p>
<pre data-type="programlisting" data-code-language="ini"><code class="na">extension</code><code class="o">=</code><code class="s">php_pdo.dll</code>
<code class="na">extension</code><code class="o">=</code><code class="s">php_pdo_mysql.dll</code></pre>
<p>The PDO library is also an object-oriented extension (as you will see in the code examples that follow).</p>
<section data-type="sect3" data-pdf-bookmark="Making a connection"><div class="sect3" id="making_a_connection">
<h3>Making a connection</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="connecting to" id="idm45922771934056"/>The first requirement for PDO is to make a connection to the database in question and hold that connection in a connection handle variable, as in the following code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">PDO</code><code class="p">(</code><code class="nv">$</code><em><code class="nv">dsn</code></em><code class="p">,</code><code> </code><code class="nv">$</code><em><code class="nv">username</code></em><code class="p">,</code><code> </code><code class="nv">$</code><em><code class="nv">password</code></em><code class="p">);</code></pre>
<p>The <code>$</code><em>dsn</em> stands for <em>data source name</em>, and the other two parameters are self-explanatory. Specifically, for a MySQL connection, you would write the following code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PDO</code><code class="p">(</code><code class="s2">"mysql:host=localhost;dbname=library"</code><code class="p">,</code> <code class="s2">"petermac"</code><code class="p">,</code> <code class="s2">"abc123"</code><code class="p">);</code></pre>
<p>Of course, you could (should) maintain variable-based username and password parameters for code reuse and flexibility reasons.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Interacting with the database"><div class="sect3" id="interacting_with_the_database">
<h3>Interacting with the database</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="interacting with" id="idm45922764947464"/>Once you have connected to your database engine and the database that you want to interact with, you can use that connection to send SQL commands to the server. <a contenteditable="false" data-type="indexterm" data-primary="UPDATE command, SQL" id="idm45922764945784"/><a contenteditable="false" data-type="indexterm" data-primary="query method, database" id="idm45922764944680"/>A simple <code>UPDATE</code> statement would look like this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="s2">"UPDATE books SET authorid=4 WHERE pub_year=1982"</code><code class="p">);</code></pre>
<p>This code simply updates the books table and releases the query. This allows you to send simple SQL commands (e.g., <code>UPDATE</code>, <code>DELETE</code>, <code>INSERT</code>) directly to the database.</p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Using PDO and prepared statements"><div class="sect3" id="using_pdo_and_prepared_statements">
<h3><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="prepared statements for" id="idm45922764928264"/>Using PDO and prepared statements</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="prepare method, database" id="idm45922764926472"/>More typically, you’ll use <em>prepared statements</em>, issuing PDO calls in stages or steps. Consider the following code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s2">"SELECT * FROM books"</code><code class="p">);</code>
<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">();</code>

<code class="c1">// handle row results, one at a time</code>
<code class="k">while</code><code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">())</code> <code class="p">{</code>
 <code class="nb">print_r</code><code class="p">(</code><code class="nv">$row</code><code class="p">);</code>
 <code class="c1">// ... or probably do something more meaningful with each returned row</code>
<code class="p">}</code>

<code class="nv">$statement</code> <code class="o">=</code> <code class="k">null</code><code class="p">;</code></pre>
<p><a contenteditable="false" data-type="indexterm" data-primary="execute method, database" id="idm45922764923800"/>In this code, we “prepare” the SQL code and then “execute” it. Next, we cycle through the result with the <code>while</code> code and, finally, we release the result object by assigning <code>null</code> to it. This may not look all that powerful in this simple example, but there are other features that can be used with prepared statements. Now, consider this code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s2">"INSERT INTO books (authorid, title, ISBN, pub_year)"</code>
 <code class="o">.</code> <code class="s2">"VALUES (:authorid, :title, :ISBN, :pub_year)"</code><code class="p">);</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">(</code><code class="k">array</code><code class="p">(</code>
 <code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">4</code><code class="p">,</code>
 <code class="s1">'title'</code> <code class="o">=&gt;</code> <code class="s2">"Foundation"</code><code class="p">,</code>
 <code class="s1">'ISBN'</code> <code class="o">=&gt;</code> <code class="s2">"0-553-80371-9"</code><code class="p">,</code>
 <code class="s1">'pub_year'</code> <code class="o">=&gt;</code> <code class="mi">1951</code><code class="p">),</code>
<code class="p">);</code></pre>
<p>Here, we prepare the SQL statement with four named placeholders: <em>authorid</em>, <em>title</em>, <em>ISBN</em>, and <em>pub_year</em>. In this case, these happen to be the same names as the columns in the database, but this is done only for clarity—the placeholder names can be anything that is meaningful to you. In the execute call, we replace these placeholders with the actual data that we want to use in this particular query. One of the advantages of prepared statements is that you can execute the same SQL command and pass in different values through the array each time. You can also do this type of statement preparation with positional placeholders (not actually naming them), signified by a ?, which is the positional item to be replaced. Look at the following variation of the previous code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s2">"INSERT INTO books (authorid, title, ISBN, pub_year)"</code>
 <code class="o">.</code> <code class="s2">"VALUES (?, ?, ?, ?)"</code><code class="p">);</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">(</code><code class="k">array</code><code class="p">(</code><code class="mi">4</code><code class="p">,</code> <code class="s2">"Foundation"</code><code class="p">,</code> <code class="s2">"0-553-80371-9"</code><code class="p">,</code> <code class="mi">1951</code><code class="p">));</code></pre>
<p>This accomplishes the same thing but with less code, as the value area of the SQL statement does not name the elements to be replaced, and therefore the array in the <code>execute</code> statement needs to send in only the raw data and no names. You just have to be sure about the position of the data that you are sending into the prepared <span class="keep-together">statement.</span></p>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Handling transactions"><div class="sect3" id="handling_transactions">
<h3>Handling transactions</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="transactions, database" id="idm45922764734440"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="transactions for" id="idm45922764733336"/>Some RDBMSs support <em>transactions</em>, in which a series of database changes can be committed (all applied at once) or rolled back (discarded, with none of the changes applied to the database). For example, when a bank handles a money transfer, the withdrawal from one account and deposit into another must happen together—neither should happen without the other, and there should be no time lag between the two actions. PDO handles transactions elegantly with <a contenteditable="false" data-type="indexterm" data-primary="try…catch statement" id="idm45922764730936"/><code>try...catch</code> structures like this one in <a data-type="xref" href="#example_nine_onedot_the_trydotdotdotcat">Example 9-1</a>.</p>
<div data-type="example" id="example_nine_onedot_the_trydotdotdotcat">
<h5><span class="label">Example 9-1. </span>The try...catch code structure</h5>
<pre data-type="programlisting" data-code-language="php"><code class="k">try</code> <code class="p">{</code>
 <code class="c1">// connection successful</code>
 <code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">PDO</code><code class="p">(</code><code class="s2">"mysql:host=localhost;dbname=banking_sys"</code><code class="p">,</code> <code class="s2">"petermac"</code><code class="p">,</code> <code class="s2">"abc123"</code><code class="p">);</code>
<code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">Exception</code> <code class="nv">$error</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">die</code><code class="p">(</code><code class="s2">"Connection failed: "</code> <code class="o">.</code> <code class="nv">$error</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">());</code>
<code class="p">}</code>

<code class="k">try</code> <code class="p">{</code>
 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">setAttribute</code><code class="p">(</code><code class="nx">PDO</code><code class="o">::</code><code class="na">ATTR_ERRMODE</code><code class="p">,</code> <code class="nx">PDO</code><code class="o">::</code><code class="na">ERRMODE_EXCEPTION</code><code class="p">);</code>
 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">beginTransaction</code><code class="p">();</code>

 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="s2">"insert into accounts (account_id, amount) values (23, '5000')"</code> <code class="p">);</code>
 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">exec</code><code class="p">(</code><code class="s2">"insert into accounts (account_id, amount) values (27, '-5000')"</code> <code class="p">);</code>

 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">commit</code><code class="p">();</code>
<code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">Exception</code> <code class="nv">$error</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">rollback</code><code class="p">();</code>
 <code class="k">echo</code> <code class="s2">"Transaction not completed: "</code> <code class="o">.</code> <code class="nv">$error</code><code class="o">-&gt;</code><code class="na">getMessage</code><code class="p">();</code>
<code class="p">}</code></pre>
</div>
<p>If the entirety of the transaction can’t be completed, none of it will be, and an exception will be thrown.</p>
<p>If you call <a contenteditable="false" data-type="indexterm" data-primary="commit method, database" id="idm45922764724504"/><code>commit()</code> or <a contenteditable="false" data-type="indexterm" data-primary="rollback method, database" id="idm45922764636680"/><code>rollback()</code> on a database that doesn’t support transactions, the methods return <code>DB_ERROR</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Be sure to check your underlying database product to ensure that it supports transactions.</p>
</div>
</div></section>
<section data-type="sect3" data-pdf-bookmark="Debugging statements"><div class="sect3" id="debugging_statements">
<h3>Debugging statements</h3>
<p><a contenteditable="false" data-type="indexterm" data-primary="debugging" data-secondary="PDO statements" id="idm45922764576696"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="debugging statements" id="idm45922764575320"/>The PDO interface provides a method for showing details about a PDO statement, which can be useful for debugging if something goes wrong.</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$statement</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">prepare</code><code class="p">(</code><code class="s2">"SELECT title FROM books WHERE authorid = ?)"</code><code class="p">;</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">bindParam</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="s2">"12345678"</code><code class="p">,</code> <code class="nx">PDO</code><code class="o">::</code><code class="na">PARAM_STR</code><code class="p">);</code>
<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">execute</code><code class="p">();</code>

<code class="nv">$statement</code><code class="o">-&gt;</code><code class="na">debugDumpParams</code><code class="p">();</code></pre>
<p>Calling the <a contenteditable="false" data-type="indexterm" data-primary="debugDumpParams method, database" id="idm45922764553640"/><code>debugDumpParams()</code> method on the statement object prints a variety of information about the call:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nx">SQL</code><code class="o">:</code> <code class="p">[</code><code class="mi">35</code><code class="p">]</code> <code class="nx">SELECT</code> <code class="nx">title</code>
 <code class="nx">FROM</code> <code class="nx">books</code>
 <code class="nx">WHERE</code> <code class="nx">authorID</code> <code class="o">=</code> <code class="o">?</code>
<code class="nx">Sent</code> <code class="nx">SQL</code><code class="o">:</code> <code class="p">[</code><code class="mi">44</code><code class="p">]</code> <code class="nx">SELECT</code> <code class="nx">title</code>
 <code class="nx">FROM</code> <code class="nx">books</code>
 <code class="nx">WHERE</code> <code class="nx">authorid</code> <code class="o">=</code> <code class="s2">"12345678"</code>
<code class="nx">Params</code><code class="o">:</code> <code class="mi">1</code>
<code class="nx">Key</code><code class="o">:</code> <code class="nx">Position</code> <code class="c1">#0:</code>
<code class="nx">paramno</code><code class="o">=</code><code class="mi">0</code>
<code class="nx">name</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="s2">""</code>
<code class="nx">is_param</code><code class="o">=</code><code class="mi">1</code>
<code class="nx">param_type</code><code class="o">=</code><code class="mi">2</code></pre>
<p>The <code>Sent SQL</code> section is displayed only after the statement is executed; prior to that, only the <code>SQL</code> and <code>Params</code> sections are available.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_RDBMS" id="idm45922764400840"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_RDBMS_overview" id="idm45922764399576"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_pdo_library_ch9" id="idm45922764398200"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_pdo_library" id="idm45922764396824"/></p>
</div></section>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="MySQLi Object Interface"><div class="sect1" id="mysqli_object_interface">
<h1>MySQLi Object Interface</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="MySQLi object interface" id="ix_mysqli_database_ch9"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="MySQLi interface" id="ix_databases_mysqli"/>The most popular database platform used with PHP is the MySQL database. If you look at the<a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="MySQL versions" id="idm45922764390840"/> <a href="http://www.mysql.com">MySQL website</a>, you’ll discover that there are a few different versions of MySQL you can use. We will look at the freely distributable version known as the <a contenteditable="false" data-type="indexterm" data-primary="community server" id="idm45922764388456"/><em>community server</em>. PHP has a number of different interfaces to this database tool as well, so we will look at the object-oriented interface known as MySQLi, aka the <em>MySQL Improved</em> extension.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="MariaDB" id="idm45922764386168"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="MariaDB" id="idm45922764385064"/><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="MariaDB" id="idm45922764383688"/>Recently, <a href="http://mariadb.com">MariaDB</a> has started overtaking MySQL as the database of choice for PHP developers. By design, MariaDB is client language–, connection tool–, and binary file–compatible with MySQL; this means that you can install MariaDB, uninstall MySQL, and point your PHP configuration to MariaDB instead, and likely need no other changes.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="OOP (object-oriented programming)" id="idm45922764380840"/>If you are not overly familiar with OOP interfaces and concepts, be sure to review <a data-type="xref" href="ch06.xhtml#objects-id00032">Chapter 6</a> before you get too far into this section.</p>
<p>Since this object-oriented interface is built into PHP with a standard installation configuration (you simply activate the MySQLi extension in your PHP environment), all you have to do to start using it is instantiate its class, as in the following code:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code><code> </code><code class="o">=</code><code> </code><code class="k">new</code><code> </code><code class="nx">mysqli</code><code class="p">(</code><em><code class="nx">host</code></em><code class="p">,</code><code> </code><em><code class="nx">user</code></em><code class="p">,</code><code> </code><em><code class="nx">password</code></em><code class="p">,</code><code> </code><em><code class="nx">databaseName</code></em><code class="p">);</code></pre>
<p>In this example, we have a database named <code>library</code>, and we will use the fictitious username of <code>petermac</code> and the password of <code>1q2w3e9i8u7y</code>. The actual code that would be used is:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">mysqli</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="s2">"petermac"</code><code class="p">,</code> <code class="s2">"1q2w3e9i8u7y"</code><code class="p">,</code> <code class="s2">"library"</code><code class="p">);</code></pre>
<p>This gives us access to the database engine itself within the PHP code; we will specifically access tables and other data later. Once this class is instantiated into the variable <code>$db</code>, we can use methods on that object to do our database work.</p>
<p>A brief example of generating some code to insert a new book into the <code>library</code> database would look something like this:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">mysqli</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="s2">"petermac"</code><code class="p">,</code> <code class="s2">"1q2w3e9i8u7y"</code><code class="p">,</code> <code class="s2">"library"</code><code class="p">);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"INSERT INTO books (authorid, title, ISBN, pub_year, available)</code>
<code class="s2"> VALUES (4, 'I, Robot', '0-553-29438-5', 1950, 1)"</code><code class="p">;</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">))</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Book data saved successfully."</code><code class="p">;</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"INSERT attempt failed, please try again later, or call tech support"</code> <code class="p">;</code>
<code class="p">}</code>

<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">close</code><code class="p">();</code></pre>
<p>First, we instantiate the MySQLi class into the variable <code>$db</code>. Next, we build our SQL command string and save it to a variable called <code>$sql</code>. Then we call the query method of the class and at the same time test its return value to determine if it was successful (<code>TRUE</code>), and then comment to the screen accordingly. You may not want to <code>echo</code> out to the browser at this stage, as again this is only an example. Last, we call the <code>close()</code> method on the class to tidy up and destroy the class from memory.</p>
<section data-type="sect2" data-pdf-bookmark="Retrieving Data for Display"><div class="sect2" id="retrieving_data_for_display">
<h2>Retrieving Data for Display</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="retrieving data for display" id="idm45922764203480"/>In another area of your website, you may want to draw out a listing of your books and show who their authors are. We can accomplish this by employing the same MySQLi class and working with the result set that is generated from a <a contenteditable="false" data-type="indexterm" data-primary="SELECT command, SQL" id="idm45922764201768"/><code>SELECT</code> SQL command. There are many ways to display the information in the browser, and we’ll look at one example of how this can be done. Notice that the result returned is a different object than the <code>$db</code> that we first instantiate. PHP instantiates the result object for you and fills it with any returned data.</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">mysqli</code><code class="p">(</code><code class="s2">"localhost"</code><code class="p">,</code> <code class="s2">"petermac"</code><code class="p">,</code> <code class="s2">"1q2w3e9i8u7y"</code><code class="p">,</code> <code class="s2">"library"</code><code class="p">);</code>
<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"SELECT a.name, b.title FROM books b, authors a WHERE </code>
<code class="s2">a.authorid=b.authorid"</code><code class="p">;</code>
<code class="nv">$result</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">);</code>

<code class="k">while</code> <code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch_assoc</code><code class="p">())</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$row</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]</code><code class="si">}</code><code class="s2"> is the author of: </code><code class="si">{</code><code class="nv">$row</code><code class="p">[</code><code class="s1">'title'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="p">}</code>

<code class="nv">$result</code><code class="o">-&gt;</code><code class="na">close</code><code class="p">();</code>
<code class="nv">$db</code><code class="o">-&gt;</code><code class="na">close</code><code class="p">();</code></pre>
<p>Here, we are using the <a contenteditable="false" data-type="indexterm" data-primary="query method, database" id="idm45922764197512"/><code>query()</code> method call and storing the returned information into the variable called <code>$result</code>. Then we are using a method of the result object called <code>fetch_assoc()</code> to provide one row of data at a time, and we are storing that single row into the variable called <code>$row</code>. This continues as long as there are rows to process. Within that <code>while</code> loop, we are dumping content out to the browser window. Finally, we are closing both the result and the database objects.</p>
<p>The output would look like this:</p>
<pre data-type="programlisting"><strong>J.R.R. Tolkien is the author of: The Two Towers</strong>
<strong>J.R.R. Tolkien is the author of: The Return of The King</strong>
<strong>J.R.R. Tolkien is the author of: The Hobbit</strong>
<strong>Alex Haley is the author of: Roots</strong>
<strong>Tom Clancy is the author of: Rainbow Six</strong>
<strong>Tom Clancy is the author of: Teeth of the Tiger</strong>
<strong>Tom Clancy is the author of: Executive Orders...</strong></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>One of the most useful methods in MySQLi is <a contenteditable="false" data-type="indexterm" data-primary="multi_query method, database" id="idm45922764152904"/><code>multi_query()</code>, which allows you to run multiple SQL commands in the same statement. If you want to do an <code>INSERT</code> and then an <code>UPDATE</code> statement based on similar data, you can do it all in one method call—one step.</p>
</div>
<p>We have, of course, just scratched the surface of what the MySQLi class has to offer. If you review its <a href="http://www.php.net/mysqli">documentation</a>), you’ll see the extensive list of methods that are part of this class, as well as each result class documented within the appropriate subject area.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_mysqli" id="idm45922764148952"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_mysqli_database_ch9" id="idm45922764147576"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="SQLite"><div class="sect1" id="sqlite">
<h1>SQLite</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="SQLite database" id="ix_sqlite_database_ch9"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="SQLite" id="ix_databases_sqlite_ch9"/>SQLite is a compact, highly performant (for small data sets), and—as its name suggests—lightweight  database. SQLite is ready to go right out of the box when you install PHP, so if it sounds like a good fit for your database needs, be sure to read up on it.</p>
<p>All the database storage in SQLite is file-based, and therefore accomplished without the use of a separate database engine. This can be very advantageous if you are trying to build an application with a small database footprint and no product dependencies other than PHP. All you have to do to start using SQLite is to reference it in your code.</p>
<p><a contenteditable="false" data-type="indexterm" data-primary="OOP (object-oriented programming)" id="idm45922764139976"/>There is an OOP interface to SQLite, so you can instantiate an object with the following statement:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SQLiteDatabase</code><code class="p">(</code><code class="s2">"library.sqlite"</code><code class="p">);</code></pre>
<p><a contenteditable="false" data-type="indexterm" data-primary="CREATE command, SQL" id="idm45922764133480"/>The neat thing about this statement is that if the file is not found at the specified location, SQLite creates it for you. Continuing with our <code>library</code> database example, the command to create the authors table and insert a sample row within SQLite would look something like <a data-type="xref" href="#example_nine_twodot_sqlite_library_auth">Example 9-2</a>.</p>
<div data-type="example" id="example_nine_twodot_sqlite_library_auth">
<h5><span class="label">Example 9-2. </span>SQLite library authors table</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$sql</code><code> </code><code class="o">=</code><code> </code><code class="s2">"</code><code class="s2">CREATE TABLE 'authors' ('authorid' INTEGER PRIMARY KEY, 'name' TEXT)</code><code class="s2">"</code><code class="p">;</code><code>

</code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="nv">$database</code><code class="o">-&gt;</code><code class="na">queryExec</code><code class="p">(</code><code class="nv">$sql</code><code class="p">,</code><code> </code><code class="nv">$error</code><code class="p">))</code><code> </code><code class="p">{</code><code>
 </code><code class="k">echo</code><code> </code><code class="s2">"</code><code class="s2">Create Failure - </code><code class="si">{</code><code class="nv">$error</code><code class="si">}</code><code class="s2">&lt;br /&gt;</code><code class="s2">"</code><code class="p">;</code><code>
</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>
 </code><code class="k">echo</code><code> </code><code class="s2">"</code><code class="s2">Table Authors was created &lt;br /&gt;</code><code class="s2">"</code><code class="p">;</code><code>
</code><code class="p">}</code><code>

</code><code class="nv">$sql</code><code> </code><code class="o">=</code><code> </code><code class="s">&lt;&lt;&lt;SQL
INSERT INTO 'authors' ('name') VALUES ('J.R.R. Tolkien');
INSERT INTO 'authors' ('name') VALUES ('Alex Haley');
INSERT INTO 'authors' ('name') VALUES ('Tom Clancy');
INSERT INTO 'authors' ('name') VALUES ('Isaac Asimov');
SQL;
</code><code>
</code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="nv">$database</code><code class="o">-&gt;</code><code class="na">queryExec</code><code class="p">(</code><code class="nv">$sql</code><code class="p">,</code><code> </code><code class="nv">$error</code><code class="p">))</code><code> </code><code class="p">{</code><code>
 </code><code class="k">echo</code><code> </code><code class="s2">"</code><code class="s2">Insert Failure - </code><code class="si">{</code><code class="nv">$error</code><code class="si">}</code><code class="s2">&lt;br /&gt;</code><code class="s2">"</code><code class="p">;</code><code>
</code><code class="p">}</code><code> </code><code class="k">else</code><code> </code><code class="p">{</code><code>
 </code><code class="k">echo</code><code> </code><code class="s2">"</code><code class="s2">INSERT to Authors - OK&lt;br /&gt;</code><code class="s2">"</code><code class="p">;</code><code>
</code><code class="p">}</code><code>
</code><strong><code class="nx">Table</code><code> </code><code class="nx">Authors</code><code> </code><code class="nx">was</code><code> </code><code class="nx">createdINSERT</code><code> </code><code class="nx">to</code><code> </code><code class="nx">Authors</code><code> </code><code class="o">-</code><code> </code><code class="nx">OK</code></strong></pre>
</div>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In SQLite, unlike MySQL, there is no <code>AUTO_INCREMENT</code> option. SQLite instead makes any column that is defined with <code>INTEGER</code> and <code>PRIMARY KEY</code> an automatically incrementing column. You can override this default behavior by providing a value to the column when an <code>INSERT</code> statement is executed.</p>
</div>
<p>Notice that the data types are quite different from what we have seen in MySQL. Remember that SQLite is a trimmed-down database tool and therefore it is “lite” on its data types; see <a data-type="xref" href="#data_types_available_in_sqlite">Table 9-1</a> for a listing of the data types that it uses.</p>
<table class="border" id="data_types_available_in_sqlite">
<caption><span class="label">Table 9-1. </span>Data types available in SQLite</caption>
<thead>
<tr>
<th>Data type</th>
<th>Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td>Text</td>
<td>Stores data as <code>NULL</code>, <code>TEXT</code>, or <code>BLOB</code> content. If a number is supplied to a text field, it is converted to text before it is stored.</td>
</tr>
<tr>
<td>Numeric</td>
<td>Can store either integer or real data. If text data is supplied, SQLite attempts to convert the information to numerical format.</td>
</tr>
<tr>
<td>Integer</td>
<td>Behaves the same as the numeric data type. However, if data of the real type is supplied, it is stored as an integer. This may affect data storage accuracy.</td>
</tr>
<tr>
<td>Real</td>
<td>Behaves the same as the numeric data type, except that it forces integer values into floating-point representation.</td>
</tr>
<tr>
<td>None</td>
<td>This is a catchall data type; it does not prefer one base type to another. Data is stored exactly as supplied.</td>
</tr>
</tbody>
</table>
<p>Run the following code in <a data-type="xref" href="#example_nine_threedot_sqlite_library_bo">Example 9-3</a> to create the books table and insert some data into the database file.</p>
<div data-type="example" id="example_nine_threedot_sqlite_library_bo">
<h5><span class="label">Example 9-3. </span>SQLite library books table</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SQLiteDatabase</code><code class="p">(</code><code class="s2">"library.sqlite"</code><code class="p">);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"CREATE TABLE 'books' ('bookid' INTEGER PRIMARY KEY,</code>
<code class="s2"> 'authorid' INTEGER,</code>
<code class="s2"> 'title' TEXT,</code>
<code class="s2"> 'ISBN' TEXT,</code>
<code class="s2"> 'pub_year' INTEGER,</code>
<code class="s2"> 'available' INTEGER,</code>
<code class="s2">)"</code><code class="p">;</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">queryExec</code><code class="p">(</code><code class="nv">$sql</code><code class="p">,</code> <code class="nv">$error</code><code class="p">)</code> <code class="o">==</code> <code class="k">FALSE</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Create Failure - </code><code class="si">{</code><code class="nv">$error</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Table Books was created&lt;br /&gt;"</code><code class="p">;</code>
<code class="p">}</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s">&lt;&lt;&lt;SQL</code>
<code class="s">INSERT INTO books ('authorid', 'title', 'ISBN', 'pub_year', 'available')</code>
<code class="s">VALUES (1, 'The Two Towers', '0-261-10236-2', 1954, 1);</code>

<code class="s">INSERT INTO books ('authorid', 'title', 'ISBN', 'pub_year', 'available')</code>
<code class="s">VALUES (1, 'The Return of The King', '0-261-10237-0', 1955, 1);</code>

<code class="s">INSERT INTO books ('authorid', 'title', 'ISBN', 'pub_year', 'available')</code>
<code class="s">VALUES (2, 'Roots', '0-440-17464-3', 1974, 1);</code>

<code class="s">INSERT INTO books ('authorid', 'title', 'ISBN', 'pub_year', 'available')</code>
<code class="s">VALUES (4, 'I, Robot', '0-553-29438-5', 1950, 1);</code>

<code class="s">INSERT INTO books ('authorid', 'title', 'ISBN', 'pub_year', 'available')</code>
<code class="s">VALUES (4, 'Foundation', '0-553-80371-9', 1951, 1);</code>
<code class="s">SQL;</code>

<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nv">$db</code><code class="o">-&gt;</code><code class="na">queryExec</code><code class="p">(</code><code class="nv">$sql</code><code class="p">,</code> <code class="nv">$error</code><code class="p">))</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Insert Failure - </code><code class="si">{</code><code class="nv">$error</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"INSERT to Books - OK&lt;br /&gt;"</code><code class="p">;</code>
<code class="p">}</code></pre>
</div>
<p>Notice that we can execute multiple SQL commands at the same time. We could also do this with MySQLi, but you’d have to remember to use the <a contenteditable="false" data-type="indexterm" data-primary="multi_query method, database" id="idm45922763968200"/><code>multi_query()</code> method; with SQLite, it’s available with the <a contenteditable="false" data-type="indexterm" data-primary="queryExec method, database" id="idm45922763818744"/><code>queryExec()</code> method. After loading the database with some data, run the code in <a data-type="xref" href="#example_nine_fourdot_sqlite_select_book">Example 9-4</a>.</p>
<div data-type="example" id="example_nine_fourdot_sqlite_select_book">
<h5><span class="label">Example 9-4. </span>SQLite select books</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$db</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">SQLiteDatabase</code><code class="p">(</code><code class="s2">"c:/copy/library.sqlite"</code><code class="p">);</code>

<code class="nv">$sql</code> <code class="o">=</code> <code class="s2">"SELECT a.name, b.title FROM books b, authors a WHERE a.authorid=b.authorid"</code><code class="p">;</code>
<code class="nv">$result</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">query</code><code class="p">(</code><code class="nv">$sql</code><code class="p">);</code>

<code class="k">while</code> <code class="p">(</code><code class="nv">$row</code> <code class="o">=</code> <code class="nv">$result</code><code class="o">-&gt;</code><code class="na">fetch</code><code class="p">())</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"</code><code class="si">{</code><code class="nv">$row</code><code class="p">[</code><code class="s1">'a.name'</code><code class="p">]</code><code class="si">}</code><code class="s2"> is the author of: </code><code class="si">{</code><code class="nv">$row</code><code class="p">[</code><code class="s1">'b.title'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br/&gt;"</code><code class="p">;</code>
<code class="p">}</code></pre>
</div>
<p>The preceding code produces the following output:</p>
<pre data-type="programlisting"><strong>J.R.R. Tolkien is the author of: The Two Towers</strong>
<strong>J.R.R. Tolkien is the author of: The Return of The King</strong>
<strong>Alex Haley is the author of: Roots</strong>
<strong>Isaac Asimov is the author of: I, Robot</strong>
<strong>Isaac Asimov is the author of: Foundation</strong></pre>
<p>SQLite can do almost as much as the “bigger” database engines—the “lite” refers not to its functionality but to its demand for system resources. You should always consider SQLite when you require a database that’s more portable and less demanding of resources.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>If you are just getting started with the dynamic aspect of web development, you can use PDO to interface with SQLite. In this way, you can start with a lightweight database and grow into a more robust database server like MySQL when you are ready.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_sqlite_ch9" id="idm45922763777032"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_sqlite_database_ch9" id="idm45922763775656"/></p>
</div>
</div></section>
<section data-type="sect1" data-pdf-bookmark="Direct File-Level Manipulation"><div class="sect1" id="direct_file_level_manipulation">
<h1>Direct File-Level Manipulation</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="files" data-secondary="as alternative to database" id="ix_file_manip_alt_database"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="file manipulation as alternative to" id="ix_databases_file_manip"/>PHP has many little hidden features within its vast toolset. One of these features (which is often overlooked) is its uncanny ability to handle complex files. Sure, everyone knows that PHP can open a file, but what can it really do with that file? Consider the following example highlighting the true range of its possibilities. One of this book’s authors was contacted by a prospective client who had “no money” but wanted a dynamic web survey developed. Of course, the author initially offered the client the wonders of PHP and database interaction with MySQLi. Upon hearing the monthly fees from a local ISP, however, the client asked if there was any other (cheaper) way to accomplish the work. It turns out that if you don’t want to use SQLite, an alternative is to use files to manage and manipulate small amounts of text for later retrieval. <a contenteditable="false" data-type="indexterm" data-primary="functions" data-secondary="file management" id="idm45922763752776"/><a contenteditable="false" data-type="indexterm" data-primary="files" data-secondary="functions for" id="idm45922763751400"/>The functions we’ll discuss here are nothing out of the ordinary when taken individually—in fact, they’re really part of the basic PHP toolset everyone is probably familiar with, as you can see in <a data-type="xref" href="#commonly_used_php_file_management_funct">Table 9-2</a>.</p>
<table class="border" id="commonly_used_php_file_management_funct">
<caption><span class="label">Table 9-2. </span>Commonly used PHP file management functions</caption>
<thead>
<tr>
<th>Function name</th>
<th>Description of use</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mkdir()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="mkdir function" id="idm45922763743736"/>Used to make a directory on the server.</td>
</tr>
<tr>
<td><code>file_exists()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="file_exists function" id="idm45922763741192"/>Used to determine if a file or directory exists at the supplied location.</td>
</tr>
<tr>
<td><code>fopen()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="fopen function" id="idm45922763738648"/>Used to open an existing file for reading or writing (see detailed options for correct usage).</td>
</tr>
<tr>
<td><code>fread()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="fread function" id="idm45922763735992"/>Used to read in the contents of a file to a variable for PHP use.</td>
</tr>
<tr>
<td><code>flock()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="flock function" id="idm45922763733448"/>Used to gain an exclusive lock on a file for writing.</td>
</tr>
<tr>
<td><code>fwrite()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="fwrite function" id="idm45922763730840"/>Used to write the contents of a variable to a file.</td>
</tr>
<tr>
<td><code>filesize()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="filesize function" id="idm45922763728232"/>When reading in a file, this is used to determine how many bytes to read in at a time.</td>
</tr>
<tr>
<td><code>fclose()</code></td>
<td><a contenteditable="false" data-type="indexterm" data-primary="fclose function" id="idm45922763725688"/>Used to close the file once its usefulness has passed.</td>
</tr>
</tbody>
</table>
<p>The interesting part is in tying all the functions together to accomplish your objective. For example, let’s create a small web form survey that covers two pages of questions. Users can enter some opinions and return at a later date to finish the survey, picking up right where they left off. We’ll scope out the logic of our little application and, hopefully, you will see that its basic premise can be expanded to a full production-type employment.</p>
<p>The first thing that we want to do is allow users to return to this survey at any time to provide additional input. To do this, we need to have a unique identifier to differentiate one user from another. Generally, a person’s email address is unique (other people might know it and use it, but that is a question of website security and/or controlling identity theft). For the sake of simplicity, we’ll assume honesty here in the use of email addresses and not bother with a password system. So, once we have the user’s email address, we need to store that information in a location that is distinct from that of other site visitors. For this purpose, we will create a directory folder for each visitor on the server (this, of course, assumes that you have access and proper rights to a location on the server that permits the reading and writing of files). Since we have the relatively unique identifier in the visitor’s email address, we will simply name the new directory location with that identifier. Once we’ve created a directory (testing to see if the user has returned from a previous session), we will read in any file contents that are already there and display them in a <code>&lt;textarea&gt;</code> form control so that the visitor can see what (if anything) he or she has written previously. We then save the visitor’s comments upon the submission of the form and move on to the next survey question. <a data-type="xref" href="#example_nine_fivedot_file_level_access">Example 9-5</a> shows the code for the first page (the <code>&lt;?php</code> tags are included here because there are places where they are turned on and off throughout the listing).</p>
<div data-type="example" id="example_nine_fivedot_file_level_access">
<h5><span class="label">Example 9-5. </span>File-level access</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nb">session_start</code><code class="p">();</code>

<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">empty</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'posted'</code><code class="p">])</code> <code class="o">&amp;&amp;</code> <code class="o">!</code><code class="k">empty</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'email'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="nv">$folder</code> <code class="o">=</code> <code class="s2">"surveys/"</code> <code class="o">.</code> <code class="nb">strtolower</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'email'</code><code class="p">]);</code>

 <code class="c1">// send path information to the session</code>
 <code class="nv">$_SESSION</code><code class="p">[</code><code class="s1">'folder'</code><code class="p">]</code> <code class="o">=</code> <code class="nv">$folder</code><code class="p">;</code>

 <code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nb">file_exists</code><code class="p">(</code><code class="nv">$folder</code><code class="p">))</code> <code class="p">{</code>
 <code class="c1">// make the directory and then add the empty files</code>
 <code class="nb">mkdir</code><code class="p">(</code><code class="nv">$folder</code><code class="p">,</code> <code class="mo">0777</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="nb">header</code><code class="p">(</code><code class="s2">"Location: 08_6.php"</code><code class="p">);</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="cp">?&gt;</code><code class="x"/></pre>
  <pre data-type="programlisting" data-code-language="html+php"><code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Files <code class="err">&amp;</code> folders - On-line Survey<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body</code> <code class="na">bgcolor=</code><code class="s">"white"</code> <code class="na">text=</code><code class="s">"black"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;h2&gt;</code>Survey Form<code class="nt">&lt;/h2&gt;</code>

 <code class="nt">&lt;p&gt;</code>Please enter your e-mail address to start recording your comments<code class="nt">&lt;/p&gt;</code>

 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"</code><code class="cp">&lt;?php</code> <code class="k">echo</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'PHP_SELF'</code><code class="p">];</code> <code class="cp">?&gt;</code><code class="s">"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"posted"</code> <code class="na">value=</code><code class="s">"1"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;p&gt;</code>Email address: <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"text"</code> <code class="na">name=</code><code class="s">"email"</code> <code class="na">size=</code><code class="s">"45"</code> <code class="nt">/&gt;&lt;br</code> <code class="nt">/&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"submit"</code> <code class="na">value=</code><code class="s">"Submit"</code><code class="nt">&gt;&lt;/p&gt;</code>
 <code class="nt">&lt;/form&gt;</code>
 <code class="nt">&lt;/body&gt;</code>
 <code class="nt">&lt;/html&gt;</code>
<code class="cp">&lt;?php</code> <code class="p">}</code></pre>
</div>
<p><a data-type="xref" href="#survey_login_screen">Figure 9-1</a> shows the web page that asks the visitor to submit an email address.</p>
<figure><div id="survey_login_screen" class="figure">
<img src="Images/php4_0901.png" alt="Survey login screen" width="470" height="173"/>
<h6><span class="label">Figure 9-1. </span>Survey login screen</h6>
</div></figure>
<p>As you can see, the first thing that we do is open a new session to pass the visitor’s information on to subsequent pages. Then we test to confirm that the form further down in the code has indeed been submitted and that there is something entered in the email address field. If this test fails, the form is simply redisplayed. Of course, the production version of this functionality would send out an error message telling the user to enter valid text.</p>
<p>Once this test has passed (assuming the form has been submitted correctly) we create a <code>$folder</code> variable that contains the directory structure where we want to save the survey information and append the user’s email address to it; we also save the contents of this newly created variable (<code>$folder</code>) into the session for later use. Here we simply take the email address and use it (again, if this were a secure site, we would protect the data with proper security measures).</p>
<p>Next, we want to see if the directory already exists. If it does not, we create it with the <a contenteditable="false" data-type="indexterm" data-primary="mkdir function" id="idm45922763353368"/><code>mkdir()</code> function. This function takes the argument of the path and the name of the directory we want to create and attempts to create it.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>In a Linux environment, there are other options on the <code>mkdir()</code> function that control access levels and permissions on the newly created directory, so be sure to look into those options if this applies to your environment.</p>
</div>
<p>After we verify that the directory exists, we simply direct the browser to the first page of the survey.</p>
<p>Now that we are on the first page of the survey (see <a data-type="xref" href="#the_first_page_of_the_survey">Figure 9-2</a>), the form is ready for use.</p>
<figure><div id="the_first_page_of_the_survey" class="figure">
<img src="Images/php4_0902.png" alt="The first page of the survey" width="418" height="373"/>
<h6><span class="label">Figure 9-2. </span>The first page of the survey</h6>
</div></figure>
<p>This, however, is a dynamically generated form, as you can see in <a data-type="xref" href="#example_nine_sixdot_file_level_accessco">Example 9-6</a>.</p>
<div data-type="example" id="example_nine_sixdot_file_level_accessco">
<h5><span class="label">Example 9-6. </span>File-level access, continued</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nb">session_start</code><code class="p">();</code>
<code class="nv">$folder</code> <code class="o">=</code> <code class="nv">$_SESSION</code><code class="p">[</code><code class="s1">'folder'</code><code class="p">];</code>
<code class="nv">$filename</code> <code class="o">=</code> <code class="nv">$folder</code> <code class="o">.</code> <code class="s2">"/question1.txt"</code><code class="p">;</code>

<code class="c1">// open file for reading then clean it out</code>
<code class="nv">$file_handle</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$filename</code><code class="p">,</code> <code class="s2">"a+"</code><code class="p">);</code>

<code class="c1">// pick up any text in the file that may already be there</code>
<code class="nv">$comments</code> <code class="o">=</code> <code class="nb">file_get_contents</code><code class="p">(</code><code class="nv">$filename</code><code class="p">)</code> <code class="p">;</code>
<code class="nb">fclose</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">);</code> <code class="c1">// close this handle</code>

<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="k">empty</code><code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'posted'</code><code class="p">]))</code> <code class="p">{</code>
 <code class="c1">// create file if first time and then</code>
 <code class="c1">//save text that is in $_POST['question1']</code>
 <code class="nv">$question1</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'question1'</code><code class="p">];</code>
 <code class="nv">$file_handle</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$filename</code><code class="p">,</code> <code class="s2">"w+"</code><code class="p">);</code>

 <code class="c1">// open file for total overwrite</code>
 <code class="k">if</code> <code class="p">(</code><code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_EX</code><code class="p">))</code> <code class="p">{</code>
 <code class="c1">// do an exclusive lock</code>
 <code class="k">if</code> <code class="p">(</code><code class="nb">fwrite</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nv">$question1</code><code class="p">)</code> <code class="o">==</code> <code class="k">FALSE</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Cannot write to file (</code><code class="si">$filename</code><code class="s2">)"</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="c1">// release the lock</code>
 <code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_UN</code><code class="p">);</code>
 <code class="p">}</code>

 <code class="c1">// close the file handle and redirect to next page ?</code>
 <code class="nb">fclose</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">);</code>
 <code class="nb">header</code><code class="p">(</code> <code class="s2">"Location: page2.php"</code> <code class="p">);</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="cp">?&gt;</code>
 <code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Files <code class="err">&amp;</code> folders - On-line Survey<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="nt">&lt;table</code> <code class="na">border=</code><code class="s">"0"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>Please enter your response to the following survey question:<code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
 <code class="nt">&lt;tr</code> <code class="na">bgcolor=</code><code class="s">lightblue</code><code class="nt">&gt;</code>
 <code class="nt">&lt;td&gt;</code>
 What is your opinion on the state of the world economy?<code class="nt">&lt;br/&gt;</code>
 Can you help us fix it ?
 <code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>
 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"</code><code class="cp">&lt;?php</code> <code class="k">echo</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'PHP_SELF'</code><code class="p">];</code> <code class="cp">?&gt;</code><code class="s">"</code> <code class="na">method=</code><code class="s">"POST"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"posted"</code> <code class="na">value=</code><code class="s">"1"</code><code class="nt">&gt;&lt;br/&gt;</code>
 <code class="nt">&lt;textarea</code> <code class="na">name=</code><code class="s">"question1"</code> <code class="na">rows=</code><code class="s">12</code> <code class="na">cols=</code><code class="s">35</code><code class="nt">&gt;</code><code class="cp">&lt;?</code><code class="o">=</code> <code class="nv">$comments</code> <code class="cp">?&gt;</code><code class="nt">&lt;/textarea&gt;</code>
 <code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>

 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"submit"</code> <code class="na">value=</code><code class="s">"Submit"</code><code class="nt">&gt;&lt;/form&gt;&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
 <code class="nt">&lt;/table&gt;</code>
<code class="cp">&lt;?php</code> <code class="p">}</code> <code class="cp">?&gt;</code></pre>
</div>
<p>Let’s highlight a few of the lines of code here, because this is where the file management and manipulation really takes place. After taking in the session information that we need and appending the filename to the <code>$filename</code> variable, we are ready to start working with the files. Keep in mind that the point of this process is to display any information that may already be saved in the file and allow users to enter information (or alter what they have already entered). So, near the top of the code you see this command:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$file_handle</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$filename</code><code class="p">,</code> <code class="s2">"a+"</code><code class="p">);</code></pre>
<p>Using the file opening function, <a contenteditable="false" data-type="indexterm" data-primary="fopen function" id="idm45922763446808"/><code>fopen()</code>, we ask PHP to provide us with a handle to that file and store it in the aptly named variable <code>$file_handle</code>. Notice that there is another parameter passed to the function here: the <code>a+</code> option. The <a href="http://php.net">PHP site</a> provides a full listing of these option letters and what they mean. The <code>a+</code> option causes the file to open for reading and writing, with the file pointer placed at the end of any existing file content. If the file does not exist, PHP will attempt to create it. Looking at the next two lines of code, you’ll see that the entire file is read (using the <a contenteditable="false" data-type="indexterm" data-primary="file_get_contents function" id="idm45922763443192"/><code>file_get_contents()</code> function) into the <code>$comments</code> variable, and then it is closed:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$comments</code> <code class="o">=</code> <code class="nb">file_get_contents</code><code class="p">(</code><code class="nv">$filename</code><code class="p">);</code>
<code class="nb">fclose</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">);</code></pre>
<p>Next, we want to see if the form portion of this program file has been executed and, if so, we have to save any information that was entered into the text area. This time, we open the same file again, but we use the <code>w+</code> option, which causes the interpreter to open the file for writing only—creating it if it doesn’t exist, or emptying it if it does. The file pointer is then placed at the beginning of the file. Essentially, we want to empty out the current contents of the file and replace it with a totally new volume of text. For this purpose, we employ the <a contenteditable="false" data-type="indexterm" data-primary="fwrite function" id="idm45922763430168"/><code>fwrite()</code> function:</p>
<pre data-type="programlisting" data-code-language="php"><code class="c1">// do an exclusive lock</code>
<code class="k">if</code> <code class="p">(</code><code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_EX</code><code class="p">))</code> <code class="p">{</code>
 <code class="k">if</code> <code class="p">(</code><code class="nb">fwrite</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nv">$question1</code><code class="p">)</code> <code class="o">==</code> <code class="k">FALSE</code><code class="p">){</code>
 <code class="k">echo</code> <code class="s2">"Cannot write to file (</code><code class="si">$filename</code><code class="s2">)"</code><code class="p">;</code>
 <code class="p">}</code>
 <code class="c1">// release the lock</code>
 <code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_UN</code><code class="p">);</code>
<code class="p">}</code></pre>
<p>We have to be sure that this information is indeed saved into the designated file, so we wrap a few conditional statements around our file-writing operations to make sure everything will go smoothly. First, we attempt to gain an exclusive lock on the file in question (using the <a contenteditable="false" data-type="indexterm" data-primary="flock function" id="idm45922762930376"/><code>flock()</code> function); this will ensure that no other process can access the file while we’re operating on it. After the writing is complete, we release the lock on the file. This is merely a precaution, since the file management is unique to the entered email address on the first web page form and each survey has its own folder location, so usage collisions should never occur unless two people happen to be using the same email address.</p>
<p>As you can see, the file write function uses the <code>$file_handle</code> variable to add the contents of the <code>$question1</code> variable to the file. Then we simply close the file when we are finished with it and move on to the next page of the survey, as shown in <a data-type="xref" href="#page_two_of_the_survey">Figure 9-3</a>.</p>
<figure><div id="page_two_of_the_survey" class="figure">
<img src="Images/php4_0903.png" alt="Page 2 of the survey" width="413" height="402"/>
<h6><span class="label">Figure 9-3. </span>Page 2 of the survey</h6>
</div></figure>
<p>As you can see in <a data-type="xref" href="#example_nine_sevendot_file_level_access">Example 9-7</a>, the code for processing this file (called <em>question2.txt</em>) is identical to the previous one except for its name.</p>
<div data-type="example" id="example_nine_sevendot_file_level_access">
<h5><span class="label">Example 9-7. </span>File-level access, continued</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="nb">session_start</code><code class="p">();</code>
<code class="nv">$folder</code> <code class="o">=</code> <code class="nv">$_SESSION</code><code class="p">[</code><code class="s1">'folder'</code><code class="p">];</code>
<code class="nv">$filename</code> <code class="o">=</code> <code class="nv">$folder</code> <code class="o">.</code> <code class="s2">"/question2.txt"</code> <code class="p">;</code>

<code class="c1">// open file for reading then clean it out</code>
<code class="nv">$file_handle</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$filename</code><code class="p">,</code> <code class="s2">"a+"</code><code class="p">);</code>

<code class="c1">// pick up any text in the file that may already be there</code>
<code class="nv">$comments</code> <code class="o">=</code> <code class="nb">fread</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nb">filesize</code><code class="p">(</code><code class="nv">$filename</code><code class="p">));</code>
<code class="nb">fclose</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">);</code> <code class="c1">// close this handle</code>

<code class="k">if</code> <code class="p">(</code><code class="nv">$_POST</code><code class="p">[</code><code class="s1">'posted'</code><code class="p">])</code> <code class="p">{</code>
 <code class="c1">// create file if first time and then save</code>
 <code class="c1">//text that is in $_POST['question2']</code>
 <code class="nv">$question2</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'question2'</code><code class="p">];</code>

 <code class="c1">// open file for total overwrite</code>
 <code class="nv">$file_handle</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="nv">$filename</code><code class="p">,</code> <code class="s2">"w+"</code><code class="p">);</code>

 <code class="k">if</code><code class="p">(</code><code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_EX</code><code class="p">))</code> <code class="p">{</code> <code class="c1">// do an exclusive lock</code>
 <code class="k">if</code><code class="p">(</code><code class="nb">fwrite</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nv">$question2</code><code class="p">)</code> <code class="o">==</code> <code class="k">FALSE</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">echo</code> <code class="s2">"Cannot write to file (</code><code class="si">$filename</code><code class="s2">)"</code><code class="p">;</code>
 <code class="p">}</code>

 <code class="nb">flock</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">,</code> <code class="nx">LOCK_UN</code><code class="p">);</code> <code class="c1">// release the lock</code>
 <code class="p">}</code>

 <code class="c1">// close the file handle and redirect to next page ?</code>
 <code class="nb">fclose</code><code class="p">(</code><code class="nv">$file_handle</code><code class="p">);</code>

 <code class="nb">header</code><code class="p">(</code> <code class="s2">"Location: last_page.php"</code> <code class="p">);</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code> <code class="cp">?&gt;</code>
 <code class="nt">&lt;html&gt;</code>
 <code class="nt">&lt;head&gt;</code>
 <code class="nt">&lt;title&gt;</code>Files <code class="err">&amp;</code> folders - On-line Survey<code class="nt">&lt;/title&gt;</code>
 <code class="nt">&lt;/head&gt;</code>

 <code class="nt">&lt;body&gt;</code>
 <code class="nt">&lt;table</code> <code class="na">border=</code><code class="s">"0"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>Please enter your comments to the following survey statement:<code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>

 <code class="nt">&lt;tr</code> <code class="na">bgcolor=</code><code class="s">"lightblue"</code><code class="nt">&gt;</code>
 <code class="nt">&lt;td&gt;</code>It's a funny thing freedom. I mean how can any of us <code class="nt">&lt;br/&gt;</code>
 be really free when we still have personal possessions.
 How do you respond to the previous statement?<code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>

 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;</code>
 <code class="nt">&lt;form</code> <code class="na">action=</code><code class="s">"</code><code class="cp">&lt;?php</code> <code class="k">echo</code> <code class="nv">$_SERVER</code><code class="p">[</code><code class="s1">'PHP_SELF'</code><code class="p">];</code> <code class="cp">?&gt;</code><code class="s">"</code> <code class="na">method=</code><code class="s">POST</code><code class="nt">&gt;</code>
 <code class="nt">&lt;input</code> <code class="na">type=</code><code class="s">"hidden"</code> <code class="na">name=</code><code class="s">"posted"</code> <code class="na">value=</code><code class="s">"1"</code><code class="nt">&gt;&lt;br/&gt;</code>
 <code class="nt">&lt;textarea</code> <code class="na">name=</code><code class="s">"question2"</code> <code class="na">rows=</code><code class="s">"12"</code> <code class="na">cols=</code><code class="s">"35"</code><code class="nt">&gt;</code><code class="cp">&lt;?</code><code class="o">=</code> <code class="nv">$comments</code> <code class="cp">?&gt;</code><code class="nt">&lt;/textarea&gt;</code>
 <code class="nt">&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>

 <code class="nt">&lt;tr&gt;</code>
 <code class="nt">&lt;td&gt;&lt;input</code> <code class="na">type=</code><code class="s">"submit"</code> <code class="na">name=</code><code class="s">"submit"</code> <code class="na">value=</code><code class="s">"Submit"</code><code class="nt">&gt;&lt;/form&gt;&lt;/td&gt;</code>
 <code class="nt">&lt;/tr&gt;</code>
<code class="nt">&lt;/table&gt;</code>
<code class="cp">&lt;?php</code> <code class="p">}</code> <code class="cp">?&gt;</code></pre>
</div>
<p>This kind of file processing can continue for as long as you like, and therefore your surveys can be as long as you like. To make it more interesting, you can ask multiple questions on the same page and simply give each question its own filename. The only unique item here to point out is that once this page is submitted and the text is stored, it is directed to a PHP file called <em>last_page.php</em>. This page is not included in the code samples, as it is merely a page thanking users for filling out the survey.</p>
<p>Of course, after a few pages, with as many as five questions per page, you may find yourself with a large volume of individual files needing management. Fortunately, PHP has other file-handling functions that you can use. The <a contenteditable="false" data-type="indexterm" data-primary="file function" id="idm45922763120232"/><code>file()</code> function, for example, is an alternative to the <a contenteditable="false" data-type="indexterm" data-primary="fread function" id="idm45922762820424"/><code>fread()</code> function that reads the entire contents of a file in an array, one element per line. If your information is formatted properly—with each line delimited by the end of line sequence, <code>\n</code>—you can store multiple pieces of information in a single file very easily. Naturally, this would also entail the use of the appropriate looping controls for handling the creation of the HTML form, as well as recording the entries into that form.</p>
<p>When it comes to file handling, there are still many more options that you can look at on the PHP website. If you go to <a data-type="xref" href="app01.xhtml#filesystem">“Filesystem”</a>, you will find a list of over 70 functions—including, of course, the ones discussed here. You can check to see if a file is either readable or writable with the <a contenteditable="false" data-type="indexterm" data-primary="is_readable function" id="idm45922762816312"/><code>is_readable()</code> or <a contenteditable="false" data-type="indexterm" data-primary="is_writable function" id="idm45922762814792"/><code>is_writable()</code> functions, respectively. You can check on file permissions, free disk space, or total disk space, and you can delete files, copy files, and much more. When you get right down to it, if you have enough time and desire, you can even write an entire web application without ever needing or using a database system.</p>
<p>When the day comes, and it most likely will, that you have a client who does not want to pay big bucks for the use of a database engine, you will have an alternative approach to offer them.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_file_manip" id="idm45922762812280"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_file_manip_alt_database" id="idm45922762810904"/></p>
</div></section>
<section data-type="sect1" data-pdf-bookmark="MongoDB"><div class="sect1" id="mongodb">
<h1>MongoDB</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="NoSQL databases (MongoDB)" id="ix_nosql_database"/><a contenteditable="false" data-type="indexterm" data-primary="MongoDB database" id="ix_mongodb_ch9"/><a contenteditable="false" data-type="indexterm" data-primary="databases" data-secondary="MongoDB" id="ix_databases_mongodb"/>The last database type that we will look at is a NoSQL database. NoSQL databases are rising in popularity because they are also quite lightweight in terms of system resources, but more importantly, they work outside the typical SQL command structure. NoSQL databases are also becoming more popular with mobile devices like tablets and smartphones for the same two reasons.</p>
<p>One of the frontrunners in the NoSQL database world is known as MongoDB. We’ll only be touching the surface of MongoDB here, just to give you a taste of what is possible with its use. <a contenteditable="false" data-type="indexterm" data-primary="MongoDB and PHP (O'Reilly)" id="idm45922762802456"/><a contenteditable="false" data-type="indexterm" data-primary="Francia, Steve (author)" data-secondary="MongoDB and PHP (O'Reilly)" id="idm45922762801336"/>For more detailed coverage of this topic, please refer to <a class="orm:hideurl" href="http://bit.ly/MongoDB_PHP"><em>MongoDB and PHP</em></a> (O’Reilly) by Steve Francia.</p>
<p>The first thing to get your head around with MongoDB is that it is not a traditional database. It has its own setup and terminology. Getting used to how to work with it will take some time for the traditional SQL database user. <a data-type="xref" href="#typical_mongodbsolidussql_equivalents">Table 9-3</a> attempts to draw some parallels with “standard” SQL terminology.</p>
<table class="border" id="typical_mongodbsolidussql_equivalents">
<caption><span class="label">Table 9-3. </span>Typical MongoDB/SQL equivalents</caption>
<thead>
<tr>
<th>Traditional SQL terms</th>
<th>MongoDB terms</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td>Database</td>
</tr>
<tr>
<td>Tables</td>
<td>Collections</td>
</tr>
<tr>
<td>Rows</td>
<td>Documents. No correlation, not like database “rows”; rather, think of arrays.</td>
</tr>
</tbody>
</table>
<p>There’s not an exact equivalent of a database row within the MongoDB paradigm. One of the best ways to think of the data within a collection is like that of a multidimensional array, as you’ll see shortly when we revamp our <code>library</code> database example.</p>
<p>If you just want to try MongoDB out on your own localhost (recommended for getting familiar with it), you can use an all-in-one tool like <a contenteditable="false" data-type="indexterm" data-primary="Zend Server CE" id="idm45922762787672"/><a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Zend Server CE" id="idm45922762786568"/><a href="http://zend.com">Zend Server CE</a> to set up a local environment with the Mongo drivers all installed. You’ll still have to download the server itself from the <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="MongoDB" id="idm45922762784360"/><a href="http://www.mongodb.org">MongoDB website</a> and follow the instructions for setting up the database server engine for your own local environment.</p>
<p>One very useful web-based tool for browsing MongoDB data and manipulating the collections and documents is <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="Genghis (for MongoDB)" id="idm45922762781640"/><a contenteditable="false" data-type="indexterm" data-primary="Genghis (for MongoDB)" id="idm45922762780264"/><a href="http://genghisapp.com">Genghis</a>. Simply download the project and drop it into its own folder in the localhost and call <em>genghis.php</em>. If the database engine is running, it will be picked up and displayed to you (see <a data-type="xref" href="#genghis_mongodb_web_interface_sample">Figure 9-4</a>).</p>
<figure><div id="genghis_mongodb_web_interface_sample" class="figure">
<img src="Images/php4_0904.png" alt="Genghis MongoDB web interface sample" width="885" height="393"/>
<h6><span class="label">Figure 9-4. </span>Genghis MongoDB web interface sample</h6>
</div></figure>
<p>Now let’s get into some sample code. Take a look at <a data-type="xref" href="#example_nine_eightdot_mongodb_library">Example 9-8</a> to see the beginnings of a Mongo database taking shape.</p>
<div class="pagebreak-before" data-type="example" id="example_nine_eightdot_mongodb_library">
<h5 class="less_space"><span class="label">Example 9-8. </span>MongoDB library</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mongo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Mongo</code><code class="p">();</code>
<code class="nv">$db</code> <code class="o">=</code> <code class="nv">$mongo</code><code class="o">-&gt;</code><code class="na">library</code><code class="p">;</code>
<code class="nv">$authors</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">authors</code><code class="p">;</code>

<code class="nv">$author</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code><code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"J.R.R. Tolkien"</code><code class="p">);</code>
<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">insert</code><code class="p">(</code><code class="nv">$author</code><code class="p">);</code>

<code class="nv">$author</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code><code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"Alex Haley"</code><code class="p">);</code>
<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">insert</code><code class="p">(</code><code class="nv">$author</code><code class="p">);</code>

<code class="nv">$author</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code><code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">3</code><code class="p">,</code> <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"Tom Clancy"</code><code class="p">);</code>
<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">(</code><code class="nv">$author</code><code class="p">);</code>

<code class="nv">$author</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code><code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">4</code><code class="p">,</code> <code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"Isaac Asimov"</code><code class="p">);</code>
<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">save</code><code class="p">(</code><code class="nv">$author</code><code class="p">);</code></pre>
</div>
<p>The first line creates a new connection to the MongoDB engine, and creates an object interface to it as well. The next line connects to the <code>library</code> “collection”; if this collection does not exist, Mongo creates it for you (so there is no need to precreate a collection in Mongo). We then create an object interface with the <code>$db</code> connection to the <code>library</code> database and create a collection where we will store our author data. The next four groupings of code add documents to the <code>authors</code> collection in two different ways. The first two samples use the <a contenteditable="false" data-type="indexterm" data-primary="insert method, database" id="idm45922762434728"/><code>insert()</code> method, and the last two use the <a contenteditable="false" data-type="indexterm" data-primary="save method" id="idm45922762433320"/><code>save()</code> method. The only difference between these two methods is that <code>save()</code> will update a value if it is already in the document and has an existing <code>_id</code> key (more on <code>_id</code> shortly).</p>
<p>Execute this code within a browser, and you should see the sample data shown in <a data-type="xref" href="#sample_mongo_document_data_for_authors">Figure 9-5</a>. As you can see, an entity called <code>_id</code> is created with the inserted data. This is the automatic primary key that is assigned to all created collections. If we wanted to depend on that key—and there is no reason why we shouldn’t (other than its obvious complexity)—we wouldn’t have had to add in our own <code>authorid</code> information in the preceding code.</p>

<figure><div id="sample_mongo_document_data_for_authors" class="figure">
<img src="Images/php4_0905.png" alt="Sample Mongo document data for authors" width="386" height="823"/>
<h6><span class="label">Figure 9-5. </span>Sample Mongo document data for authors</h6>
</div></figure>

<section class="pagebreak-before" data-type="sect2" data-pdf-bookmark="Retrieving Data"><div class="sect2" id="retrieving_data">
<h2 class="less_space">Retrieving Data</h2>
<p>Once the data is stored, we can now start looking at ways in which to access it. <a data-type="xref" href="#example_nine_ninedot_mongodb_data_selec">Example 9-9</a> shows one option.</p>
<div data-type="example" id="example_nine_ninedot_mongodb_data_selec">
<h5><span class="label">Example 9-9. </span>MongoDB data selection example</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mongo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Mongo</code><code class="p">();</code>
<code class="nv">$db</code> <code class="o">=</code> <code class="nv">$mongo</code><code class="o">-&gt;</code><code class="na">library</code><code class="p">;</code>
<code class="nv">$authors</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">authors</code><code class="p">;</code>

<code class="nv">$data</code> <code class="o">=</code> <code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">findone</code><code class="p">(</code><code class="k">array</code><code class="p">(</code><code class="s1">'authorid'</code> <code class="o">=&gt;</code> <code class="mi">4</code><code class="p">));</code>

<code class="k">echo</code> <code class="s2">"Generated Primary Key: </code><code class="si">{</code><code class="nv">$data</code><code class="p">[</code><code class="s1">'_id'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"Author name: </code><code class="si">{</code><code class="nv">$data</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code></pre>
</div>
<p>The first three lines of code are the same as before, since we still want to connect to the same database and make use of the same collection (<code>library</code>) and document (<code>authors</code>). After that, we use the <a contenteditable="false" data-type="indexterm" data-primary="findone method, database" id="idm45922762687192"/><code>findone()</code> method, passing it an array containing a unique piece of data that can be used to find the information that we want—in this case, the <code>authorid</code> for Isaac Asimov, <code>4</code>. We store the returned information into an array called <code>$data</code>.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>As a good oversimplification, you can think of information within a Mongo document as array-based.</p>
</div>
<p>Then we can use that array as we wish to display the returned data from the document. The following is the resulting output from the previous code. Notice the size of the primary key that Mongo has created.</p>
<pre data-type="programlisting"><strong>Generated Primary Key: 4ff43ef45b9e7d300c000007</strong>
<strong>Author name: Isaac Asimov</strong></pre>
</div></section>
<section class="pagebreak-before" data-type="sect2" data-pdf-bookmark="Inserting More Complex Data"><div class="sect2" id="inserting_more_complex_data">
<h2 class="less_space">Inserting More Complex Data</h2>
<p>Next we want to continue our <code>library</code> example database by adding some books to the document in relation to a particular author. Here is where the analogy of different tables within a database can collapse. Consider <a data-type="xref" href="#example_nine_onezerodot_mongodb_simple">Example 9-10</a>, which adds four books to the <code>authors</code> document, essentially as a multidimensional array.</p>
<div data-type="example" id="example_nine_onezerodot_mongodb_simple">
<h5><span class="label">Example 9-10. </span>MongoDB simple data update/insert</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mongo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Mongo</code><code class="p">();</code>
<code class="nv">$db</code> <code class="o">=</code> <code class="nv">$mongo</code><code class="o">-&gt;</code><code class="na">library</code><code class="p">;</code>
<code class="nv">$authors</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">authors</code><code class="p">;</code>

<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">(</code>
 <code class="k">array</code><code class="p">(</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"Isaac Asimov"</code><code class="p">),</code>
 <code class="k">array</code><code class="p">(</code><code class="s1">'$set'</code> <code class="o">=&gt;</code>
 <code class="k">array</code><code class="p">(</code><code class="s1">'books'</code> <code class="o">=&gt;</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s2">"0-425-17034-9"</code> <code class="o">=&gt;</code> <code class="s2">"Foundation"</code><code class="p">,</code>
 <code class="s2">"0-261-10236-2"</code> <code class="o">=&gt;</code> <code class="s2">"I, Robot"</code><code class="p">,</code>
 <code class="s2">"0-440-17464-3"</code> <code class="o">=&gt;</code> <code class="s2">"Second Foundation"</code><code class="p">,</code>
 <code class="s2">"0-425-13354-0"</code> <code class="o">=&gt;</code> <code class="s2">"Pebble In The Sky"</code><code class="p">,</code>
 <code class="p">)</code>
 <code class="p">)</code>
 <code class="p">)</code>
<code class="p">);</code></pre>
</div>
<p>Here, after making the needed connections, we use the <a contenteditable="false" data-type="indexterm" data-primary="update method, database" id="idm45922762554536"/><code>update()</code> method and use the first element of the array (the first parameter of the <code>update()</code> method) as the unique lookup identifier, and a defined operator called <code>$set</code> as the second parameter to attach the book data to the provided key of the first parameter.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You should research and fully understand the special operators <code>$set</code> and <code>$push</code> (not covered here) before using them in a production environment. <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="MongoDB" id="idm45922762654296"/>See the <a href="http://bit.ly/12YY646">MongoDB documentation</a> for more information and a full listing of these <span class="keep-together">operators.</span></p>
</div>
<p><a data-type="xref" href="#example_nine_oneonedot_mongodb_data_upd">Example 9-11</a> provides another approach to accomplishing the same goal, except that we are preparing the array to be inserted and attached ahead of time and using the Mongo-created <code>_id</code> as the location key.</p>
<div class="pagebreak-before" data-type="example" id="example_nine_oneonedot_mongodb_data_upd">
<h5 class="less_space"><span class="label">Example 9-11. </span>MongoDB data update/insert</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mongo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Mongo</code><code class="p">();</code>
<code class="nv">$db</code> <code class="o">=</code> <code class="nv">$mongo</code><code class="o">-&gt;</code><code class="na">library</code><code class="p">;</code>
<code class="nv">$authors</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">authors</code><code class="p">;</code>

<code class="nv">$data</code> <code class="o">=</code> <code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">findone</code><code class="p">(</code><code class="k">array</code><code class="p">(</code><code class="s1">'name'</code> <code class="o">=&gt;</code> <code class="s2">"Isaac Asimov"</code><code class="p">));</code>

<code class="nv">$bookData</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s2">"ISBN"</code> <code class="o">=&gt;</code> <code class="s2">"0-553-29337-0"</code><code class="p">,</code>
 <code class="s2">"title"</code> <code class="o">=&gt;</code> <code class="s2">"Foundation"</code><code class="p">,</code>
 <code class="s2">"pub_year"</code> <code class="o">=&gt;</code> <code class="mi">1951</code><code class="p">,</code>
 <code class="s2">"available"</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code>
 <code class="p">),</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s2">"ISBN"</code> <code class="o">=&gt;</code> <code class="s2">"0-553-29438-5"</code><code class="p">,</code>
 <code class="s2">"title"</code> <code class="o">=&gt;</code> <code class="s2">"I, Robot"</code><code class="p">,</code>
 <code class="s2">"pub_year"</code> <code class="o">=&gt;</code> <code class="mi">1950</code><code class="p">,</code>
 <code class="s2">"available"</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code>
 <code class="p">),</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s2">"ISBN"</code> <code class="o">=&gt;</code> <code class="s2">"0-517-546671"</code><code class="p">,</code>
 <code class="s2">"title"</code> <code class="o">=&gt;</code> <code class="s2">"Exploring the Earth and the Cosmos"</code><code class="p">,</code>
 <code class="s2">"pub_year"</code> <code class="o">=&gt;</code> <code class="mi">1982</code><code class="p">,</code>
 <code class="s2">"available"</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code>
 <code class="p">),</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s2">"ISBN' =&gt; "</code><code class="mi">0</code><code class="o">-</code><code class="mi">553</code><code class="o">-</code><code class="mi">29336</code><code class="o">-</code><code class="mi">2</code><code class="s2">",</code>
<code class="s2"> 'title"</code> <code class="o">=&gt;</code> <code class="s2">"Second Foundation"</code><code class="p">,</code>
 <code class="s2">"pub_year"</code> <code class="o">=&gt;</code> <code class="mi">1953</code><code class="p">,</code>
 <code class="s2">"available"</code> <code class="o">=&gt;</code> <code class="mi">1</code><code class="p">,</code>
 <code class="p">),</code>
<code class="p">);</code>

<code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">update</code><code class="p">(</code>
 <code class="k">array</code><code class="p">(</code><code class="s2">"_id"</code> <code class="o">=&gt;</code> <code class="nv">$data</code><code class="p">[</code><code class="s2">"_id"</code><code class="p">]),</code>
 <code class="k">array</code><code class="p">(</code><code class="s2">"</code><code class="si">$set</code><code class="s2">"</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="s2">"books"</code> <code class="o">=&gt;</code> <code class="nv">$bookData</code><code class="p">))</code>
<code class="p">);</code></pre>
</div>
<p>In both of our two previous code examples, we did not add any keys to the array of book data. We could do this, but it’s just as easy to allow Mongo to manage that data as if it were a multidimensional array. <a data-type="xref" href="#book_data_added_to_an_author">Figure 9-6</a> shows how the data from <a data-type="xref" href="#example_nine_oneonedot_mongodb_data_upd">Example 9-11</a> will look when it is displayed in Genghis.</p>
<figure><div id="book_data_added_to_an_author" class="figure">
<img src="Images/php4_0906.png" alt="Book data added to an author" width="416" height="691"/>
<h6><span class="label">Figure 9-6. </span>Book data added to an author</h6>
</div></figure>
<p><a data-type="xref" href="#example_nine_onetwodot_mongodb_data_fin">Example 9-12</a> shows a little more of what data is stored in our Mongo database. It adds just a few more lines of code to <a data-type="xref" href="#example_nine_ninedot_mongodb_data_selec">Example 9-9</a>; here we are referencing the automatic natural keys generated in the previous code that inserted the book detail <span class="keep-together">information.</span></p>
<div data-type="example" id="example_nine_onetwodot_mongodb_data_fin">
<h5><span class="label">Example 9-12. </span>MongoDB data find and display</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$mongo</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Mongo</code><code class="p">();</code>
<code class="nv">$db</code> <code class="o">=</code> <code class="nv">$mongo</code><code class="o">-&gt;</code><code class="na">library</code><code class="p">;</code>
<code class="nv">$authors</code> <code class="o">=</code> <code class="nv">$db</code><code class="o">-&gt;</code><code class="na">authors</code><code class="p">;</code>

<code class="nv">$data</code> <code class="o">=</code> <code class="nv">$authors</code><code class="o">-&gt;</code><code class="na">findone</code><code class="p">(</code><code class="k">array</code><code class="p">(</code><code class="s2">"authorid"</code> <code class="o">=&gt;</code> <code class="mi">4</code><code class="p">));</code>

<code class="k">echo</code> <code class="s2">"Generated Primary Key: </code><code class="si">{</code><code class="nv">$data</code><code class="p">[</code><code class="s1">'_id'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"Author name: </code><code class="si">{</code><code class="nv">$data</code><code class="p">[</code><code class="s1">'name'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"2nd Book info - ISBN: </code><code class="si">{</code><code class="nv">$data</code><code class="p">[</code><code class="s1">'books'</code><code class="p">][</code><code class="mi">1</code><code class="p">][</code><code class="s1">'ISBN'</code><code class="p">]</code><code class="si">}</code><code class="s2">&lt;br /&gt;"</code><code class="p">;</code>
<code class="k">echo</code> <code class="s2">"2nd Book info - Title: {$data['books'][1]['title']&lt;br /&gt;"</code><code class="p">;</code></pre>
</div>
<p>The generated output of the preceding code looks like this (remember that arrays are zero-based):</p>
<pre data-type="programlisting"><strong>Generated Primary Key: 4ff43ef45b9e7d300c000007</strong>
<strong>Author name: Isaac Asimov</strong>
<strong>2nd Book info - ISBN: 0-553-29438-5</strong>
<strong>2nd Book info - Title: I, Robot</strong></pre>
<p>For more information on how MongoDB can be used and manipulated within PHP, see the documentation on the <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="MongoDB" id="idm45922761863352"/><a href="https://oreil.ly/GB6iV">PHP website</a>.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_ch9" id="idm45922761861288"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_databases_mongodb" id="idm45922761859880"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_mongodb_ch9" id="idm45922761858504"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_nosql_database" id="idm45922761857128"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What’s Next"><div class="sect1" id="whatapostrophes_next-id00067">
<h1>What’s Next</h1>
<p>In the next chapter, we’ll explore various techniques for including graphics media within pages generated by PHP, as well as dynamically generating and manipulating graphics on your web server.</p>
</div></section>
</div></section></div>



  </body></html>