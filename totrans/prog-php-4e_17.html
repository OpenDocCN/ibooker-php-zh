<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 16. Web Services"><div class="chapter" id="web_services">
<h1><span class="label">Chapter 16. </span>Web Services</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="web services" id="ix_web_services_ch16"/>Historically, every time there’s been a need for two systems to communicate, a new protocol has been created (for example, SMTP for sending mail, POP3 for receiving mail, and the numerous protocols that database clients and servers use). The idea of web services is to remove the need to create new protocols by providing a standardized mechanism for remote procedure calls, based on XML and HTTP.</p>
<p>Web services make it easy to integrate heterogeneous systems. Say you’re writing a web interface to a library system that already exists. It has a complex system of database tables, and lots of business logic embedded in the program code that manipulates those tables. And it’s written in C++. You could reimplement the business logic in PHP, writing a lot of code to manipulate tables in the correct way, or you could write a little code in C++ to expose the library operations (e.g., check out a book to a user, see when this book is due back, see what the overdue fines are for this user) as a web service. Now your PHP code simply has to handle the web frontend; it can use the library service to do all the heavy lifting.</p>
<section data-type="sect1" data-pdf-bookmark="REST Clients"><div class="sect1" id="rest_clients">
<h1>REST Clients</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" id="ix_RESTful_web_services"/><a contenteditable="false" data-type="indexterm" data-primary="web services" data-secondary="RESTful" id="ix_web_services_RESTful"/>A <em>RESTful web service</em> is a loose description of web APIs implemented using HTTP and the principles of Representational State Transfer (REST). It refers to a collection of resources, along with basic operations a client can perform on those resources through the API.</p>
<p>For example, an API might describe a collection of authors and the books to which those authors have contributed. The data within each object type is arbitrary. In this case, a <em>resource</em> is each individual author, each individual book, and the collections of all authors, all books, and the books to which each author has contributed. Each resource must have a unique identifier so calls into the API know what resource is being retrieved or acted upon.</p>
<p>You might represent a simple set of classes to represent the book and author resources, as in <a data-type="xref" href="#example_onesix_onedot_book_and_author_c">Example 16-1</a>.</p>
<div data-type="example" id="example_onesix_onedot_book_and_author_c">
<h5><span class="label">Example 16-1. </span>Book and Author classes</h5>
<pre data-type="programlisting" data-code-language="php"><code class="k">class</code> <code class="nc">Book</code> <code class="p">{</code>
 <code class="k">public</code> <code class="nv">$id</code><code class="p">;</code>
 <code class="k">public</code> <code class="nv">$name</code><code class="p">;</code>
 <code class="k">public</code> <code class="nv">$edition</code><code class="p">;</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf-Magic">__construct</code><code class="p">(</code><code class="nv">$id</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">=</code> <code class="nv">$id</code><code class="p">;</code>
 <code class="p">}</code>
<code class="p">}</code>

<code class="k">class</code> <code class="nc">Author</code> <code class="p">{</code>
 <code class="k">public</code> <code class="nv">$id</code><code class="p">;</code>
 <code class="k">public</code> <code class="nv">$name</code><code class="p">;</code>
 <code class="k">public</code> <code class="nv">$books</code> <code class="o">=</code> <code class="k">array</code><code class="p">();</code>

 <code class="k">public</code> <code class="k">function</code> <code class="nf-Magic">__construct</code><code class="p">(</code><code class="nv">$id</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$this</code><code class="o">-&gt;</code><code class="na">id</code> <code class="o">=</code> <code class="nv">$id</code><code class="p">;</code>
 <code class="p">}</code>
<code class="p">}</code></pre>
</div>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="verbs for" id="idm45922746820872"/>Because HTTP was built with the REST architecture in mind, it provides a set of <em>verbs</em> that you use to interact with the API. We’ve already seen <code>GET</code> and <code>POST</code> verbs, which websites often use to represent “retrieve data” and “perform an action,” respectively. RESTful web services introduce two additional verbs, <code>PUT</code> and <code>DELETE</code>:</p>
<dl>
<dt><code>GET</code></dt>
<dd><a contenteditable="false" data-type="indexterm" data-primary="GET verb, REST" id="idm45922746793944"/>Retrieve information about a resource or collection of resources.</dd>
<dt><code>POST</code></dt>
<dd><a contenteditable="false" data-type="indexterm" data-primary="POST verb, REST" id="idm45922746791848"/>Create a new resource.</dd>
<dt><code>PUT</code></dt>
<dd><a contenteditable="false" data-type="indexterm" data-primary="PUT verb, REST" id="idm45922746789720"/>Update a resource with new data, or replace a collection of resources with new ones.</dd>
<dt><code>DELETE</code></dt>
<dd><a contenteditable="false" data-type="indexterm" data-primary="DELETE verb, REST" id="idm45922746787624"/>Delete a resource or a collection of resources.</dd>
</dl>
<p>For example, the <code>Books</code> and <code>Authors</code> API might consist of the following REST endpoints, based on the data contained within the object classes:</p>
<dl>
<dt><code>GET /api/authors</code></dt>
<dd>Return a list of identifiers for each author in the collection.</dd>
<dt><code>POST /api/authors</code></dt>
<dd>Given information about a new author, create a new author in the collection.</dd>
<dt><code>GET /api/authors/</code><em><code>id</code></em></dt>
<dd>Retrieve the author with identifier <em><code>id</code></em> from the collection and return it.</dd>
<dt><code>PUT /api/authors/</code><em><code>id</code></em></dt>
<dd>Given updated information about an author with identifier <em><code>id</code></em>, update that author’s information in the collection.</dd>
<dt><code>DELETE /api/authors/</code><em><code>id</code></em></dt>
<dd>Delete the author with identifier <em><code>id</code></em> from the collection.</dd>
<dt><code>GET /api/authors/</code><em><code>id</code></em><code>/books</code></dt>
<dd>Retrieve a list of identifiers for each book to which the author with identifier <em><code>id</code></em> has contributed.</dd>
<dt><code>POST /api/authors/</code><em><code>id</code></em><code>/books</code></dt>
<dd>Given information about a new book, create a new book in the collection under the author with identifier <em><code>id</code></em>.</dd>
<dt><code>GET /api/books/</code><em><code>id</code></em></dt>
<dd>Retrieve the book with identifier <em><code>id</code></em> from the collection and return it.</dd>
</dl>
<p>The <code>GET</code>, <code>POST</code>, <code>PUT</code>, and <code>DELETE</code> verbs provided by RESTful web services can be thought of as roughly equivalent to the <em>create</em>, <em>retrieve</em>, <em>update</em>, and <em>delete</em> (CRUD) operations typical to a database, although they can correlate to collections, not just entities as is typical with CRUD implementations.</p>
<section data-type="sect2" data-pdf-bookmark="Responses"><div class="sect2" id="responses">
<h2>Responses</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="responses from" id="idm45922746763816"/>In each of the preceding API endpoints, <a contenteditable="false" data-type="indexterm" data-primary="HTTP (HyperText Transfer Protocol)" data-secondary="status codes for" id="idm45922746762312"/>the HTTP status code is used to provide the result of the request. HTTP provides a long list of standard status codes: for example, <code>201 Created</code> would be returned when you create a resource, and <code>501 Not Implemented</code> would be returned when you send a request to an endpoint that doesn’t exist.</p>
<p>While the full list of HTTP codes is beyond the scope of this chapter, some common ones include:</p>
<dl>
<dt><code>200 OK</code></dt>
<dd>The request was successfully completed.</dd>
<dt><code>201 Created</code></dt>
<dd>A request for creating a new resource was completed successfully.</dd>
<dt><code>400 Bad Request</code></dt>
<dd>The request hit a valid endpoint, but was malformed and could not be <span class="keep-together">completed.</span></dd>
<dt><code>401 Unauthorized</code></dt>
<dd>Along with <code>403 Forbidden</code>, represents a valid request, but one that could not be completed due to a lack of permissions. Typically, this response indicates that authorization is required but has not yet been provided.</dd>
<dt><code>403 Forbidden</code></dt>
<dd>Similar to <code>401 Unauthorized</code>, this response indicates a valid request, but one that could not be completed due to a lack of permissions. Typically, this response indicates that authorization was available but that the user lacks permission to perform the requested action.</dd>
<dt><code>404 Not Found</code></dt>
<dd>The resource was not found (for example, attempting to delete an author with an ID that does not exist).</dd>
<dt><code>500 Internal Server Error</code></dt>
<dd>An error occurred on the server side.</dd>
</dl>
<p>These codes are mere guidelines and typical responses; the exact responses provided by a RESTful API are detailed by the API itself.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Retrieving Resources"><div class="sect2" id="retrieving_resources">
<h2>Retrieving Resources</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="resources" data-tertiary="retrieving" id="idm45922746747224"/>Retrieving information for a resource involves a straightforward <a contenteditable="false" data-type="indexterm" data-primary="GET verb, REST" id="idm45922746745448"/><code>GET</code> request. <a data-type="xref" href="#example_onesix_twodot_retrieving_author">Example 16-2</a> uses the <a contenteditable="false" data-type="indexterm" data-primary="curl extension" id="ix_curl_extension_REST"/><em>curl</em> extension to format an HTTP request, set parameters on it, send the request, and get the returned information.</p>
<div data-type="example" id="example_onesix_twodot_retrieving_author">
<h5><span class="label">Example 16-2. </span>Retrieving author data</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$authorID</code> <code class="o">=</code> <code class="s2">"ktatroe"</code><code class="p">;</code>
<code class="nv">$url</code> <code class="o">=</code> <code class="s2">"http://example.com/api/authors/</code><code class="si">{</code><code class="nv">$authorID</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

<code class="nv">$ch</code> <code class="o">=</code> <code class="nb">curl_init</code><code class="p">();</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_URL</code><code class="p">,</code> <code class="nv">$url</code><code class="p">);</code>

<code class="nv">$response</code> <code class="o">=</code> <code class="nb">curl_exec</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>
<code class="nv">$resultInfo</code> <code class="o">=</code> <code class="nb">curl_getinfo</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>

<code class="nb">curl_close</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>

<code class="c1">// decode the JSON and use a Factory to instantiate an Author object</code>
<code class="nv">$authorJSON</code> <code class="o">=</code> <code class="nb">json_decode</code><code class="p">(</code><code class="nv">$response</code><code class="p">);</code>
<code class="nv">$author</code> <code class="o">=</code> <code class="nx">ResourceFactory</code><code class="o">::</code><code class="na">authorFromJSON</code><code class="p">(</code><code class="nv">$authorJSON</code><code class="p">);</code></pre>
</div>
<p>To retrieve information about an author, this script first constructs a URL representing the endpoint for the resource. Then, it initializes a curl resource and provides the constructed URL to it. Finally, the curl object is executed, which sends the HTTP request, waits for the response, and returns it.</p>
<p>In this case, the response is JSON data, which is decoded and handed off to a <code>Factory</code> method of <code>Author</code> to construct an instance of the <code>Author</code> class.</p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Updating Resources"><div class="sect2" id="updating_resources">
<h2>Updating Resources</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="resources" data-tertiary="updating" id="idm45922746675032"/>Updating an existing resource is a bit trickier than retrieving information about a resource. In this case, you need to use the <a contenteditable="false" data-type="indexterm" data-primary="PUT verb, REST" id="idm45922746673112"/><code>PUT</code> verb. As <code>PUT</code> was originally intended to handle file uploads, <code>PUT</code> requests require that you stream data to the remote service from a file.</p>
<p>Rather than creating a file on disk and streaming from it, the script in <a data-type="xref" href="#example_onesix_threedot_updating_book_d">Example 16-3</a> uses the <code>'memory'</code> stream provided by PHP, first filling it with the data to send, then rewinding it to the start of the data it just wrote, and finally pointing the curl object at the file.</p>
<div data-type="example" id="example_onesix_threedot_updating_book_d">
<h5><span class="label">Example 16-3. </span>Updating book data</h5>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$bookID</code> <code class="o">=</code> <code class="s2">"ProgrammingPHP"</code><code class="p">;</code>
<code class="nv">$url</code> <code class="o">=</code> <code class="s2">"http://example.com/api/books/</code><code class="si">{</code><code class="nv">$bookID</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

<code class="nv">$data</code> <code class="o">=</code> <code class="nb">json_encode</code><code class="p">(</code><code class="k">array</code><code class="p">(</code>
 <code class="s1">'edition'</code> <code class="o">=&gt;</code> <code class="mi">4</code><code class="p">,</code>
<code class="p">));</code>

<code class="nv">$requestData</code> <code class="o">=</code> <code class="nb">http_build_query</code><code class="p">(</code><code class="nv">$data</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">'&amp;'</code><code class="p">);</code>

<code class="nv">$ch</code> <code class="o">=</code> <code class="nb">curl_init</code><code class="p">();</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_URL</code><code class="p">,</code> <code class="nv">$url</code><code class="p">);</code>

<code class="nv">$fh</code> <code class="o">=</code> <code class="nb">fopen</code><code class="p">(</code><code class="s2">"php://memory"</code><code class="p">,</code> <code class="s1">'rw'</code><code class="p">);</code>
<code class="nb">fwrite</code><code class="p">(</code><code class="nv">$fh</code><code class="p">,</code> <code class="nv">$requestData</code><code class="p">);</code>
<code class="nb">rewind</code><code class="p">(</code><code class="nv">$fh</code><code class="p">);</code>

<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_INFILE</code><code class="p">,</code> <code class="nv">$fh</code><code class="p">);</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_INFILESIZE</code><code class="p">,</code> <code class="nb">mb_strlen</code><code class="p">(</code><code class="nv">$requestData</code><code class="p">));</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_PUT</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>

<code class="nv">$response</code> <code class="o">=</code> <code class="nb">curl_exec</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>
<code class="nv">$resultInfo</code> <code class="o">=</code> <code class="nb">curl_getinfo</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>

<code class="nb">curl_close</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>
<code class="nb">fclose</code><code class="p">(</code><code class="nv">$fh</code><code class="p">);</code></pre>
</div>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Creating Resources"><div class="sect2" id="creating_resources">
<h2>Creating Resources</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="resources" data-tertiary="creating" id="idm45922746480808"/>To create a new resource, call the appropriate endpoint with the <a contenteditable="false" data-type="indexterm" data-primary="POST verb, REST" id="idm45922746479032"/><code>POST</code> verb. The data for the request is put into the typical key-value form for <code>POST</code> requests.</p>
<p>In <a data-type="xref" href="#example_onesix_fourdot_creating_an_auth">Example 16-4</a>, the <code>Author</code> API endpoint for creating a new author takes the information to create the new author as a JSON-formatted object under the key <code>'data'</code>.</p>
<div data-type="example" id="example_onesix_fourdot_creating_an_auth">
<h5><span class="label">Example 16-4. </span>Creating an author</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code> <code class="nv">$newAuthor</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Author</code><code class="p">(</code><code class="s1">'pbmacintyre'</code><code class="p">);</code>
<code class="nv">$newAuthor</code><code class="o">-&gt;</code><code class="na">name</code> <code class="o">=</code> <code class="s2">"Peter Macintyre"</code><code class="p">;</code>

<code class="nv">$url</code> <code class="o">=</code> <code class="s2">"http://example.com/api/authors"</code><code class="p">;</code>

<code class="nv">$data</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'data'</code> <code class="o">=&gt;</code> <code class="nb">json_encode</code><code class="p">(</code><code class="nv">$newAuthor</code><code class="p">)</code>
<code class="p">);</code>

<code class="nv">$requestData</code> <code class="o">=</code> <code class="nb">http_build_query</code><code class="p">(</code><code class="nv">$data</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">'&amp;'</code><code class="p">);</code>

<code class="nv">$ch</code> <code class="o">=</code> <code class="nb">curl_init</code><code class="p">();</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_URL</code><code class="p">,</code> <code class="nv">$url</code><code class="p">);</code>

<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_POSTFIELDS</code><code class="p">,</code> <code class="nv">$requestData</code><code class="p">);</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_POST</code><code class="p">,</code> <code class="k">true</code><code class="p">);</code>

<code class="nv">$response</code> <code class="o">=</code> <code class="nb">curl_exec</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>
<code class="nv">$resultInfo</code> <code class="o">=</code> <code class="nb">curl_getinfo</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>

<code class="nb">curl_close</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code></pre>
</div>
<p>This script first constructs a new <code>Author</code> instance and encodes its values as a JSON-formatted string. Then, it constructs the key-value data in the appropriate format, provides that data to the curl object, and sends the request.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_web_services_RESTful" id="idm45922746470872"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_RESTful_web_services" id="idm45922746190568"/></p>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Deleting Resources"><div class="sect2" id="deleting_resources">
<h2>Deleting Resources</h2>
<p><a contenteditable="false" data-type="indexterm" data-primary="RESTful web service" data-secondary="resources" data-tertiary="deleting" id="idm45922746187592"/>Deleting a resource is similarly straightforward. <a data-type="xref" href="#example_onesix_fivedot_deleting_a_book">Example 16-5</a> creates a request, sets the verb on that request to <a contenteditable="false" data-type="indexterm" data-primary="DELETE verb, REST" id="idm45922746184536"/><code>'DELETE'</code> via the <a contenteditable="false" data-type="indexterm" data-primary="curl_setopt function" id="idm45922746183048"/><code>curl_setopt()</code> function, and sends it.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_curl_extension_REST" id="idm45922746181496"/></p>
<div data-type="example" id="example_onesix_fivedot_deleting_a_book">
<h5><span class="label">Example 16-5. </span>Deleting a book</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code> <code class="nv">$authorID</code> <code class="o">=</code> <code class="s2">"ktatroe"</code><code class="p">;</code>
<code class="nv">$bookID</code> <code class="o">=</code> <code class="s2">"ProgrammingPHP"</code><code class="p">;</code>
<code class="nv">$url</code> <code class="o">=</code> <code class="s2">"http://example.com/api/authors/</code><code class="si">{</code><code class="nv">$authorID</code><code class="si">}</code><code class="s2">/books/</code><code class="si">{</code><code class="nv">$bookID</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code>

<code class="nv">$ch</code> <code class="o">=</code> <code class="nb">curl_init</code><code class="p">();</code>
<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_URL</code><code class="p">,</code> <code class="nv">$url</code><code class="p">);</code>

<code class="nb">curl_setopt</code><code class="p">(</code><code class="nv">$ch</code><code class="p">,</code> <code class="nx">CURLOPT_CUSTOMREQUEST</code><code class="p">,</code> <code class="s1">'DELETE'</code><code class="p">);</code>

<code class="nv">$result</code> <code class="o">=</code> <code class="nb">curl_exec</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>
<code class="nv">$resultInfo</code> <code class="o">=</code> <code class="nb">curl_getinfo</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code>

<code class="nb">curl_close</code><code class="p">(</code><code class="nv">$ch</code><code class="p">);</code></pre>
</div>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="XML-RPC"><div class="sect1" id="xml_rpc">
<h1>XML-RPC</h1>
<p><a contenteditable="false" data-type="indexterm" data-primary="XML-RPC" id="ix_xml-rpc_web_services"/><a contenteditable="false" data-type="indexterm" data-primary="web services" data-secondary="XML-RPC" id="ix_web_services_xml-rpc"/>While less popular nowadays than REST, XML-RPC and <a contenteditable="false" data-type="indexterm" data-primary="web services" data-secondary="SOAP" id="idm45922746151784"/><a contenteditable="false" data-type="indexterm" data-primary="SOAP" id="idm45922746150408"/>SOAP are two older standard protocols used to create web services. XML-RPC is the older and simpler of the two, while SOAP is newer and more complex.</p>
<p>PHP provides access to both SOAP and XML-RPC through the <a contenteditable="false" data-type="indexterm" data-primary="xmlrpc extension" id="idm45922746084344"/><em>xmlrpc</em> extension, which is based on the <a href="http://xmlrpc-epi.sourceforge.net">xmlrpc-epi project</a>. The <em>xmlrpc</em> extension is not compiled in by default, so you’ll need to add <code>--with-xmlrpc</code> to your <code>configure</code> line when you compile PHP.</p>
<section data-type="sect2" data-pdf-bookmark="Servers"><div class="sect2" id="servers">
<h2>Servers</h2>
<p><a data-type="xref" href="#example_onesix_sixdot_multiplier_xml_rp">Example 16-6</a> shows a very basic XML-RPC server that exposes only one function (which XML-RPC calls a “method”). That function, <code>multiply()</code>, multiplies two numbers and returns the result. It’s not a very exciting example, but it shows the basic structure of an XML-RPC server.</p>
<div data-type="example" id="example_onesix_sixdot_multiplier_xml_rp">
<h5><span class="label">Example 16-6. </span>Multiplier XML-RPC server</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="c1">// expose this function via RPC as "multiply()"</code>
<code class="k">function</code> <code class="nf">times</code> <code class="p">(</code><code class="nv">$method</code><code class="p">,</code> <code class="nv">$args</code><code class="p">)</code> <code class="p">{</code>
 <code class="k">return</code> <code class="nv">$args</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="nv">$args</code><code class="p">[</code><code class="mi">1</code><code class="p">];</code>
<code class="p">}</code>

<code class="nv">$request</code> <code class="o">=</code> <code class="nv">$HTTP_RAW_POST_DATA</code><code class="p">;</code>

<code class="k">if</code> <code class="p">(</code><code class="o">!</code><code class="nv">$request</code><code class="p">)</code> <code class="p">{</code>
 <code class="nv">$requestXml</code> <code class="o">=</code> <code class="nv">$_POST</code><code class="p">[</code><code class="s1">'xml'</code><code class="p">];</code>
<code class="p">}</code>

<code class="nv">$server</code> <code class="o">=</code> <code class="nb">xmlrpc_server_create</code><code class="p">()</code> <code class="k">or</code> <code class="k">die</code><code class="p">(</code><code class="s2">"Couldn't create server"</code><code class="p">);</code>
<code class="nb">xmlrpc_server_register_method</code><code class="p">(</code><code class="nv">$server</code><code class="p">,</code> <code class="s2">"multiply"</code><code class="p">,</code> <code class="s2">"times"</code><code class="p">);</code>

<code class="nv">$options</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code>
 <code class="s1">'output_type'</code> <code class="o">=&gt;</code> <code class="s1">'xml'</code><code class="p">,</code>
 <code class="s1">'version'</code> <code class="o">=&gt;</code> <code class="s1">'auto'</code><code class="p">,</code>
<code class="p">);</code>

<code class="k">echo</code> <code class="nb">xmlrpc_server_call_method</code><code class="p">(</code><code class="nv">$server</code><code class="p">,</code> <code class="nv">$request</code><code class="p">,</code> <code class="k">null</code><code class="p">,</code> <code class="nv">$options</code><code class="p">);</code>

<code class="nb">xmlrpc_server_destroy</code><code class="p">(</code><code class="nv">$server</code><code class="p">);</code></pre>
</div>
<p>The <em>xmlrpc</em> extension handles the dispatch for you. That is, it works out which method the client was trying to call, decodes the arguments, and calls the corresponding PHP function. It then returns an XML response that encodes any values returned by the function that can be decoded by an XML-RPC client.</p>
<p>Create a server with <a contenteditable="false" data-type="indexterm" data-primary="xmlrpc_server_create function" id="idm45922746340968"/><code>xmlrpc_server_create()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$server</code> <code class="o">=</code> <code class="nb">xmlrpc_server_create</code><code class="p">();</code></pre>
<p>Once you’ve created a server, expose functions through the XML-RPC dispatch mechanism using <a contenteditable="false" data-type="indexterm" data-primary="xmlrpc_server_register_method function" id="idm45922746336872"/><code>xmlrpc_server_register_method()</code>:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nb">xmlrpc_server_register_method</code><code class="p">(</code><em><code class="nx">server</code></em><code class="p">,</code><code> </code><em><code class="nx">method</code></em><code class="p">,</code><code> </code><em><code class="nx">function</code></em><code class="p">);</code></pre>
<p>The <em><code>method</code></em> parameter is the name the XML-RPC client knows. The <em><code>function</code></em> parameter is the PHP function implementing that XML-RPC method. In the case of <a data-type="xref" href="#example_onesix_sixdot_multiplier_xml_rp">Example 16-6</a>, the <code>multiply()</code> XML-RPC client method is implemented by the <code>times()</code> function in PHP. Often a server will call <code>xmlrpc_server_register_method()</code> many times to expose many functions.</p>
<p>When you’ve registered all your methods, call <a contenteditable="false" data-type="indexterm" data-primary="xmlrpc_server_call_method function" id="idm45922746319608"/><code>xmlrpc_server_call_method()</code> to dispatch the incoming request to the appropriate function:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$response</code><code> </code><code class="o">=</code><code> </code><code class="nb">xmlrpc_server_call_method</code><code class="p">(</code><em><code class="nx">server</code></em><code class="p">,</code><code> </code><em><code class="nx">request</code></em><code class="p">,</code><code> </code><em><code class="nx">user_data</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">options</code></em><code class="p">]);</code></pre>
<p>The <em><code>request</code></em> is the XML-RPC request, which is typically sent as HTTP <code>POST</code> data. We fetch that through the <code>$HTTP_RAW_POST_DATA</code> variable. It contains the name of the method to be called and parameters to that method. The parameters are decoded into PHP data types, and the function (<code>times()</code>, in this case) is called.</p>
<p>A function exposed as an XML-RPC method takes two or three parameters:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$retval</code><code> </code><code class="o">=</code><code> </code><code class="nx">exposedFunction</code><code class="p">(</code><em><code class="nx">method</code></em><code class="p">,</code><code> </code><em><code class="nx">args</code></em><code> </code><code class="p">[,</code><code> </code><em><code class="nx">user_data</code></em><code class="p">]);</code></pre>
<p>The <em><code>method</code></em> parameter contains the name of the XML-RPC method (so you can have one PHP function exposed under many names). The arguments to the method are passed in the array <em><code>args</code></em>, and the optional <em><code>user_data</code></em> parameter is whatever the <code>xmlrpc_server_call_method()</code> function’s <em><code>user_data</code></em> parameter was.</p>
<p>The <em><code>options</code></em> parameter to <code>xmlrpc_server_call_method()</code> is an array mapping option names to their values. The options are:</p>
<dl>
<dt><code>output_type</code></dt>
<dd>Controls the data encoding used. Permissible values are <code>"php"</code> or <code>"xml"</code> (default).</dd>
<dt><code>verbosity</code></dt>
<dd>Controls how much whitespace is added to the output XML to make it readable to humans. Permissible values are <code>"no_white_space"</code>, <code>"newlines_only"</code>, and <code>"pretty"</code> (default).</dd>
<dt><code>escaping</code></dt>
<dd>Controls which characters are escaped and how they are escaped. Multiple values may be given as a subarray. Permissible values are <code>"cdata"</code>, <code>"non-ascii"</code> (default), <code>"non-print"</code> (default), and <code>"markup"</code> (default).</dd>
<dt><code>versioning</code></dt>
<dd>Controls which web service system to use. Permissible values are <code>"simple"</code>, <code>"soap 1.1"</code>, <code>"xmlrpc"</code> (default for clients), and <code>"auto"</code> (default for servers, meaning “whatever format the request came in”).</dd>
<dt><code>encoding</code></dt>
<dd>Controls the character encoding of the data. Permissible values include any valid encoding identifiers, but you’ll rarely want to change it from <code>"iso-8859-1"</code> (the default).</dd>
</dl>
</div></section>
<section data-type="sect2" data-pdf-bookmark="Clients"><div class="sect2" id="clients">
<h2>Clients</h2>
<p>An XML-RPC client issues an HTTP request and parses the response. The <em>xmlrpc</em> extension that ships with PHP can work with the XML that encodes an XML-RPC request, but it doesn’t know how to issue HTTP requests. For that functionality, you must download the <a contenteditable="false" data-type="indexterm" data-primary="website resources" data-secondary="xmlrpc-epi distribution" id="idm45922745932472"/><a contenteditable="false" data-type="indexterm" data-primary="xmlrpc-epi distribution" id="idm45922745931096"/><a href="http://xmlrpc-epi.sourceforge.net">xmlrpc-epi distribution</a> and install the <em>sample/utils/utils.php</em> file. This file contains a function to perform the HTTP request.</p>
<p><a data-type="xref" href="#example_onesix_sevendot_multiply_xml_rp">Example 16-7</a> shows a client for the <code>multiply</code> XML-RPC service.</p>
<div data-type="example" id="example_onesix_sevendot_multiply_xml_rp">
<h5><span class="label">Example 16-7. </span>Multiply XML-RPC client</h5>
<pre data-type="programlisting" data-code-language="html+php"><code class="cp">&lt;?php</code>
<code class="k">require_once</code><code class="p">(</code><code class="s2">"utils.php"</code><code class="p">);</code>

<code class="nv">$options</code> <code class="o">=</code> <code class="k">array</code><code class="p">(</code><code class="s1">'output_type'</code> <code class="o">=&gt;</code> <code class="s2">"xml"</code><code class="p">,</code> <code class="s1">'version'</code> <code class="o">=&gt;</code> <code class="s2">"xmlrpc"</code><code class="p">);</code>

<code class="nv">$result</code> <code class="o">=</code> <code class="nx">xu_rpc_http_concise</code><code class="p">(</code>
 <code class="k">array</code><code class="p">(</code>
 <code class="s1">'method'</code> <code class="o">=&gt;</code> <code class="s2">"multiply"</code><code class="p">,</code>
 <code class="s1">'args'</code> <code class="o">=&gt;</code> <code class="k">array</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code> <code class="mi">6</code><code class="p">),</code>
 <code class="s1">'host'</code> <code class="o">=&gt;</code> <code class="s2">"192.168.0.1"</code><code class="p">,</code>
 <code class="s1">'uri'</code> <code class="o">=&gt;</code> <code class="s2">"/~gnat/test/ch11/xmlrpc-server.php"</code><code class="p">,</code>
 <code class="s1">'options'</code> <code class="o">=&gt;</code> <code class="nv">$options</code><code class="p">,</code>
 <code class="p">)</code>
<code class="p">);</code>

<code class="k">echo</code> <code class="s2">"5 * 6 is </code><code class="si">{</code><code class="nv">$result</code><code class="si">}</code><code class="s2">"</code><code class="p">;</code></pre>
</div>
<p>We begin by loading the XML-RPC convenience utilities library. This gives us the <a contenteditable="false" data-type="indexterm" data-primary="xu_rpc_http_concise function" id="idm45922745831224"/><code>xu_rpc_http_concise()</code> function, which constructs a <code>POST</code> request for us:</p>
<pre data-type="programlisting" data-code-language="php"><code class="nv">$response</code><code> </code><code class="o">=</code><code> </code><code class="nx">xu_rpc_http_concise</code><code class="p">(</code><em><code class="nb">hash</code></em><code class="p">);</code></pre>
<p>The <em><code>hash</code></em> array contains the various attributes of the XML-RPC call as an associative array:</p>
<dl>
<dt><code>method</code></dt>
<dd>Name of the method to call.</dd>
<dt><code>args</code></dt>
<dd>Array of arguments to the method.</dd>
<dt><code>host</code></dt>
<dd>Hostname of the web service offering the method.</dd>
<dt><code>url</code></dt>
<dd>URL path to the web service.</dd>
<dt><code>options</code></dt>
<dd>Associative array of options, as for the server.</dd>
<dt><code>debug</code></dt>
<dd>If nonzero, prints debugging information (default is <code>0</code>).</dd>
</dl>
<p>The value returned by <code>xu_rpc_http_concise()</code> is the decoded return value from the called method.</p>
<p>There are several features of XML-RPC we haven’t covered. For example, XML-RPC’s data types do not always map precisely onto those of PHP, and there are ways to encode values as a particular data type rather than as the <em>xmlrpc</em> extension’s best guess. Also, there are features of the <em>xmlrpc</em> extension we haven’t covered, such as <a contenteditable="false" data-type="indexterm" data-primary="SOAP" id="idm45922745782472"/><a contenteditable="false" data-type="indexterm" data-primary="web services" data-secondary="SOAP" id="idm45922745781592"/>SOAP faults. See the <a href="http://www.php.net"><em>xmlrpc</em> extension’s documentation</a> for the full details.</p>
<p>For more information on XML-RPC, see <a class="orm:hideurl" href="http://oreil.ly/Web_Services_XML-RPC"><em>Programming Web Services in XML-RPC</em></a> (O’Reilly) by Simon St. Laurent et al. <a contenteditable="false" data-type="indexterm" data-primary="Programming Web Services in XML-RPC (O'Reilly)" id="idm45922745777288"/><a contenteditable="false" data-type="indexterm" data-primary="Programming Web Services with SOAP (O'Reilly)" id="idm45922745776152"/><a contenteditable="false" data-type="indexterm" data-primary="St. Laurent, Simon (author)" data-secondary="Programming Web Services in XML-RPC (O'Reilly)" id="idm45922745775016"/><a contenteditable="false" data-type="indexterm" data-primary="Snell, James (author)" data-secondary="Programming Web Services with SOAP (O'Reilly)" id="idm45922745773544"/>See <a class="orm:hideurl" href="http://oreil.ly/Web_Services_SOAP"><em>Programming Web Services with SOAP</em></a> (O’Reilly) by James Snell et al. for more information on SOAP.<a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_web_services_ch16" id="idm45922745770840"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_web_services_xml-rpc" id="idm45922745769528"/><a contenteditable="false" data-type="indexterm" data-primary="" data-startref="ix_xml-rpc_web_services" id="idm45922745768152"/></p>
</div></section>
</div></section>
<section data-type="sect1" data-pdf-bookmark="What’s Next"><div class="sect1" id="whatapostrophes_next-id00074">
<h1>What’s Next</h1>
<p>Now that we’ve covered the majority of the syntax, features, and application of PHP, the next chapter explores what to do when things go wrong: how to debug problems that arise in your PHP applications and scripts.</p>
</div></section>
</div></section></div>



  </body></html>